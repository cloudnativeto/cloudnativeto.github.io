<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  
  <title>在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发 | 云原生社区</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/all.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/chaos-engineering-with-kubernetes/" />
  <meta property="og:title" content="在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发" />
  <meta property="og:description" content="本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。" />
  <meta property="og:image" content="https://cloudnative.to/images/blog/chaos-mesh.png" />
</head>
<body>
<!-- header -->

<img src="images/logo-square.jpg" width="0" height="0" />
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
     <img src="" width='700'>
</div>
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog/">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/community/sig/">兴趣小组</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
                <a class="dropdown-item" href="https://istio.io/latest/zh/">Istio 中文文档</a>
                
              </div>
            </li>
            
            
          </ul>

          
          

          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3 text-capitalize">在 kubernetes 实施混沌工程—— chaos mesh 原理分析与控制面开发</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/chaos-mesh.png'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f">云原生</a></div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://github.com/mayocream">黄涵（Mayo Cream）</a></strong>
          
            发表于 <strong class="text-dark">2021年10月22日</strong></div>
        <hr>
        <div class="content">
          <p>Chaos Mesh 是由 TiDB 背后的 PingCAP 公司开发，运行在 Kubernetes 上的混沌工程（Chaos Engineering）系统。简而言之，Chaos Mesh 通过运行在 K8s 集群中的“特权”容器，依据 CRD 资源中的测试场景，在集群中制造浑沌（模拟故障）<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</p>
<p>本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。
如果你缺乏基础知识，要想对 Chaos Mesh 的架构有宏观上的认识，请参阅文末尾注中的链接。</p>
<p>本文试验代码位于 <a href="https://github.com/mayocream/chaos-mesh-controlpanel-demo">mayocream/chaos-mesh-controlpanel-demo</a> 仓库。</p>
<h2 id="如何制造混沌">如何制造混沌</h2>
<p>Chaos Mesh 是在 Kubernetes 上实施混沌工程的利器，那它是如何工作的呢？</p>
<h3 id="特权模式">特权模式</h3>
<p>上面提到 Chaos Mesh 运行 Kubernetes 特权容器来制造故障。Daemon Set 方式运行的 Pod 授权了容器运行时的<a href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#capabilities">权能字（Capabilities）</a>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: DaemonSet
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>: ...
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
        - <span style="color:#66d9ef">name</span>: chaos-daemon
          <span style="color:#66d9ef">securityContext</span>:
            {{- if .Values.chaosDaemon.privileged }}
            <span style="color:#66d9ef">privileged</span>: <span style="color:#66d9ef">true</span>
            <span style="color:#66d9ef">capabilities</span>:
              <span style="color:#66d9ef">add</span>:
                - SYS_PTRACE
            {{- else }}
            <span style="color:#66d9ef">capabilities</span>:
              <span style="color:#66d9ef">add</span>:
                - SYS_PTRACE
                - NET_ADMIN
                - MKNOD
                - SYS_CHROOT
                - SYS_ADMIN
                - KILL
                <span style="color:#75715e"># CAP_IPC_LOCK is used to lock memory</span>
                - IPC_LOCK
            {{- end }}
</code></pre></div><p>这些 Linux 权能字用于授予容器特权，以创建和访问 <code>/dev/fuse</code> FUSE 管道<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>（FUSE 是 Linux 用户空间文件系统接口，它使无特权的用户能够无需编辑内核代码而创建自己的文件系统）。</p>
<p>参阅 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/1109">#1109</a> Pull Request，Daemon Set 程序使用 CGO 调用 Linux <code>makedev</code> 函数创建 FUSE 管道。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// #include &lt;sys/sysmacros.h&gt;
</span><span style="color:#75715e">// #include &lt;sys/types.h&gt;
</span><span style="color:#75715e">// // makedev is a macro, so a wrapper is needed
</span><span style="color:#75715e">// dev_t Makedev(unsigned int maj, unsigned int min) {
</span><span style="color:#75715e">//   return makedev(maj, min);
</span><span style="color:#75715e">// }
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// EnsureFuseDev ensures /dev/fuse exists. If not, it will create one
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">EnsureFuseDev</span>() {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;/dev/fuse&#34;</span>); <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">IsNotExist</span>(<span style="color:#a6e22e">err</span>) {
		<span style="color:#75715e">// 10, 229 according to https://www.kernel.org/doc/Documentation/admin-guide/devices.txt
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">fuse</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">Makedev</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">229</span>)
		<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Mknod</span>(<span style="color:#e6db74">&#34;/dev/fuse&#34;</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o666</span>|<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">S_IFCHR</span>, int(<span style="color:#a6e22e">fuse</span>))
	}
}
</code></pre></div><p>同时在 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/1453">#1103</a> PR 中，Chaos Daemon 默认启用特权模式，即容器的 <code>securityContext</code> 中设置 <code>privileged: true</code>。</p>
<h3 id="杀死-pod">杀死 Pod</h3>
<p>PodKill、PodFailure、ContainerKill 都归属于 PodChaos 类别下，PodKill 是随机杀死 Pod。</p>
<p>PodKill 的具体实现其实是通过调用 API Server 发送 Kill 命令。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>

	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
	<span style="color:#e6db74">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Impl</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">impl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Impl</span>) <span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">records</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">Record</span>, <span style="color:#a6e22e">obj</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">InnerObject</span>) (<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">Phase</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">impl</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">namespacedName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pod</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// TODO: handle this error
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">NotInjected</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">impl</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pod</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">DeleteOptions</span>{
		<span style="color:#a6e22e">GracePeriodSeconds</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">podchaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">GracePeriod</span>, <span style="color:#75715e">// PeriodSeconds has to be set specifically
</span><span style="color:#75715e"></span>	})
	<span style="color:#f92672">...</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">Injected</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><code>GracePeriodSeconds</code> 参数适用于 K8s <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination-forced">强制终止 Pod</a>。例如在需要快速删除 Pod 时，我们使用 <code>kubectl delete pod --grace-period=0 --force</code> 命令。</p>
<p>PodFailure 是通过 Patch Pod 对象资源，用错误的镜像替换 Pod 中的镜像。Chaos 只修改了 <code>containers</code> 和 <code>initContainers</code> 的 <code>image</code> 字段，这也是因为 Pod 大部分字段是无法更改的，详情可以参阅 <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#pod-update-and-replacement">Pod 更新与替换</a>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">impl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Impl</span>) <span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">records</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">Record</span>, <span style="color:#a6e22e">obj</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">InnerObject</span>) (<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">Phase</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">origin</span>.<span style="color:#a6e22e">DeepCopy</span>()
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> {
		<span style="color:#a6e22e">originImage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">Image</span>
		<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">Name</span>

		<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">annotation</span>.<span style="color:#a6e22e">GenKeyForImage</span>(<span style="color:#a6e22e">podchaos</span>, <span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">false</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)
		}

		<span style="color:#75715e">// If the annotation is already existed, we could skip the reconcile for this container
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#a6e22e">key</span>] = <span style="color:#a6e22e">originImage</span>
		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">Image</span> = <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ControllerCfg</span>.<span style="color:#a6e22e">PodFailurePauseImage</span>
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">InitContainers</span> {
		<span style="color:#a6e22e">originImage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">InitContainers</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">Image</span>
		<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">InitContainers</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">Name</span>

		<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">annotation</span>.<span style="color:#a6e22e">GenKeyForImage</span>(<span style="color:#a6e22e">podchaos</span>, <span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">true</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)
		}

		<span style="color:#75715e">// If the annotation is already existed, we could skip the reconcile for this container
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#a6e22e">key</span>] = <span style="color:#a6e22e">originImage</span>
		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">InitContainers</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">Image</span> = <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ControllerCfg</span>.<span style="color:#a6e22e">PodFailurePauseImage</span>
	}

	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">impl</span>.<span style="color:#a6e22e">Patch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">MergeFrom</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">origin</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// TODO: handle this error
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">NotInjected</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">Injected</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>默认用于引发故障的容器镜像是 <code>gcr.io/google-containers/pause:latest</code>， 如果在国内环境使用，大概率会水土不服，可以将 <code>gcr.io</code> 替换为 <code>registry.aliyuncs.com</code>。</p>
<p>ContainerKill 不同于 PodKill 和 PodFailure，后两个都是通过 K8s API Server 控制 Pod 生命周期，而 ContainerKill 是通过运行在集群 Node 上的 Chaos Daemon 程序操作完成。具体来说，ContainerKill 通过 Chaos Controller Manager 运行客户端向 Chaos Daemon 发起 grpc 调用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ChaosDaemonClientBuilder</span>) <span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>) (<span style="color:#a6e22e">chaosdaemonclient</span>.<span style="color:#a6e22e">ChaosDaemonClientInterface</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">daemonIP</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">FindDaemonIP</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">pod</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">builder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpcUtils</span>.<span style="color:#a6e22e">Builder</span>(<span style="color:#a6e22e">daemonIP</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ControllerCfg</span>.<span style="color:#a6e22e">ChaosDaemonPort</span>).<span style="color:#a6e22e">WithDefaultTimeout</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ControllerCfg</span>.<span style="color:#a6e22e">TLSConfig</span>.<span style="color:#a6e22e">ChaosMeshCACert</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">TLSFromFile</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ControllerCfg</span>.<span style="color:#a6e22e">TLSConfig</span>.<span style="color:#a6e22e">ChaosMeshCACert</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ControllerCfg</span>.<span style="color:#a6e22e">TLSConfig</span>.<span style="color:#a6e22e">ChaosDaemonClientCert</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ControllerCfg</span>.<span style="color:#a6e22e">TLSConfig</span>.<span style="color:#a6e22e">ChaosDaemonClientKey</span>)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">Insecure</span>()
	}
	<span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">Build</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">chaosdaemonclient</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cc</span>), <span style="color:#66d9ef">nil</span>
}

</code></pre></div><p>向 Chaos Daemon 发送命令时会依据 Pod 信息创建对应的客户端，例如要控制某个 Node 上的 Pod，会获取该 Pod 所在 Node 的 ClusterIP，以创建客户端。如果 TLS 证书配置存在，Controller Manager 会为客户端添加 TLS 证书。</p>
<p>Chaos Daemon 在启动时如果有 TLS 证书，会附加证书以启用 grpcs。TLS 校验配置 <code>RequireAndVerifyClientCert</code> 表示启用双向 TLS 认证（mTLS）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newGRPCServer</span>(<span style="color:#a6e22e">containerRuntime</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">reg</span> <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">Registerer</span>, <span style="color:#a6e22e">tlsConf</span> <span style="color:#a6e22e">tlsConfig</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tlsConf</span> <span style="color:#f92672">!=</span> (<span style="color:#a6e22e">tlsConfig</span>{}) {
		<span style="color:#a6e22e">caCert</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">tlsConf</span>.<span style="color:#a6e22e">CaCert</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">caCertPool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">NewCertPool</span>()
		<span style="color:#a6e22e">caCertPool</span>.<span style="color:#a6e22e">AppendCertsFromPEM</span>(<span style="color:#a6e22e">caCert</span>)

		<span style="color:#a6e22e">serverCert</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">LoadX509KeyPair</span>(<span style="color:#a6e22e">tlsConf</span>.<span style="color:#a6e22e">Cert</span>, <span style="color:#a6e22e">tlsConf</span>.<span style="color:#a6e22e">Key</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}

		<span style="color:#a6e22e">creds</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">credentials</span>.<span style="color:#a6e22e">NewTLS</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Config</span>{
			<span style="color:#a6e22e">Certificates</span>: []<span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Certificate</span>{<span style="color:#a6e22e">serverCert</span>},
			<span style="color:#a6e22e">ClientCAs</span>:    <span style="color:#a6e22e">caCertPool</span>,
			<span style="color:#a6e22e">ClientAuth</span>:   <span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">RequireAndVerifyClientCert</span>,
		})

		<span style="color:#a6e22e">grpcOpts</span> = append(<span style="color:#a6e22e">grpcOpts</span>, <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Creds</span>(<span style="color:#a6e22e">creds</span>))
	}

	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">grpcOpts</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">grpcMetrics</span>.<span style="color:#a6e22e">InitializeMetrics</span>(<span style="color:#a6e22e">s</span>)

	<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterChaosDaemonServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ds</span>)
	<span style="color:#a6e22e">reflection</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">s</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Chaos Daemon 提供了以下 grpc 调用接口：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// ChaosDaemonClient is the client API for ChaosDaemon service.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChaosDaemonClient</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">SetTcs</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TcsRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">FlushIPSets</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">IPSetsRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">SetIptablesChains</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">IptablesChainsRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">SetTimeOffset</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TimeRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">RecoverTimeOffset</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TimeRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">ContainerKill</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ContainerRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">ContainerGetPid</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ContainerRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ContainerResponse</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">ExecStressors</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ExecStressRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ExecStressResponse</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">CancelStressors</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CancelStressRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">ApplyIOChaos</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ApplyIOChaosRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ApplyIOChaosResponse</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">ApplyHttpChaos</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ApplyHttpChaosRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ApplyHttpChaosResponse</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">SetDNSServer</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SetDNSServerRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>)
}
</code></pre></div><h3 id="网络故障">网络故障</h3>
<p>从最初的 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/41">#41</a> PR 中，可以清晰地了解到，Chaos Mesh 的网络错误注入是通过调用 <code>pbClient.SetNetem</code> 方法，将参数封装成请求，交给 Node 上的 Chaos Daemon 处理的。</p>
<p>（注：这是 2019 年初期的代码，随着项目发展，代码中的函数已分散到不同的文件中）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reconciler</span>) <span style="color:#a6e22e">applyPod</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>, <span style="color:#a6e22e">networkchaos</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">NetworkChaos</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">pbClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">NewChaosDaemonClient</span>(<span style="color:#a6e22e">c</span>)

	<span style="color:#a6e22e">containerId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">ContainerStatuses</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">ContainerID</span>

	<span style="color:#a6e22e">netem</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">ToNetem</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pbClient</span>.<span style="color:#a6e22e">SetNetem</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">NetemRequest</span>{
		<span style="color:#a6e22e">ContainerId</span>: <span style="color:#a6e22e">containerId</span>,
		<span style="color:#a6e22e">Netem</span>:       <span style="color:#a6e22e">netem</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>同时在 <code>pkg/chaosdaemon</code> 包中，我们能看到 Chaos Daemon 处理请求的方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">SetNetem</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">NetemRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Set netem&#34;</span>, <span style="color:#e6db74">&#34;Request&#34;</span>, <span style="color:#a6e22e">in</span>)

	<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">crClient</span>.<span style="color:#a6e22e">GetPidFromContainerID</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">ContainerId</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">codes</span>.<span style="color:#a6e22e">Internal</span>, <span style="color:#e6db74">&#34;get pid from containerID error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">Netem</span>, <span style="color:#a6e22e">pid</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">codes</span>.<span style="color:#a6e22e">Internal</span>, <span style="color:#e6db74">&#34;netem apply error: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>{}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Apply applies a netem on eth0 in pid related namespace
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">netem</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Netem</span>, <span style="color:#a6e22e">pid</span> <span style="color:#66d9ef">uint32</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Apply netem on PID&#34;</span>, <span style="color:#e6db74">&#34;pid&#34;</span>, <span style="color:#a6e22e">pid</span>)

	<span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">netns</span>.<span style="color:#a6e22e">GetFromPath</span>(<span style="color:#a6e22e">GenNetnsPath</span>(<span style="color:#a6e22e">pid</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to find network namespace&#34;</span>, <span style="color:#e6db74">&#34;pid&#34;</span>, <span style="color:#a6e22e">pid</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">NewHandleAt</span>(<span style="color:#a6e22e">ns</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to get handle at network namespace&#34;</span>, <span style="color:#e6db74">&#34;network namespace&#34;</span>, <span style="color:#a6e22e">ns</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">link</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">handle</span>.<span style="color:#a6e22e">LinkByName</span>(<span style="color:#e6db74">&#34;eth0&#34;</span>) <span style="color:#75715e">// TODO: check whether interface name is eth0
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to find eth0 interface&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#a6e22e">netemQdisc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">NewNetem</span>(<span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">QdiscAttrs</span>{
		<span style="color:#a6e22e">LinkIndex</span>: <span style="color:#a6e22e">link</span>.<span style="color:#a6e22e">Attrs</span>().<span style="color:#a6e22e">Index</span>,
		<span style="color:#a6e22e">Handle</span>:    <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">MakeHandle</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>),
		<span style="color:#a6e22e">Parent</span>:    <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">HANDLE_ROOT</span>,
	}, <span style="color:#a6e22e">ToNetlinkNetemAttrs</span>(<span style="color:#a6e22e">netem</span>))

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">handle</span>.<span style="color:#a6e22e">QdiscAdd</span>(<span style="color:#a6e22e">netemQdisc</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>(), <span style="color:#e6db74">&#34;file exists&#34;</span>) {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to add Qdisc&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>最终使用 <a href="https://github.com/vishvananda/netlink">vishvananda/netlink</a> 库操作 Linux 网络接口来完成工作。</p>
<p>这里能够知道，NetworkChaos 混沌类型，操作了Linux 宿主机网络来制造混沌，包含 iptables、ipset 等工具。</p>
<p>在 Chaos Daemon 的 Dockerfile 中，可以看到其依赖的 Linux 工具链：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\ </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    apt-get install -y tzdata iptables ipset stress-ng iproute2 fuse util-linux procps curl <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    rm -rf /var/lib/apt/lists/*<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h3 id="压力测试">压力测试</h3>
<p>StressChaos 类型的混沌也是由 Chaos Daemon 实施的，Controller Manager 计算好规则后就将任务下发到具体的 Daemon 上。拼装的参数如下，这些参数会组合成命令执行的参数，附加到 <code>stress-ng</code> 命令后执行<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Normalize the stressors to comply with stress-ng
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Stressors</span>) <span style="color:#a6e22e">Normalize</span>() (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;&#34;</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Workers</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34; --vm %d --vm-keep&#34;</span>, <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Workers</span>)
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Size</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Size</span>[len(<span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Size</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;%&#39;</span> {
				<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">units</span>.<span style="color:#a6e22e">FromHumanSize</span>(string(<span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Size</span>))
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34; --vm-bytes %d&#34;</span>, <span style="color:#a6e22e">size</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34; --vm-bytes %s&#34;</span>,
					<span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Size</span>)
			}
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Options</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">MemoryStressor</span>.<span style="color:#a6e22e">Options</span> {
				<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34; %v &#34;</span>, <span style="color:#a6e22e">v</span>)
			}
		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CPUStressor</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CPUStressor</span>.<span style="color:#a6e22e">Workers</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34; --cpu %d&#34;</span>, <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CPUStressor</span>.<span style="color:#a6e22e">Workers</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CPUStressor</span>.<span style="color:#a6e22e">Load</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34; --cpu-load %d&#34;</span>,
				<span style="color:#f92672">*</span><span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CPUStressor</span>.<span style="color:#a6e22e">Load</span>)
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CPUStressor</span>.<span style="color:#a6e22e">Options</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CPUStressor</span>.<span style="color:#a6e22e">Options</span> {
				<span style="color:#a6e22e">stressors</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34; %v &#34;</span>, <span style="color:#a6e22e">v</span>)
			}
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">stressors</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Chaos Daemon 服务端处理函数中调用 Go 官方包 <code>os/exec</code> 执行命令，再大段贴代码就没有意思了，具体可以阅读 <a href="https://github.com/chaos-mesh/chaos-mesh/blob/98af3a0e7832a4971d6b133a32069539d982ef0a/pkg/chaosdaemon/stress_server_linux.go#L33">pkg/chaosdaemon/stress_server_linux.go</a> 文件。同名文件还有以 darwin 结尾的，推测是为了在 macOS 上开发调试方便。</p>
<p>代码中使用 <a href="https://github.com/shirou/gopsutil">shirou/gopsutil</a> 包获取 PID 进程状态，并读取了 stdout、stderr 等标准输出，这种处理模式我在 <a href="https://github.com/hashicorp/go-plugin">hashicorp/go-plugin</a> 见过，go-plugin 在这方面做得更加优秀。我的另一篇文章 Dkron 源码分析中提到了它<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>。</p>
<h3 id="io-注入">IO 注入</h3>
<p>开篇就提到了 Chaos Mesh 使用了特权容器，用于挂载宿主机上的 FUSE 设备 <code>/dev/fuse</code>。</p>
<p>看到这里，我铁定以为 Chaos Mesh 是使用 <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook">Mutating 准入控制器</a>进行 Sidecar 容器的注入，挂载 FUSE 设备，或修改 Pod Volumes Mount 等配置，然后它的实现方式与直观上不同。</p>
<p>仔细看了 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/826">#826</a> PR，这个 PR 引入了新的 IOChaos 的实现，避免使用 Sidecar 注入的方式，而采用 Chaos Daemon 直接通过 runc 容器底层命令操作 Linux 命名空间，运行用 Rust 开发的 <a href="https://github.com/chaos-mesh/toda">chaos-mesh/toda</a> FUSE 程序（使用 <a href="https://pkg.go.dev/github.com/ethereum/go-ethereum/rpc">JSON-RPC 2.0</a> 协议通信）进行容器 IO 混沌注入。</p>
<p>关注新的 IOChaos 实现，它不会修改 Pod 资源，IOChaos 混沌实验定义被创建时，针对选择器（selector 字段）筛选出的每一个 Pod，对应的一个 PodIoChaos 资源会被创建，PodIoChaos 的<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/">属主引用（Owner Reference）</a>为该 Pod。PodIoChaos 同时会被添加上一组 <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/">Finalizers</a>，用于在被删除前释放 PodIoChaos 资源。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Apply implements the reconciler.InnerReconciler.Apply
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reconciler</span>) <span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">chaos</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">InnerObject</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">iochaos</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chaos</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">IoChaos</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;chaos is not IoChaos&#34;</span>)
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;chaos is not IoChaos&#34;</span>, <span style="color:#e6db74">&#34;chaos&#34;</span>, <span style="color:#a6e22e">chaos</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">source</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Namespace</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Name</span>
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">podiochaosmanager</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">source</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Log</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Client</span>)

	<span style="color:#a6e22e">pods</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">SelectAndFilterPods</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Reader</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to select and filter pods&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;applying iochaos&#34;</span>, <span style="color:#e6db74">&#34;iochaos&#34;</span>, <span style="color:#a6e22e">iochaos</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pods</span> {
		<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">WithInit</span>(<span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NamespacedName</span>{
			<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>,
			<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Namespace</span>,
		})

		<span style="color:#75715e">// TODO: support chaos on multiple volume
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">SetVolumePath</span>(<span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">VolumePath</span>)
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Append</span>(<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">IoChaosAction</span>{
			<span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Action</span>,
			<span style="color:#a6e22e">Filter</span>: <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">Filter</span>{
				<span style="color:#a6e22e">Path</span>:    <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Path</span>,
				<span style="color:#a6e22e">Percent</span>: <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Percent</span>,
				<span style="color:#a6e22e">Methods</span>: <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Methods</span>,
			},
			<span style="color:#a6e22e">Faults</span>: []<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">IoFault</span>{
				{
					<span style="color:#a6e22e">Errno</span>:  <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Errno</span>,
					<span style="color:#a6e22e">Weight</span>: <span style="color:#ae81ff">1</span>,
				},
			},
			<span style="color:#a6e22e">Latency</span>:          <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Delay</span>,
			<span style="color:#a6e22e">AttrOverrideSpec</span>: <span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Attr</span>,
			<span style="color:#a6e22e">Source</span>:           <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>,
		})

		<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pod</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Finalizers</span> = <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">InsertFinalizer</span>(<span style="color:#a6e22e">iochaos</span>.<span style="color:#a6e22e">Finalizers</span>, <span style="color:#a6e22e">key</span>)
	}
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;commiting updates of podiochaos&#34;</span>)
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Commit</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;fail to commit&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Event</span>(<span style="color:#a6e22e">iochaos</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">EventTypeNormal</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">EventChaosInjected</span>, <span style="color:#e6db74">&#34;&#34;</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>在 PodIoChaos 资源的控制器中，Controller Manager 会将资源封装成参数，调用 Chaos Daemon 接口进行实际处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Apply flushes io configuration on pod
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">Apply</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">chaos</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodIoChaos</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;updating io chaos&#34;</span>, <span style="color:#e6db74">&#34;pod&#34;</span>, <span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Namespace</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;spec&#34;</span>, <span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Spec</span>)
    <span style="color:#f92672">...</span>
	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pbClient</span>.<span style="color:#a6e22e">ApplyIoChaos</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ApplyIoChaosRequest</span>{
		<span style="color:#a6e22e">Actions</span>:     <span style="color:#a6e22e">input</span>,
		<span style="color:#a6e22e">Volume</span>:      <span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">VolumeMountPath</span>,
		<span style="color:#a6e22e">ContainerId</span>: <span style="color:#a6e22e">containerID</span>,

		<span style="color:#a6e22e">Instance</span>:  <span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">StartTime</span>: <span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">StartTime</span>,
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Pid</span> = <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Instance</span>
	<span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">StartTime</span> = <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">StartTime</span>
	<span style="color:#a6e22e">chaos</span>.<span style="color:#a6e22e">OwnerReferences</span> = []<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">OwnerReference</span>{
		{
			<span style="color:#a6e22e">APIVersion</span>: <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">APIVersion</span>,
			<span style="color:#a6e22e">Kind</span>:       <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Kind</span>,
			<span style="color:#a6e22e">Name</span>:       <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>,
			<span style="color:#a6e22e">UID</span>:        <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>,
		},
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>在 Chaos Daemon 中处理 IOChaos 的代码文件 <code>pkg/chaosdaemon/iochaos_server.go</code> 中，容器需要被注入一个 FUSE 程序，通过 <a href="https://github.com/chaos-mesh/chaos-mesh/issues/2305">#2305</a> Issue，可以了解到执行了 <code>/usr/local/bin/nsexec -l -p /proc/119186/ns/pid -m /proc/119186/ns/mnt -- /usr/local/bin/toda --path /tmp --verbose info</code> 命令，以在特定的 Linux 命名空间（Namespace）下运行 toda 程序，即与 Pod 在同一个命名空间下。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonServer</span>) <span style="color:#a6e22e">ApplyIOChaos</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ApplyIOChaosRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ApplyIOChaosResponse</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">crClient</span>.<span style="color:#a6e22e">GetPidFromContainerID</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">ContainerId</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error while getting PID&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;--path %s --verbose info&#34;</span>, <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">Volume</span>)
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;executing&#34;</span>, <span style="color:#e6db74">&#34;cmd&#34;</span>, <span style="color:#a6e22e">todaBin</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">args</span>)

	<span style="color:#a6e22e">processBuilder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bpm</span>.<span style="color:#a6e22e">DefaultProcessBuilder</span>(<span style="color:#a6e22e">todaBin</span>, <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">args</span>, <span style="color:#e6db74">&#34; &#34;</span>)<span style="color:#f92672">...</span>).
		<span style="color:#a6e22e">EnableLocalMnt</span>().
		<span style="color:#a6e22e">SetIdentifier</span>(<span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">ContainerId</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">EnterNS</span> {
		<span style="color:#a6e22e">processBuilder</span> = <span style="color:#a6e22e">processBuilder</span>.<span style="color:#a6e22e">SetNS</span>(<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">bpm</span>.<span style="color:#a6e22e">MountNS</span>).<span style="color:#a6e22e">SetNS</span>(<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">bpm</span>.<span style="color:#a6e22e">PidNS</span>)
	}

    <span style="color:#f92672">...</span>
    <span style="color:#75715e">// JSON RPC 调用
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jrpc</span>.<span style="color:#a6e22e">DialIO</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">receiver</span>, <span style="color:#a6e22e">caller</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">processBuilder</span>.<span style="color:#a6e22e">Build</span>()
    <span style="color:#a6e22e">procState</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">backgroundProcessManager</span>.<span style="color:#a6e22e">StartProcess</span>(<span style="color:#a6e22e">cmd</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#f92672">...</span>
}
</code></pre></div><p>下面这段代码最终构建了运行的命令，而这些命令正是 <a href="https://github.com/opencontainers/runc">runc</a> 底层的 Namespace 隔离实现<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// GetNsPath returns corresponding namespace path
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetNsPath</span>(<span style="color:#a6e22e">pid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">typ</span> <span style="color:#a6e22e">NsType</span>) <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s/%d/ns/%s&#34;</span>, <span style="color:#a6e22e">DefaultProcPrefix</span>, <span style="color:#a6e22e">pid</span>, string(<span style="color:#a6e22e">typ</span>))
}

<span style="color:#75715e">// SetNS sets the namespace of the process
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ProcessBuilder</span>) <span style="color:#a6e22e">SetNS</span>(<span style="color:#a6e22e">pid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">typ</span> <span style="color:#a6e22e">NsType</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ProcessBuilder</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">SetNSOpt</span>([]<span style="color:#a6e22e">nsOption</span>{{
		<span style="color:#a6e22e">Typ</span>:  <span style="color:#a6e22e">typ</span>,
		<span style="color:#a6e22e">Path</span>: <span style="color:#a6e22e">GetNsPath</span>(<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">typ</span>),
	}})
}

<span style="color:#75715e">// Build builds the process
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ProcessBuilder</span>) <span style="color:#a6e22e">Build</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ManagedProcess</span> {
	<span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">args</span>
	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">cmd</span>

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">nsOptions</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">args</span> = append([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;--&#34;</span>, <span style="color:#a6e22e">cmd</span>}, <span style="color:#a6e22e">args</span><span style="color:#f92672">...</span>)
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">option</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">nsOptions</span> {
			<span style="color:#a6e22e">args</span> = append([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">nsArgMap</span>[<span style="color:#a6e22e">option</span>.<span style="color:#a6e22e">Typ</span>], <span style="color:#a6e22e">option</span>.<span style="color:#a6e22e">Path</span>}, <span style="color:#a6e22e">args</span><span style="color:#f92672">...</span>)
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">localMnt</span> {
			<span style="color:#a6e22e">args</span> = append([]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;-l&#34;</span>}, <span style="color:#a6e22e">args</span><span style="color:#f92672">...</span>)
		}
		<span style="color:#a6e22e">cmd</span> = <span style="color:#a6e22e">nsexecPath</span>
	}
    <span style="color:#f92672">...</span>
}
</code></pre></div><h2 id="控制平面">控制平面</h2>
<p>Chaos Mesh 是一个开源的混沌工程系统，以 Apache 2.0 协议开源，经过以上分析知道它的能力丰富，并且它的生态良好，维护团队围绕混沌系统研发了用户态文件系统（FUSE）<a href="https://github.com/chaos-mesh/toda">chaos-mesh/toda</a> 、CoreDNS 混沌插件 <a href="https://github.com/chaos-mesh/k8s_dns_chaos">chaos-mesh/k8s_dns_chaos</a>、基于 BPF 的内核错误注入 <a href="https://github.com/chaos-mesh/bpfki">chaos-mesh/bpfki</a> 等。</p>
<p>下述如果我想要建立一个面向终端用户的混沌工程平台，在服务端实现的代码应该是怎样的。示例仅为一种实践，并不代表最佳实践，如果想看 Real World 平台的开发实践的话，可以参考 Chaos Mesh 官方的 <a href="https://github.com/chaos-mesh/chaos-mesh/tree/master/pkg/dashboard">Dashboard</a>，内部使用了 <a href="https://github.com/uber-go/fx">uber-go/fx</a> 依赖注入框架和 controller runtime 的 manager 模式。</p>
<h3 id="职能划分">职能划分</h3>
<p><img src="4_d0e6bfad2a.png" alt="Chaos Mesh 的基本工作流原理图"></p>
<p>这里标题虽是控制平面，但查看上述 Chaos Mesh 工作流程图，其实我们需要做的只是实现一个将 YAML 下发到 Kubernetes API 的服务器，复杂的规则校验、规则下发到 Chaos Daemon 的行为是由 Chaos Controller Manager 完成的。想要结合自己的平台使用，只需要对接 CRD 资源创建的过程就足够了。</p>
<p>我们来看一下 PingCAP 官方给出的示例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;context&#34;</span>

    <span style="color:#e6db74">&#34;github.com/pingcap/chaos-mesh/api/v1alpha1&#34;</span>
    <span style="color:#e6db74">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">delay</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">chaosv1alpha1</span>.<span style="color:#a6e22e">NetworkChaos</span>{
        <span style="color:#a6e22e">Spec</span>: <span style="color:#a6e22e">chaosv1alpha1</span>.<span style="color:#a6e22e">NetworkChaosSpec</span>{<span style="color:#f92672">...</span>},
    }
    <span style="color:#a6e22e">k8sClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">conf</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Options</span>{ <span style="color:#a6e22e">Scheme</span>: <span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">Scheme</span> })
    <span style="color:#a6e22e">k8sClient</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">delay</span>)
    <span style="color:#a6e22e">k8sClient</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">delay</span>)
}
</code></pre></div><p>Chaos Mesh 已经提供了所有的 CRD 资源定义对应的 API，我们使用 Kubernetes <a href="https://github.com/kubernetes/community/tree/master/sig-api-machinery">API Machinery SIG</a> 开发的 <a href="https://github.com/kubernetes-sigs/controller-runtime">controller-runtime</a> 来简化与 Kubernetes API 的交互。</p>
<h3 id="实施混沌">实施混沌</h3>
<p>例如我们想通过程序调用的方式，创建一个 PodKill 资源，该资源被发送到 Kubernetes API Server 后，会经由  Chaos Controller Manager 的 <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook/">Validating 准入控制器</a>，进行数据校验，若数据格式验证失败，会在创建时返回错误。具体参数可以查阅官方文档<a href="https://chaos-mesh.org/zh/docs/simulate-pod-chaos-on-kubernetes/#%E4%BD%BF%E7%94%A8-yaml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E5%AE%9E%E9%AA%8C">使用 YAML 配置文件创建实验</a>。</p>
<p><code>NewClient</code> 创建了一个 K8s API Client，可以参考<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.10.2/pkg/client#example-New">客户端创建示例</a>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;controlpanel&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>

	<span style="color:#e6db74">&#34;github.com/chaos-mesh/chaos-mesh/api/v1alpha1&#34;</span>
	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">applyPodKill</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">namespace</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">labels</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">cli</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controlpanel</span>.<span style="color:#a6e22e">NewClient</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;create client&#34;</span>)
	}

	<span style="color:#a6e22e">cr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodChaos</span>{
		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
			<span style="color:#a6e22e">GenerateName</span>: <span style="color:#a6e22e">name</span>,
			<span style="color:#a6e22e">Namespace</span>:    <span style="color:#a6e22e">namespace</span>,
		},
		<span style="color:#a6e22e">Spec</span>: <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodChaosSpec</span>{
			<span style="color:#a6e22e">Action</span>: <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodKillAction</span>,
			<span style="color:#a6e22e">ContainerSelector</span>: <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">ContainerSelector</span>{
				<span style="color:#a6e22e">PodSelector</span>: <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodSelector</span>{
					<span style="color:#a6e22e">Mode</span>: <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">OnePodMode</span>,
					<span style="color:#a6e22e">Selector</span>: <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodSelectorSpec</span>{
						<span style="color:#a6e22e">Namespaces</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">namespace</span>},
						<span style="color:#a6e22e">LabelSelectors</span>: <span style="color:#a6e22e">labels</span>,
					},
				},
			},
		},
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">cr</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;create podkill&#34;</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>运行程序的日志输出为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">I1021 00:51:55.225502   <span style="color:#ae81ff">23781</span> request.go:665<span style="color:#f92672">]</span> Waited <span style="color:#66d9ef">for</span> 1.033116256s due to client-side throttling, not priority and fairness, request: GET:https://***
2021/10/21 00:51:56 apply podkill
</code></pre></div><p>通过 kubectl 查看 PodKill 资源的状态：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ k describe podchaos.chaos-mesh.org -n dev podkillvjn77
Name:         podkillvjn77
Namespace:    dev
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  chaos-mesh.org/v1alpha1
Kind:         PodChaos
Metadata:
  Creation Timestamp:  2021-10-20T16:51:56Z
  Finalizers:
    chaos-mesh/records
  Generate Name:     podkill
  Generation:        <span style="color:#ae81ff">7</span>
  Resource Version:  <span style="color:#ae81ff">938921488</span>
  Self Link:         /apis/chaos-mesh.org/v1alpha1/namespaces/dev/podchaos/podkillvjn77
  UID:               afbb40b3-ade8-48ba-89db-04918d89fd0b
Spec:
  Action:        pod-kill
  Grace Period:  <span style="color:#ae81ff">0</span>
  Mode:          one
  Selector:
    Label Selectors:
      app:  nginx
    Namespaces:
      dev
Status:
  Conditions:
    Reason:  
    Status:  False
    Type:    Paused
    Reason:  
    Status:  True
    Type:    Selected
    Reason:  
    Status:  True
    Type:    AllInjected
    Reason:  
    Status:  False
    Type:    AllRecovered
  Experiment:
    Container Records:
      Id:            dev/nginx
      Phase:         Injected
      Selector Key:  .
    Desired Phase:   Run
Events:
  Type    Reason           Age    From          Message
  ----    ------           ----   ----          -------
  Normal  FinalizerInited  6m35s  finalizer     Finalizer has been inited
  Normal  Updated          6m35s  finalizer     Successfully update finalizer of resource
  Normal  Updated          6m35s  records       Successfully update records of resource
  Normal  Updated          6m35s  desiredphase  Successfully update desiredPhase of resource
  Normal  Applied          6m35s  records       Successfully apply chaos <span style="color:#66d9ef">for</span> dev/nginx
  Normal  Updated          6m35s  records       Successfully update records of resource
</code></pre></div><p>控制面还自然而然要有查询和获取 Chaos 资源的功能，方便平台用户查看到所有的混沌试验的实施状态，对其进行管理。当然，这里无非是调用 REST API 发送 Get/List 请求，但在实践上细节需要留意，敝司就发生过 Controller 每次请求全量的资源数据，造成 K8s API Server 的负载增高。</p>
<p>这里十分推荐阅读 <a href="https://zoetrope.github.io/kubebuilder-training/controller-runtime/client.html">クライアントの使い方</a>，这篇 controller runtime 使用教程，提到了很细节的地方。例如 controller runtime 默认会从多个位置读取 kubeconfig，flag、环境变量、再是自动挂载在 Pod 中的 Service Account，<a href="https://github.com/armosec/kubescape">armosec/kubescape</a> <a href="https://github.com/armosec/kubescape/pull/21">#21</a> PR 也是利用了该特性。这篇教程还包括了如何分页、更新、覆盖对象等常用的操作，我目前还没有看到有哪篇中文、英文教程有这么详细。</p>
<p>Get/List 请求示例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">controlpanel</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>

	<span style="color:#e6db74">&#34;github.com/chaos-mesh/chaos-mesh/api/v1alpha1&#34;</span>
	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
	<span style="color:#e6db74">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetPodChaos</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">namespace</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodChaos</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">cli</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetClient</span>()

	<span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodChaos</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">ObjectKey</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">namespace</span>}, <span style="color:#a6e22e">item</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;get cr&#34;</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">item</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ListPodChaos</span>(<span style="color:#a6e22e">namespace</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">labels</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>) ([]<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodChaos</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">cli</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetClient</span>()

	<span style="color:#a6e22e">list</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PodChaosList</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">list</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">InNamespace</span>(<span style="color:#a6e22e">namespace</span>), <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">MatchingLabels</span>(<span style="color:#a6e22e">labels</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">Items</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>示例中使用了 manager，该模式下会启用 cache 机制，避免重复获取大量数据。</p>
<p><img src="cache.png" alt=""></p>
<ol>
<li>获取 Pod</li>
<li>初次获取全量数据（List）</li>
<li>Watch 数据变化时更新缓存</li>
</ol>
<h3 id="混沌编排">混沌编排</h3>
<p>就如同 CRI 容器运行时提供了强大的底层隔离能力，能够支撑容器的稳定运行，而想要更大规模、更复杂的场景就需要容器编排一样，Chaos Mesh 提供了 Schedule 和 Workflow 功能。<a href="https://chaos-mesh.org/zh/docs/define-scheduling-rules/">Schedule</a> 能够根据设定的 Cron 时间定时、间隔地触发故障，<a href="https://chaos-mesh.org/zh/docs/create-chaos-mesh-workflow/">Workflow</a> 能像 Argo Workflow 一样编排多个故障试验。</p>
<p>当然，Chaos Controller Manager 替我们做了大部分工作，控制面所需要的还是管理这些 YAML 资源，唯一需要考虑的是要给用户提供怎样的功能。</p>
<h3 id="平台功能">平台功能</h3>
<p>参考 Chaos Mesh Dashboard，我们需要考虑平台该提供哪些功能给终端用户。</p>
<p><img src="image-20211021030337926-16347566199512.png" alt=""></p>
<p>可能的平台功能点：</p>
<ul>
<li>混沌注入
<ul>
<li>Pod 崩溃</li>
<li>网络故障</li>
<li>负载测试</li>
<li>IO 故障</li>
</ul>
</li>
<li>事件跟踪</li>
<li>关联告警</li>
<li>时序遥测</li>
</ul>
<h2 id="参阅资料">参阅资料</h2>
<p>本文既是为公司引入新技术进行试探，同时也是自我学习的记录，此前接触的学习材料及撰写本文时查阅的资料，较为优秀的部分列在这里，以便快速查阅。</p>
<ul>
<li><a href="https://qiankunli.github.io/2020/08/10/controller_runtime.html">controller-runtime源码分析</a></li>
<li><a href="https://github.com/zoetrope/kubebuilder-training">つくって学ぶKubebuilder</a>（日文教程）</li>
<li><a href="https://book.kubebuilder.io/">Kubebuilder Book</a> / <a href="https://cloudnative.to/kubebuilder/">中文版</a></li>
<li><a href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kube-controller-manager/sharedIndexInformer.html">kube-controller-manager源码分析（三）之 Informer机制</a></li>
<li><a href="https://segmentfault.com/a/1190000020359577">kubebuilder2.0学习笔记——进阶使用</a></li>
<li><a href="https://www.cnblogs.com/charlieroro/p/11112526.html">client-go和golang源码中的技巧</a></li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://pingcap.com/zh/blog/chaos-mesh">Chaos Mesh - 让应用跟混沌在 Kubernetes 上共舞</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://xie.infoq.cn/article/655c0893ed150ff65f2b7a16f">自制文件系统 —— 02 开发者的福音，FUSE 文件系统</a> <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="http://www.freeoa.net/product/apptool/stress-ng_3456.html">系统压力测试工具-stress-ng</a> <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p><a href="https://shoujo.ink/2021/09/dkron-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Dkron 源码分析</a> <a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p><a href="https://www.jianshu.com/p/a73f984f53b5">RunC 源码通读指南之 NameSpace</a> <a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb"> 
            源码阅读</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/%e6%b7%b7%e6%b2%8c%e5%b7%a5%e7%a8%8b"> , 
            混沌工程</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/kubernetes"> , 
            Kubernetes</a>
            
          </ul>
        </div>
        <!-- previous -->
        
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://cloudnative.to/blog/kong-source-code-reading/" data-toggle="tooltip" data-placement="top" title="云原生网关 Kong 源码分析">&larr; 上一篇</a>
</li>
 
</ul>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/kong-source-code-reading/">云原生网关 Kong 源码分析</a></li>
  
    <li><a href="/blog/create-a-ipvs-svc-without-container/">在非容器环境上实现散装的 IPVS SVC</a></li>
  
    <li><a href="/blog/kubernetes-autoscaling-strategy/">如何选择最佳的 Kubernetes 集群自动伸缩策略</a></li>
  
    <li><a href="/blog/scaling-kubernetes-with-assurance-at-pinterest/">Pinterest 如何有把握地扩展 Kubernetes</a></li>
  
    <li><a href="/blog/202003-k8s-scheduling-framework/">浅谈 Kubernetes Scheduling-Framework 插件的实现</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
    <!-- categories -->
<div class="bg-pink px-4 py-5 box-shadow mb-5">
  <h4 class="mb-4">分类</h4>
  <ul class="list-unstyled">
    <li class="border-bottom"><a href="/categories/devops" class="d-block pb-3 mt-3 text-capitalize">Devops</a></li>
    <li class="border-bottom"><a href="/categories/envoy" class="d-block pb-3 mt-3 text-capitalize">Envoy</a></li>
    <li class="border-bottom"><a href="/categories/istio" class="d-block pb-3 mt-3 text-capitalize">Istio</a></li>
    <li class="border-bottom"><a href="/categories/kubernetes" class="d-block pb-3 mt-3 text-capitalize">Kubernetes</a></li>
    <li class="border-bottom"><a href="/categories/serverless" class="d-block pb-3 mt-3 text-capitalize">Serverless</a></li>
    <li class="border-bottom"><a href="/categories/service-mesh" class="d-block pb-3 mt-3 text-capitalize">Service mesh</a></li>
    <li class="border-bottom"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="d-block pb-3 mt-3 text-capitalize">云原生</a></li>
    <li class="border-bottom"><a href="/categories/%e5%85%b6%e4%bb%96" class="d-block pb-3 mt-3 text-capitalize">其他</a></li>
    <li class="border-bottom"><a href="/categories/%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">可观察性</a></li>
    <li class="border-bottom"><a href="/categories/%e5%ae%89%e5%85%a8" class="d-block pb-3 mt-3 text-capitalize">安全</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90" class="d-block pb-3 mt-3 text-capitalize">开源</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" class="d-block pb-3 mt-3 text-capitalize">开源社区</a></li>
    <li class="border-bottom"><a href="/categories/%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98" class="d-block pb-3 mt-3 text-capitalize">持续交付</a></li>
    <li class="border-bottom"><a href="/categories/%e7%a8%b3%e5%ae%9a%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">稳定性</a></li>
    <li class="border-bottom"><a href="/categories/%e8%be%b9%e7%bc%98%e8%ae%a1%e7%ae%97" class="d-block pb-3 mt-3 text-capitalize">边缘计算</a></li>
  </ul>
</div>

  <!-- tags -->
  

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <div class="mx-auto avatar-wrp">
        <img class="rounded-circle avatar-img" src="https://github.com/mayocream.png">
      </div>
      <p class="avatar-name">
        <strong class="text-dark "><a href="https://github.com/mayocream">黄涵（Mayo Cream）</a></strong> 
      </p>
      <p>CNCF TAG Security 成员，云原生社区贡献者。</p>
    </div>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#如何制造混沌">如何制造混沌</a>
      <ul>
        <li><a href="#特权模式">特权模式</a></li>
        <li><a href="#杀死-pod">杀死 Pod</a></li>
        <li><a href="#网络故障">网络故障</a></li>
        <li><a href="#压力测试">压力测试</a></li>
        <li><a href="#io-注入">IO 注入</a></li>
      </ul>
    </li>
    <li><a href="#控制平面">控制平面</a>
      <ul>
        <li><a href="#职能划分">职能划分</a></li>
        <li><a href="#实施混沌">实施混沌</a></li>
        <li><a href="#混沌编排">混沌编排</a></li>
        <li><a href="#平台功能">平台功能</a></li>
      </ul>
    </li>
    <li><a href="#参阅资料">参阅资料</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是国内最大的独立第三方云原生终端用户和泛开发者社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，提供云原生专业资讯，促进云原生产业发展。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fab fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fab fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://mp.weixin.qq.com/s/vWlSdzz2MNdXRr0sd2-LFg"><i class="fab fa-weixin"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="far fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://zhuanlan.zhihu.com/cloud-native"><i class="fab fa-zhihu"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://space.bilibili.com/515485124"><i class="fas fa-play-circle"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fas fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="/city/chengdu">成都</a>|<a href="/city/shenzhen">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="/city/guangzhou/">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2021 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/policy"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
