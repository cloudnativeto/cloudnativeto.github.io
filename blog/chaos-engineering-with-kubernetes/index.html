<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnativecn.com/blog/chaos-engineering-with-kubernetes/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.008259417e6adf8980695ebbbb46553f.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu11854384586569594417.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu14437075198232143360.png" />

  <link rel="canonical" href="https://cloudnativecn.com/blog/chaos-engineering-with-kubernetes/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnativecn.com/blog/chaos-engineering-with-kubernetes/" />
  <meta property="og:title" content="在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发 | 云原生社区（中国）" />
  <meta property="og:description" content="本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。" /><meta property="og:image" content="https://cloudnativecn.com/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnativecn.com/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2021-10-22T00:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2025-04-21T10:51:03&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnativecn.com/blog/chaos-engineering-with-kubernetes/"
  },
  "headline": "在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发",
  
  "datePublished": "2021-10-22T00:00:00+08:00",
  "dateModified": "2025-04-21T10:51:03+08:00",
  
  "author": {
    "@type": "Person",
    "name": "Mayo Cream"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnativecn.com/media/logo.svg"
    }
  },
  "description": "本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。"
}
</script>

  

  

  

  





  <title>在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="e9e670f3685f652d289dde7260e3ad12" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>云原生资料库</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/mayo-cream/">Mayo Cream</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/%E4%BA%91%E5%8E%9F%E7%94%9F/" class="text-capitalize">云原生</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2021-10-22
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 5287
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 24 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#如何制造混沌">如何制造混沌</a>
      <ul>
        <li><a href="#特权模式">特权模式</a></li>
        <li><a href="#杀死-pod">杀死 Pod</a></li>
        <li><a href="#网络故障">网络故障</a></li>
        <li><a href="#压力测试">压力测试</a></li>
        <li><a href="#io-注入">IO 注入</a></li>
      </ul>
    </li>
    <li><a href="#控制平面">控制平面</a>
      <ul>
        <li><a href="#职能划分">职能划分</a></li>
        <li><a href="#实施混沌">实施混沌</a></li>
        <li><a href="#混沌编排">混沌编排</a></li>
        <li><a href="#平台功能">平台功能</a></li>
      </ul>
    </li>
    <li><a href="#参阅资料">参阅资料</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block my-4">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#如何制造混沌">如何制造混沌</a>
      <ul>
        <li><a href="#特权模式">特权模式</a></li>
        <li><a href="#杀死-pod">杀死 Pod</a></li>
        <li><a href="#网络故障">网络故障</a></li>
        <li><a href="#压力测试">压力测试</a></li>
        <li><a href="#io-注入">IO 注入</a></li>
      </ul>
    </li>
    <li><a href="#控制平面">控制平面</a>
      <ul>
        <li><a href="#职能划分">职能划分</a></li>
        <li><a href="#实施混沌">实施混沌</a></li>
        <li><a href="#混沌编排">混沌编排</a></li>
        <li><a href="#平台功能">平台功能</a></li>
      </ul>
    </li>
    <li><a href="#参阅资料">参阅资料</a></li>
  </ul>
</nav>
</details>

                    
                    <p>Chaos Mesh 是由 TiDB 背后的 PingCAP 公司开发，运行在 Kubernetes 上的混沌工程（Chaos Engineering）系统。简而言之，Chaos Mesh 通过运行在 K8s 集群中的“特权”容器，依据 CRD 资源中的测试场景，在集群中制造浑沌（模拟故障）<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</p>
<p>本文探索混沌工程在 Kubernetes 集群上的实践，基于源码分析了解 Chaos Mesh 的工作原理，以代码示例阐述如何开发 Chaos Mesh 的控制平面。
如果你缺乏基础知识，要想对 Chaos Mesh 的架构有宏观上的认识，请参阅文末尾注中的链接。</p>
<p>本文试验代码位于 <a href="https://github.com/mayocream/chaos-mesh-controlpanel-demo" target="_blank" rel="noopener">mayocream/chaos-mesh-controlpanel-demo</a> 仓库。</p>
<h2 id="如何制造混沌">如何制造混沌</h2>
<p>Chaos Mesh 是在 Kubernetes 上实施混沌工程的利器，那它是如何工作的呢？</p>
<h3 id="特权模式">特权模式</h3>
<p>上面提到 Chaos Mesh 运行 Kubernetes 特权容器来制造故障。Daemon Set 方式运行的 Pod 授权了容器运行时的<a href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#capabilities" target="_blank" rel="noopener">权能字（Capabilities）</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">chaos-daemon</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>{{- <span class="l">if .Values.chaosDaemon.privileged }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">add</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">SYS_PTRACE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>{{- <span class="l">else }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">add</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">SYS_PTRACE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">NET_ADMIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">MKNOD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">SYS_CHROOT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">SYS_ADMIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">KILL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># CAP_IPC_LOCK is used to lock memory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">IPC_LOCK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>{{- <span class="l">end }}</span><span class="w">
</span></span></span></code></pre></div><p>这些 Linux 权能字用于授予容器特权，以创建和访问 <code>/dev/fuse</code> FUSE 管道<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>（FUSE 是 Linux 用户空间文件系统接口，它使无特权的用户能够无需编辑内核代码而创建自己的文件系统）。</p>
<p>参阅 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/1109" target="_blank" rel="noopener">#1109</a> Pull Request，Daemon Set 程序使用 CGO 调用 Linux <code>makedev</code> 函数创建 FUSE 管道。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// #include &lt;sys/sysmacros.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">// #include &lt;sys/types.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">// // makedev is a macro, so a wrapper is needed
</span></span></span><span class="line"><span class="cl"><span class="c1">// dev_t Makedev(unsigned int maj, unsigned int min) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//   return makedev(maj, min);
</span></span></span><span class="line"><span class="cl"><span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// EnsureFuseDev ensures /dev/fuse exists. If not, it will create one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">EnsureFuseDev</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;/dev/fuse&#34;</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 10, 229 according to https://www.kernel.org/doc/Documentation/admin-guide/devices.txt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">fuse</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">Makedev</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">229</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">syscall</span><span class="p">.</span><span class="nf">Mknod</span><span class="p">(</span><span class="s">&#34;/dev/fuse&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="nx">o666</span><span class="p">|</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">S_IFCHR</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">fuse</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>同时在 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/1453" target="_blank" rel="noopener">#1103</a> PR 中，Chaos Daemon 默认启用特权模式，即容器的 <code>securityContext</code> 中设置 <code>privileged: true</code>。</p>
<h3 id="杀死-pod">杀死 Pod</h3>
<p>PodKill、PodFailure、ContainerKill 都归属于 PodChaos 类别下，PodKill 是随机杀死 Pod。</p>
<p>PodKill 的具体实现其实是通过调用 API Server 发送 Kill 命令。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">v1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Impl</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">impl</span> <span class="o">*</span><span class="nx">Impl</span><span class="p">)</span> <span class="nf">Apply</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">index</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">records</span> <span class="p">[]</span><span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">Record</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">InnerObject</span><span class="p">)</span> <span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">Phase</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">impl</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">namespacedName</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// TODO: handle this error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">NotInjected</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">impl</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pod</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">client</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">GracePeriodSeconds</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">podchaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">GracePeriod</span><span class="p">,</span> <span class="c1">// PeriodSeconds has to be set specifically
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">Injected</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>GracePeriodSeconds</code> 参数适用于 K8s <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination-forced" target="_blank" rel="noopener">强制终止 Pod</a>。例如在需要快速删除 Pod 时，我们使用 <code>kubectl delete pod --grace-period=0 --force</code> 命令。</p>
<p>PodFailure 是通过 Patch Pod 对象资源，用错误的镜像替换 Pod 中的镜像。Chaos 只修改了 <code>containers</code> 和 <code>initContainers</code> 的 <code>image</code> 字段，这也是因为 Pod 大部分字段是无法更改的，详情可以参阅 <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#pod-update-and-replacement" target="_blank" rel="noopener">Pod 更新与替换</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">impl</span> <span class="o">*</span><span class="nx">Impl</span><span class="p">)</span> <span class="nf">Apply</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">index</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">records</span> <span class="p">[]</span><span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">Record</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">InnerObject</span><span class="p">)</span> <span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">Phase</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pod</span> <span class="o">:=</span> <span class="nx">origin</span><span class="p">.</span><span class="nf">DeepCopy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">index</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">originImage</span> <span class="o">:=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Image</span>
</span></span><span class="line"><span class="cl">		<span class="nx">name</span> <span class="o">:=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">key</span> <span class="o">:=</span> <span class="nx">annotation</span><span class="p">.</span><span class="nf">GenKeyForImage</span><span class="p">(</span><span class="nx">podchaos</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// If the annotation is already existed, we could skip the reconcile for this container
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">originImage</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Image</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ControllerCfg</span><span class="p">.</span><span class="nx">PodFailurePauseImage</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">index</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">InitContainers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">originImage</span> <span class="o">:=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">InitContainers</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Image</span>
</span></span><span class="line"><span class="cl">		<span class="nx">name</span> <span class="o">:=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">InitContainers</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">key</span> <span class="o">:=</span> <span class="nx">annotation</span><span class="p">.</span><span class="nf">GenKeyForImage</span><span class="p">(</span><span class="nx">podchaos</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// If the annotation is already existed, we could skip the reconcile for this container
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pod</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">originImage</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">InitContainers</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Image</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ControllerCfg</span><span class="p">.</span><span class="nx">PodFailurePauseImage</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">impl</span><span class="p">.</span><span class="nf">Patch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nf">MergeFrom</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">origin</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// TODO: handle this error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">NotInjected</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">Injected</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认用于引发故障的容器镜像是 <code>gcr.io/google-containers/pause:latest</code>，如果在国内环境使用，大概率会水土不服，可以将 <code>gcr.io</code> 替换为 <code>registry.aliyuncs.com</code>。</p>
<p>ContainerKill 不同于 PodKill 和 PodFailure，后两个都是通过 K8s API Server 控制 Pod 生命周期，而 ContainerKill 是通过运行在集群 Node 上的 Chaos Daemon 程序操作完成。具体来说，ContainerKill 通过 Chaos Controller Manager 运行客户端向 Chaos Daemon 发起 grpc 调用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">ChaosDaemonClientBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="p">(</span><span class="nx">chaosdaemonclient</span><span class="p">.</span><span class="nx">ChaosDaemonClientInterface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">daemonIP</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">FindDaemonIP</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">builder</span> <span class="o">:=</span> <span class="nx">grpcUtils</span><span class="p">.</span><span class="nf">Builder</span><span class="p">(</span><span class="nx">daemonIP</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ControllerCfg</span><span class="p">.</span><span class="nx">ChaosDaemonPort</span><span class="p">).</span><span class="nf">WithDefaultTimeout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ControllerCfg</span><span class="p">.</span><span class="nx">TLSConfig</span><span class="p">.</span><span class="nx">ChaosMeshCACert</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">builder</span><span class="p">.</span><span class="nf">TLSFromFile</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">ControllerCfg</span><span class="p">.</span><span class="nx">TLSConfig</span><span class="p">.</span><span class="nx">ChaosMeshCACert</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ControllerCfg</span><span class="p">.</span><span class="nx">TLSConfig</span><span class="p">.</span><span class="nx">ChaosDaemonClientCert</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ControllerCfg</span><span class="p">.</span><span class="nx">TLSConfig</span><span class="p">.</span><span class="nx">ChaosDaemonClientKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">builder</span><span class="p">.</span><span class="nf">Insecure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">chaosdaemonclient</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cc</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>向 Chaos Daemon 发送命令时会依据 Pod 信息创建对应的客户端，例如要控制某个 Node 上的 Pod，会获取该 Pod 所在 Node 的 ClusterIP，以创建客户端。如果 TLS 证书配置存在，Controller Manager 会为客户端添加 TLS 证书。</p>
<p>Chaos Daemon 在启动时如果有 TLS 证书，会附加证书以启用 grpcs。TLS 校验配置 <code>RequireAndVerifyClientCert</code> 表示启用双向 TLS 认证（mTLS）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newGRPCServer</span><span class="p">(</span><span class="nx">containerRuntime</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">reg</span> <span class="nx">prometheus</span><span class="p">.</span><span class="nx">Registerer</span><span class="p">,</span> <span class="nx">tlsConf</span> <span class="nx">tlsConfig</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tlsConf</span> <span class="o">!=</span> <span class="p">(</span><span class="nx">tlsConfig</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">caCert</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">tlsConf</span><span class="p">.</span><span class="nx">CaCert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">caCertPool</span> <span class="o">:=</span> <span class="nx">x509</span><span class="p">.</span><span class="nf">NewCertPool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">caCertPool</span><span class="p">.</span><span class="nf">AppendCertsFromPEM</span><span class="p">(</span><span class="nx">caCert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">serverCert</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tls</span><span class="p">.</span><span class="nf">LoadX509KeyPair</span><span class="p">(</span><span class="nx">tlsConf</span><span class="p">.</span><span class="nx">Cert</span><span class="p">,</span> <span class="nx">tlsConf</span><span class="p">.</span><span class="nx">Key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">creds</span> <span class="o">:=</span> <span class="nx">credentials</span><span class="p">.</span><span class="nf">NewTLS</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Certificates</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">{</span><span class="nx">serverCert</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ClientCAs</span><span class="p">:</span>    <span class="nx">caCertPool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ClientAuth</span><span class="p">:</span>   <span class="nx">tls</span><span class="p">.</span><span class="nx">RequireAndVerifyClientCert</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">grpcOpts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">grpcOpts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">Creds</span><span class="p">(</span><span class="nx">creds</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">grpcOpts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">grpcMetrics</span><span class="p">.</span><span class="nf">InitializeMetrics</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterChaosDaemonServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">ds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">reflection</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Chaos Daemon 提供了以下 grpc 调用接口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ChaosDaemonClient is the client API for ChaosDaemon service.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ChaosDaemonClient</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SetTcs</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">TcsRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">FlushIPSets</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">IPSetsRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SetIptablesChains</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">IptablesChainsRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SetTimeOffset</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">TimeRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RecoverTimeOffset</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">TimeRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ContainerKill</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">ContainerRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ContainerGetPid</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">ContainerRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ContainerResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ExecStressors</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">ExecStressRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ExecStressResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CancelStressors</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">CancelStressRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ApplyIOChaos</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">ApplyIOChaosRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ApplyIOChaosResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ApplyHttpChaos</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">ApplyHttpChaosRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ApplyHttpChaosResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SetDNSServer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">SetDNSServerRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="网络故障">网络故障</h3>
<p>从最初的 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/41" target="_blank" rel="noopener">#41</a> PR 中，可以清晰地了解到，Chaos Mesh 的网络错误注入是通过调用 <code>pbClient.SetNetem</code> 方法，将参数封装成请求，交给 Node 上的 Chaos Daemon 处理的。</p>
<p>（注：这是 2019 年初期的代码，随着项目发展，代码中的函数已分散到不同的文件中）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reconciler</span><span class="p">)</span> <span class="nf">applyPod</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">networkchaos</span> <span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">NetworkChaos</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pbClient</span> <span class="o">:=</span> <span class="nx">pb</span><span class="p">.</span><span class="nf">NewChaosDaemonClient</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">containerId</span> <span class="o">:=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ContainerStatuses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">ContainerID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">netem</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">spec</span><span class="p">.</span><span class="nf">ToNetem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pbClient</span><span class="p">.</span><span class="nf">SetNetem</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">NetemRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerId</span><span class="p">:</span> <span class="nx">containerId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Netem</span><span class="p">:</span>       <span class="nx">netem</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>同时在 <code>pkg/chaosdaemon</code> 包中，我们能看到 Chaos Daemon 处理请求的方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">SetNetem</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">NetemRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Set netem&#34;</span><span class="p">,</span> <span class="s">&#34;Request&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">crClient</span><span class="p">.</span><span class="nf">GetPidFromContainerID</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">ContainerId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Internal</span><span class="p">,</span> <span class="s">&#34;get pid from containerID error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Apply</span><span class="p">(</span><span class="nx">in</span><span class="p">.</span><span class="nx">Netem</span><span class="p">,</span> <span class="nx">pid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Internal</span><span class="p">,</span> <span class="s">&#34;netem apply error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Apply applies a netem on eth0 in pid related namespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Apply</span><span class="p">(</span><span class="nx">netem</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">Netem</span><span class="p">,</span> <span class="nx">pid</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Apply netem on PID&#34;</span><span class="p">,</span> <span class="s">&#34;pid&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">netns</span><span class="p">.</span><span class="nf">GetFromPath</span><span class="p">(</span><span class="nf">GenNetnsPath</span><span class="p">(</span><span class="nx">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to find network namespace&#34;</span><span class="p">,</span> <span class="s">&#34;pid&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">ns</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">handle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">netlink</span><span class="p">.</span><span class="nf">NewHandleAt</span><span class="p">(</span><span class="nx">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to get handle at network namespace&#34;</span><span class="p">,</span> <span class="s">&#34;network namespace&#34;</span><span class="p">,</span> <span class="nx">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">link</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">handle</span><span class="p">.</span><span class="nf">LinkByName</span><span class="p">(</span><span class="s">&#34;eth0&#34;</span><span class="p">)</span> <span class="c1">// TODO: check whether interface name is eth0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to find eth0 interface&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">netemQdisc</span> <span class="o">:=</span> <span class="nx">netlink</span><span class="p">.</span><span class="nf">NewNetem</span><span class="p">(</span><span class="nx">netlink</span><span class="p">.</span><span class="nx">QdiscAttrs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LinkIndex</span><span class="p">:</span> <span class="nx">link</span><span class="p">.</span><span class="nf">Attrs</span><span class="p">().</span><span class="nx">Index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Handle</span><span class="p">:</span>    <span class="nx">netlink</span><span class="p">.</span><span class="nf">MakeHandle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Parent</span><span class="p">:</span>    <span class="nx">netlink</span><span class="p">.</span><span class="nx">HANDLE_ROOT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nf">ToNetlinkNetemAttrs</span><span class="p">(</span><span class="nx">netem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">handle</span><span class="p">.</span><span class="nf">QdiscAdd</span><span class="p">(</span><span class="nx">netemQdisc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="s">&#34;file exists&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to add Qdisc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>最终使用 <a href="https://github.com/vishvananda/netlink" target="_blank" rel="noopener">vishvananda/netlink</a> 库操作 Linux 网络接口来完成工作。</p>
<p>这里能够知道，NetworkChaos 混沌类型，操作了 Linux 宿主机网络来制造混沌，包含 iptables、ipset 等工具。</p>
<p>在 Chaos Daemon 的 Dockerfile 中，可以看到其依赖的 Linux 工具链：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> <span class="se">\ </span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    apt-get install -y tzdata iptables ipset stress-ng iproute2 fuse util-linux procps curl <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    rm -rf /var/lib/apt/lists/*<span class="err">
</span></span></span></code></pre></div><h3 id="压力测试">压力测试</h3>
<p>StressChaos 类型的混沌也是由 Chaos Daemon 实施的，Controller Manager 计算好规则后就将任务下发到具体的 Daemon 上。拼装的参数如下，这些参数会组合成命令执行的参数，附加到 <code>stress-ng</code> 命令后执行<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Normalize the stressors to comply with stress-ng
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">Stressors</span><span class="p">)</span> <span class="nf">Normalize</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stressors</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Workers</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">stressors</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34; --vm %d --vm-keep&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Workers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Size</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Size</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;%&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">units</span><span class="p">.</span><span class="nf">FromHumanSize</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">stressors</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34; --vm-bytes %d&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">stressors</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34; --vm-bytes %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">in</span><span class="p">.</span><span class="nx">MemoryStressor</span><span class="p">.</span><span class="nx">Options</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">stressors</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34; %v &#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">CPUStressor</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">in</span><span class="p">.</span><span class="nx">CPUStressor</span><span class="p">.</span><span class="nx">Workers</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">stressors</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34; --cpu %d&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">CPUStressor</span><span class="p">.</span><span class="nx">Workers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">CPUStressor</span><span class="p">.</span><span class="nx">Load</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">stressors</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34; --cpu-load %d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="o">*</span><span class="nx">in</span><span class="p">.</span><span class="nx">CPUStressor</span><span class="p">.</span><span class="nx">Load</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">CPUStressor</span><span class="p">.</span><span class="nx">Options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">in</span><span class="p">.</span><span class="nx">CPUStressor</span><span class="p">.</span><span class="nx">Options</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">stressors</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34; %v &#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">stressors</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Chaos Daemon 服务端处理函数中调用 Go 官方包 <code>os/exec</code> 执行命令，再大段贴代码就没有意思了，具体可以阅读 <a href="https://github.com/chaos-mesh/chaos-mesh/blob/98af3a0e7832a4971d6b133a32069539d982ef0a/pkg/chaosdaemon/stress_server_linux.go#L33" target="_blank" rel="noopener">pkg/chaosdaemon/stress_server_linux.go</a> 文件。同名文件还有以 darwin 结尾的，推测是为了在 macOS 上开发调试方便。</p>
<p>代码中使用 <a href="https://github.com/shirou/gopsutil" target="_blank" rel="noopener">shirou/gopsutil</a> 包获取 PID 进程状态，并读取了 stdout、stderr 等标准输出，这种处理模式我在 <a href="https://github.com/hashicorp/go-plugin" target="_blank" rel="noopener">hashicorp/go-plugin</a> 见过，go-plugin 在这方面做得更加优秀。我的另一篇文章 Dkron 源码分析中提到了它<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>。</p>
<h3 id="io-注入">IO 注入</h3>
<p>开篇就提到了 Chaos Mesh 使用了特权容器，用于挂载宿主机上的 FUSE 设备 <code>/dev/fuse</code>。</p>
<p>看到这里，我铁定以为 Chaos Mesh 是使用 <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook" target="_blank" rel="noopener">Mutating 准入控制器</a>进行 Sidecar 容器的注入，挂载 FUSE 设备，或修改 Pod Volumes Mount 等配置，然后它的实现方式与直观上不同。</p>
<p>仔细看了 <a href="https://github.com/chaos-mesh/chaos-mesh/pull/826" target="_blank" rel="noopener">#826</a> PR，这个 PR 引入了新的 IOChaos 的实现，避免使用 Sidecar 注入的方式，而采用 Chaos Daemon 直接通过 runc 容器底层命令操作 Linux 命名空间，运行用 Rust 开发的 <a href="https://github.com/chaos-mesh/toda" target="_blank" rel="noopener">chaos-mesh/toda</a> FUSE 程序（使用 <a href="https://pkg.go.dev/github.com/ethereum/go-ethereum/rpc" target="_blank" rel="noopener">JSON-RPC 2.0</a> 协议通信）进行容器 IO 混沌注入。</p>
<p>关注新的 IOChaos 实现，它不会修改 Pod 资源，IOChaos 混沌实验定义被创建时，针对选择器（selector 字段）筛选出的每一个 Pod，对应的一个 PodIoChaos 资源会被创建，PodIoChaos 的<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/" target="_blank" rel="noopener">属主引用（Owner Reference）</a>为该 Pod。PodIoChaos 同时会被添加上一组 <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/" target="_blank" rel="noopener">Finalizers</a>，用于在被删除前释放 PodIoChaos 资源。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Apply implements the reconciler.InnerReconciler.Apply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reconciler</span><span class="p">)</span> <span class="nf">Apply</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">chaos</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">InnerObject</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">iochaos</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">chaos</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">IoChaos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;chaos is not IoChaos&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;chaos is not IoChaos&#34;</span><span class="p">,</span> <span class="s">&#34;chaos&#34;</span><span class="p">,</span> <span class="nx">chaos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">source</span> <span class="o">:=</span> <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Namespace</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Name</span>
</span></span><span class="line"><span class="cl">	<span class="nx">m</span> <span class="o">:=</span> <span class="nx">podiochaosmanager</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Client</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pods</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">SelectAndFilterPods</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to select and filter pods&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;applying iochaos&#34;</span><span class="p">,</span> <span class="s">&#34;iochaos&#34;</span><span class="p">,</span> <span class="nx">iochaos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pods</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">WithInit</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>      <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Namespace</span><span class="p">:</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// TODO: support chaos on multiple volume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">t</span><span class="p">.</span><span class="nf">SetVolumePath</span><span class="p">(</span><span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">IoChaosAction</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span> <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Action</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Filter</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">Filter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Path</span><span class="p">:</span>    <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Percent</span><span class="p">:</span> <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Percent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Methods</span><span class="p">:</span> <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Methods</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Faults</span><span class="p">:</span> <span class="p">[]</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">IoFault</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Errno</span><span class="p">:</span>  <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Errno</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Weight</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Latency</span><span class="p">:</span>          <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Delay</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">AttrOverrideSpec</span><span class="p">:</span> <span class="nx">iochaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Attr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>           <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">key</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">MetaNamespaceKeyFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">iochaos</span><span class="p">.</span><span class="nx">Finalizers</span> <span class="p">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">InsertFinalizer</span><span class="p">(</span><span class="nx">iochaos</span><span class="p">.</span><span class="nx">Finalizers</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;commiting updates of podiochaos&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Commit</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;fail to commit&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nf">Event</span><span class="p">(</span><span class="nx">iochaos</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeNormal</span><span class="p">,</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">EventChaosInjected</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在 PodIoChaos 资源的控制器中，Controller Manager 会将资源封装成参数，调用 Chaos Daemon 接口进行实际处理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Apply flushes io configuration on pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nf">Apply</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">chaos</span> <span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodIoChaos</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">h</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;updating io chaos&#34;</span><span class="p">,</span> <span class="s">&#34;pod&#34;</span><span class="p">,</span> <span class="nx">chaos</span><span class="p">.</span><span class="nx">Namespace</span><span class="o">+</span><span class="s">&#34;/&#34;</span><span class="o">+</span><span class="nx">chaos</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="s">&#34;spec&#34;</span><span class="p">,</span> <span class="nx">chaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pbClient</span><span class="p">.</span><span class="nf">ApplyIoChaos</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">ApplyIoChaosRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Actions</span><span class="p">:</span>     <span class="nx">input</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Volume</span><span class="p">:</span>      <span class="nx">chaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">VolumeMountPath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerId</span><span class="p">:</span> <span class="nx">containerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">Instance</span><span class="p">:</span>  <span class="nx">chaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">StartTime</span><span class="p">:</span> <span class="nx">chaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">StartTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">chaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Pid</span> <span class="p">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Instance</span>
</span></span><span class="line"><span class="cl">	<span class="nx">chaos</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">StartTime</span> <span class="p">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">StartTime</span>
</span></span><span class="line"><span class="cl">	<span class="nx">chaos</span><span class="p">.</span><span class="nx">OwnerReferences</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">OwnerReference</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">APIVersion</span><span class="p">:</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">APIVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Kind</span><span class="p">:</span>       <span class="nx">pod</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>       <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">UID</span><span class="p">:</span>        <span class="nx">pod</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在 Chaos Daemon 中处理 IOChaos 的代码文件 <code>pkg/chaosdaemon/iochaos_server.go</code> 中，容器需要被注入一个 FUSE 程序，通过 <a href="https://github.com/chaos-mesh/chaos-mesh/issues/2305" target="_blank" rel="noopener">#2305</a> Issue，可以了解到执行了 <code>/usr/local/bin/nsexec -l -p /proc/119186/ns/pid -m /proc/119186/ns/mnt -- /usr/local/bin/toda --path /tmp --verbose info</code> 命令，以在特定的 Linux 命名空间（Namespace）下运行 toda 程序，即与 Pod 在同一个命名空间下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">DaemonServer</span><span class="p">)</span> <span class="nf">ApplyIOChaos</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">ApplyIOChaosRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">ApplyIOChaosResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">crClient</span><span class="p">.</span><span class="nf">GetPidFromContainerID</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">ContainerId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;error while getting PID&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;--path %s --verbose info&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Volume</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;executing&#34;</span><span class="p">,</span> <span class="s">&#34;cmd&#34;</span><span class="p">,</span> <span class="nx">todaBin</span><span class="o">+</span><span class="s">&#34; &#34;</span><span class="o">+</span><span class="nx">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">processBuilder</span> <span class="o">:=</span> <span class="nx">bpm</span><span class="p">.</span><span class="nf">DefaultProcessBuilder</span><span class="p">(</span><span class="nx">todaBin</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">)</span><span class="o">...</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">EnableLocalMnt</span><span class="p">().</span>
</span></span><span class="line"><span class="cl">		<span class="nf">SetIdentifier</span><span class="p">(</span><span class="nx">in</span><span class="p">.</span><span class="nx">ContainerId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">in</span><span class="p">.</span><span class="nx">EnterNS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">processBuilder</span> <span class="p">=</span> <span class="nx">processBuilder</span><span class="p">.</span><span class="nf">SetNS</span><span class="p">(</span><span class="nx">pid</span><span class="p">,</span> <span class="nx">bpm</span><span class="p">.</span><span class="nx">MountNS</span><span class="p">).</span><span class="nf">SetNS</span><span class="p">(</span><span class="nx">pid</span><span class="p">,</span> <span class="nx">bpm</span><span class="p">.</span><span class="nx">PidNS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// JSON RPC 调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">jrpc</span><span class="p">.</span><span class="nf">DialIO</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">,</span> <span class="nx">caller</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">processBuilder</span><span class="p">.</span><span class="nf">Build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">procState</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">backgroundProcessManager</span><span class="p">.</span><span class="nf">StartProcess</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>下面这段代码最终构建了运行的命令，而这些命令正是 <a href="https://github.com/opencontainers/runc" target="_blank" rel="noopener">runc</a> 底层的 Namespace 隔离实现<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// GetNsPath returns corresponding namespace path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetNsPath</span><span class="p">(</span><span class="nx">pid</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">typ</span> <span class="nx">NsType</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s/%d/ns/%s&#34;</span><span class="p">,</span> <span class="nx">DefaultProcPrefix</span><span class="p">,</span> <span class="nx">pid</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">typ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SetNS sets the namespace of the process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">ProcessBuilder</span><span class="p">)</span> <span class="nf">SetNS</span><span class="p">(</span><span class="nx">pid</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">typ</span> <span class="nx">NsType</span><span class="p">)</span> <span class="o">*</span><span class="nx">ProcessBuilder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nf">SetNSOpt</span><span class="p">([]</span><span class="nx">nsOption</span><span class="p">{{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Typ</span><span class="p">:</span>  <span class="nx">typ</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Path</span><span class="p">:</span> <span class="nf">GetNsPath</span><span class="p">(</span><span class="nx">pid</span><span class="p">,</span> <span class="nx">typ</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Build builds the process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">ProcessBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">()</span> <span class="o">*</span><span class="nx">ManagedProcess</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">args</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">cmd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">nsOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;--&#34;</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">},</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">option</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">nsOptions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;-&#34;</span> <span class="o">+</span> <span class="nx">nsArgMap</span><span class="p">[</span><span class="nx">option</span><span class="p">.</span><span class="nx">Typ</span><span class="p">],</span> <span class="nx">option</span><span class="p">.</span><span class="nx">Path</span><span class="p">},</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">localMnt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;-l&#34;</span><span class="p">},</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cmd</span> <span class="p">=</span> <span class="nx">nsexecPath</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="控制平面">控制平面</h2>
<p>Chaos Mesh 是一个开源的混沌工程系统，以 Apache 2.0 协议开源，经过以上分析知道它的能力丰富，并且它的生态良好，维护团队围绕混沌系统研发了用户态文件系统（FUSE）<a href="https://github.com/chaos-mesh/toda" target="_blank" rel="noopener">chaos-mesh/toda</a> 、CoreDNS 混沌插件 <a href="https://github.com/chaos-mesh/k8s_dns_chaos" target="_blank" rel="noopener">chaos-mesh/k8s_dns_chaos</a>、基于 BPF 的内核错误注入 <a href="https://github.com/chaos-mesh/bpfki" target="_blank" rel="noopener">chaos-mesh/bpfki</a> 等。</p>
<p>下述如果我想要建立一个面向终端用户的混沌工程平台，在服务端实现的代码应该是怎样的。示例仅为一种实践，并不代表最佳实践，如果想看 Real World 平台的开发实践的话，可以参考 Chaos Mesh 官方的 <a href="https://github.com/chaos-mesh/chaos-mesh/tree/master/pkg/dashboard" target="_blank" rel="noopener">Dashboard</a>，内部使用了 <a href="https://github.com/uber-go/fx" target="_blank" rel="noopener">uber-go/fx</a> 依赖注入框架和 controller runtime 的 manager 模式。</p>
<h3 id="职能划分">职能划分</h3>
<p>















<figure  id="figure-chaos-mesh-的基本工作流原理图">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Chaos Mesh 的基本工作流原理图" srcset="
               /blog/chaos-engineering-with-kubernetes/4_d0e6bfad2a_hu1778765232209465122.webp 400w,
               /blog/chaos-engineering-with-kubernetes/4_d0e6bfad2a_hu5306651859791968205.webp 760w,
               /blog/chaos-engineering-with-kubernetes/4_d0e6bfad2a_hu1320662706098551643.webp 1200w"
               src="/blog/chaos-engineering-with-kubernetes/4_d0e6bfad2a_hu1778765232209465122.webp"
               width="760"
               height="350"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Chaos Mesh 的基本工作流原理图
    </figcaption></figure>
</p>
<p>这里标题虽是控制平面，但查看上述 Chaos Mesh 工作流程图，其实我们需要做的只是实现一个将 YAML 下发到 Kubernetes API 的服务器，复杂的规则校验、规则下发到 Chaos Daemon 的行为是由 Chaos Controller Manager 完成的。想要结合自己的平台使用，只需要对接 CRD 资源创建的过程就足够了。</p>
<p>我们来看一下 PingCAP 官方给出的示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/pingcap/chaos-mesh/api/v1alpha1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">delay</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">chaosv1alpha1</span><span class="p">.</span><span class="nx">NetworkChaos</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Spec</span><span class="p">:</span> <span class="nx">chaosv1alpha1</span><span class="p">.</span><span class="nx">NetworkChaosSpec</span><span class="p">{</span><span class="o">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">k8sClient</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span> <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">Scheme</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">k8sClient</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Chaos Mesh 已经提供了所有的 CRD 资源定义对应的 API，我们使用 Kubernetes <a href="https://github.com/kubernetes/community/tree/master/sig-api-machinery" target="_blank" rel="noopener">API Machinery SIG</a> 开发的 <a href="https://github.com/kubernetes-sigs/controller-runtime" target="_blank" rel="noopener">controller-runtime</a> 来简化与 Kubernetes API 的交互。</p>
<h3 id="实施混沌">实施混沌</h3>
<p>例如我们想通过程序调用的方式，创建一个 PodKill 资源，该资源被发送到 Kubernetes API Server 后，会经由  Chaos Controller Manager 的 <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook/" target="_blank" rel="noopener">Validating 准入控制器</a>，进行数据校验，若数据格式验证失败，会在创建时返回错误。具体参数可以查阅官方文档<a href="https://chaos-mesh.org/zh/docs/simulate-pod-chaos-on-kubernetes/#%E4%BD%BF%E7%94%A8-yaml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E5%AE%9E%E9%AA%8C" target="_blank" rel="noopener">使用 YAML 配置文件创建实验</a>。</p>
<p><code>NewClient</code> 创建了一个 K8s API Client，可以参考<a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.10.2/pkg/client#example-New" target="_blank" rel="noopener">客户端创建示例</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;controlpanel&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/chaos-mesh/chaos-mesh/api/v1alpha1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/pkg/errors&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">applyPodKill</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">labels</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cli</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">controlpanel</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;create client&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodChaos</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">GenerateName</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Namespace</span><span class="p">:</span>    <span class="nx">namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Spec</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodChaosSpec</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Action</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodKillAction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ContainerSelector</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">ContainerSelector</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">PodSelector</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodSelector</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Mode</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">OnePodMode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Selector</span><span class="p">:</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodSelectorSpec</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">Namespaces</span><span class="p">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">namespace</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">						<span class="nx">LabelSelectors</span><span class="p">:</span> <span class="nx">labels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="p">},</span>
</span></span><span class="line"><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">cr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;create podkill&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>运行程序的日志输出为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">I1021 00:51:55.225502   <span class="m">23781</span> request.go:665<span class="o">]</span> Waited <span class="k">for</span> 1.033116256s due to client-side throttling, not priority and fairness, request: GET:https://***
</span></span><span class="line"><span class="cl">2021/10/21 00:51:56 apply podkill
</span></span></code></pre></div><p>通过 kubectl 查看 PodKill 资源的状态：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ k describe podchaos.chaos-mesh.org -n dev podkillvjn77
</span></span><span class="line"><span class="cl">Name:         podkillvjn77
</span></span><span class="line"><span class="cl">Namespace:    dev
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">API Version:  chaos-mesh.org/v1alpha1
</span></span><span class="line"><span class="cl">Kind:         PodChaos
</span></span><span class="line"><span class="cl">Metadata:
</span></span><span class="line"><span class="cl">  Creation Timestamp:  2021-10-20T16:51:56Z
</span></span><span class="line"><span class="cl">  Finalizers:
</span></span><span class="line"><span class="cl">    chaos-mesh/records
</span></span><span class="line"><span class="cl">  Generate Name:     podkill
</span></span><span class="line"><span class="cl">  Generation:        <span class="m">7</span>
</span></span><span class="line"><span class="cl">  Resource Version:  <span class="m">938921488</span>
</span></span><span class="line"><span class="cl">  Self Link:         /apis/chaos-mesh.org/v1alpha1/namespaces/dev/podchaos/podkillvjn77
</span></span><span class="line"><span class="cl">  UID:               afbb40b3-ade8-48ba-89db-04918d89fd0b
</span></span><span class="line"><span class="cl">Spec:
</span></span><span class="line"><span class="cl">  Action:        pod-kill
</span></span><span class="line"><span class="cl">  Grace Period:  <span class="m">0</span>
</span></span><span class="line"><span class="cl">  Mode:          one
</span></span><span class="line"><span class="cl">  Selector:
</span></span><span class="line"><span class="cl">    Label Selectors:
</span></span><span class="line"><span class="cl">      app:  nginx
</span></span><span class="line"><span class="cl">    Namespaces:
</span></span><span class="line"><span class="cl">      dev
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Conditions:
</span></span><span class="line"><span class="cl">    Reason:  
</span></span><span class="line"><span class="cl">    Status:  False
</span></span><span class="line"><span class="cl">    Type:    Paused
</span></span><span class="line"><span class="cl">    Reason:  
</span></span><span class="line"><span class="cl">    Status:  True
</span></span><span class="line"><span class="cl">    Type:    Selected
</span></span><span class="line"><span class="cl">    Reason:  
</span></span><span class="line"><span class="cl">    Status:  True
</span></span><span class="line"><span class="cl">    Type:    AllInjected
</span></span><span class="line"><span class="cl">    Reason:  
</span></span><span class="line"><span class="cl">    Status:  False
</span></span><span class="line"><span class="cl">    Type:    AllRecovered
</span></span><span class="line"><span class="cl">  Experiment:
</span></span><span class="line"><span class="cl">    Container Records:
</span></span><span class="line"><span class="cl">      Id:            dev/nginx
</span></span><span class="line"><span class="cl">      Phase:         Injected
</span></span><span class="line"><span class="cl">      Selector Key:  .
</span></span><span class="line"><span class="cl">    Desired Phase:   Run
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason           Age    From          Message
</span></span><span class="line"><span class="cl">  ----    ------           ----   ----          -------
</span></span><span class="line"><span class="cl">  Normal  FinalizerInited  6m35s  finalizer     Finalizer has been inited
</span></span><span class="line"><span class="cl">  Normal  Updated          6m35s  finalizer     Successfully update finalizer of resource
</span></span><span class="line"><span class="cl">  Normal  Updated          6m35s  records       Successfully update records of resource
</span></span><span class="line"><span class="cl">  Normal  Updated          6m35s  desiredphase  Successfully update desiredPhase of resource
</span></span><span class="line"><span class="cl">  Normal  Applied          6m35s  records       Successfully apply chaos <span class="k">for</span> dev/nginx
</span></span><span class="line"><span class="cl">  Normal  Updated          6m35s  records       Successfully update records of resource
</span></span></code></pre></div><p>控制面还自然而然要有查询和获取 Chaos 资源的功能，方便平台用户查看到所有的混沌试验的实施状态，对其进行管理。当然，这里无非是调用 REST API 发送 Get/List 请求，但在实践上细节需要留意，敝司就发生过 Controller 每次请求全量的资源数据，造成 K8s API Server 的负载增高。</p>
<p>这里十分推荐阅读 <a href="https://zoetrope.github.io/kubebuilder-training/controller-runtime/client.html" target="_blank" rel="noopener">クライアントの使い方</a>，这篇 controller runtime 使用教程，提到了很细节的地方。例如 controller runtime 默认会从多个位置读取 kubeconfig，flag、环境变量、再是自动挂载在 Pod 中的 Service Account，<a href="https://github.com/armosec/kubescape" target="_blank" rel="noopener">armosec/kubescape</a> <a href="https://github.com/armosec/kubescape/pull/21" target="_blank" rel="noopener">#21</a> PR 也是利用了该特性。这篇教程还包括了如何分页、更新、覆盖对象等常用的操作，我目前还没有看到有哪篇中文、英文教程有这么详细。</p>
<p>Get/List 请求示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">controlpanel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/chaos-mesh/chaos-mesh/api/v1alpha1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/pkg/errors&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetPodChaos</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodChaos</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cli</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">item</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodChaos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">client</span><span class="p">.</span><span class="nx">ObjectKey</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">namespace</span><span class="p">},</span> <span class="nx">item</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;get cr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">item</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ListPodChaos</span><span class="p">(</span><span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">labels</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodChaos</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cli</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">list</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">PodChaosList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nf">InNamespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">),</span> <span class="nx">client</span><span class="p">.</span><span class="nf">MatchingLabels</span><span class="p">(</span><span class="nx">labels</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Items</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>示例中使用了 manager，该模式下会启用 cache 机制，避免重复获取大量数据。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/chaos-engineering-with-kubernetes/cache_hu8530264592940307326.webp 400w,
               /blog/chaos-engineering-with-kubernetes/cache_hu8317843759316683853.webp 760w,
               /blog/chaos-engineering-with-kubernetes/cache_hu8048840279667558842.webp 1200w"
               src="/blog/chaos-engineering-with-kubernetes/cache_hu8530264592940307326.webp"
               width="760"
               height="428"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<ol>
<li>获取 Pod</li>
<li>初次获取全量数据（List）</li>
<li>Watch 数据变化时更新缓存</li>
</ol>
<h3 id="混沌编排">混沌编排</h3>
<p>就如同 CRI 容器运行时提供了强大的底层隔离能力，能够支撑容器的稳定运行，而想要更大规模、更复杂的场景就需要容器编排一样，Chaos Mesh 提供了 Schedule 和 Workflow 功能。<a href="https://chaos-mesh.org/zh/docs/define-scheduling-rules/" target="_blank" rel="noopener">Schedule</a> 能够根据设定的 Cron 时间定时、间隔地触发故障，<a href="https://chaos-mesh.org/zh/docs/create-chaos-mesh-workflow/" target="_blank" rel="noopener">Workflow</a> 能像 Argo Workflow 一样编排多个故障试验。</p>
<p>当然，Chaos Controller Manager 替我们做了大部分工作，控制面所需要的还是管理这些 YAML 资源，唯一需要考虑的是要给用户提供怎样的功能。</p>
<h3 id="平台功能">平台功能</h3>
<p>参考 Chaos Mesh Dashboard，我们需要考虑平台该提供哪些功能给终端用户。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/chaos-engineering-with-kubernetes/image-20211021030337926-16347566199512_hu9402193779835002332.webp 400w,
               /blog/chaos-engineering-with-kubernetes/image-20211021030337926-16347566199512_hu9074003006261223364.webp 760w,
               /blog/chaos-engineering-with-kubernetes/image-20211021030337926-16347566199512_hu14623391612030035962.webp 1200w"
               src="/blog/chaos-engineering-with-kubernetes/image-20211021030337926-16347566199512_hu9402193779835002332.webp"
               width="760"
               height="386"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>可能的平台功能点：</p>
<ul>
<li>混沌注入
<ul>
<li>Pod 崩溃</li>
<li>网络故障</li>
<li>负载测试</li>
<li>IO 故障</li>
</ul>
</li>
<li>事件跟踪</li>
<li>关联告警</li>
<li>时序遥测</li>
</ul>
<h2 id="参阅资料">参阅资料</h2>
<p>本文既是为公司引入新技术进行试探，同时也是自我学习的记录，此前接触的学习材料及撰写本文时查阅的资料，较为优秀的部分列在这里，以便快速查阅。</p>
<ul>
<li><a href="https://qiankunli.github.io/2020/08/10/controller_runtime.html" target="_blank" rel="noopener">controller-runtime 源码分析</a></li>
<li><a href="https://github.com/zoetrope/kubebuilder-training" target="_blank" rel="noopener">つくって学ぶ Kubebuilder</a>（日文教程）</li>
<li><a href="https://book.kubebuilder.io/" target="_blank" rel="noopener">Kubebuilder Book</a> / <a href="https://cloudnative.to/kubebuilder/" target="_blank" rel="noopener">中文版</a></li>
<li><a href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kube-controller-manager/sharedIndexInformer.html" target="_blank" rel="noopener">kube-controller-manager 源码分析（三）之 Informer 机制</a></li>
<li><a href="https://segmentfault.com/a/1190000020359577" target="_blank" rel="noopener">kubebuilder2.0 学习笔记——进阶使用</a></li>
<li><a href="https://www.cnblogs.com/charlieroro/p/11112526.html" target="_blank" rel="noopener">client-go 和 golang 源码中的技巧</a></li>
</ul>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://pingcap.com/zh/blog/chaos-mesh" target="_blank" rel="noopener">Chaos Mesh - 让应用跟混沌在 Kubernetes 上共舞</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://xie.infoq.cn/article/655c0893ed150ff65f2b7a16f" target="_blank" rel="noopener">自制文件系统 —— 02 开发者的福音，FUSE 文件系统</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="http://www.freeoa.net/product/apptool/stress-ng_3456.html" target="_blank" rel="noopener">系统压力测试工具-stress-ng</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://shoujo.ink/2021/09/dkron-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">Dkron 源码分析</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="https://www.jianshu.com/p/a73f984f53b5" target="_blank" rel="noopener">RunC 源码通读指南之 NameSpace</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a>
  
  <a class="badge badge-light" href="/tag/%E6%B7%B7%E6%B2%8C%E5%B7%A5%E7%A8%8B/">混沌工程</a>
  
  <a class="badge badge-light" href="/tag/kubernetes/">Kubernetes</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/mayo-cream/"><img class="avatar mr-3 avatar-circle" src="/author/mayo-cream/avatar_hu3801682002625739492.jpg" alt="Mayo Cream"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/mayo-cream/">Mayo Cream</a></p>
      
      
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/apisix-source-code-reading/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>云原生网关 APISIX 核心流程源码分析与进化方向思考</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/kong-source-code-reading/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>云原生网关 Kong 源码分析</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/chaos-engineering-with-kubernetes/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/advanced-guide-for-cloudnative-architects/">云原生架构师进阶指南</a></li>
      
      <li><a href="/blog/introducing-velero/">使用 Velero 备份还原 Kubernetes 集群资源</a></li>
      
      <li><a href="/blog/apisix-source-code-reading/">云原生网关 APISIX 核心流程源码分析与进化方向思考</a></li>
      
      <li><a href="/blog/kong-source-code-reading/">云原生网关 Kong 源码分析</a></li>
      
      <li><a href="/blog/access-management-reference-architecture/">云上细粒度访问管理的参考架构</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnativecn.com",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2024 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.4684ca30d68fb8aed8d4debfcc18beed.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.85fc5fdbc5de9f11d741a1c4a48fe458.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
