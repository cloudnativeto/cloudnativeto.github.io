<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="作者在本文将和大家一起探讨下 Istio 的服务治理，介绍服务治理相关概念和实现原理。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/istio-traffic-management-series-service-management-concept-theory/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.008259417e6adf8980695ebbbb46553f.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/istio-traffic-management-series-service-management-concept-theory/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/istio-traffic-management-series-service-management-concept-theory/" />
  <meta property="og:title" content="浅析 Istio——服务治理之概念和原理 | 云原生社区（中国）" />
  <meta property="og:description" content="作者在本文将和大家一起探讨下 Istio 的服务治理，介绍服务治理相关概念和实现原理。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2022-06-12T12:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2024-01-12T09:24:21&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/istio-traffic-management-series-service-management-concept-theory/"
  },
  "headline": "浅析 Istio——服务治理之概念和原理",
  
  "datePublished": "2022-06-12T12:00:00+08:00",
  "dateModified": "2024-01-12T09:24:21+08:00",
  
  "author": {
    "@type": "Person",
    "name": "房耘耘"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "作者在本文将和大家一起探讨下 Istio 的服务治理，介绍服务治理相关概念和实现原理。"
}
</script>

  

  

  

  





  <title>浅析 Istio——服务治理之概念和原理 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="88470ef319c44998e9bbab6463223118" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>浅析 Istio——服务治理之概念和原理</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E6%88%BF%E8%80%98%E8%80%98/">房耘耘</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/service-mesh/" class="text-capitalize">service mesh</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2022-06-12
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 9115
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 41 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#服务治理概念">服务治理概念</a></li>
    <li><a href="#服务治理原理">服务治理原理</a>
      <ul>
        <li><a href="#流量代理转发模式">流量代理转发模式</a></li>
        <li><a href="#流量策略生效原理">流量策略生效原理</a></li>
        <li><a href="#envoy-过滤器">Envoy 过滤器</a></li>
        <li><a href="#流量匹配和转移">流量匹配和转移</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#服务治理概念">服务治理概念</a></li>
    <li><a href="#服务治理原理">服务治理原理</a>
      <ul>
        <li><a href="#流量代理转发模式">流量代理转发模式</a></li>
        <li><a href="#流量策略生效原理">流量策略生效原理</a></li>
        <li><a href="#envoy-过滤器">Envoy 过滤器</a></li>
        <li><a href="#流量匹配和转移">流量匹配和转移</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
</details>

                    
                    <h2 id="前言">前言</h2>
<p>在浅析 Istio 系列的<a href="https://cloudnative.to/blog/istio-traffic-management-series-route-management/" target="_blank" rel="noopener">上篇文章</a>中，我们介绍了 Istio 的流量路由管理相关内容，并基于此实践了灰度发布相关技术。本篇文章，我们继续扩展探讨 Istio 服务治理的相关技术和原理。</p>
<h2 id="服务治理概念">服务治理概念</h2>
<p>应用从单体架构向微服务架构演进的过程中，由于细粒度的微服务应用数量大幅增长，微服务之间的服务发现、负载均衡、熔断限流等服务治理需求显著提高。</p>
<p>在微服务场景下，每个服务有多个服务实例，需要一种机制将请求的服务名解析到服务实例地址上，这就需要服务发现和负载均衡机制。负载均衡一般和服务发现配合使用，服务发现负责从服务名中解析一组服务实例的列表，负载均衡负责从中选择一个实例发起请求。</p>
<p>传统架构下负载均衡一般由服务端提供的，比如访问一个 Web 网站时，一般在网站入口处有一个负载均衡器来做请求的汇聚和转发（也称作反向代理）。服务的虚拟 IP 和后端实例映射通过配置文件维护，负载均衡器通过健康检查保证客户端的请求被路由到健康的服务实例。</p>
<p>















<figure  id="figure-concept-1">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="concept-1" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/concept-1_hu257caae7fc1c8c0c4844ccd468033a11_20847_3b98a9946f55b2c097e6ca12ba9dd524.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/concept-1_hu257caae7fc1c8c0c4844ccd468033a11_20847_7bacc6825c75473567c3244dfa8734b6.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/concept-1_hu257caae7fc1c8c0c4844ccd468033a11_20847_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/concept-1_hu257caae7fc1c8c0c4844ccd468033a11_20847_3b98a9946f55b2c097e6ca12ba9dd524.webp"
               width="760"
               height="246"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      concept-1
    </figcaption></figure>
</p>
<p>微服务架构下，服务发现和负载均衡相关功能包含以下工作流程：
<strong>服务注册</strong>：各服务将服务名和服务实例的对应信息注册到服务注册中心。
<strong>服务发现</strong>：发起服务调用时，从服务注册中心获取服务对应的实例列表。
<strong>负载均衡</strong>：根据配置的负载均衡策略，从实例集合中选择一个服务实例来处理业务请求。</p>
<p>Istio 中的服务注册和发现由控制面的 Pilot 和数据面的 Envoy 协作完成，Pilot 通过 K8s ApiServer 接口获取 service 和 endpoint 等服务资源信息，将其转化为 xDS 消息下发给数据面的 Envoy 组件。Envoy 在收到请求后根据配置的负载均衡策略选择一个服务实例进行请求的转发。实际上，控制面加数据面架构是 Istio 为代表的第二代服务网格相对第一代服务网格的独特优势，控制面可以实现集中高效的分发配置和服务信息，数据面依据这些信息可实现服务发现，负载均衡，服务状态监控，限流熔断等多种服务治理能力。</p>
<p>















<figure  id="figure-concept-2">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="concept-2" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/concept-2_hu667ba59164b009f3b764bcc0e3b0e9fb_19258_5938fb9effa4d29c219fb7ade76b8fd3.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/concept-2_hu667ba59164b009f3b764bcc0e3b0e9fb_19258_cd22ff3c58cc23772d6bfcd59bb8c198.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/concept-2_hu667ba59164b009f3b764bcc0e3b0e9fb_19258_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/concept-2_hu667ba59164b009f3b764bcc0e3b0e9fb_19258_5938fb9effa4d29c219fb7ade76b8fd3.webp"
               width="613"
               height="404"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      concept-2
    </figcaption></figure>
</p>
<p>微服务中自动<strong>重试</strong>也是服务间调用的一项常见配置，当上游服务返回特定类型的错误代码时可重新尝试调用。由于错误可能是暂时的环境抖动引起，一般很快恢复，所以重试是一个有用的策略。重试是解决一些异常请求的直接、简单的方法，尤其是网络质量不稳定的场景下，可提高服务质量。但是重试使用不当也会有问题，特定情况下重试可能一直不成功，反而增加延迟和性能开销。因此根据系统运行环境和服务特点，配置适当的重试规则非常必要。Istio 中支持配置细粒度的配置服务重试策略，支持设置重试超时和重试次数等参数，能较好的达到重试的目标效果。</p>
<p>在微服务架构下服务之间的调用链路相比单体应用时代更长，微服务化拆分带来系统整体能力提升的同时，也增加了服务间级联故障出现的概率。多个服务之间存在依赖调用，如果某个服务无法及时响应请求，故障向调用源头方向传播，可能引发集群的大规模级联故障，造成整个系统不可用。为应对这种情况，可以引入<strong>熔断</strong>策略。为了防止故障范围的扩大，熔断的基本逻辑就是隔离故障。通过不断探测和周期性统计服务失败调用次数，如果服务的健康状况低于设定阈值则启动熔断，剔除错误服务实例。熔断机制虽然解决不了故障，但却能在故障发生时尽量保全非故障链路上的服务接口能被正常访问，将故障范围控制在局部。被熔断的服务也不会一直处于熔断状态，在熔断机制中还会执行故障恢复，探测到服务正常后关闭熔断。Istio 支持较全面的故障检测，熔断开启和熔断恢复机制。</p>
<p><strong>限流</strong>功能也是保护服务的重要手段，熔断的主要目的是隔离故障，而引起故障的原因除了系统服务内部的问题外，还有可能是请求量超过了系统处理能力的极限，后续新进入的请求会持续加重服务负载，导致资源耗尽发生服务出错。限流的目的就是拒绝过多的请求流量，保证服务整体负载处于合理水平。系统的吞吐量一般是可以被测算的，为了保证系统的稳定运行，一旦达到的需要限制的阈值，就需要采取措施限制流量，比如延迟处理，拒绝处理，或者部分拒绝处理等。Istio 支持基于服务连接数，请求排队数等设置限流，还支持经典的令牌限流模式，主动保护上游服务。</p>
<p>微服务中为方便系统进行可靠性测试和调参优化，可以模拟出应用的故障场景。<strong>故障注入</strong>就是通过一定的机制实现服务故障模拟，但不破坏服务本身。比如可以对某种请求返回一个特定的 HTTP 故障码，对于访问的客户端来说，就跟服务发生异常一样。还可以注入指定的延时，模拟客户端访问服务端响应慢，而无须为了达到这种效果在服务端的代码里添一段延迟响应代码。Istio 中的故障注入中还可以对故障的条件进行设置，例如只对某些特定请求注入故障，其他请求保持正常，以支持特定访问场景的故障响应测试。</p>
<p><strong>流量转移</strong>的概念是配置不同规则给不同的服务版本分配流量，常见的配置规则包括不同服务版本分配不同的访问流量比例，以及基于请求的消息头参数将流量分配到不同服务实例等。流量转移的典型应用是灰度发布，其核心要求是提供一种机制满足多个不同版本同时在线，并能够配置规则给不同的版本分配流量，使新版本流量在可控范围的线上环境中经受充分测试，即使新版本失败也很容易回退。传统的灰度发布方式是在入口的负载均衡器上配置流量策略，这种方式要求负载均衡器必须支持相应的流量策略，并且只能对入口的服务做灰度发布，不支持对后端服务单独做灰度发布。K8s 中依靠 Kube-proxy 把流量分发到目标后端，限制也比较明显：首先不同服务版本分配的流量必须和 Pod 数量成比例，其次这种方式不支持根据请求消息头来分配流量，比如让移动端发来的请求和 PC 端发来的请求分别访问不同的服务版本。Istio 通过引入服务版本路由声明，以及流量匹配和路由转发机制，很好的支持了流量转移的场景，可提供全链路灰度发布功能支持。</p>
<p>综上所述，微服务架构带来开发运维模式巨大变革的同时，也引入了服务治理的诸多问题：一个应用由多个服务组成，每个服务有多个实例，每个实例的运行状态不断变化。这对服务间流量管理和服务治理功能提出了巨大需求。以 Istio 为代表的服务网格，通过接管服务发送和接收的所有流量，可以轻松承载微服务应用间的通信功能。Istio 通过控制平面下发服务治理配置，然后根据配置在各个服务之间路由流量，并提供的服务发现和故障处理策略等服务治理功能。同时 Istio 还记录网格内流量交互信息，提供对服务的可观察性支持，很好的满足了微服务系统服务治理的需求。下一章中我们一起探讨服务网格实现服务流量治理的原理。</p>
<h2 id="服务治理原理">服务治理原理</h2>
<h3 id="流量代理转发模式">流量代理转发模式</h3>
<p>如何将服务联通起来，是服务治理首先要解决的问题。通常的做法是将通讯层基础功能以 SDK 的形式嵌入业务代码中，但是这种强耦合的方案会增加开发的难度，增加维护成本，增加质量风险。SDK 增加新特性做版本升级，业务侧配合 SDK 进行升级成本很高。SDK 一般绑定具体语言，对多语言服务开发的支持不健全。另外对 SDK 调用的代码多处冗余出现，从服务治理的角度来看，这样的方式侵入了业务，并且分散于应用，不利于微服务体系的整体管控。</p>
<p>通过将原来在 SDK 中的逻辑转移到 Sidecar 中，提供了另一种可行方案。Sidecar 就是在应用节点上部署的代理进程，应用将请求发给代理，由代理完成路由转发。</p>
<p>















<figure  id="figure-sidecar-model-1">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="sidecar-model-1" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-1_hu2ca753b351c46a7f1122356fb805b23b_17683_60695fea7fe0dfa12758ae09aa3b7375.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-1_hu2ca753b351c46a7f1122356fb805b23b_17683_6bc9e21b1fafae91b2a358f3a5f9a865.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-1_hu2ca753b351c46a7f1122356fb805b23b_17683_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-1_hu2ca753b351c46a7f1122356fb805b23b_17683_60695fea7fe0dfa12758ae09aa3b7375.webp"
               width="760"
               height="301"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      sidecar-model-1
    </figcaption></figure>
</p>
<p>从整体看代理间流量调用关系形成完整的网络，代表服务间复杂的调用关系，承载着系统内的应用通信。各个具体的微服务之间不再直接发生连接，而是转由各自的 Sidecar 代理通信实现，在应用形态上形成了一组由代理所组成的网状交互结构，这也是服务网格名称的由来。</p>
<p>















<figure  id="figure-sidecar-model-2">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="sidecar-model-2" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-2_huea7aae06ad100157a756748c07663304_41496_b5da508d9e1dd0c1954b77428ca06b0a.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-2_huea7aae06ad100157a756748c07663304_41496_d435002aaa8f745b06f4028afe803d9e.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-2_huea7aae06ad100157a756748c07663304_41496_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-2_huea7aae06ad100157a756748c07663304_41496_b5da508d9e1dd0c1954b77428ca06b0a.webp"
               width="529"
               height="416"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      sidecar-model-2
    </figcaption></figure>
</p>
<p>服务网格的本质是将通用流量治理的功能沉淀至 Sidecar 中，由 Sidecar 接管服务流量并对其进行治理。可以通过流量劫持的手段，做到无代码侵入实现流量治理，让开发者更聚焦业务功能，降低微服务的代码复杂性，提高开发效率。通过将服务治理功能从应用本身剥离出来，做到了控制与逻辑的分离。Sidecar 模式允许我们向应用无侵入添加多种功能，避免了为满足功能扩展需求而向应用添加额外的代码。</p>
<p>















<figure  id="figure-sidecar-model-3">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="sidecar-model-3" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-3_hudcd8f8ad184417a1d7b0cb7c9d0c768b_26857_51e93cbe6ff09afa33bf516ee480faac.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-3_hudcd8f8ad184417a1d7b0cb7c9d0c768b_26857_f2a820f940eb07a52162309fc796b1bd.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-3_hudcd8f8ad184417a1d7b0cb7c9d0c768b_26857_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-3_hudcd8f8ad184417a1d7b0cb7c9d0c768b_26857_51e93cbe6ff09afa33bf516ee480faac.webp"
               width="593"
               height="198"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      sidecar-model-3
    </figcaption></figure>
</p>
<p>如下图右侧所示，当外部请求调用服务实例接口时，其发送的网络请求会经过它们各自的网络代理，那么代理就可以为其提供服务熔断相关的机制，当调用服务实例持续出错时，就不再将外部请求发送到服务实例，而是直接返回配置的错误码。同样，Proxy 代理可以为其提供限流功能，当外部请求流量过大时，代理会对其中一部分请求进行限流，拒绝部分请求，只将部分请求转发下游服务。</p>
<p>















<figure  id="figure-sidecar-model-4">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="sidecar-model-4" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-4_huc493e45d85f1bd21d2766cb1884182b9_19817_ce5318824a518720c0ee5e2066e81164.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-4_huc493e45d85f1bd21d2766cb1884182b9_19817_56dcf5fda8cedc1380377f8219eeec59.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-4_huc493e45d85f1bd21d2766cb1884182b9_19817_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-4_huc493e45d85f1bd21d2766cb1884182b9_19817_ce5318824a518720c0ee5e2066e81164.webp"
               width="760"
               height="291"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      sidecar-model-4
    </figcaption></figure>
</p>
<p>将微服务治理逻辑从原先具体的微服务进程中抽离出来，实现由统一控制面管理和代理数据面执行的体系结构，是 Istio Service Mesh 体系与 Spring Cloud 传统微服务体系在架构上最大的区别。各种服务治理逻辑，也是在这样的架构模式下实现的。Service Mesh 架构总体上由控制面 (Control Plane) 和数据面 (Data Plane) 两部分组成。其中控制面主要承担整个微服务体系治理信息的集中管控分发，而数据面则负责具体执行由控制面下发的各类服务治理信息及规则。</p>
<p>















<figure  id="figure-sidecar-model-5">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="sidecar-model-5" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-5_hu239d933c62edaaa5b6c62169a8d34e9e_20659_e2ff3f0106d38de4889ddef02772103c.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-5_hu239d933c62edaaa5b6c62169a8d34e9e_20659_cba95090673406666b648723ea803b06.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-5_hu239d933c62edaaa5b6c62169a8d34e9e_20659_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/sidecar-model-5_hu239d933c62edaaa5b6c62169a8d34e9e_20659_e2ff3f0106d38de4889ddef02772103c.webp"
               width="760"
               height="462"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      sidecar-model-5
    </figcaption></figure>

对于代理程序的部署问题，Istio 中通过开启自动注入，在部署应用时可以把代理程序自动部署到用户应用相同的 Pod 下，用户无需担心代理程序的部署问题。</p>
<h3 id="流量策略生效原理">流量策略生效原理</h3>
<p>















<figure  id="figure-effective-principle-1">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="effective-principle-1" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-1_hu40c56c4958a4ef617bce24e9d80ca5cd_48068_10330ca2cfd28845e87cf171369c1792.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-1_hu40c56c4958a4ef617bce24e9d80ca5cd_48068_25babacafd4c7664ffee9ccae819506c.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-1_hu40c56c4958a4ef617bce24e9d80ca5cd_48068_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-1_hu40c56c4958a4ef617bce24e9d80ca5cd_48068_10330ca2cfd28845e87cf171369c1792.webp"
               width="760"
               height="548"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      effective-principle-1
    </figcaption></figure>
</p>
<p>Istio 作为 Service Mesh 中的标杆，其流量管理的核心组件是 Pilot。Pilot 主要功能就是管理和配置部署在 Istio 中的所有 Sidecar 代理实例，它管理 Sidecar 代理之间的路由流量规则，并配置故障恢复功能，如超时、重试和熔断等。</p>
<p>Istio 流量治理的概要流程如下：在控制面方面，管理员通过命令或 API 在控制面创建流量管理规则，然后 Pilot 将流量规则转为 Envoy 可理解的标准格式，Pilot 将规则下发给 Envoy。在数据面方面，Envoy 拦截 Pod 上本地容器的 Inbound 流量和 Outbound 流量，在流量经过 Envoy 时执行对应的流量规则，对流量进行治理。</p>
<p>















<figure  id="figure-effective-principle-2">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="effective-principle-2" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-2_hu7c34f40b41a95f159831bbf3ba40a447_47410_3ee50765b4eb5715f241c3ea61bce1c6.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-2_hu7c34f40b41a95f159831bbf3ba40a447_47410_ffefad2e10765280ff7f343f4e753f61.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-2_hu7c34f40b41a95f159831bbf3ba40a447_47410_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-2_hu7c34f40b41a95f159831bbf3ba40a447_47410_3ee50765b4eb5715f241c3ea61bce1c6.webp"
               width="760"
               height="545"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      effective-principle-2
    </figcaption></figure>
</p>
<p>为了支持对不同服务注册中心（Kubernetes、consul、nacos 等），Istio 设计了统一的数据存储模型（Abstract Model）和适配器 Platform Adapter。Pilot 基于 Platform adapters 可以实现服务注册中心数据到抽象模型之间的数据转换。除了注册中心的服务信息外，Platform Adapter 还将流量治理配置信息转换成 Abstract Model。基于统一数据存储模型 Abstract Model，Pilot-discovery 进程通过 xDS api 接口为数据面提供了控制信息服务，将控制信息下发到数据面 Envoy。比如 Kubernetes 适配器通过 Kubernetes API 服务器获取 Kubernetes 中 service 和 pod 的相关信息，然后翻译为抽象模型提供给 Envoy 使用。通过适配器 Pilot 还可以从 CloudFoundry 等平台中获取服务信息，同样通过开发适配器可以将其他提供服务发现的组件集成到 Pilot 中。</p>
<p>K8s 平台上定义了 Istio 使用的流量管理相关 CRD 资源类型，作为承载用户进行流量管理的抽象实体。运维人员通过操作 CRD 来配置流量规则并下发到 Pilot，这些规则被 Pilot 翻译成数据面的配置，再通过标准数据面 API 分发到 Sidecar 实例，可以在运行期对微服务的流量进行控制和调整。通过运用不同的流量规则，可以对网格中微服务进行精细化的流量控制，如按版本分流、断路器、故障注入、灰度发布等。</p>
<p>CDR 中典型的几个配置介绍如下：VirtualService 可以理解为对 service 的一层抽象，用于定义路由规则，控制流量路由到匹配的 service 子集 (VirtualService)。同时可以为每个 VirtualService 设置一些独立的网络弹性属性，例如超时、重试等。DestinationRule 定义目的服务的策略，包括断路器、负载均衡等。同时定义可路由子集，即 VirtualService 中的路由规则可以完全委托给 DestinationRule。ServiceEntry 用于将 Istio 服务网格外部的服务添加到内部服务注册的，可通过其定义和访问外部服务。Gateway 是用于控制流量的网关，将 Gateway 绑定到 VirtualService 上，可以控制进出集群的流量。EnvoyFilter 主要为 Envoy 配置过滤器，用于动态扩展 Envoy 的能力。以上 CRD 配置详细用法可参考 Istio 官方文档，这里只简单介绍直观概念。</p>
<p>Pilot 主要包含 2 个组件，即 Pilot Agent 和 Discovery services，分别对应服务网格的数据面和控制面。</p>
<p>Pilot Agent 的进程名称为 Pilot-agent，负责生成 Envoy 配置文件和管理 Envoy 生命周期。它和 Envoy 以及具体应用在同一 Pod 中，以 Sidecar 模式部署。Pilot Agent 主要生成少部分初始化配置，其他动态配置通过标准 xDS 接口从 Pilot 获取。同时还负责 Envoy 进程的监控与管理工作，Envoy 故障退出后负责重启 Envoy，配置变更后负责 reload Envoy。Envoy 是基于 C++语言开发的高性能代理工具，内置服务发现、负载均衡、TLS 终止、HTTP/2、GRPC 代理、熔断器、健康检查、灰度发布、故障注入等功能，可用于协调服务网格中所有服务的入站和出站流量。</p>
<p>Discovery services 进程对应的是 Pilot-discovery，扮演服务注册中心和 Istio 控制平面到 Sidecar 之间的桥梁，负责 Pilot 中关键的管理逻辑，包括服务发现与流量管理等。Discovery services 使用单独的服务部署的。它会访问两种类型的数据。一是 k8s API Server 中的服务信息，即 service、endpoint、pod、node 等资源；二是配置信息，比如 K8s API Server 中 CRD 资源，包括上述的 VritualService 等 Istio 控制面的流量规则配置信息。然后将这两部分数据转换为数据面可以理解的格式（遵循 Envoy xDS Api），并通过标准的 API 将这些信息以 gRPC 接口下发到各个数据面下 Envoy 组件中。</p>
<p>xDS 概念如下：Pilot 使用了一套起源于 Envoy 项目的标准数据面 API 来将服务信息和流量规则下发到数据面的 Sidecar 中，这套标准数据面 API 叫 xDS。Envoy 通过 xDS API 可以动态获取 Listener（监听器）、Route（路由）、Cluster（集群）及 Endpoint（集群成员）配置。LDS 指 Listener 发现服务：Listener 监听器控制 Sidecar 启动端口监听，并配置 L3/L4 层过滤器，当网络连接达到后，配置好的网络过滤器堆栈开始处理后续事件。RDS 指 Router 发现服务：用于 HTTP 连接管理过滤器动态获取路由配置，其路由配置包含 HTTP 头部修改，虚拟主机以及虚拟主机的各个路由条目。CDS 指 Cluster 发现服务：用于动态获取 Cluster 信息。EDS 指 Endpoint 发现服务：用与动态维护服务节点信息，还包括负载均衡权重、金丝雀状态等，基于这些信息，Sidecar 可以做出智能的负载均衡决策。xDS 中的每种类型都对应一个发现资源，服务治理中的熔断限流逻辑则是由 RDS 配置实现。</p>
<p>下图中，当下游主机 A 发送请求至上游主机（B，C，D），Envoy 拦截请求，Listener 监听到下游主机请求后从请求内容抽象出 Filter Chains，然后根据流量策略相关的配置路由请求至对应的上游主机集群 (Cluster)，从而完成路由转发、负载均衡、流量策略等能力。流量策略相关的配置信息以动态配置的方式由 xDS Api 获取。Pilot-discovery 与每一个 Envoy 建立双向 gRPC 连接，Envoy 会通过 xDS 接口按照调用逻辑发起请求，并将 Pilot 的流量管理配置 VirtualService、DestinationRule 等组装成 cluster、endpoint、router、listener 等 Envoy 配置。最终这些动态配置会作用在 Envoy 上，当 Envoy Listener 监听到下游主机请求时，就可以根据这些配置完成实际的动态服务发现、流量管理等功能。</p>
<p>















<figure  id="figure-effective-principle-3">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="effective-principle-3" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-3_hu8229ddeb5664640616cdccef4b4f3a63_35793_c026233bf159886a603ea04fa19230ec.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-3_hu8229ddeb5664640616cdccef4b4f3a63_35793_d32a2efd8835d12dcdda38859604ec69.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-3_hu8229ddeb5664640616cdccef4b4f3a63_35793_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/effective-principle-3_hu8229ddeb5664640616cdccef4b4f3a63_35793_c026233bf159886a603ea04fa19230ec.webp"
               width="584"
               height="419"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      effective-principle-3
    </figcaption></figure>
</p>
<p>基于以上流程，我们就可以通过编写 VirtualService、DestinationRule 和 EnvoyFilter 等 CRD 资源来实现对运行于网格上的微服务提供无侵入的流量治理能力。</p>
<p>另外，对于进出服务的流量如何被 Envoy 接管，需要了解 Envoy 流量劫持原理。简单讲主要通过使用 iptable 工具，通过 Linux Netfilter 模块操纵流量。限于篇幅这里不展开叙述，具体原理可参考 Istio 相关资料。</p>
<h3 id="envoy-过滤器">Envoy 过滤器</h3>
<p>Envoy 的核心工作是对业务进行透明的请求拦截，依据配置对所有进出流量进行管理，包括监听，过滤，消息修改，转发等。对拦截的请求进行一定的控制，比如进行安全访问控制、流量控制等多方面处理后，发送给应用程序。通过使用 Envoy，开发者可以专注于应用功能的开发，不用考虑复杂的网络通讯实现。</p>
<p>















<figure  id="figure-envoyfilter-1jpg">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="envoyfilter-1.jpg" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-1_hufa583b6d66b207e1cfd754626f87b3b4_98638_f8a30452ff73b7d0747ad2153ffa4d0f.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-1_hufa583b6d66b207e1cfd754626f87b3b4_98638_2bc9beaecb2eb2289bac25cfbf19ff4c.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-1_hufa583b6d66b207e1cfd754626f87b3b4_98638_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-1_hufa583b6d66b207e1cfd754626f87b3b4_98638_f8a30452ff73b7d0747ad2153ffa4d0f.webp"
               width="760"
               height="570"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      envoyfilter-1.jpg
    </figcaption></figure>
</p>
<p>Envoy 流量管理是通过 EnvoyFilter 提供的机制来定制 Istio Pilot 生成的 Envoy 配置。使用 EnvoyFilter 来修改某些字段的值，添加特定的过滤器，甚至添加全新的 listener、cluster 等。这个功能必须谨慎使用，因为不正确的配置可能破坏整个网格的稳定性。与其他 Istio  CRD 配置对象不同，EnvoyFilter 是累加应用。对于特定命名空间中的特定工作负载，可以存在任意数量的 EnvoyFilter，EnvoyFilter 的应用顺序为首先配置根命名空间中的所有 EnvoyFilter，其次是工作负载命名空间中的所有匹配的 EnvoyFilter。</p>
<p>EnvoyFilter 对象定义了 Envoy 代理的过滤器，这些过滤器可以定制由 Istio Pilot 生成的代理配置。主要包括 workloadLabels 配置（工作负载实例筛选）和 filters 配置（包括要加入指定监听器之中的 Envoy 网络过滤器和 HTTP 过滤器配置信息）。Envoy 内部对请求的处理流程大致相同，即对请求的处理流程基本是不变的，而对于变化的部分全部抽象为 Filter。例如对请求的读写是 ReadFilter 和 WriteFilter，对 HTTP 请求数据的编解码是 StreamEncoderFilter 和 StreamDecoderFilter，对 TCP 的处理是 TcpProxyFilter，对 HTTP 的逻辑处理是 HTTP ConnectionManager，各个 Filter 最终会组织成一个 FilterChain，在收到请求后首先走 FilterChain，然后路由到指定集群并做负载均衡获取一个目标地址，最后转发出去完成一次服务调用过程。</p>
<p>















<figure  id="figure-envoyfilter-2jpg">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="envoyfilter-2.jpg" srcset="
               /blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-2_hub2b7be2fe08c0a108cdfec29b527d5b1_79964_720880a90a67ee1cb3398c27c721b961.webp 400w,
               /blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-2_hub2b7be2fe08c0a108cdfec29b527d5b1_79964_1b62bc7c912cb58a6b6b87b24b12ae23.webp 760w,
               /blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-2_hub2b7be2fe08c0a108cdfec29b527d5b1_79964_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/istio-traffic-management-series-service-management-concept-theory/envoyfilter-2_hub2b7be2fe08c0a108cdfec29b527d5b1_79964_720880a90a67ee1cb3398c27c721b961.webp"
               width="760"
               height="486"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      envoyfilter-2.jpg
    </figcaption></figure>
</p>
<p>Envoy 配置信息，主要包括如下关键字段：</p>
<p>listener : Envoy 的监听地址，负责接入工作负载。Envoy 会暴露一个或多个 Listener 来监听客户端的请求。</p>
<p>filter : 过滤器（如上图）。在 Envoy 中指的是一些“可插拔”和可组合的逻辑处理层，是 Envoy 核心逻辑处理单元。利用 Filter 机制，Envoy 理论上可以实现任意协议的支持以及协议之间的转换，可以对请求流量进行全方位的修改和定制。强大的 Filter 机制带来的不仅仅是强大的可扩展性，Filter 机制让 Envoy 的使用者可以在不侵入社区源码的基础上对 Envoy 做各个方面的增强。</p>
<p>route : 路由规则配置，即将请求路由到后端的哪个集群。Listener 可以接收来自下游的连接，Cluster 可以将流量发送给具体的上游服务，而 Router 则决定 Listener 在接收到下游连接和数据之后，应该将数据交给哪一个 Cluster 处理。它定义了数据分发的规则，说到 Router 大部分时候可以理解为 HTTP 路由，此外 Envoy 还支持多种协议，如 Dubbo、Redis 等，所以此处 Router 可泛指所有用于桥接 Listener 和后端服务的规则与资源集合。Router 中最核心配置包含匹配规则和目标 Cluster，此外，也可能包含重试、分流、限流等。</p>
<p>cluster : 服务提供方集群。Envoy 通过服务发现定位集群成员并获取服务，具体路由到哪个集群成员由负载均衡策略决定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">static_resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 1. 监听器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">listener_0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">address: 0.0.0.0, port_value</span><span class="p">:</span><span class="w"> </span><span class="m">10000</span><span class="w"> </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c"># 2. 过滤器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">filter_chains</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.http_connection_manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l">ingress_http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">route_config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">virtual_hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local_service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">domains</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/&#34;</span><span class="w"> </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">route</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">host_rewrite: www.baidu.com, cluster</span><span class="p">:</span><span class="w"> </span><span class="l">service_baidu }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">http_filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.router       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 3. 集群</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service_baidu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">connect_timeout</span><span class="p">:</span><span class="w"> </span><span class="l">1s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LOGICAL_DNS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dns_lookup_family</span><span class="p">:</span><span class="w"> </span><span class="l">V4_ONLY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lb_policy</span><span class="p">:</span><span class="w"> </span><span class="l">ROUND_ROBIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>{<span class="w"> </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">address: www.baidu.com, port_value</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w"> </span>}}<span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tls_context</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">sni</span><span class="p">:</span><span class="w"> </span><span class="l">baidu.com }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 4. 管理    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">admin</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">access_log_path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp/admin_access.log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">address: 0.0.0.0, port_value</span><span class="p">:</span><span class="w"> </span><span class="m">9901</span><span class="w"> </span>}<span class="w">
</span></span></span></code></pre></div><p>以上示例是一个典型的示例配置文件，实现将所有流量代理到 <a href="https://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a>，配置完成后通过请求 Envoy 的端点就可以直接看到百度的主页，而无需使用真实 URL 地址。</p>
<p>关于 EnvoyFilter 和 Envoy 的更多技术请参考 Envoy 官方文档。</p>
<h3 id="流量匹配和转移">流量匹配和转移</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">forecast</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">forecast</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">location</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l">north</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">forecast</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">route</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">forecast</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span></code></pre></div><p>Istio 的服务治理功能都是通过编写和应用 Kubernetes 的 CRD 实现，CRD 语法描述性较强。可以很直观理解以上配置的意思：对于 forecast 服务访问，如果在请求的 Header 中 location 取值是 north，则将请求转发到服务的 v2 版本上，其余请求都转发到服务的 v1 版本上。</p>
<p>VirtualService 定义了对特定目标服务的一组流量规则，在形式上表示一个虚拟服务，将满足条件的流量都转发到对应的服务后端。服务后端可以是一个独立服务，也可以是在 DestinationRule 中定义的服务的子集。</p>
<p>hosts 字段列举虚拟服务的主机，表示流量发送的目标。定义路由规则的的标识，用于匹配访问地址。http 字段定义了 HTTPRoute 类型的路由集合，用于处理 HTTP 的流量，对应服务的端口协议是 HTTP、HTTP2、GRPC。Istio 同时还支持 Tls 和 Tcp 服务的路由定义。</p>
<p>HTTPRoute 规则的功能是满足 HTTPMatchRequest 条件的流量都被路由到 HTTPRouteDestination。HTTPRoute 中最重要的字段是条件字段 Match，为一个 HTTPMatchRequest 类型的数组，表示 HTTP 请求满足条件，支持将 HTTP 属性如 headers、uri、scheme、method、authority、port 等作为条件来匹配请求。headers 匹配请求中的 Header，是一个 map 类型。map 的 key 是字符串类型，value 是 StringMatch 类型。即对于每一个 Header 的值，都可以使用精确、前缀和正则三种方式进行匹配。示例为自定义 Header 中 location 的取值为“north”的请求。port 表示请求服务的端口，大部分服务只开放一个端口，这也是在微服务中推荐的做法，在这种场景下可以不指定 port。</p>
<p>sourceLabels 是一个 map 类型的键值对，表示请求来源负载匹配标签。这在很多情况有用，可以对一组服务都打一个相同的标签，然后使用 sourceLabels 字段对这些服务实施相同的流量规则。在 Kubernetes 平台上，这里的 Label 就是 Pod 上的标签。如下所示表示请求来源是 testA 服务的 v2 版本的负载。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">match</span><span class="p">:</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">sourceLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">testA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span></span></span></code></pre></div><p>在 HTTPRoute 的匹配条件中，每个 HTTPMatchRequest 中的诸多属性是“与”逻辑，几个元素之间的关系是“或”逻辑。在 VirtualService 中 match 字段都是数组类型。HTTPMatchRequest 中的诸多属性如 uri、header、method 等都是“与”逻辑，而数组中几个元素间关系是“或”逻辑。在下面的例子中，match 包含两个 HTTPMatchRequest 元素，其条件的语义是：headers 中的 source 取值为“north”，且 uri 以“/advertisment”开头的请求，或者 uri 以“/forecast”开头的请求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">match</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">heraders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l">north</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uri</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/advertisment&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">uri</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/forecast&#34;</span><span class="w">
</span></span></span></code></pre></div><p>HTTPRoute 上的 route 字段是一个 HTTPRouteDestination 类型的数组，表示满足条件的流量目标。在 HTTPRouteDestination 中主要由三个字段：destination（请求目标）、weight（权重）、和 headers（HTTP 头操作），destination、weight 是必选字段。</p>
<p>destination 字段指定了符合此条件的流量的实际目标地址。在 Virtualservice 上执行一组规则，最终的流量要被送到这个目标上。destination 类型结构，通过 host、subset 和 port 三个属性来描述。host 是 Destination 必选字段，表示在 Istio 中注册的服务名，不但包括网格内的服务，也包括通过 ServiceEntry 方式注册的外部服务。与 host 配合来表示流量路由后端的是另一个重要字段 subset，它表示在 host 上定义的一个子集。例如，在灰度发布中将版本定义为 subset，配置路由策略会将流量转发到不同版本的 subset 上。HTTPRouteDestination 上的另一个必选字段是 weight，表示流量分配的比例，在一个 route 下多个 destination 的 weight 总和要求是 100。如果一个 route 只有一个 destination，那么可以省略 weight，默认就是 100。</p>
<p>下面示例，配置 20% 的流量到 v2 版本，其余流量到 v1 版本，这也是灰度发布常用的一个流量策略，即不区分请求内容，从总流量中切出一部分流量给新版本做灰度测试。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">forecast</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">route</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">forecast</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">forecast</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><h2 id="总结">总结</h2>
<p>本文我们介绍了 Istio 服务治理的基本概念，以及实现流量治理功能的相关技术。通过阅读本文读者可以初步理解 Istio 流量治理的概念和相关知识框架。限于篇幅，Istio 服务治理相关实践介绍请关注后续文章。</p>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/istio/">Istio</a>
  
  <a class="badge badge-light" href="/tag/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/">服务治理</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E6%88%BF%E8%80%98%E8%80%98/"><img class="avatar mr-3 avatar-circle" src="/author/%E6%88%BF%E8%80%98%E8%80%98/avatar_hu6f66991d06ce38c3a1f2433f61b5121a_16337_270x270_fill_q75_lanczos_center.jpg" alt="房耘耘"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E6%88%BF%E8%80%98%E8%80%98/">房耘耘</a></p>
      
      <p class="card-text">中国移动云能力中心软件开发工程师，专注于云原生、Istio、K8s 等领域。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/mtls-guide/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>写给 Kubernetes 工程师的 mTLS 指南</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/istio-spire-integration/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>如何在 Istio 中集成 SPIRE</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/istio-traffic-management-series-service-management-concept-theory/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/understanding-istio-and-open-policy-agent-opa/">Istio 中的外部授权过滤器：使用 OPA 实现灵活的授权策略</a></li>
      
      <li><a href="/blog/istio-gateway-api-beta/">Istio 扩展对 Gateway API 的支持</a></li>
      
      <li><a href="/blog/istio-traffic-management-series-route-management/">浅析 Istio——流量治理之路由管理</a></li>
      
      <li><a href="/blog/validating-a-request-payload-with-wasm/">使用 WebAssembly 验证请求负载</a></li>
      
      <li><a href="/blog/resiliency-app-aware-network/">利用服务网格和智能应用感知网络增强应用弹性</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2024 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
