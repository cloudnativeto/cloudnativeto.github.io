<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="本文为使用工具排查出v1.17&#43;的kubernetes集群下为何CNI的VXLAN模式下有超时，并且给出了三种解决方案和定位到问题起源。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/kubernetes-1-17-vxlan-63s-delay/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/kubernetes-1-17-vxlan-63s-delay/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/kubernetes-1-17-vxlan-63s-delay/" />
  <meta property="og:title" content="Kubernetes v1.17&#43; 集群下 CNI 使用 VXLAN 模式 SVC 有 63 秒延迟的触发原因定位 | 云原生社区（中国）" />
  <meta property="og:description" content="本文为使用工具排查出v1.17&#43;的kubernetes集群下为何CNI的VXLAN模式下有超时，并且给出了三种解决方案和定位到问题起源。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2020-05-28T15:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-05-05T09:34:58&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/kubernetes-1-17-vxlan-63s-delay/"
  },
  "headline": "Kubernetes v1.17+ 集群下 CNI 使用 VXLAN 模式 SVC 有 63 秒延迟的触发原因定位",
  
  "datePublished": "2020-05-28T15:00:00+08:00",
  "dateModified": "2023-05-05T09:34:58+08:00",
  
  "author": {
    "@type": "Person",
    "name": "张浩"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "本文为使用工具排查出v1.17+的kubernetes集群下为何CNI的VXLAN模式下有超时，并且给出了三种解决方案和定位到问题起源。"
}
</script>

  

  

  

  





  <title>Kubernetes v1.17&#43; 集群下 CNI 使用 VXLAN 模式 SVC 有 63 秒延迟的触发原因定位 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="2dfd4612cce049be0e19ad947f2b1789" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>Kubernetes v1.17&#43; 集群下 CNI 使用 VXLAN 模式 SVC 有 63 秒延迟的触发原因定位</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E5%BC%A0%E6%B5%A9/">张浩</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/kubernetes/" class="text-capitalize">kubernetes</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2020-05-28
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 3531
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 16 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#由来">由来</a>
      <ul>
        <li><a href="#抓包">抓包</a></li>
        <li><a href="#报文分析">报文分析</a></li>
        <li><a href="#不是根本的解决方法">不是根本的解决方法</a></li>
        <li><a href="#什么是-checksum-offload">什么是 checksum offload</a></li>
      </ul>
    </li>
    <li><a href="#正文">正文</a>
      <ul>
        <li><a href="#对照组">对照组</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#由来">由来</a>
      <ul>
        <li><a href="#抓包">抓包</a></li>
        <li><a href="#报文分析">报文分析</a></li>
        <li><a href="#不是根本的解决方法">不是根本的解决方法</a></li>
        <li><a href="#什么是-checksum-offload">什么是 checksum offload</a></li>
      </ul>
    </li>
    <li><a href="#正文">正文</a>
      <ul>
        <li><a href="#对照组">对照组</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav>
</details>

                    
                    <h2 id="前言">前言</h2>
<p>这个问题 flannel 和 calico 的 VXLAN 模式下都会发生，部分人的集群的 A 记录 UDP 下查询可能有问题。原因是 <code>v1.17+</code> 的 kubernetes 某部分会引起内核的某个 UDP 相关的 BUG 而不是 CNI 的软件层面， WEAVE 没有这个问题，原因后面会说到。写这篇文章的日期是 <code>05/28</code>，最开始发现是上周五也就是 <code>05/23</code> 号，文章从时间线写起，因为很多时候想发文章但是没空。</p>
<p>2020-07-19 官方版本 v1.18.6, v1.16.13, v1.17.9+ 已经修复这个问题，可以同版本内升级，或者只切 kube-proxy 版本。</p>
<h2 id="由来">由来</h2>
<p>上周五我经过同事的工位看到同事的桌面是 <code>kubectl get po</code> 的输出，问他咋开始学 Kubernetes 了，他说跟着视频学下。看了下用的 kubeadm 部署了一套 <code>1.18.2</code> 的集群。1.18 的 kube-proxy 的 ipvs 包的 parseIP 有 bug ，我推荐他换 <code>v1.17.5</code>。他当时在部署一个入门的 SVC 实验，无法解析域名。使用 dig 命令排查了下，下面是对照：</p>
<ul>
<li><code>dig @&lt;podIP&gt; +short kubernetes.default.svc.cluster.local</code> 能解析</li>
<li><code>dig @10.96.0.10 +short kubernetes.default.svc.cluster.local</code> 超时</li>
</ul>
<p>很多市面上的 kubeadm 部署教程都是直接命令 <code>kubeadm init</code> 的，所以我推荐同事去按照我文章的 <a href="https://zhangguanzhang.github.io/2019/11/24/kubeadm-base-use/" target="_blank" rel="noopener">kubeadm 部署</a> 一套后再试试，叫他用<code>v1.17</code>的最新版本<code>v1.17.5</code>，结果还是上面一样。 coredns 实际上还有 metrics 的 http 接口，从 http 层测了下：</p>
<ul>
<li><code>curl -I 10.96.0.10:9153/metrics</code> 超时，很久之后才有返回</li>
<li><code>curl -I &lt;podIP&gt;:9153/metrics</code> 能直接返回</li>
</ul>
<p>涉及到本次排查的信息为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ kubectl get node -o wide
</span></span><span class="line"><span class="cl">NAME     STATUS   ROLES    AGE    VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">master   Ready    master   7d8h   v1.18.2   10.0.100.3    &lt;none&gt;        CentOS Linux <span class="m">7</span> <span class="o">(</span>Core<span class="o">)</span>   3.10.0-957.el7.x86_64   docker://19.3.8
</span></span><span class="line"><span class="cl">node1    Ready    &lt;none&gt;   7d7h   v1.18.2   10.0.100.4    &lt;none&gt;        CentOS Linux <span class="m">7</span> <span class="o">(</span>Core<span class="o">)</span>   3.10.0-957.el7.x86_64   docker://19.3.8
</span></span><span class="line"><span class="cl">node2    Ready    &lt;none&gt;   7d7h   v1.18.2   10.0.100.15   &lt;none&gt;        CentOS Linux <span class="m">7</span> <span class="o">(</span>Core<span class="o">)</span>   3.10.0-957.el7.x86_64   docker://19.3.8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get po -o wide -n kube-system -l k8s-app<span class="o">=</span>kube-dns
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">coredns-546565776c-v5wwg   1/1     Running   <span class="m">2</span>          25h   10.244.2.73   node2   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>多次尝试发现很久的时间都是一样，用 time 命令观察了下一直是 63 秒返回。包括其他任何 SVC 都是这样。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">time</span>    curl -I 10.96.0.10:9153/metrics
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Content-Type: text/plain<span class="p">;</span> <span class="nv">version</span><span class="o">=</span>0.0.4<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl">Date: Wed, <span class="m">25</span> May <span class="m">2020</span> 08:39:35 GMT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real	1m3.091s
</span></span><span class="line"><span class="cl">user	0m0.002s
</span></span><span class="line"><span class="cl">sys	0m0.007s
</span></span></code></pre></div><p>proxyMode 是 ipvs ，用 ipvsadm 看下超时的时候的状态，一直是 <code>SYN_RECV</code>，也就是发送了 SYN ，没收到回包。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ipvsadm -lnc <span class="p">|&amp;</span> grep <span class="m">9153</span>
</span></span><span class="line"><span class="cl">TCP 00:59  SYN_RECV    10.96.0.10:41282   10.96.0.10:9153    10.244.2.73:9153
</span></span></code></pre></div><h3 id="抓包">抓包</h3>
<p>因为 CNI 使用的 flannel ，用的 VXLAN 模式。master 上抓 9153 和 <code>flannel.1</code> 的 8472 端口，coredns 的 POD 所在 node 上抓 flannel 的 VXLAN 包，下面三个是对应的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@master /root]# tcpdump -nn -i flannel.1 port 9153
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
</span></span><span class="line"><span class="cl">listening on flannel.1, link-type EN10MB (Ethernet), capture size 262144 bytes
</span></span><span class="line"><span class="cl">16:30:56.705696 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17148909 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:30:57.708489 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17149912 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:30:59.712458 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17151916 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:03.716441 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17155920 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:11.732562 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17163936 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:27.764498 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17179968 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.828493 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17212032 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.829565 IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [S.], seq 435819916, ack 911217172, win 27960, options [mss 1410,sackOK,TS val 17212067 ecr 17212032,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.829611 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 1, win 342, options [nop,nop,TS val 17212033 ecr 17212067], length 0
</span></span><span class="line"><span class="cl">16:31:59.829714 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [P.], seq 1:88, ack 1, win 342, options [nop,nop,TS val 17212033 ecr 17212067], length 87
</span></span><span class="line"><span class="cl">16:31:59.829897 IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [.], ack 88, win 219, options [nop,nop,TS val 17212067 ecr 17212033], length 0
</span></span><span class="line"><span class="cl">16:31:59.831300 IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [P.], seq 1:113, ack 88, win 219, options [nop,nop,TS val 17212069 ecr 17212033], length 112
</span></span><span class="line"><span class="cl">16:31:59.831322 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 113, win 342, options [nop,nop,TS val 17212034 ecr 17212069], length 0
</span></span><span class="line"><span class="cl">16:31:59.831435 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [F.], seq 88, ack 113, win 342, options [nop,nop,TS val 17212035 ecr 17212069], length 0
</span></span><span class="line"><span class="cl">16:31:59.831633 IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [F.], seq 113, ack 89, win 219, options [nop,nop,TS val 17212069 ecr 17212035], length 0
</span></span><span class="line"><span class="cl">16:31:59.831660 IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 114, win 342, options [nop,nop,TS val 17212035 ecr 17212069], length 0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@master /root]# tcpdump -nn -i eth0 port 8472
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
</span></span><span class="line"><span class="cl">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
</span></span><span class="line"><span class="cl">16:30:56.705718 IP 10.0.100.3.48683 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17148909 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:30:57.708523 IP 10.0.100.3.48683 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17149912 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:30:59.712478 IP 10.0.100.3.48683 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17151916 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:03.716452 IP 10.0.100.3.48683 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17155920 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:11.732590 IP 10.0.100.3.48683 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17163936 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:27.764513 IP 10.0.100.3.48683 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17179968 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.828541 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17212032 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.829521 IP 10.0.100.15.56771 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [S.], seq 435819916, ack 911217172, win 27960, options [mss 1410,sackOK,TS val 17212067 ecr 17212032,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.829617 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 1, win 342, options [nop,nop,TS val 17212033 ecr 17212067], length 0
</span></span><span class="line"><span class="cl">16:31:59.829729 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [P.], seq 1:88, ack 1, win 342, options [nop,nop,TS val 17212033 ecr 17212067], length 87
</span></span><span class="line"><span class="cl">16:31:59.829883 IP 10.0.100.15.34571 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [.], ack 88, win 219, options [nop,nop,TS val 17212067 ecr 17212033], length 0
</span></span><span class="line"><span class="cl">16:31:59.831292 IP 10.0.100.15.34571 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [P.], seq 1:113, ack 88, win 219, options [nop,nop,TS val 17212069 ecr 17212033], length 112
</span></span><span class="line"><span class="cl">16:31:59.831327 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 113, win 342, options [nop,nop,TS val 17212034 ecr 17212069], length 0
</span></span><span class="line"><span class="cl">16:31:59.831448 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [F.], seq 88, ack 113, win 342, options [nop,nop,TS val 17212035 ecr 17212069], length 0
</span></span><span class="line"><span class="cl">16:31:59.831612 IP 10.0.100.15.34571 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [F.], seq 113, ack 89, win 219, options [nop,nop,TS val 17212069 ecr 17212035], length 0
</span></span><span class="line"><span class="cl">16:31:59.831665 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 114, win 342, options [nop,nop,TS val 17212035 ecr 17212069], length 0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@node2 /root]# tcpdump -nn  -i eth0 port 8472
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
</span></span><span class="line"><span class="cl">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
</span></span><span class="line"><span class="cl">16:31:59.836137 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [S], seq 911217171, win 43690, options [mss 65495,sackOK,TS val 17212032 ecr 0,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.836328 IP 10.0.100.15.56771 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [S.], seq 435819916, ack 911217172, win 27960, options [mss 1410,sackOK,TS val 17212067 ecr 17212032,nop,wscale 7], length 0
</span></span><span class="line"><span class="cl">16:31:59.836811 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 1, win 342, options [nop,nop,TS val 17212033 ecr 17212067], length 0
</span></span><span class="line"><span class="cl">16:31:59.836910 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [P.], seq 1:88, ack 1, win 342, options [nop,nop,TS val 17212033 ecr 17212067], length 87
</span></span><span class="line"><span class="cl">16:31:59.836951 IP 10.0.100.15.34571 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [.], ack 88, win 219, options [nop,nop,TS val 17212067 ecr 17212033], length 0
</span></span><span class="line"><span class="cl">16:31:59.838385 IP 10.0.100.15.34571 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [P.], seq 1:113, ack 88, win 219, options [nop,nop,TS val 17212069 ecr 17212033], length 112
</span></span><span class="line"><span class="cl">16:31:59.838522 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 113, win 342, options [nop,nop,TS val 17212034 ecr 17212069], length 0
</span></span><span class="line"><span class="cl">16:31:59.838621 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [F.], seq 88, ack 113, win 342, options [nop,nop,TS val 17212035 ecr 17212069], length 0
</span></span><span class="line"><span class="cl">16:31:59.838703 IP 10.0.100.15.34571 &gt; 10.0.100.3.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.2.73.9153 &gt; 10.244.0.0.2201: Flags [F.], seq 113, ack 89, win 219, options [nop,nop,TS val 17212069 ecr 17212035], length 0
</span></span><span class="line"><span class="cl">16:31:59.838836 IP 10.0.100.3.56618 &gt; 10.0.100.15.8472: OTV, flags [I] (0x08), overlay 0, instance 1
</span></span><span class="line"><span class="cl">IP 10.244.0.0.2201 &gt; 10.244.2.73.9153: Flags [.], ack 114, win 342, options [nop,nop,TS val 17212035 ecr 17212069], length 0
</span></span></code></pre></div><p>先看上面的第一部分，搜了下资料，得知 TCP 默认 SYN 报文最大 retry 5 次，每次超时了翻倍，<code>1s -&gt; 3s -&gt; 7s -&gt; 15s -&gt; 31s -&gt; 63s</code>。只有 63 秒的时候 node 的机器上才收到了 VXLAN 的报文。说明 POD 所在  node 压根没收到 63 秒之前的。</p>
<p>一般 LVS 的 dr 模式下 TCP 的时间戳混乱或者其他几个 ARP 的内核参数不对下 <code>SYN</code> 是一直收不到的而不是63秒后有结果，所以和内核相关参数无关。于是同样上面的步骤 tcpdump 抓包，加上<code>-w filename.pcap</code>选项把抓的包导出下来导入到 wireshark 里准备看看。</p>
<h3 id="报文分析">报文分析</h3>
<p>9153 的包 wireshark 里看 63 秒前面都是 TCP 的 SYN 重传，看到了 master 上向外发送的 VXLAN 报文的时候有了发现。</p>
<p>可以看到 UDP 的 checksum 是<code>0xffff</code>，我对 UDP 报文不太熟悉， UDP 的 header 的 Checksum 没记错的话 <code>CRC32</code> 校验的，不可能是这种两个字节都置 1 的 <code>0xffff</code> ，明显就是 UDP 的 header 的校验出错了。后面几个正常包的 Checksum 都是 missing 的。</p>
<p>















<figure  id="figure-vxlan1">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="vxlan1" srcset="
               /blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum1_huaf1abb878251657be8ca6ddf7b5cba40_54149_84fd3ec0f4fac947880f6ae0336710c0.webp 400w,
               /blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum1_huaf1abb878251657be8ca6ddf7b5cba40_54149_e7e7b98da259c2716ae5a7e365a5697f.webp 760w,
               /blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum1_huaf1abb878251657be8ca6ddf7b5cba40_54149_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum1_huaf1abb878251657be8ca6ddf7b5cba40_54149_84fd3ec0f4fac947880f6ae0336710c0.webp"
               width="760"
               height="629"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      vxlan1
    </figcaption></figure>
</p>
<p>wireshark 的<code>编辑</code>-&gt;<code>首选项</code>-&gt;<code>Protocols</code>-&gt;<code>UDP</code>-&gt;<code>Validate the UDP checksum if possible</code> 勾上更直观看。</p>
<p>















<figure  id="figure-vxlan1">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="vxlan1" srcset="
               /blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum2_hu9f411cffa8f56693cee5b41730363e25_61230_62273d306a6a1120bcff637b3ae4a395.webp 400w,
               /blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum2_hu9f411cffa8f56693cee5b41730363e25_61230_7244dc237643cddbb698eed17bc23e39.webp 760w,
               /blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum2_hu9f411cffa8f56693cee5b41730363e25_61230_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/kubernetes-1-17-vxlan-63s-delay/vxlan-udp-csum2_hu9f411cffa8f56693cee5b41730363e25_61230_62273d306a6a1120bcff637b3ae4a395.webp"
               width="760"
               height="590"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      vxlan1
    </figcaption></figure>
</p>
<h3 id="不是根本的解决方法">不是根本的解决方法</h3>
<p>搜了下 <code>wireshark linux udp checksum incorrect</code>，都是推荐把 <code>Checksum Offload</code> disable 掉就行了，例如我这里是 flannel ，则是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ /sbin/ethtool -K flannel.1 tx-checksum-ip-generic off
</span></span><span class="line"><span class="cl">Actual changes:
</span></span><span class="line"><span class="cl">tx-checksumming: off
</span></span><span class="line"><span class="cl">	tx-checksum-ip-generic: off
</span></span><span class="line"><span class="cl">tcp-segmentation-offload: off
</span></span><span class="line"><span class="cl">	tx-tcp-segmentation: off <span class="o">[</span>requested on<span class="o">]</span>
</span></span><span class="line"><span class="cl">	tx-tcp-ecn-segmentation: off <span class="o">[</span>requested on<span class="o">]</span>
</span></span><span class="line"><span class="cl">	tx-tcp6-segmentation: off <span class="o">[</span>requested on<span class="o">]</span>
</span></span><span class="line"><span class="cl">	tx-tcp-mangleid-segmentation: off <span class="o">[</span>requested on<span class="o">]</span>
</span></span><span class="line"><span class="cl">udp-fragmentation-offload: off <span class="o">[</span>requested on<span class="o">]</span>
</span></span></code></pre></div><p>再测下正常，而 WEAVE 他们也用的 VXLAN 模式，但是他们在创建网卡的时候把这个已经 off 掉了，所以 WEAVE 的 VXLAN 模式在 <code>v1.17+</code> 集群没出现这个问题。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">time</span> curl -I 10.96.0.10:9153
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">404</span> Not Found
</span></span><span class="line"><span class="cl">Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl">X-Content-Type-Options: nosniff
</span></span><span class="line"><span class="cl">Date: Wed, <span class="m">27</span> May <span class="m">2020</span> 02:14:04 GMT
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">19</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real	0m0.009s
</span></span><span class="line"><span class="cl">user	0m0.005s
</span></span><span class="line"><span class="cl">sys	0m0.003s
</span></span></code></pre></div><p>你以为这样就完了？其实并没有，因为我自己维护了一套 <a href="https://github.com/zhangguanzhang/Kubernetes-ansible" target="_blank" rel="noopener">ansible 部署 kubernetes</a> 的方案，每次新版本发布我都会实际测下。并且同事反映了他同样云主机开出来用我 ansible 部署 <code>v1.17.5</code> 没有这个问题。这就很奇怪了，原因后面说，请接着继续看。</p>
<h3 id="什么是-checksum-offload">什么是 checksum offload</h3>
<p>Checksum Offload 是网卡的一个功能选项。如果该选项开启，则网卡层面会计算需要发送或者接收到的消息的校验和，从而节省 CPU 的计算开销。此时，在需要发送的消息到达网卡前，系统会在报头的校验和字段填充一个随机值。但是，尽管校验和卸载能够降低 CPU 的计算开销，但受到计算能力的限制，某些环境下的一些网络卡计算速度不如主频超过 400MHz 的 CPU 快。</p>
<h2 id="正文">正文</h2>
<h3 id="对照组">对照组</h3>
<p>很奇怪的就是为啥就是我的 ansible 部署的二进制就正常没这个问题，而 kubeadm 部署的就不正常，后面我花时间整了以下几个对照组(期间同事也帮我做了几个条件下的测试，但是不是系统用错了就是版本整错了。。。)，终于找到了问题的范围，下面是我自己统计的对照组信息， kubeadm 和 ansible 版本均为<code>1.17.5</code>测试。os 不重要，因为最终排查出和 os 无关：</p>
<table>
<thead>
<tr>
<th style="text-align:left">os</th>
<th style="text-align:center">type(kubeadm or ansible)</th>
<th style="text-align:center">flannel version</th>
<th style="text-align:center">flannel is running in pod?</th>
<th style="text-align:center">will 63 sec delay?</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v0.11.0</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v0.12.0</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v0.11.0</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v0.12.0</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">ansible</td>
<td style="text-align:center">v0.11.0</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">ansible</td>
<td style="text-align:center">v0.12.0</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">ansible</td>
<td style="text-align:center">v0.11.0</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">ansible</td>
<td style="text-align:center">v0.12.0</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
</tbody>
</table>
<p>这就看起来很迷了。但是排查出和 flannel 无关，感觉 kube-proxy 有关系，然后今天 <code>05/28</code> 针对 kube-proxy 做了个对照组：</p>
<table>
<thead>
<tr>
<th style="text-align:left">os</th>
<th style="text-align:center">type(kubeadm or ansible)</th>
<th style="text-align:center">kube-proxy version</th>
<th style="text-align:center">kube-proxy is running in pod?</th>
<th style="text-align:center">will 63 sec delay?</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v1.17.5</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v1.17.5</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v1.16.9</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">kubeadm</td>
<td style="text-align:center">v1.16.9</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">ansible</td>
<td style="text-align:center">v1.17.5</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">7.6</td>
<td style="text-align:center">ansible</td>
<td style="text-align:center">v1.17.5</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
</tbody>
</table>
<p>可以看出就是 1.17 以上的 kube-proxy 如果使用 POD 则会有这个问题，而非 POD 则不会， 在 github 上 <a href="https://github.com/kubernetes/kubernetes/compare/v1.16.3...v1.17.0" target="_blank" rel="noopener">compare 了下 v1.17.0 和 v1.16.3 </a>。</p>
<p>发现了 <a href="https://github.com/kubernetes/kubernetes/commit/fed582333f639dc22e879f4bbb258e403c210c30" target="_blank" rel="noopener">Dockerfile 的改动</a>，<code>1.17.0</code> 里的 Dockerfile 的 BASEIMAGE 是用  <a href="https://github.com/coreos/flannel/pull/1282#issuecomment-635273081" target="_blank" rel="noopener">指定了一个源安装了最新的 iptables</a>，然后利用 <code>update-alternatives</code> 把脚本 <code>/usr/sbin/iptables-wrapper</code> 去替代 <code>iptables</code> 来检测应该使用 <code>nft</code> 还是 <code>legacy</code>， hack 下镜像回自带源里的 iptables 验证下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> registry.aliyuncs.com/google_containers/kube-proxy:v1.17.5</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> rm -f /usr/sbin/iptables <span class="o">&amp;&amp;</span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    clean-install iptables<span class="err">
</span></span></span></code></pre></div><p>构建的镜像推送到了 dockerhub 上 <code>zhangguanzhang/hack-kube-proxy:v1.17.5</code>，更改下集群 kube-proxy ds 的镜像。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ kubectl -n kube-system get ds kube-proxy -o yaml <span class="p">|</span> grep image:
</span></span><span class="line"><span class="cl">        image: zhangguanzhang/hack-kube-proxy:v1.17.5
</span></span></code></pre></div><p>测试访问成功。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">time</span> curl -I 10.96.0.10:9153
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">404</span> Not Found
</span></span><span class="line"><span class="cl">Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl">X-Content-Type-Options: nosniff
</span></span><span class="line"><span class="cl">Date: Thu, <span class="m">28</span> May <span class="m">2020</span> 04:47:21 GMT
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">19</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real	0m0.008s
</span></span><span class="line"><span class="cl">user	0m0.003s
</span></span><span class="line"><span class="cl">sys	0m0.003s
</span></span></code></pre></div><p>对于这个问题我在 <a href="https://github.com/coreos/flannel/pull/1282" target="_blank" rel="noopener">flannel 的 pr</a> 下面也参与了回复，同时在官方 github 上提了一个 <a href="https://github.com/kubernetes/kubernetes/issues/91519" target="_blank" rel="noopener">issue</a>。</p>
<p>这个问题的触发是由于<code>v1.17+</code>的 kube-proxy 的 docker 镜像里安装了最新的 iptables， <code>--random-fully</code> 选项<a href="https://github.com/kubernetes/kubernetes/issues/88986#issuecomment-635640143" target="_blank" rel="noopener">会触发内核 vxlan 的 bug</a>。</p>
<h2 id="总结">总结</h2>
<p>目前解决问题三种办法：</p>
<ul>
<li>关闭 CNI 的 VXLAN 网卡的 <code>checksum offload</code></li>
<li>更改 Docker 镜像</li>
<li>升级到新内核，具体版本就不知道了，只要在这个 <a href="https://github.com/torvalds/linux/commit/ea64d8d6c675c0bb712689b13810301de9d8f77a" target="_blank" rel="noopener">内核 pr</a> 合并后出的内核版本都行，有人说这些可以 <code>Stable kernels 5.6.13, 5.4.41, 4.19.123, 4.14.181 and later have the checksum patch included.</code></li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://blog.csdn.net/u010039418/article/details/78234570" target="_blank" rel="noopener">TCP 超时重传定时器梳理</a></li>
<li><a href="https://wiki.wireshark.org/CaptureSetup/Offloading" target="_blank" rel="noopener">wireshark 文档</a></li>
<li><a href="https://zh.wikipedia.org/wiki/TCP%E6%A0%A1%E9%AA%8C%E5%92%8C%E5%8D%B8%E8%BD%BD" target="_blank" rel="noopener">offloading</a></li>
</ul>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/tcpdump/">tcpdump</a>
  
  <a class="badge badge-light" href="/tag/vxlan/">vxlan</a>
  
  <a class="badge badge-light" href="/tag/wireshark/">wireshark</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E5%BC%A0%E6%B5%A9/"><img class="avatar mr-3 avatar-circle" src="/author/%E5%BC%A0%E6%B5%A9/avatar_hud68548513b001ec088db8eb8343de5a4_23649_270x270_fill_q75_lanczos_center.jpg" alt="张浩"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E5%BC%A0%E6%B5%A9/">张浩</a></p>
      
      <p class="card-text">金山办公软件运维开发工程师，containers/podman 的 Collaborator。目前主要从事运维和 K8S 相关的工作。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/istio-16-explain/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>迈向极简主义 - Istio 1.6 发布</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/oam-crossplane/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>OAM和Crossplane: 构建现代应用的下一个阶段</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/kubernetes-1-17-vxlan-63s-delay/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/arm-kylin-clone-vxlan-error/">Arm64 银河麒麟系统克隆机器上 k8s vxlan 跨节点不通的一次排查</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2023 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
