<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  
  <title>Istio 安全源码分析——认证体系与通信安全 | 云原生社区</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文分析 Istio 安全认证体系与加密通信的源码，让读者对零信任的实践有清晰的认识，这些知识能帮助构建零信任认证与通信体系。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/all.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/istio-zero-trust-source-code-reading/" />
  <meta property="og:title" content="Istio 安全源码分析——认证体系与通信安全" />
  <meta property="og:description" content="本文分析 Istio 安全认证体系与加密通信的源码，让读者对零信任的实践有清晰的认识，这些知识能帮助构建零信任认证与通信体系。" />
  <meta property="og:image" content="https://cloudnative.to/images/blog/istio-zero-trust-heading.png" />
</head>
<body>
<!-- header -->

<img src="images/logo-square.jpg" width="0" height="0" />
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
     <img src="" width='700'>
</div>
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog/">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/community/sig/">兴趣小组</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
                <a class="dropdown-item" href="https://istio.io/latest/zh/">Istio 中文文档</a>
                
              </div>
            </li>
            
            
          </ul>

          
          

          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">Istio 安全源码分析——认证体系与通信安全</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">本文分析 Istio 安全认证体系与加密通信的源码，让读者对零信任的实践有清晰的认识，这些知识能帮助构建零信任认证与通信体系。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/istio-zero-trust-heading.png'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type"><a href="/categories/service-mesh">Service Mesh</a></div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://github.com/mayocream">Mayo Cream</a></strong>
          
            发表于 <strong class="text-dark">2021年10月27日</strong></div>
        <hr>
        <div class="content">
          <p>本文分析 Istio 安全认证体系与加密通信的源码，介绍 Istio 是如何构建集群内部 PKI 证书基础设施和实施安全通信的。</p>
<p>分析过程的代码注释在我的 Github 仓库 <a href="https://github.com/mayocream/istio/tree/citadel-review">mayocream/istio</a> 的 citadel-review 分支。</p>
<h2 id="1-身份模型">1. 身份模型</h2>
<p>零信任架构下，需要严格区分工作负载的识别和信任，而签发 X.509 证书是推荐的一种认证方式<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。在 Kubernetes 集群中，服务间是通过 DNS 名称互相访问的，而网络流量可能被 DNS 欺骗、BGP/路由劫持、ARP 欺骗等手段劫持，为了将服务名称（DNS 名称）与服务身份强关联起来，Istio 使用置于 X.509 证书中的安全命名（Secure naming）机制<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>。</p>
<p>SPIFFE 是 Istio 所采用的安全命名的规范，它也是云原生定义的一种标准化的、可移植的工作负载身份规范。<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<h3 id="11-介绍">1.1. 介绍</h3>
<p><a href="https://spiffe.io/">Secure Production Identity Framework For Everyone (SPIFFE)</a> 是一套服务之间相互进行身份识别的标准，主要包含以下内容：</p>
<ul>
<li>SPIFFE ID 标准，SPIFFE ID 是服务的唯一标识，具体实现使用 URI 资源标识符。</li>
<li>SPIFFE Verifiable Identity Document (SVID) 标准，将 SPIFFE ID 编码到一个加密的可验证的数据格式中。</li>
<li>颁发与撤销 SVID 的 API 标准。</li>
</ul>
<p>SPIFFE ID 规定了形如 <code>spiffe://&lt;trust domain&gt;/&lt;workload identifier&gt;</code> 的 URI 格式，作为工作负载（Workload）的唯一标识。SVID 是 SPIFFE ID 的识别凭证，有 X.509 和 JWT 两种格式。</p>
<p>SPIFFE 规范的实现有 spiffe 官方的 <a href="https://github.com/spiffe/spire">Spire</a> 项目，而 Istio 在自身的生态中只使用到了 SPIFFE ID 作为安全命名，其数据格式由自己实现，通信格式采用 CNCF 支持的 <a href="https://github.com/cncf/xds">xDS</a> 协议规范（证书认证通信更具体来说是 xDS 的 SDS）。</p>
<p>Istio 使用形如 <code>spiffe://&lt;trust_domain&gt;/ns/&lt;namespace&gt;/sa/&lt;service_account&gt;</code> 格式的 SPIFFE ID 作为安全命名，注入到 X.509 证书的 subjectAltName 扩展中。其中“trust domain”参数通过 Istiod 环境变量 <code>TRUST_DOMAIN</code> 注入，用于在多集群环境中交互。</p>
<p><img src="istio-security-arch-sec.svg" alt="Istio 安全架构"></p>
<h3 id="12-代码实现">1.2. 代码实现</h3>
<p>SPIFFE 官方提供了 Go SDK <a href="https://github.com/spiffe/go-spiffe">go-spiffe</a>，提供一种标准的 SPIFFE 协议的客户端实现。
由于 Istio 仅仅使用了 SPIFFE ID，没有必要引入这个 SDK，还值得一提的是该 SDK 引入了 grpc 包，如果你和我一样踩过 grpc 包引用版本冲突的问题，还花费了一下午的时间来解决，这次一定要保持警惕。</p>
<p>Istio 将自己实现的 SPIFFE 相关的代码存放在 pkg 目录下的 spiffe 目录。</p>
<h4 id="数据结构">数据结构</h4>
<p>这里再提一次数据格式是形如 <code>spiffe://&lt;trust_domain&gt;/ns/&lt;namespace&gt;/sa/&lt;service_account&gt;</code> 的 URI 字符串。这类身份标识因系统设计不同，定义的格式也各不相同，例如蚂蚁内部使用的身份标识格式是 <code>spiffe://&lt;domain&gt;/cluster/&lt;cluster&gt;/&lt;required_attr_1_name&gt;/&lt;required_attr_1_value&gt;/&lt;required_attr_2_name&gt;/&lt;required_attr_2_value&gt;</code><sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>。</p>
<p>定义 SPIFFE 的数据结构及其解析方式。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Identity</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">TrustDomain</span>    <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Namespace</span>      <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">ServiceAccount</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ParseIdentity</span>(<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">Identity</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">URIPrefix</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Identity</span>{}, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;identity is not a spiffe format: %v&#34;</span>, <span style="color:#a6e22e">s</span>)
    }
    <span style="color:#a6e22e">split</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">s</span>[<span style="color:#a6e22e">URIPrefixLen</span>:], <span style="color:#e6db74">&#34;/&#34;</span>)
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Identity</span>{
        <span style="color:#a6e22e">TrustDomain</span>:    <span style="color:#a6e22e">split</span>[<span style="color:#ae81ff">0</span>],
        <span style="color:#a6e22e">Namespace</span>:      <span style="color:#a6e22e">split</span>[<span style="color:#ae81ff">2</span>],
        <span style="color:#a6e22e">ServiceAccount</span>: <span style="color:#a6e22e">split</span>[<span style="color:#ae81ff">4</span>],
    }, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">i</span> <span style="color:#a6e22e">Identity</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">URIPrefix</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">TrustDomain</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/ns/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">Namespace</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/sa/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">ServiceAccount</span>
}
</code></pre></div><p>信任域（Trust Domain）是由 Istiod 主程序启动时调用 <code>spiffe.SetTrustDomain(s.environment.Mesh().GetTrustDomain())</code> 函数方法设置的。</p>
<h4 id="tls-验证">TLS 验证</h4>
<p>Go 官方的 tls 包提供了 <em>VerifyPeerCertificate</em> 方法，该方法通常会在标准证书校验后（验证服务端 IP 或 DNS 名称以及证书链校验）被调用，提供额外的自定义 Peer 证书验证功能。</p>
<p>由于 SPIFFE ID 属于证书扩展内容，程序需要额外校验 SPIFFE 身份。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pkg/spiffe/spiffe.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PeerCertVerifier</span>) <span style="color:#a6e22e">VerifyPeerCert</span>(<span style="color:#a6e22e">rawCerts</span> [][]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">_</span> [][]<span style="color:#f92672">*</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// 下游服务证书
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">peerCert</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>
    <span style="color:#75715e">// CA 证书链
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">intCertPool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">NewCertPool</span>()
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">rawCert</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">rawCerts</span> {
        <span style="color:#a6e22e">cert</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">ParseCertificate</span>(<span style="color:#a6e22e">rawCert</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#75715e">// 第一个证书为 Workload 证书
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">peerCert</span> = <span style="color:#a6e22e">cert</span>
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">intCertPool</span>.<span style="color:#a6e22e">AddCert</span>(<span style="color:#a6e22e">cert</span>)
        }
    }
    <span style="color:#75715e">// ERROR: SAN URIs 没有 SPIFFE ID
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">peerCert</span>.<span style="color:#a6e22e">URIs</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;peer certificate does not contain 1 URI type SAN, detected %d&#34;</span>, len(<span style="color:#a6e22e">peerCert</span>.<span style="color:#a6e22e">URIs</span>))
    }
    <span style="color:#a6e22e">trustDomain</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetTrustDomainFromURISAN</span>(<span style="color:#a6e22e">peerCert</span>.<span style="color:#a6e22e">URIs</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">String</span>())
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#75715e">// 根证书池
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rootCertPool</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">certPools</span>[<span style="color:#a6e22e">trustDomain</span>]
    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;no cert pool found for trust domain %s&#34;</span>, <span style="color:#a6e22e">trustDomain</span>)
    }

    <span style="color:#75715e">// 验证证书有效性
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">peerCert</span>.<span style="color:#a6e22e">Verify</span>(<span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">VerifyOptions</span>{
        <span style="color:#a6e22e">Roots</span>:         <span style="color:#a6e22e">rootCertPool</span>,
        <span style="color:#a6e22e">Intermediates</span>: <span style="color:#a6e22e">intCertPool</span>,
    })
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>校验过程会检查 SPIFFE ID 字段是否存在，以及 CA 证书的信任域是否与工作负载的证书处于同一有效的信任域。若校验失败，TLS 握手会以失败告终。</p>
<p>Istiod 在主程序启动时调用 <em>setPeerCertVerifier</em> 方法，设置额外的 mTLS 校验方式，以及添加 CA 证书到 Cert Pool 里：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// setPeerCertVerifier 设置 Istiod 的 SPIFFE 校验方式
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">setPeerCertVerifier</span>(<span style="color:#a6e22e">tlsOptions</span> <span style="color:#a6e22e">TLSOptions</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// 调用上述的 spiffe 包
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">peerCertVerifier</span> = <span style="color:#a6e22e">spiffe</span>.<span style="color:#a6e22e">NewPeerCertVerifier</span>()
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rootCertBytes</span> []<span style="color:#66d9ef">byte</span>
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
    <span style="color:#75715e">// CA 证书
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tlsOptions</span>.<span style="color:#a6e22e">CaCertFile</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#75715e">// 传入 CA 证书
</span><span style="color:#75715e"></span>        <span style="color:#f92672">...</span>
    }

    <span style="color:#75715e">// 加入 CA 根证书到 SPIFFIE 的信任证书里
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">rootCertBytes</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">peerCertVerifier</span>.<span style="color:#a6e22e">AddMappingFromPEM</span>(<span style="color:#a6e22e">spiffe</span>.<span style="color:#a6e22e">GetTrustDomain</span>(), <span style="color:#a6e22e">rootCertBytes</span>)
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h4 id="外部-ca">外部 CA</h4>
<p>Istio 实现了 <a href="https://github.com/spiffe/spiffe/blob/master/standards/SPIFFE_Trust_Domain_and_Bundle.md">SPIFFE Bundle</a> 协议，该协议允许访问外部 URI 通过规定的 <a href="https://datatracker.ietf.org/doc/html/rfc7517">JWK（JSON Web Key）</a>数据格式，获取信任域对应的根证书，而无需将根证书置于程序内部。</p>
<p>Istio 定义的数据格式：</p>
<ul>
<li><em>&lt;trustdomain, endpoint&gt;</em> 元组以 || 分割</li>
<li>每个元组内使用 | 分割 trustdomain 和 endpoint</li>
<li>例如：<code>foo|https://url/for/foo||bar|https://url/for/bar</code></li>
</ul>
<p>下述方式用于获取信任域对应的 X.509 CA 证书链（可以有多层级）。该方法接收 <code>foo|URL1||bar|URL2</code> 格式的参数，用 <code>||</code> 分隔切片，第一个参数为 trust domain，第二个参数为 CA 服务器 URL。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// RetrieveSpiffeBundleRootCertsFromStringInput 从 SPIFFE bundle 中检索可信的 CA 证书。
</span><span style="color:#75715e">// 它可以使用系统证书和提供的证书来进行验证。
</span><span style="color:#75715e">// 格式如下：
</span><span style="color:#75715e">// &#34;foo|URL1||bar|URL2||baz|URL3...&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RetrieveSpiffeBundleRootCertsFromStringInput</span>(<span style="color:#a6e22e">inputString</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">extraTrustedCerts</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>) (
    <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#f92672">*</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">spiffeLog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Processing SPIFFE bundle configuration: %v&#34;</span>, <span style="color:#a6e22e">inputString</span>)
    <span style="color:#a6e22e">config</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)
    <span style="color:#a6e22e">tuples</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">inputString</span>, <span style="color:#e6db74">&#34;||&#34;</span>)
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">tuple</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tuples</span> {
        <span style="color:#a6e22e">items</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">tuple</span>, <span style="color:#e6db74">&#34;|&#34;</span>)
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">items</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;config is invalid: %v. Expected &lt;trustdomain&gt;|&lt;url&gt;&#34;</span>, <span style="color:#a6e22e">tuple</span>)
        }
        <span style="color:#a6e22e">trustDomain</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">items</span>[<span style="color:#ae81ff">0</span>]
        <span style="color:#a6e22e">endpoint</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">items</span>[<span style="color:#ae81ff">1</span>]
        <span style="color:#a6e22e">config</span>[<span style="color:#a6e22e">trustDomain</span>] = <span style="color:#a6e22e">endpoint</span>
    }
    <span style="color:#75715e">// 调用 CA 服务器
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">RetrieveSpiffeBundleRootCerts</span>(<span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">extraTrustedCerts</span>)
}
</code></pre></div><p>外部服务器返回 JWK 格式的数据：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pkg/spiffe/spiffe.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 返回的 JSON 结构
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">bundleDoc</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">jose</span>.<span style="color:#a6e22e">JSONWebKeySet</span>
    <span style="color:#a6e22e">Sequence</span>    <span style="color:#66d9ef">uint64</span> <span style="color:#e6db74">`json:&#34;spiffe_sequence,omitempty&#34;`</span>
    <span style="color:#a6e22e">RefreshHint</span> <span style="color:#66d9ef">int</span>    <span style="color:#e6db74">`json:&#34;spiffe_refresh_hint,omitempty&#34;`</span>
}

<span style="color:#75715e">// JSONWebKey represents a public or private key in JWK format.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">JSONWebKey</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#75715e">// Cryptographic key, can be a symmetric or asymmetric key.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Key</span> <span style="color:#66d9ef">interface</span>{}
    <span style="color:#75715e">// Key identifier, parsed from `kid` header.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">KeyID</span> <span style="color:#66d9ef">string</span>
    <span style="color:#75715e">// Key algorithm, parsed from `alg` header.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Algorithm</span> <span style="color:#66d9ef">string</span>
    <span style="color:#75715e">// Key use, parsed from `use` header.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Use</span> <span style="color:#66d9ef">string</span>

    <span style="color:#75715e">// X.509 certificate chain, parsed from `x5c` header.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Certificates</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>
    <span style="color:#75715e">// X.509 certificate URL, parsed from `x5u` header.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">CertificatesURL</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span>
    <span style="color:#75715e">// X.509 certificate thumbprint (SHA-1), parsed from `x5t` header.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">CertificateThumbprintSHA1</span> []<span style="color:#66d9ef">byte</span>
    <span style="color:#75715e">// X.509 certificate thumbprint (SHA-256), parsed from `x5t#S256` header.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">CertificateThumbprintSHA256</span> []<span style="color:#66d9ef">byte</span>
}
</code></pre></div><p>实际的数据示例如下。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">{
    <span style="color:#e6db74">&#34;spiffe_sequence&#34;</span>: <span style="color:#ae81ff">1</span>,
    <span style="color:#e6db74">&#34;spiffe_refresh_hint&#34;</span>: <span style="color:#ae81ff">450000</span>,
    <span style="color:#e6db74">&#34;keys&#34;</span>: [
        {
        <span style="color:#e6db74">&#34;kty&#34;</span>: <span style="color:#e6db74">&#34;RSA&#34;</span>,
        <span style="color:#e6db74">&#34;use&#34;</span>: <span style="color:#e6db74">&#34;x509-svid&#34;</span>,
        <span style="color:#e6db74">&#34;n&#34;</span>: <span style="color:#e6db74">&#34;&lt;证书签名&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;e&#34;</span>: <span style="color:#e6db74">&#34;AQAB&#34;</span>,
        <span style="color:#e6db74">&#34;x5c&#34;</span>: [<span style="color:#e6db74">&#34;&lt;X.509 证书&gt;&#34;</span>]
        }
    ]
}
</code></pre></div><h2 id="2-私有-pki">2. 私有 PKI</h2>
<p>Istio 内部有一套内置的 PKI 证书基础设施。零信任架构中，PKI 是零信任模型身份认证的基石，大多数零信任网络都采用 PKI 来证明身份的真实性。零信任网络颁发的证书数量可能会很多，因此非常有必要对证书进行自动化管理。<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>
<h3 id="21-istiod-配置">2.1. Istiod 配置</h3>
<p>Istiod 默认启用内置的 CA 服务器。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/features/pilot.go
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">EnableCAServer</span> = <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">RegisterBoolVar</span>(<span style="color:#e6db74">&#34;ENABLE_CA_SERVER&#34;</span>, <span style="color:#66d9ef">true</span>,
        <span style="color:#e6db74">&#34;If this is set to false, will not create CA server in istiod.&#34;</span>).<span style="color:#a6e22e">Get</span>()
</code></pre></div><p>证书签名的默认配置项：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/bootstrap/istio_ca.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 兼容挂载名为 cacerts 的 secret
</span><span style="color:#75715e">// 但已经不使用
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 使用 &#34;istio-ca-secret&#34; 来创建证书
</span><span style="color:#75715e">// 兼容旧版本
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> (
    <span style="color:#75715e">// 挂载名为 cacerts 的 secret 的目录，Read-only
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">LocalCertDir</span> = <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">RegisterStringVar</span>(<span style="color:#e6db74">&#34;ROOT_CA_DIR&#34;</span>, <span style="color:#e6db74">&#34;./etc/cacerts&#34;</span>,
        <span style="color:#e6db74">&#34;Location of a local or mounted CA root&#34;</span>)
    
    <span style="color:#75715e">// 默认服务证书 TTL
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">workloadCertTTL</span> = <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">RegisterDurationVar</span>(<span style="color:#e6db74">&#34;DEFAULT_WORKLOAD_CERT_TTL&#34;</span>,
        <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">DefaultWorkloadCertTTL</span>,
        <span style="color:#e6db74">&#34;The default TTL of issued workload certificates. Applied when the client sets a &#34;</span><span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34;non-positive TTL in the CSR.&#34;</span>)

    <span style="color:#a6e22e">maxWorkloadCertTTL</span> = <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">RegisterDurationVar</span>(<span style="color:#e6db74">&#34;MAX_WORKLOAD_CERT_TTL&#34;</span>,
        <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">DefaultMaxWorkloadCertTTL</span>,
        <span style="color:#e6db74">&#34;The max TTL of issued workload certificates.&#34;</span>)

    <span style="color:#75715e">// 自签名 CA 证书 TTL
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">SelfSignedCACertTTL</span> = <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">RegisterDurationVar</span>(<span style="color:#e6db74">&#34;CITADEL_SELF_SIGNED_CA_CERT_TTL&#34;</span>,
        <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">DefaultSelfSignedCACertTTL</span>,
        <span style="color:#e6db74">&#34;The TTL of self-signed CA root certificate.&#34;</span>)
</code></pre></div><p>Istio 主程序会挂载两个 Secert，一个是 <em>cacerts</em> Secret，用于指定 Istio 启动时用户定义的 CA 证书，另一个是 <em>istio-ca-secret</em> Secret，用于储存 Istio Pilot Discovery 程序自签名的 CA 证书及其私钥。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#75715e">// CA 证书不应该在 Workload 证书失效之前就失效
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 所以此处设置证书的生命周期为证书链中的最短的时效期
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">defaultCertTTL</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">minTTL</span>(<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">DefaultCertTTL</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ca</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to get default cert TTL %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
    }
    <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">defaultCertTTL</span> = <span style="color:#a6e22e">defaultCertTTL</span>
</code></pre></div><p>CA 证书不应该在 Workload 证书失效之前就失效，所以此处设置 Workload 证书的生命周期为 CA 证书链中的最短的时效期。</p>
<p>Istio CA 实际挂载的 <em>istio-ca-secret</em> Secret 数据示例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">kind</span>: Secret
<span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: istio-ca-secret
  <span style="color:#66d9ef">namespace</span>: istio-system
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">ca-cert.pem</span>: &gt;-
LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvRENDQWVTZ0F3SUJBZ0lRQWVMc3E2ZDVFN0ZheVY2U...
  <span style="color:#66d9ef">ca-key.pem</span>: &gt;-LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBd2JpOWtucHVPS1d6SUxkM...
  <span style="color:#66d9ef">cert-chain.pem</span>: <span style="color:#e6db74">&#39;&#39;</span>
  <span style="color:#66d9ef">key.pem</span>: <span style="color:#e6db74">&#39;&#39;</span>
  <span style="color:#66d9ef">root-cert.pem</span>: <span style="color:#e6db74">&#39;&#39;</span>
<span style="color:#66d9ef">type</span>: istio.io/ca-root

</code></pre></div><h3 id="22-初始化">2.2. 初始化</h3>
<h4 id="221-入口流程">2.2.1. 入口流程</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/bootstrap/server.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// maybeCreateCA creates and initializes CA Key if needed.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">maybeCreateCA</span>(<span style="color:#a6e22e">caOpts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">caOptions</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// 默认启用
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">EnableCA</span>() {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;creating CA and initializing public key&#34;</span>)
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">corev1</span> <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">CoreV1Interface</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">corev1</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">CoreV1</span>()
        }
        <span style="color:#75715e">// 从远程 K8S 集群获取证书，默认不启用
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">useRemoteCerts</span>.<span style="color:#a6e22e">Get</span>() {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">loadRemoteCACerts</span>(<span style="color:#a6e22e">caOpts</span>, <span style="color:#a6e22e">LocalCertDir</span>.<span style="color:#a6e22e">Get</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to load remote CA certs: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
            }
        }

        <span style="color:#75715e">// TODO: Issue #27606 If External CA is configured, use that to sign DNS Certs as well. IstioCA need not be initialized
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">CA</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">createIstioCA</span>(<span style="color:#a6e22e">corev1</span>, <span style="color:#a6e22e">caOpts</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create CA: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initPublicKey</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error initializing public key: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><code>s.createIstioCA</code> 里面详细进行 CA 初始化的操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/bootstrap/istio_ca.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// createIstioCA initializes the Istio CA signing functionality.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">createIstioCA</span>(<span style="color:#a6e22e">client</span> <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">CoreV1Interface</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">caOptions</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">IstioCA</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">caOpts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">IstioCAOptions</span>
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>

    <span style="color:#75715e">// In pods, this is the optional &#39;cacerts&#39; Secret.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// TODO: also check for key.pem ( for interop )
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">signingKeyFile</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">LocalCertDir</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#e6db74">&#34;ca-key.pem&#34;</span>)

    <span style="color:#75715e">// If not found, will default to ca-cert.pem. May contain multiple roots.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rootCertFile</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">LocalCertDir</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#e6db74">&#34;root-cert.pem&#34;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">rootCertFile</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// 兼容 Istio 获取 Root cert 证书
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// In Citadel, normal self-signed doesn&#39;t use a root-cert.pem file for additional roots.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// In Istiod, it is possible to provide one via &#34;cacerts&#34; secret in both cases, for consistency.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rootCertFile</span> = <span style="color:#e6db74">&#34;&#34;</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">signingKeyFile</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// 在 K8S 集群中创建自签名证书
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// The user-provided certs are missing - create a self-signed cert.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Use self-signed certificate as the CA certificate&#34;</span>)
        <span style="color:#75715e">// Abort after 20 minutes.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span><span style="color:#f92672">*</span><span style="color:#ae81ff">20</span>)
        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
        <span style="color:#75715e">// 获取证书操作符
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// rootCertFile will be added to &#34;ca-cert.pem&#34;.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// readSigningCertOnly set to false - it doesn&#39;t seem to be used in Citadel, nor do we have a way
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// to set it only for one job.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">caOpts</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">NewSelfSignedIstioCAOptions</span>(<span style="color:#a6e22e">ctx</span>,
            <span style="color:#a6e22e">selfSignedRootCertGracePeriodPercentile</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#a6e22e">SelfSignedCACertTTL</span>.<span style="color:#a6e22e">Get</span>(),
            <span style="color:#a6e22e">selfSignedRootCertCheckInterval</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#a6e22e">workloadCertTTL</span>.<span style="color:#a6e22e">Get</span>(),
            <span style="color:#a6e22e">maxWorkloadCertTTL</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">TrustDomain</span>, <span style="color:#66d9ef">true</span>,
            <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">rootCertFile</span>,
            <span style="color:#a6e22e">enableJitterForRootCertRotator</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#a6e22e">caRSAKeySize</span>.<span style="color:#a6e22e">Get</span>())
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create a self-signed istiod CA: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#f92672">...</span>
    }
    <span style="color:#a6e22e">istioCA</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">NewIstioCA</span>(<span style="color:#a6e22e">caOpts</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create an istiod CA: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
    <span style="color:#a6e22e">istioCA</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">rootCertRotatorChan</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">istioCA</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>数据操作流程：</p>
<ol>
<li>
<p>首先读取 Kubernetes 中“cacerts”的 secret 挂载的本地目录。</p>
</li>
<li>
<p>若不存在则通过 go-client 获取 K8S 中 &ldquo;istio-ca-cert&rdquo; 的 secret，该 secret 包含 CA 的私钥及证书。</p>
</li>
<li>
<p>K8s 中没有 CA 证书，则开始自签名证书流程。</p>
</li>
</ol>
<h4 id="222-自签名-ca-证书">2.2.2. 自签名 CA 证书</h4>
<p>签发与获取证书相关参数配置对照表如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>DefaultSelfSignedCACertTTL</td>
<td>3650 * 24 * time.Hour</td>
<td>自签名 Root 证书默认的 TTL</td>
</tr>
<tr>
<td>DefaultSelfSignedRootCertCheckInterval</td>
<td>1 * time.Hour</td>
<td>自签名证书定期检查证书有效期或进行证书轮换检查的默认间隔时间</td>
</tr>
<tr>
<td>DefaultRootCertGracePeriodPercentile</td>
<td>20</td>
<td>根证书平滑轮换证书的有效时长百分比，相对于证书的有效周期（TTL）</td>
</tr>
<tr>
<td>ReadSigningCertRetryInterval</td>
<td>time.Second * 5</td>
<td>读取证书与私钥失败的重试间隔时间</td>
</tr>
<tr>
<td>ReadSigningCertRetryMax</td>
<td>time.Second * 30</td>
<td>读取证书与私钥失败的最大重试次数</td>
</tr>
<tr>
<td>DefaultMaxWorkloadCertTTL</td>
<td>90 * 24 * time.Hour</td>
<td>签发工作负载证书的默认最长的 TTL</td>
</tr>
<tr>
<td>DefaultWorkloadCertTTL</td>
<td>24 * time.Hour</td>
<td>签发工作负载证书的默认的 TTL</td>
</tr>
</tbody>
</table>
<p>Istio 是具体是如何使用 Go 官方包自签名一个 CA 证书的？
主要流程为：</p>
<ol>
<li>创建 RSA 私钥（Istio 还不支持 ECDSA 私钥）</li>
<li>构建 CSR（Certificate signing request）模板</li>
<li>填充 SPIFFE ID 到 CSR 的扩展字段（ASN.1）</li>
<li>自签名 CSR 生成证书</li>
<li>创建 Kubernetes Secret 资源储存 CA 证书和私钥</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/pki/ca/ca.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// K8S 集群内自签名证书
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewSelfSignedIstioCAOptions</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,
    <span style="color:#a6e22e">rootCertGracePeriodPercentile</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">caCertTTL</span>, <span style="color:#a6e22e">rootCertCheckInverval</span>, <span style="color:#a6e22e">defaultCertTTL</span>,
    <span style="color:#a6e22e">maxCertTTL</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>, <span style="color:#a6e22e">org</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">dualUse</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">namespace</span> <span style="color:#66d9ef">string</span>,
    <span style="color:#a6e22e">readCertRetryInterval</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>, <span style="color:#a6e22e">client</span> <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">CoreV1Interface</span>,
    <span style="color:#a6e22e">rootCertFile</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">enableJitter</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">caRSAKeySize</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">caOpts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">IstioCAOptions</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// 如果证书不存在则创建证书
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 后续读取 secret 获取
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 获取 K8S istio-ca-secret secret 资源
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">caSecret</span>, <span style="color:#a6e22e">scrtErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Secrets</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">CASecret</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
    <span style="color:#75715e">// 获取 secret 失败，尝试多次重新获取
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 若超时仍然获取不到，则创建自签名证书
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">scrtErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">readCertRetryInterval</span> &gt; <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#ae81ff">0</span>) {
        <span style="color:#a6e22e">pkiCaLog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Citadel in signing key/cert read only mode. Wait until secret %s:%s can be loaded...&#34;</span>, <span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">CASecret</span>)
        <span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">readCertRetryInterval</span>)
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">scrtErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">select</span> {
            <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">C</span>:
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">caSecret</span>, <span style="color:#a6e22e">scrtErr</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Secrets</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">CASecret</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{}); <span style="color:#a6e22e">scrtErr</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#a6e22e">pkiCaLog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Citadel successfully loaded the secret.&#34;</span>)
                }
            }
        }
    }

    <span style="color:#a6e22e">caOpts</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">IstioCAOptions</span>{
        <span style="color:#a6e22e">CAType</span>:         <span style="color:#a6e22e">selfSignedCA</span>, <span style="color:#75715e">// 1 自签名证书 2 用户自定义证书
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">DefaultCertTTL</span>: <span style="color:#a6e22e">defaultCertTTL</span>,
        <span style="color:#a6e22e">MaxCertTTL</span>:     <span style="color:#a6e22e">maxCertTTL</span>,
        <span style="color:#75715e">// CA 轮转检查
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">RotatorConfig</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SelfSignedCARootCertRotatorConfig</span>{
            <span style="color:#a6e22e">CheckInterval</span>:      <span style="color:#a6e22e">rootCertCheckInverval</span>,
            <span style="color:#a6e22e">caCertTTL</span>:          <span style="color:#a6e22e">caCertTTL</span>,
            <span style="color:#a6e22e">retryInterval</span>:      <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ReadSigningCertRetryInterval</span>, <span style="color:#75715e">// 默认 5 秒
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">retryMax</span>:           <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ReadSigningCertRetryMax</span>, <span style="color:#75715e">// 默认 30 秒
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">certInspector</span>:      <span style="color:#a6e22e">certutil</span>.<span style="color:#a6e22e">NewCertUtil</span>(<span style="color:#a6e22e">rootCertGracePeriodPercentile</span>),
            <span style="color:#a6e22e">caStorageNamespace</span>: <span style="color:#a6e22e">namespace</span>,
            <span style="color:#a6e22e">dualUse</span>:            <span style="color:#a6e22e">dualUse</span>, <span style="color:#75715e">// 默认 true
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">org</span>:                <span style="color:#a6e22e">org</span>,
            <span style="color:#a6e22e">rootCertFile</span>:       <span style="color:#a6e22e">rootCertFile</span>,
            <span style="color:#a6e22e">enableJitter</span>:       <span style="color:#a6e22e">enableJitter</span>,
            <span style="color:#a6e22e">client</span>:             <span style="color:#a6e22e">client</span>,
        },
    }
    <span style="color:#75715e">// 获取不到 secret，自签名创建
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">scrtErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">pkiCaLog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Failed to get secret (error: %s), will create one&#34;</span>, <span style="color:#a6e22e">scrtErr</span>)

        <span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">CertOptions</span>{
            <span style="color:#a6e22e">TTL</span>:          <span style="color:#a6e22e">caCertTTL</span>,
            <span style="color:#a6e22e">Org</span>:          <span style="color:#a6e22e">org</span>,
            <span style="color:#a6e22e">IsCA</span>:         <span style="color:#66d9ef">true</span>, <span style="color:#75715e">// 证书标识为 CA
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">IsSelfSigned</span>: <span style="color:#66d9ef">true</span>,
            <span style="color:#a6e22e">RSAKeySize</span>:   <span style="color:#a6e22e">caRSAKeySize</span>,
            <span style="color:#75715e">// Whether this certificate is for dual-use clients (SAN+CN).
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">IsDualUse</span>:    <span style="color:#a6e22e">dualUse</span>, <span style="color:#75715e">// 这个选项其实没有用到
</span><span style="color:#75715e"></span>        }
        <span style="color:#a6e22e">pemCert</span>, <span style="color:#a6e22e">pemKey</span>, <span style="color:#a6e22e">ckErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">GenCertKeyFromOptions</span>(<span style="color:#a6e22e">options</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ckErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unable to generate CA cert and key for self-signed CA (%v)&#34;</span>, <span style="color:#a6e22e">ckErr</span>)
        }

        <span style="color:#75715e">// 获取 RootCertFile 加入根证书链
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rootCerts</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">AppendRootCerts</span>(<span style="color:#a6e22e">pemCert</span>, <span style="color:#a6e22e">rootCertFile</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to append root certificates (%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
        }

        <span style="color:#75715e">// 构建储存证书链的并发安全的数据结构体
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">caOpts</span>.<span style="color:#a6e22e">KeyCertBundle</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">NewVerifiedKeyCertBundleFromPem</span>(<span style="color:#a6e22e">pemCert</span>, <span style="color:#a6e22e">pemKey</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">rootCerts</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create CA KeyCertBundle (%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
        }

        <span style="color:#75715e">// 在 K8S 中创建 secret 储存证书
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Write the key/cert back to secret so they will be persistent when CA restarts.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">secret</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">k8ssecret</span>.<span style="color:#a6e22e">BuildSecret</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">CASecret</span>, <span style="color:#a6e22e">namespace</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">pemCert</span>, <span style="color:#a6e22e">pemKey</span>, <span style="color:#a6e22e">istioCASecretType</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Secrets</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">secret</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">CreateOptions</span>{}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#f92672">...</span>
        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">// 从本地读取 CA 证书
</span><span style="color:#75715e"></span>    }
    <span style="color:#75715e">// 返回证书操作符
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">caOpts</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>默认使用 RSA 2048 size 生成私钥：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/pki/util/generate_cert.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// GenCertKeyFromOptions generates a X.509 certificate and a private key with the given options.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GenCertKeyFromOptions</span>(<span style="color:#a6e22e">options</span> <span style="color:#a6e22e">CertOptions</span>) (<span style="color:#a6e22e">pemCert</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">pemKey</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// 默认忽略，使用 RSA 算法
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">ECSigAlg</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#f92672">...</span>
    }

    <span style="color:#75715e">// 生成 RSA 密钥
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rsaPriv</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsa</span>.<span style="color:#a6e22e">GenerateKey</span>(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Reader</span>, <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">RSAKeySize</span>)
    <span style="color:#75715e">// 生成证书
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">genCert</span>(<span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">rsaPriv</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rsaPriv</span>.<span style="color:#a6e22e">PublicKey</span>)
}
</code></pre></div><p>创建一个证书模板，随后会从模板创建 CSR：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/pki/util/generate_cert.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// genCertTemplateFromoptions generates a certificate template with the given options.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">genCertTemplateFromOptions</span>(<span style="color:#a6e22e">options</span> <span style="color:#a6e22e">CertOptions</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">keyUsage</span> <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">KeyUsage</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">IsCA</span> {
        <span style="color:#75715e">// If the cert is a CA cert, the private key is allowed to sign other certificates.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">keyUsage</span> = <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">KeyUsageCertSign</span>
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// Otherwise the private key is allowed for digital signature and key encipherment.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">keyUsage</span> = <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">KeyUsageDigitalSignature</span> | <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">KeyUsageKeyEncipherment</span>
    }

    <span style="color:#a6e22e">subject</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pkix</span>.<span style="color:#a6e22e">Name</span>{
        <span style="color:#a6e22e">Organization</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">Org</span>},
    }

    <span style="color:#75715e">// 填充扩展字段
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">exts</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">pkix</span>.<span style="color:#a6e22e">Extension</span>{}
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">Host</span>; len(<span style="color:#a6e22e">h</span>) &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#75715e">// 生成 SAN
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">BuildSubjectAltNameExtension</span>(<span style="color:#a6e22e">h</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">IsDualUse</span> {
            <span style="color:#75715e">// 获取 common name
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">cn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DualUseCommonName</span>(<span style="color:#a6e22e">h</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#f92672">...</span>
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">subject</span>.<span style="color:#a6e22e">CommonName</span> = <span style="color:#a6e22e">cn</span>
            }
        }
        <span style="color:#a6e22e">exts</span> = []<span style="color:#a6e22e">pkix</span>.<span style="color:#a6e22e">Extension</span>{<span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>}
    }

    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>{
        <span style="color:#a6e22e">SerialNumber</span>:          <span style="color:#a6e22e">serialNum</span>,
        <span style="color:#a6e22e">Subject</span>:               <span style="color:#a6e22e">subject</span>,
        <span style="color:#a6e22e">NotBefore</span>:             <span style="color:#a6e22e">notBefore</span>,
        <span style="color:#a6e22e">NotAfter</span>:              <span style="color:#a6e22e">notBefore</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">TTL</span>),
        <span style="color:#a6e22e">KeyUsage</span>:              <span style="color:#a6e22e">keyUsage</span>,
        <span style="color:#a6e22e">ExtKeyUsage</span>:           <span style="color:#a6e22e">extKeyUsages</span>,
        <span style="color:#a6e22e">IsCA</span>:                  <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">IsCA</span>,
        <span style="color:#a6e22e">BasicConstraintsValid</span>: <span style="color:#66d9ef">true</span>,
        <span style="color:#a6e22e">ExtraExtensions</span>:       <span style="color:#a6e22e">exts</span>}, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>注入 SPIFFE 工作负载身份标识：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/pki/util/san.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// BuildSubjectAltNameExtension builds the SAN extension for the certificate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BuildSubjectAltNameExtension</span>(<span style="color:#a6e22e">hosts</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pkix</span>.<span style="color:#a6e22e">Extension</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">ids</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">Identity</span>{}
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">host</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">hosts</span>, <span style="color:#e6db74">&#34;,&#34;</span>) {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ip</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ParseIP</span>(<span style="color:#a6e22e">host</span>); <span style="color:#a6e22e">ip</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#75715e">// Use the 4-byte representation of the IP address when possible.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">eip</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ip</span>.<span style="color:#a6e22e">To4</span>(); <span style="color:#a6e22e">eip</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">ip</span> = <span style="color:#a6e22e">eip</span>
            }
            <span style="color:#a6e22e">ids</span> = append(<span style="color:#a6e22e">ids</span>, <span style="color:#a6e22e">Identity</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">TypeIP</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">ip</span>})
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">host</span>, <span style="color:#a6e22e">spiffe</span>.<span style="color:#a6e22e">URIPrefix</span>) {
            <span style="color:#a6e22e">ids</span> = append(<span style="color:#a6e22e">ids</span>, <span style="color:#a6e22e">Identity</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">TypeURI</span>, <span style="color:#a6e22e">Value</span>: []byte(<span style="color:#a6e22e">host</span>)})
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">ids</span> = append(<span style="color:#a6e22e">ids</span>, <span style="color:#a6e22e">Identity</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">TypeDNS</span>, <span style="color:#a6e22e">Value</span>: []byte(<span style="color:#a6e22e">host</span>)})
        }
    }

    <span style="color:#a6e22e">san</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">BuildSANExtension</span>(<span style="color:#a6e22e">ids</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;SAN extension building failure (%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">san</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// BuildSANExtension builds a `pkix.Extension` of type &#34;Subject
</span><span style="color:#75715e">// Alternative Name&#34; based on the given identities.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BuildSANExtension</span>(<span style="color:#a6e22e">identites</span> []<span style="color:#a6e22e">Identity</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pkix</span>.<span style="color:#a6e22e">Extension</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#75715e">// 如果 subject 的信息仅存在于 subjectAltName 扩展中(仅于Email地址或URI相关)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 则 subject name 必须为非空结构且 subjectAltName 扩展必须为 critical。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// SAN is Critical because the subject is empty. This is compliant with X.509 and SPIFFE standards.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pkix</span>.<span style="color:#a6e22e">Extension</span>{<span style="color:#a6e22e">Id</span>: <span style="color:#a6e22e">oidSubjectAlternativeName</span>, <span style="color:#a6e22e">Critical</span>: <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">bs</span>}, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>SPIFFE ID 储存在 X.509 证书的 SAN URI 字段中。</p>
<h4 id="223-储存证书">2.2.3. 储存证书</h4>
<p>Istiod 的 CA 证书同时也会储存到本地一份。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Save the root public key file and initialize the path the the file, to be used by other components.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initPublicKey</span>() <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// Setup the root cert chain and caBundlePath - before calling initDNSListener.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">PilotCertProvider</span>.<span style="color:#a6e22e">Get</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">IstiodCAProvider</span> {
        <span style="color:#a6e22e">signingKeyFile</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">LocalCertDir</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#e6db74">&#34;ca-key.pem&#34;</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">signingKeyFile</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#75715e">// When Citadel is configured to use self-signed certs, keep a local copy so other
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// components can load it via file (e.g. webhook config controller).
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">MkdirAll</span>(<span style="color:#a6e22e">dnsCertDir</span>, <span style="color:#ae81ff">0700</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#75715e">// We have direct access to the self-signed
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">internalSelfSignedRootPath</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">dnsCertDir</span>, <span style="color:#e6db74">&#34;self-signed-root.pem&#34;</span>)

            <span style="color:#a6e22e">rootCert</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">CA</span>.<span style="color:#a6e22e">GetCAKeyCertBundle</span>().<span style="color:#a6e22e">GetRootCertPem</span>()
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#a6e22e">internalSelfSignedRootPath</span>, <span style="color:#a6e22e">rootCert</span>, <span style="color:#ae81ff">0600</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#f92672">...</span>
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">caBundlePath</span> = <span style="color:#a6e22e">internalSelfSignedRootPath</span>
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>储存到本地目的是为了让各个独立的组件（虽然合并到 Istiod 程序中）都读取到 CA 证书。
同时还会监听文件系统的变化，及时替换证书。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// initCertificateWatches sets up  watches for the certs.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initCertificateWatches</span>(<span style="color:#a6e22e">tlsOptions</span> <span style="color:#a6e22e">TLSOptions</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// load the cert/key and setup a persistent watch for updates.
</span><span style="color:#75715e"></span>    <span style="color:#f92672">...</span>
}
</code></pre></div><h3 id="23-ca-证书轮换">2.3. CA 证书轮换</h3>
<p>CA 证书轮换的代码位于 <code>security/pkg/pki/ca/selfsignedcarootcertrotator.go</code> 文件中。</p>
<p>该模块定期检查 CA 证书有效性，比对 Kubernetes 的 Secret 资源中的 CA 证书与内存中储存的 CA 证书是否一致。
若证书即将过期，则使用私钥重新签名，以颁发新的可用的 CA 证书。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// NewSelfSignedCARootCertRotator returns a new root cert rotator instance that
</span><span style="color:#75715e">// rotates self-signed root cert periodically.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewSelfSignedCARootCertRotator</span>(<span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SelfSignedCARootCertRotatorConfig</span>,
    <span style="color:#a6e22e">ca</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">IstioCA</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">SelfSignedCARootCertRotator</span> {
    <span style="color:#a6e22e">rotator</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SelfSignedCARootCertRotator</span>{
        <span style="color:#a6e22e">caSecretController</span>: <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">NewCaSecretController</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">client</span>),
        <span style="color:#a6e22e">config</span>:             <span style="color:#a6e22e">config</span>,
        <span style="color:#a6e22e">ca</span>:                 <span style="color:#a6e22e">ca</span>,
    }
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rotator</span>
}
</code></pre></div><p>该证书轮换器带有指数退避算法，以更优雅地定期错误重试。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Run refreshes root certs and updates config map accordingly.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rotator</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SelfSignedCARootCertRotator</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">CheckInterval</span>)
    <span style="color:#66d9ef">for</span> {
        <span style="color:#66d9ef">select</span> {
        <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">C</span>:
            <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Check and rotate root cert.&#34;</span>)
            <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">checkAndRotateRootCert</span>()
        }
    }
}
</code></pre></div><p><code>checkAndRotateRootCert</code> 函数定时被执行，以确认证书的有效性指标。
<em>Citadel</em> 是 Istio 中专门负责认证相关的组件，虽然合并到 Istiod 中，
在代码中它还是被单独归类。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// checkAndRotateRootCert decides whether root cert should be refreshed, and rotates
</span><span style="color:#75715e">// root cert for self-signed Citadel.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rotator</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SelfSignedCARootCertRotator</span>) <span style="color:#a6e22e">checkAndRotateRootCert</span>() {
    <span style="color:#75715e">// 带失败重试获取 CA 证书的 K8s secret
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">caSecret</span>, <span style="color:#a6e22e">scrtErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">caSecretController</span>.<span style="color:#a6e22e">LoadCASecretWithRetry</span>(<span style="color:#a6e22e">CASecret</span>,
        <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">caStorageNamespace</span>, <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">retryInterval</span>, <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">retryMax</span>)

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">scrtErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#f92672">...</span>
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">checkAndRotateRootCertForSigningCertCitadel</span>(<span style="color:#a6e22e">caSecret</span>)
    }
}

<span style="color:#75715e">// checkAndRotateRootCertForSigningCertCitadel checks root cert secret and rotates
</span><span style="color:#75715e">// root cert if the current one is about to expire. The rotation uses existing
</span><span style="color:#75715e">// root private key to generate a new root cert, and updates root cert secret.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rotator</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SelfSignedCARootCertRotator</span>) <span style="color:#a6e22e">checkAndRotateRootCertForSigningCertCitadel</span>(
    <span style="color:#a6e22e">caSecret</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Secret</span>) {
    <span style="color:#75715e">// Check root certificate expiration time in CA secret
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">waitTime</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">certInspector</span>.<span style="color:#a6e22e">GetWaitTime</span>(<span style="color:#a6e22e">caSecret</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#a6e22e">caCertID</span>], <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>(), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#ae81ff">0</span>))
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">waitTime</span> &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Root cert is not about to expire, skipping root cert rotation.&#34;</span>)
        <span style="color:#a6e22e">caCertInMem</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">GetCAKeyCertBundle</span>().<span style="color:#a6e22e">GetAllPem</span>()
        <span style="color:#75715e">// 比较内存中的证书与 K8S 中的证书是否一致
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// If CA certificate is different from the CA certificate in local key
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// cert bundle, it implies that other Citadels have updated istio-ca-secret.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Reload root certificate into key cert bundle.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">caCertInMem</span>, <span style="color:#a6e22e">caSecret</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#a6e22e">caCertID</span>]) {
            <span style="color:#75715e">// 校验证书并将证书加载到内存中缓存
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">GetCAKeyCertBundle</span>().<span style="color:#a6e22e">VerifyAndSetAll</span>(<span style="color:#a6e22e">caSecret</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#a6e22e">caCertID</span>],
                <span style="color:#a6e22e">caSecret</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#a6e22e">caPrivateKeyID</span>], <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">rootCerts</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to reload root cert into KeyCertBundle (%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Successfully reloaded root cert into KeyCertBundle.&#34;</span>)
            }
        }
        <span style="color:#66d9ef">return</span>
    }

    <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Refresh root certificate, root cert is about to expire: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())


    <span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">CertOptions</span>{
        <span style="color:#a6e22e">TTL</span>:           <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">caCertTTL</span>,
        <span style="color:#a6e22e">SignerPrivPem</span>: <span style="color:#a6e22e">caSecret</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#a6e22e">caPrivateKeyID</span>],
        <span style="color:#a6e22e">Org</span>:           <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">org</span>,
        <span style="color:#a6e22e">IsCA</span>:          <span style="color:#66d9ef">true</span>,
        <span style="color:#a6e22e">IsSelfSigned</span>:  <span style="color:#66d9ef">true</span>,
        <span style="color:#a6e22e">RSAKeySize</span>:    <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">caRSAKeySize</span>,
        <span style="color:#a6e22e">IsDualUse</span>:     <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">dualUse</span>,
    }
    <span style="color:#75715e">// options should be consistent with the one used in NewSelfSignedIstioCAOptions().
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// This is to make sure when rotate the root cert, we don&#39;t make unnecessary changes
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// to the certificate or add extra fields to the certificate.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">options</span> = <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">MergeCertOptions</span>(<span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">oldCertOptions</span>)
    <span style="color:#75715e">// 重新签发证书
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pemCert</span>, <span style="color:#a6e22e">pemKey</span>, <span style="color:#a6e22e">ckErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">GenRootCertFromExistingKey</span>(<span style="color:#a6e22e">options</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ckErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unable to generate CA cert and key for self-signed CA: %s&#34;</span>, <span style="color:#a6e22e">ckErr</span>.<span style="color:#a6e22e">Error</span>())
        <span style="color:#66d9ef">return</span>
    }

    <span style="color:#f92672">...</span>
    <span style="color:#75715e">// 在 K8S 及内存中更新证书
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rollback</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">updateRootCertificate</span>(<span style="color:#a6e22e">caSecret</span>, <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">pemCert</span>, <span style="color:#a6e22e">pemKey</span>, <span style="color:#a6e22e">pemRootCerts</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">// caSecret is out-of-date. Need to load the latest istio-ca-secret to roll back root certificate.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rotator</span>.<span style="color:#a6e22e">updateRootCertificate</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">oldCaCert</span>, <span style="color:#a6e22e">oldCaPrivateKey</span>, <span style="color:#a6e22e">oldRootCerts</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Failed to roll backward root certificate (error: %s).&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
        }
        <span style="color:#66d9ef">return</span>
    }
    <span style="color:#a6e22e">rootCertRotatorLog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Root certificate rotation is completed successfully.&#34;</span>)
}
</code></pre></div><p>同时证书更新替换时也有失败回滚机制，CA 证书轮换后 Istio 会更新 Kubernetes 中 Secret 资源，以及内存中缓存的证书资源。
这类证书轮换函数，运行在独立的协程中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ca</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">IstioCA</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">rootCertRotator</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// Start root cert rotator in a separate goroutine.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">rootCertRotator</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopChan</span>)
    }
}
</code></pre></div><h3 id="24-签发-workload-证书">2.4. 签发 Workload 证书</h3>
<p>以上部分是 Istio 如何签发 CA 与轮换 CA 证书，因为证书都是在同一个进程中签发与替换，不涉及额外的网络操作，
相对流程比较清晰。Workload 证书签发是由独立运行的工作负载的 Pod 中的 Agent 进程向 Kubernetes 进行认证后，
发送 CSR 请求给 Istio CA 服务器进行签名的。它还拥有一套特殊的通信协议。</p>
<h4 id="241-启动-ca-服务器">2.4.1. 启动 CA 服务器</h4>
<p>Istiod 启动 CA 服务器，响应工作负载签发符合自身权限身份的 CSR 请求。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// StartCA starts the CA or RA server if configured.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">startCA</span>(<span style="color:#a6e22e">caOpts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">caOptions</span>) {
   <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">addStartFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
      <span style="color:#a6e22e">grpcServer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">secureGrpcServer</span>
      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">secureGrpcServer</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
         <span style="color:#a6e22e">grpcServer</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcServer</span>
      }
      <span style="color:#75715e">// Start the RA server if configured, else start the CA server
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">RA</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#f92672">...</span>
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">CA</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
         <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Starting IstioD CA&#34;</span>)
         <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">RunCA</span>(<span style="color:#a6e22e">grpcServer</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">CA</span>, <span style="color:#a6e22e">caOpts</span>)
      }
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
   })
}
</code></pre></div><p>CA 服务器的接口注册在 grpc 服务器上，注意这里开启了 TLS，通信协议是 grpcs。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 在 GRPCS 服务器上开启 CA
</span><span style="color:#75715e">// RunCA will start the cert signing GRPC service on an existing server.
</span><span style="color:#75715e">// Protected by installer options: the CA will be started only if the JWT token in /var/run/secrets
</span><span style="color:#75715e">// is mounted. If it is missing - for example old versions of K8S that don&#39;t support such tokens -
</span><span style="color:#75715e">// we will not start the cert-signing server, since pods will have no way to authenticate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">RunCA</span>(<span style="color:#a6e22e">grpc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>, <span style="color:#a6e22e">ca</span> <span style="color:#a6e22e">caserver</span>.<span style="color:#a6e22e">CertificateAuthority</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">caOptions</span>) {
    <span style="color:#a6e22e">iss</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">trustedIssuer</span>.<span style="color:#a6e22e">Get</span>() <span style="color:#75715e">// 默认为空
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">aud</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">audience</span>.<span style="color:#a6e22e">Get</span>() <span style="color:#75715e">// 默认为空
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 填充 iss 和 aud
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 默认获取 K8S SA Token
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// &#34;/var/run/secrets/kubernetes.io/serviceaccount/token&#34;
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">jwtPath</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// 获取 JWT Payload
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">tok</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">detectAuthEnv</span>(string(<span style="color:#a6e22e">token</span>))
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warn</span>(<span style="color:#e6db74">&#34;Starting with invalid K8S JWT token&#34;</span>, <span style="color:#a6e22e">err</span>, string(<span style="color:#a6e22e">token</span>))
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">iss</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
                <span style="color:#a6e22e">iss</span> = <span style="color:#a6e22e">tok</span>.<span style="color:#a6e22e">Iss</span>
            }
            <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tok</span>.<span style="color:#a6e22e">Aud</span>) &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">aud</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
                <span style="color:#a6e22e">aud</span> = <span style="color:#a6e22e">tok</span>.<span style="color:#a6e22e">Aud</span>[<span style="color:#ae81ff">0</span>]
            }
        }
    }

    <span style="color:#75715e">// The CA API uses cert with the max workload cert TTL.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// &#39;hostlist&#39; must be non-empty - but is not used since a grpc server is passed.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Adds client cert auth and kube (sds enabled)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 创建给 Workload 颁发证书的 CA
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">caServer</span>, <span style="color:#a6e22e">startErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">caserver</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">ca</span>, <span style="color:#a6e22e">maxWorkloadCertTTL</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Authenticators</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">startErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;failed to create istio ca server: %v&#34;</span>, <span style="color:#a6e22e">startErr</span>)
    }

    <span style="color:#75715e">// 注册 GRPC PB
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">caServer</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">grpc</span>)

    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Istiod CA has started&#34;</span>)
}
</code></pre></div><p>Kubernetes Serivce Account Token 包含的 Payload 数据示例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;iss&#34;</span>: <span style="color:#e6db74">&#34;kubernetes/serviceaccount&#34;</span>,
  <span style="color:#f92672">&#34;kubernetes.io/serviceaccount/namespace&#34;</span>: <span style="color:#e6db74">&#34;istio-system&#34;</span>,
  <span style="color:#f92672">&#34;kubernetes.io/serviceaccount/secret.name&#34;</span>: <span style="color:#e6db74">&#34;istio-reader-service-account-token-zmks5&#34;</span>,
  <span style="color:#f92672">&#34;kubernetes.io/serviceaccount/service-account.name&#34;</span>: <span style="color:#e6db74">&#34;istio-reader-service-account&#34;</span>,
  <span style="color:#f92672">&#34;kubernetes.io/serviceaccount/service-account.uid&#34;</span>: <span style="color:#e6db74">&#34;9a544d83-ed88-474f-967c-27473357ee95&#34;</span>,
  <span style="color:#f92672">&#34;sub&#34;</span>: <span style="color:#e6db74">&#34;system:serviceaccount:istio-system:istio-reader-service-account&#34;</span>
}
</code></pre></div><p>默认配置中，签发给 Workload 的证书的有效期是 90 天。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/server/ca/server.go
</span><span style="color:#75715e">// Register registers a GRPC server on the specified port.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">grpcServer</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>) {
    <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterIstioCertificateServiceServer</span>(<span style="color:#a6e22e">grpcServer</span>, <span style="color:#a6e22e">s</span>)
}

<span style="color:#75715e">// istio.io\api@v0.0.0-20201125194658-3cee6a1d3ab4\security\v1alpha1\ca.pb.go
</span><span style="color:#75715e">// IstioCertificateServiceServer is the server API for IstioCertificateService service.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IstioCertificateServiceServer</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#75715e">// Using provided CSR, returns a signed certificate.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">CreateCertificate</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">IstioCertificateRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">IstioCertificateResponse</span>, <span style="color:#66d9ef">error</span>)
}
</code></pre></div><p>CA 服务器的 grpc 接口只有一个 <code>CreateCertificate</code> 方法，调用该方法处理 CSR 请求。</p>
<h4 id="242-签发证书">2.4.2. 签发证书</h4>
<p>通过 grpcs 协议接收到 CSR 请求时，首先会进行认证：</p>
<p>Istio 支持多种方式进行认证，例如客户端证书、K8s JWT、ID Token 等，Istio 认证方法中会尝试从多个认证源进行认证，
选择出能够验证客户端身份的一种方式，当然认证失败就失败了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// authenticate goes through a list of authenticators (provided client cert, k8s jwt, and ID token)
</span><span style="color:#75715e">// and authenticates if one of them is valid.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">authenticate</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">Caller</span> {
    <span style="color:#75715e">// TODO: apply different authenticators in specific order / according to configuration.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">errMsg</span> <span style="color:#66d9ef">string</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">authn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Authenticators</span> {
        <span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">authn</span>.<span style="color:#a6e22e">Authenticate</span>(<span style="color:#a6e22e">ctx</span>)
        <span style="color:#f92672">...</span>
    }
    <span style="color:#a6e22e">serverCaLog</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;Authentication failed for %v: %s&#34;</span>, <span style="color:#a6e22e">getConnectionAddress</span>(<span style="color:#a6e22e">ctx</span>), <span style="color:#a6e22e">errMsg</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>具体处理 CSR 创建证书的接口逻辑：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// CreateCertificate handles an incoming certificate signing request (CSR). It does
</span><span style="color:#75715e">// authentication and authorization. Upon validated, signs a certificate that:
</span><span style="color:#75715e">// the SAN is the identity of the caller in authentication result.
</span><span style="color:#75715e">// the subject public key is the public key in the CSR.
</span><span style="color:#75715e">// the validity duration is the ValidityDuration in request, or default value if the given duration is invalid.
</span><span style="color:#75715e">// it is signed by the CA signing key.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">CreateCertificate</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">request</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">IstioCertificateRequest</span>) (
    <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">IstioCertificateResponse</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// metrics
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">monitoring</span>.<span style="color:#a6e22e">CSR</span>.<span style="color:#a6e22e">Increment</span>()
    <span style="color:#75715e">// 从 GRPC CTX 获取 TLS Info 里面的 SPIFFE ID
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">caller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">authenticate</span>(<span style="color:#a6e22e">ctx</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">caller</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// 缺少 TLS Info 的客户端证书的 SAN URI 字段
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">monitoring</span>.<span style="color:#a6e22e">AuthnError</span>.<span style="color:#a6e22e">Increment</span>()
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">codes</span>.<span style="color:#a6e22e">Unauthenticated</span>, <span style="color:#e6db74">&#34;request authenticate failure&#34;</span>)
    }

    <span style="color:#75715e">// TODO: Call authorizer.
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">certChainBytes</span>, <span style="color:#a6e22e">rootCertBytes</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">GetCAKeyCertBundle</span>().<span style="color:#a6e22e">GetAll</span>()
    <span style="color:#75715e">// 签发证书
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">cert</span>, <span style="color:#a6e22e">signErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">Sign</span>(
        []byte(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">Csr</span>), <span style="color:#a6e22e">caller</span>.<span style="color:#a6e22e">Identities</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">ValidityDuration</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#66d9ef">false</span>)
    
    <span style="color:#a6e22e">respCertChain</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{string(<span style="color:#a6e22e">cert</span>)}
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">certChainBytes</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#75715e">// 加入证书链
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">respCertChain</span> = append(<span style="color:#a6e22e">respCertChain</span>, string(<span style="color:#a6e22e">certChainBytes</span>))
    }
    <span style="color:#a6e22e">respCertChain</span> = append(<span style="color:#a6e22e">respCertChain</span>, string(<span style="color:#a6e22e">rootCertBytes</span>))
    <span style="color:#a6e22e">response</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">IstioCertificateResponse</span>{
        <span style="color:#a6e22e">CertChain</span>: <span style="color:#a6e22e">respCertChain</span>,
    }
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">monitoring</span>.<span style="color:#a6e22e">Success</span>.<span style="color:#a6e22e">Increment</span>()
    <span style="color:#a6e22e">serverCaLog</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;CSR successfully signed.&#34;</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h3 id="25-ra注册机构">2.5. RA（注册机构）</h3>
<blockquote>
<p>Istio 带有现成的证书颁发机构（CA），但不少用户也希望能够接入现有 CA。
在之前的版本中，您需要实现 Istio CSR  API 并自行编写第三方集成。
在 Istio 1.8 中，我们引入了一种使用 Kubernetes CSR  API 的新方法，此方法可与任何能够使用此API的工具相集成。
Istiod 将充当注册机构（RA）角色，负责对工作负载进行身份验证及授权，而后创建、批准并监控 CSR 资源的更新。
接下来，第三方工具（例如cert-manager）即可使用正确的签名程序创建具有适当后端 CA 的签名证书。
此功能目前尚处于试验阶段。<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/bootstrap/server.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">maybeCreateCA</span>(<span style="color:#a6e22e">caOpts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">caOptions</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">EnableCA</span>() {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">caOpts</span>.<span style="color:#a6e22e">ExternalCAType</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">RA</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">createIstioRA</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">caOpts</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create RA: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
            }
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><p>如果配置了自定义 CA，则启用 RA 功能。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/bootstrap/istio_ca.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// createIstioRA initializes the Istio RA signing functionality.
</span><span style="color:#75715e">// the caOptions defines the external provider
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">createIstioRA</span>(<span style="color:#a6e22e">client</span> <span style="color:#a6e22e">kubelib</span>.<span style="color:#a6e22e">Client</span>,
   <span style="color:#a6e22e">opts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">caOptions</span>) (<span style="color:#a6e22e">ra</span>.<span style="color:#a6e22e">RegistrationAuthority</span>, <span style="color:#66d9ef">error</span>) {

   <span style="color:#a6e22e">caCertFile</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">ra</span>.<span style="color:#a6e22e">DefaultExtCACertDir</span>, <span style="color:#a6e22e">constants</span>.<span style="color:#a6e22e">CACertNamespaceConfigMapDataName</span>)
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">caCertFile</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">caCertFile</span> = <span style="color:#a6e22e">defaultCACertPath</span>
   }
   <span style="color:#a6e22e">raOpts</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ra</span>.<span style="color:#a6e22e">IstioRAOptions</span>{
      <span style="color:#a6e22e">ExternalCAType</span>: <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">ExternalCAType</span>,
      <span style="color:#a6e22e">DefaultCertTTL</span>: <span style="color:#a6e22e">workloadCertTTL</span>.<span style="color:#a6e22e">Get</span>(),
      <span style="color:#a6e22e">MaxCertTTL</span>:     <span style="color:#a6e22e">maxWorkloadCertTTL</span>.<span style="color:#a6e22e">Get</span>(),
      <span style="color:#a6e22e">CaSigner</span>:       <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">ExternalCASigner</span>,
      <span style="color:#a6e22e">CaCertFile</span>:     <span style="color:#a6e22e">caCertFile</span>,
      <span style="color:#a6e22e">VerifyAppendCA</span>: <span style="color:#66d9ef">true</span>,
      <span style="color:#a6e22e">K8sClient</span>:      <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CertificatesV1beta1</span>(),
   }
   <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ra</span>.<span style="color:#a6e22e">NewIstioRA</span>(<span style="color:#a6e22e">raOpts</span>)

}

<span style="color:#75715e">// security/pkg/pki/ra/common.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// NewIstioRA is a factory method that returns an RA that implements the RegistrationAuthority functionality.
</span><span style="color:#75715e">// the caOptions defines the external provider
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewIstioRA</span>(<span style="color:#a6e22e">opts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">IstioRAOptions</span>) (<span style="color:#a6e22e">RegistrationAuthority</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">ExternalCAType</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">ExtCAK8s</span> {
        <span style="color:#a6e22e">istioRA</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewKubernetesRA</span>(<span style="color:#a6e22e">opts</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create an K8s CA: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">istioRA</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;invalid CA Name %s&#34;</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">ExternalCAType</span>)
}

</code></pre></div><p>看上去 RA 类型现在只支持 Kubernetes 一种。</p>
<p>RA 默认不启用，同时处于试验阶段，这里不加以分析。</p>
<h2 id="3-通信安全">3. 通信安全</h2>
<p>加密和认证通常是紧密相关的，在零信任流量安全中，
对于客户端/服务器的交互，使用双向认证的 TLS 协议是一种的合理的网络安全方案，
这种方案通常包括配置客户端并将客户端证书提供给服务器端访问代理，以确保连接经过认证和授权<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>。</p>
<h3 id="31-加密与认证">3.1. 加密与认证</h3>
<h4 id="311-tls-验证">3.1.1. TLS 验证</h4>
<p>初始化服务端的 TLS 的校验方式。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/bootstrap/server.go
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Config</span>{
        <span style="color:#a6e22e">GetCertificate</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">getIstiodCertificate</span>,
        <span style="color:#a6e22e">ClientAuth</span>:     <span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">VerifyClientCertIfGiven</span>,
        <span style="color:#a6e22e">ClientCAs</span>:      <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">peerCertVerifier</span>.<span style="color:#a6e22e">GetGeneralCertPool</span>(),
        <span style="color:#a6e22e">VerifyPeerCertificate</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">rawCerts</span> [][]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">verifiedChains</span> [][]<span style="color:#f92672">*</span><span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">Certificate</span>) <span style="color:#66d9ef">error</span> {
            <span style="color:#75715e">// 使用 SPIFFE 包校验 TLS 证书有效性
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">peerCertVerifier</span>.<span style="color:#a6e22e">VerifyPeerCert</span>(<span style="color:#a6e22e">rawCerts</span>, <span style="color:#a6e22e">verifiedChains</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Could not verify certificate: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
            }
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        },
    }
</code></pre></div><p>ClientAuth 有五种类型，各自的含义是：</p>
<ul>
<li>
<p>NoClientCert：忽略任何客户端证书，即客户端可以不提供证书。</p>
</li>
<li>
<p>RequestClientCer：要求客户端提供证书，但是如果客户端没有提供证书，服务端还是会继续处理请求。</p>
</li>
<li>
<p>RequireAnyClientCert：需要客户端提供证书，但不用ClientCA来验证证书的有效性。</p>
</li>
<li>
<p>VerifyClientCertIfGiven：如果客户端提供了证书，则用ClientCA来验证证书的有效性。 如果客户端没提供，则会继续处理请求。</p>
</li>
<li>
<p>RequireAndVerifyClientCert：需要客户端提供证书，且会用ClientCA来验证证书的有效性。</p>
</li>
</ul>
<p>在 tlsConfig 中如果不显式的指定 ClientAuth，则默认值是 NoClientCert。即使 Server 端配置了 CA，也不会校验客户端证书。</p>
<h4 id="312-身份认证">3.1.2. 身份认证</h4>
<p>配置服务端对客户端进行身份认证的方式，默认启用客户端证书，以及 K8s JWT。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#75715e">// pilot/pkg/bootstrap/server.go
</span><span style="color:#75715e"></span> 
     <span style="color:#75715e">// Notice that the order of authenticators matters, since at runtime
</span><span style="color:#75715e"></span>     <span style="color:#75715e">// authenticators are activated sequentially and the first successful attempt
</span><span style="color:#75715e"></span>     <span style="color:#75715e">// is used as the authentication result.
</span><span style="color:#75715e"></span>     <span style="color:#75715e">// The JWT authenticator requires the multicluster registry to be initialized, so we build this later
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">authenticators</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">Authenticator</span>{
         <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">ClientCertAuthenticator</span>{},
         <span style="color:#a6e22e">kubeauth</span>.<span style="color:#a6e22e">NewKubeJWTAuthenticator</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">clusterID</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">multicluster</span>.<span style="color:#a6e22e">GetRemoteKubeClient</span>, <span style="color:#a6e22e">spiffe</span>.<span style="color:#a6e22e">GetTrustDomain</span>(), <span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">JwtPolicy</span>.<span style="color:#a6e22e">Get</span>()),
     }
 
     <span style="color:#75715e">// 默认启用
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">caOpts</span>.<span style="color:#a6e22e">Authenticators</span> = <span style="color:#a6e22e">authenticators</span>
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">XDSAuth</span> {
         <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">XDSServer</span>.<span style="color:#a6e22e">Authenticators</span> = <span style="color:#a6e22e">authenticators</span>
     }
</code></pre></div><p>无论是 grpcs，还是 grpc 协议都会启用强认证。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/server/ca/authenticate/model.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Caller carries the identity and authentication source of a caller.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Caller</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">AuthSource</span> <span style="color:#a6e22e">AuthSource</span>
    <span style="color:#a6e22e">Identities</span> []<span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Authenticator</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#a6e22e">Authenticate</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Caller</span>, <span style="color:#66d9ef">error</span>)
    <span style="color:#a6e22e">AuthenticatorType</span>() <span style="color:#66d9ef">string</span>
}

</code></pre></div><p>实现了 Authenticator 接口的认证器调用 Authenticate 方法从 grpc 请求的上下文 Metadata 字段中获取 Caller 信息，校验失败则返回错误。</p>
<h5 id="客户端证书认证">客户端证书认证</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/server/ca/authenticate/cert_authenticator.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// ClientCertAuthenticator extracts identities from client certificate.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ClientCertAuthenticator</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">Authenticator</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ClientCertAuthenticator</span>{}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cca</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClientCertAuthenticator</span>) <span style="color:#a6e22e">AuthenticatorType</span>() <span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ClientCertAuthenticatorType</span>
}

<span style="color:#75715e">// Authenticate extracts identities from presented client certificates. This
</span><span style="color:#75715e">// method assumes that certificate chain has been properly validated before
</span><span style="color:#75715e">// this method is called. In other words, this method does not do certificate
</span><span style="color:#75715e">// chain validation itself.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cca</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClientCertAuthenticator</span>) <span style="color:#a6e22e">Authenticate</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Caller</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// 从 GRPC 连接获取 peer 信息
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">peer</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span>)
    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">AuthInfo</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;no client certificate is presented&#34;</span>)
    }

    <span style="color:#75715e">// 连接必须为 TLS
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">authType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">AuthInfo</span>.<span style="color:#a6e22e">AuthType</span>(); <span style="color:#a6e22e">authType</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;tls&#34;</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unsupported auth type: %q&#34;</span>, <span style="color:#a6e22e">authType</span>)
    }

    <span style="color:#a6e22e">tlsInfo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">AuthInfo</span>.(<span style="color:#a6e22e">credentials</span>.<span style="color:#a6e22e">TLSInfo</span>)
    <span style="color:#a6e22e">chains</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tlsInfo</span>.<span style="color:#a6e22e">State</span>.<span style="color:#a6e22e">VerifiedChains</span>
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">chains</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">chains</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;no verified chain is found&#34;</span>)
    }

    <span style="color:#a6e22e">ids</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ExtractIDs</span>(<span style="color:#a6e22e">chains</span>[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Extensions</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Caller</span>{
        <span style="color:#a6e22e">AuthSource</span>: <span style="color:#a6e22e">AuthSourceClientCertificate</span>,
        <span style="color:#a6e22e">Identities</span>: <span style="color:#a6e22e">ids</span>, <span style="color:#75715e">// id 应该就是 SPIFFE ID
</span><span style="color:#75715e"></span>    }, <span style="color:#66d9ef">nil</span>
}

</code></pre></div><p>grpc TLS 包会在 TLS 握手阶段获取 SPIFFIE ID：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// grpc@v1.33.1\credentials\tls.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// TLSInfo contains the auth information for a TLS authenticated connection.
</span><span style="color:#75715e">// It implements the AuthInfo interface.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">TLSInfo</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">State</span> <span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">ConnectionState</span>
    <span style="color:#a6e22e">CommonAuthInfo</span>
    <span style="color:#75715e">// This API is experimental.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">SPIFFEID</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">tlsCreds</span>) <span style="color:#a6e22e">ServerHandshake</span>(<span style="color:#a6e22e">rawConn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) (<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">AuthInfo</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Server</span>(<span style="color:#a6e22e">rawConn</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Handshake</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">tlsInfo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">TLSInfo</span>{
        <span style="color:#a6e22e">State</span>: <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">ConnectionState</span>(),
        <span style="color:#a6e22e">CommonAuthInfo</span>: <span style="color:#a6e22e">CommonAuthInfo</span>{
            <span style="color:#a6e22e">SecurityLevel</span>: <span style="color:#a6e22e">PrivacyAndIntegrity</span>,
        },
    }
    <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">credinternal</span>.<span style="color:#a6e22e">SPIFFEIDFromState</span>(<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">ConnectionState</span>())
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">tlsInfo</span>.<span style="color:#a6e22e">SPIFFEID</span> = <span style="color:#a6e22e">id</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">credinternal</span>.<span style="color:#a6e22e">WrapSyscallConn</span>(<span style="color:#a6e22e">rawConn</span>, <span style="color:#a6e22e">conn</span>), <span style="color:#a6e22e">tlsInfo</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// grpc@v1.33.1\internal\credentials\spiffe.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// SPIFFEIDFromState parses the SPIFFE ID from State. If the SPIFFE ID format
</span><span style="color:#75715e">// is invalid, return nil with warning.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SPIFFEIDFromState</span>(<span style="color:#a6e22e">state</span> <span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">ConnectionState</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span> {
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">PeerCertificates</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">PeerCertificates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">URIs</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">spiffeID</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">uri</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">PeerCertificates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">URIs</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">uri</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">Scheme</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;spiffe&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">Opaque</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">||</span> (<span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">User</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Username</span>() <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span>) {
            <span style="color:#66d9ef">continue</span>
        }
        <span style="color:#75715e">// From this point, we assume the uri is intended for a SPIFFE ID.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">String</span>()) &gt; <span style="color:#ae81ff">2048</span> {
            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warning</span>(<span style="color:#e6db74">&#34;invalid SPIFFE ID: total ID length larger than 2048 bytes&#34;</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">Host</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">RawPath</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">Path</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warning</span>(<span style="color:#e6db74">&#34;invalid SPIFFE ID: domain or workload ID is empty&#34;</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">uri</span>.<span style="color:#a6e22e">Host</span>) &gt; <span style="color:#ae81ff">255</span> {
            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warning</span>(<span style="color:#e6db74">&#34;invalid SPIFFE ID: domain length larger than 255 characters&#34;</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#75715e">// A valid SPIFFE certificate can only have exactly one URI SAN field.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">PeerCertificates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">URIs</span>) &gt; <span style="color:#ae81ff">1</span> {
            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warning</span>(<span style="color:#e6db74">&#34;invalid SPIFFE ID: multiple URI SANs&#34;</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#a6e22e">spiffeID</span> = <span style="color:#a6e22e">uri</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">spiffeID</span>
}

</code></pre></div><h5 id="k8s-jwt-认证">K8s JWT 认证</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/server/ca/authenticate/kubeauth/kube_jwt.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// KubeJWTAuthenticator authenticates K8s JWTs.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">KubeJWTAuthenticator</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">trustDomain</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">jwtPolicy</span>   <span style="color:#66d9ef">string</span>

    <span style="color:#75715e">// Primary cluster kube client
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">kubeClient</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">Interface</span>
    <span style="color:#75715e">// Primary cluster ID
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">clusterID</span> <span style="color:#66d9ef">string</span>

    <span style="color:#75715e">// remote cluster kubeClient getter
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">remoteKubeClientGetter</span> <span style="color:#a6e22e">RemoteKubeClientGetter</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">Authenticator</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">KubeJWTAuthenticator</span>{}

<span style="color:#75715e">// Authenticate authenticates the call using the K8s JWT from the context.
</span><span style="color:#75715e">// The returned Caller.Identities is in SPIFFE format.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">KubeJWTAuthenticator</span>) <span style="color:#a6e22e">Authenticate</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">Caller</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// 从 HTTP Authenticate 字段获取 JWT Token
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">targetJWT</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">ExtractBearerToken</span>(<span style="color:#a6e22e">ctx</span>)
    <span style="color:#a6e22e">clusterID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">extractClusterID</span>(<span style="color:#a6e22e">ctx</span>)
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">id</span> []<span style="color:#66d9ef">string</span>

    <span style="color:#a6e22e">kubeClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">GetKubeClient</span>(<span style="color:#a6e22e">clusterID</span>)
    
    <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tokenreview</span>.<span style="color:#a6e22e">ValidateK8sJwt</span>(<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">targetJWT</span>, <span style="color:#a6e22e">aud</span>)
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">callerNamespace</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">id</span>[<span style="color:#ae81ff">0</span>]
    <span style="color:#a6e22e">callerServiceAccount</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">id</span>[<span style="color:#ae81ff">1</span>]
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">Caller</span>{
        <span style="color:#a6e22e">AuthSource</span>: <span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">AuthSourceIDToken</span>,
        <span style="color:#a6e22e">Identities</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#a6e22e">authenticate</span>.<span style="color:#a6e22e">IdentityTemplate</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">trustDomain</span>, <span style="color:#a6e22e">callerNamespace</span>, <span style="color:#a6e22e">callerServiceAccount</span>)},
    }, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>从 grpc 通信 Metadata 中获取 JWT Token，与 K8s API Server 通信认证 Token：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ValidateK8sJwt</span>(<span style="color:#a6e22e">kubeClient</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#a6e22e">targetToken</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">aud</span> []<span style="color:#66d9ef">string</span>) ([]<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">tokenReview</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">k8sauth</span>.<span style="color:#a6e22e">TokenReview</span>{
        <span style="color:#a6e22e">Spec</span>: <span style="color:#a6e22e">k8sauth</span>.<span style="color:#a6e22e">TokenReviewSpec</span>{
            <span style="color:#a6e22e">Token</span>: <span style="color:#a6e22e">targetToken</span>,
        },
    }
    <span style="color:#a6e22e">reviewRes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">AuthenticationV1</span>().<span style="color:#a6e22e">TokenReviews</span>().<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">tokenReview</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">CreateOptions</span>{})
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getTokenReviewResult</span>(<span style="color:#a6e22e">reviewRes</span>)
}
</code></pre></div><p>从代码注释中可以看到请求和返回的示例数据：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#75715e">// An example SA token:
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// {&#34;alg&#34;:&#34;RS256&#34;,&#34;typ&#34;:&#34;JWT&#34;}
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// {&#34;iss&#34;:&#34;kubernetes/serviceaccount&#34;,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  &#34;kubernetes.io/serviceaccount/namespace&#34;:&#34;default&#34;,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  &#34;kubernetes.io/serviceaccount/secret.name&#34;:&#34;example-pod-sa-token-h4jqx&#34;,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  &#34;kubernetes.io/serviceaccount/service-account.name&#34;:&#34;example-pod-sa&#34;,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  &#34;kubernetes.io/serviceaccount/service-account.uid&#34;:&#34;ff578a9e-65d3-11e8-aad2-42010a8a001d&#34;,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  &#34;sub&#34;:&#34;system:serviceaccount:default:example-pod-sa&#34;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  }
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// An example token review status
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// &#34;status&#34;:{
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//   &#34;authenticated&#34;:true,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//   &#34;user&#34;:{
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//     &#34;username&#34;:&#34;system:serviceaccount:default:example-pod-sa&#34;,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//     &#34;uid&#34;:&#34;ff578a9e-65d3-11e8-aad2-42010a8a001d&#34;,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//     &#34;groups&#34;:[&#34;system:serviceaccounts&#34;,&#34;system:serviceaccounts:default&#34;,&#34;system:authenticated&#34;]
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//    }
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// }
</span></code></pre></div><h3 id="32-xds-通信协议">3.2. xDS 通信协议</h3>
<p>SDS 协议是 xDS 协议的一类，在 Istio 中，SDS 用于传输证书数据。</p>
<p><img src="graph-xds.png" alt=""></p>
<p><em>pilot-agent</em> 原本叫 Node Agent，负责转发 Envoy 的 SDS 请求，以及负责生成 CSR 请求到 discovery。</p>
<p>为了避免混淆，注明镜像名：</p>
<ul>
<li>pilot-agent: <code>istio/proxyv2:1.8.0</code> 中的 <code>pilot-agent proxy sidecar</code></li>
<li>discovery: <code>istio/pilot:1.8.0</code></li>
</ul>
<h4 id="321-server">3.2.1. Server</h4>
<h5 id="事件广播">事件广播</h5>
<p>Discovery 初始化 SDS 服务器：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// initSDSServer starts the SDS server
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initSDSServer</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PilotArgs</span>) {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">EnableXDSIdentityCheck</span> {
            <span style="color:#75715e">// Make sure we have security
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;skipping Kubernetes credential reader; PILOT_ENABLE_XDS_IDENTITY_CHECK must be set to true for this feature.&#34;</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// 启用 XDS Namespace 认证
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 默认是 istio-system Namespace
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 监听 K8S Secrets 变化
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">sc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubesecrets</span>.<span style="color:#a6e22e">NewMulticluster</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">clusterID</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">RegistryOptions</span>.<span style="color:#a6e22e">ClusterRegistriesNamespace</span>)
            <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">namespace</span> <span style="color:#66d9ef">string</span>) {
                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">XDSServer</span>.<span style="color:#a6e22e">ConfigUpdate</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">PushRequest</span>{
                    <span style="color:#a6e22e">Full</span>: <span style="color:#66d9ef">false</span>,
                    <span style="color:#a6e22e">ConfigsUpdated</span>: <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigKey</span>]<span style="color:#66d9ef">struct</span>{}{
                        {
                            <span style="color:#a6e22e">Kind</span>:      <span style="color:#a6e22e">gvk</span>.<span style="color:#a6e22e">Secret</span>,
                            <span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">name</span>,
                            <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">namespace</span>,
                        }: {},
                    },
                    <span style="color:#a6e22e">Reason</span>: []<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">TriggerReason</span>{<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">SecretTrigger</span>},
                })
            })
            <span style="color:#75715e">// XDS Generator
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">XDSServer</span>.<span style="color:#a6e22e">Generators</span>[<span style="color:#a6e22e">v3</span>.<span style="color:#a6e22e">SecretType</span>] = <span style="color:#a6e22e">xds</span>.<span style="color:#a6e22e">NewSecretGen</span>(<span style="color:#a6e22e">sc</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">XDSServer</span>.<span style="color:#a6e22e">Cache</span>)
        }
    }
}
</code></pre></div><p><code>SecretController</code> 会监视 K8s 集群中特殊类型（Istio 多集群）的 Secret 资源变化，并通过 xDS 广播：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pkg/kube/secretcontroller/secretcontroller.go
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">secretsInformer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewSharedIndexInformer</span>(
        <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ListWatch</span>{
            <span style="color:#a6e22e">ListFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">opts</span> <span style="color:#a6e22e">meta_v1</span>.<span style="color:#a6e22e">ListOptions</span>) (<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#66d9ef">error</span>) {
                <span style="color:#75715e">// 限定 Label 为 &#34;istio/multiCluster=true&#34;
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LabelSelector</span> = <span style="color:#a6e22e">MultiClusterSecretLabel</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;=true&#34;</span>
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">kubeclientset</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Secrets</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">opts</span>)
            },
            <span style="color:#a6e22e">WatchFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">opts</span> <span style="color:#a6e22e">meta_v1</span>.<span style="color:#a6e22e">ListOptions</span>) (<span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#66d9ef">error</span>) {
                <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">LabelSelector</span> = <span style="color:#a6e22e">MultiClusterSecretLabel</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;=true&#34;</span>
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">kubeclientset</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Secrets</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">opts</span>)
            },
        },
        <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Secret</span>{}, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Indexers</span>{},
    )
</code></pre></div><h5 id="gateway-证书">Gateway 证书</h5>
<p><code>Generate</code> 方法仅仅在 pilot-agent 类型为 router（即 Gateway）的时候生成 Envoy 使用的证书返回。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot/pkg/xds/sds.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 与 Node Agent 也就是 Istio Proxy 进行通信返回的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SecretGen</span>) <span style="color:#a6e22e">Generate</span>(<span style="color:#a6e22e">proxy</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Proxy</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">PushContext</span>, <span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">WatchedResource</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">PushRequest</span>) <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Resources</span> {
  <span style="color:#f92672">...</span>
   <span style="color:#75715e">// 调用 K8S API Server 确认身份 SA 是否有权限访问 secrets
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">Authorize</span>(<span style="color:#a6e22e">proxy</span>.<span style="color:#a6e22e">VerifiedIdentity</span>.<span style="color:#a6e22e">ServiceAccount</span>, <span style="color:#a6e22e">proxy</span>.<span style="color:#a6e22e">VerifiedIdentity</span>.<span style="color:#a6e22e">Namespace</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">adsLog</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;proxy %v is not authorized to receive secrets: %v&#34;</span>, <span style="color:#a6e22e">proxy</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">err</span>)
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
   }
   <span style="color:#75715e">// 如果不是 gateway 则返回 nil
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">needsUpdate</span>(<span style="color:#a6e22e">proxy</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ConfigsUpdated</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
   }
   <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">updatedSecrets</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigKey</span>]<span style="color:#66d9ef">struct</span>{}
   <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Full</span> {
      <span style="color:#a6e22e">updatedSecrets</span> = <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigsOfKind</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ConfigsUpdated</span>, <span style="color:#a6e22e">gvk</span>.<span style="color:#a6e22e">Secret</span>)
   }
   <span style="color:#a6e22e">results</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Resources</span>{}
   <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">resource</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">ResourceNames</span> {
      <span style="color:#f92672">...</span>
      <span style="color:#a6e22e">isCAOnlySecret</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasSuffix</span>(<span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">GatewaySdsCaSuffix</span>)
      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isCAOnlySecret</span> {
         <span style="color:#a6e22e">secret</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">GetCaCert</span>(<span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">Namespace</span>)
         <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">secret</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">toEnvoyCaSecret</span>(<span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">ResourceName</span>, <span style="color:#a6e22e">secret</span>)
            <span style="color:#a6e22e">results</span> = append(<span style="color:#a6e22e">results</span>, <span style="color:#a6e22e">res</span>)
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">sr</span>, <span style="color:#a6e22e">res</span>)
         } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">adsLog</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;failed to fetch ca certificate for %v&#34;</span>, <span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">ResourceName</span>)
         }
      } <span style="color:#66d9ef">else</span> {
          <span style="color:#75715e">// 生成密钥和证书
</span><span style="color:#75715e"></span>         <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">cert</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">GetKeyAndCert</span>(<span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">Namespace</span>)
         <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">cert</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">toEnvoyKeyCertSecret</span>(<span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">ResourceName</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">cert</span>)
            <span style="color:#a6e22e">results</span> = append(<span style="color:#a6e22e">results</span>, <span style="color:#a6e22e">res</span>)
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">sr</span>, <span style="color:#a6e22e">res</span>)
         } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">adsLog</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;failed to fetch key and certificate for %v&#34;</span>, <span style="color:#a6e22e">sr</span>.<span style="color:#a6e22e">ResourceName</span>)
         }
      }
   }
   <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">results</span>
}
</code></pre></div><h4 id="322-client">3.2.2. Client</h4>
<h5 id="初始化-sds">初始化 SDS</h5>
<p>配置项：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pilot-agent 更新证书周期是 24 小时
</span><span style="color:#75715e"></span><span style="color:#a6e22e">secretTTLEnv</span> = <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">RegisterDurationVar</span>(<span style="color:#e6db74">&#34;SECRET_TTL&#34;</span>, <span style="color:#ae81ff">24</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span>,
        <span style="color:#e6db74">&#34;The cert lifetime requested by istio agent&#34;</span>).<span style="color:#a6e22e">Get</span>()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pkg/istio-agent/agent.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sa</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">isSidecar</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">podNamespace</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">sds</span>.<span style="color:#a6e22e">Server</span>, <span style="color:#66d9ef">error</span>) {

    <span style="color:#75715e">// 本地进程证书缓存
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// TODO: remove the caching, workload has a single cert
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">WorkloadSecrets</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">WorkloadSecrets</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">newWorkloadSecretCache</span>()
    }

    <span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sds</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">secOpts</span>, <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">WorkloadSecrets</span>)


    <span style="color:#75715e">// Start the local XDS generator.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">localXDSGenerator</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">startXDSGenerator</span>(<span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">proxyConfig</span>, <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">WorkloadSecrets</span>, <span style="color:#a6e22e">podNamespace</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to start local xds generator: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">initLocalDNSServer</span>(<span style="color:#a6e22e">isSidecar</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to start local DNS server: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">ProxyXDSViaAgent</span> {
        <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">xdsProxy</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">initXdsProxy</span>(<span style="color:#a6e22e">sa</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to start xds proxy: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">server</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>此部分有异常多旧代码以及 TODO，推测是原来架构有 DaemonSet 部署的 Node Agent，目前架构中去除了，Node Agent 的工作由 pilot-agent 完成，只处理自身容器内 Envoy 的请求，自然不需要多复杂的缓存机制。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/nodeagent/sds/server.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// NewServer creates and starts the Grpc server for SDS.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">options</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ca2</span>.<span style="color:#a6e22e">Options</span>, <span style="color:#a6e22e">workloadSecretCache</span> <span style="color:#a6e22e">ca2</span>.<span style="color:#a6e22e">SecretManager</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
        <span style="color:#a6e22e">workloadSds</span>: <span style="color:#a6e22e">newSDSService</span>(<span style="color:#a6e22e">workloadSecretCache</span>, <span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">FileMountedCerts</span>),
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">EnableWorkloadSDS</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initWorkloadSdsService</span>(<span style="color:#a6e22e">options</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">sdsServiceLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Failed to initialize secret discovery service for workload proxies: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initWorkloadSdsService</span>(<span style="color:#a6e22e">options</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ca2</span>.<span style="color:#a6e22e">Options</span>) <span style="color:#66d9ef">error</span> { <span style="color:#75715e">//nolint: unparam
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">GrpcServer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcWorkloadServer</span> = <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">GrpcServer</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">workloadSds</span>.<span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcWorkloadServer</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcWorkloadServer</span> = <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcServerOptions</span>(<span style="color:#a6e22e">options</span>)<span style="color:#f92672">...</span>)
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">workloadSds</span>.<span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcWorkloadServer</span>)

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
    <span style="color:#75715e">// Unix Domain Socket SDS 通信
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcWorkloadListener</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">uds</span>.<span style="color:#a6e22e">NewListener</span>(<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">WorkloadUDSPath</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">sdsServiceLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Failed to set up UDS path: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }

    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">sdsServiceLog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Start SDS grpc server&#34;</span>)
        <span style="color:#f92672">...</span>
    }()

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>这里可以看到本地监听 UDS，与 Envoy 通信。</p>
<h5 id="构建-csr">构建 CSR</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// pkg/istio-agent/agent.go
</span><span style="color:#75715e"></span>
        <span style="color:#f92672">...</span>
            <span style="color:#75715e">// 获取 Istio CA 的证书，挂载的 Configmap
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">caCertFile</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">FindRootCAForCA</span>()
        <span style="color:#f92672">...</span>
             <span style="color:#75715e">// 与 Istio CA 建立连接
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">caClient</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">citadel</span>.<span style="color:#a6e22e">NewCitadelClient</span>(<span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">secOpts</span>.<span style="color:#a6e22e">CAEndpoint</span>, <span style="color:#a6e22e">tls</span>, <span style="color:#a6e22e">rootCert</span>, <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">secOpts</span>.<span style="color:#a6e22e">ClusterID</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/nodeagent/cache/secretcache.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// GenerateSecret generates new secret and cache the secret, this function is called by SDS.StreamSecrets
</span><span style="color:#75715e">// and SDS.FetchSecret. Since credential passing from client may change, regenerate secret every time
</span><span style="color:#75715e">// instead of reading from cache.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SecretCache</span>) <span style="color:#a6e22e">GenerateSecret</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">connectionID</span>, <span style="color:#a6e22e">resourceName</span>, <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">security</span>.<span style="color:#a6e22e">SecretItem</span>, <span style="color:#66d9ef">error</span>) {

   <span style="color:#75715e">// First try to generate secret from file.
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">sdsFromFile</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">generateFileSecret</span>(<span style="color:#a6e22e">connKey</span>, <span style="color:#a6e22e">token</span>)

   <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ns</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SecretCache</span>) <span style="color:#a6e22e">generateSecret</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">connKey</span> <span style="color:#a6e22e">ConnKey</span>, <span style="color:#a6e22e">t</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">security</span>.<span style="color:#a6e22e">SecretItem</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#75715e">// 构建 SPIFFE SAN 字段
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">csrHostName</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">spiffe</span>.<span style="color:#a6e22e">Identity</span>{
        <span style="color:#a6e22e">TrustDomain</span>:    <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">configOptions</span>.<span style="color:#a6e22e">TrustDomain</span>,
        <span style="color:#a6e22e">Namespace</span>:      <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">configOptions</span>.<span style="color:#a6e22e">WorkloadNamespace</span>,
        <span style="color:#a6e22e">ServiceAccount</span>: <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">configOptions</span>.<span style="color:#a6e22e">ServiceAccount</span>,
    }

    <span style="color:#75715e">// 构建 CSR 参数
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pkiutil</span>.<span style="color:#a6e22e">CertOptions</span>{
        <span style="color:#a6e22e">Host</span>:       <span style="color:#a6e22e">csrHostName</span>.<span style="color:#a6e22e">String</span>(),
        <span style="color:#a6e22e">RSAKeySize</span>: <span style="color:#a6e22e">keySize</span>,
        <span style="color:#a6e22e">PKCS8Key</span>:   <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">configOptions</span>.<span style="color:#a6e22e">Pkcs8Keys</span>,
        <span style="color:#a6e22e">ECSigAlg</span>:   <span style="color:#a6e22e">pkiutil</span>.<span style="color:#a6e22e">SupportedECSignatureAlgorithms</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">configOptions</span>.<span style="color:#a6e22e">ECCSigAlg</span>),
    }

    <span style="color:#75715e">// Generate the cert/key, send CSR to CA.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">csrPEM</span>, <span style="color:#a6e22e">keyPEM</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pkiutil</span>.<span style="color:#a6e22e">GenCSR</span>(<span style="color:#a6e22e">options</span>)

    <span style="color:#75715e">// 调用 Istio CA 发送 CSR 请求
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">certChainPEM</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">sendRetriableRequest</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">csrPEM</span>, <span style="color:#a6e22e">exchangedToken</span>, <span style="color:#a6e22e">connKey</span>, <span style="color:#66d9ef">true</span>)
<span style="color:#f92672">...</span>
}
</code></pre></div><p>流程：</p>
<ol>
<li>检查/创建私钥</li>
<li>构建 CSR（CSR 的 Host 是 SAN URI，即 SPIFFE ID）</li>
<li>请求 Istio CA</li>
</ol>
<h5 id="证书轮换">证书轮换</h5>
<p>两种情况：</p>
<ol>
<li>Workload 证书定期更新</li>
<li>CA 证书改变</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/nodeagent/cache/secretcache.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SecretCache</span>) <span style="color:#a6e22e">shouldRotate</span>(<span style="color:#a6e22e">secret</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">security</span>.<span style="color:#a6e22e">SecretItem</span>) <span style="color:#66d9ef">bool</span> {
    <span style="color:#75715e">// secret should be rotated before it expired.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">secretLifeTime</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">ExpireTime</span>.<span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">CreatedTime</span>)
    <span style="color:#a6e22e">gracePeriod</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">configOptions</span>.<span style="color:#a6e22e">SecretRotationGracePeriodRatio</span> <span style="color:#f92672">*</span> float64(<span style="color:#a6e22e">secretLifeTime</span>))
    <span style="color:#a6e22e">rotate</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">ExpireTime</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">gracePeriod</span>))
    <span style="color:#a6e22e">cacheLog</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Secret %s: lifetime: %v, graceperiod: %v, expiration: %v, should rotate: %v&#34;</span>,
        <span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">ResourceName</span>, <span style="color:#a6e22e">secretLifeTime</span>, <span style="color:#a6e22e">gracePeriod</span>, <span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">ExpireTime</span>, <span style="color:#a6e22e">rotate</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rotate</span>
}
</code></pre></div><p>默认 Workload 证书 24 小时轮换。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/nodeagent/cache/secretcache.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SecretCache</span>) <span style="color:#a6e22e">addFileWatcher</span>(<span style="color:#a6e22e">file</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">connKey</span> <span style="color:#a6e22e">ConnKey</span>) {
    <span style="color:#f92672">...</span>

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">certWatcher</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">file</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#f92672">...</span>
    }
    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">timerC</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
        <span style="color:#66d9ef">for</span> {
            <span style="color:#66d9ef">select</span> {
            <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">timerC</span>:
                <span style="color:#a6e22e">timerC</span> = <span style="color:#66d9ef">nil</span>
                <span style="color:#75715e">// TODO(ramaraochavali): Remove the watchers for unused keys and certs.
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">certMutex</span>.<span style="color:#a6e22e">RLock</span>()
                <span style="color:#a6e22e">connKeys</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">fileCerts</span>[<span style="color:#a6e22e">npath</span>]
                <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">certMutex</span>.<span style="color:#a6e22e">RUnlock</span>()
                <span style="color:#75715e">// Update all connections that use this file.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">ckey</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">connKeys</span> {
                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">ckey</span>); <span style="color:#a6e22e">ok</span> {
                        <span style="color:#75715e">// Regenerate the Secret and trigger the callback that pushes the secrets to proxy.
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// 重新生成证书
</span><span style="color:#75715e"></span>                        <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">generateFileSecret</span>(<span style="color:#a6e22e">ckey</span>, <span style="color:#a6e22e">token</span>)
                    }
                }
            }
        }
    }()
}
</code></pre></div><p>监听根证书文件的变化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// security/pkg/nodeagent/cache/secretcache.go        
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sitem</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">generateRootCertFromExistingFile</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">existingRootCertFile</span>, <span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">connKey</span>, <span style="color:#66d9ef">true</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">addFileWatcher</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">existingRootCertFile</span>, <span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">connKey</span>)
        }
</code></pre></div><p>附 Istio 证书体系相关流程图<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup>：</p>
<p><img src="cert-flow.png" alt=""></p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>摘自《零信任网络 : 在不可信网络中构建安全系统》第 6 章—建立用户信任 <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://istio.io/latest/docs/concepts/security/#secure-naming">Istio / Security - Secure naming</a> <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="https://github.com/spiffe/spiffe/blob/main/standards/SPIFFE.md#1-introduction">Secure Production Identity Framework for Everyone (SPIFFE) - 1. Introduction</a> <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p><a href="https://developer.aliyun.com/article/740195">Kubernetes 下零信任安全架构分析 - 蚂蚁零信任架构体系落地最佳实践</a> <a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p>摘自《零信任网络 : 在不可信网络中构建安全系统》第 2 章—信任管理 <a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p><a href="https://istio.io/latest/news/releases/1.8.x/announcing-1.8/">Announcing Istio 1.8</a> <a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7" role="doc-endnote">
<p>摘自《零信任网络 : 在不可信网络中构建安全系统》第 8 章—建立流量信任 <a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8" role="doc-endnote">
<p><a href="https://blog.csdn.net/yevvzi/article/details/107863433">Istio 证书签发流程</a> <a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb"> 
            源码阅读</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/%e9%9b%b6%e4%bf%a1%e4%bb%bb"> , 
            零信任</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/istio"> , 
            Istio</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/envoy"> , 
            Envoy</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/%e5%ae%89%e5%85%a8"> , 
            安全</a>
            
          </ul>
        </div>
        <!-- previous -->
        
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://cloudnative.to/blog/apisix-source-code-reading/" data-toggle="tooltip" data-placement="top" title="云原生网关 APISIX 核心流程源码分析与进化方向思考">&larr; 上一篇</a>
</li>
 
<li class="next">
<a href="https://cloudnative.to/blog/how-ebpf-streamlines-the-service-mesh/" data-toggle="tooltip" data-placement="top" title="eBPF 如何简化服务网格">下一篇 &rarr;</a>
</li>

</ul>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/istio-debug-with-envoy-log/">istio 数据面日志调试</a></li>
  
    <li><a href="/blog/using-envoyfilter-extend-istio/">Kubernetes上的Service Mesh实践：用EnvoyFilter扩展Istio</a></li>
  
    <li><a href="/blog/envoy-service-mesh-and-observability-best-practices-for-enterprises/">Envoy、服务网格和可观察性之企业最佳实践</a></li>
  
    <li><a href="/blog/building-a-control-plane-for-envoy/">为 Envoy 赋能——如何基于 Envoy 构建一个多用途控制平面</a></li>
  
    <li><a href="/blog/service-mesh-the-microservices-in-post-kubernetes-era/">Service Mesh——后 Kubernetes 时代的微服务</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
    <!-- categories -->
<div class="bg-pink px-4 py-5 box-shadow mb-5">
  <h4 class="mb-4">分类</h4>
  <ul class="list-unstyled">
    <li class="border-bottom"><a href="/categories/devops" class="d-block pb-3 mt-3 text-capitalize">Devops</a></li>
    <li class="border-bottom"><a href="/categories/envoy" class="d-block pb-3 mt-3 text-capitalize">Envoy</a></li>
    <li class="border-bottom"><a href="/categories/istio" class="d-block pb-3 mt-3 text-capitalize">Istio</a></li>
    <li class="border-bottom"><a href="/categories/kubernetes" class="d-block pb-3 mt-3 text-capitalize">Kubernetes</a></li>
    <li class="border-bottom"><a href="/categories/serverless" class="d-block pb-3 mt-3 text-capitalize">Serverless</a></li>
    <li class="border-bottom"><a href="/categories/service-mesh" class="d-block pb-3 mt-3 text-capitalize">Service mesh</a></li>
    <li class="border-bottom"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="d-block pb-3 mt-3 text-capitalize">云原生</a></li>
    <li class="border-bottom"><a href="/categories/%e5%85%b6%e4%bb%96" class="d-block pb-3 mt-3 text-capitalize">其他</a></li>
    <li class="border-bottom"><a href="/categories/%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">可观察性</a></li>
    <li class="border-bottom"><a href="/categories/%e5%ae%89%e5%85%a8" class="d-block pb-3 mt-3 text-capitalize">安全</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90" class="d-block pb-3 mt-3 text-capitalize">开源</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" class="d-block pb-3 mt-3 text-capitalize">开源社区</a></li>
    <li class="border-bottom"><a href="/categories/%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98" class="d-block pb-3 mt-3 text-capitalize">持续交付</a></li>
    <li class="border-bottom"><a href="/categories/%e7%a8%b3%e5%ae%9a%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">稳定性</a></li>
    <li class="border-bottom"><a href="/categories/%e8%be%b9%e7%bc%98%e8%ae%a1%e7%ae%97" class="d-block pb-3 mt-3 text-capitalize">边缘计算</a></li>
  </ul>
</div>

  <!-- tags -->
  

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <div class="mx-auto avatar-wrp">
        <img class="rounded-circle avatar-img" src="https://github.com/mayocream.png">
      </div>
      <p class="avatar-name">
        <strong class="text-dark "><a href="https://github.com/mayocream">Mayo Cream</a></strong> 
      </p>
      <p>Kubernetes Member, CNCF Security TAG Member, OSS Contributor.</p>
    </div>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-身份模型">1. 身份模型</a>
      <ul>
        <li><a href="#11-介绍">1.1. 介绍</a></li>
        <li><a href="#12-代码实现">1.2. 代码实现</a></li>
      </ul>
    </li>
    <li><a href="#2-私有-pki">2. 私有 PKI</a>
      <ul>
        <li><a href="#21-istiod-配置">2.1. Istiod 配置</a></li>
        <li><a href="#22-初始化">2.2. 初始化</a></li>
        <li><a href="#23-ca-证书轮换">2.3. CA 证书轮换</a></li>
        <li><a href="#24-签发-workload-证书">2.4. 签发 Workload 证书</a></li>
        <li><a href="#25-ra注册机构">2.5. RA（注册机构）</a></li>
      </ul>
    </li>
    <li><a href="#3-通信安全">3. 通信安全</a>
      <ul>
        <li><a href="#31-加密与认证">3.1. 加密与认证</a></li>
        <li><a href="#32-xds-通信协议">3.2. xDS 通信协议</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是国内最大的独立第三方云原生终端用户和泛开发者社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，提供云原生专业资讯，促进云原生产业发展。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fab fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fab fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://mp.weixin.qq.com/s/vWlSdzz2MNdXRr0sd2-LFg"><i class="fab fa-weixin"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="far fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://zhuanlan.zhihu.com/cloud-native"><i class="fab fa-zhihu"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://space.bilibili.com/515485124"><i class="fas fa-play-circle"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fas fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="/city/chengdu">成都</a>|<a href="/city/shenzhen">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="/city/guangzhou/">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2022 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/policy"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
