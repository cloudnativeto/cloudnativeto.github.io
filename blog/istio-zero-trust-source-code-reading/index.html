<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="本文分析 Istio 安全认证体系与加密通信的源码，让读者对零信任的实践有清晰的认识，这些知识能帮助构建零信任认证与通信体系。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/istio-zero-trust-source-code-reading/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/istio-zero-trust-source-code-reading/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/istio-zero-trust-source-code-reading/" />
  <meta property="og:title" content="Istio 安全源码分析——认证体系与通信安全 | 云原生社区（中国）" />
  <meta property="og:description" content="本文分析 Istio 安全认证体系与加密通信的源码，让读者对零信任的实践有清晰的认识，这些知识能帮助构建零信任认证与通信体系。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2021-10-27T03:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-04-23T14:31:13&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/istio-zero-trust-source-code-reading/"
  },
  "headline": "Istio 安全源码分析——认证体系与通信安全",
  
  "datePublished": "2021-10-27T03:00:00+08:00",
  "dateModified": "2023-04-23T14:31:13+08:00",
  
  "author": {
    "@type": "Person",
    "name": "Mayo Cream"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "本文分析 Istio 安全认证体系与加密通信的源码，让读者对零信任的实践有清晰的认识，这些知识能帮助构建零信任认证与通信体系。"
}
</script>

  

  

  

  





  <title>Istio 安全源码分析——认证体系与通信安全 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="29fe8aca997efd7fe97c9659b7e09e6b" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>Istio 安全源码分析——认证体系与通信安全</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/mayo-cream/">Mayo Cream</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/service-mesh/" class="text-capitalize">service mesh</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2021-10-27
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 10010
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 46 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-身份模型">1. 身份模型</a>
      <ul>
        <li><a href="#11-介绍">1.1. 介绍</a></li>
        <li><a href="#12-代码实现">1.2. 代码实现</a></li>
      </ul>
    </li>
    <li><a href="#2-私有-pki">2. 私有 PKI</a>
      <ul>
        <li><a href="#21-istiod-配置">2.1. Istiod 配置</a></li>
        <li><a href="#22-初始化">2.2. 初始化</a></li>
        <li><a href="#23-ca-证书轮换">2.3. CA 证书轮换</a></li>
        <li><a href="#24-签发-workload-证书">2.4. 签发 Workload 证书</a></li>
        <li><a href="#25-ra注册机构">2.5. RA（注册机构）</a></li>
      </ul>
    </li>
    <li><a href="#3-通信安全">3. 通信安全</a>
      <ul>
        <li><a href="#31-加密与认证">3.1. 加密与认证</a></li>
        <li><a href="#32-xds-通信协议">3.2. xDS 通信协议</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-身份模型">1. 身份模型</a>
      <ul>
        <li><a href="#11-介绍">1.1. 介绍</a></li>
        <li><a href="#12-代码实现">1.2. 代码实现</a></li>
      </ul>
    </li>
    <li><a href="#2-私有-pki">2. 私有 PKI</a>
      <ul>
        <li><a href="#21-istiod-配置">2.1. Istiod 配置</a></li>
        <li><a href="#22-初始化">2.2. 初始化</a></li>
        <li><a href="#23-ca-证书轮换">2.3. CA 证书轮换</a></li>
        <li><a href="#24-签发-workload-证书">2.4. 签发 Workload 证书</a></li>
        <li><a href="#25-ra注册机构">2.5. RA（注册机构）</a></li>
      </ul>
    </li>
    <li><a href="#3-通信安全">3. 通信安全</a>
      <ul>
        <li><a href="#31-加密与认证">3.1. 加密与认证</a></li>
        <li><a href="#32-xds-通信协议">3.2. xDS 通信协议</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

                    
                    <p>本文分析 Istio 安全认证体系与加密通信的源码，介绍 Istio 是如何构建集群内部 PKI 证书基础设施和实施安全通信的。</p>
<p>分析过程的代码注释在我的 Github 仓库 <a href="https://github.com/mayocream/istio/tree/citadel-review" target="_blank" rel="noopener">mayocream/istio</a> 的 citadel-review 分支。</p>
<h2 id="1-身份模型">1. 身份模型</h2>
<p>零信任架构下，需要严格区分工作负载的识别和信任，而签发 X.509 证书是推荐的一种认证方式<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。在 Kubernetes 集群中，服务间是通过 DNS 名称互相访问的，而网络流量可能被 DNS 欺骗、BGP/路由劫持、ARP 欺骗等手段劫持，为了将服务名称（DNS 名称）与服务身份强关联起来，Istio 使用置于 X.509 证书中的安全命名（Secure naming）机制<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>。</p>
<p>SPIFFE 是 Istio 所采用的安全命名的规范，它也是云原生定义的一种标准化的、可移植的工作负载身份规范。<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<h3 id="11-介绍">1.1. 介绍</h3>
<p><a href="https://spiffe.io/" target="_blank" rel="noopener">Secure Production Identity Framework For Everyone (SPIFFE)</a> 是一套服务之间相互进行身份识别的标准，主要包含以下内容：</p>
<ul>
<li>SPIFFE ID 标准，SPIFFE ID 是服务的唯一标识，具体实现使用 URI 资源标识符。</li>
<li>SPIFFE Verifiable Identity Document (SVID) 标准，将 SPIFFE ID 编码到一个加密的可验证的数据格式中。</li>
<li>颁发与撤销 SVID 的 API 标准。</li>
</ul>
<p>SPIFFE ID 规定了形如 <code>spiffe://&lt;trust domain&gt;/&lt;workload identifier&gt;</code> 的 URI 格式，作为工作负载（Workload）的唯一标识。SVID 是 SPIFFE ID 的识别凭证，有 X.509 和 JWT 两种格式。</p>
<p>SPIFFE 规范的实现有 spiffe 官方的 <a href="https://github.com/spiffe/spire" target="_blank" rel="noopener">Spire</a> 项目，而 Istio 在自身的生态中只使用到了 SPIFFE ID 作为安全命名，其数据格式由自己实现，通信格式采用 CNCF 支持的 <a href="https://github.com/cncf/xds" target="_blank" rel="noopener">xDS</a> 协议规范（证书认证通信更具体来说是 xDS 的 SDS）。</p>
<p>Istio 使用形如 <code>spiffe://&lt;trust_domain&gt;/ns/&lt;namespace&gt;/sa/&lt;service_account&gt;</code> 格式的 SPIFFE ID 作为安全命名，注入到 X.509 证书的 subjectAltName 扩展中。其中“trust domain”参数通过 Istiod 环境变量 <code>TRUST_DOMAIN</code> 注入，用于在多集群环境中交互。</p>
<p>















<figure  id="figure-istio-安全架构">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Istio 安全架构"
           src="/blog/istio-zero-trust-source-code-reading/istio-security-arch-sec.svg"
           loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Istio 安全架构
    </figcaption></figure>
</p>
<h3 id="12-代码实现">1.2. 代码实现</h3>
<p>SPIFFE 官方提供了 Go SDK <a href="https://github.com/spiffe/go-spiffe" target="_blank" rel="noopener">go-spiffe</a>，提供一种标准的 SPIFFE 协议的客户端实现。
由于 Istio 仅仅使用了 SPIFFE ID，没有必要引入这个 SDK，还值得一提的是该 SDK 引入了 grpc 包，如果你和我一样踩过 grpc 包引用版本冲突的问题，还花费了一下午的时间来解决，这次一定要保持警惕。</p>
<p>Istio 将自己实现的 SPIFFE 相关的代码存放在 pkg 目录下的 spiffe 目录。</p>
<h4 id="数据结构">数据结构</h4>
<p>这里再提一次数据格式是形如 <code>spiffe://&lt;trust_domain&gt;/ns/&lt;namespace&gt;/sa/&lt;service_account&gt;</code> 的 URI 字符串。这类身份标识因系统设计不同，定义的格式也各不相同，例如蚂蚁内部使用的身份标识格式是 <code>spiffe://&lt;domain&gt;/cluster/&lt;cluster&gt;/&lt;required_attr_1_name&gt;/&lt;required_attr_1_value&gt;/&lt;required_attr_2_name&gt;/&lt;required_attr_2_value&gt;</code><sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>。</p>
<p>定义 SPIFFE 的数据结构及其解析方式。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Identity</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">TrustDomain</span>    <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Namespace</span>      <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ServiceAccount</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ParseIdentity</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Identity</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">URIPrefix</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">Identity</span><span class="p">{},</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;identity is not a spiffe format: %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">split</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">URIPrefixLen</span><span class="p">:],</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Identity</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">TrustDomain</span><span class="p">:</span>    <span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Namespace</span><span class="p">:</span>      <span class="nx">split</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ServiceAccount</span><span class="p">:</span> <span class="nx">split</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">i</span> <span class="nx">Identity</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">URIPrefix</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">TrustDomain</span> <span class="o">+</span> <span class="s">&#34;/ns/&#34;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">Namespace</span> <span class="o">+</span> <span class="s">&#34;/sa/&#34;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ServiceAccount</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>信任域（Trust Domain）是由 Istiod 主程序启动时调用 <code>spiffe.SetTrustDomain(s.environment.Mesh().GetTrustDomain())</code> 函数方法设置的。</p>
<h4 id="tls-验证">TLS 验证</h4>
<p>Go 官方的 tls 包提供了 <em>VerifyPeerCertificate</em> 方法，该方法通常会在标准证书校验后（验证服务端 IP 或 DNS 名称以及证书链校验）被调用，提供额外的自定义 Peer 证书验证功能。</p>
<p>由于 SPIFFE ID 属于证书扩展内容，程序需要额外校验 SPIFFE 身份。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pkg/spiffe/spiffe.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">PeerCertVerifier</span><span class="p">)</span> <span class="nf">VerifyPeerCert</span><span class="p">(</span><span class="nx">rawCerts</span> <span class="p">[][]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">_</span> <span class="p">[][]</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 下游服务证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">peerCert</span> <span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CA 证书链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">intCertPool</span> <span class="o">:=</span> <span class="nx">x509</span><span class="p">.</span><span class="nf">NewCertPool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">rawCert</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rawCerts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cert</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">x509</span><span class="p">.</span><span class="nf">ParseCertificate</span><span class="p">(</span><span class="nx">rawCert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 第一个证书为 Workload 证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">peerCert</span> <span class="p">=</span> <span class="nx">cert</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">intCertPool</span><span class="p">.</span><span class="nf">AddCert</span><span class="p">(</span><span class="nx">cert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ERROR: SAN URIs 没有 SPIFFE ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">peerCert</span><span class="p">.</span><span class="nx">URIs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;peer certificate does not contain 1 URI type SAN, detected %d&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">peerCert</span><span class="p">.</span><span class="nx">URIs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">trustDomain</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">GetTrustDomainFromURISAN</span><span class="p">(</span><span class="nx">peerCert</span><span class="p">.</span><span class="nx">URIs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 根证书池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rootCertPool</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">certPools</span><span class="p">[</span><span class="nx">trustDomain</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no cert pool found for trust domain %s&#34;</span><span class="p">,</span> <span class="nx">trustDomain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 验证证书有效性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">peerCert</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">x509</span><span class="p">.</span><span class="nx">VerifyOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Roots</span><span class="p">:</span>         <span class="nx">rootCertPool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Intermediates</span><span class="p">:</span> <span class="nx">intCertPool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>校验过程会检查 SPIFFE ID 字段是否存在，以及 CA 证书的信任域是否与工作负载的证书处于同一有效的信任域。若校验失败，TLS 握手会以失败告终。</p>
<p>Istiod 在主程序启动时调用 <em>setPeerCertVerifier</em> 方法，设置额外的 mTLS 校验方式，以及添加 CA 证书到 Cert Pool 里：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// setPeerCertVerifier 设置 Istiod 的 SPIFFE 校验方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">setPeerCertVerifier</span><span class="p">(</span><span class="nx">tlsOptions</span> <span class="nx">TLSOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用上述的 spiffe 包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nx">peerCertVerifier</span> <span class="p">=</span> <span class="nx">spiffe</span><span class="p">.</span><span class="nf">NewPeerCertVerifier</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">rootCertBytes</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CA 证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">tlsOptions</span><span class="p">.</span><span class="nx">CaCertFile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 传入 CA 证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 加入 CA 根证书到 SPIFFIE 的信任证书里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rootCertBytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">peerCertVerifier</span><span class="p">.</span><span class="nf">AddMappingFromPEM</span><span class="p">(</span><span class="nx">spiffe</span><span class="p">.</span><span class="nf">GetTrustDomain</span><span class="p">(),</span> <span class="nx">rootCertBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="外部-ca">外部 CA</h4>
<p>Istio 实现了 <a href="https://github.com/spiffe/spiffe/blob/master/standards/SPIFFE_Trust_Domain_and_Bundle.md" target="_blank" rel="noopener">SPIFFE Bundle</a> 协议，该协议允许访问外部 URI 通过规定的 <a href="https://datatracker.ietf.org/doc/html/rfc7517" target="_blank" rel="noopener">JWK（JSON Web Key）</a>数据格式，获取信任域对应的根证书，而无需将根证书置于程序内部。</p>
<p>Istio 定义的数据格式：</p>
<ul>
<li><em>&lt;trustdomain, endpoint&gt;</em> 元组以 || 分割</li>
<li>每个元组内使用 | 分割 trustdomain 和 endpoint</li>
<li>例如：<code>foo|https://url/for/foo||bar|https://url/for/bar</code></li>
</ul>
<p>下述方式用于获取信任域对应的 X.509 CA 证书链（可以有多层级）。该方法接收 <code>foo|URL1||bar|URL2</code> 格式的参数，用 <code>||</code> 分隔切片，第一个参数为 trust domain，第二个参数为 CA 服务器 URL。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// RetrieveSpiffeBundleRootCertsFromStringInput 从 SPIFFE bundle 中检索可信的 CA 证书。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 它可以使用系统证书和提供的证书来进行验证。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 格式如下：
</span></span></span><span class="line"><span class="cl"><span class="c1">// &#34;foo|URL1||bar|URL2||baz|URL3...&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">RetrieveSpiffeBundleRootCertsFromStringInput</span><span class="p">(</span><span class="nx">inputString</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">extraTrustedCerts</span> <span class="p">[]</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">)</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spiffeLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Processing SPIFFE bundle configuration: %v&#34;</span><span class="p">,</span> <span class="nx">inputString</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tuples</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">inputString</span><span class="p">,</span> <span class="s">&#34;||&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tuple</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tuples</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">items</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">tuple</span><span class="p">,</span> <span class="s">&#34;|&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;config is invalid: %v. Expected &lt;trustdomain&gt;|&lt;url&gt;&#34;</span><span class="p">,</span> <span class="nx">tuple</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">trustDomain</span> <span class="o">:=</span> <span class="nx">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">endpoint</span> <span class="o">:=</span> <span class="nx">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">config</span><span class="p">[</span><span class="nx">trustDomain</span><span class="p">]</span> <span class="p">=</span> <span class="nx">endpoint</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用 CA 服务器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">RetrieveSpiffeBundleRootCerts</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">extraTrustedCerts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>外部服务器返回 JWK 格式的数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pkg/spiffe/spiffe.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 返回的 JSON 结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">bundleDoc</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">jose</span><span class="p">.</span><span class="nx">JSONWebKeySet</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Sequence</span>    <span class="kt">uint64</span> <span class="s">`json:&#34;spiffe_sequence,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RefreshHint</span> <span class="kt">int</span>    <span class="s">`json:&#34;spiffe_refresh_hint,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// JSONWebKey represents a public or private key in JWK format.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">JSONWebKey</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Cryptographic key, can be a symmetric or asymmetric key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Key</span> <span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Key identifier, parsed from `kid` header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">KeyID</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Key algorithm, parsed from `alg` header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Algorithm</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Key use, parsed from `use` header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Use</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// X.509 certificate chain, parsed from `x5c` header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Certificates</span> <span class="p">[]</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// X.509 certificate URL, parsed from `x5u` header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">CertificatesURL</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// X.509 certificate thumbprint (SHA-1), parsed from `x5t` header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">CertificateThumbprintSHA1</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// X.509 certificate thumbprint (SHA-256), parsed from `x5t#S256` header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">CertificateThumbprintSHA256</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>实际的数据示例如下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;spiffe_sequence&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;spiffe_refresh_hint&#34;</span><span class="p">:</span> <span class="mi">450000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;keys&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;kty&#34;</span><span class="p">:</span> <span class="s">&#34;RSA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;use&#34;</span><span class="p">:</span> <span class="s">&#34;x509-svid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;n&#34;</span><span class="p">:</span> <span class="s">&#34;&lt;证书签名&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;e&#34;</span><span class="p">:</span> <span class="s">&#34;AQAB&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;x5c&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#34;&lt;X.509 证书&gt;&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="2-私有-pki">2. 私有 PKI</h2>
<p>Istio 内部有一套内置的 PKI 证书基础设施。零信任架构中，PKI 是零信任模型身份认证的基石，大多数零信任网络都采用 PKI 来证明身份的真实性。零信任网络颁发的证书数量可能会很多，因此非常有必要对证书进行自动化管理。<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>
<h3 id="21-istiod-配置">2.1. Istiod 配置</h3>
<p>Istiod 默认启用内置的 CA 服务器。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/features/pilot.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">EnableCAServer</span> <span class="p">=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">RegisterBoolVar</span><span class="p">(</span><span class="s">&#34;ENABLE_CA_SERVER&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;If this is set to false, will not create CA server in istiod.&#34;</span><span class="p">).</span><span class="nf">Get</span><span class="p">()</span>
</span></span></code></pre></div><p>证书签名的默认配置项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/bootstrap/istio_ca.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 兼容挂载名为 cacerts 的 secret
</span></span></span><span class="line"><span class="cl"><span class="c1">// 但已经不使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 使用 &#34;istio-ca-secret&#34; 来创建证书
</span></span></span><span class="line"><span class="cl"><span class="c1">// 兼容旧版本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 挂载名为 cacerts 的 secret 的目录，Read-only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">LocalCertDir</span> <span class="p">=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">RegisterStringVar</span><span class="p">(</span><span class="s">&#34;ROOT_CA_DIR&#34;</span><span class="p">,</span> <span class="s">&#34;./etc/cacerts&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;Location of a local or mounted CA root&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 默认服务证书 TTL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">workloadCertTTL</span> <span class="p">=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">RegisterDurationVar</span><span class="p">(</span><span class="s">&#34;DEFAULT_WORKLOAD_CERT_TTL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cmd</span><span class="p">.</span><span class="nx">DefaultWorkloadCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;The default TTL of issued workload certificates. Applied when the client sets a &#34;</span><span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;non-positive TTL in the CSR.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">maxWorkloadCertTTL</span> <span class="p">=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">RegisterDurationVar</span><span class="p">(</span><span class="s">&#34;MAX_WORKLOAD_CERT_TTL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cmd</span><span class="p">.</span><span class="nx">DefaultMaxWorkloadCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;The max TTL of issued workload certificates.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 自签名 CA 证书 TTL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">SelfSignedCACertTTL</span> <span class="p">=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">RegisterDurationVar</span><span class="p">(</span><span class="s">&#34;CITADEL_SELF_SIGNED_CA_CERT_TTL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cmd</span><span class="p">.</span><span class="nx">DefaultSelfSignedCACertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;The TTL of self-signed CA root certificate.&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Istio 主程序会挂载两个 Secert，一个是 <em>cacerts</em> Secret，用于指定 Istio 启动时用户定义的 CA 证书，另一个是 <em>istio-ca-secret</em> Secret，用于储存 Istio Pilot Discovery 程序自签名的 CA 证书及其私钥。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// CA 证书不应该在 Workload 证书失效之前就失效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 所以此处设置证书的生命周期为证书链中的最短的时效期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">defaultCertTTL</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ca</span><span class="p">.</span><span class="nf">minTTL</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">DefaultCertTTL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ca</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get default cert TTL %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ca</span><span class="p">.</span><span class="nx">defaultCertTTL</span> <span class="p">=</span> <span class="nx">defaultCertTTL</span>
</span></span></code></pre></div><p>CA 证书不应该在 Workload 证书失效之前就失效，所以此处设置 Workload 证书的生命周期为 CA 证书链中的最短的时效期。</p>
<p>Istio CA 实际挂载的 <em>istio-ca-secret</em> Secret 数据示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ca-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ca-cert.pem</span><span class="p">:</span><span class="w"> </span><span class="l">&gt;-</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvRENDQWVTZ0F3SUJBZ0lRQWVMc3E2ZDVFN0ZheVY2U...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ca-key.pem</span><span class="p">:</span><span class="w"> </span><span class="l">&gt;-LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBd2JpOWtucHVPS1d6SUxkM...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cert-chain.pem</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">key.pem</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">root-cert.pem</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">istio.io/ca-root</span><span class="w">
</span></span></span></code></pre></div><h3 id="22-初始化">2.2. 初始化</h3>
<h4 id="221-入口流程">2.2.1. 入口流程</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/bootstrap/server.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// maybeCreateCA creates and initializes CA Key if needed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">maybeCreateCA</span><span class="p">(</span><span class="nx">caOpts</span> <span class="o">*</span><span class="nx">caOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 默认启用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">EnableCA</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;creating CA and initializing public key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">corev1</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">CoreV1Interface</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">kubeClient</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">corev1</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 从远程 K8S 集群获取证书，默认不启用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">useRemoteCerts</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">loadRemoteCACerts</span><span class="p">(</span><span class="nx">caOpts</span><span class="p">,</span> <span class="nx">LocalCertDir</span><span class="p">.</span><span class="nf">Get</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to load remote CA certs: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Issue #27606 If External CA is configured, use that to sign DNS Certs as well. IstioCA need not be initialized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">CA</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">createIstioCA</span><span class="p">(</span><span class="nx">corev1</span><span class="p">,</span> <span class="nx">caOpts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create CA: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">initPublicKey</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error initializing public key: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>s.createIstioCA</code> 里面详细进行 CA 初始化的操作。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/bootstrap/istio_ca.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// createIstioCA initializes the Istio CA signing functionality.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">createIstioCA</span><span class="p">(</span><span class="nx">client</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">CoreV1Interface</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">caOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ca</span><span class="p">.</span><span class="nx">IstioCA</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">caOpts</span> <span class="o">*</span><span class="nx">ca</span><span class="p">.</span><span class="nx">IstioCAOptions</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// In pods, this is the optional &#39;cacerts&#39; Secret.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO: also check for key.pem ( for interop )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">signingKeyFile</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">LocalCertDir</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="s">&#34;ca-key.pem&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If not found, will default to ca-cert.pem. May contain multiple roots.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rootCertFile</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">LocalCertDir</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="s">&#34;root-cert.pem&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">rootCertFile</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 兼容 Istio 获取 Root cert 证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// In Citadel, normal self-signed doesn&#39;t use a root-cert.pem file for additional roots.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// In Istiod, it is possible to provide one via &#34;cacerts&#34; secret in both cases, for consistency.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">rootCertFile</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">signingKeyFile</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">client</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 在 K8S 集群中创建自签名证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// The user-provided certs are missing - create a self-signed cert.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Use self-signed certificate as the CA certificate&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Abort after 20 minutes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取证书操作符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// rootCertFile will be added to &#34;ca-cert.pem&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// readSigningCertOnly set to false - it doesn&#39;t seem to be used in Citadel, nor do we have a way
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// to set it only for one job.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">caOpts</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ca</span><span class="p">.</span><span class="nf">NewSelfSignedIstioCAOptions</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">selfSignedRootCertGracePeriodPercentile</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="nx">SelfSignedCACertTTL</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">selfSignedRootCertCheckInterval</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="nx">workloadCertTTL</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxWorkloadCertTTL</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TrustDomain</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">opts</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">rootCertFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">enableJitterForRootCertRotator</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="nx">caRSAKeySize</span><span class="p">.</span><span class="nf">Get</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create a self-signed istiod CA: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">istioCA</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ca</span><span class="p">.</span><span class="nf">NewIstioCA</span><span class="p">(</span><span class="nx">caOpts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create an istiod CA: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">istioCA</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">rootCertRotatorChan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">istioCA</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>数据操作流程：</p>
<ol>
<li>
<p>首先读取 Kubernetes 中“cacerts”的 secret 挂载的本地目录。</p>
</li>
<li>
<p>若不存在则通过 go-client 获取 K8S 中 &ldquo;istio-ca-cert&rdquo; 的 secret，该 secret 包含 CA 的私钥及证书。</p>
</li>
<li>
<p>K8s 中没有 CA 证书，则开始自签名证书流程。</p>
</li>
</ol>
<h4 id="222-自签名-ca-证书">2.2.2. 自签名 CA 证书</h4>
<p>签发与获取证书相关参数配置对照表如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>DefaultSelfSignedCACertTTL</td>
<td>3650 * 24 * time.Hour</td>
<td>自签名 Root 证书默认的 TTL</td>
</tr>
<tr>
<td>DefaultSelfSignedRootCertCheckInterval</td>
<td>1 * time.Hour</td>
<td>自签名证书定期检查证书有效期或进行证书轮换检查的默认间隔时间</td>
</tr>
<tr>
<td>DefaultRootCertGracePeriodPercentile</td>
<td>20</td>
<td>根证书平滑轮换证书的有效时长百分比，相对于证书的有效周期（TTL）</td>
</tr>
<tr>
<td>ReadSigningCertRetryInterval</td>
<td>time.Second * 5</td>
<td>读取证书与私钥失败的重试间隔时间</td>
</tr>
<tr>
<td>ReadSigningCertRetryMax</td>
<td>time.Second * 30</td>
<td>读取证书与私钥失败的最大重试次数</td>
</tr>
<tr>
<td>DefaultMaxWorkloadCertTTL</td>
<td>90 * 24 * time.Hour</td>
<td>签发工作负载证书的默认最长的 TTL</td>
</tr>
<tr>
<td>DefaultWorkloadCertTTL</td>
<td>24 * time.Hour</td>
<td>签发工作负载证书的默认的 TTL</td>
</tr>
</tbody>
</table>
<p>Istio 是具体是如何使用 Go 官方包自签名一个 CA 证书的？
主要流程为：</p>
<ol>
<li>创建 RSA 私钥（Istio 还不支持 ECDSA 私钥）</li>
<li>构建 CSR（Certificate signing request）模板</li>
<li>填充 SPIFFE ID 到 CSR 的扩展字段（ASN.1）</li>
<li>自签名 CSR 生成证书</li>
<li>创建 Kubernetes Secret 资源储存 CA 证书和私钥</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/pki/ca/ca.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// K8S 集群内自签名证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSelfSignedIstioCAOptions</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rootCertGracePeriodPercentile</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">caCertTTL</span><span class="p">,</span> <span class="nx">rootCertCheckInverval</span><span class="p">,</span> <span class="nx">defaultCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxCertTTL</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">org</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">dualUse</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">readCertRetryInterval</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">client</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">CoreV1Interface</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rootCertFile</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">enableJitter</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">caRSAKeySize</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">caOpts</span> <span class="o">*</span><span class="nx">IstioCAOptions</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果证书不存在则创建证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 后续读取 secret 获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 获取 K8S istio-ca-secret secret 资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">caSecret</span><span class="p">,</span> <span class="nx">scrtErr</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Secrets</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">CASecret</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取 secret 失败，尝试多次重新获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 若超时仍然获取不到，则创建自签名证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">scrtErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">readCertRetryInterval</span> <span class="p">&gt;</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pkiCaLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Citadel in signing key/cert read only mode. Wait until secret %s:%s can be loaded...&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">CASecret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">readCertRetryInterval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">scrtErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">caSecret</span><span class="p">,</span> <span class="nx">scrtErr</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Secrets</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">CASecret</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{});</span> <span class="nx">scrtErr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">pkiCaLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Citadel successfully loaded the secret.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">caOpts</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">IstioCAOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CAType</span><span class="p">:</span>         <span class="nx">selfSignedCA</span><span class="p">,</span> <span class="c1">// 1 自签名证书 2 用户自定义证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">DefaultCertTTL</span><span class="p">:</span> <span class="nx">defaultCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">MaxCertTTL</span><span class="p">:</span>     <span class="nx">maxCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// CA 轮转检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">RotatorConfig</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">SelfSignedCARootCertRotatorConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">CheckInterval</span><span class="p">:</span>      <span class="nx">rootCertCheckInverval</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">caCertTTL</span><span class="p">:</span>          <span class="nx">caCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">retryInterval</span><span class="p">:</span>      <span class="nx">cmd</span><span class="p">.</span><span class="nx">ReadSigningCertRetryInterval</span><span class="p">,</span> <span class="c1">// 默认 5 秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">retryMax</span><span class="p">:</span>           <span class="nx">cmd</span><span class="p">.</span><span class="nx">ReadSigningCertRetryMax</span><span class="p">,</span> <span class="c1">// 默认 30 秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">certInspector</span><span class="p">:</span>      <span class="nx">certutil</span><span class="p">.</span><span class="nf">NewCertUtil</span><span class="p">(</span><span class="nx">rootCertGracePeriodPercentile</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">caStorageNamespace</span><span class="p">:</span> <span class="nx">namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">dualUse</span><span class="p">:</span>            <span class="nx">dualUse</span><span class="p">,</span> <span class="c1">// 默认 true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">org</span><span class="p">:</span>                <span class="nx">org</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rootCertFile</span><span class="p">:</span>       <span class="nx">rootCertFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">enableJitter</span><span class="p">:</span>       <span class="nx">enableJitter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">client</span><span class="p">:</span>             <span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取不到 secret，自签名创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">scrtErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pkiCaLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Failed to get secret (error: %s), will create one&#34;</span><span class="p">,</span> <span class="nx">scrtErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">options</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">CertOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">TTL</span><span class="p">:</span>          <span class="nx">caCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Org</span><span class="p">:</span>          <span class="nx">org</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">IsCA</span><span class="p">:</span>         <span class="kc">true</span><span class="p">,</span> <span class="c1">// 证书标识为 CA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">IsSelfSigned</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">RSAKeySize</span><span class="p">:</span>   <span class="nx">caRSAKeySize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Whether this certificate is for dual-use clients (SAN+CN).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">IsDualUse</span><span class="p">:</span>    <span class="nx">dualUse</span><span class="p">,</span> <span class="c1">// 这个选项其实没有用到
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pemCert</span><span class="p">,</span> <span class="nx">pemKey</span><span class="p">,</span> <span class="nx">ckErr</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">GenCertKeyFromOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ckErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to generate CA cert and key for self-signed CA (%v)&#34;</span><span class="p">,</span> <span class="nx">ckErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取 RootCertFile 加入根证书链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">rootCerts</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">AppendRootCerts</span><span class="p">(</span><span class="nx">pemCert</span><span class="p">,</span> <span class="nx">rootCertFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to append root certificates (%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 构建储存证书链的并发安全的数据结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">caOpts</span><span class="p">.</span><span class="nx">KeyCertBundle</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">NewVerifiedKeyCertBundleFromPem</span><span class="p">(</span><span class="nx">pemCert</span><span class="p">,</span> <span class="nx">pemKey</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">rootCerts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create CA KeyCertBundle (%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 在 K8S 中创建 secret 储存证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Write the key/cert back to secret so they will be persistent when CA restarts.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">secret</span> <span class="o">:=</span> <span class="nx">k8ssecret</span><span class="p">.</span><span class="nf">BuildSecret</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">CASecret</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">pemCert</span><span class="p">,</span> <span class="nx">pemKey</span><span class="p">,</span> <span class="nx">istioCASecretType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Secrets</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">secret</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 从本地读取 CA 证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 返回证书操作符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">caOpts</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认使用 RSA 2048 size 生成私钥：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/pki/util/generate_cert.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// GenCertKeyFromOptions generates a X.509 certificate and a private key with the given options.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GenCertKeyFromOptions</span><span class="p">(</span><span class="nx">options</span> <span class="nx">CertOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">pemCert</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">pemKey</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 默认忽略，使用 RSA 算法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ECSigAlg</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 生成 RSA 密钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rsaPriv</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rsa</span><span class="p">.</span><span class="nf">GenerateKey</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">RSAKeySize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 生成证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">genCert</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">rsaPriv</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rsaPriv</span><span class="p">.</span><span class="nx">PublicKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>创建一个证书模板，随后会从模板创建 CSR：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/pki/util/generate_cert.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// genCertTemplateFromoptions generates a certificate template with the given options.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">genCertTemplateFromOptions</span><span class="p">(</span><span class="nx">options</span> <span class="nx">CertOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">keyUsage</span> <span class="nx">x509</span><span class="p">.</span><span class="nx">KeyUsage</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">IsCA</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If the cert is a CA cert, the private key is allowed to sign other certificates.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">x509</span><span class="p">.</span><span class="nx">KeyUsageCertSign</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Otherwise the private key is allowed for digital signature and key encipherment.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">x509</span><span class="p">.</span><span class="nx">KeyUsageDigitalSignature</span> <span class="p">|</span> <span class="nx">x509</span><span class="p">.</span><span class="nx">KeyUsageKeyEncipherment</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">subject</span> <span class="o">:=</span> <span class="nx">pkix</span><span class="p">.</span><span class="nx">Name</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Organization</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">options</span><span class="p">.</span><span class="nx">Org</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 填充扩展字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">exts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">pkix</span><span class="p">.</span><span class="nx">Extension</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Host</span><span class="p">;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 生成 SAN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">BuildSubjectAltNameExtension</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">IsDualUse</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 获取 common name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">cn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">DualUseCommonName</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">subject</span><span class="p">.</span><span class="nx">CommonName</span> <span class="p">=</span> <span class="nx">cn</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">exts</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">pkix</span><span class="p">.</span><span class="nx">Extension</span><span class="p">{</span><span class="o">*</span><span class="nx">s</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">SerialNumber</span><span class="p">:</span>          <span class="nx">serialNum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Subject</span><span class="p">:</span>               <span class="nx">subject</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NotBefore</span><span class="p">:</span>             <span class="nx">notBefore</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NotAfter</span><span class="p">:</span>              <span class="nx">notBefore</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">TTL</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">KeyUsage</span><span class="p">:</span>              <span class="nx">keyUsage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ExtKeyUsage</span><span class="p">:</span>           <span class="nx">extKeyUsages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">IsCA</span><span class="p">:</span>                  <span class="nx">options</span><span class="p">.</span><span class="nx">IsCA</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">BasicConstraintsValid</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ExtraExtensions</span><span class="p">:</span>       <span class="nx">exts</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>注入 SPIFFE 工作负载身份标识：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/pki/util/san.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// BuildSubjectAltNameExtension builds the SAN extension for the certificate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">BuildSubjectAltNameExtension</span><span class="p">(</span><span class="nx">hosts</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pkix</span><span class="p">.</span><span class="nx">Extension</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ids</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Identity</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">host</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">hosts</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ip</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="nx">host</span><span class="p">);</span> <span class="nx">ip</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Use the 4-byte representation of the IP address when possible.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">eip</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nf">To4</span><span class="p">();</span> <span class="nx">eip</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">ip</span> <span class="p">=</span> <span class="nx">eip</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ids</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">Identity</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">TypeIP</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">ip</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">spiffe</span><span class="p">.</span><span class="nx">URIPrefix</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ids</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">Identity</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">TypeURI</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">host</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ids</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">Identity</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">TypeDNS</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">host</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">san</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">BuildSANExtension</span><span class="p">(</span><span class="nx">ids</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;SAN extension building failure (%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">san</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BuildSANExtension builds a `pkix.Extension` of type &#34;Subject
</span></span></span><span class="line"><span class="cl"><span class="c1">// Alternative Name&#34; based on the given identities.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">BuildSANExtension</span><span class="p">(</span><span class="nx">identites</span> <span class="p">[]</span><span class="nx">Identity</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pkix</span><span class="p">.</span><span class="nx">Extension</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果 subject 的信息仅存在于 subjectAltName 扩展中(仅于Email地址或URI相关)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 则 subject name 必须为非空结构且 subjectAltName 扩展必须为 critical。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// SAN is Critical because the subject is empty. This is compliant with X.509 and SPIFFE standards.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">pkix</span><span class="p">.</span><span class="nx">Extension</span><span class="p">{</span><span class="nx">Id</span><span class="p">:</span> <span class="nx">oidSubjectAlternativeName</span><span class="p">,</span> <span class="nx">Critical</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bs</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>SPIFFE ID 储存在 X.509 证书的 SAN URI 字段中。</p>
<h4 id="223-储存证书">2.2.3. 储存证书</h4>
<p>Istiod 的 CA 证书同时也会储存到本地一份。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Save the root public key file and initialize the path the the file, to be used by other components.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">initPublicKey</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Setup the root cert chain and caBundlePath - before calling initDNSListener.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">features</span><span class="p">.</span><span class="nx">PilotCertProvider</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="o">==</span> <span class="nx">IstiodCAProvider</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">signingKeyFile</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">LocalCertDir</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="s">&#34;ca-key.pem&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">signingKeyFile</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// When Citadel is configured to use self-signed certs, keep a local copy so other
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// components can load it via file (e.g. webhook config controller).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">dnsCertDir</span><span class="p">,</span> <span class="mo">0700</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We have direct access to the self-signed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">internalSelfSignedRootPath</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">dnsCertDir</span><span class="p">,</span> <span class="s">&#34;self-signed-root.pem&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">rootCert</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">CA</span><span class="p">.</span><span class="nf">GetCAKeyCertBundle</span><span class="p">().</span><span class="nf">GetRootCertPem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">internalSelfSignedRootPath</span><span class="p">,</span> <span class="nx">rootCert</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="nx">s</span><span class="p">.</span><span class="nx">caBundlePath</span> <span class="p">=</span> <span class="nx">internalSelfSignedRootPath</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>储存到本地目的是为了让各个独立的组件（虽然合并到 Istiod 程序中）都读取到 CA 证书。
同时还会监听文件系统的变化，及时替换证书。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// initCertificateWatches sets up  watches for the certs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">initCertificateWatches</span><span class="p">(</span><span class="nx">tlsOptions</span> <span class="nx">TLSOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// load the cert/key and setup a persistent watch for updates.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="23-ca-证书轮换">2.3. CA 证书轮换</h3>
<p>CA 证书轮换的代码位于 <code>security/pkg/pki/ca/selfsignedcarootcertrotator.go</code> 文件中。</p>
<p>该模块定期检查 CA 证书有效性，比对 Kubernetes 的 Secret 资源中的 CA 证书与内存中储存的 CA 证书是否一致。
若证书即将过期，则使用私钥重新签名，以颁发新的可用的 CA 证书。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// NewSelfSignedCARootCertRotator returns a new root cert rotator instance that
</span></span></span><span class="line"><span class="cl"><span class="c1">// rotates self-signed root cert periodically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSelfSignedCARootCertRotator</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">SelfSignedCARootCertRotatorConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ca</span> <span class="o">*</span><span class="nx">IstioCA</span><span class="p">)</span> <span class="o">*</span><span class="nx">SelfSignedCARootCertRotator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rotator</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">SelfSignedCARootCertRotator</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">caSecretController</span><span class="p">:</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">NewCaSecretController</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">client</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">config</span><span class="p">:</span>             <span class="nx">config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ca</span><span class="p">:</span>                 <span class="nx">ca</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">rotator</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>该证书轮换器带有指数退避算法，以更优雅地定期错误重试。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run refreshes root certs and updates config map accordingly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rotator</span> <span class="o">*</span><span class="nx">SelfSignedCARootCertRotator</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">CheckInterval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Check and rotate root cert.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rotator</span><span class="p">.</span><span class="nf">checkAndRotateRootCert</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>checkAndRotateRootCert</code> 函数定时被执行，以确认证书的有效性指标。
<em>Citadel</em> 是 Istio 中专门负责认证相关的组件，虽然合并到 Istiod 中，
在代码中它还是被单独归类。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// checkAndRotateRootCert decides whether root cert should be refreshed, and rotates
</span></span></span><span class="line"><span class="cl"><span class="c1">// root cert for self-signed Citadel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rotator</span> <span class="o">*</span><span class="nx">SelfSignedCARootCertRotator</span><span class="p">)</span> <span class="nf">checkAndRotateRootCert</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 带失败重试获取 CA 证书的 K8s secret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">caSecret</span><span class="p">,</span> <span class="nx">scrtErr</span> <span class="o">:=</span> <span class="nx">rotator</span><span class="p">.</span><span class="nx">caSecretController</span><span class="p">.</span><span class="nf">LoadCASecretWithRetry</span><span class="p">(</span><span class="nx">CASecret</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">caStorageNamespace</span><span class="p">,</span> <span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">retryInterval</span><span class="p">,</span> <span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">retryMax</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">scrtErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rotator</span><span class="p">.</span><span class="nf">checkAndRotateRootCertForSigningCertCitadel</span><span class="p">(</span><span class="nx">caSecret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// checkAndRotateRootCertForSigningCertCitadel checks root cert secret and rotates
</span></span></span><span class="line"><span class="cl"><span class="c1">// root cert if the current one is about to expire. The rotation uses existing
</span></span></span><span class="line"><span class="cl"><span class="c1">// root private key to generate a new root cert, and updates root cert secret.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rotator</span> <span class="o">*</span><span class="nx">SelfSignedCARootCertRotator</span><span class="p">)</span> <span class="nf">checkAndRotateRootCertForSigningCertCitadel</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">caSecret</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Check root certificate expiration time in CA secret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">waitTime</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">certInspector</span><span class="p">.</span><span class="nf">GetWaitTime</span><span class="p">(</span><span class="nx">caSecret</span><span class="p">.</span><span class="nx">Data</span><span class="p">[</span><span class="nx">caCertID</span><span class="p">],</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">waitTime</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Root cert is not about to expire, skipping root cert rotation.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">caCertInMem</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">rotator</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nf">GetCAKeyCertBundle</span><span class="p">().</span><span class="nf">GetAllPem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 比较内存中的证书与 K8S 中的证书是否一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// If CA certificate is different from the CA certificate in local key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// cert bundle, it implies that other Citadels have updated istio-ca-secret.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Reload root certificate into key cert bundle.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">caCertInMem</span><span class="p">,</span> <span class="nx">caSecret</span><span class="p">.</span><span class="nx">Data</span><span class="p">[</span><span class="nx">caCertID</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 校验证书并将证书加载到内存中缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rotator</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nf">GetCAKeyCertBundle</span><span class="p">().</span><span class="nf">VerifyAndSetAll</span><span class="p">(</span><span class="nx">caSecret</span><span class="p">.</span><span class="nx">Data</span><span class="p">[</span><span class="nx">caCertID</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="nx">caSecret</span><span class="p">.</span><span class="nx">Data</span><span class="p">[</span><span class="nx">caPrivateKeyID</span><span class="p">],</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">rootCerts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to reload root cert into KeyCertBundle (%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Successfully reloaded root cert into KeyCertBundle.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Refresh root certificate, root cert is about to expire: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">options</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">CertOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">TTL</span><span class="p">:</span>           <span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">caCertTTL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">SignerPrivPem</span><span class="p">:</span> <span class="nx">caSecret</span><span class="p">.</span><span class="nx">Data</span><span class="p">[</span><span class="nx">caPrivateKeyID</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Org</span><span class="p">:</span>           <span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">IsCA</span><span class="p">:</span>          <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">IsSelfSigned</span><span class="p">:</span>  <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RSAKeySize</span><span class="p">:</span>    <span class="nx">rotator</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nx">caRSAKeySize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">IsDualUse</span><span class="p">:</span>     <span class="nx">rotator</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">dualUse</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// options should be consistent with the one used in NewSelfSignedIstioCAOptions().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is to make sure when rotate the root cert, we don&#39;t make unnecessary changes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to the certificate or add extra fields to the certificate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">options</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">MergeCertOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">oldCertOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 重新签发证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pemCert</span><span class="p">,</span> <span class="nx">pemKey</span><span class="p">,</span> <span class="nx">ckErr</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">GenRootCertFromExistingKey</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">ckErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to generate CA cert and key for self-signed CA: %s&#34;</span><span class="p">,</span> <span class="nx">ckErr</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 K8S 及内存中更新证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">rollback</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rotator</span><span class="p">.</span><span class="nf">updateRootCertificate</span><span class="p">(</span><span class="nx">caSecret</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">pemCert</span><span class="p">,</span> <span class="nx">pemKey</span><span class="p">,</span> <span class="nx">pemRootCerts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// caSecret is out-of-date. Need to load the latest istio-ca-secret to roll back root certificate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rotator</span><span class="p">.</span><span class="nf">updateRootCertificate</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">oldCaCert</span><span class="p">,</span> <span class="nx">oldCaPrivateKey</span><span class="p">,</span> <span class="nx">oldRootCerts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to roll backward root certificate (error: %s).&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rootCertRotatorLog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Root certificate rotation is completed successfully.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>同时证书更新替换时也有失败回滚机制，CA 证书轮换后 Istio 会更新 Kubernetes 中 Secret 资源，以及内存中缓存的证书资源。
这类证书轮换函数，运行在独立的协程中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ca</span> <span class="o">*</span><span class="nx">IstioCA</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopChan</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">ca</span><span class="p">.</span><span class="nx">rootCertRotator</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Start root cert rotator in a separate goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">go</span> <span class="nx">ca</span><span class="p">.</span><span class="nx">rootCertRotator</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stopChan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="24-签发-workload-证书">2.4. 签发 Workload 证书</h3>
<p>以上部分是 Istio 如何签发 CA 与轮换 CA 证书，因为证书都是在同一个进程中签发与替换，不涉及额外的网络操作，
相对流程比较清晰。Workload 证书签发是由独立运行的工作负载的 Pod 中的 Agent 进程向 Kubernetes 进行认证后，
发送 CSR 请求给 Istio CA 服务器进行签名的。它还拥有一套特殊的通信协议。</p>
<h4 id="241-启动-ca-服务器">2.4.1. 启动 CA 服务器</h4>
<p>Istiod 启动 CA 服务器，响应工作负载签发符合自身权限身份的 CSR 请求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// StartCA starts the CA or RA server if configured.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">startCA</span><span class="p">(</span><span class="nx">caOpts</span> <span class="o">*</span><span class="nx">caOptions</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">s</span><span class="p">.</span><span class="nf">addStartFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">stop</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">grpcServer</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">secureGrpcServer</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">secureGrpcServer</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">grpcServer</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">grpcServer</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Start the RA server if configured, else start the CA server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">RA</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">CA</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Starting IstioD CA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">s</span><span class="p">.</span><span class="nf">RunCA</span><span class="p">(</span><span class="nx">grpcServer</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">CA</span><span class="p">,</span> <span class="nx">caOpts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">   <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>CA 服务器的接口注册在 grpc 服务器上，注意这里开启了 TLS，通信协议是 grpcs。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 在 GRPCS 服务器上开启 CA
</span></span></span><span class="line"><span class="cl"><span class="c1">// RunCA will start the cert signing GRPC service on an existing server.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Protected by installer options: the CA will be started only if the JWT token in /var/run/secrets
</span></span></span><span class="line"><span class="cl"><span class="c1">// is mounted. If it is missing - for example old versions of K8S that don&#39;t support such tokens -
</span></span></span><span class="line"><span class="cl"><span class="c1">// we will not start the cert-signing server, since pods will have no way to authenticate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">RunCA</span><span class="p">(</span><span class="nx">grpc</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="nx">ca</span> <span class="nx">caserver</span><span class="p">.</span><span class="nx">CertificateAuthority</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">caOptions</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">iss</span> <span class="o">:=</span> <span class="nx">trustedIssuer</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="c1">// 默认为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aud</span> <span class="o">:=</span> <span class="nx">audience</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="c1">// 默认为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 填充 iss 和 aud
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 默认获取 K8S SA Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &#34;/var/run/secrets/kubernetes.io/serviceaccount/token&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">jwtPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取 JWT Payload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">tok</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">detectAuthEnv</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;Starting with invalid K8S JWT token&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">iss</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">iss</span> <span class="p">=</span> <span class="nx">tok</span><span class="p">.</span><span class="nx">Iss</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">tok</span><span class="p">.</span><span class="nx">Aud</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">aud</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">aud</span> <span class="p">=</span> <span class="nx">tok</span><span class="p">.</span><span class="nx">Aud</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The CA API uses cert with the max workload cert TTL.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &#39;hostlist&#39; must be non-empty - but is not used since a grpc server is passed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Adds client cert auth and kube (sds enabled)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 创建给 Workload 颁发证书的 CA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">caServer</span><span class="p">,</span> <span class="nx">startErr</span> <span class="o">:=</span> <span class="nx">caserver</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">ca</span><span class="p">,</span> <span class="nx">maxWorkloadCertTTL</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Authenticators</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">startErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to create istio ca server: %v&#34;</span><span class="p">,</span> <span class="nx">startErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 注册 GRPC PB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">caServer</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">grpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Istiod CA has started&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Kubernetes Serivce Account Token 包含的 Payload 数据示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;kubernetes/serviceaccount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kubernetes.io/serviceaccount/namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;istio-system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kubernetes.io/serviceaccount/secret.name&#34;</span><span class="p">:</span> <span class="s2">&#34;istio-reader-service-account-token-zmks5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kubernetes.io/serviceaccount/service-account.name&#34;</span><span class="p">:</span> <span class="s2">&#34;istio-reader-service-account&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kubernetes.io/serviceaccount/service-account.uid&#34;</span><span class="p">:</span> <span class="s2">&#34;9a544d83-ed88-474f-967c-27473357ee95&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;system:serviceaccount:istio-system:istio-reader-service-account&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认配置中，签发给 Workload 的证书的有效期是 90 天。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/server/ca/server.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// Register registers a GRPC server on the specified port.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">grpcServer</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterIstioCertificateServiceServer</span><span class="p">(</span><span class="nx">grpcServer</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// istio.io\api@v0.0.0-20201125194658-3cee6a1d3ab4\security\v1alpha1\ca.pb.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// IstioCertificateServiceServer is the server API for IstioCertificateService service.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">IstioCertificateServiceServer</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Using provided CSR, returns a signed certificate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CreateCertificate</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">IstioCertificateRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">IstioCertificateResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>CA 服务器的 grpc 接口只有一个 <code>CreateCertificate</code> 方法，调用该方法处理 CSR 请求。</p>
<h4 id="242-签发证书">2.4.2. 签发证书</h4>
<p>通过 grpcs 协议接收到 CSR 请求时，首先会进行认证：</p>
<p>Istio 支持多种方式进行认证，例如客户端证书、K8s JWT、ID Token 等，Istio 认证方法中会尝试从多个认证源进行认证，
选择出能够验证客户端身份的一种方式，当然认证失败就失败了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// authenticate goes through a list of authenticators (provided client cert, k8s jwt, and ID token)
</span></span></span><span class="line"><span class="cl"><span class="c1">// and authenticates if one of them is valid.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="o">*</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">Caller</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: apply different authenticators in specific order / according to configuration.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">errMsg</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">authn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Authenticators</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">authn</span><span class="p">.</span><span class="nf">Authenticate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">serverCaLog</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;Authentication failed for %v: %s&#34;</span><span class="p">,</span> <span class="nf">getConnectionAddress</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span> <span class="nx">errMsg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>具体处理 CSR 创建证书的接口逻辑：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// CreateCertificate handles an incoming certificate signing request (CSR). It does
</span></span></span><span class="line"><span class="cl"><span class="c1">// authentication and authorization. Upon validated, signs a certificate that:
</span></span></span><span class="line"><span class="cl"><span class="c1">// the SAN is the identity of the caller in authentication result.
</span></span></span><span class="line"><span class="cl"><span class="c1">// the subject public key is the public key in the CSR.
</span></span></span><span class="line"><span class="cl"><span class="c1">// the validity duration is the ValidityDuration in request, or default value if the given duration is invalid.
</span></span></span><span class="line"><span class="cl"><span class="c1">// it is signed by the CA signing key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">CreateCertificate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateRequest</span><span class="p">)</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// metrics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">.</span><span class="nx">CSR</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从 GRPC CTX 获取 TLS Info 里面的 SPIFFE ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">caller</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">caller</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 缺少 TLS Info 的客户端证书的 SAN URI 字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">s</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">.</span><span class="nx">AuthnError</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unauthenticated</span><span class="p">,</span> <span class="s">&#34;request authenticate failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: Call authorizer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">certChainBytes</span><span class="p">,</span> <span class="nx">rootCertBytes</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nf">GetCAKeyCertBundle</span><span class="p">().</span><span class="nf">GetAll</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 签发证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cert</span><span class="p">,</span> <span class="nx">signErr</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Csr</span><span class="p">),</span> <span class="nx">caller</span><span class="p">.</span><span class="nx">Identities</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">ValidityDuration</span><span class="p">)</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">respCertChain</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nb">string</span><span class="p">(</span><span class="nx">cert</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">certChainBytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 加入证书链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">respCertChain</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">respCertChain</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">certChainBytes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">respCertChain</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">respCertChain</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">rootCertBytes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">response</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CertChain</span><span class="p">:</span> <span class="nx">respCertChain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">.</span><span class="nx">Success</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">serverCaLog</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;CSR successfully signed.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">response</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="25-ra注册机构">2.5. RA（注册机构）</h3>
<blockquote>
<p>Istio 带有现成的证书颁发机构（CA），但不少用户也希望能够接入现有 CA。
在之前的版本中，您需要实现 Istio CSR  API 并自行编写第三方集成。
在 Istio 1.8 中，我们引入了一种使用 Kubernetes CSR  API 的新方法，此方法可与任何能够使用此API的工具相集成。
Istiod 将充当注册机构（RA）角色，负责对工作负载进行身份验证及授权，而后创建、批准并监控 CSR 资源的更新。
接下来，第三方工具（例如cert-manager）即可使用正确的签名程序创建具有适当后端 CA 的签名证书。
此功能目前尚处于试验阶段。<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/bootstrap/server.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">maybeCreateCA</span><span class="p">(</span><span class="nx">caOpts</span> <span class="o">*</span><span class="nx">caOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">EnableCA</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">caOpts</span><span class="p">.</span><span class="nx">ExternalCAType</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">RA</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">createIstioRA</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">caOpts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create RA: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>如果配置了自定义 CA，则启用 RA 功能。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/bootstrap/istio_ca.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// createIstioRA initializes the Istio RA signing functionality.
</span></span></span><span class="line"><span class="cl"><span class="c1">// the caOptions defines the external provider
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">createIstioRA</span><span class="p">(</span><span class="nx">client</span> <span class="nx">kubelib</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nx">opts</span> <span class="o">*</span><span class="nx">caOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">ra</span><span class="p">.</span><span class="nx">RegistrationAuthority</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">caCertFile</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">ra</span><span class="p">.</span><span class="nx">DefaultExtCACertDir</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">CACertNamespaceConfigMapDataName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">caCertFile</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">caCertFile</span> <span class="p">=</span> <span class="nx">defaultCACertPath</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">raOpts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ra</span><span class="p">.</span><span class="nx">IstioRAOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ExternalCAType</span><span class="p">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ExternalCAType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">DefaultCertTTL</span><span class="p">:</span> <span class="nx">workloadCertTTL</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">MaxCertTTL</span><span class="p">:</span>     <span class="nx">maxWorkloadCertTTL</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">CaSigner</span><span class="p">:</span>       <span class="nx">opts</span><span class="p">.</span><span class="nx">ExternalCASigner</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">CaCertFile</span><span class="p">:</span>     <span class="nx">caCertFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">VerifyAppendCA</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">K8sClient</span><span class="p">:</span>      <span class="nx">client</span><span class="p">.</span><span class="nf">CertificatesV1beta1</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">ra</span><span class="p">.</span><span class="nf">NewIstioRA</span><span class="p">(</span><span class="nx">raOpts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// security/pkg/pki/ra/common.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// NewIstioRA is a factory method that returns an RA that implements the RegistrationAuthority functionality.
</span></span></span><span class="line"><span class="cl"><span class="c1">// the caOptions defines the external provider
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewIstioRA</span><span class="p">(</span><span class="nx">opts</span> <span class="o">*</span><span class="nx">IstioRAOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">RegistrationAuthority</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ExternalCAType</span> <span class="o">==</span> <span class="nx">ExtCAK8s</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">istioRA</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewKubernetesRA</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create an K8s CA: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">istioRA</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid CA Name %s&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ExternalCAType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>看上去 RA 类型现在只支持 Kubernetes 一种。</p>
<p>RA 默认不启用，同时处于试验阶段，这里不加以分析。</p>
<h2 id="3-通信安全">3. 通信安全</h2>
<p>加密和认证通常是紧密相关的，在零信任流量安全中，
对于客户端/服务器的交互，使用双向认证的 TLS 协议是一种的合理的网络安全方案，
这种方案通常包括配置客户端并将客户端证书提供给服务器端访问代理，以确保连接经过认证和授权<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>。</p>
<h3 id="31-加密与认证">3.1. 加密与认证</h3>
<h4 id="311-tls-验证">3.1.1. TLS 验证</h4>
<p>初始化服务端的 TLS 的校验方式。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/bootstrap/server.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">GetCertificate</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">getIstiodCertificate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ClientAuth</span><span class="p">:</span>     <span class="nx">tls</span><span class="p">.</span><span class="nx">VerifyClientCertIfGiven</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ClientCAs</span><span class="p">:</span>      <span class="nx">s</span><span class="p">.</span><span class="nx">peerCertVerifier</span><span class="p">.</span><span class="nf">GetGeneralCertPool</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">VerifyPeerCertificate</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">rawCerts</span> <span class="p">[][]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">verifiedChains</span> <span class="p">[][]</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 使用 SPIFFE 包校验 TLS 证书有效性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">peerCertVerifier</span><span class="p">.</span><span class="nf">VerifyPeerCert</span><span class="p">(</span><span class="nx">rawCerts</span><span class="p">,</span> <span class="nx">verifiedChains</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Could not verify certificate: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>ClientAuth 有五种类型，各自的含义是：</p>
<ul>
<li>
<p>NoClientCert：忽略任何客户端证书，即客户端可以不提供证书。</p>
</li>
<li>
<p>RequestClientCer：要求客户端提供证书，但是如果客户端没有提供证书，服务端还是会继续处理请求。</p>
</li>
<li>
<p>RequireAnyClientCert：需要客户端提供证书，但不用ClientCA来验证证书的有效性。</p>
</li>
<li>
<p>VerifyClientCertIfGiven：如果客户端提供了证书，则用ClientCA来验证证书的有效性。 如果客户端没提供，则会继续处理请求。</p>
</li>
<li>
<p>RequireAndVerifyClientCert：需要客户端提供证书，且会用ClientCA来验证证书的有效性。</p>
</li>
</ul>
<p>在 tlsConfig 中如果不显式的指定 ClientAuth，则默认值是 NoClientCert。即使 Server 端配置了 CA，也不会校验客户端证书。</p>
<h4 id="312-身份认证">3.1.2. 身份认证</h4>
<p>配置服务端对客户端进行身份认证的方式，默认启用客户端证书，以及 K8s JWT。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"> <span class="c1">// pilot/pkg/bootstrap/server.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">     <span class="c1">// Notice that the order of authenticators matters, since at runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">// authenticators are activated sequentially and the first successful attempt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">// is used as the authentication result.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">// The JWT authenticator requires the multicluster registry to be initialized, so we build this later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">authenticators</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">Authenticator</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="o">&amp;</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">ClientCertAuthenticator</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">         <span class="nx">kubeauth</span><span class="p">.</span><span class="nf">NewKubeJWTAuthenticator</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">clusterID</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">multicluster</span><span class="p">.</span><span class="nx">GetRemoteKubeClient</span><span class="p">,</span> <span class="nx">spiffe</span><span class="p">.</span><span class="nf">GetTrustDomain</span><span class="p">(),</span> <span class="nx">features</span><span class="p">.</span><span class="nx">JwtPolicy</span><span class="p">.</span><span class="nf">Get</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">     <span class="c1">// 默认启用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">caOpts</span><span class="p">.</span><span class="nx">Authenticators</span> <span class="p">=</span> <span class="nx">authenticators</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">features</span><span class="p">.</span><span class="nx">XDSAuth</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">s</span><span class="p">.</span><span class="nx">XDSServer</span><span class="p">.</span><span class="nx">Authenticators</span> <span class="p">=</span> <span class="nx">authenticators</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span></code></pre></div><p>无论是 grpcs，还是 grpc 协议都会启用强认证。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/server/ca/authenticate/model.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Caller carries the identity and authentication source of a caller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Caller</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">AuthSource</span> <span class="nx">AuthSource</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Identities</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Authenticator</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Authenticate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Caller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">AuthenticatorType</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>实现了 Authenticator 接口的认证器调用 Authenticate 方法从 grpc 请求的上下文 Metadata 字段中获取 Caller 信息，校验失败则返回错误。</p>
<h5 id="客户端证书认证">客户端证书认证</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/server/ca/authenticate/cert_authenticator.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ClientCertAuthenticator extracts identities from client certificate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ClientCertAuthenticator</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">_</span> <span class="nx">Authenticator</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">ClientCertAuthenticator</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cca</span> <span class="o">*</span><span class="nx">ClientCertAuthenticator</span><span class="p">)</span> <span class="nf">AuthenticatorType</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ClientCertAuthenticatorType</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Authenticate extracts identities from presented client certificates. This
</span></span></span><span class="line"><span class="cl"><span class="c1">// method assumes that certificate chain has been properly validated before
</span></span></span><span class="line"><span class="cl"><span class="c1">// this method is called. In other words, this method does not do certificate
</span></span></span><span class="line"><span class="cl"><span class="c1">// chain validation itself.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cca</span> <span class="o">*</span><span class="nx">ClientCertAuthenticator</span><span class="p">)</span> <span class="nf">Authenticate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Caller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从 GRPC 连接获取 peer 信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">peer</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">peer</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">AuthInfo</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no client certificate is presented&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 连接必须为 TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">authType</span> <span class="o">:=</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">AuthInfo</span><span class="p">.</span><span class="nf">AuthType</span><span class="p">();</span> <span class="nx">authType</span> <span class="o">!=</span> <span class="s">&#34;tls&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unsupported auth type: %q&#34;</span><span class="p">,</span> <span class="nx">authType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">tlsInfo</span> <span class="o">:=</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">AuthInfo</span><span class="p">.(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">TLSInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chains</span> <span class="o">:=</span> <span class="nx">tlsInfo</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nx">VerifiedChains</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">chains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no verified chain is found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ids</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">ExtractIDs</span><span class="p">(</span><span class="nx">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">Extensions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Caller</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">AuthSource</span><span class="p">:</span> <span class="nx">AuthSourceClientCertificate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Identities</span><span class="p">:</span> <span class="nx">ids</span><span class="p">,</span> <span class="c1">// id 应该就是 SPIFFE ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>grpc TLS 包会在 TLS 握手阶段获取 SPIFFIE ID：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// grpc@v1.33.1\credentials\tls.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// TLSInfo contains the auth information for a TLS authenticated connection.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It implements the AuthInfo interface.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">TLSInfo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">State</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">ConnectionState</span>
</span></span><span class="line"><span class="cl">    <span class="nx">CommonAuthInfo</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This API is experimental.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">SPIFFEID</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">tlsCreds</span><span class="p">)</span> <span class="nf">ServerHandshake</span><span class="p">(</span><span class="nx">rawConn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">AuthInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">conn</span> <span class="o">:=</span> <span class="nx">tls</span><span class="p">.</span><span class="nf">Server</span><span class="p">(</span><span class="nx">rawConn</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">Handshake</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tlsInfo</span> <span class="o">:=</span> <span class="nx">TLSInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">State</span><span class="p">:</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">ConnectionState</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CommonAuthInfo</span><span class="p">:</span> <span class="nx">CommonAuthInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">SecurityLevel</span><span class="p">:</span> <span class="nx">PrivacyAndIntegrity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span> <span class="o">:=</span> <span class="nx">credinternal</span><span class="p">.</span><span class="nf">SPIFFEIDFromState</span><span class="p">(</span><span class="nx">conn</span><span class="p">.</span><span class="nf">ConnectionState</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">id</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tlsInfo</span><span class="p">.</span><span class="nx">SPIFFEID</span> <span class="p">=</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">credinternal</span><span class="p">.</span><span class="nf">WrapSyscallConn</span><span class="p">(</span><span class="nx">rawConn</span><span class="p">,</span> <span class="nx">conn</span><span class="p">),</span> <span class="nx">tlsInfo</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// grpc@v1.33.1\internal\credentials\spiffe.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// SPIFFEIDFromState parses the SPIFFE ID from State. If the SPIFFE ID format
</span></span></span><span class="line"><span class="cl"><span class="c1">// is invalid, return nil with warning.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">SPIFFEIDFromState</span><span class="p">(</span><span class="nx">state</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">ConnectionState</span><span class="p">)</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">PeerCertificates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">PeerCertificates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">URIs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">spiffeID</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">uri</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">state</span><span class="p">.</span><span class="nx">PeerCertificates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">URIs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">uri</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">Scheme</span> <span class="o">!=</span> <span class="s">&#34;spiffe&#34;</span> <span class="o">||</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">Opaque</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">User</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nf">Username</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// From this point, we assume the uri is intended for a SPIFFE ID.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span> <span class="p">&gt;</span> <span class="mi">2048</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">logger</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;invalid SPIFFE ID: total ID length larger than 2048 bytes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">Host</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">RawPath</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">logger</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;invalid SPIFFE ID: domain or workload ID is empty&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">Host</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">255</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">logger</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;invalid SPIFFE ID: domain length larger than 255 characters&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// A valid SPIFFE certificate can only have exactly one URI SAN field.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">PeerCertificates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">URIs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">logger</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;invalid SPIFFE ID: multiple URI SANs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">spiffeID</span> <span class="p">=</span> <span class="nx">uri</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">spiffeID</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="k8s-jwt-认证">K8s JWT 认证</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/server/ca/authenticate/kubeauth/kube_jwt.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// KubeJWTAuthenticator authenticates K8s JWTs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">KubeJWTAuthenticator</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">trustDomain</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">jwtPolicy</span>   <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Primary cluster kube client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kubeClient</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Primary cluster ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">clusterID</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// remote cluster kubeClient getter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">remoteKubeClientGetter</span> <span class="nx">RemoteKubeClientGetter</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">_</span> <span class="nx">authenticate</span><span class="p">.</span><span class="nx">Authenticator</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">KubeJWTAuthenticator</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Authenticate authenticates the call using the K8s JWT from the context.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The returned Caller.Identities is in SPIFFE format.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">KubeJWTAuthenticator</span><span class="p">)</span> <span class="nf">Authenticate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">Caller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从 HTTP Authenticate 字段获取 JWT Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">targetJWT</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">authenticate</span><span class="p">.</span><span class="nf">ExtractBearerToken</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">clusterID</span> <span class="o">:=</span> <span class="nf">extractClusterID</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">id</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">kubeClient</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">GetKubeClient</span><span class="p">(</span><span class="nx">clusterID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tokenreview</span><span class="p">.</span><span class="nf">ValidateK8sJwt</span><span class="p">(</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">targetJWT</span><span class="p">,</span> <span class="nx">aud</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">callerNamespace</span> <span class="o">:=</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">callerServiceAccount</span> <span class="o">:=</span> <span class="nx">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">Caller</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">AuthSource</span><span class="p">:</span> <span class="nx">authenticate</span><span class="p">.</span><span class="nx">AuthSourceIDToken</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Identities</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">IdentityTemplate</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trustDomain</span><span class="p">,</span> <span class="nx">callerNamespace</span><span class="p">,</span> <span class="nx">callerServiceAccount</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>从 grpc 通信 Metadata 中获取 JWT Token，与 K8s API Server 通信认证 Token：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ValidateK8sJwt</span><span class="p">(</span><span class="nx">kubeClient</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">targetToken</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">aud</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tokenReview</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">k8sauth</span><span class="p">.</span><span class="nx">TokenReview</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Spec</span><span class="p">:</span> <span class="nx">k8sauth</span><span class="p">.</span><span class="nx">TokenReviewSpec</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Token</span><span class="p">:</span> <span class="nx">targetToken</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reviewRes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubeClient</span><span class="p">.</span><span class="nf">AuthenticationV1</span><span class="p">().</span><span class="nf">TokenReviews</span><span class="p">().</span><span class="nf">Create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">tokenReview</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">getTokenReviewResult</span><span class="p">(</span><span class="nx">reviewRes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>从代码注释中可以看到请求和返回的示例数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// An example SA token:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// {&#34;alg&#34;:&#34;RS256&#34;,&#34;typ&#34;:&#34;JWT&#34;}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// {&#34;iss&#34;:&#34;kubernetes/serviceaccount&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  &#34;kubernetes.io/serviceaccount/namespace&#34;:&#34;default&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  &#34;kubernetes.io/serviceaccount/secret.name&#34;:&#34;example-pod-sa-token-h4jqx&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  &#34;kubernetes.io/serviceaccount/service-account.name&#34;:&#34;example-pod-sa&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  &#34;kubernetes.io/serviceaccount/service-account.uid&#34;:&#34;ff578a9e-65d3-11e8-aad2-42010a8a001d&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  &#34;sub&#34;:&#34;system:serviceaccount:default:example-pod-sa&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// An example token review status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &#34;status&#34;:{
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   &#34;authenticated&#34;:true,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   &#34;user&#34;:{
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     &#34;username&#34;:&#34;system:serviceaccount:default:example-pod-sa&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     &#34;uid&#34;:&#34;ff578a9e-65d3-11e8-aad2-42010a8a001d&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     &#34;groups&#34;:[&#34;system:serviceaccounts&#34;,&#34;system:serviceaccounts:default&#34;,&#34;system:authenticated&#34;]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span></code></pre></div><h3 id="32-xds-通信协议">3.2. xDS 通信协议</h3>
<p>SDS 协议是 xDS 协议的一类，在 Istio 中，SDS 用于传输证书数据。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/istio-zero-trust-source-code-reading/graph-xds_hudb10d8661330ab79b815c890d02eb51d_14875_42d92212171dfc7b0fb286a38514f49b.webp 400w,
               /blog/istio-zero-trust-source-code-reading/graph-xds_hudb10d8661330ab79b815c890d02eb51d_14875_288eb580243321c4ed8036adebb8a933.webp 760w,
               /blog/istio-zero-trust-source-code-reading/graph-xds_hudb10d8661330ab79b815c890d02eb51d_14875_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-zero-trust-source-code-reading/graph-xds_hudb10d8661330ab79b815c890d02eb51d_14875_42d92212171dfc7b0fb286a38514f49b.webp"
               width="760"
               height="177"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p><em>pilot-agent</em> 原本叫 Node Agent，负责转发 Envoy 的 SDS 请求，以及负责生成 CSR 请求到 discovery。</p>
<p>为了避免混淆，注明镜像名：</p>
<ul>
<li>pilot-agent: <code>istio/proxyv2:1.8.0</code> 中的 <code>pilot-agent proxy sidecar</code></li>
<li>discovery: <code>istio/pilot:1.8.0</code></li>
</ul>
<h4 id="321-server">3.2.1. Server</h4>
<h5 id="事件广播">事件广播</h5>
<p>Discovery 初始化 SDS 服务器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// initSDSServer starts the SDS server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">initSDSServer</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">PilotArgs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">kubeClient</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">features</span><span class="p">.</span><span class="nx">EnableXDSIdentityCheck</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Make sure we have security
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">log</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;skipping Kubernetes credential reader; PILOT_ENABLE_XDS_IDENTITY_CHECK must be set to true for this feature.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 启用 XDS Namespace 认证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 默认是 istio-system Namespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 监听 K8S Secrets 变化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">sc</span> <span class="o">:=</span> <span class="nx">kubesecrets</span><span class="p">.</span><span class="nf">NewMulticluster</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">clusterID</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">RegistryOptions</span><span class="p">.</span><span class="nx">ClusterRegistriesNamespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sc</span><span class="p">.</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">s</span><span class="p">.</span><span class="nx">XDSServer</span><span class="p">.</span><span class="nf">ConfigUpdate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">model</span><span class="p">.</span><span class="nx">PushRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Full</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">ConfigsUpdated</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">ConfigKey</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}{</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">Kind</span><span class="p">:</span>      <span class="nx">gvk</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">Name</span><span class="p">:</span>      <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Reason</span><span class="p">:</span> <span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">TriggerReason</span><span class="p">{</span><span class="nx">model</span><span class="p">.</span><span class="nx">SecretTrigger</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// XDS Generator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">s</span><span class="p">.</span><span class="nx">XDSServer</span><span class="p">.</span><span class="nx">Generators</span><span class="p">[</span><span class="nx">v3</span><span class="p">.</span><span class="nx">SecretType</span><span class="p">]</span> <span class="p">=</span> <span class="nx">xds</span><span class="p">.</span><span class="nf">NewSecretGen</span><span class="p">(</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">XDSServer</span><span class="p">.</span><span class="nx">Cache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>SecretController</code> 会监视 K8s 集群中特殊类型（Istio 多集群）的 Secret 资源变化，并通过 xDS 广播：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pkg/kube/secretcontroller/secretcontroller.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">secretsInformer</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">NewSharedIndexInformer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ListFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">meta_v1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 限定 Label 为 &#34;istio/multiCluster=true&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">opts</span><span class="p">.</span><span class="nx">LabelSelector</span> <span class="p">=</span> <span class="nx">MultiClusterSecretLabel</span> <span class="o">+</span> <span class="s">&#34;=true&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">kubeclientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Secrets</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">WatchFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">meta_v1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">opts</span><span class="p">.</span><span class="nx">LabelSelector</span> <span class="p">=</span> <span class="nx">MultiClusterSecretLabel</span> <span class="o">+</span> <span class="s">&#34;=true&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">kubeclientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Secrets</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">{},</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Indexers</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><h5 id="gateway-证书">Gateway 证书</h5>
<p><code>Generate</code> 方法仅仅在 pilot-agent 类型为 router（即 Gateway）的时候生成 Envoy 使用的证书返回。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot/pkg/xds/sds.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 与 Node Agent 也就是 Istio Proxy 进行通信返回的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">SecretGen</span><span class="p">)</span> <span class="nf">Generate</span><span class="p">(</span><span class="nx">proxy</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Proxy</span><span class="p">,</span> <span class="nx">_</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">PushContext</span><span class="p">,</span> <span class="nx">w</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">WatchedResource</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">PushRequest</span><span class="p">)</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Resources</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 调用 K8S API Server 确认身份 SA 是否有权限访问 secrets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">Authorize</span><span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">VerifiedIdentity</span><span class="p">.</span><span class="nx">ServiceAccount</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">VerifiedIdentity</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">adsLog</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;proxy %v is not authorized to receive secrets: %v&#34;</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 如果不是 gateway 则返回 nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">req</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nf">needsUpdate</span><span class="p">(</span><span class="nx">proxy</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ConfigsUpdated</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="kd">var</span> <span class="nx">updatedSecrets</span> <span class="kd">map</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">ConfigKey</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">Full</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">updatedSecrets</span> <span class="p">=</span> <span class="nx">model</span><span class="p">.</span><span class="nf">ConfigsOfKind</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ConfigsUpdated</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">.</span><span class="nx">Secret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">results</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Resources</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">resource</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">w</span><span class="p">.</span><span class="nx">ResourceNames</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="nx">isCAOnlySecret</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">sr</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">GatewaySdsCaSuffix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">isCAOnlySecret</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">secret</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">GetCaCert</span><span class="p">(</span><span class="nx">sr</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">sr</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">secret</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">res</span> <span class="o">:=</span> <span class="nf">toEnvoyCaSecret</span><span class="p">(</span><span class="nx">sr</span><span class="p">.</span><span class="nx">ResourceName</span><span class="p">,</span> <span class="nx">secret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">s</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sr</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">adsLog</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;failed to fetch ca certificate for %v&#34;</span><span class="p">,</span> <span class="nx">sr</span><span class="p">.</span><span class="nx">ResourceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 生成密钥和证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">key</span><span class="p">,</span> <span class="nx">cert</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">GetKeyAndCert</span><span class="p">(</span><span class="nx">sr</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">sr</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">key</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">cert</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">res</span> <span class="o">:=</span> <span class="nf">toEnvoyKeyCertSecret</span><span class="p">(</span><span class="nx">sr</span><span class="p">.</span><span class="nx">ResourceName</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">cert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">s</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sr</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">adsLog</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;failed to fetch key and certificate for %v&#34;</span><span class="p">,</span> <span class="nx">sr</span><span class="p">.</span><span class="nx">ResourceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">results</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="322-client">3.2.2. Client</h4>
<h5 id="初始化-sds">初始化 SDS</h5>
<p>配置项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pilot-agent 更新证书周期是 24 小时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">secretTTLEnv</span> <span class="p">=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">RegisterDurationVar</span><span class="p">(</span><span class="s">&#34;SECRET_TTL&#34;</span><span class="p">,</span> <span class="mi">24</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;The cert lifetime requested by istio agent&#34;</span><span class="p">).</span><span class="nf">Get</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pkg/istio-agent/agent.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">sa</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">isSidecar</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">podNamespace</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">sds</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 本地进程证书缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO: remove the caching, workload has a single cert
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">WorkloadSecrets</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sa</span><span class="p">.</span><span class="nx">WorkloadSecrets</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">sa</span><span class="p">.</span><span class="nf">newWorkloadSecretCache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sds</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">sa</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">,</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">WorkloadSecrets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Start the local XDS generator.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">localXDSGenerator</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">sa</span><span class="p">.</span><span class="nf">startXDSGenerator</span><span class="p">(</span><span class="nx">sa</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">,</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">WorkloadSecrets</span><span class="p">,</span> <span class="nx">podNamespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start local xds generator: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sa</span><span class="p">.</span><span class="nf">initLocalDNSServer</span><span class="p">(</span><span class="nx">isSidecar</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start local DNS server: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyXDSViaAgent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sa</span><span class="p">.</span><span class="nx">xdsProxy</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">initXdsProxy</span><span class="p">(</span><span class="nx">sa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start xds proxy: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">server</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>此部分有异常多旧代码以及 TODO，推测是原来架构有 DaemonSet 部署的 Node Agent，目前架构中去除了，Node Agent 的工作由 pilot-agent 完成，只处理自身容器内 Envoy 的请求，自然不需要多复杂的缓存机制。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/nodeagent/sds/server.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// NewServer creates and starts the Grpc server for SDS.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewServer</span><span class="p">(</span><span class="nx">options</span> <span class="o">*</span><span class="nx">ca2</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">workloadSecretCache</span> <span class="nx">ca2</span><span class="p">.</span><span class="nx">SecretManager</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">workloadSds</span><span class="p">:</span> <span class="nf">newSDSService</span><span class="p">(</span><span class="nx">workloadSecretCache</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">FileMountedCerts</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">EnableWorkloadSDS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">initWorkloadSdsService</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to initialize secret discovery service for workload proxies: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">initWorkloadSdsService</span><span class="p">(</span><span class="nx">options</span> <span class="o">*</span><span class="nx">ca2</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="c1">//nolint: unparam
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">GrpcServer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadServer</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">GrpcServer</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nx">workloadSds</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadServer</span> <span class="p">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nf">grpcServerOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">workloadSds</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Unix Domain Socket SDS 通信
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadListener</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">uds</span><span class="p">.</span><span class="nf">NewListener</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">WorkloadUDSPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to set up UDS path: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Start SDS grpc server&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这里可以看到本地监听 UDS，与 Envoy 通信。</p>
<h5 id="构建-csr">构建 CSR</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pkg/istio-agent/agent.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 获取 Istio CA 的证书，挂载的 Configmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">caCertFile</span> <span class="o">:=</span> <span class="nx">sa</span><span class="p">.</span><span class="nf">FindRootCAForCA</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// 与 Istio CA 建立连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">caClient</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">citadel</span><span class="p">.</span><span class="nf">NewCitadelClient</span><span class="p">(</span><span class="nx">sa</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CAEndpoint</span><span class="p">,</span> <span class="nx">tls</span><span class="p">,</span> <span class="nx">rootCert</span><span class="p">,</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">ClusterID</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/nodeagent/cache/secretcache.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// GenerateSecret generates new secret and cache the secret, this function is called by SDS.StreamSecrets
</span></span></span><span class="line"><span class="cl"><span class="c1">// and SDS.FetchSecret. Since credential passing from client may change, regenerate secret every time
</span></span></span><span class="line"><span class="cl"><span class="c1">// instead of reading from cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">SecretCache</span><span class="p">)</span> <span class="nf">GenerateSecret</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">connectionID</span><span class="p">,</span> <span class="nx">resourceName</span><span class="p">,</span> <span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">SecretItem</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// First try to generate secret from file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">sdsFromFile</span><span class="p">,</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">generateFileSecret</span><span class="p">(</span><span class="nx">connKey</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">ns</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">SecretCache</span><span class="p">)</span> <span class="nf">generateSecret</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">token</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">connKey</span> <span class="nx">ConnKey</span><span class="p">,</span> <span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">SecretItem</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构建 SPIFFE SAN 字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">csrHostName</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">spiffe</span><span class="p">.</span><span class="nx">Identity</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">TrustDomain</span><span class="p">:</span>    <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">TrustDomain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Namespace</span><span class="p">:</span>      <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">WorkloadNamespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ServiceAccount</span><span class="p">:</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">ServiceAccount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 构建 CSR 参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">options</span> <span class="o">:=</span> <span class="nx">pkiutil</span><span class="p">.</span><span class="nx">CertOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Host</span><span class="p">:</span>       <span class="nx">csrHostName</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RSAKeySize</span><span class="p">:</span> <span class="nx">keySize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PKCS8Key</span><span class="p">:</span>   <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">Pkcs8Keys</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ECSigAlg</span><span class="p">:</span>   <span class="nx">pkiutil</span><span class="p">.</span><span class="nf">SupportedECSignatureAlgorithms</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">ECCSigAlg</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Generate the cert/key, send CSR to CA.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">csrPEM</span><span class="p">,</span> <span class="nx">keyPEM</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pkiutil</span><span class="p">.</span><span class="nf">GenCSR</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用 Istio CA 发送 CSR 请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">certChainPEM</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">sendRetriableRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">csrPEM</span><span class="p">,</span> <span class="nx">exchangedToken</span><span class="p">,</span> <span class="nx">connKey</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>流程：</p>
<ol>
<li>检查/创建私钥</li>
<li>构建 CSR（CSR 的 Host 是 SAN URI，即 SPIFFE ID）</li>
<li>请求 Istio CA</li>
</ol>
<h5 id="证书轮换">证书轮换</h5>
<p>两种情况：</p>
<ol>
<li>Workload 证书定期更新</li>
<li>CA 证书改变</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/nodeagent/cache/secretcache.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">SecretCache</span><span class="p">)</span> <span class="nf">shouldRotate</span><span class="p">(</span><span class="nx">secret</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">SecretItem</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// secret should be rotated before it expired.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">secretLifeTime</span> <span class="o">:=</span> <span class="nx">secret</span><span class="p">.</span><span class="nx">ExpireTime</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">secret</span><span class="p">.</span><span class="nx">CreatedTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gracePeriod</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">SecretRotationGracePeriodRatio</span> <span class="o">*</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">secretLifeTime</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rotate</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">After</span><span class="p">(</span><span class="nx">secret</span><span class="p">.</span><span class="nx">ExpireTime</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="o">-</span><span class="nx">gracePeriod</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Secret %s: lifetime: %v, graceperiod: %v, expiration: %v, should rotate: %v&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">secret</span><span class="p">.</span><span class="nx">ResourceName</span><span class="p">,</span> <span class="nx">secretLifeTime</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">,</span> <span class="nx">secret</span><span class="p">.</span><span class="nx">ExpireTime</span><span class="p">,</span> <span class="nx">rotate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">rotate</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认 Workload 证书 24 小时轮换。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/nodeagent/cache/secretcache.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">SecretCache</span><span class="p">)</span> <span class="nf">addFileWatcher</span><span class="p">(</span><span class="nx">file</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">token</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">connKey</span> <span class="nx">ConnKey</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">certWatcher</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">timerC</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timerC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">timerC</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// TODO(ramaraochavali): Remove the watchers for unused keys and certs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">sc</span><span class="p">.</span><span class="nx">certMutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="nx">connKeys</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">fileCerts</span><span class="p">[</span><span class="nx">npath</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="nx">sc</span><span class="p">.</span><span class="nx">certMutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Update all connections that use this file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">for</span> <span class="nx">ckey</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">connKeys</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">secrets</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">ckey</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Regenerate the Secret and trigger the callback that pushes the secrets to proxy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// 重新生成证书
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nx">sc</span><span class="p">.</span><span class="nf">generateFileSecret</span><span class="p">(</span><span class="nx">ckey</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>监听根证书文件的变化：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// security/pkg/nodeagent/cache/secretcache.go        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sitem</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">generateRootCertFromExistingFile</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">existingRootCertFile</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">connKey</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sc</span><span class="p">.</span><span class="nf">addFileWatcher</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">existingRootCertFile</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">connKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></div><p>附 Istio 证书体系相关流程图<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup>：</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/istio-zero-trust-source-code-reading/cert-flow_hu93fe9fecc6c4193568f170aafe022871_273732_c45e568ff7827f9f4dd46fd6c242cd39.webp 400w,
               /blog/istio-zero-trust-source-code-reading/cert-flow_hu93fe9fecc6c4193568f170aafe022871_273732_d14a04f27664cc8ea35593f92c8dfc54.webp 760w,
               /blog/istio-zero-trust-source-code-reading/cert-flow_hu93fe9fecc6c4193568f170aafe022871_273732_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-zero-trust-source-code-reading/cert-flow_hu93fe9fecc6c4193568f170aafe022871_273732_c45e568ff7827f9f4dd46fd6c242cd39.webp"
               width="735"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>摘自《零信任网络 : 在不可信网络中构建安全系统》第 6 章—建立用户信任&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://istio.io/latest/docs/concepts/security/#secure-naming" target="_blank" rel="noopener">Istio / Security - Secure naming</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://github.com/spiffe/spiffe/blob/main/standards/SPIFFE.md#1-introduction" target="_blank" rel="noopener">Secure Production Identity Framework for Everyone (SPIFFE) - 1. Introduction</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://developer.aliyun.com/article/740195" target="_blank" rel="noopener">Kubernetes 下零信任安全架构分析 - 蚂蚁零信任架构体系落地最佳实践</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>摘自《零信任网络 : 在不可信网络中构建安全系统》第 2 章—信任管理&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p><a href="https://istio.io/latest/news/releases/1.8.x/announcing-1.8/" target="_blank" rel="noopener">Announcing Istio 1.8</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p>摘自《零信任网络 : 在不可信网络中构建安全系统》第 8 章—建立流量信任&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p><a href="https://blog.csdn.net/yevvzi/article/details/107863433" target="_blank" rel="noopener">Istio 证书签发流程</a>&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a>
  
  <a class="badge badge-light" href="/tag/%E9%9B%B6%E4%BF%A1%E4%BB%BB/">零信任</a>
  
  <a class="badge badge-light" href="/tag/istio/">Istio</a>
  
  <a class="badge badge-light" href="/tag/envoy/">envoy</a>
  
  <a class="badge badge-light" href="/tag/%E5%AE%89%E5%85%A8/">安全</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/mayo-cream/"><img class="avatar mr-3 avatar-circle" src="/author/mayo-cream/avatar_hue38add62c87b7486d80c9f3fda25dfc1_12220_270x270_fill_q75_lanczos_center.jpg" alt="Mayo Cream"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/mayo-cream/">Mayo Cream</a></p>
      
      
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/how-ebpf-streamlines-the-service-mesh/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>eBPF 如何简化服务网格</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/apisix-source-code-reading/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>云原生网关 APISIX 核心流程源码分析与进化方向思考</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/istio-zero-trust-source-code-reading/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/validating-a-request-payload-with-wasm/">使用 WebAssembly 验证请求负载</a></li>
      
      <li><a href="/blog/istiocon-layer7-traffic/">使用 Aeraki 在 Isito 中支持 Dubbo、Thrift、Redis，以及任何七层协议</a></li>
      
      <li><a href="/blog/redis-cluster-with-istio/">在 Istio 中实现 Redis 集群的数据分片、读写分离和流量镜像</a></li>
      
      <li><a href="/blog/envoy-wasm/">Istio 进阶学习系列 - 基于 WebAssembly 实现 Envoy 与 Istio 的功能扩展</a></li>
      
      <li><a href="/blog/redefining-extensibility-in-proxies/">重新定义代理的扩展性：WebAssembly在Envoy与Istio中的应用</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2023 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
