<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="本文分析了 Kong 的启动流程、插件机制、缓存机制和请求的生命周期。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/kong-source-code-reading/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.008259417e6adf8980695ebbbb46553f.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/kong-source-code-reading/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/kong-source-code-reading/" />
  <meta property="og:title" content="云原生网关 Kong 源码分析 | 云原生社区（中国）" />
  <meta property="og:description" content="本文分析了 Kong 的启动流程、插件机制、缓存机制和请求的生命周期。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2021-10-21T12:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2024-03-06T17:22:12&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/kong-source-code-reading/"
  },
  "headline": "云原生网关 Kong 源码分析",
  
  "datePublished": "2021-10-21T12:00:00+08:00",
  "dateModified": "2024-03-06T17:22:12+08:00",
  
  "author": {
    "@type": "Person",
    "name": "Mayo Cream"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "本文分析了 Kong 的启动流程、插件机制、缓存机制和请求的生命周期。"
}
</script>

  

  

  

  





  <title>云原生网关 Kong 源码分析 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>小组</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/k8s-gateway-api"><span>Kubernetes Gateway API SIG</span></a>
              
            </div>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>云原生网关 Kong 源码分析</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/mayo-cream/">Mayo Cream</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/%E4%BA%91%E5%8E%9F%E7%94%9F/" class="text-capitalize">云原生</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2021-10-21
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 12924
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 59 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-概述">1. 概述</a></li>
    <li><a href="#2-配置文件">2. 配置文件</a></li>
    <li><a href="#3-初始化">3. 初始化</a>
      <ul>
        <li><a href="#31-数据库初始化">3.1. 数据库初始化</a></li>
        <li><a href="#32-缓存构建">3.2. 缓存构建</a></li>
        <li><a href="#33-事件订阅">3.3. 事件订阅</a></li>
      </ul>
    </li>
    <li><a href="#4-事件分发">4. 事件分发</a>
      <ul>
        <li><a href="#41-单次任务">4.1. 单次任务</a></li>
        <li><a href="#42-定时任务">4.2. 定时任务</a></li>
      </ul>
    </li>
    <li><a href="#5-事件处理">5. 事件处理</a>
      <ul>
        <li><a href="#51-数据库事件">5.1. 数据库事件</a></li>
      </ul>
    </li>
    <li><a href="#6-插件加载">6. 插件加载</a>
      <ul>
        <li><a href="#61-插件读取">6.1. 插件读取</a></li>
        <li><a href="#62-插件调用">6.2. 插件调用</a></li>
      </ul>
    </li>
    <li><a href="#7-缓存机制">7. 缓存机制</a></li>
    <li><a href="#8-请求生命周期">8. 请求生命周期</a>
      <ul>
        <li><a href="#81-ssl_certificate_by_lua-阶段">8.1. ssl_certificate_by_lua 阶段</a></li>
        <li><a href="#82-rewrite_by_lua-阶段">8.2. rewrite_by_lua 阶段</a></li>
        <li><a href="#83-access_by_lua-阶段">8.3. access_by_lua 阶段</a></li>
        <li><a href="#84-balancer_by_lua-阶段">8.4. balancer_by_lua 阶段</a></li>
        <li><a href="#85-header_filter_by_lua-阶段">8.5. header_filter_by_lua 阶段</a></li>
        <li><a href="#86-body_filter_by_lua-阶段">8.6. body_filter_by_lua 阶段</a></li>
        <li><a href="#87-log_by_lua-阶段">8.7. log_by_lua 阶段</a></li>
      </ul>
    </li>
    <li><a href="#9-admin-api">9. Admin API</a></li>
    <li><a href="#10-插件开发">10. 插件开发</a>
      <ul>
        <li><a href="#101-多层-schema-嵌套">10.1. 多层 Schema 嵌套</a></li>
        <li><a href="#102-自定义-schema-校验器">10.2. 自定义 Schema 校验器</a></li>
        <li><a href="#103-日志打印-table">10.3. 日志打印 Table</a></li>
        <li><a href="#104-自定义日志输出">10.4. 自定义日志输出</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-概述">1. 概述</a></li>
    <li><a href="#2-配置文件">2. 配置文件</a></li>
    <li><a href="#3-初始化">3. 初始化</a>
      <ul>
        <li><a href="#31-数据库初始化">3.1. 数据库初始化</a></li>
        <li><a href="#32-缓存构建">3.2. 缓存构建</a></li>
        <li><a href="#33-事件订阅">3.3. 事件订阅</a></li>
      </ul>
    </li>
    <li><a href="#4-事件分发">4. 事件分发</a>
      <ul>
        <li><a href="#41-单次任务">4.1. 单次任务</a></li>
        <li><a href="#42-定时任务">4.2. 定时任务</a></li>
      </ul>
    </li>
    <li><a href="#5-事件处理">5. 事件处理</a>
      <ul>
        <li><a href="#51-数据库事件">5.1. 数据库事件</a></li>
      </ul>
    </li>
    <li><a href="#6-插件加载">6. 插件加载</a>
      <ul>
        <li><a href="#61-插件读取">6.1. 插件读取</a></li>
        <li><a href="#62-插件调用">6.2. 插件调用</a></li>
      </ul>
    </li>
    <li><a href="#7-缓存机制">7. 缓存机制</a></li>
    <li><a href="#8-请求生命周期">8. 请求生命周期</a>
      <ul>
        <li><a href="#81-ssl_certificate_by_lua-阶段">8.1. ssl_certificate_by_lua 阶段</a></li>
        <li><a href="#82-rewrite_by_lua-阶段">8.2. rewrite_by_lua 阶段</a></li>
        <li><a href="#83-access_by_lua-阶段">8.3. access_by_lua 阶段</a></li>
        <li><a href="#84-balancer_by_lua-阶段">8.4. balancer_by_lua 阶段</a></li>
        <li><a href="#85-header_filter_by_lua-阶段">8.5. header_filter_by_lua 阶段</a></li>
        <li><a href="#86-body_filter_by_lua-阶段">8.6. body_filter_by_lua 阶段</a></li>
        <li><a href="#87-log_by_lua-阶段">8.7. log_by_lua 阶段</a></li>
      </ul>
    </li>
    <li><a href="#9-admin-api">9. Admin API</a></li>
    <li><a href="#10-插件开发">10. 插件开发</a>
      <ul>
        <li><a href="#101-多层-schema-嵌套">10.1. 多层 Schema 嵌套</a></li>
        <li><a href="#102-自定义-schema-校验器">10.2. 自定义 Schema 校验器</a></li>
        <li><a href="#103-日志打印-table">10.3. 日志打印 Table</a></li>
        <li><a href="#104-自定义日志输出">10.4. 自定义日志输出</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

                    
                    <p>本文针对 Kong 的启动流程、插件机制、缓存机制和请求的生命周期做了详细的阐述。</p>
<h2 id="1-概述">1. 概述</h2>
<p>本文针对的是 Kong 2.1 版本（Stable）。</p>
<p>我阅读并作出中文注释的 Commits 可以在这里看到： <br>
<a href="https://github.com/mayocream/kong/commits?author=huanghan39" target="_blank" rel="noopener">https://github.com/mayocream/kong/commits?author=mayocream</a></p>
<p><strong>Kong（OpenResty）的执行阶段</strong>：</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/kong-source-code-reading/openresty_phases_hu4b99ff06867232c24725aa5416b07e33_138963_942773043139fa96da65b47adb6d027f.webp 400w,
               /blog/kong-source-code-reading/openresty_phases_hu4b99ff06867232c24725aa5416b07e33_138963_f2fb2bf1a8800bc9468fe6868c98c153.webp 760w,
               /blog/kong-source-code-reading/openresty_phases_hu4b99ff06867232c24725aa5416b07e33_138963_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/kong-source-code-reading/openresty_phases_hu4b99ff06867232c24725aa5416b07e33_138963_942773043139fa96da65b47adb6d027f.webp"
               width="760"
               height="688"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Kong 的插件机制也是基于 OpenResty 的生命周期，只不过是其在上层做了些许封装。</p>
<p><strong>Kong 的数据库关联关系</strong>：</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/kong-source-code-reading/kong_db_hu54ccf84f51e882ba97d63dea506d67f8_206086_69e8a4710e17f24be3ecd921b949a763.webp 400w,
               /blog/kong-source-code-reading/kong_db_hu54ccf84f51e882ba97d63dea506d67f8_206086_18a254b040dba25afe36813b09717341.webp 760w,
               /blog/kong-source-code-reading/kong_db_hu54ccf84f51e882ba97d63dea506d67f8_206086_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/kong-source-code-reading/kong_db_hu54ccf84f51e882ba97d63dea506d67f8_206086_69e8a4710e17f24be3ecd921b949a763.webp"
               width="359"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p><a href="https://github.com/Kong/kong" target="_blank" rel="noopener">Kong</a> 虽然介绍中说是 Cloud Native 项目，也上榜了 CNCF <a href="https://landscape.cncf.io/" target="_blank" rel="noopener">全景图</a>，但是它还依赖于传统的数据库 PostgreSQL，并且还自定义了许多 Function，相比于 APISIX 的分布式储存 Etcd 显得较为弱势。比起 Etcd 客户端能建立 HTTP 长连接 Watch 数据变化，Kong 只能依赖定时的轮询从数据库更新状态，数据库高可用也相比搭建 Etcd 集群要复杂得多。</p>
<h2 id="2-配置文件">2. 配置文件</h2>
<p>Kong 在启动阶段会解析 <a href="https://github.com/kong/kong/tree/master/kong/templates" target="_blank" rel="noopener"><code>kong/templates</code></a> 目录下的 <code>.lua</code> 模板文件，注入环境变量和 <code>kong.conf</code> 覆盖配置，生成 Nginx 启动的配置文件 <code>nginx.conf</code>。</p>
<p>结构如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">pid pids/nginx.pid;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">error_log logs/error.log notice;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># injected nginx_main_* directives</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">env SKYWALKING_URL;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">events {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># injected nginx_events_* directives</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">multi_accept on;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">worker_connections 16384;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">http {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">lua_package_path       &#39;./?.lua;./?/init.lua;;;;&#39;;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">lua_package_cpath      &#39;;;;&#39;;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">lua_shared_dict kong                        5m;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">lua_shared_dict kong_locks                  8m;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># injected nginx_http_* directives</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">client_body_buffer_size 8k;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">init_by_lua_block {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Kong = require &#39;kong&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Kong.init()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">init_worker_by_lua_block {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Kong.init_worker()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">upstream kong_upstream {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">server 0.0.0.1;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># injected nginx_upstream_* directives</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">balancer_by_lua_block {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">Kong.balancer()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c"># Kong Proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">server {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">server_name kong;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c"># Kong Admin API</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">server {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">server_name kong_admin;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>Kong 定义了 <code>NGINX_MAIN_XXX</code>，诸如此类的环境变量，在解析配置阶段会加载到 <code>nginx.conf</code> 的指定位置，能够避免直接修改模板文件。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 在 main 块里定义 env 变量</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> NGINX_MAIN_ENV SKYWALKING_URL<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建新的 lua shared dict</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> NGINX_HTTP_Lua_SHARED_DICT tracing_buffer 128m<span class="p">;</span>
</span></span></code></pre></div><p>Kong <a href="https://docs.konghq.com/2.1.x/configuration/" target="_blank" rel="noopener">官方的配置文档</a>已经非常详尽，解释了各个参数代表的含义。</p>
<p>这里补充一点，通常我们需要定义多个 Shared dict，配置写法需要改成这种形式：</p>
<pre tabindex="0"><code>nginx_http_lua_shared_dict = cache_buffer_one 128m; lua_shared_dict cache_buffer_two 128m
</code></pre><h2 id="3-初始化">3. 初始化</h2>
<h3 id="31-数据库初始化">3.1. 数据库初始化</h3>
<p><code>Kong.init()</code> 方法中初始化数据库相关：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- 数据库连接相关</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">db</span> <span class="o">=</span> <span class="n">assert</span><span class="p">(</span><span class="n">DB.new</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">db</span><span class="p">:</span><span class="n">init_connector</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong.db</span> <span class="o">=</span> <span class="n">db</span>
</span></span></code></pre></div><p><code>DB.new()</code> 方法中依次调用了 <code>Schema.new()</code>、<code>Entity.new()</code>、<code>DAO.new()</code> 方法，下面一个个来说明。</p>
<h4 id="311-schema">3.1.1. Schema</h4>
<p>Kong 的 Schema 数据结构体位于 <code>db/schema/entities</code> 下，就 <code>routes.lua</code> 为例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">typedefs</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&#34;kong.db.schema.typedefs&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">name</span>         <span class="o">=</span> <span class="s2">&#34;routes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">primary_key</span>  <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;id&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="n">endpoint_key</span> <span class="o">=</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">workspaceable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">subschema_key</span> <span class="o">=</span> <span class="s2">&#34;protocols&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">id</span>             <span class="o">=</span> <span class="n">typedefs.uuid</span><span class="p">,</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">created_at</span>     <span class="o">=</span> <span class="n">typedefs.auto_timestamp_s</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">updated_at</span>     <span class="o">=</span> <span class="n">typedefs.auto_timestamp_s</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">name</span>           <span class="o">=</span> <span class="n">typedefs.name</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">protocols</span>      <span class="o">=</span> <span class="p">{</span> <span class="n">type</span>     <span class="o">=</span> <span class="s2">&#34;set&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">len_min</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">elements</span> <span class="o">=</span> <span class="n">typedefs.protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">mutually_exclusive_subsets</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                           <span class="p">{</span> <span class="s2">&#34;http&#34;</span><span class="p">,</span> <span class="s2">&#34;https&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                           <span class="p">{</span> <span class="s2">&#34;tcp&#34;</span><span class="p">,</span> <span class="s2">&#34;tls&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                           <span class="p">{</span> <span class="s2">&#34;grpc&#34;</span><span class="p">,</span> <span class="s2">&#34;grpcs&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                         <span class="p">},</span>
</span></span><span class="line"><span class="cl">                         <span class="n">default</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;http&#34;</span><span class="p">,</span> <span class="s2">&#34;https&#34;</span> <span class="p">},</span> <span class="c1">-- TODO: different default depending on service&#39;s scheme</span>
</span></span><span class="line"><span class="cl">                       <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">methods</span>        <span class="o">=</span> <span class="n">typedefs.methods</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">hosts</span>          <span class="o">=</span> <span class="n">typedefs.hosts</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">paths</span>          <span class="o">=</span> <span class="n">typedefs.paths</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">headers</span>        <span class="o">=</span> <span class="n">typedefs.headers</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">https_redirect_status_code</span> <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;integer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">one_of</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">307</span><span class="p">,</span> <span class="mi">308</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">default</span> <span class="o">=</span> <span class="mi">426</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">regex_priority</span> <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;integer&#34;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">strip_path</span>     <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;boolean&#34;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">path_handling</span>  <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s2">&#34;v0&#34;</span><span class="p">,</span> <span class="n">one_of</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;v0&#34;</span><span class="p">,</span> <span class="s2">&#34;v1&#34;</span> <span class="p">},</span> <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">preserve_host</span>  <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;boolean&#34;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">snis</span> <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;set&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">elements</span> <span class="o">=</span> <span class="n">typedefs.sni</span> <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">typedefs.sources</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">destinations</span> <span class="o">=</span> <span class="n">typedefs.destinations</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">tags</span>             <span class="o">=</span> <span class="n">typedefs.tags</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">service</span> <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;foreign&#34;</span><span class="p">,</span> <span class="n">reference</span> <span class="o">=</span> <span class="s2">&#34;services&#34;</span> <span class="p">},</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">entity_checks</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="n">conditional</span> <span class="o">=</span> <span class="p">{</span> <span class="n">if_field</span> <span class="o">=</span> <span class="s2">&#34;protocols&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">if_match</span> <span class="o">=</span> <span class="p">{</span> <span class="n">elements</span> <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span> <span class="n">not_one_of</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;grpcs&#34;</span><span class="p">,</span> <span class="s2">&#34;https&#34;</span><span class="p">,</span> <span class="s2">&#34;tls&#34;</span> <span class="p">}}},</span>
</span></span><span class="line"><span class="cl">                      <span class="n">then_field</span> <span class="o">=</span> <span class="s2">&#34;snis&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">then_match</span> <span class="o">=</span> <span class="p">{</span> <span class="n">len_eq</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                      <span class="n">then_err</span> <span class="o">=</span> <span class="s2">&#34;&#39;snis&#39; can only be set when &#39;protocols&#39; is &#39;grpcs&#39;, &#39;https&#39; or &#39;tls&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}},</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>primary_key</code> 是在数据库中主键也是当 <code>cache_key</code> 未定义时的默认 <code>cache_key</code>。</p>
<p>有 <code>type=foreign</code> 的情况，entity 加载时会当作 subschema 加载进来。</p>
<p>插件不同于其他 entity，有特定 cache_key。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;plugins&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">primary_key</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;id&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="n">cache_key</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;route&#34;</span><span class="p">,</span> <span class="s2">&#34;service&#34;</span><span class="p">,</span> <span class="s2">&#34;consumer&#34;</span> <span class="p">},</span>
</span></span></code></pre></div><p>Cache 相关操作中调用 <code>Entity.cache_key()</code> 获取。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">dao</span><span class="p">:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cache</span><span class="p">:</span><span class="n">safe_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
</span></span></code></pre></div><p>具体生成 <code>cache_key</code> 的方法，返回一个字符串作为缓存 key。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">cache_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">,</span> <span class="n">arg4</span><span class="p">,</span> <span class="n">arg5</span><span class="p">,</span> <span class="n">ws_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">self.schema</span><span class="p">.</span><span class="n">workspaceable</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ws_id</span> <span class="o">=</span> <span class="n">ws_id</span> <span class="ow">or</span> <span class="n">workspaces.get_workspace_id</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- Fast path: passing the cache_key/primary_key entries in</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- order as arguments, this produces the same result as</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- the generic code below, but building the cache key</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- becomes a single string.format operation</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">fmt</span><span class="p">(</span><span class="s2">&#34;%s:%s:%s:%s:%s:%s:%s&#34;</span><span class="p">,</span> <span class="n">self.schema</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">key</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="s2">&#34;&#34;</span> <span class="ow">or</span> <span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">arg2</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="s2">&#34;&#34;</span> <span class="ow">or</span> <span class="n">arg2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">arg3</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="s2">&#34;&#34;</span> <span class="ow">or</span> <span class="n">arg3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">arg4</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="s2">&#34;&#34;</span> <span class="ow">or</span> <span class="n">arg4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">arg5</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="s2">&#34;&#34;</span> <span class="ow">or</span> <span class="n">arg5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">ws_id</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="s2">&#34;&#34;</span> <span class="ow">or</span> <span class="n">ws_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- Generic path: build the cache key from the fields</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- listed in cache_key or primary_key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;table&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span><span class="p">(</span><span class="s2">&#34;key must be a string or an entity table&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">key.ws_id</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ws_id</span> <span class="o">=</span> <span class="n">key.ws_id</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">values</span> <span class="o">=</span> <span class="n">new_tab</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">self.schema</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">source</span> <span class="o">=</span> <span class="n">self.schema</span><span class="p">.</span><span class="n">cache_key</span> <span class="ow">or</span> <span class="n">self.schema</span><span class="p">.</span><span class="n">primary_key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">field</span> <span class="o">=</span> <span class="n">self.schema</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">null</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">value</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">elseif</span> <span class="n">field.type</span> <span class="o">==</span> <span class="s2">&#34;foreign&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- FIXME extract foreign key, do not assume `id`</span>
</span></span><span class="line"><span class="cl">      <span class="n">value</span> <span class="o">=</span> <span class="n">value.id</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="mi">6</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">values</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">ws_id</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">concat</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>schema/init.lua</code> 中定义了 schema 相关操作的基本方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- each_field() 用于遍历 schema 的 fields</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 是 schema 相关操作最频繁的</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">Schema</span><span class="p">:</span><span class="nf">each_field</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">subschema</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">values</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">subschema</span> <span class="o">=</span> <span class="n">get_subschema</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">item</span> <span class="o">=</span> <span class="n">self.fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">key</span> <span class="o">=</span> <span class="n">next</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">field</span> <span class="o">=</span> <span class="n">resolve_field</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">subschema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>Schema.new()</code> 方法中通过元组设置 <code>__index</code> 让结构体继承 Schema 下定义的一系列操作方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">Schema</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">is_subschema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">definition</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">validation_errors.SCHEMA_NO_DEFINITION</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">definition.fields</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">validation_errors.SCHEMA_NO_FIELDS</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">self</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 继承 Schema 下定义的一系列操作方法</span>
</span></span><span class="line"><span class="cl">  <span class="n">setmetatable</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- entity 缓存的 cache_key，</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 如果没有这个字段，则默认使用 schema 定义的</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- primary_key 来作为 cache_key</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- cache_key 是个数组，</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 这里只是分开储存</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">self.cache_key</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">self.cache_key_set</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">self.cache_key</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">self.cache_key_set</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 通过元组 __index 方法调用 Schema:each_field() 方法</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 遍历 schema 的 fields table</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">field</span> <span class="kr">in</span> <span class="n">self</span><span class="p">:</span><span class="n">each_field</span><span class="p">()</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- Also give access to fields by name</span>
</span></span><span class="line"><span class="cl">    <span class="n">self.fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">field.type</span> <span class="o">==</span> <span class="s2">&#34;record&#34;</span> <span class="ow">and</span> <span class="n">field.fields</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">allow_record_fields_by_name</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 如果有外键</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 则加载外键关联的 schema 进来</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">field.type</span> <span class="o">==</span> <span class="s2">&#34;foreign&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">      <span class="n">field.schema</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_foreign_schema_for_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">field.schema</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">is_subschema</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- Store the inverse relation for implementing constraints</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">constraints</span> <span class="o">=</span> <span class="n">assert</span><span class="p">(</span><span class="n">_cache</span><span class="p">[</span><span class="n">field.reference</span><span class="p">]).</span><span class="n">constraints</span>
</span></span><span class="line"><span class="cl">        <span class="n">table.insert</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">schema</span>     <span class="o">=</span> <span class="n">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">field_name</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">on_delete</span>  <span class="o">=</span> <span class="n">field.on_delete</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">self.workspaceable</span> <span class="ow">and</span> <span class="n">self.name</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">_workspaceable</span><span class="p">[</span><span class="n">self.name</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">_workspaceable</span><span class="p">[</span><span class="n">self.name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="n">table.insert</span><span class="p">(</span><span class="n">_workspaceable</span><span class="p">,</span> <span class="p">{</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">self</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">self.name</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- do not reset the constraints list if a schema in reloaded</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">_cache</span><span class="p">[</span><span class="n">self.name</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">_cache</span><span class="p">[</span><span class="n">self.name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- but always update the schema object in cache</span>
</span></span><span class="line"><span class="cl">    <span class="n">_cache</span><span class="p">[</span><span class="n">self.name</span><span class="p">].</span><span class="n">schema</span> <span class="o">=</span> <span class="n">self</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">self</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>用于下级继承的元组。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">Schema</span>       <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">Schema.__index</span>     <span class="o">=</span> <span class="n">Schema</span>
</span></span></code></pre></div><h4 id="312-entity">3.1.2. Entity</h4>
<p>Entity 只是简单对 Schema 进行一层封装。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- definition 是 schema 结构体</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">Entity</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 初始化 Schema 对象</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">self</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">Schema.new</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">self</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 遍历 schema fields</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="kr">in</span> <span class="n">self</span><span class="p">:</span><span class="n">each_field</span><span class="p">()</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">field.nilable</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">entity_errors.NO_NILABLE</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">field.abstract</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">goto</span> <span class="nl">continue</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">field.type</span> <span class="o">==</span> <span class="s2">&#34;map&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">field.keys</span><span class="p">.</span><span class="n">type</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">entity_errors.MAP_KEY_STRINGS_ONLY</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">elseif</span> <span class="n">field.type</span> <span class="o">==</span> <span class="s2">&#34;record&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">make_records_required</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">elseif</span> <span class="n">field.type</span> <span class="o">==</span> <span class="s2">&#34;function&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">entity_errors.NO_FUNCTIONS</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">::</span><span class="nl">continue</span><span class="p">::</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">self.new_subschema</span> <span class="o">=</span> <span class="n">Entity.new_subschema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">self</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>Entity 对象随后被加载到 <code>DB.new()</code> 函数中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">schemas</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- load schemas</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- core entities are for now the only source of schemas.</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- TODO: support schemas from plugins entities as well.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 载入核心 entity，为什么是核心 entity</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 因为还有 plugin 自定义的 entity</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 这些 entity 是 Kong 自身的</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entity_name</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">constants.CORE_ENTITIES</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 加载 schema（数据结构体）</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">entity_schema</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;kong.db.schema.entities.&#34;</span> <span class="o">..</span> <span class="n">entity_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- validate core entities schema via metaschema</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">MetaSchema</span><span class="p">:</span><span class="n">validate</span><span class="p">(</span><span class="n">entity_schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="s2">&#34;schema of entity &#39;%s&#39; is invalid: %s&#34;</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">tostring</span><span class="p">(</span><span class="n">errors</span><span class="p">:</span><span class="n">schema_violation</span><span class="p">(</span><span class="n">err_t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 加载 entity 对象</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">Entity.new</span><span class="p">(</span><span class="n">entity_schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">entity</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="s2">&#34;schema of entity &#39;%s&#39; is invalid: %s&#34;</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">schemas</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- load core entities subschemas</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">subschemas</span>
</span></span><span class="line"><span class="cl">    <span class="n">ok</span><span class="p">,</span> <span class="n">subschemas</span> <span class="o">=</span> <span class="n">utils.load_module_if_exists</span><span class="p">(</span><span class="s2">&#34;kong.db.schema.entities.&#34;</span> <span class="o">..</span> <span class="n">entity_name</span> <span class="o">..</span> <span class="s2">&#34;_subschemas&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">subschema</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">subschemas</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">entity</span><span class="p">:</span><span class="n">new_subschema</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">subschema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">          <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="p">(</span><span class="s2">&#34;error initializing schema for %s: %s&#34;</span><span class="p">):</span><span class="n">format</span><span class="p">(</span><span class="n">entity_name</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h4 id="313-dao">3.1.3. DAO</h4>
<p><code>db/dao/init.lua</code> 中定义了一系列对数据库操作的方法，例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">select</span><span class="p">(</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">page</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">each</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><p><code>DAO.new()</code> 会创建一个包含 db 连接信息，entity 的 table。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- schema 参数是 Entity 对象</span>
</span></span><span class="line"><span class="cl"><span class="c1">--  DB 结构体：  local self   = {</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--    daos       = daos,       -- each of those has the connector singleton</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--    strategies = strategies,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--    connector  = connector,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--    strategy   = strategy,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--    errors     = errors,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--    infos      = connector:infos(),</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--    kong_config = kong_config,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--  }</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">fk_methods</span> <span class="o">=</span> <span class="n">generate_foreign_key_methods</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 继承 DAO 基础方法</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">super</span>      <span class="o">=</span> <span class="n">setmetatable</span><span class="p">(</span><span class="n">fk_methods</span><span class="p">,</span> <span class="n">DAO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">self</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span>         <span class="o">=</span> <span class="n">db</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span>     <span class="o">=</span> <span class="n">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">strategy</span>   <span class="o">=</span> <span class="n">strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">errors</span>     <span class="o">=</span> <span class="n">errors</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">pagination</span> <span class="o">=</span> <span class="n">utils.shallow_copy</span><span class="p">(</span><span class="n">defaults.pagination</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">super</span>      <span class="o">=</span> <span class="n">super</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">schema.dao</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 插件自定义的 dao</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">custom_dao</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="n">schema.dao</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">custom_dao</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">setmetatable</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">{</span> <span class="n">__index</span> <span class="o">=</span> <span class="n">super</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>在 <code>db\init.lua</code> 中加载所有 DAO 对象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- load DAOs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">schema</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">strategy</span> <span class="o">=</span> <span class="n">strategies</span><span class="p">[</span><span class="n">schema.name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">strategy</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="s2">&#34;no strategy found for schema &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="n">schema.name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- 储存 daos</span>
</span></span><span class="line"><span class="cl">      <span class="n">daos</span><span class="p">[</span><span class="n">schema.name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DAO.new</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p>和上面结构一样，<code>DB.new()</code> 中最后为 table 设置元组 __index 方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- 设置元组 __index 方法</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 访问不存在的对象则先</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- DB.xxx 再访问 DB.daos.xxx</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">setmetatable</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">DB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">DB</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">DB.__index</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- rawget 为不调用元组 __index 方法，直接获取原数据</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">DB</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">or</span> <span class="n">rawget</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s2">&#34;daos&#34;</span><span class="p">)[</span><span class="n">k</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>Kong 中其他地方调用数据库方法，操作符为 <code>kong.db.services:each_fields()</code>，即实际调用 <code>daos.services</code>、<code>entity:each_fields()</code>（实际是 <code>Schema:each_fields()</code>）。</p>
<p>DAO 下面还有封装的数据库操作层，例如 PostgreSQL 生成 SQL 语句的方法，这里就不赘述了。</p>
<h3 id="32-缓存构建">3.2. 缓存构建</h3>
<p><code>init_by_lua</code>  阶段初始化 Master 进程，进行解析配置文件、连接数据库、清空共享内存、构建路由缓存等操作。</p>
<p><code>reset_kong_shm</code> 代码块里清理共享内存。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">shms</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_locks&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_healthchecks&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_process_events&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_cluster_events&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_rate_limiting_counters&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_core_db_cache&#34;</span> <span class="o">..</span> <span class="n">suffix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_core_db_cache_miss&#34;</span> <span class="o">..</span> <span class="n">suffix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_db_cache&#34;</span> <span class="o">..</span> <span class="n">suffix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_db_cache_miss&#34;</span> <span class="o">..</span> <span class="n">suffix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kong_clustering&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">shm</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">shms</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">dict</span> <span class="o">=</span> <span class="n">ngx.shared</span><span class="p">[</span><span class="n">shm</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 清空共享内存</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">dict</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">dict</span><span class="p">:</span><span class="n">flush_all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">dict</span><span class="p">:</span><span class="n">flush_expired</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span></code></pre></div><h4 id="321-路由缓存">3.2.1. 路由缓存</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- DB 模式</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">default_ws</span> <span class="o">=</span> <span class="n">db.workspaces</span><span class="p">:</span><span class="n">select_by_name</span><span class="p">(</span><span class="s2">&#34;default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">kong.default_workspace</span> <span class="o">=</span> <span class="n">default_ws</span> <span class="ow">and</span> <span class="n">default_ws.id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">runloop.build_plugins_iterator</span><span class="p">(</span><span class="s2">&#34;init&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">error</span><span class="p">(</span><span class="s2">&#34;error building initial plugins: &#34;</span> <span class="o">..</span> <span class="n">tostring</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 初始化路由</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 构建路由缓存</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">runloop.build_router</span><span class="p">(</span><span class="s2">&#34;init&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">db</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>DB 模式下最后一步会调用 <code>runloop.build_router(&quot;init&quot;)</code> 构建路由缓存。</p>
<p>构建路由缓存过程中，判断 Kong 是否已经初始化过 Cache 组件，<code>init</code> 阶段没有完成初始化 Cache，则创建一个 Lua table 缓存路由信息。<code>build_services_init_cache()</code> 方法会分页加载所有 Service 到 table 中，对取出来的 Services，判断当前使用的 Nginx 模式（http/stream）是否对应路由指定的协议，对应则取出 Service 对象，与 Route 进行关联。最后传递给 <code>Router.new()</code> 方法通过算法建立树形结构建立路由索引。</p>
<p>Kong 基于 Nginx Subsystem 支持的协议对应关系：</p>
<ul>
<li>http/https -&gt; http</li>
<li>grpc/grpcs -&gt; http</li>
<li>tcp/tls -&gt; stream</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="n">build_router</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">db</span> <span class="o">=</span> <span class="n">kong.db</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- table 储存所有的 route-service 数据</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">routes</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="p">{},</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- The router is initially created on init phase, where kong.core_cache is</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- still not ready. For those cases, use a plain Lua table as a cache</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- instead</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- init 阶段 core_cache 还没有初始化完成</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 这里使用 table 储存</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">services_init_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">kong.core_cache</span> <span class="ow">and</span> <span class="n">db.strategy</span> <span class="o">~=</span> <span class="s2">&#34;off&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 获取所有的 services，使用默认的分页参数</span>
</span></span><span class="line"><span class="cl">      <span class="n">services_init_cache</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">build_services_init_cache</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">services_init_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="p">(</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&#34;could not build services init cache: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">page_size</span> <span class="o">=</span> <span class="n">db.routes</span><span class="p">.</span><span class="n">pagination.page_size</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">route</span><span class="p">,</span> <span class="n">err</span> <span class="kr">in</span> <span class="n">db.routes</span><span class="p">:</span><span class="n">each</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">GLOBAL_QUERY_OPTS</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;could not load routes: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- 检查 router 数据是否已经变化</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 通过检查 router hash 是否一致判断</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 如果已经变化则退出函数</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">db.strategy</span> <span class="o">~=</span> <span class="s2">&#34;off&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">kong.core_cache</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">%</span> <span class="n">page_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">          <span class="kd">local</span> <span class="n">new_version</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_router_version</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to retrieve router version: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="n">new_version</span> <span class="o">~=</span> <span class="n">version</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;router was changed while rebuilding it&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- subsystem 是否支持当前路由的协议</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">should_process_route</span><span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 获取 route 的 service</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">service</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_service_for_route</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">services_init_cache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">          <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">route</span>   <span class="o">=</span> <span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">service</span> <span class="o">=</span> <span class="n">service</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 储存所有的 route-service</span>
</span></span><span class="line"><span class="cl">        <span class="n">routes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">new_router</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">Router.new</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">new_router</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;could not create router: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- router 实例</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span> <span class="o">=</span> <span class="n">new_router</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">version</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">router_version</span> <span class="o">=</span> <span class="n">version</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- LEGACY - singletons module is deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="n">singletons.router</span> <span class="o">=</span> <span class="n">router</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- /LEGACY</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p>构建路由缓存过程中，判断 Kong 是否已经初始化过 Cache 组件，<code>init</code> 阶段没有完成初始化 Cache，则创建一个 Lua table 缓存 services。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- 以 [service.id] = service</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 结构储存到 table 中</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">build_services_init_cache</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">services_init_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">service</span><span class="p">,</span> <span class="n">err</span> <span class="kr">in</span> <span class="n">db.services</span><span class="p">:</span><span class="n">each</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">GLOBAL_QUERY_OPTS</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">services_init_cache</span><span class="p">[</span><span class="n">service.id</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">services_init_cache</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p><code>build_services_init_cache(db)</code> 方法，调用 <code>DAO:each()</code> 函数，使用默认分页参数 <code>page_size=1000</code>，进行分页获取，再返回可迭代的单条记录。这里因为 <code>init_by_lua</code> 阶段没有初始化缓存（<code>kong.core_cache</code> ），所以使用 Lua table 储存缓存数据。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">each</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">size</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">validate_size_type</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 获取分页条件，有默认值</span>
</span></span><span class="line"><span class="cl">  <span class="n">options</span> <span class="o">=</span> <span class="n">get_pagination_options</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">size</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">validate_size_value</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">options.pagination</span><span class="p">.</span><span class="n">max_page_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">self.errors</span><span class="p">:</span><span class="n">invalid_size</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">err_t</span><span class="p">),</span> <span class="n">err_t</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="n">options.pagination</span><span class="p">.</span><span class="n">page_size</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">validate_options_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">self.errors</span><span class="p">:</span><span class="n">invalid_options</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">err_t</span><span class="p">),</span> <span class="n">err_t</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">pager</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">self.strategy</span><span class="p">:</span><span class="n">page</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">iteration.by_row</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pager</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>默认分页参数在 <code>db/strategies/connector.lua</code> 文件中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">Connector</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 默认分页条件</span>
</span></span><span class="line"><span class="cl">    <span class="n">pagination</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">page_size</span>     <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>接下来会遍历所有的 Routes，逐个调用 <code>should_process_route()</code> 和 <code>get_service_for_route()</code> 方法，前者会判断 Nginx Subsystem 是否和 Route 协议一致，后者先在缓存中查找 Service，如果缓存中不存在则从数据库中获取。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">get_service_for_route</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">services_init_cache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- route 关联的 service 外键</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">service_pk</span> <span class="o">=</span> <span class="n">route.service</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">service_pk</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 查找缓存 table 里的 service</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">service_pk.id</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">service</span> <span class="o">=</span> <span class="n">services_init_cache</span><span class="p">[</span><span class="n">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">service</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="n">service</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- kong.core_cache is available, not in init phase</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">kong.core_cache</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 通过 mlcache 查询 service</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">db.services</span><span class="p">:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">service_pk.id</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                              <span class="n">route.ws_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 查询 cache 获取，没有获取到则调用 load_service_from_db 获取</span>
</span></span><span class="line"><span class="cl">      <span class="n">service</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong.core_cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">TTL_ZERO</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">load_service_from_db</span><span class="p">,</span> <span class="n">service_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">else</span> <span class="c1">-- init phase, kong.core_cache not available</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- A new service/route has been inserted while the initial route</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- was being created, on init (perhaps by a different Kong node).</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- Load the service individually and update services_init_cache with it</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 直接查询数据库获取 service</span>
</span></span><span class="line"><span class="cl">      <span class="n">service</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">load_service_from_db</span><span class="p">(</span><span class="n">service_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">services_init_cache</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;error raised while finding service for route (&#34;</span> <span class="o">..</span> <span class="n">route.id</span> <span class="o">..</span> <span class="s2">&#34;): &#34;</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                  <span class="n">err</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">elseif</span> <span class="ow">not</span> <span class="n">service</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;could not find service for route (&#34;</span> <span class="o">..</span> <span class="n">route.id</span> <span class="o">..</span> <span class="s2">&#34;)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- TODO: this should not be needed as the schema should check it already</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">SUBSYSTEMS</span><span class="p">[</span><span class="n">service.protocol</span><span class="p">]</span> <span class="o">~=</span> <span class="n">subsystem</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&#34;service with protocol &#39;&#34;</span><span class="p">,</span> <span class="n">service.protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;&#39; cannot be used with &#39;&#34;</span><span class="p">,</span> <span class="n">subsystem</span><span class="p">,</span> <span class="s2">&#34;&#39; subsystem&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">service</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p><code>load_service_from_db()</code> 方法中只是简单调用 <code>DAO:select()</code> 方法，取出 Service 同时缓存到 <code>services_init_cache</code> table 中，不更新 <code>Kong.core_cache</code> 组件。</p>
<p>对数据库实体对象的处理中，只有<code>create</code> 、<code>update</code>、<code>delete</code> 会通过事件广播到其他 Worker 同步，后面事件的一节我们会详细阐述。</p>
<p>接下来将 <code>{router, service}</code> 数组传入 <code>router.iua</code> 中 <code>Router.new()</code> 函数处理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">new_router</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">Router.new</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">if</span> <span class="ow">not</span> <span class="n">new_router</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;could not create router: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 绑定 router 实例</span>
</span></span><span class="line"><span class="cl"><span class="n">router</span> <span class="o">=</span> <span class="n">new_router</span>
</span></span></code></pre></div><p>具体构建路由索引的过程在 <code>router.lua</code> 中的 <code>_M.new(routes)</code> 函数，使用 <strong><a href="https://github.com/openresty/lua-resty-lrucache" target="_blank" rel="noopener">lua-resty-lrucache</a></strong> 包缓存，对路由和 Service 组合通过算法进行排序，构建索引，将诸如 <code>{cache_key: {route, service}}</code> 结构存入缓存中，返回 Router 实例。</p>
<p>路由索引 Key 的构建方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">req_method</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">req_uri</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">req_host</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.src_ip</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.src_port</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.dst_ip</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.dst_port</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.sni</span>
</span></span></code></pre></div><p>Router 实例由 Master 进程构建，并 fork 到各个 Worker 进程使用。</p>
<p>Worker 执行完共享内存的构建后，注册定时任务，定时重建缓存。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">      <span class="c1">-- 定时重建路由缓存</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">kong.db</span><span class="p">.</span><span class="n">strategy</span> <span class="o">~=</span> <span class="s2">&#34;off&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">timer_every</span><span class="p">(</span><span class="n">worker_state_update_frequency</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">premature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="n">premature</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">-- Don&#39;t wait for the semaphore (timeout = 0) when updating via the</span>
</span></span><span class="line"><span class="cl">          <span class="c1">-- timer.</span>
</span></span><span class="line"><span class="cl">          <span class="c1">-- If the semaphore is locked, that means that the rebuild is</span>
</span></span><span class="line"><span class="cl">          <span class="c1">-- already ongoing.</span>
</span></span><span class="line"><span class="cl">          <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rebuild_router</span><span class="p">(</span><span class="n">ROUTER_ASYNC_OPTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not rebuild router via timer: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timer_every</span><span class="p">(</span><span class="n">worker_state_update_frequency</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">premature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="n">premature</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rebuild_plugins_iterator</span><span class="p">(</span><span class="n">PLUGINS_ITERATOR_ASYNC_OPTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not rebuild plugins iterator via timer: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span></code></pre></div><h4 id="322-entity-缓存">3.2.2. Entity 缓存</h4>
<p>这里首先介绍一下 <strong><a href="https://github.com/thibaultcha/lua-resty-mlcache" target="_blank" rel="noopener">lua-resty-mlcache</a></strong> 这个缓存库，该库基于 <a href="https://github.com/openresty/lua-nginx-module#lua_shared_dict" target="_blank" rel="noopener">lua_shared_dict</a> 和 <a href="https://github.com/openresty/lua-resty-lrucache" target="_blank" rel="noopener">lua-resty-lrucache</a> 做了两层缓存，Worker 会有自己的进程级别的 LRU 缓存，首先会在这一层进行查询，其次使用共享内存进行缓存，最后提供 callback 从数据库查询，使用 <a href="https://github.com/openresty/lua-resty-lock" target="_blank" rel="noopener">lua-resty-lock</a> 库创建锁只允许单个进程执行 callback。</p>
<p>mlcache 架构图：</p>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────┐
│ Nginx                                           │
│       ┌───────────┐ ┌───────────┐ ┌───────────┐ │
│       │worker     │ │worker     │ │worker     │ │
│ L1    │           │ │           │ │           │ │
│       │ Lua cache │ │ Lua cache │ │ Lua cache │ │
│       └───────────┘ └───────────┘ └───────────┘ │
│             │             │             │       │
│             ▼             ▼             ▼       │
│       ┌───────────────────────────────────────┐ │
│       │                                       │ │
│ L2    │           lua_shared_dict             │ │
│       │                                       │ │
│       └───────────────────────────────────────┘ │
│                           │ mutex               │
│                           ▼                     │
│                  ┌──────────────────┐           │
│                  │     callback     │           │
│                  └────────┬─────────┘           │
└───────────────────────────┼─────────────────────┘
                            │
  L3                        │   I/O fetch
                            ▼

                   Database, API, DNS, Disk, any I/O...
</code></pre><p><code>Kong.init_worker()</code> 中进行初始化缓存：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- 初始化基于共享内存的 cache</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">cache</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong_global.init_cache</span><span class="p">(</span><span class="n">kong.configuration</span><span class="p">,</span> <span class="n">cluster_events</span><span class="p">,</span> <span class="n">worker_events</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">cache</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">stash_init_worker_error</span><span class="p">(</span><span class="s2">&#34;failed to instantiate &#39;kong.cache&#39; module: &#34;</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                            <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong.cache</span> <span class="o">=</span> <span class="n">cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">core_cache</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong_global.init_core_cache</span><span class="p">(</span><span class="n">kong.configuration</span><span class="p">,</span> <span class="n">cluster_events</span><span class="p">,</span> <span class="n">worker_events</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">core_cache</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">stash_init_worker_error</span><span class="p">(</span><span class="s2">&#34;failed to instantiate &#39;kong.core_cache&#39; module: &#34;</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                            <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong.core_cache</span> <span class="o">=</span> <span class="n">core_cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">runloop.set_init_versions_in_cache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">stash_init_worker_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="c1">-- &#39;err&#39; fully formatted</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p><code>global.init_cache()</code> 结构如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_GLOBAL</span><span class="p">.</span><span class="nf">init_cache</span><span class="p">(</span><span class="n">kong_config</span><span class="p">,</span> <span class="n">cluster_events</span><span class="p">,</span> <span class="n">worker_events</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">db_cache_ttl</span> <span class="o">=</span> <span class="n">kong_config.db_cache_ttl</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">db_cache_neg_ttl</span> <span class="o">=</span> <span class="n">kong_config.db_cache_neg_ttl</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">cache_pages</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">kong_config.database</span> <span class="o">==</span> <span class="s2">&#34;off&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">db_cache_ttl</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">db_cache_neg_ttl</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache_pages</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">kong_cache.new</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">shm_name</span>          <span class="o">=</span> <span class="s2">&#34;kong_db_cache&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">cluster_events</span>    <span class="o">=</span> <span class="n">cluster_events</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">worker_events</span>     <span class="o">=</span> <span class="n">worker_events</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ttl</span>               <span class="o">=</span> <span class="n">db_cache_ttl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">neg_ttl</span>           <span class="o">=</span> <span class="n">db_cache_neg_ttl</span> <span class="ow">or</span> <span class="n">db_cache_ttl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">resurrect_ttl</span>     <span class="o">=</span> <span class="n">kong_config.resurrect_ttl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache_pages</span>       <span class="o">=</span> <span class="n">cache_pages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">resty_lock_opts</span>   <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">exptime</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>最终会调用 <code>cache.lua</code> 中 <code>_M.new()</code> 进行必要参数的验证，检测共享内存块是否可以访问，关联集群事件和 Worker 事件，定义序列化和反序列化的方法，对 mlcache 进行一层封装。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- opts validation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">mlcaches</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">shm_names</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">opts.cache_pages</span> <span class="ow">or</span> <span class="mi">1</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">channel_name</span>  <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&#34;mlcache&#34;</span>                 <span class="ow">or</span> <span class="s2">&#34;mlcache_2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">shm_name</span>      <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">opts.shm_name</span>             <span class="ow">or</span> <span class="n">opts.shm_name</span> <span class="o">..</span> <span class="s2">&#34;_2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">shm_miss_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">opts.shm_name</span> <span class="o">..</span> <span class="s2">&#34;_miss&#34;</span>  <span class="ow">or</span> <span class="n">opts.shm_name</span> <span class="o">..</span> <span class="s2">&#34;_miss_2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">ngx.shared</span><span class="p">[</span><span class="n">shm_name</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">mlcache</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">resty_mlcache.new</span><span class="p">(</span><span class="n">shm_name</span><span class="p">,</span> <span class="n">shm_name</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">shm_miss</span>         <span class="o">=</span> <span class="n">shm_miss_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">shm_locks</span>        <span class="o">=</span> <span class="s2">&#34;kong_locks&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">shm_set_retries</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">lru_size</span>         <span class="o">=</span> <span class="n">LRU_SIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ttl</span>              <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">opts.ttl</span>     <span class="ow">or</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">neg_ttl</span>          <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">opts.neg_ttl</span> <span class="ow">or</span> <span class="mi">300</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">resurrect_ttl</span>    <span class="o">=</span> <span class="n">opts.resurrect_ttl</span> <span class="ow">or</span> <span class="mi">30</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">resty_lock_opts</span>  <span class="o">=</span> <span class="n">opts.resty_lock_opts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ipc</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">-- 进程间通信的函数绑定</span>
</span></span><span class="line"><span class="cl">          <span class="n">register_listeners</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">event_t</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">              <span class="n">opts.worker_events</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">event_t.handler</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="kr">end</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">,</span> <span class="n">event_t.channel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">broadcast</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">opts.worker_events</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">              <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;failed to post event &#39;&#34;</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">,</span> <span class="s2">&#34;&#39;, &#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">channel</span><span class="p">,</span> <span class="s2">&#34;&#39;: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">mlcache</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to instantiate mlcache: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">      <span class="n">mlcaches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlcache</span>
</span></span><span class="line"><span class="cl">      <span class="n">shm_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">shm_name</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">curr_mlcache</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">opts.cache_pages</span> <span class="o">==</span> <span class="mi">2</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">curr_mlcache</span> <span class="o">=</span> <span class="n">ngx.shared</span><span class="p">.</span><span class="n">kong</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;kong:cache:&#34;</span> <span class="o">..</span> <span class="n">opts.shm_name</span> <span class="o">..</span> <span class="s2">&#34;:curr_mlcache&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">self</span>          <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cluster_events</span>    <span class="o">=</span> <span class="n">opts.cluster_events</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">mlcache</span>           <span class="o">=</span> <span class="n">mlcaches</span><span class="p">[</span><span class="n">curr_mlcache</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">mlcaches</span>          <span class="o">=</span> <span class="n">mlcaches</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">shm_names</span>         <span class="o">=</span> <span class="n">shm_names</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">curr_mlcache</span>      <span class="o">=</span> <span class="n">curr_mlcache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self.cluster_events</span><span class="p">:</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&#34;invalidations&#34;</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s2">&#34;received invalidate event from cluster for key: &#39;&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">self</span><span class="p">:</span><span class="n">invalidate_local</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to subscribe to invalidations cluster events &#34;</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;channel: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">_init</span><span class="p">[</span><span class="n">opts.shm_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">setmetatable</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>初始化完缓存模块后，Worker 会根据配置文件中的 <code>db_cache_warmup_entities</code> 加载指定的数据库资源到内存进行缓存，默认配置会缓存 <code>services, plugins</code>。</p>
<p><code>LRU_SIZE</code> 值为 500,000，单位是 item，设置最大能储存的 item 数量，这个值表示单个 Worker LRU Cache 最大占用 500M 内存。</p>
<p>Worker 会根据配置项加载数据库实体到共享内存缓存。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">execute_cache_warmup</span><span class="p">(</span><span class="n">kong_config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">kong_config.database</span> <span class="o">==</span> <span class="s2">&#34;off&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 只在一个 worker 上执行操作</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 加载数据库实体到共享内存缓存</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">ngx.worker</span><span class="p">.</span><span class="n">id</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cache_warmup.execute</span><span class="p">(</span><span class="n">kong_config.db_cache_warmup_entities</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>这里只在一个 Worker 进程上加载数据库数据，随后同步到其他的 Worker 上。</p>
<p><code>cache_warmup.execute()</code> 里做基本信息的检测，随后调用 <code>cache_warmup_single_entity(dao)</code> 方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 加载数据库实体到缓存，以实现更快的访问速度</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 在 Worker 初始化阶段运行</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 默认加载 service, plugins</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 大小受配置 mem_cache_size 影响</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Loads entities from the database into the cache, for rapid subsequent</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- access. This function is intented to be used during worker initialization.</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">cache_warmup</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">kong.cache</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">kong.core_cache</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entity_name</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">entity_name</span> <span class="o">==</span> <span class="s2">&#34;routes&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- do not spend shm memory by caching individual Routes entries</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- because the routes are kept in-memory by building the router object</span>
</span></span><span class="line"><span class="cl">      <span class="n">kong.log</span><span class="p">.</span><span class="n">notice</span><span class="p">(</span><span class="s2">&#34;the &#39;routes&#39; entry is ignored in the list of &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;&#39;db_cache_warmup_entities&#39; because Kong &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;caches routes in memory separately&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">goto</span> <span class="nl">continue</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">dao</span> <span class="o">=</span> <span class="n">kong.db</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">type</span><span class="p">(</span><span class="n">dao</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;table&#34;</span> <span class="ow">and</span> <span class="n">dao.schema</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">kong.log</span><span class="p">.</span><span class="n">warn</span><span class="p">(</span><span class="n">entity_name</span><span class="p">,</span> <span class="s2">&#34; is not a valid entity name, please check &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;the value of &#39;db_cache_warmup_entities&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">goto</span> <span class="nl">continue</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cache_warmup_single_entity</span><span class="p">(</span><span class="n">dao</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err</span> <span class="o">==</span> <span class="s2">&#34;no memory&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">kong.log</span><span class="p">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&#34;cache warmup has been stopped because cache &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;memory is exhausted, please consider increasing &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;the value of &#39;mem_cache_size&#39; (currently at &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">kong.configuration</span><span class="p">.</span><span class="n">mem_cache_size</span><span class="p">,</span> <span class="s2">&#34;)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">::</span><span class="nl">continue</span><span class="p">::</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>不缓存 Routes，因为 Route 已经在上一节中构建为路由索引树，通过 fork 到所有的 Worker 内存里了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">cache_warmup_single_entity</span><span class="p">(</span><span class="n">dao</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">entity_name</span> <span class="o">=</span> <span class="n">dao.schema</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 选定储存地方 cache/core_cache</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">cache_store</span> <span class="o">=</span> <span class="n">constants.ENTITY_CACHE_STORE</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- cache 全局对象</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">kong</span><span class="p">[</span><span class="n">cache_store</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.NOTICE</span><span class="p">,</span> <span class="s2">&#34;Preloading &#39;&#34;</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">,</span> <span class="s2">&#34;&#39; into the &#34;</span><span class="p">,</span> <span class="n">cache_store</span><span class="p">,</span> <span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ngx.now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">hosts_array</span><span class="p">,</span> <span class="n">hosts_set</span><span class="p">,</span> <span class="n">host_count</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">entity_name</span> <span class="o">==</span> <span class="s2">&#34;services&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">hosts_array</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">hosts_set</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">host_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span> <span class="kr">in</span> <span class="n">dao</span><span class="p">:</span><span class="n">each</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">GLOBAL_QUERY_OPTS</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">entity_name</span> <span class="o">==</span> <span class="s2">&#34;services&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">utils.hostname_type</span><span class="p">(</span><span class="n">entity.host</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;name&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="ow">and</span> <span class="n">hosts_set</span><span class="p">[</span><span class="n">entity.host</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">host_count</span> <span class="o">=</span> <span class="n">host_count</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">hosts_array</span><span class="p">[</span><span class="n">host_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity.host</span>
</span></span><span class="line"><span class="cl">        <span class="n">hosts_set</span><span class="p">[</span><span class="n">entity.host</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 获取 cache_key</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">dao</span><span class="p">:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 调用 mlcache 的 safe_set 方法，</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 内存不足会报错</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cache</span><span class="p">:</span><span class="n">safe_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">entity_name</span> <span class="o">==</span> <span class="s2">&#34;services&#34;</span> <span class="ow">and</span> <span class="n">host_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ngx.timer</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">warmup_dns</span><span class="p">,</span> <span class="n">hosts_array</span><span class="p">,</span> <span class="n">host_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">((</span><span class="n">ngx.now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.NOTICE</span><span class="p">,</span> <span class="s2">&#34;finished preloading &#39;&#34;</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;&#39; into the &#34;</span><span class="p">,</span> <span class="n">cache_store</span><span class="p">,</span> <span class="s2">&#34; (in &#34;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span> <span class="s2">&#34;ms)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>cache_warmup_single_entity()</code> 会加载该 dao 所有的数据到内存中，<code>set</code> 方法会分发事件同步数据到其他的 Worker 上，最终每个 Worker 都会缓存一份。</p>
<h3 id="33-事件订阅">3.3. 事件订阅</h3>
<p><code>Kong.init_worker()</code> 中初始化 Worker 事件和集群事件。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">worker_events</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong_global.init_worker_events</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">worker_events</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">stash_init_worker_error</span><span class="p">(</span><span class="s2">&#34;failed to instantiate &#39;kong.worker_events&#39; &#34;</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;module: &#34;</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong.worker_events</span> <span class="o">=</span> <span class="n">worker_events</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">cluster_events</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong_global.init_cluster_events</span><span class="p">(</span><span class="n">kong.configuration</span><span class="p">,</span> <span class="n">kong.db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">cluster_events</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">stash_init_worker_error</span><span class="p">(</span><span class="s2">&#34;failed to instantiate &#39;kong.cluster_events&#39; &#34;</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;module: &#34;</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong.cluster_events</span> <span class="o">=</span> <span class="n">cluster_events</span>
</span></span></code></pre></div><p>Worker 事件内部是使用 <strong><a href="https://github.com/Kong/lua-resty-worker-events" target="_blank" rel="noopener">lua-resty-worker-events</a></strong> 库实现的进程间事件处理，原理是通过共享内存储存事件，每秒拉取共享内存中的事件，进行处理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_GLOBAL</span><span class="p">.</span><span class="nf">init_worker_events</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Note: worker_events will not work correctly if required at the top of the file.</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--       It must be required right here, inside the init function</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">worker_events</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&#34;resty.worker.events&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">worker_events.configure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">shm</span> <span class="o">=</span> <span class="s2">&#34;kong_process_events&#34;</span><span class="p">,</span> <span class="c1">-- defined by &#34;lua_shared_dict&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>            <span class="c1">-- life time of event data in shm</span>
</span></span><span class="line"><span class="cl">    <span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>           <span class="c1">-- poll interval (seconds)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">wait_interval</span> <span class="o">=</span> <span class="mf">0.010</span><span class="p">,</span>  <span class="c1">-- wait before retry fetching event data</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait_max</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>         <span class="c1">-- max wait time before discarding event</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">worker_events</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>集群事件（多个 Kong 之间的通信）是通过将事件储存在数据库中，定时轮询数据库查询事件，进行处理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_GLOBAL</span><span class="p">.</span><span class="nf">init_cluster_events</span><span class="p">(</span><span class="n">kong_config</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">kong_cluster_events.new</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span>            <span class="o">=</span> <span class="n">db</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">poll_interval</span> <span class="o">=</span> <span class="n">kong_config.db_update_frequency</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">poll_offset</span>   <span class="o">=</span> <span class="n">kong_config.db_update_propagation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">poll_delay</span>    <span class="o">=</span> <span class="n">kong_config.db_update_propagation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>从这里可以看到集群事件是通过数据库表实现的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">:</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;channel must be a string&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;data must be a string&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">delay</span> <span class="ow">and</span> <span class="n">type</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;number&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;delay must be a number&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">elseif</span> <span class="n">self.poll_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span> <span class="o">=</span> <span class="n">self.poll_delay</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- insert event row</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">--log(DEBUG, &#34;broadcasting on channel: &#39;&#34;, channel, &#34;&#39; data: &#34;, data,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--           &#34; with delay: &#34;, delay and delay or &#34;none&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self.strategy</span><span class="p">:</span><span class="n">insert</span><span class="p">(</span><span class="n">self.node_id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">:</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">start_polling</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">error</span><span class="p">(</span><span class="s2">&#34;channel must be a string&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;function&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">error</span><span class="p">(</span><span class="s2">&#34;callback must be a function&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">self.callbacks</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">self.callbacks</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">cb</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">insert</span><span class="p">(</span><span class="n">self.channels</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">insert</span><span class="p">(</span><span class="n">self.callbacks</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">cb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">start_polling</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_polling</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">self.polling</span> <span class="ow">and</span> <span class="n">start_polling</span> <span class="ow">and</span> <span class="n">self.use_polling</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- start recurring polling timer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">timer_at</span><span class="p">(</span><span class="n">self.poll_interval</span><span class="p">,</span> <span class="n">poll_handler</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to start polling timer: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">self.polling</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>在 <code>cache.lua</code> 中集群事件订阅 cache 失效事件，内部调用 mlcache 的 delete 方法，同步到所有的 Worker 上。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self.cluster_events</span><span class="p">:</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&#34;invalidations&#34;</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s2">&#34;received invalidate event from cluster for key: &#39;&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">self</span><span class="p">:</span><span class="n">invalidate_local</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">:</span><span class="nf">invalidate_local</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shadow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span><span class="p">(</span><span class="s2">&#34;key must be a string&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">log</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s2">&#34;invalidating (local): &#39;&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">current_page</span> <span class="o">=</span> <span class="n">self.curr_mlcache</span> <span class="ow">or</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">delete_page</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">shadow</span> <span class="ow">and</span> <span class="o">#</span><span class="n">self.mlcaches</span> <span class="o">==</span> <span class="mi">2</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">delete_page</span> <span class="o">=</span> <span class="n">current_page</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">or</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">delete_page</span> <span class="o">=</span> <span class="n">current_page</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self.mlcaches</span><span class="p">[</span><span class="n">delete_page</span><span class="p">]:</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;failed to delete entity from node cache: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>这部分主要描述 Kong 初始化过程中的事件相关操作，主要是初始化事件订阅，关联到 mlcache 的 IPC 进程间通信，订阅 cache 的失效事件，并关联 DAO 的事件发布。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DB</span><span class="p">:</span><span class="nf">set_events_handler</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dao</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">self.daos</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">dao.events</span> <span class="o">=</span> <span class="n">events</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h2 id="4-事件分发">4. 事件分发</h2>
<p>Kong 中众多部分通过非阻塞的 <code>ngx.timer.at()</code> 和 <code>ngx.timer.every()</code> 函数执行定时任务。这一部分较为分散，主要叙述 Kong 执行非阻塞一次性事件处理，和典型的定时任务。</p>
<h3 id="41-单次任务">4.1. 单次任务</h3>
<h4 id="411-dns-解析">4.1.1. DNS 解析</h4>
<p>在 <code>cache_warmup.lua</code> 中缓存 services 对象时，Kong 会非阻塞地获取 services 中 host 对应的 IP。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">entity_name</span> <span class="o">==</span> <span class="s2">&#34;services&#34;</span> <span class="ow">and</span> <span class="n">host_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ngx.timer</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">warmup_dns</span><span class="p">,</span> <span class="n">hosts_array</span><span class="p">,</span> <span class="n">host_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">warmup_dns</span><span class="p">(</span><span class="n">premature</span><span class="p">,</span> <span class="n">hosts</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">premature</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.NOTICE</span><span class="p">,</span> <span class="s2">&#34;warming up DNS entries ...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ngx.now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">kong.dns</span><span class="p">.</span><span class="n">toip</span><span class="p">(</span><span class="n">hosts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">((</span><span class="n">ngx.now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.NOTICE</span><span class="p">,</span> <span class="s2">&#34;finished warming up DNS entries&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;&#39; into the cache (in &#34;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span> <span class="s2">&#34;ms)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>Kong 内部 dns 模块使用 <strong><a href="https://github.com/Kong/lua-resty-dns-client" target="_blank" rel="noopener">lua-resty-dns-client</a></strong>，这个库也是由 Kong 开源的，<code>toip</code> 函数会根据 DNS 返回 ip 的权重配置加权轮询的权重，储存 DNS 查询的结果在内存中。</p>
<p><code>warmup_dns()</code> 内调用 <code>kong.dns.toip()</code> 方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">warmup_dns</span><span class="p">(</span><span class="n">premature</span><span class="p">,</span> <span class="n">hosts</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">premature</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.NOTICE</span><span class="p">,</span> <span class="s2">&#34;warming up DNS entries ...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ngx.now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">kong.dns</span><span class="p">.</span><span class="n">toip</span><span class="p">(</span><span class="n">hosts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">((</span><span class="n">ngx.now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.NOTICE</span><span class="p">,</span> <span class="s2">&#34;finished warming up DNS entries&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;&#39; into the cache (in &#34;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span> <span class="s2">&#34;ms)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="42-定时任务">4.2. 定时任务</h3>
<h4 id="421-集群任务">4.2.1. 集群任务</h4>
<p><code>cluster_events/init.lua</code> 中集群事情订阅函数里启用定时器轮询数据库集群事件表。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">:</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">start_polling</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">error</span><span class="p">(</span><span class="s2">&#34;channel must be a string&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;function&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">error</span><span class="p">(</span><span class="s2">&#34;callback must be a function&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">self.callbacks</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">self.callbacks</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">cb</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">insert</span><span class="p">(</span><span class="n">self.channels</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">insert</span><span class="p">(</span><span class="n">self.callbacks</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">cb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">start_polling</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_polling</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">self.polling</span> <span class="ow">and</span> <span class="n">start_polling</span> <span class="ow">and</span> <span class="n">self.use_polling</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- start recurring polling timer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">timer_at</span><span class="p">(</span><span class="n">self.poll_interval</span><span class="p">,</span> <span class="n">poll_handler</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to start polling timer: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">self.polling</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>这里因为要在每次循环调用时进行锁的判断，所以没有使用 <code>ngx.timer.every()</code> 函数，而是循环调用 <code>ngx.timer.at()</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">poll_handler</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">premature</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">premature</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">self.polling</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- set self.polling to false to stop a polling loop</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">get_lock</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">timer_at</span><span class="p">(</span><span class="n">self.poll_interval</span><span class="p">,</span> <span class="n">poll_handler</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">CRIT</span><span class="p">,</span> <span class="s2">&#34;failed to start recurring polling timer: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- single worker</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">pok</span><span class="p">,</span> <span class="n">perr</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">pcall</span><span class="p">(</span><span class="n">poll</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">pok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;poll() threw an error: &#34;</span><span class="p">,</span> <span class="n">perr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">elseif</span> <span class="ow">not</span> <span class="n">perr</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;failed to poll: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- unlock</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">self.shm</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="n">POLL_RUNNING_LOCK_KEY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">timer_at</span><span class="p">(</span><span class="n">self.poll_interval</span><span class="p">,</span> <span class="n">poll_handler</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">CRIT</span><span class="p">,</span> <span class="s2">&#34;failed to start recurring polling timer: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>锁通过共享内存事件，保证只有一个 Worker 执行单次任务。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">get_lock</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- check if a poll is not currently running, to ensure we don&#39;t start</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- another poll while a worker is still stuck in its own polling (in</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- case it is being slow)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- we still add an exptime to this lock in case something goes horribly</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- wrong, to ensure other workers can poll new events</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- a poll cannot take more than max(poll_interval * 5, 10) -- 10s min</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self.shm</span><span class="p">:</span><span class="n">safe_add</span><span class="p">(</span><span class="n">POLL_RUNNING_LOCK_KEY</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">max</span><span class="p">(</span><span class="n">self.poll_interval</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">err</span> <span class="o">~=</span> <span class="s2">&#34;exists&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;failed to acquire poll_running lock: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- else</span>
</span></span><span class="line"><span class="cl">    <span class="c1">--   log(DEBUG, &#34;failed to acquire poll_running lock: &#34;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">--              &#34;a worker still holds the lock&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">self.poll_interval</span> <span class="o">&gt;</span> <span class="mf">0.001</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- check if interval of `poll_interval` has elapsed already, to ensure</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- we do not run the poll when a previous poll was quickly executed, but</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- another worker got the timer trigger a bit too late.</span>
</span></span><span class="line"><span class="cl">    <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self.shm</span><span class="p">:</span><span class="n">safe_add</span><span class="p">(</span><span class="n">POLL_INTERVAL_LOCK_KEY</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">self.poll_interval</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err</span> <span class="o">~=</span> <span class="s2">&#34;exists&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;failed to acquire poll_interval lock: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- else</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--   log(DEBUG, &#34;failed to acquire poll_interval lock: &#34;,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--              &#34;not enough time elapsed since last poll&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">self.shm</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="n">POLL_RUNNING_LOCK_KEY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h4 id="422-数据库-ttl">4.2.2. 数据库 TTL</h4>
<p>为给 PostgreSQL 加上 TTL，Kong 在 <code>init_worker</code> 阶段调用数据库层 <code>db/strategies/postgres/connector.lua</code> 中 <code>init_worker()</code> 函数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 以下省略部分内容，只展示关键部分</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_mt</span><span class="p">:</span><span class="nf">init_worker</span><span class="p">(</span><span class="n">strategies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">ngx.worker</span><span class="p">.</span><span class="n">id</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">cleanup_statements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">concat</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;  DELETE FROM &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">self</span><span class="p">:</span><span class="n">escape_identifier</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34; WHERE &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">column_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34; &lt; CURRENT_TIMESTAMP AT TIME ZONE &#39;UTC&#39;;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cleanup_statement</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">cleanup_statements</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">timer_every</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">premature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num_queries</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">query</span><span class="p">(</span><span class="n">cleanup_statement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">num_queries</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">          <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">num_queries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cleanup_statements_count</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">cleanup_statements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">query</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">              <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="p">(</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&#34;unable to clean expired rows from table &#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">sorted_strategies</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&#34;&#39; on PostgreSQL database (&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">err</span><span class="p">,</span> <span class="s2">&#34;)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="kr">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="p">(</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&#34;unable to clean expired rows from table &#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">sorted_strategies</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&#34;&#39; on PostgreSQL database&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="kr">end</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">else</span>
</span></span><span class="line"><span class="cl">          <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;unable to clean expired rows from PostgreSQL database (&#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s2">&#34;)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>数据库初始化时新增一个 <code>timer</code>，在协程中调用回调函数，删除 TTL 过期的 rows。</p>
<h4 id="423-更新路由索引">4.2.3. 更新路由索引</h4>
<p><code>kong.init_worker()</code> 会添加定时任务，定时更新缓存。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">      <span class="c1">-- 定时重建路由缓存</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">kong.db</span><span class="p">.</span><span class="n">strategy</span> <span class="o">~=</span> <span class="s2">&#34;off&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">timer_every</span><span class="p">(</span><span class="n">worker_state_update_frequency</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">premature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="n">premature</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">-- Don&#39;t wait for the semaphore (timeout = 0) when updating via the</span>
</span></span><span class="line"><span class="cl">          <span class="c1">-- timer.</span>
</span></span><span class="line"><span class="cl">          <span class="c1">-- If the semaphore is locked, that means that the rebuild is</span>
</span></span><span class="line"><span class="cl">          <span class="c1">-- already ongoing.</span>
</span></span><span class="line"><span class="cl">          <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rebuild_router</span><span class="p">(</span><span class="n">ROUTER_ASYNC_OPTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not rebuild router via timer: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timer_every</span><span class="p">(</span><span class="n">worker_state_update_frequency</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">premature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="n">premature</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rebuild_plugins_iterator</span><span class="p">(</span><span class="n">PLUGINS_ITERATOR_ASYNC_OPTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not rebuild plugins iterator via timer: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span></code></pre></div><p>实际调用顺序是开一个 cosocket 协程，判断 routes 是否有变化，变化则重构路由缓存。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="n">rebuild_router</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">rebuild</span><span class="p">(</span><span class="s2">&#34;router&#34;</span><span class="p">,</span> <span class="n">update_router</span><span class="p">,</span> <span class="n">router_version</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">rebuild</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">current_version</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong.core_cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">name</span> <span class="o">..</span> <span class="s2">&#34;:version&#34;</span><span class="p">,</span> <span class="n">TTL_ZERO</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">utils.uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to retrieve &#34;</span> <span class="o">..</span> <span class="n">name</span> <span class="o">..</span> <span class="s2">&#34; version: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">current_version</span> <span class="o">==</span> <span class="n">version</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">  <span class="c1">-- 开一个 cosocket 协程调用 callback</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">concurrency.with_coroutine_mutex</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">update_router</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- we might not need to rebuild the router (if we were not</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- the first request in this process to enter this code path)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- check again and rebuild only if necessary</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">version</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_router_version</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to retrieve router version: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">router_version</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">build_router</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="cm">--[[ &#39;err&#39; fully formatted ]]</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p>最终还会调用到 <code>build_router()</code> 方法，我们已经在 1.2.1 中描述过。</p>
<h2 id="5-事件处理">5. 事件处理</h2>
<p>Worker 间的事件处理使用 <code>lua-resty-worker-events</code> 库。</p>
<p>事件订阅函数：<code>events.register(callback, source, event1, event2, ...)</code>，callback 方法 <code>callback = function(data, event, source, pid)</code>。</p>
<p>事件发布函数：<code>success, err = events.post(source, event, data, unique)</code></p>
<h3 id="51-数据库事件">5.1. 数据库事件</h3>
<p><code>db/dao/init.lua</code> 中定义了 DAO 相关的操作方法，我已经在 1.1.3 中简单阐述过了。</p>
<p>数据库相关实体的 CRUD 事件最后会调用 <code>DAO:post_crud_event()</code> 方法广播事件。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">DAO</span><span class="p">:</span><span class="nf">post_crud_event</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">old_entity</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">options.no_broadcast_crud_event</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">self.events</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">entity_without_nulls</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">entity</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">entity_without_nulls</span> <span class="o">=</span> <span class="n">remove_nulls</span><span class="p">(</span><span class="n">utils.deep_copy</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">old_entity_without_nulls</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">old_entity</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">old_entity_without_nulls</span> <span class="o">=</span> <span class="n">remove_nulls</span><span class="p">(</span><span class="n">utils.deep_copy</span><span class="p">(</span><span class="n">old_entity</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">self.events</span><span class="p">.</span><span class="n">post_local</span><span class="p">(</span><span class="s2">&#34;dao:crud&#34;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">operation</span>  <span class="o">=</span> <span class="n">operation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">schema</span>     <span class="o">=</span> <span class="n">self.schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">entity</span>     <span class="o">=</span> <span class="n">entity_without_nulls</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">old_entity</span> <span class="o">=</span> <span class="n">old_entity_without_nulls</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;[db] failed to propagate CRUD operation: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>在 <code>dao:crud</code> 通道发布了一个事件，operation 类型有 create、update、delete。</p>
<p><code>runloop/handler.lua</code> 中 <code>register_events()</code> 会在 <code>kong.init_worker()</code> 中被调用，此时会订阅数据库相关事件，添加处理函数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="n">worker_events.register</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">data.schema</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;[events] missing schema in crud subscriber&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">data.entity</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;[events] missing entity in crud subscriber&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- invalidate this entity anywhere it is cached if it has a</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- caching key</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 如果 entity 有 cache_key 则让它失效</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 基本上也只有 entity schema 定义出错的情况下才不会有 cache_key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">data.schema</span><span class="p">.</span><span class="n">name</span><span class="p">]:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">data.entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cache_obj</span> <span class="o">=</span> <span class="n">kong</span><span class="p">[</span><span class="n">constants.ENTITY_CACHE_STORE</span><span class="p">[</span><span class="n">data.schema</span><span class="p">.</span><span class="n">name</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">cache_key</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">cache_obj</span><span class="p">:</span><span class="n">invalidate</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- if we had an update, but the cache key was part of what was updated,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- we need to invalidate the previous entity as well</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">data.old_entity</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">old_cache_key</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">data.schema</span><span class="p">.</span><span class="n">name</span><span class="p">]:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">data.old_entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">old_cache_key</span> <span class="ow">and</span> <span class="n">cache_key</span> <span class="o">~=</span> <span class="n">old_cache_key</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache_obj</span><span class="p">:</span><span class="n">invalidate</span><span class="p">(</span><span class="n">old_cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">data.operation</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;[events] missing operation in crud subscriber&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- public worker events propagation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 获取 schema 名字</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">entity_channel</span>           <span class="o">=</span> <span class="n">data.schema</span><span class="p">.</span><span class="n">table</span> <span class="ow">or</span> <span class="n">data.schema</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">entity_operation_channel</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">(</span><span class="s2">&#34;%s:%s&#34;</span><span class="p">,</span> <span class="n">entity_channel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">data.operation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- crud:routes</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">worker_events.post_local</span><span class="p">(</span><span class="s2">&#34;crud&#34;</span><span class="p">,</span> <span class="n">entity_channel</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;[events] could not broadcast crud event: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- crud:routes:create</span>
</span></span><span class="line"><span class="cl">    <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">worker_events.post_local</span><span class="p">(</span><span class="s2">&#34;crud&#34;</span><span class="p">,</span> <span class="n">entity_operation_channel</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;[events] could not broadcast crud event: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span><span class="p">,</span> <span class="s2">&#34;dao:crud&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>CRUD 事件处理流程：调用 <code>cache:invalidate()</code> 方法，方法内部发布了一个 worker 级事件，通知 worker 进程删除该数据，还会发布一个集群事件，在集群间同步删除数据。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- 修改了 Routes 后会清空 router:version 缓存，</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 会导致重新构建路由表，详情查看 2.2.3</span>
</span></span><span class="line"><span class="cl">  <span class="n">worker_events.register</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s2">&#34;[events] Route updated, invalidating router&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">core_cache</span><span class="p">:</span><span class="n">invalidate</span><span class="p">(</span><span class="s2">&#34;router:version&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span><span class="p">,</span> <span class="s2">&#34;crud&#34;</span><span class="p">,</span> <span class="s2">&#34;routes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span><span class="err">其他对象同理</span>
</span></span></code></pre></div><h2 id="6-插件加载">6. 插件加载</h2>
<h3 id="61-插件读取">6.1. 插件读取</h3>
<p><code>init</code> 阶段会加载配置文件中 <code>plugins=bundled,skywalking-intergrator</code> 的插件列表，调用 Lua <code>require</code> 加载对应的包。（所有的插件包都要求在 <code>kong.plugins</code> 下）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">Plugins</span><span class="p">:</span><span class="nf">load_plugin_schemas</span><span class="p">(</span><span class="n">plugin_set</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">self.handlers</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">go_plugins_cnt</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">errs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- load installed plugins</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">plugin</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">plugin_set</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">handler</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">load_plugin</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">handler</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">handler.is</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;function&#34;</span> <span class="ow">and</span> <span class="n">handler</span><span class="p">:</span><span class="n">is</span><span class="p">(</span><span class="n">BasePlugin</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- Backwards-compatibility for 0.x and 1.x plugins inheriting from the</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- BasePlugin class.</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- TODO: deprecate &amp; remove</span>
</span></span><span class="line"><span class="cl">        <span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">handler._go</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">go_plugins_cnt</span> <span class="o">=</span> <span class="n">go_plugins_cnt</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">handlers</span><span class="p">[</span><span class="n">plugin</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">      <span class="n">errs</span> <span class="o">=</span> <span class="n">errs</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="n">table.insert</span><span class="p">(</span><span class="n">errs</span><span class="p">,</span> <span class="s2">&#34;on plugin &#39;&#34;</span> <span class="o">..</span> <span class="n">plugin</span> <span class="o">..</span> <span class="s2">&#34;&#39;: &#34;</span> <span class="o">..</span> <span class="n">tostring</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">errs</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;error loading plugin schemas: &#34;</span> <span class="o">..</span> <span class="n">table.concat</span><span class="p">(</span><span class="n">errs</span><span class="p">,</span> <span class="s2">&#34;; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">reports.add_immutable_value</span><span class="p">(</span><span class="s2">&#34;go_plugins_cnt&#34;</span><span class="p">,</span> <span class="n">go_plugins_cnt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">self.handlers</span> <span class="o">=</span> <span class="n">handlers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>所有插件的 Handler 函数会被储存在 <code>kong.db.plugins.handlers</code>，数据格式为 <code>{plugin_name: handler}</code>。</p>
<p>所有的插件会储存到 Worker 进程上，周期性进行同步更新。</p>
<p>我整理了插件表加载到 Lua table 的结构，输出成 YAML，方便理解：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">map</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">plugin_name</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">combos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">plugin_name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># both: {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">both</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">route_id</span><span class="p">:</span><span class="w"> </span><span class="l">service_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># routes: {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">route_id</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># services: {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">service_id</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">0</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 全局插件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">1</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 路由插件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">2</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># Service 插件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">3</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 路由+Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">4</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># Consumer 插件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">5</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 路由+Consumer 插件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">6</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 路由+Service+Consumer 插件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">loaded</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">plugin_name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">handler</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">phase_name</span><span class="p">:</span><span class="w"> </span><span class="l">func()</span><span class="w">
</span></span></span></code></pre></div><h3 id="62-插件调用">6.2. 插件调用</h3>
<p>插件不直接和路由进行绑定，插件有自己的生命周期，和 Kong 的生命周期基本相同。在 Kong 生命周期的各个阶段会调用插件的对应方法。</p>
<p>插件只在调用阶段进行判断，是否关联当前 Route、Service、和 Consumer，有则从数据库读取插件关联的配置项（插件 Entity），并使用 <code>kong.core_cache</code> 进行缓存。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">load_configuration_through_combos</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">combos</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">plugin_configuration</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">name</span> <span class="o">=</span> <span class="n">plugin.name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">route</span>    <span class="o">=</span> <span class="n">ctx.route</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">service</span>  <span class="o">=</span> <span class="n">ctx.service</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">ctx.authenticated_consumer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">route</span> <span class="ow">and</span> <span class="n">plugin.no_route</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">service</span> <span class="ow">and</span> <span class="n">plugin.no_service</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">consumer</span> <span class="ow">and</span> <span class="n">plugin.no_consumer</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">consumer</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span>    <span class="n">route_id</span> <span class="o">=</span> <span class="n">route</span>    <span class="ow">and</span>    <span class="n">route.id</span> <span class="ow">or</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span>  <span class="n">service_id</span> <span class="o">=</span> <span class="n">service</span>  <span class="ow">and</span>  <span class="n">service.id</span> <span class="ow">or</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">consumer_id</span> <span class="o">=</span> <span class="n">consumer</span> <span class="ow">and</span> <span class="n">consumer.id</span> <span class="ow">or</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">kong.db</span><span class="p">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&#34;off&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">route_id</span> <span class="ow">and</span> <span class="n">service_id</span> <span class="ow">and</span> <span class="n">consumer_id</span> <span class="ow">and</span> <span class="n">combos</span><span class="p">[</span><span class="n">COMBO_RSC</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="ow">and</span> <span class="n">combos.both</span><span class="p">[</span><span class="n">route_id</span><span class="p">]</span> <span class="o">==</span> <span class="n">service_id</span>
</span></span><span class="line"><span class="cl">    <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">plugin_configuration</span> <span class="o">=</span> <span class="n">load_configuration</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">route_id</span><span class="p">,</span> <span class="n">service_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">consumer_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">plugin_configuration</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">plugin_configuration</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">consumer_id</span> <span class="ow">and</span> <span class="n">combos</span><span class="p">[</span><span class="n">COMBO_C</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">plugin_configuration</span> <span class="o">=</span> <span class="n">load_configuration</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">consumer_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">plugin_configuration</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">plugin_configuration</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">route_id</span> <span class="ow">and</span> <span class="n">combos</span><span class="p">[</span><span class="n">COMBO_R</span><span class="p">]</span> <span class="ow">and</span> <span class="n">combos.routes</span><span class="p">[</span><span class="n">route_id</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">plugin_configuration</span> <span class="o">=</span> <span class="n">load_configuration</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">route_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">plugin_configuration</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">plugin_configuration</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">combos</span><span class="p">[</span><span class="n">COMBO_GLOBAL</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="n">load_configuration</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>这里会查询当前 Service、Route 和 Consumer 是否与某个插件配对，成功则加载对应的配置项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">--- Load the configuration for a plugin entry.</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Given a Route, Service, Consumer and a plugin name, retrieve the plugin&#39;s</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- configuration if it exists. Results are cached in ngx.dict</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @param[type=string] name Name of the plugin being tested for configuration.</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @param[type=string] route_id Id of the route being proxied.</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @param[type=string] service_id Id of the service being proxied.</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @param[type=string] consumer_id Id of the donsumer making the request (if any).</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @treturn table Plugin configuration, if retrieved.</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">load_configuration</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">route_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">service_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">consumer_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ws_id</span> <span class="o">=</span> <span class="n">workspaces.get_workspace_id</span><span class="p">()</span> <span class="ow">or</span> <span class="n">kong.default_workspace</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">key</span> <span class="o">=</span> <span class="n">kong.db</span><span class="p">.</span><span class="n">plugins</span><span class="p">:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">route_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">service_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">consumer_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">ws_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong.core_cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">load_plugin_from_db</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.delay_response</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.ERR</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="n">ngx.ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">plugin</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">plugin.enabled</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">plugin.config</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">cfg.__key__</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">cfg.__key__</span> <span class="o">=</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">    <span class="n">cfg.__seq__</span> <span class="o">=</span> <span class="n">next_seq</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_seq</span> <span class="o">=</span> <span class="n">next_seq</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">cfg.route_id</span>    <span class="o">=</span> <span class="n">plugin.route</span> <span class="ow">and</span> <span class="n">plugin.route</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">  <span class="n">cfg.service_id</span>  <span class="o">=</span> <span class="n">plugin.service</span> <span class="ow">and</span> <span class="n">plugin.service</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">  <span class="n">cfg.consumer_id</span> <span class="o">=</span> <span class="n">plugin.consumer</span> <span class="ow">and</span> <span class="n">plugin.consumer</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">cfg</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>插件的调用有两种方式：</p>
<ol>
<li>同步调用</li>
<li>异步调用</li>
</ol>
<p>除了 <code>access_by_lua</code> 阶段，都是使用同步调用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">execute_plugins_iterator</span><span class="p">(</span><span class="n">plugins_iterator</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">old_ws</span> <span class="o">=</span> <span class="n">ctx</span> <span class="ow">and</span> <span class="n">ctx.workspace</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">configuration</span> <span class="kr">in</span> <span class="n">plugins_iterator</span><span class="p">:</span><span class="n">iterate</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">ctx</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">plugin.handler</span><span class="p">.</span><span class="n">_go</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx.ran_go_plugin</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">kong_global.set_named_ctx</span><span class="p">(</span><span class="n">kong</span><span class="p">,</span> <span class="s2">&#34;plugin&#34;</span><span class="p">,</span> <span class="n">plugin.handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">kong_global.set_namespaced_log</span><span class="p">(</span><span class="n">kong</span><span class="p">,</span> <span class="n">plugin.name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 这里是同步调用</span>
</span></span><span class="line"><span class="cl">    <span class="n">plugin.handler</span><span class="p">[</span><span class="n">phase</span><span class="p">](</span><span class="n">plugin.handler</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">kong_global.reset_log</span><span class="p">(</span><span class="n">kong</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">ctx</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">ctx.workspace</span> <span class="o">=</span> <span class="n">old_ws</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>而在 <code>access_by_lua</code> 阶段，使用协程异步调用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">plugin_conf</span> <span class="kr">in</span> <span class="n">plugins_iterator</span><span class="p">:</span><span class="n">iterate</span><span class="p">(</span><span class="s2">&#34;access&#34;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">plugin.handler</span><span class="p">.</span><span class="n">_go</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">ctx.ran_go_plugin</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ctx.delayed_response</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">kong_global.set_named_ctx</span><span class="p">(</span><span class="n">kong</span><span class="p">,</span> <span class="s2">&#34;plugin&#34;</span><span class="p">,</span> <span class="n">plugin.handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">kong_global.set_namespaced_log</span><span class="p">(</span><span class="n">kong</span><span class="p">,</span> <span class="n">plugin.name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- 使用 Lua coroutine 开启协程异步调用插件函数</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">err</span> <span class="o">=</span> <span class="n">coroutine.wrap</span><span class="p">(</span><span class="n">plugin.handler</span><span class="p">.</span><span class="n">access</span><span class="p">)(</span><span class="n">plugin.handler</span><span class="p">,</span> <span class="n">plugin_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">kong.log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx.delayed_response</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">content</span>     <span class="o">=</span> <span class="p">{</span> <span class="n">message</span>  <span class="o">=</span> <span class="s2">&#34;An unexpected error occurred&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">kong_global.reset_log</span><span class="p">(</span><span class="n">kong</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.workspace</span> <span class="o">=</span> <span class="n">old_ws</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><h2 id="7-缓存机制">7. 缓存机制</h2>
<p>本节根据我对 Kong 源码的分析，做一个缓存机制的小回顾。</p>
<p>Kong 针对缓存有这些操作：</p>
<ul>
<li>初始化缓存块</li>
<li>预载加载数据库内容到缓存</li>
<li>访问时才加载的数据内容添加到缓存</li>
<li>timer 定时更新缓存</li>
<li>数据库 CRUD 操作删除缓存</li>
<li>集群/Worker 间同步缓存</li>
</ul>
<p>缓存加载内容：</p>
<p>默认配置下，Kong 将路由表和 Routes 全量加载到每个 Worker 的内存，Services 和 Plugins 全量加载到每个 Worker 的内存和共享内存中。Upstreams 和 Targets 根据负载均衡器的解析及时从数据库获取，加载到内存和共享内存中。</p>
<p>上述 Entity 加载在由 mlcache 库创建的 L1+L2 两级缓存 <code>core_cache</code> 中。</p>
<p>而 consumers 加载到同为 mlcache 创建的不同名的 <code>cache</code> 中。</p>
<h2 id="8-请求生命周期">8. 请求生命周期</h2>
<p>本节讲述一个请求经过 Kong 处理的流程。</p>
<h3 id="81-ssl_certificate_by_lua-阶段">8.1. ssl_certificate_by_lua 阶段</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">execute</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">sn</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">server_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not retrieve SNI: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="n">ngx.ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">cert_and_key</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">find_certificate</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="n">ngx.ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">cert_and_key</span> <span class="o">==</span> <span class="n">default_cert_and_key</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- use (already set) fallback certificate</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- set the certificate for this connection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">clear_certs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not clear existing (default) certificates: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="n">ngx.ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">set_cert</span><span class="p">(</span><span class="n">cert_and_key.cert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not set configured certificate: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="n">ngx.ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">set_priv_key</span><span class="p">(</span><span class="n">cert_and_key.key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not set configured private key: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="n">ngx.ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>根据 Server Name 查找对应 SSL 证书 Cert 和私钥并设置在 Nginx 上。</p>
<h3 id="82-rewrite_by_lua-阶段">8.2. rewrite_by_lua 阶段</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ngx.ctx</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ctx.KONG_PROCESSING_START</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.KONG_PROCESSING_START</span> <span class="o">=</span> <span class="n">ngx.req</span><span class="p">.</span><span class="n">start_time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ctx.KONG_REWRITE_START</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.KONG_REWRITE_START</span> <span class="o">=</span> <span class="n">get_now_ms</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">kong_global.set_phase</span><span class="p">(</span><span class="n">kong</span><span class="p">,</span> <span class="n">PHASES.rewrite</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong_resty_ctx.stash_ref</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">is_https</span> <span class="o">=</span> <span class="n">var.https</span> <span class="o">==</span> <span class="s2">&#34;on&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">is_https</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_init_worker_errors</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">runloop.rewrite</span><span class="p">.</span><span class="n">before</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">rewrite</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">before</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">ctx.host_port</span> <span class="o">=</span> <span class="n">HOST_PORTS</span><span class="p">[</span><span class="n">var.server_port</span><span class="p">]</span> <span class="ow">or</span> <span class="n">var.server_port</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- special handling for proxy-authorization and te headers in case</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- the plugin(s) want to specify them (store the original)</span>
</span></span><span class="line"><span class="cl">      <span class="n">ctx.http_proxy_authorization</span> <span class="o">=</span> <span class="n">var.http_proxy_authorization</span>
</span></span><span class="line"><span class="cl">      <span class="n">ctx.http_te</span>                  <span class="o">=</span> <span class="n">var.http_te</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span></code></pre></div><p>初始化 <code>kong.ctx</code> 生命周期 Context，为 Context 添加请求信息。</p>
<h3 id="83-access_by_lua-阶段">8.3. access_by_lua 阶段</h3>
<h4 id="831-路由匹配">8.3.1. 路由匹配</h4>
<p><code>runloop.access.before</code> 会进行调用 <code>Router</code> 实例进行路由匹配。首先会调用 <code>get_updated_router()</code> 判断是否有路由更新，没有则返回当前 <code>Router</code> 实例。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">      <span class="c1">-- routing request</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">router</span> <span class="o">=</span> <span class="n">get_updated_router</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	  <span class="c1">-- 调用 Router.exec() 查找匹配的路由</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">match_t</span> <span class="o">=</span> <span class="n">router.exec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">match_t</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">kong.response</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="p">{</span> <span class="n">message</span> <span class="o">=</span> <span class="s2">&#34;no Route matched with those values&#34;</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span></code></pre></div><p><code>Router.exec()</code> 方法最终会调用 <code>Router.find_route()</code> 方法，该方法接收请求头字段，并生成路由 Cache Key，查找对应的项目。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">find_route</span><span class="p">(</span><span class="n">req_method</span><span class="p">,</span> <span class="n">req_uri</span><span class="p">,</span> <span class="n">req_host</span><span class="p">,</span> <span class="n">req_scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">src_ip</span><span class="p">,</span> <span class="n">src_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">dst_ip</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">sni</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">req_method</span> <span class="o">=</span> <span class="n">req_method</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req_uri</span> <span class="o">=</span> <span class="n">req_uri</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req_host</span> <span class="o">=</span> <span class="n">req_host</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">req_headers</span> <span class="o">=</span> <span class="n">req_headers</span> <span class="ow">or</span> <span class="n">EMPTY_T</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ctx.req_method</span>     <span class="o">=</span> <span class="n">req_method</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.req_uri</span>        <span class="o">=</span> <span class="n">req_uri</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.req_host</span>       <span class="o">=</span> <span class="n">req_host</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.req_headers</span>    <span class="o">=</span> <span class="n">req_headers</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.src_ip</span>         <span class="o">=</span> <span class="n">src_ip</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.src_port</span>       <span class="o">=</span> <span class="n">src_port</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.dst_ip</span>         <span class="o">=</span> <span class="n">dst_ip</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.dst_port</span>       <span class="o">=</span> <span class="n">dst_port</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.sni</span>            <span class="o">=</span> <span class="n">sni</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">req_method</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">req_uri</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">req_host</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.src_ip</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.src_port</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.dst_ip</span> <span class="o">..</span> <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.dst_port</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;|&#34;</span> <span class="o">..</span> <span class="n">ctx.sni</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">match_t</span> <span class="o">=</span> <span class="n">cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">match_t</span> <span class="ow">and</span> <span class="n">hits.header_name</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">match_t</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span></code></pre></div><p>如果 LRU 缓存中有匹配路由，则直接返回。</p>
<p>否则继续匹配路由，生成匹配项目，并存入缓存中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">              <span class="p">...</span>
</span></span><span class="line"><span class="cl">              <span class="kd">local</span> <span class="n">match_t</span>     <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">route</span>           <span class="o">=</span> <span class="n">matched_route.route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">service</span>         <span class="o">=</span> <span class="n">matched_route.service</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">headers</span>         <span class="o">=</span> <span class="n">matched_route.headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">upstream_url_t</span>  <span class="o">=</span> <span class="n">upstream_url_t</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">upstream_scheme</span> <span class="o">=</span> <span class="n">upstream_url_t.scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">upstream_uri</span>    <span class="o">=</span> <span class="n">upstream_uri</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">upstream_host</span>   <span class="o">=</span> <span class="n">upstream_host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">prefix</span>          <span class="o">=</span> <span class="n">request_prefix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">matches</span>         <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">uri_captures</span>  <span class="o">=</span> <span class="n">matches.uri_captures</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">uri</span>           <span class="o">=</span> <span class="n">matches.uri</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">host</span>          <span class="o">=</span> <span class="n">matches.host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">headers</span>       <span class="o">=</span> <span class="n">matches.headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">method</span>        <span class="o">=</span> <span class="n">matches.method</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">src_ip</span>        <span class="o">=</span> <span class="n">matches.src_ip</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">src_port</span>      <span class="o">=</span> <span class="n">matches.src_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dst_ip</span>        <span class="o">=</span> <span class="n">matches.dst_ip</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dst_port</span>      <span class="o">=</span> <span class="n">matches.dst_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sni</span>           <span class="o">=</span> <span class="n">matches.sni</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="n">band</span><span class="p">(</span><span class="n">matched_route.match_rules</span><span class="p">,</span> <span class="n">MATCH_RULES.HEADER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                  <span class="n">cache</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">match_t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">                <span class="p">...</span>
</span></span></code></pre></div><p>匹配成功后会将关联的 Route 和 Service 写入 <code>ngx.ctx</code> ，在接下来的生命周期中共享。</p>
<h4 id="832-请求调度">8.3.2. 请求调度</h4>
<p><code>runloop.access.after</code> 中根据 Route、Service 等条件解析出后端要请求的 IP、Port、Schema 等参数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- looks up a balancer for the target.</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @param target the table with the target details</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @param no_create (optional) if true, do not attempt to create</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- (for thorough testing purposes)</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- @return balancer if found, `false` if not found, or nil+error on error</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">get_balancer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">no_create</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- NOTE: only called upon first lookup, so `cache_only` limitations</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- do not apply here</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">target.host</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- first go and find the upstream object, from cache or the db</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_upstream_by_name</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">upstream</span> <span class="o">==</span> <span class="kc">false</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">false</span> <span class="c1">-- no upstream by this name</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span> <span class="c1">-- there was an error</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">balancer</span> <span class="o">=</span> <span class="n">balancers</span><span class="p">[</span><span class="n">upstream.id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">balancer</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">no_create</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;balancer not found&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;balancer not found for &#34;</span><span class="p">,</span> <span class="n">upstream.name</span><span class="p">,</span> <span class="s2">&#34;, will create it&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="n">create_balancer</span><span class="p">(</span><span class="n">upstream</span><span class="p">),</span> <span class="n">upstream</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">balancer</span><span class="p">,</span> <span class="n">upstream</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>get_balancer()</code> 根据 Service 的 Host 返回最终请求的 Target，和负载均衡器。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">handle</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">balancer</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- have to invoke the ring-balancer</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">hstate</span> <span class="o">=</span> <span class="n">run_hook</span><span class="p">(</span><span class="s2">&#34;balancer:get_peer:pre&#34;</span><span class="p">,</span> <span class="n">target.host</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">balancer</span><span class="p">:</span><span class="n">getPeer</span><span class="p">(</span><span class="n">dns_cache_only</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">target.balancer_handle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">hash_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_hook</span><span class="p">(</span><span class="s2">&#34;balancer:get_peer:post&#34;</span><span class="p">,</span> <span class="n">hstate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ip</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="s2">&#34;No peers are available&#34;</span> <span class="ow">or</span> <span class="n">port</span> <span class="o">==</span> <span class="s2">&#34;Balancer is unhealthy&#34;</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failure to get a peer from the ring-balancer&#34;</span><span class="p">,</span> <span class="mi">503</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span> <span class="ow">or</span> <span class="n">ip</span>
</span></span><span class="line"><span class="cl">    <span class="n">target.hash_value</span> <span class="o">=</span> <span class="n">hash_value</span>
</span></span><span class="line"><span class="cl">    <span class="n">target.balancer_handle</span> <span class="o">=</span> <span class="n">handle</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- have to do a regular DNS lookup</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">try_list</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">hstate</span> <span class="o">=</span> <span class="n">run_hook</span><span class="p">(</span><span class="s2">&#34;balancer:to_ip:pre&#34;</span><span class="p">,</span> <span class="n">target.host</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">try_list</span> <span class="o">=</span> <span class="n">toip</span><span class="p">(</span><span class="n">target.host</span><span class="p">,</span> <span class="n">target.port</span><span class="p">,</span> <span class="n">dns_cache_only</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_hook</span><span class="p">(</span><span class="s2">&#34;balancer:to_ip:post&#34;</span><span class="p">,</span> <span class="n">hstate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hostname</span> <span class="o">=</span> <span class="n">target.host</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ip</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;DNS resolution failed: &#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s2">&#34;. Tried: &#34;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">try_list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">port</span> <span class="o">==</span> <span class="s2">&#34;dns server error: 3 name error&#34;</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">         <span class="n">port</span> <span class="o">==</span> <span class="s2">&#34;dns client error: 101 empty record received&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;name resolution failed&#34;</span><span class="p">,</span> <span class="mi">503</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p>调用负载均衡器的策略获取 Target 的 IP，或者直接使用 DNS 查询获取 IP 地址，这一步在 2.1.1 中已经提前进行了 DNS 预缓存，这里可以从缓存中读取。</p>
<p>如果 Service Host 直接是 IP 地址，则不执行负载均衡策略。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- ip 则直接返回</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">target.type</span> <span class="o">~=</span> <span class="s2">&#34;name&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- it&#39;s an ip address (v4 or v6), so nothing we can do...</span>
</span></span><span class="line"><span class="cl">    <span class="n">target.ip</span> <span class="o">=</span> <span class="n">target.host</span>
</span></span><span class="line"><span class="cl">    <span class="n">target.port</span> <span class="o">=</span> <span class="n">target.port</span> <span class="ow">or</span> <span class="mi">80</span> <span class="c1">-- TODO: remove this fallback value</span>
</span></span><span class="line"><span class="cl">    <span class="n">target.hostname</span> <span class="o">=</span> <span class="n">target.host</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><h3 id="84-balancer_by_lua-阶段">8.4. balancer_by_lua 阶段</h3>
<p>使用 <code>ngx.balancer.set_more_tries()</code> 设置错误重试次数，使用 <code>ngx.balancer.get_last_failure()</code> 获取上一次请求错误详情，在错误处理中进行对上游节点进行被动健康检查。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">balancer_data.try_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- only call balancer on retry, first one is done in `runloop.access.after`</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- which runs in the ACCESS context and hence has less limitations than</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- this BALANCER context where the retries are executed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- record failure data</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">previous_try</span> <span class="o">=</span> <span class="n">tries</span><span class="p">[</span><span class="n">balancer_data.try_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">previous_try.state</span><span class="p">,</span> <span class="n">previous_try.code</span> <span class="o">=</span> <span class="n">get_last_failure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- Report HTTP status for health checks</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">balancer</span> <span class="o">=</span> <span class="n">balancer_data.balancer</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">balancer</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">previous_try.state</span> <span class="o">==</span> <span class="s2">&#34;failed&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">previous_try.code</span> <span class="o">==</span> <span class="mi">504</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">          <span class="n">balancer.report_timeout</span><span class="p">(</span><span class="n">balancer_data.balancer_handle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">else</span>
</span></span><span class="line"><span class="cl">          <span class="n">balancer.report_tcp_failure</span><span class="p">(</span><span class="n">balancer_data.balancer_handle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">balancer.report_http_status</span><span class="p">(</span><span class="n">balancer_data.balancer_handle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">previous_try.code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">errcode</span> <span class="o">=</span> <span class="n">balancer_execute</span><span class="p">(</span><span class="n">balancer_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">ngx_log</span><span class="p">(</span><span class="n">ngx_ERR</span><span class="p">,</span> <span class="s2">&#34;failed to retry the dns/balancer resolver for &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">tostring</span><span class="p">(</span><span class="n">balancer_data.host</span><span class="p">),</span> <span class="s2">&#34;&#39; with: &#34;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">ctx.KONG_BALANCER_ENDED_AT</span> <span class="o">=</span> <span class="n">get_now_ms</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="n">ctx.KONG_BALANCER_TIME</span> <span class="o">=</span> <span class="n">ctx.KONG_BALANCER_ENDED_AT</span> <span class="o">-</span> <span class="n">ctx.KONG_BALANCER_START</span>
</span></span><span class="line"><span class="cl">      <span class="n">ctx.KONG_PROXY_LATENCY</span> <span class="o">=</span> <span class="n">ctx.KONG_BALANCER_ENDED_AT</span> <span class="o">-</span> <span class="n">ctx.KONG_PROCESSING_START</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="n">errcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- first try, so set the max number of retries</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">retries</span> <span class="o">=</span> <span class="n">balancer_data.retries</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">set_more_tries</span><span class="p">(</span><span class="n">retries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p>请求到最终解析的后端服务，使用 <code>ngx.balancer.set_current_peer()</code> 方法设置访问的地址。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- set the targets as resolved</span>
</span></span><span class="line"><span class="cl">  <span class="n">ngx_log</span><span class="p">(</span><span class="n">ngx_DEBUG</span><span class="p">,</span> <span class="s2">&#34;setting address (try &#34;</span><span class="p">,</span> <span class="n">balancer_data.try_count</span><span class="p">,</span> <span class="s2">&#34;): &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">balancer_data.ip</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">balancer_data.port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 最终调度的地址</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">set_current_peer</span><span class="p">(</span><span class="n">balancer_data.ip</span><span class="p">,</span> <span class="n">balancer_data.port</span><span class="p">,</span> <span class="n">pool_opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ngx_log</span><span class="p">(</span><span class="n">ngx_ERR</span><span class="p">,</span> <span class="s2">&#34;failed to set the current peer (address: &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">tostring</span><span class="p">(</span><span class="n">balancer_data.ip</span><span class="p">),</span> <span class="s2">&#34; port: &#34;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">balancer_data.port</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;): &#34;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ctx.KONG_BALANCER_ENDED_AT</span> <span class="o">=</span> <span class="n">get_now_ms</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.KONG_BALANCER_TIME</span> <span class="o">=</span> <span class="n">ctx.KONG_BALANCER_ENDED_AT</span> <span class="o">-</span> <span class="n">ctx.KONG_BALANCER_START</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.KONG_PROXY_LATENCY</span> <span class="o">=</span> <span class="n">ctx.KONG_BALANCER_ENDED_AT</span> <span class="o">-</span> <span class="n">ctx.KONG_PROCESSING_START</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">ngx.exit</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><h3 id="85-header_filter_by_lua-阶段">8.5. header_filter_by_lua 阶段</h3>
<p>此阶段在 Kong 接收完上游服务返回的 Header 字段后执行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">upstream_status_header</span> <span class="o">=</span> <span class="n">constants.HEADERS</span><span class="p">.</span><span class="n">UPSTREAM_STATUS</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">singletons.configuration</span><span class="p">.</span><span class="n">enabled_headers</span><span class="p">[</span><span class="n">upstream_status_header</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">header</span><span class="p">[</span><span class="n">upstream_status_header</span><span class="p">]</span> <span class="o">=</span> <span class="n">tonumber</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="n">var.upstream_status</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">[</span><span class="n">upstream_status_header</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">          <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;failed to set &#34;</span><span class="p">,</span> <span class="n">upstream_status_header</span><span class="p">,</span> <span class="s2">&#34; header&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">hash_cookie</span> <span class="o">=</span> <span class="n">ctx.balancer_data</span><span class="p">.</span><span class="n">hash_cookie</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">hash_cookie</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">ck</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">hash_cookie</span><span class="p">)</span>
</span></span></code></pre></div><p><code>runloop.header_filter.before</code> 中在返回结果的 header 里加入节点状态，以及判断是否需要加入负载均衡器一致性策略的 Cookie。</p>
<h3 id="86-body_filter_by_lua-阶段">8.6. body_filter_by_lua 阶段</h3>
<p>此阶段在接收上游服务返回的 Body 数据时执行，根据数据大小划分 chunks，此阶段会被执行多次。</p>
<p>在 OpenResty 的生命周期里，<code>body_filter_by_lua</code> 中使用 <code>ngx.arg[1]</code> 读取 chunk，使用 <code>ngx.arg[2]</code> 标记 EOF。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">  <span class="c1">-- 获取到了所有的 body</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">kong.ctx</span><span class="p">.</span><span class="n">core.response_body</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kong.ctx</span><span class="p">.</span><span class="n">core.response_body</span>
</span></span><span class="line"><span class="cl">    <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 获取到所有的 body 后</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 再统计执行时间</span>
</span></span><span class="line"><span class="cl">  <span class="n">ctx.KONG_BODY_FILTER_ENDED_AT</span> <span class="o">=</span> <span class="n">get_now_ms</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">ctx.KONG_BODY_FILTER_TIME</span> <span class="o">=</span> <span class="n">ctx.KONG_BODY_FILTER_ENDED_AT</span> <span class="o">-</span> <span class="n">ctx.KONG_BODY_FILTER_START</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">ctx.KONG_PROXIED</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- time spent receiving the response (header_filter + body_filter)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- we could use $upstream_response_time but we need to distinguish the waiting time</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- from the receiving time in our logging plugins (especially ALF serializer).</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.KONG_RECEIVE_TIME</span> <span class="o">=</span> <span class="n">ctx.KONG_BODY_FILTER_ENDED_AT</span> <span class="o">-</span> <span class="p">(</span><span class="n">ctx.KONG_HEADER_FILTER_START</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                                                             <span class="n">ctx.KONG_BALANCER_ENDED_AT</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                                                             <span class="n">ctx.KONG_BALANCER_START</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                                                             <span class="n">ctx.KONG_ACCESS_ENDED_AT</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="87-log_by_lua-阶段">8.7. log_by_lua 阶段</h3>
<p>调用 Lua 的垃圾回收器统计 Kong 占用内存情况：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">update_lua_mem</span>
</span></span><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">ngx.worker</span><span class="p">.</span><span class="n">pid</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">kong_shm</span> <span class="o">=</span> <span class="n">ngx.shared</span><span class="p">.</span><span class="n">kong</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">Lua_MEM_SAMPLE_RATE</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">-- seconds</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">last</span> <span class="o">=</span> <span class="n">ngx.time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">collectgarbage</span> <span class="o">=</span> <span class="n">collectgarbage</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">update_lua_mem</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">time</span> <span class="o">=</span> <span class="n">ngx.time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="n">time</span> <span class="o">-</span> <span class="n">last</span> <span class="o">&gt;=</span> <span class="n">Lua_MEM_SAMPLE_RATE</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">count</span> <span class="o">=</span> <span class="n">collectgarbage</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong_shm</span><span class="p">:</span><span class="n">safe_set</span><span class="p">(</span><span class="s2">&#34;kong:mem:&#34;</span> <span class="o">..</span> <span class="n">pid</span><span class="p">(),</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="p">(</span><span class="n">ERR</span><span class="p">,</span> <span class="s2">&#34;could not record Lua VM allocated memory: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">last</span> <span class="o">=</span> <span class="n">ngx.time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>根据响应结果调用负载均衡器调整上游节点的权重：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">      <span class="c1">-- If response was produced by an upstream (ie, not by a Kong plugin)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- Report HTTP status for health checks</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">balancer_data</span> <span class="o">=</span> <span class="n">ctx.balancer_data</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">balancer_data</span> <span class="ow">and</span> <span class="n">balancer_data.balancer_handle</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ngx.status</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">504</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">          <span class="n">balancer_data.balancer</span><span class="p">.</span><span class="n">report_timeout</span><span class="p">(</span><span class="n">balancer_data.balancer_handle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">else</span>
</span></span><span class="line"><span class="cl">          <span class="n">balancer_data.balancer</span><span class="p">.</span><span class="n">report_http_status</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">balancer_data.balancer_handle</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- release the handle, so the balancer can update its statistics</span>
</span></span><span class="line"><span class="cl">        <span class="n">balancer_data.balancer_handle</span><span class="p">:</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span></code></pre></div><h2 id="9-admin-api">9. Admin API</h2>
<p>Kong Admin API 入口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">Kong</span><span class="p">.</span><span class="nf">admin_content</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ngx.ctx</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="ow">not</span> <span class="n">ctx.workspace</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.workspace</span> <span class="o">=</span> <span class="n">kong.default_workspace</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">serve_content</span><span class="p">(</span><span class="s2">&#34;kong.api&#34;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">serve_content</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- CORS 跨域相关</span>
</span></span><span class="line"><span class="cl">  <span class="n">header</span><span class="p">[</span><span class="s2">&#34;Access-Control-Allow-Origin&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options.allow_origin</span> <span class="ow">or</span> <span class="s2">&#34;*&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 启动 lapis</span>
</span></span><span class="line"><span class="cl">  <span class="n">lapis.serve</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>关于 <a href="https://leafo.net/lapis/" target="_blank" rel="noopener">Lapis</a>：</p>
<blockquote>
<p>Lapis is a framework for building web applications using <a href="https://moonscript.org" target="_blank" rel="noopener">MoonScript</a> or <a href="https://lua.org" target="_blank" rel="noopener">Lua</a> that runs inside of a customized version of <a href="https://nginx.org" target="_blank" rel="noopener">Nginx</a> called <a href="https://openresty.org" target="_blank" rel="noopener">OpenResty</a>.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="o">#</span> <span class="n">api</span><span class="o">/</span><span class="n">init.lua</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 加载固定路由</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Load core routes</span>
</span></span><span class="line"><span class="cl"><span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">({</span><span class="s2">&#34;kong&#34;</span><span class="p">,</span> <span class="s2">&#34;health&#34;</span><span class="p">,</span> <span class="s2">&#34;cache&#34;</span><span class="p">,</span> <span class="s2">&#34;config&#34;</span><span class="p">,</span> <span class="s2">&#34;clustering&#34;</span><span class="p">})</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">routes</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;kong.api.routes.&#34;</span> <span class="o">..</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">api_helpers.attach_routes</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- DAO Routes</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dao</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">singletons.db</span><span class="p">.</span><span class="n">daos</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">dao.schema</span><span class="p">.</span><span class="n">generate_admin_api</span> <span class="o">~=</span> <span class="kc">false</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dao.schema</span><span class="p">.</span><span class="n">legacy</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">routes</span> <span class="o">=</span> <span class="n">Endpoints.new</span><span class="p">(</span><span class="n">dao.schema</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span></code></pre></div><p>初始化构建路由：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="o">#</span> <span class="n">api</span><span class="o">/</span><span class="n">endpoints.lua</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 创建基础路由</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Generates admin api endpoint functions</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Examples:</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /routes</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /routes/:routes</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /routes/:routes/service</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /services/:services/routes</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- and</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /services</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /services/:services</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /services/:services/routes/:routes</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">generate_endpoints</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- list 路由</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- e.g. /routes</span>
</span></span><span class="line"><span class="cl">  <span class="n">generate_collection_endpoints</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 单体路由</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- e.g. /routes/:routes</span>
</span></span><span class="line"><span class="cl">  <span class="n">generate_entity_endpoints</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 判断是否有关联对象</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- 例如 route 关联 services</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">foreign_field_name</span><span class="p">,</span> <span class="n">foreign_field</span> <span class="kr">in</span> <span class="n">schema</span><span class="p">:</span><span class="n">each_field</span><span class="p">()</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 外键</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">foreign_field.type</span> <span class="o">==</span> <span class="s2">&#34;foreign&#34;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">foreign_field.schema</span><span class="p">.</span><span class="n">legacy</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- e.g. /routes/:routes/service</span>
</span></span><span class="line"><span class="cl">      <span class="n">generate_entity_endpoints</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">foreign_field.schema</span><span class="p">,</span> <span class="n">foreign_field_name</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- e.g. /services/:services/routes</span>
</span></span><span class="line"><span class="cl">      <span class="n">generate_collection_endpoints</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">foreign_field.schema</span><span class="p">,</span> <span class="n">foreign_field_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">-- e.g. /services/:services/routes/:routes</span>
</span></span><span class="line"><span class="cl">      <span class="n">generate_entity_endpoints</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">foreign_field.schema</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">foreign_field_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">endpoints</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- Generates admin api collection endpoint functions</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Examples:</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /routes</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /services/:services/routes</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- and</span>
</span></span><span class="line"><span class="cl"><span class="c1">--</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- /services</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">generate_collection_endpoints</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">foreign_schema</span><span class="p">,</span> <span class="n">foreign_field_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">collection_path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- 外键关联</span>
</span></span><span class="line"><span class="cl">  <span class="kr">if</span> <span class="n">foreign_schema</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_path</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">(</span><span class="s2">&#34;/%s/:%s/%s&#34;</span><span class="p">,</span> <span class="n">foreign_schema.admin_api_name</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">foreign_schema.name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">foreign_schema.name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">schema.admin_api_nested_name</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">schema.admin_api_name</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">schema.name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 没有外键关联</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_path</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">(</span><span class="s2">&#34;/%s&#34;</span><span class="p">,</span> <span class="n">schema.admin_api_name</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">schema.name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">endpoints</span><span class="p">[</span><span class="n">collection_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span>  <span class="o">=</span> <span class="n">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">methods</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--OPTIONS = method_not_allowed,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--HEAD    = method_not_allowed,</span>
</span></span><span class="line"><span class="cl">      <span class="n">GET</span>     <span class="o">=</span> <span class="n">get_collection_endpoint</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">foreign_schema</span><span class="p">,</span> <span class="n">foreign_field_name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">POST</span>    <span class="o">=</span> <span class="n">post_collection_endpoint</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">foreign_schema</span><span class="p">,</span> <span class="n">foreign_field_name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--PUT     = method_not_allowed,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--PATCH   = method_not_allowed,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--DELETE  = method_not_allowed,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>只关注 POST 请求处理的部分：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">post_collection_endpoint</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">foreign_schema</span><span class="p">,</span> <span class="n">foreign_field_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">helpers</span><span class="p">,</span> <span class="n">post_process</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">foreign_schema</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kd">local</span> <span class="n">foreign_entity</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">select_entity</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">foreign_schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err_t</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">handle_error</span><span class="p">(</span><span class="n">err_t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="ow">not</span> <span class="n">foreign_entity</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">not_found</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">self.args</span><span class="p">.</span><span class="n">post</span><span class="p">[</span><span class="n">foreign_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">foreign_schema</span><span class="p">:</span><span class="n">extract_pk_values</span><span class="p">(</span><span class="n">foreign_entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 处理请求，参数校验，插入数据    </span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">insert_entity</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">err_t</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="kr">return</span> <span class="n">handle_error</span><span class="p">(</span><span class="n">err_t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">-- 回调函数</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">post_process</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">entity</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">post_process</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">if</span> <span class="n">err_t</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">handle_error</span><span class="p">(</span><span class="n">err_t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">created</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>Admin API 仅仅是一层 API 封装，不负责背后的事件处理和数据同步，背后的事件处理在文章事件处理部分阐述过了。</p>
<h2 id="10-插件开发">10. 插件开发</h2>
<p>简单介绍一下插件开发能用上的一些小 Trick。</p>
<h3 id="101-多层-schema-嵌套">10.1. 多层 Schema 嵌套</h3>
<p>Schema 多层嵌套示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">plugin_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">typedefs.no_consumer</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="n">protocols</span> <span class="o">=</span> <span class="n">typedefs.protocols_http</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;record&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;array&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">elements</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;record&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">match</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;array&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">elements</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;record&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span> <span class="n">vars</span> <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;array&#34;</span><span class="p">,</span> <span class="n">elements</span> <span class="o">=</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;array&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">elements</span> <span class="o">=</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;string&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">                      <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="102-自定义-schema-校验器">10.2. 自定义 Schema 校验器</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;resty.expr.v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">schema_validator</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">conf.rules</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rule</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">conf.rules</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">rule.match</span> <span class="ow">and</span> <span class="n">type</span><span class="p">(</span><span class="n">rule.match</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;table&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">rule.match</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">expr.new</span><span class="p">(</span><span class="n">m.vars</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                        <span class="kr">return</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&#34;failed to validate the &#39;vars&#39; expression: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">                    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="103-日志打印-table">10.3. 日志打印 Table</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">kong.log</span><span class="p">.</span><span class="n">inspect.on</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">kong.log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;Lua table: &#34;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="104-自定义日志输出">10.4. 自定义日志输出</h3>
<p>2.3.0 版本以上可用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">entries</span> <span class="o">=</span> <span class="n">ctx.log_entries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">id</span> <span class="o">=</span> <span class="n">self.transaction_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">action</span> <span class="o">=</span> <span class="n">action_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">kong.log</span><span class="p">.</span><span class="n">set_serialize_value</span><span class="p">(</span><span class="s2">&#34;waf&#34;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
</span></span></code></pre></div>
                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/%E7%BD%91%E5%85%B3/">网关</a>
  
  <a class="badge badge-light" href="/tag/kong/">Kong</a>
  
  <a class="badge badge-light" href="/tag/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/mayo-cream/"><img class="avatar mr-3 avatar-circle" src="/author/mayo-cream/avatar_hue38add62c87b7486d80c9f3fda25dfc1_12220_270x270_fill_q75_lanczos_center.jpg" alt="Mayo Cream"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/mayo-cream/">Mayo Cream</a></p>
      
      
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/chaos-engineering-with-kubernetes/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/can-ztna-replace-vpn/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>ZTNA 能取代 VPN 吗？——三种远程访问方法对比</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/kong-source-code-reading/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/apisix-source-code-reading/">云原生网关 APISIX 核心流程源码分析与进化方向思考</a></li>
      
      <li><a href="/blog/chaos-engineering-with-kubernetes/">在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发</a></li>
      
      <li><a href="/blog/gateway-and-mesh/">API 网关、Kubernetes 网关和 Service Mesh 综合指南</a></li>
      
      <li><a href="/blog/istio-gateway-api-beta/">Istio 扩展对 Gateway API 的支持</a></li>
      
      <li><a href="/blog/designing-traffic-flow-via-tier1-and-tier2-ingress-gateways/">通过两级网关设计来路由服务网格流量</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2024 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.5b2c48a98fb93f10e8d01cff2874cdf3.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.a04788cdfce708339d31c0685377d64e.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
