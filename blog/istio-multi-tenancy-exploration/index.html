<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="Istio 作为服务治理的主流技术，应用的越来越多。在将 Istio 落地部署的时候，需要考虑公司组织结构、产品、网络、人员等多种场景因素，确定合适的部署方案。我们需要在一个 Kubernetes 集群中通过 Istio 纳管多款产品，针对该需求，对 Istio 部署模型进行了一些调研探索，确定了适合的的部署模式，记录下来，为有相同需要的伙伴提供参考。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/istio-multi-tenancy-exploration/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/istio-multi-tenancy-exploration/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区" />
  <meta property="og:url" content="https://cloudnative.to/blog/istio-multi-tenancy-exploration/" />
  <meta property="og:title" content="多租户场景下 Istio 部署方案探索 | 云原生社区" />
  <meta property="og:description" content="Istio 作为服务治理的主流技术，应用的越来越多。在将 Istio 落地部署的时候，需要考虑公司组织结构、产品、网络、人员等多种场景因素，确定合适的部署方案。我们需要在一个 Kubernetes 集群中通过 Istio 纳管多款产品，针对该需求，对 Istio 部署模型进行了一些调研探索，确定了适合的的部署模式，记录下来，为有相同需要的伙伴提供参考。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2021-11-01T02:37:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2022-10-22T16:40:22&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/istio-multi-tenancy-exploration/"
  },
  "headline": "多租户场景下 Istio 部署方案探索",
  
  "datePublished": "2021-11-01T02:37:00+08:00",
  "dateModified": "2022-10-22T16:40:22+08:00",
  
  "author": {
    "@type": "Person",
    "name": "张海文"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "Istio 作为服务治理的主流技术，应用的越来越多。在将 Istio 落地部署的时候，需要考虑公司组织结构、产品、网络、人员等多种场景因素，确定合适的部署方案。我们需要在一个 Kubernetes 集群中通过 Istio 纳管多款产品，针对该需求，对 Istio 部署模型进行了一些调研探索，确定了适合的的部署模式，记录下来，为有相同需要的伙伴提供参考。"
}
</script>

  

  

  

  





  <title>多租户场景下 Istio 部署方案探索 | 云原生社区</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="20b2c2d03f419d415a87943307e4d167" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder"><span>Kubebuilder 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>多租户场景下 Istio 部署方案探索</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E5%BC%A0%E6%B5%B7%E6%96%87/">张海文</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/istio/" class="text-capitalize">istio</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2021-11-01
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 4713
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 21 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#初始方案问题">初始方案问题</a>
      <ul>
        <li><a href="#性能问题">性能问题</a></li>
        <li><a href="#故障隔离性问题">故障隔离性问题</a></li>
      </ul>
    </li>
    <li><a href="#新方案调研">新方案调研</a>
      <ul>
        <li><a href="#官方方案">官方方案</a></li>
        <li><a href="#单控制面多-gateway-方案">单控制面多 Gateway 方案</a></li>
        <li><a href="#大厂方案">大厂方案</a></li>
      </ul>
    </li>
    <li><a href="#我们的探索">我们的探索</a>
      <ul>
        <li><a href="#官方方案-1">官方方案</a></li>
        <li><a href="#单控制面多-gateway-方案-1">单控制面多 Gateway 方案</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#初始方案问题">初始方案问题</a>
      <ul>
        <li><a href="#性能问题">性能问题</a></li>
        <li><a href="#故障隔离性问题">故障隔离性问题</a></li>
      </ul>
    </li>
    <li><a href="#新方案调研">新方案调研</a>
      <ul>
        <li><a href="#官方方案">官方方案</a></li>
        <li><a href="#单控制面多-gateway-方案">单控制面多 Gateway 方案</a></li>
        <li><a href="#大厂方案">大厂方案</a></li>
      </ul>
    </li>
    <li><a href="#我们的探索">我们的探索</a>
      <ul>
        <li><a href="#官方方案-1">官方方案</a></li>
        <li><a href="#单控制面多-gateway-方案-1">单控制面多 Gateway 方案</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav>
</details>

                    
                    <h2 id="背景">背景</h2>
<p>随着云原生概念的普及，服务网格技术的流行以及 Istio 的成熟，使用Istio 进行服务治理的实践也越来越多，正成为服务治理的趋势。</p>
<p>在这样的背景下，我们也加入到 Istio 的研究中，希望初期通过 Istio 实现公司产品迭代版本的灰度发布，后续基于 Istio 为业务产品提供更多的流量管理及观测追踪能力。</p>
<p>一开始设计 Istio 部署方案时，基于当时对公司产品部署方式的了解，每款产品独占一套 Kubernetes 集群，另外考虑到当时我们对 Istio 的熟悉程度，设计的是最基础的方案：一套 Kubernetes 集群中部署一套 Istio，将该 Kubernetes 集群内唯一的产品纳管到 Istio 服务网格中，即 Kubernetes 集群、产品、Istio 是1:1:1的关系。</p>
<p>随着对公司产品部署方式调研的深入，我们了解到有几款产品部署在一套 Kubernetes 集群中，按照 namespace 进行分割，并且公司开始推行统一 Kubernetes 集群，已经在落地实施。</p>
<p>如果我们继续使用初始的部署方案，在初期 Kubernetes 集群中产品数量不多，规模不大的情况，也是可以支撑的，但存在潜在问题(主要是性能问题以及故障隔离性的问题)，所以需要调研实现在一套 Kubernetes 集群内，为每一个产品提供一套 Istio 服务网格的方案。</p>
<h2 id="初始方案问题">初始方案问题</h2>
<p>初始方案存在以下两个问题：</p>
<h3 id="性能问题">性能问题</h3>
<p>集群规模较大时，多产品共用同一套 Istio，会存在性能问题。在默认情况下，服务网格中的每个 Sidecar 都会收到整个集群所有服务信息。在较大规模的规模中，尤其是由于流量规则批量变更，控制面向数据面短时间内大量下发服务信息的情况下，Sidecar 的 CPU 及内存消耗、XDS 的下发及时性等问题，会变得非常突出。</p>
<h3 id="故障隔离性问题">故障隔离性问题</h3>
<p>多款产品共用一套 Istio，可能 Istio 本身会出现问题，也可能由于某款产品的配置导致 Istio 出现问题，进而可能导致纳管的所有产品灰度甚至正常访问都出现问题，无法实现故障的隔离。</p>
<h2 id="新方案调研">新方案调研</h2>
<p>我们需要调研实现在一套 Kubernetes 集群内，为每一个产品提供一套 Istio 服务网格的方案，解决潜在的问题。 总结下来，有以下几种方案：</p>
<h3 id="官方方案">官方方案</h3>
<p>Istio 官方网站有一篇2018年的博文：<a href="https://istio.io/latest/zh/blog/2018/soft-multitenancy/" target="_blank" rel="noopener">Istio 的软性多租户支持</a>给出了方案，可以实现为每个产品提供一套 Istio 网格的目标，每套 Istio 的控制面可以安装到指定的 namespace 中，数据面可以设置为产品部署的 namespace。官方方案是符合我们期望的方案，但 Istio 版本升级太快，博文内容比较陈旧，没办法按文档操作，并且有人反馈实操时有问题（<a href="https://github.com/istio/istio/issues/7608" target="_blank" rel="noopener">提出问题的issue</a>）。</p>
<p>每个 namespace 装一套 Istio 网格，也是存在一定问题的，但结合目前我们的实际情况，认为下面的两个问题我们是可以接受的。</p>
<ul>
<li>资源消耗问题：每套 Istio 网格都是需要消耗一定量的资源的</li>
<li>namespace 之间网络请求问题：如果 namespace 之间存在服务互访，按照 Istio 的规范，通过在 namespace 中部署 Ingress Gateway 和 Egress Gateway，控制进入和流出的流量，但这样增加了部署复杂度。</li>
</ul>
<h3 id="单控制面多-gateway-方案">单控制面多 Gateway 方案</h3>
<p><a href="https://medium.com/@sudeep.batra/service-mesh-istio-patterns-for-multitenancy-2462568636f7" target="_blank" rel="noopener">Service Mesh (Istio) patterns for Multitenancy</a>提供了另外一种方案，该方案为部署一套 Istio 控制面，纳管多个产品数据面，每个产品以及 Istio 控制面的 namespace 部署一套 Ingress Gateway，相当于产品共用 Istio 控制面，但不共用 Ingress Gateway，一定程度上减少产品的耦合。</p>
<p>















<figure  id="figure-单控制面多-gateway-方案">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="单控制面多 Gateway 方案" srcset="
               /blog/istio-multi-tenancy-exploration/one-control-plane-multi-gateways_hue06e03890b345f6f830f583e4fc2a36b_39336_518e6d9b4df0f75245c2aef08d9f5a3f.webp 400w,
               /blog/istio-multi-tenancy-exploration/one-control-plane-multi-gateways_hue06e03890b345f6f830f583e4fc2a36b_39336_8131929e11bd085df89da839e14566df.webp 760w,
               /blog/istio-multi-tenancy-exploration/one-control-plane-multi-gateways_hue06e03890b345f6f830f583e4fc2a36b_39336_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/one-control-plane-multi-gateways_hue06e03890b345f6f830f583e4fc2a36b_39336_518e6d9b4df0f75245c2aef08d9f5a3f.webp"
               width="760"
               height="601"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      单控制面多 Gateway 方案
    </figcaption></figure>
</p>
<h3 id="大厂方案">大厂方案</h3>
<p>一些大厂，在开源 Istio 的基础上，增加了多租户的支持，比如<a href="https://www.redhat.com/en/topics/microservices/why-choose-openshift-service-mesh" target="_blank" rel="noopener">Red Hat OpenShift Service Mesh</a>、<a href="https://www.infoq.cn/article/id2w4pefjqbusjhmd8jt" target="_blank" rel="noopener">腾讯云 TFS Mesh</a>及<a href="https://www.qbitai.com/2020/06/15846.html" target="_blank" rel="noopener">蚂蚁金服 SOFAMesh</a>，在这三篇文章中，都各自提到了对多租户的支持。</p>
<h2 id="我们的探索">我们的探索</h2>
<p>目前我们进行了前两个方案的探索，即上文中官方方案及单控制面多 Gateway 的方案，通过实践和对源码研究，在不修改调研版本（V1.8.1）Istio 源码的情况下，前者是行不通的，而后者是可以顺利实现的(PS：通过对最新版本 V1.11.4 的 Istio 进行实践，本文对 V1.11.4 版本 Istio 仍然适用)。</p>
<p>两个方案各有优缺点：</p>
<ul>
<li>
<p>前者可以实现租户对 Istio 的独占，是在一套 Kubernetes 集群中彻底的分租户方案，比较完美的解决性能问题及故障隔离性问题，但缺点是需要修改源代码，开发成本较高，后期每次 Istio 版本升级，需要将 patch 重新打入，维护成本也较高，另外考虑对 Istio 的熟悉程度，修改源码带来的风险也较大。</p>
</li>
<li>
<p>后者是在不修改源代码的情况下实现多租户的折中方案，租户间虽然共享控制面，但独享数据面，在数据面范围内实现租户隔离，解决用户访问租户产品时的性能问题和故障隔离性问题，保障了产品的正常访问，这也是最重要、最需要保障的部分，缺点是租户共享控制面，控制面出现问题时，影响多产品控制面对数据面的管理，比如流量管理配置变更下发，但考虑一般在周期性上线时，才涉及到控制面对数据面的管理变更，解决问题的紧急程度，比数据面业务访问出问题时的紧急程度低很多，并且我们会通过控制面高可用等方案，降低这种情况的影响。</p>
</li>
</ul>
<p>下面详细介绍下对两个方案的探索：</p>
<h3 id="官方方案-1">官方方案</h3>
<p>前面已经提到，官方方案内容比较陈旧，没办法按照文档操作，并且有人反馈存在问题，按照博文方案，通过 istioctl 方式多次尝试，没有成功。阅读了更多的其他官方文档，考虑 Istio Operator 方式安装 Istio，可以更方便进行 Istio 部署设置，所以进行了通过 Istio Operator 安装 Istio 的很多尝试，并且深入阅读了 Istio 相关代码，发现在不修改 Istio 源代码的情况下，是行不通的。</p>
<p>以下是通过 Istio Operator 安装 Istio，实现官方方案的一些尝试，并包含一些源代码的分析。</p>
<p>试验 Demo 部署模型如下，在一套 Kubernetes 集群上部署两套服务网格及两套产品(Foo 和 Bar)，每套服务网格完全隔离，每个产品独占对应的服务网格。</p>
<p>















<figure  id="figure-官方方案验证demo部署模型">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="官方方案验证demo部署模型" srcset="
               /blog/istio-multi-tenancy-exploration/independent-control-plane-demo_hud2d25fadb0d709cec4cd0731e03818d7_64610_3e02cc87cdff2e30bc12541474754aa3.webp 400w,
               /blog/istio-multi-tenancy-exploration/independent-control-plane-demo_hud2d25fadb0d709cec4cd0731e03818d7_64610_6d10e2d4715d8048e22568262470603f.webp 760w,
               /blog/istio-multi-tenancy-exploration/independent-control-plane-demo_hud2d25fadb0d709cec4cd0731e03818d7_64610_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/independent-control-plane-demo_hud2d25fadb0d709cec4cd0731e03818d7_64610_3e02cc87cdff2e30bc12541474754aa3.webp"
               width="760"
               height="334"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      官方方案验证demo部署模型
    </figcaption></figure>
</p>
<p>1、为 Foo 产品部署独占的 Istio 组件</p>
<pre tabindex="0"><code>kubectl create namespace istio-system-foo
istioctl operator init --istioNamespace istio-system-foo --watchedNamespaces istio-system-foo --namespace istio-system-foo --operatorNamespace istio-operator-foo
kubectl apply -f istio-operator-foo.yaml
</code></pre><p>istio-operator-foo.yaml 的内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">install.istio.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IstioOperator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">istioNamespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meshConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rootNamespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingressGateways</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ingressgateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span></code></pre></div><p>执行以上操作后，过一段时间，查看 istio-system-foo namespace，可以看到 Foo 独占的 Istio 组件部署成功。</p>
<ol start="2">
<li>类似的方式，为 Bar 应用部署独占的 Istio 组件</li>
</ol>
<pre tabindex="0"><code>kubectl create namespace istio-system-bar
istioctl operator init --istioNamespace istio-system-bar --watchedNamespaces istio-system-bar --namespace istio-system-bar --operatorNamespace istio-operator-bar
kubectl apply -f istio-operator-bar.yaml
</code></pre><p>istio-operator-bar.yaml 的内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">install.istio.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IstioOperator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">istioNamespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meshConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rootNamespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system-bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingressGateways</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ingressgateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span></code></pre></div><p>执行以上的操作，稍等一会，查看 istio-system-bar namespace 下的 Istio 组件部署情况，会发现 Istio Ingress Gateway 的 pod 无法成功启动，查看日志，日志中报如下错误：</p>
<pre tabindex="0"><code>error   xdsproxy        failed to create upstream grpc client: rpc error: code = Unavailable desc = connection error: desc = &#34;transport: authentication handshake failed: x509: certificate signed by unknown authority (possibly because of \&#34;crypto/rsa: verification error\&#34; while trying to verify candidate authority certificate \&#34;cluster.local\&#34;)&#34;
</code></pre><p>更多日志见下面截图：</p>
<p>















<figure  id="figure-ingress-gateway-启动错误日志">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Ingress Gateway 启动错误日志" srcset="
               /blog/istio-multi-tenancy-exploration/ingress-gateway-failed-log_hu9b7126d2a00c9714d00a2f67b14349a8_467943_35b913963a2c5adf3e300b3d56da57e3.webp 400w,
               /blog/istio-multi-tenancy-exploration/ingress-gateway-failed-log_hu9b7126d2a00c9714d00a2f67b14349a8_467943_bd965c61e54a410206fdbb04a7d4f85c.webp 760w,
               /blog/istio-multi-tenancy-exploration/ingress-gateway-failed-log_hu9b7126d2a00c9714d00a2f67b14349a8_467943_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/ingress-gateway-failed-log_hu9b7126d2a00c9714d00a2f67b14349a8_467943_35b913963a2c5adf3e300b3d56da57e3.webp"
               width="760"
               height="371"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Ingress Gateway 启动错误日志
    </figcaption></figure>
</p>
<p>要解释截图中的错误日志原因，需要先介绍下数据面（Envoy）和控制面（Istiod）的网络交互。下面是网络交互图（ADS 请求部分）：</p>
<p>















<figure  id="figure-envoy-和-istiod-的网络交互图">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Envoy 和 Istiod 的网络交互图" srcset="
               /blog/istio-multi-tenancy-exploration/ads_huc76e7ef8980035a0e2c451866d40f33f_20618_f4fe851942158c9000dac9a877f94084.webp 400w,
               /blog/istio-multi-tenancy-exploration/ads_huc76e7ef8980035a0e2c451866d40f33f_20618_accafafd165f1646106e9dd8e537965b.webp 760w,
               /blog/istio-multi-tenancy-exploration/ads_huc76e7ef8980035a0e2c451866d40f33f_20618_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/ads_huc76e7ef8980035a0e2c451866d40f33f_20618_f4fe851942158c9000dac9a877f94084.webp"
               width="241"
               height="491"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Envoy 和 Istiod 的网络交互图
    </figcaption></figure>
</p>
<p>在数据面 Istio Ingress Gateway 容器中或者业务产品 pod 注入的 Sidecar 容器中，启动着两个进程，Envoy 进程及 Pilot Agent 进程（即图中的 Istio Agent），后者扮演着 Istiod 和 Envoy 之间（即控制面和数据面之间）进行网络交互的中间代理角色。Envoy 向Istio Agent 发送 ADS（Aggregated Discovery Services，即聚合的发现服务，通过一个 gRPC 流来同步所有的配置更新）请求，后者将请求转发给控制面的配置发现服务（一般为 Istiod ），然后配置发现服务将全部的配置更新返回给数据面。</p>
<p>数据面和控制面之间的网络请求，默认基于双向 TLS 认证，即两者进行通信时，双方都需要验证对方的身份，通过阅读源代码及参考赵化冰大佬的文章<a href="https://zhaohuabing.com/post/2020-05-25-istio-certificate/" target="_blank" rel="noopener">一文带你彻底厘清 Isito 中的证书工作机制</a>，了解数据面对控制面的身份认证过程如下：</p>
<p>















<figure  id="figure-身份认证">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="身份认证" srcset="
               /blog/istio-multi-tenancy-exploration/certification_hu54963320601599946177ae5c0e067b13_45519_99bf2d17a563a733620751ff97f411b7.webp 400w,
               /blog/istio-multi-tenancy-exploration/certification_hu54963320601599946177ae5c0e067b13_45519_a61b1a3c37b16e1f571b503913a69a68.webp 760w,
               /blog/istio-multi-tenancy-exploration/certification_hu54963320601599946177ae5c0e067b13_45519_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/certification_hu54963320601599946177ae5c0e067b13_45519_99bf2d17a563a733620751ff97f411b7.webp"
               width="745"
               height="688"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      身份认证
    </figcaption></figure>
</p>
<ol>
<li>Istiod 采用内置的 CA 服务为自身签发一个服务器证书，并采用该服务器证书对外提供基于 TLS 的 gPRC 服务；</li>
<li>Istiod 调用 kube-apiserver 生成 configmap：istio-ca-root-cert，在该 configmap 中放入了 Istiod 的 CA 根证书；</li>
<li>数据面 Ingress Gateway 容器或 Sidecar 容器将istio-ca-root-cert configmap mount 为容器内 /var/run/secrets/istio/root-cert.pem 文件；</li>
<li>在Pilot Agent 和 Istiod 建立 gRPC 连接时，Pilot Agent 采用 root-cert.pem 文件证书对 Istiod 的身份进行认证；</li>
</ol>
<p>问题出现：</p>
<p>















<figure  id="figure-istio-多租户认证过程">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Istio 多租户认证过程" srcset="
               /blog/istio-multi-tenancy-exploration/certification-with-multi-tenancy_hub9804839b501f21365e4833fa1076502_60637_0fffcf14d25b1901d3fe0201eeba7f0a.webp 400w,
               /blog/istio-multi-tenancy-exploration/certification-with-multi-tenancy_hub9804839b501f21365e4833fa1076502_60637_61a4b01281bfb3232188f5cc3a19cfc8.webp 760w,
               /blog/istio-multi-tenancy-exploration/certification-with-multi-tenancy_hub9804839b501f21365e4833fa1076502_60637_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/certification-with-multi-tenancy_hub9804839b501f21365e4833fa1076502_60637_0fffcf14d25b1901d3fe0201eeba7f0a.webp"
               width="760"
               height="362"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Istio 多租户认证过程
    </figcaption></figure>
</p>
<ol start="5">
<li>Istio 通过 Kubernetes Informer 机制，将步骤2 Foo 控制面生成的 Configmap 同步到 Kubernetes 集群里所有的 namespace 下，包括 Bar 网格相关的 Namespace；</li>
<li>Bar 数据面 Ingress Gateway 容器或 Sidecar 容器，采用步骤3相同的方式，将步骤5同步到的 Configmap mount 到容器内；</li>
<li>Bar 的 Ingress Gateway 或 Sidecar 使用 Foo 控制面生成的 CA 根证书，对 Bar 的控制面进行身份认证，认证失败。</li>
</ol>
<p>可以从 Istio 源代码：<a href="https://github.com/istio/istio/blob/1.8.1/pilot/pkg/bootstrap/server.go" target="_blank" rel="noopener">pilot/pkg/bootstrap/server.go</a>和<a href="https://github.com/istio/istio/blob/1.8.1/pilot/pkg/serviceregistry/kube/controller/namespacecontroller.go" target="_blank" rel="noopener">pilot/pkg/serviceregistry/kube/controller/namespacecontroller.go</a>中看到相关的分析内容，Istiod 中 pilot 模块 server 服务时，会进行一系列的初始化工作，包括初始化 namespaceController，而该namespaceController 会创建 configmapInformer，通过 informer 机制，接受 Kubernetes 集群中的 istio-ca-root-cert configmap 的更新，而该 informer 是一个SharedIndexInformer，也就是共享的 informer，监听同一个 Kubernetes 集群中所有 namespace 下 configmap 的变化，所以从代码中可以看出，目前的 Istio 不支持在同一个 Kubernetes 集群中存在多套 Istio 控制面，这个变化应该是来自 Istio 2020 年 7 月的一次代码修改，可以查看<a href="https://github.com/istio/istio/commit/9fdec2a68d443b9f9aac85530ac01491b0d24bf2" target="_blank" rel="noopener">namespace controller: use shared informer</a></p>
<p>















<figure  id="figure-namespace-controller-use-shared-informer">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="namespace controller: use shared informer" srcset="
               /blog/istio-multi-tenancy-exploration/istio-code_hu396fa18c9af3f62e9a5535a07841d150_178495_1520f77af8bbd233e5cbfbe513548453.webp 400w,
               /blog/istio-multi-tenancy-exploration/istio-code_hu396fa18c9af3f62e9a5535a07841d150_178495_3e2efa1a3610f85f12aa6a843830d80e.webp 760w,
               /blog/istio-multi-tenancy-exploration/istio-code_hu396fa18c9af3f62e9a5535a07841d150_178495_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/istio-code_hu396fa18c9af3f62e9a5535a07841d150_178495_1520f77af8bbd233e5cbfbe513548453.webp"
               width="760"
               height="404"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      namespace controller: use shared informer
    </figcaption></figure>
</p>
<p>所以得出结论，在不修改 Istio 源码的情况下，想要实现官方方案，是行不通的。</p>
<h3 id="单控制面多-gateway-方案-1">单控制面多 Gateway 方案</h3>
<p>参照<a href="https://medium.com/@sudeep.batra/service-mesh-istio-patterns-for-multitenancy-2462568636f7" target="_blank" rel="noopener">Service Mesh (Istio) patterns for Multitenancy</a>，进行了实践验证，实践过程很顺利，以下是试验 Demo 部署模型及实践步骤，一套 Kubernetes 集群上部署两款产品（Foo 和 Bar），两款产品共享控制面，独享数据面，数据面范围内实现租户隔离。</p>
<p>















<figure  id="figure-单控制面多-gateway-方案-demo-部署模型">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="单控制面多 Gateway 方案 Demo 部署模型" srcset="
               /blog/istio-multi-tenancy-exploration/shared-control-plane-demo_hu615c9f6c64aa1710ddec7fc5b87cbf55_54028_cbdbd29b6be06aae5f77a491015ab302.webp 400w,
               /blog/istio-multi-tenancy-exploration/shared-control-plane-demo_hu615c9f6c64aa1710ddec7fc5b87cbf55_54028_83523925cc64de9311a7cf5f1467f821.webp 760w,
               /blog/istio-multi-tenancy-exploration/shared-control-plane-demo_hu615c9f6c64aa1710ddec7fc5b87cbf55_54028_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/istio-multi-tenancy-exploration/shared-control-plane-demo_hu615c9f6c64aa1710ddec7fc5b87cbf55_54028_cbdbd29b6be06aae5f77a491015ab302.webp"
               width="760"
               height="348"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      单控制面多 Gateway 方案 Demo 部署模型
    </figcaption></figure>
</p>
<ol>
<li>部署 Istio Operator</li>
</ol>
<pre tabindex="0"><code>istioctl operator init
</code></pre><ol start="2">
<li>创建 istio-system namespace</li>
</ol>
<pre tabindex="0"><code>kubectl create namespace istio-system
</code></pre><ol start="3">
<li>创建部署控制面的 Istio Operator 自定义资源</li>
</ol>
<pre tabindex="0"><code>kubectl apply -f istio-operator.yaml
</code></pre><p>istio-operator.yaml 的内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">install.istio.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IstioOperator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pilot</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hpaSpec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PILOT_SCOPE_GATEWAY_TO_NAMESPACE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingressGateways</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ingressgateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><p>需要注意一点，部署 pilot 组件时，为 pilot 组件设置了 <code>PILOT_SCOPE_GATEWAY_TO_NAMESPACE</code> 环境变量，值为 true，会限制 gateway 规则只会应用到 gateway 所在 namespace 下 Istio Ingress Gateway 上，这样设置实现租户之间的隔离。</p>
<p>operator controller 会监测到 istio-control-plane 这个 IstioOperator 资源，并按照配置部署相关组件，稍等一段时间，可以看懂 istio-system namespace 下共享的控制面组件已经部署完成。</p>
<pre tabindex="0"><code>kubectl get all -n istio-system
NAME                          READY   STATUS    RESTARTS   AGE
pod/istiod-6fc49c7d5c-2ljdl   1/1     Running   0          19h
pod/istiod-6fc49c7d5c-mjp5h   1/1     Running   0          19h
NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                 AGE
service/istiod   ClusterIP   10.109.247.96   &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP   5d5h
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/istiod   2/2     2            2           19h
NAME                                DESIRED   CURRENT   READY   AGE
replicaset.apps/istiod-6fc49c7d5c   2         2         2       19h
replicaset.apps/istiod-f77f59479    0         0         0       19h
NAME                                         REFERENCE           TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
horizontalpodautoscaler.autoscaling/istiod   Deployment/istiod   &lt;unknown&gt;/80%   2         5         2          19h
</code></pre><ol start="4">
<li>创建 foo namespace，并为该 namespace 打上标签，支持 istio sidecar 自动注入</li>
</ol>
<pre tabindex="0"><code>kubectl create namespace foo
kubectl label namespace foo istio-injection=enabled
</code></pre><ol start="5">
<li>创建部署 Foo 应用独占的 Istio Ingress Gateway 需要的 Istio Operator 自定义资源</li>
</ol>
<pre tabindex="0"><code>kubectl apply -f istio-operator-foo.yaml
</code></pre><p>istio-operator-foo.yaml 的内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">install.istio.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IstioOperator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo-ingress-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l">empty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingressGateways</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ingress-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">foo </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hpaSpec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></div><p>稍等一段时间，可以看到 foo namespace 下，Foo 应用独占的 Istio Ingress Gateway 部署完成。</p>
<pre tabindex="0"><code>kubectl get all -n foo
NAME                                         READY   STATUS    RESTARTS   AGE
pod/istio-ingress-gateway-78447867cf-gh4l8   1/1     Running   0          23h
pod/istio-ingress-gateway-78447867cf-nqcb4   1/1     Running   0          23h

NAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE
service/istio-ingress-gateway   NodePort    10.233.21.151   &lt;none&gt;        80:32180/TCP   23h

NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/istio-ingress-gateway   2/2     2            2           23h

NAME                                               DESIRED   CURRENT   READY   AGE
replicaset.apps/istio-ingress-gateway-78447867cf   2         2         2       23h

NAME                                                        REFERENCE                          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
horizontalpodautoscaler.autoscaling/istio-ingress-gateway   Deployment/istio-ingress-gateway   8%/80%    2         5         2          23h
</code></pre><ol start="6">
<li>参照步骤4、5，在 bar namespace 中部署产品 Bar 独占的 Istio Ingress Gateway。</li>
</ol>
<pre tabindex="0"><code>kubectl create namespace bar
kubectl label namespace bar istio-injection=enabled
kubectl apply -f istio-operator-bar.yaml
</code></pre><p>istio-operator-bar.yaml 内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">install.istio.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IstioOperator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bar-ingress-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l">empty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingressGateways</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ingress-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hpaSpec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32280</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></div><p>稍等一段时间，可以看到 bar namespace 下，Bar 应用独占的 Istio Ingress Gateway 部署完成。</p>
<pre tabindex="0"><code>kubectl get all -n bar
NAME                                         READY   STATUS    RESTARTS   AGE
pod/istio-ingress-gateway-8646b4964b-2q56j   1/1     Running   0          23h
pod/istio-ingress-gateway-8646b4964b-xjvvp   1/1     Running   0          23h

NAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE
service/istio-ingress-gateway   NodePort    10.233.41.156   &lt;none&gt;        80:32280/TCP   23h

NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/istio-ingress-gateway   2/2     2            2           23h

NAME                                               DESIRED   CURRENT   READY   AGE
replicaset.apps/istio-ingress-gateway-8646b4964b   2         2         2       23h

NAME                                                        REFERENCE                          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
horizontalpodautoscaler.autoscaling/istio-ingress-gateway   Deployment/istio-ingress-gateway   6%/80%    2         5         2          23h
</code></pre><p>通过步骤1-6，实现了单控制面多 Gateway 方案的部署，两款产品 Foo 及 Bar 共享 istio-system namespace 中的 Istiod 控制面，独占各自 namespace 中的 Istio Ingress Gateway。</p>
<p>部署Foo、Bar两款产品（很简单的 HelloWorld 类型的 Demo），并创建 Istio 流量管理相关的 CRD，可以实现 Foo、Bar 两款产品的灰度发布，下面是实现灰度发布后的效果，部署过程不再赘述。</p>
<pre tabindex="0"><code>curl http://10.154.0.165:32180/foo/hello
Hello Foo 0.0.1
curl -H &#39;version:v0-0-2&#39; http://10.154.0.165:32180/foo/hello
Hello Foo 0.0.2
curl http://10.154.0.165:32280/bar/hello
Hello Bar 0.0.1
curl -H &#39;version:v0-0-2&#39; http://10.154.0.165:32280/bar/hello
Hello Bar 0.0.2
</code></pre><h2 id="总结">总结</h2>
<p>通过对 Istio 多租户方案的调研和探索，我们总结出同一个 Kubernetes 集群中分 namespace 部署多款产品场景下两种 Istio 部署方案的优缺点，结合我们目前的情况，更倾向采用单控制面多 Gateway 方案。
以上的调研探索，可能存在错误或不准确的地方，欢迎大家交流指正。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="http://blog.itpub.net/31557835/viewspace-2760142/" target="_blank" rel="noopener">2021年 Istio 大型“入坑”指南</a></li>
<li><a href="https://www.cnblogs.com/kirito-c/p/12750063.html" target="_blank" rel="noopener">「Bug」Istio 的 Sidercar 和 IngressGateway 间歇性地报错：Envoy proxy is NOT ready</a></li>
<li><a href="https://medium.com/ww-engineering/istio-performance-in-a-multi-tenancy-kubernetes-cluster-a843ec4e51f7" target="_blank" rel="noopener">Istio performance in a multi-tenancy Kubernetes cluster</a></li>
<li><a href="https://istio.io/latest/zh/blog/2018/soft-multitenancy/" target="_blank" rel="noopener">Istio 的软性多租户支持</a></li>
<li><a href="https://github.com/istio/istio/issues/7608" target="_blank" rel="noopener">1.0 Soft multi-tenancy support</a></li>
<li><a href="https://medium.com/ww-engineering/istio-performance-in-a-multi-tenancy-kubernetes-cluster-a843ec4e51f7" target="_blank" rel="noopener">Istio performance in a multi-tenancy Kubernetes cluster</a></li>
<li><a href="https://www.redhat.com/en/topics/microservices/why-choose-openshift-service-mesh" target="_blank" rel="noopener">Why choose Red Hat OpenShift Service Mesh?</a></li>
<li><a href="https://www.infoq.cn/article/id2w4pefjqbusjhmd8jt" target="_blank" rel="noopener">腾讯云中间件团队在 Service Mesh 中的实践与探索</a></li>
<li><a href="https://www.qbitai.com/2020/06/15846.html" target="_blank" rel="noopener">Service Mesh：调度千军万马微服务，2.0妥妥的</a></li>
<li><a href="https://zhaohuabing.com/post/2020-05-25-istio-certificate/" target="_blank" rel="noopener">一文带你彻底厘清 Isito 中的证书工作机制</a></li>
<li><a href="https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/" target="_blank" rel="noopener">Istio流量管理实现机制深度解析</a></li>
</ul>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/istio/">Istio</a>
  
  <a class="badge badge-light" href="/tag/%E5%A4%9A%E7%A7%9F%E6%88%B7/">多租户</a>
  
  <a class="badge badge-light" href="/tag/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>
  
  <a class="badge badge-light" href="/tag/service-mesh/">service mesh</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E5%BC%A0%E6%B5%B7%E6%96%87/"><img class="avatar mr-3 avatar-circle" src="/author/%E5%BC%A0%E6%B5%B7%E6%96%87/avatar_huc85d1e9a51dd09941e743d779c58be43_23158_270x270_fill_q75_lanczos_center.jpg" alt="张海文"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E5%BC%A0%E6%B5%B7%E6%96%87/">张海文</a></p>
      
      <p class="card-text">中国移动云能力中心高级软件开发工程师，专注于云原生、微服务、 Kubernetes、服务网格、 Istio 等领域。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/dapr-distributed-application-runtime-joins-cncf-incubator/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>Dapr（分布式应用运行时）加入 CNCF 孵化器</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/how-ebpf-streamlines-the-service-mesh/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>eBPF 如何简化服务网格</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/istio-multi-tenancy-exploration/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/istio-access-external-services/">Istio 网格中访问外部服务方法</a></li>
      
      <li><a href="/blog/importance-of-wasm-in-istio/">在 Istio 中引入 Wasm 意味着什么？</a></li>
      
      <li><a href="/blog/smart-istio-management-plane-slime/">网易开源 Istio 扩展项目 Slime 简介——基于 Istio 的智能服务网格管理器</a></li>
      
      <li><a href="/blog/istio-wasm-extensions-and-ecosystem/">Istio 1.12 引入 Wasm 插件配置 API 用于扩展 Istio 生态</a></li>
      
      <li><a href="/blog/grpc-proxyless-service-mesh/">基于 gRPC 和 Istio 的无 sidecar 代理的服务网格</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2022 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
