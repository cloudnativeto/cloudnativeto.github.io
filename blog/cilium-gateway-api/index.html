<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="这篇文章介绍了如何使用 Cilium 部署和配置 Gateway API，一个新的服务网格 API，用于管理 Kubernetes 中的服务间通信。文章详细说明了 Gateway API 的概念和组件，以及如何使用 Cilium 的特性和工具，实现高效和灵活的路由策略。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/cilium-gateway-api/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.008259417e6adf8980695ebbbb46553f.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/cilium-gateway-api/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/cilium-gateway-api/" />
  <meta property="og:title" content="使用 Cilium 实现 Gateway API 指南 | 云原生社区（中国）" />
  <meta property="og:description" content="这篇文章介绍了如何使用 Cilium 部署和配置 Gateway API，一个新的服务网格 API，用于管理 Kubernetes 中的服务间通信。文章详细说明了 Gateway API 的概念和组件，以及如何使用 Cilium 的特性和工具，实现高效和灵活的路由策略。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2024-01-04T08:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2024-01-04T18:15:30&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/cilium-gateway-api/"
  },
  "headline": "使用 Cilium 实现 Gateway API 指南",
  
  "datePublished": "2024-01-04T08:00:00+08:00",
  "dateModified": "2024-01-04T18:15:30+08:00",
  
  "author": {
    "@type": "Person",
    "name": "Smaine Kahlouch"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "这篇文章介绍了如何使用 Cilium 部署和配置 Gateway API，一个新的服务网格 API，用于管理 Kubernetes 中的服务间通信。文章详细说明了 Gateway API 的概念和组件，以及如何使用 Cilium 的特性和工具，实现高效和灵活的路由策略。"
}
</script>

  

  

  

  





  <title>使用 Cilium 实现 Gateway API 指南 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="d762145f09c744ea9373f531102df15a" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>使用 Cilium 实现 Gateway API 指南</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/smaine-kahlouch/">Smaine Kahlouch</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
    <i class="fa fa-language"></i>
    

  <span >
      <a href="/translators/%E4%BA%91%E5%8E%9F%E7%94%9F%E7%A4%BE%E5%8C%BA/">云原生社区</a></span>
    <span class="middot-divider"></span>
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/cilium/" class="text-capitalize">Cilium</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2024-01-04
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 4820
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 22 分钟
  </span>
  

  
  
  
  

</div>

    




<div class="btn-links mb-2">
  
  








  


















  
  
  
  
  
  
  
    
  
  <a class="btn btn-outline-primary btn-page-header" href="https://blog.ogenki.io/post/cilium-gateway-api/" target="_blank" rel="noopener">
    <i class="fa fa-language mr-1"></i>阅读英文版原文</a>


</div>


  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#我们的目标">我们的目标</a></li>
    <li><a href="#介绍-gateway-api">介绍 Gateway API</a></li>
    <li><a href="#先决条件">先决条件</a></li>
    <li><a href="#入口点gatewayclass-和-gateway">入口点：GatewayClass 和 Gateway</a></li>
    <li><a href="#路由规则httproute">路由规则：HTTPRoute</a>
      <ul>
        <li><a href="#基本规则">基本规则</a></li>
        <li><a href="#配置-tls-证书">配置 TLS 证书</a></li>
        <li><a href="#在多个命名空间中共享-gateway">在多个命名空间中共享 Gateway</a></li>
        <li><a href="#流量分流">流量分流</a></li>
        <li><a href="#修改标头">修改标头</a></li>
      </ul>
    </li>
    <li><a href="#分配适当的权限">分配适当的权限</a></li>
    <li><a href="#乍一看有点模糊">乍一看有点模糊</a></li>
    <li><a href="#最后的想法">最后的想法</a></li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#我们的目标">我们的目标</a></li>
    <li><a href="#介绍-gateway-api">介绍 Gateway API</a></li>
    <li><a href="#先决条件">先决条件</a></li>
    <li><a href="#入口点gatewayclass-和-gateway">入口点：GatewayClass 和 Gateway</a></li>
    <li><a href="#路由规则httproute">路由规则：HTTPRoute</a>
      <ul>
        <li><a href="#基本规则">基本规则</a></li>
        <li><a href="#配置-tls-证书">配置 TLS 证书</a></li>
        <li><a href="#在多个命名空间中共享-gateway">在多个命名空间中共享 Gateway</a></li>
        <li><a href="#流量分流">流量分流</a></li>
        <li><a href="#修改标头">修改标头</a></li>
      </ul>
    </li>
    <li><a href="#分配适当的权限">分配适当的权限</a></li>
    <li><a href="#乍一看有点模糊">乍一看有点模糊</a></li>
    <li><a href="#最后的想法">最后的想法</a></li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>
</details>

                    
                    <p>在 Kubernetes 上部署应用程序后，通常的下一步是让用户可以访问它。我们通常使用<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener"><strong>Ingress 控制器</strong></a>，例如 Nginx、Haproxy、Traefik 或来自云提供商的控制器，来引导传入的流量到应用程序，管理负载平衡、TLS 终止等等。</p>
<p>然后，我们必须从众多<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener">可用的选项</a> 中进行选择。Cilium 是其中一个相对较新的选项，旨在处理所有这些网络方面的问题。</p>
<p><a href="https://cilium.io/" target="_blank" rel="noopener"><strong>Cilium</strong></a> 是一个基于 eBPF 的开源网络和安全解决方案，其采用速度增长迅猛。它可能是提供最多功能的网络插件之一。我们不会涵盖所有功能，但其中一个功能涉及使用<a href="https://gateway-api.sigs.k8s.io/" target="_blank" rel="noopener"><strong>Gateway API</strong></a> (<code>GAPI</code>) 管理传入流量。</p>
<h2 id="我们的目标">我们的目标</h2>
<ul>
<li>准确了解 <strong>Gateway API</strong> 是什么，以及它如何代表从 <code>Ingress</code> API 进化而来。</li>
<li>演示以 GitOps 方式部署的真实场景。</li>
<li>当前的限制和即将推出的新功能。</li>
</ul>
<div class="alert-note-title">
    <p>提示</p>
</div>
<div class="alert alert-note">
    <p>本文中执行的所有步骤都来自这个<a href="https://github.com/Smana/cilium-gateway-api" target="_blank" rel="noopener"><strong>git 存储库</strong></a>。</p>
<p>我鼓励你探索它，因为它远远超出了本文的范围：</p>
<ul>
<li>使用启用了 kube-proxy 替代并具有专用 Daemonset 用于 <code>Envoy</code> 的 <code>Cilium</code> 配置的 <strong>EKS</strong> 集群的安装。</li>
<li>提出了具有依赖关系管理和我认为非常高效的 DRY 代码的 <code>Flux</code> 结构。</li>
<li>简化了用于平台组件的 IAM 权限管理的 <code>Crossplane</code> 和 <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="noopener">IRSA</a> 组合。</li>
<li>使用 <code>External-DNS</code> 和 <code>Let's Encrypt</code> 自动管理域名和证书。</li>
</ul>
<p>这个想法是只需几分钟内设置好一切，只需一个命令行。</p>

</div>

<h2 id="介绍-gateway-api">介绍 Gateway API</h2>
<p>正如前面提到的，有许多<strong>Ingress 控制器</strong>选项，每个都有其特定性和特殊功能，有时会使它们的使用变得复杂。此外，Kubernetes 中传统的 <code>Ingress</code> API 具有非常有限的参数。一些解决方案甚至创建了自己的<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener">CRDs</a>（Kubernetes 自定义资源），而其他解决方案则使用 <code>annotations</code> 来克服这些限制。</p>
<p>这就是<strong>Gateway API</strong>的用武之地！实际上，这是一种<strong>标准</strong>，允许声明高级网络功能，而无需对底层控制器进行特定扩展。而且，由于所有控制器都使用相同的 API，因此可以在不改变配置的情况下从一个解决方案切换到另一个解决方案（Kubernetes 清单描述了如何路由传入流量）。</p>
<p>在我们将要探讨的概念中，GAPI 引入了一个精细的授权模型，定义了具有不同权限的<strong>显式角色</strong>（有关 GAPI 安全模型的更多信息，请参阅<a href="https://gateway-api.sigs.k8s.io/concepts/security-model/#roles-and-personas" target="_blank" rel="noopener">这里</a>）。</p>
<p>值得注意的是，该项目由<a href="https://github.com/kubernetes/community/tree/master/sig-network" target="_blank" rel="noopener">sig-network-kubernetes</a>工作组推动，还有一个 Slack <a href="https://kubernetes.slack.com/archives/CR0H13KGA" target="_blank" rel="noopener">频道</a>，你可以在需要时联系他们。</p>
<p>让我们看看在实践中如何使用 GAPI 与 Cilium！</p>
<h2 id="先决条件">先决条件</h2>
<p>在本文的其余部分，我们假设已部署了一个 EKS 集群。如果你没有使用<a href="https://github.com/Smana/cilium-gateway-api/tree/main/terraform/eks" target="_blank" rel="noopener">演示存储库中建议的方法</a>作为本文的基础，那么有一些<strong>要检查的要点</strong>，以便使用 GAPI。</p>
<p>此处描述的安装方法基于 <code>Helm</code>，所有的 <code>values</code> 可以在<a href="https://github.com/Smana/cilium-gateway-api/blob/main/terraform/eks/helm_values/cilium.yaml" target="_blank" rel="noopener">这里</a>查看。</p>
<ul>
<li>
<p>在<a href="https://github.com/kubernetes-sigs/gateway-api/tree/main/config/crd" target="_blank" rel="noopener">Gateway API</a>存储库中<strong>安装</strong>可用的 <code>CRDs</code>。</p>
<div class="alert-note-title">
    <p>注意</p>
</div>
<div class="alert alert-note">
    如果 Cilium 设置为支持 <code>GAPI</code>（见下文），并且缺少 CRDs，则它将无法启动。在<a href="https://github.com/Smana/cilium-gateway-api" target="_blank" rel="noopener">演示存储库</a>中，<strong>GAPI CRDs</strong>在集群创建期间安装一次，以便 Cilium 可以启动，然后由 Flux 管理。
</div>

</li>
<li>
<p>使用 Cilium 和 <code>eBPF</code> 的网络转发功能<strong>替换</strong> <code>kube-proxy</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kubeProxyReplacement</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p><strong>启用</strong> Gateway API 支持。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">gatewayAPI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p><strong>检查</strong>安装。为此，你需要安装名为 <code>cilium</code> 的命令行工具。我个人使用 <a href="https://blog.ogenki.io/post/asdf/asdf/" target="_blank" rel="noopener">asdf</a>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">asdf plugin-add cilium-cli
</span></span></span><span class="line"><span class="cl"><span class="go">asdf install cilium-cli 0.15.7
</span></span></span><span class="line"><span class="cl"><span class="go">asdf global cilium 0.15.7
</span></span></span></code></pre></div><p>以下命令允许确保所有组件都正常运行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cilium status --wait
</span></span></span><span class="line"><span class="cl"><span class="go">   /¯¯\
</span></span></span><span class="line"><span class="cl"><span class="go">/¯¯\__/¯¯\    Cilium:             OK
</span></span></span><span class="line"><span class="cl"><span class="go">\__/¯¯\__/    Operator:           OK
</span></span></span><span class="line"><span class="cl"><span class="go">/¯¯\__/¯¯\    Envoy DaemonSet:    OK
</span></span></span><span class="line"><span class="cl"><span class="go">\__/¯¯\__/    Hubble Relay:       disabled
</span></span></span><span class="line"><span class="cl"><span class="go">   \__/       ClusterMesh:        disabled
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Deployment             cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span></span><span class="line"><span class="cl"><span class="go">DaemonSet              cilium             Desired: 2, Ready: 2/2, Available: 2/2
</span></span></span><span class="line"><span class="cl"><span class="go">DaemonSet              cilium-envoy       Desired: 2, Ready: 2/2, Available: 2/2
</span></span></span><span class="line"><span class="cl"><span class="go">Containers:            cilium             Running: 2
</span></span></span><span class="line"><span class="cl"><span class="go">                      cilium-operator    Running: 2
</span></span></span><span class="line"><span class="cl"><span class="go">                      cilium-envoy       Running: 2
</span></span></span><span class="line"><span class="cl"><span class="go">Cluster Pods:          33/33 managed by Cilium
</span></span></span><span class="line"><span class="cl"><span class="go">Helm chart version:    1.14.2
</span></span></span><span class="line"><span class="cl"><span class="go">Image versions         cilium             quay.io/cilium/cilium:v1.14.2@sha256:6263f3a3d5d63b267b538298dbeb5ae87da3efacf09a2c620446c873ba807d35: 2
</span></span></span><span class="line"><span class="cl"><span class="go">                      cilium-operator    quay.io/cilium/operator-aws:v1.14.2@sha256:8d514a9eaa06b7a704d1ccead8c7e663334975e6584a815efe2b8c15244493f1: 2
</span></span></span><span class="line"><span class="cl"><span class="go">                      cilium-envoy       quay.io/cilium/cilium-envoy:v1.25.9-e198a2824d309024cb91fb6a984445e73033291d@sha256:52541e1726041b050c5d475b3c527ca4b8da487a0bbb0309f72247e8127af0ec: 2
</span></span></span></code></pre></div><p>最后，你可以通过运行以下命令来检查是否启用了 Gateway API 支持：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cilium config view | grep -w &#34;enable-gateway-api&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">enable-gateway-api                                true
</span></span></span><span class="line"><span class="cl"><span class="go">enable-gateway-api-secrets-sync                   true
</span></span></span></code></pre></div><p>你还可以运行以下端到端测试：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cilium connectivity test
</span></span></span></code></pre></div><p>但是，此命令（<code>connectivity test</code>）当前在启用 Envoy 作为 DaemonSet 时会抛出错误。(<a href="https://github.com/cilium/cilium/issues/28057" target="_blank" rel="noopener">Github Issue</a>)。</p>
</li>
</ul>
<div class="alert-note-title">
    <p>提示</p>
</div>
<div class="alert alert-note">
    <p><strong>Envoy 作为 DaemonSet</strong></p>
<p>默认情况下，Cilium 代理还在同一 Pod 中运行 <code>Envoy</code>，并委托给它级别 7 的网络操作。从版本 <code>v1.14</code> 开始，可以将 Envoy 单独部署，这带来了一些好处：</p>
<ul>
<li>如果修改/重新启动一个组件（无论是 Cilium 还是 Envoy），都不会影响另一个组件。</li>
<li>更好地分配资源给每个组件以优化性能。</li>
<li>在某个 Pod 被攻击的情况下限制攻击面。</li>
<li>Envoy 日志和 Cilium 代理日志不会混合在一起。</li>
</ul>
<p>你可以使用以下命令来检查此功能是否已启用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cilium status
</span></span></span><span class="line"><span class="cl"><span class="go">    /¯¯\
</span></span></span><span class="line"><span class="cl"><span class="go"> /¯¯\__/¯¯\    Cilium:             OK
</span></span></span><span class="line"><span class="cl"><span class="go"> \__/¯¯\__/    Operator:           OK
</span></span></span><span class="line"><span class="cl"><span class="go"> /¯¯\__/¯¯\    Envoy DaemonSet:    OK
</span></span></span><span class="line"><span class="cl"><span class="go"> \__/¯¯\__/    Hubble Relay:       disabled
</span></span></span><span class="line"><span class="cl"><span class="go">    \__/       ClusterMesh:        disabled
</span></span></span></code></pre></div><p><a href="https://isovalent.com/blog/post/cilium-release-114/#h-envoy-daemonset" target="_blank" rel="noopener">更多信息</a>。</p>

</div>

<h2 id="入口点gatewayclass-和-gateway">入口点：GatewayClass 和 Gateway</h2>
<p>















<figure  id="figure-网关">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="网关" srcset="
               /blog/cilium-gateway-api/gateway_hu052a454012dce8476457ee2d39f00b3d_54224_ca3fe50a3a0d3a5c7207fd3bf88102b0.webp 400w,
               /blog/cilium-gateway-api/gateway_hu052a454012dce8476457ee2d39f00b3d_54224_aaf52ec10c35f75782e76cd95d152029.webp 760w,
               /blog/cilium-gateway-api/gateway_hu052a454012dce8476457ee2d39f00b3d_54224_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/cilium-gateway-api/gateway_hu052a454012dce8476457ee2d39f00b3d_54224_ca3fe50a3a0d3a5c7207fd3bf88102b0.webp"
               width="760"
               height="557"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      网关
    </figcaption></figure>
</p>
<p>一旦满足先决条件，我们就可以访问多个元素。我们可以利用 Gateway API CRDs 定义的自定义资源。而且，在安装 Cilium 后，一个 <code>GatewayClass</code> 立即可用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kubectl get gatewayclasses.gateway.networking.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="go">NAME     CONTROLLER                     ACCEPTED   AGE
</span></span></span><span class="line"><span class="cl"><span class="go">cilium   io.cilium/gateway-controller   True       7m59s
</span></span></span></code></pre></div><p>在 Kubernetes 集群上，你可以配置多个 <code>GatewayClasses</code>，从而能够使用不同的实现。例如，我们可以通过在 <code>Gateway</code> 配置中引用 GatewayClass 来使用 <code>Linkerd</code>。</p>
<p><code>Gateway</code> 是允许触发在云提供商中创建负载均衡组件的资源。</p>
<p>这是一个简单的示例：<a href="https://github.com/Smana/cilium-gateway-api/blob/main/apps/base/echo/gateway.yaml" target="_blank" rel="noopener">apps/base/echo/gateway.yaml</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-1-echo-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">allowedRoutes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l">Same</span><span class="w">
</span></span></span></code></pre></div><p>在 AWS（EKS）上，配置 <code>Gateway</code> 时，Cilium 会创建一个类型为 <code>LoadBalancer</code> 的 <code>Service</code>。然后，另一个控制器（<a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller" target="_blank" rel="noopener">AWS Load Balancer Controller</a>）处理云负载均衡器（<a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html" target="_blank" rel="noopener">NLB</a>）的创建。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kubectl get svc -n echo cilium-gateway-echo
</span></span></span><span class="line"><span class="cl"><span class="go">NAME                  TYPE           CLUSTER-IP     EXTERNAL-IP                                                                 PORT(S)        AGE
</span></span></span><span class="line"><span class="cl"><span class="go">cilium-gateway-echo   LoadBalancer   172.20.19.82   k8s-echo-ciliumga-64708ec85c-fcb7661f1ae4e4a4.elb.eu-west-3.amazonaws.com   80:30395/TCP   2m58s
</span></span></span></code></pre></div><p>值得注意的是，负载均衡器地址也与 <code>Gateway</code> 相关联。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kubectl get gateway -n echo echo
</span></span></span><span class="line"><span class="cl"><span class="go">NAME   CLASS    ADDRESS                                                                     PROGRAMMED   AGE
</span></span></span><span class="line"><span class="cl"><span class="go">echo   cilium   k8s-echo-ciliumga-64708ec85c-fcb7661f1ae4e4a4.elb.eu-west-3.amazonaws.com   True         16m
</span></span></span></code></pre></div><h2 id="路由规则httproute">路由规则：HTTPRoute</h2>
<h3 id="基本规则">基本规则</h3>
<p>















<figure  id="figure-httproute">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img src="httproute.jpg" alt="HTTPRoute" loading="lazy" data-zoomable /></div>
  </div><figcaption>
      HTTPRoute
    </figcaption></figure>
</p>
<p>简而言之，上面的图表可总结为几句话：<code>HTTPRoute</code> 允许通过引用 Gateway 并定义所需的路由参数来配置到服务的路由。</p>
<div class="alert-note-title">
    <p>提示</p>
</div>
<div class="alert alert-note">
    <p><strong>Kyverno</strong></p>
<p>截止目前，无法配置由 <code>Gateways</code> 生成的服务的注释（<a href="https://github.com/cilium/cilium/issues/25357" target="_blank" rel="noopener">Github Issue</a>）。已提出一种解决方法，即在创建 <code>Gateway</code> 后立即修改由 <code>Gateway</code> 创建的服务。</p>
<p>Kyverno 是一种确保配置符合最佳实践和安全要求的工具。我们在这里仅仅使用它来轻松描述<a href="https://kyverno.io/docs/writing-policies/mutate/" target="_blank" rel="noopener">突变</a>规则。</p>
<p><a href="https://github.com/Smana/cilium-gateway-api/blob/main/security/mycluster-0/echo-gw-clusterpolicy.yaml" target="_blank" rel="noopener">security/mycluster-0/echo-gw-clusterpolicy.yaml</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mutate-svc-annotations</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">any</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">kinds</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cilium-gateway-echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mutate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">patchStrategicMerge</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">external-dns.alpha.kubernetes.io/hostname</span><span class="p">:</span><span class="w"> </span><span class="l">echo.${domain_name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service.beta.kubernetes.io/aws-load-balancer-scheme</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;internet-facing&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">service.k8s.aws/nlb</span><span class="w">
</span></span></span></code></pre></div><p>因此，服务 <code>cilium-gateway-echo</code> 将添加 AWS 控制器的注释，以及一个允许自动 DNS 记录配置的注释。</p>

</div>

<p><a href="https://github.com/Smana/cilium-gateway-api/blob/main/apps/base/echo/httproute.yaml" target="_blank" rel="noopener">apps/base/echo/httproute.yaml</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-1-echo-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>上面使用的示例非常简单：所有请求都会转发到 <code>echo-1-echo-server</code> 服务。</p>
<p><code>parentRefs</code> 指示使用哪个 <code>Gateway</code>，然后在 <code>rules</code> 部分定义了路由规则。</p>
<p>路由规则还可以基于 <code>path</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">foo.bar.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/login</span><span class="w">
</span></span></span></code></pre></div><p>或者基于 HTTP 标头</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">headers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;version&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></div><p>让我们检查服务是否可访问。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">curl -s http://echo.cloud.ogenki.io | jq -rc &#39;.environment.HOSTNAME&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">echo-1-echo-server-fd88497d-w6sgn
</span></span></span></code></pre></div><p>正如你所看到的，该服务以 HTTP 方式暴露，没有证书。让我们尝试解决这个问题。</p>
<h3 id="配置-tls-证书">配置 TLS 证书</h3>
<p>有多种方法可以使用 GAPI 配置 TLS。在这里，我们将使用最常见的情况：HTTPS 协议和在 Gateway 上终止 TLS。</p>
<p>假设我们想要配置之前使用的域名 <code>echo.cloud.ogenki.io</code>。配置主要通过配置 <code>Gateway</code> 来完成。</p>
<p><a href="https://github.com/Smana/cilium-gateway-api/blob/main/apps/base/echo/tls-gateway.yaml" target="_blank" rel="noopener">apps/base/echo/tls-gateway.yaml</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo.${domain_name}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">allowedRoutes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l">Same</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">Terminate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">certificateRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-tls</span><span class="w">
</span></span></span></code></pre></div><p>这里的关键点是引用一个包含名称为 <code>echo-tls</code> 的证书的密钥。这个证书可以手动创建，但是为了本文，我选择使用 <strong>Let&rsquo;s Encrypt</strong> 和 <code>cert-manager</code> 来自动化这个过程。</p>
<div class="alert-note-title">
    <p>提示</p>
</div>
<div class="alert alert-note">
    <p>}
<strong>cert-manager</strong></p>
<p>使用 <code>cert-manager</code>，自动创建和更新由 <code>Gateway</code> 暴露的证书非常简单。为此，你需要允许控制器访问 <a href="https://aws.amazon.com/route53/" target="_blank" rel="noopener">route53</a>，以解决 DNS01 挑战（这是一种确保客户端只能为自己拥有的域请求证书的机制）。</p>
<p><a href="https://github.com/Smana/cilium-gateway-api/blob/main/security/base/cert-manager/cluster-issuer-staging.yaml" target="_blank" rel="noopener">ClusterIssuer</a> 资源描述了使用 cert-manager 生成证书所需的配置。</p>
<p>接下来，我们只需要添加一个注释 <code>cert-manager.io/cluster-issuer</code> 并设置存储证书的 Kubernetes 密钥。</p>
<p><a href="https://cert-manager.io/docs/usage/gateway/" target="_blank" rel="noopener">更多信息</a></p>
<p>在演示存储库中，权限是使用 <code>Crossplane</code> 分配的，它负责在 AWS 中配置这些 IAM 权限。</p>

</div>

<p>为了使路由正常工作，你还需要将 <code>HTTPRoute</code> 附加到正确的 <code>Gateway</code> 并指定域名。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;echo.${domain_name}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></div><p>几秒钟后，证书将被创建。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kubectl get cert -n echo
</span></span></span><span class="line"><span class="cl"><span class="go">NAME       READY   SECRET     AGE
</span></span></span><span class="line"><span class="cl"><span class="go">echo-tls   True    echo-tls   43m
</span></span></span></code></pre></div><p>最后，我们可以检查证书确实来自 Let&rsquo;s Encrypt，如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">curl https://echo.cloud.ogenki.io -v 2&gt;&amp;1 | grep -A 6 &#39;Server certificate&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">* Server certificate:
</span></span></span><span class="line"><span class="cl"><span class="go">*  subject: CN=echo.cloud.ogenki.io
</span></span></span><span class="line"><span class="cl"><span class="go">*  start date: Sep 15 14:43:00 2023 GMT
</span></span></span><span class="line"><span class="cl"><span class="go">*  expire date: Dec 14 14:42:59 2023 GMT
</span></span></span><span class="line"><span class="cl"><span class="go">*  subjectAltName: host &#34;echo.cloud.ogenki.io&#34; matched cert&#39;s &#34;echo.cloud.ogenki.io&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">*  issuer: C=US; O=Let&#39;s Encrypt; CN=R3
</span></span></span><span class="line"><span class="cl"><span class="go">*  SSL certificate verify ok.
</span></span></span></code></pre></div><div class="alert-note-title">
    <p>提示</p>
</div>
<div class="alert alert-note">
    GAPI 还允许你配置 <strong>端到端的 TLS</strong>，一直到容器。这是通过配置 <code>Gateway</code> 为 <code>Passthrough</code> 模式并使用 <code>TLSRoute</code> 资源来完成的。证书也必须由执行 TLS 终止的 pod 携带。
</div>

<h3 id="在多个命名空间中共享-gateway">在多个命名空间中共享 Gateway</h3>
<p>















<figure  id="figure-共享网关">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="共享网关" srcset="
               /blog/cilium-gateway-api/shared-gateway_hu674c7133083fe92ba85944442e1371df_93399_97766d073a16afb69fb4a8960adda925.webp 400w,
               /blog/cilium-gateway-api/shared-gateway_hu674c7133083fe92ba85944442e1371df_93399_54a309cae4661b3563828ac161178bad.webp 760w,
               /blog/cilium-gateway-api/shared-gateway_hu674c7133083fe92ba85944442e1371df_93399_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/cilium-gateway-api/shared-gateway_hu674c7133083fe92ba85944442e1371df_93399_97766d073a16afb69fb4a8960adda925.webp"
               width="760"
               height="507"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      共享网关
    </figcaption></figure>
</p>
<p>使用 <code>GAPI</code>，你可以在 <code>命名空间</code> 之间路由流量。这得益于每个功能的不同资源：一个 <code>Gateway</code> 允许配置基础设施，以及 <code>*Routes</code>。这些路由可以附加到位于另一个命名空间中的 Gateway。因此，不同的团队/项目可以共享相同的基础设施组件。</p>
<p>但是，这需要指定哪个路由允许引用该 Gateway。在这里，我们假设我们有一个专门用于内部工具的 Gateway，名为 <code>platform</code>。通过使用 <code>allowedRoutes</code> 参数，我们明确指定了哪些命名空间允许附加到此 Gateway。</p>
<p><a href="https://github.com/Smana/cilium-gateway-api/blob/main/infrastructure/base/gapi/platform-gateway.yaml" target="_blank" rel="noopener">infrastructure/base/gapi/platform-gateway.yaml</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">allowedRoutes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l">Selector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="l">observability</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="l">flux-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">Terminate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">certificateRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">platform-tls</span><span class="w">
</span></span></span></code></pre></div><p>在命名空间 <code>observability</code> 和 <code>flux-system</code> 中配置的 <code>HTTPRoutes</code> 附加到此唯一的 <code>Gateway</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">platform</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure</span><span class="w">
</span></span></span></code></pre></div><p>因此，使用来自云提供商的相同负载均衡器。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">NLB_DOMAIN=$(kubectl get svc -n infrastructure cilium-gateway-platform -o jsonpath={.status.loadBalancer.ingress[0].hostname})
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">dig +short ${NLB_DOMAIN}
</span></span></span><span class="line"><span class="cl"><span class="go">13.36.89.108
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">dig +short grafana-mycluster-0.cloud.ogenki.io
</span></span></span><span class="line"><span class="cl"><span class="go">13.36.89.108
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">dig +short gitops-mycluster-0.cloud.ogenki.io
</span></span></span><span class="line"><span class="cl"><span class="go">13.36.89.108
</span></span></span></code></pre></div><div class="alert-note-title">
    <p>注意</p>
</div>
<div class="alert alert-note">
    这些内部工具不应该暴露在互联网上，但是你知道：这只是一个演示。例如，我们可以使用内部 Gateway（私有 IP）通过调整注释并使用私有连接系统（VPN、隧道等）来实现。
</div>

<h3 id="流量分流">流量分流</h3>
<p>















<figure  id="figure-分流">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="分流" srcset="
               /blog/cilium-gateway-api/split_hu65c77c2437bb4a145d7de277091dab88_84912_9bf9e528fab131ded16d11b54864e553.webp 400w,
               /blog/cilium-gateway-api/split_hu65c77c2437bb4a145d7de277091dab88_84912_0ef6c9df2a0b5bc65cf0d062c6415d3e.webp 760w,
               /blog/cilium-gateway-api/split_hu65c77c2437bb4a145d7de277091dab88_84912_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/cilium-gateway-api/split_hu65c77c2437bb4a145d7de277091dab88_84912_9bf9e528fab131ded16d11b54864e553.webp"
               width="760"
               height="517"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      分流
    </figcaption></figure>
</p>
<p>由服务网格常常提供的一个功能是在有新版本可用时（A/B 测试或金丝雀部署）对部分流量测试应用程序的能力。<code>GAPI</code>通过使用权重来实现这一点，使其变得非常简单。</p>
<p>以下是一个将 5% 的流量转发到服务 <code>echo-2-echo-server</code> 的示例：</p>
<p><a href="https://github.com/Smana/cilium-gateway-api/blob/main/apps/base/echo/httproute-split.yaml" target="_blank" rel="noopener">apps/base/echo/httproute-split.yaml</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;split-echo.${domain_name}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-1-echo-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">95</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-2-echo-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span></code></pre></div><p>让我们检查分发是否按预期进行：</p>
<p><a href="https://github.com/Smana/cilium-gateway-api/blob/main/scripts/check-split.sh" target="_blank" rel="noopener">scripts/check-split.sh</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">./scripts/check-split.sh https://split-echo.cloud.ogenki.io
</span></span></span><span class="line"><span class="cl"><span class="go">echo-1 的请求次数：95
</span></span></span><span class="line"><span class="cl"><span class="go">echo-2 的请求次数：5
</span></span></span></code></pre></div><h3 id="修改标头">修改标头</h3>
<p>还可以更改 HTTP <strong>标头</strong>：添加、修改或删除它们。这些修改可以通过在 <code>HTTPRoute</code> 清单中使用 <a href="https://gateway-api.sigs.k8s.io/api-types/httproute#filters-optional" target="_blank" rel="noopener">filters</a> 应用于请求标头或响应标头。</p>
<p>例如，我们将在 <strong>请求</strong> 中添加一个标头。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/req-header-add</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RequestHeaderModifier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requestHeaderModifier</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">add</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">echo-1-echo-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></div><p>此命令允许查看标头是否确实已添加：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">curl -s https://echo.cloud.ogenki.io/req-header-add | jq &#39;.request.headers&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">{
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;host&#34;: &#34;echo.cloud.ogenki.io&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;user-agent&#34;: &#34;curl/8.2.1&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;accept&#34;: &#34;*/*&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;x-forwarded-for&#34;: &#34;81.220.234.254&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;x-forwarded-proto&#34;: &#34;https&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;x-envoy-external-address&#34;: &#34;81.220.234.254&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;x-request-id&#34;: &#34;320ba4d2-3bd6-4c2f-8a97-74296a9f3f26&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">  &#34;foo&#34;: &#34;bar&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">}
</span></span></span></code></pre></div><h2 id="分配适当的权限">分配适当的权限</h2>
<p><code>GAPI</code> 提供了一种清晰的权限共享模型，用于管理流量路由基础设施（由集群管理员管理）和应用程序（由开发人员管理）之间的关系。</p>
<p>多个自定义资源的可用性允许使用 Kubernetes 的 <strong>RBAC</strong> 配置以声明性方式分配权限。我已经添加了一些示例，这些示例在我的演示集群中没有效果，但可能会给你一个想法。</p>
<p>下面的配置授予 <code>developers</code> 组的成员在 echo 命名空间内管理 <code>HTTPRoutes</code> 的能力，同时仅提供对 <code>Gateways</code> 的读取权限。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gapi-developer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;gateway.networking.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;httproutes&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;gateway.networking.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;gateways&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gapi-developer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;developers&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gapi-developer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><h2 id="乍一看有点模糊">乍一看有点模糊</h2>
<p>人们可能会对通常称为 <code>API 网关</code> 的东西感到困惑。已经创建了 <a href="https://gateway-api.sigs.k8s.io/faq/" target="_blank" rel="noopener">FAQ</a> 的一个部分，以澄清它与 <code>Gateway API</code> 的不同之处。尽管 GAPI 提供了通常在 API 网关中找到的功能，但它主要是 Kubernetes 的一个特定实现。然而，选择这个名称确实可能引起 <strong>混淆</strong>。</p>
<p>此外，请注意，本文仅关注入站流量，通常由 <em>Ingress Controllers</em> 管理，称为 <a href="https://gateway-api.sigs.k8s.io/concepts/glossary/#northsouth-traffic" target="_blank" rel="noopener">南北</a>，这实际上是 GAPI 的初始范围。最近的一个名为 <a href="https://gateway-api.sigs.k8s.io/concepts/gamma/" target="_blank" rel="noopener"><strong>GAMMA</strong></a> 的倡议旨在处理 <a href="https://gateway-api.sigs.k8s.io/concepts/glossary/#eastwest-traffic" target="_blank" rel="noopener">东西流量</a> 路由，这将在将来标准化某些常见的功能，通常由 <code>Service Meshes</code> 解决方案提供。（有关更多详细信息，请参阅 <a href="https://kubernetes.io/blog/2023/08/29/gateway-api-v0-8/" target="_blank" rel="noopener">此文章</a>）。</p>
<h2 id="最后的想法">最后的想法</h2>
<p>老实说，我已经知道 <strong>Gateway API</strong> 有一段时间了。尽管我读了一些文章，但我并没有真正深入研究过。我会想：“为什么要麻烦呢？我的 <em>Ingress Controller</em> 可以工作，而且这需要学习曲线。”</p>
<p>GAPI 正在崭露头角，即将发布 GA 版本。多个 <a href="https://gateway-api.sigs.k8s.io/implementations/" target="_blank" rel="noopener">项目</a> 已经拥抱它，这个用于管理 Kubernetes 内流量的 API 将迅速成为标准。</p>
<p>我必须说，配置 GAPI 感觉直观而明确。它的安全模型取得了平衡，赋予开发人员权力而不会损害安全性。而且无缝的基础设施管理？你可以在不触及 <code>*Routes</code> 的情况下在不同的实现之间切换。</p>
<p>现在就用 <code>Cilium</code> 交换我的 Ingress Controller 吗？<strong>还没有，但它即将到来</strong>。</p>
<p>值得强调的是，Cilium 的功能非常广泛：在 Kubernetes 周围有大量的工具，Cilium 脱颖而出，承诺提供指标、跟踪、服务网格、安全性，以及 <em>Ingress Controller</em> 与 GAPI。</p>
<p>然而，需要注意一些挑战：</p>
<ul>
<li><a href="https://github.com/cilium/cilium/issues/21929" target="_blank" rel="noopener">TCP 和 UDP 支持</a></li>
<li><a href="https://github.com/cilium/cilium/issues/21928" target="_blank" rel="noopener">GRPC 支持</a></li>
<li>需要使用变异规则来配置云组件（<a href="https://github.com/cilium/cilium/issues/25357" target="_blank" rel="noopener">Github Issue</a>）。</li>
<li>本文讨论的许多功能仍处于实验阶段。例如，最新版本（我写作时的 <code>v1.14.2</code>）支持的 <a href="https://github.com/cilium/cilium/pull/27472" target="_blank" rel="noopener">扩展功能</a>。我尝试设置一个简单的 HTTP&gt;HTTPS 重定向，但遇到了 <a href="https://github.com/kubernetes-sigs/gateway-api/issues/1185" target="_blank" rel="noopener">这个问题</a>。因此，我预计 API 将来会有一些修改。</li>
</ul>
<p>虽然我只是涉及了 Cilium 的 GAPI 能够提供的一小部分内容（老实说，这篇文章已经相当长了），但我希望我们可以很快在生产中使用它。但考虑到前面提到的几点，我建议等待一段时间。不过，如果你想为未来做准备，那么现在是时候了！</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://gateway-api.sigs.k8s.io/" target="_blank" rel="noopener">https://gateway-api.sigs.k8s.io/</a></li>
<li><a href="https://docs.cilium.io/en/latest/network/servicemesh/gateway-api/gateway-api/#gs-gateway-api" target="_blank" rel="noopener">https://docs.cilium.io/en/latest/network/servicemesh/gateway-api/gateway-api/#gs-gateway-api</a></li>
<li><a href="https://isovalent.com/blog/post/cilium-gateway-api/" target="_blank" rel="noopener">https://isovalent.com/blog/post/cilium-gateway-api/</a></li>
<li><a href="https://isovalent.com/blog/post/tutorial-getting-started-with-the-cilium-gateway-api/" target="_blank" rel="noopener">https://isovalent.com/blog/post/tutorial-getting-started-with-the-cilium-gateway-api/</a></li>
<li>Isovalent 的 <a href="https://isovalent.com/resource-library/labs/" target="_blank" rel="noopener">labs</a> 是开始使用 Gateway API 并且你将获得新的徽章以添加到你的收藏中的好方法</li>
</ul>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/cilium/">Cilium</a>
  
  <a class="badge badge-light" href="/tag/gateway-api/">Gateway API</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    

    <div class="media-body">
      <p class="card-title"><a href="/author/smaine-kahlouch/">Smaine Kahlouch</a></p>
      
      
      
    </div>
  </div>


  


  
  
    




  




<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/scaling-and-sizing-the-sidecar/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>Istio Sidecar 的资源和性能管理：从监控到自动扩缩容的最佳实践</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/cilium-gateway-api/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/how-ciliums-mutual-authentication-can-compromise-security/">Ciilium 的相互认证如何危及安全</a></li>
      
      <li><a href="/blog/why-we-decided-to-start-fresh-with-our-nginx-gateway-fabric/">为什么我们决定从新开始我们的 NGINX Gateway Fabric</a></li>
      
      <li><a href="/blog/kubernetes-secure-development-best-practices-in-action/">Kubernetes 安全开发最佳实践的实际应用</a></li>
      
      <li><a href="/blog/deep-dive-into-cilium-multi-cluster/">深入了解 Cilium 多集群</a></li>
      
      <li><a href="/blog/cilium-1-4/">Cilium 1.4 发布了，新功能一览</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2024 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
