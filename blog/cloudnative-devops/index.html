<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="这篇文章通过对容器平台DevOps组件设计，从源码级别做了详尽介绍。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/cloudnative-devops/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/cloudnative-devops/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/cloudnative-devops/" />
  <meta property="og:title" content="云原生DevOps落地方案 | 云原生社区（中国）" />
  <meta property="og:description" content="这篇文章通过对容器平台DevOps组件设计，从源码级别做了详尽介绍。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2020-09-15T07:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-02-08T19:39:12&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/cloudnative-devops/"
  },
  "headline": "云原生DevOps落地方案",
  
  "datePublished": "2020-09-15T07:00:00+08:00",
  "dateModified": "2023-02-08T19:39:12+08:00",
  
  "author": {
    "@type": "Person",
    "name": "陈月新"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "这篇文章通过对容器平台DevOps组件设计，从源码级别做了详尽介绍。"
}
</script>

  

  

  

  





  <title>云原生DevOps落地方案 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="3699f97a738f7baf93934b944ccb616f" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>云原生DevOps落地方案</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E9%99%88%E6%9C%88%E6%96%B0/">陈月新</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/devops/" class="text-capitalize">DevOps</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2020-09-15
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 6968
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 32 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#devops简述">DevOps简述</a></li>
    <li><a href="#云原生devops特点">云原生DevOps特点</a></li>
    <li><a href="#云原生devops实现">云原生DevOps实现</a>
      <ul>
        <li><a href="#crd定义">CRD定义</a></li>
        <li><a href="#controller-实现">controller 实现</a></li>
        <li><a href="#缓存支持">缓存支持</a></li>
      </ul>
    </li>
    <li><a href="#hcaas-devops使用">HCaaS DevOps使用</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#devops简述">DevOps简述</a></li>
    <li><a href="#云原生devops特点">云原生DevOps特点</a></li>
    <li><a href="#云原生devops实现">云原生DevOps实现</a>
      <ul>
        <li><a href="#crd定义">CRD定义</a></li>
        <li><a href="#controller-实现">controller 实现</a></li>
        <li><a href="#缓存支持">缓存支持</a></li>
      </ul>
    </li>
    <li><a href="#hcaas-devops使用">HCaaS DevOps使用</a></li>
  </ul>
</nav>
</details>

                    
                    <h2 id="devops简述">DevOps简述</h2>
<p>顾名思义，DevOps就是开发（Development）与运维（Operations）的结合体，其目的就是打通开发与运维之间的壁垒，促进开发、运营和质量保障（QA）等部门之间的沟通协作，以便对产品进行小规模、快速迭代式地开发和部署，快速响应客户的需求变化。它强调的是开发运维一体化，加强团队间的沟通和快速反馈，达到快速交付产品和提高交付质量的目的。</p>
<p>DevOps并不是一种新的工具集，而是一种思想，一种文化，用以改变传统开发运维模式的一组最佳实践。一般做法是通过一些CI/CD（持续集成、持续部署）自动化的工具和流程来实现DevOps的思想，以流水线（pipeline）的形式改变传统开发人员和测试人员发布软件的方式。随着Docker和Kubernetes（以下简称k8s）等技术的普及，容器云平台基础设施越来越完善，加速了开发和运维角色的融合，使云原生的DevOps实践成为以后的趋势。下面我们基于混合容器云平台详细讲解下云平台下DevOps的落地方案。</p>
<h2 id="云原生devops特点">云原生DevOps特点</h2>
<p>DevOps是PaaS平台里很关键的功能模块，包含以下重要能力：支持代码克隆、编译代码、运行脚本、构建发布镜像、部署yaml文件以及部署Helm应用等环节；支持丰富的流水线设置，比如资源限额、流水线运行条数、推送代码以及推送镜像触发流水线运行等，提供了用户在不同环境下的端到端高效流水线能力；提供开箱即用的镜像仓库中心；提供流水线缓存功能，可以自由配置整个流水线或每个步骤的运行缓存，在代码克隆、编译代码、构建镜像等步骤时均可利用缓存大大缩短运行时间，提升执行效率。具体功能清单如下：</p>
<ul>
<li>缓存加速：自研容器化流水线的缓存技术，通过代码编译和镜像构建的缓存复用，平均加速流水线3~5倍；</li>
<li>细粒度缓存配置：任一阶段、步骤可以控制是否开启缓存及缓存路径；</li>
<li>支持临时配置：用户无需提交即可运行临时配置，避免频繁提交配置文件污染代码仓库；</li>
<li>开箱即用的镜像仓库；</li>
<li>提供完整的日志功能；</li>
<li>可视化编辑界面，灵活配置流水线；</li>
<li>支持多种代码仓库授权：GitHub、GitLab、Bitbucket等；</li>
<li>多种流水线触发方式：代码仓库触发，镜像推送触发等；</li>
<li>网络优化，加快镜像或依赖包的下载速度；</li>
</ul>
<h2 id="云原生devops实现">云原生DevOps实现</h2>
<p>简单地说，云原生DevOps内部功能的设计基本上均是通过k8s提供的自定义controller功能来实现的，基本逻辑就是根据业务需要抽象出多个CRD（Custom Resource Definition，自定义资源对象），并编写对应的controller来实现业务逻辑。为了实现CI/CD功能，我们抽象出了多个CRD对象，如下图所示：</p>
<p>















<figure  id="figure-图1-crd对象定义">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图1 CRD对象定义" srcset="
               /blog/cloudnative-devops/1_hucca35e3fbb2a388e677d5a25c97ec100_50673_13822f317aba3730d50673d288ab3057.webp 400w,
               /blog/cloudnative-devops/1_hucca35e3fbb2a388e677d5a25c97ec100_50673_7f9ec4edfa39e377500e0a8655896dbe.webp 760w,
               /blog/cloudnative-devops/1_hucca35e3fbb2a388e677d5a25c97ec100_50673_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/cloudnative-devops/1_hucca35e3fbb2a388e677d5a25c97ec100_50673_13822f317aba3730d50673d288ab3057.webp"
               width="760"
               height="296"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图1 CRD对象定义
    </figcaption></figure>
</p>
<center>图1 CRD对象定义</center>
<p>我们知道配置流水线通常需要对接代码仓库，包括仓库地址，仓库授权信息等，因此我们需要有3个CRD对象来记录源代码仓库的相关信息。</p>
<ul>
<li><code>sourceCodeProviderConfig</code>：记录仓库OAuth Apps的客户端ID、客户端秘钥；</li>
<li><code>sourceCodeCredential</code>：记录仓库的认证信息；</li>
<li><code>sourceCodeRepository</code>：记录仓库地址等信息。</li>
</ul>
<p>设计好了DevOps中与仓库相关的3个CRD对象后，我们需要再定义3个CRD对象来描述流水线相关的信息。</p>
<ul>
<li><code>pipeline</code>：记录该流水线的配置信息：仓库的认证信息、钩子触发配置以及项目代码地址等等；</li>
<li><code>pipelineExecution</code>：记录流水线运行时信息与执行结果信息等；</li>
<li><code>pipelineSetting</code>：记录整个项目下pipeline运行环境信息：内存、CPU的限制，最大流水线并行运行个数等等。</li>
</ul>
<p>pipeline步骤功能有很多种类型，包括运行脚本、构建发布镜像、发布应用模板、部署YAML、部署应用等等。为了提供这些功能，我们采用Jenkins作为底层的CI/CD工具，docker registry 作为镜像仓库中心，minio作为日志存储中心等等。这些服务是运行在pipeline所在项目的命名空间下。综上，我们设计的CI/CD系统功能的实现逻辑如图所示：</p>
<p>















<figure  id="figure-图2-逻辑示意图">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图2 逻辑示意图" srcset="
               /blog/cloudnative-devops/2_hu16a0ba59947264024acfae17980d2ba1_129489_e66c207651a0a6e9f1e661beee2b4bc9.webp 400w,
               /blog/cloudnative-devops/2_hu16a0ba59947264024acfae17980d2ba1_129489_aaab5aea15bd03ef30cef511879461e0.webp 760w,
               /blog/cloudnative-devops/2_hu16a0ba59947264024acfae17980d2ba1_129489_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/cloudnative-devops/2_hu16a0ba59947264024acfae17980d2ba1_129489_e66c207651a0a6e9f1e661beee2b4bc9.webp"
               width="760"
               height="307"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图2 逻辑示意图
    </figcaption></figure>
</p>
<center>图2 逻辑示意图</center>
<p>如上，当第一次运行流水线时，系统会在数据面k8s中部署Jenkins、minio等基础工具的服务，同时在管理面启动一个goroutine，实时同步数据面中流水线的作业状态到管理面的CRD对象中。当触发pipeline执行逻辑时，会产生一个pipelineExecution CRD对象，以记录本次运行pipeline的状态信息。当goroutine（syncState）发现有新的执行实例产生时，就会通过Jenkins引擎接口启动Jenkins server端流水线作业的运行，Jenkins server端收到信息后会启动单独的一个Jenkins slave pod进行流水线作业的响应。同时，goroutine（syncState）会不断地通过引擎接口轮询pipeline执行实例的运行情况进而更新 pipelineExecution CRD的状态（运行成功或失败等等）。当pipeline执行实例发生状态变化时，就会触发其对应的controller业务逻辑，进而通过Jenkins引擎接口与Jenkins server 通信进行不同的操作，比如，暂停流水线的运行，运行完清除不需要的资源等等。当流水线作业发生状态变化时，又会通过goroutine（syncState）更改pipeline执行实例的状态，进而又触发对应的controller业务代码进行不同的业务逻辑处理，往复循环，直到流水线运行结束。这就是整个pipeline执行时的一个逻辑流程。</p>
<h3 id="crd定义">CRD定义</h3>
<p>下面是详细的CRD结构体讲解，敏感信息使用了&rsquo;*&lsquo;代替。</p>
<p><code>pipelineSetting</code>：该结构体保存着整个项目下所有pipeline的运行环境信息，比如CPU/内存资源限额、缓存路径以及流水线运行的最大并行个数等等，不同功能的配置信息保存在不同的CRD下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">devops</span><span class="o">-</span><span class="nx">cache</span><span class="o">-</span><span class="nx">dir</span>            <span class="mi">12</span><span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="nx">executor</span><span class="o">-</span><span class="nx">cpu</span><span class="o">-</span><span class="nx">limit</span>          <span class="mi">12</span><span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="nx">executor</span><span class="o">-</span><span class="nx">cpu</span><span class="o">-</span><span class="nx">request</span>        <span class="mi">12</span><span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="nx">executor</span><span class="o">-</span><span class="nx">memory</span><span class="o">-</span><span class="nx">limit</span>       <span class="mi">12</span><span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="nx">executor</span><span class="o">-</span><span class="nx">memory</span><span class="o">-</span><span class="nx">request</span>     <span class="mi">12</span><span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="nx">executor</span><span class="o">-</span><span class="nx">quota</span>              <span class="mi">12</span><span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 比如，看下executor-quota详细信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">apiVersion</span><span class="p">:</span> <span class="nx">project</span><span class="p">.</span><span class="nx">cubepaas</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">v3</span>
</span></span><span class="line"><span class="cl"><span class="nx">kind</span><span class="p">:</span> <span class="nx">PipelineSetting</span>
</span></span><span class="line"><span class="cl"><span class="nx">metadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">labels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cubepaas</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">creator</span><span class="p">:</span> <span class="nx">linkcloud</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="p">:</span> <span class="nx">executor</span><span class="o">-</span><span class="nx">quota</span>
</span></span><span class="line"><span class="cl">  <span class="nx">namespace</span><span class="p">:</span> <span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span>
</span></span><span class="line"><span class="cl"><span class="k">default</span><span class="p">:</span> <span class="s">&#34;2&#34;</span> <span class="c1">// 默认最多可同时运行2个pipeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">projectName</span><span class="p">:</span> <span class="nx">c</span><span class="o">-</span><span class="mi">86</span><span class="nx">tgg</span><span class="p">:</span><span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span>
</span></span><span class="line"><span class="cl"><span class="nx">value</span><span class="p">:</span> <span class="s">&#34;3&#34;</span> <span class="c1">// 自定义设置，最多可同时运行3个pipeline，没有值会取上面默认值
</span></span></span></code></pre></div><p><code>pipeline</code>：该结构体记录着流水线的配置元信息，比如该流水线对接哪个项目代码、与仓库通信的认证信息以及上次该流水线运行的结果等等。如下图所示：</p>
<p>















<figure  id="figure-图3-流水线列表">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图3 流水线列表" srcset="
               /blog/cloudnative-devops/3_hue1f2dc29917a463b095c965c0ff6ad94_106203_097b2a11b5c46347034d6f0556598d63.webp 400w,
               /blog/cloudnative-devops/3_hue1f2dc29917a463b095c965c0ff6ad94_106203_d3fe35c0069c7f81ac9f25d374fcaa86.webp 760w,
               /blog/cloudnative-devops/3_hue1f2dc29917a463b095c965c0ff6ad94_106203_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/cloudnative-devops/3_hue1f2dc29917a463b095c965c0ff6ad94_106203_097b2a11b5c46347034d6f0556598d63.webp"
               width="760"
               height="331"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图3 流水线列表
    </figcaption></figure>
</p>
<center>图3 流水线列表</center>
<p>详细的结构字段讲解如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">apiVersion</span><span class="p">:</span> <span class="nx">project</span><span class="p">.</span><span class="nx">cubepaas</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">v3</span>
</span></span><span class="line"><span class="cl"><span class="nx">kind</span><span class="p">:</span> <span class="nx">Pipeline</span>
</span></span><span class="line"><span class="cl"><span class="nx">metadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">labels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cubepaas</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">creator</span><span class="p">:</span> <span class="nx">linkcloud</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="p">:</span> <span class="nx">p</span><span class="o">-</span><span class="nx">d5frn</span>
</span></span><span class="line"><span class="cl">  <span class="nx">namespace</span><span class="p">:</span> <span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span>
</span></span><span class="line"><span class="cl"><span class="nx">spec</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">currentBranch</span><span class="p">:</span> <span class="nx">master</span> <span class="c1">// 流水线运行时默认代码分支
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">imageWebHookToken</span><span class="p">:</span> <span class="c1">// 这是推送镜像时触发该流水线运行的设置信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">-</span> <span class="nx">branches</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">master</span>
</span></span><span class="line"><span class="cl">    <span class="nx">comment</span><span class="p">:</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="nx">imageType</span><span class="p">:</span> <span class="nx">harbor</span> <span class="c1">// 支持 harbor dockerhub aliyun等镜像仓库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">token</span><span class="p">:</span> <span class="mi">7</span><span class="nx">c102c82</span><span class="o">-</span><span class="mi">66</span><span class="nx">d9</span><span class="o">-</span><span class="mi">44</span><span class="nx">c1</span><span class="o">-</span><span class="mi">8718</span><span class="o">-****</span> <span class="c1">// 推送镜像触发流水线运行时的 token 认证 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">trigger</span><span class="p">:</span> <span class="nx">nginx</span> <span class="c1">// 当推送 nginx 镜像时会触发流水线运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">projectName</span><span class="p">:</span> <span class="nx">c</span><span class="o">-</span><span class="mi">86</span><span class="nx">tgg</span><span class="p">:</span><span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span>
</span></span><span class="line"><span class="cl">  <span class="nx">repositoryUrl</span><span class="p">:</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/gophere/devops-go.git // 项目代码地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">sourceCodeCredentialName</span><span class="p">:</span> <span class="nx">u</span><span class="o">-</span><span class="mi">8</span><span class="nx">sq</span><span class="o">**</span><span class="p">:</span><span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span><span class="o">-</span><span class="nx">github</span><span class="o">-</span><span class="nx">gophere</span> <span class="c1">// 指向对应的用户认证信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">triggerWebhookPush</span><span class="p">:</span> <span class="kc">true</span> <span class="c1">// 钩子操作，当push代码到仓库时会触发该流水线执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">status</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">lastRunState</span><span class="p">:</span> <span class="nx">Success</span> <span class="c1">// 最新一次运行的最后结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">nextRun</span><span class="p">:</span> <span class="mi">2</span> <span class="c1">// 下次运行时执行实例对应的序号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">pipelineState</span><span class="p">:</span> <span class="nx">active</span> <span class="c1">// 该流水线处于有效状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">sourceCodeCredential</span><span class="p">:</span> <span class="c1">// 上述已介绍，此处不再赘述
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="nx">token</span><span class="p">:</span> <span class="nx">e667bbb9</span><span class="o">-</span><span class="mi">7230</span><span class="o">-</span><span class="mi">48</span><span class="nx">d4</span><span class="o">-</span><span class="mi">9</span><span class="nx">d29</span><span class="o">-*****</span> <span class="c1">// 用于代码仓库触发流水线运行时的 token 认证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">webhookId</span><span class="p">:</span> <span class="s">&#34;245901183&#34;</span> <span class="c1">// 代码仓库的钩子信息
</span></span></span></code></pre></div><p><code>pipelineExecution</code>：流水线执行实例，每当流水线运行一次，会产生一个该对象记录着流水线的执行结果等信息。如下图所示：</p>
<p>















<figure  id="figure-图4-流水线执行记录列表">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图4 流水线执行记录列表" srcset="
               /blog/cloudnative-devops/4_hu32b5abad25f2f368c94e684cd33c7d6d_129009_40be872cb7c34f9e7b78ebaa811d3e2a.webp 400w,
               /blog/cloudnative-devops/4_hu32b5abad25f2f368c94e684cd33c7d6d_129009_d7f4b66924c789f51b0f0b5ac507b4aa.webp 760w,
               /blog/cloudnative-devops/4_hu32b5abad25f2f368c94e684cd33c7d6d_129009_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/cloudnative-devops/4_hu32b5abad25f2f368c94e684cd33c7d6d_129009_40be872cb7c34f9e7b78ebaa811d3e2a.webp"
               width="760"
               height="331"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图4 流水线执行记录列表
    </figcaption></figure>
</p>
<center>图4 流水线执行记录列表</center>
<p>详细的结构字段讲解如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">apiVersion</span><span class="p">:</span> <span class="nx">project</span><span class="p">.</span><span class="nx">cubepaas</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">v3</span>
</span></span><span class="line"><span class="cl"><span class="nx">kind</span><span class="p">:</span> <span class="nx">PipelineExecution</span>
</span></span><span class="line"><span class="cl"><span class="nx">metadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">labels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cubepaas</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">creator</span><span class="p">:</span> <span class="nx">linkcloud</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pipeline</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">cubepaas</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">finish</span><span class="p">:</span> <span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="p">:</span> <span class="nx">p</span><span class="o">-</span><span class="nx">d5frn</span><span class="o">-</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="nx">namespace</span><span class="p">:</span> <span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span>
</span></span><span class="line"><span class="cl"><span class="nx">spec</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">branch</span><span class="p">:</span> <span class="nx">master</span> <span class="c1">// 本次运行的代码分支
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">commit</span><span class="p">:</span> <span class="nx">f5b78969586cd90918020cb7a138fe88c7e25f9d</span> <span class="c1">// 代码 commitid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">message</span><span class="p">:</span> <span class="nx">Update</span> <span class="p">.</span><span class="nx">cubepaas</span><span class="o">-</span><span class="nx">devops</span><span class="p">.</span><span class="nx">yml</span> <span class="c1">// 代码 commit 说明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">pipelineConfig</span><span class="p">:</span> <span class="c1">// 以下是pipeline具体的stage和step的配置信息，每次运行时从代码仓库的配置文件（.cubepaas.devops.ymal）拉取下来填充该结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">Clone</span> <span class="c1">// 克隆代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">steps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="nx">sourceCodeConfig</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">Build</span> <span class="c1">// 运行脚本编译代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="nx">pipelineName</span><span class="p">:</span> <span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span><span class="p">:</span><span class="nx">p</span><span class="o">-</span><span class="nx">d5frn</span>
</span></span><span class="line"><span class="cl">  <span class="nx">projectName</span><span class="p">:</span> <span class="nx">c</span><span class="o">-</span><span class="mi">86</span><span class="nx">tgg</span><span class="p">:</span><span class="nx">p</span><span class="o">-</span><span class="nx">zwmcv</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ref</span><span class="p">:</span> <span class="nx">master</span>
</span></span><span class="line"><span class="cl">  <span class="nx">repositoryUrl</span><span class="p">:</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/gophere/devops-go.git // 项目代码地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">run</span><span class="p">:</span> <span class="mi">2</span> <span class="c1">// 此次运行序号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">triggerUserName</span><span class="p">:</span> <span class="nx">u</span><span class="o">-</span><span class="mi">8</span><span class="nx">sq</span><span class="o">**</span> <span class="c1">// 触发用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">triggeredBy</span><span class="p">:</span> <span class="nx">user</span>
</span></span><span class="line"><span class="cl"><span class="nx">status</span><span class="p">:</span> <span class="c1">// 以下记录着pipeline每个stage和step的运行结果信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">executionState</span><span class="p">:</span> <span class="nx">Success</span>
</span></span><span class="line"><span class="cl">  <span class="nx">stages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="nx">ended</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">03</span><span class="nx">T06</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mo">01</span><span class="nx">Z</span>
</span></span><span class="line"><span class="cl">    <span class="nx">state</span><span class="p">:</span> <span class="nx">Success</span>
</span></span><span class="line"><span class="cl">    <span class="nx">steps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">ended</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">03</span><span class="nx">T06</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mo">01</span><span class="nx">Z</span>
</span></span><span class="line"><span class="cl">      <span class="nx">state</span><span class="p">:</span> <span class="nx">Success</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span></code></pre></div><p>至此，我们完成了流水线功能的基础对象定义。</p>
<h3 id="controller-实现">controller 实现</h3>
<p>除了抽象出对应的CRD外，我们还需要编写对应的controller代码实现对应的业务逻辑，比如当pipeline运行时，我们需要产生pipeline执行实例，并实时同步其运行的状态信息等等。</p>
<p>当触发流水线执行逻辑时，系统会根据pipeline CRD对象和该流水线对应的代码仓库中的配置文件（.cubepaas.devops.ymal）产生一个pipelineExecution CRD对象，这时会触发pipelineExecution对应的controller运行业务逻辑。下面只摘取重要的代码逻辑，如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Lifecycle</span><span class="p">)</span> <span class="nf">Sync</span><span class="p">(</span><span class="nx">obj</span> <span class="o">*</span><span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecution</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果 pipeline 执行实例被暂停，则会停止流水线作业
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ExecutionState</span> <span class="o">==</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">StateAborted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">doStop</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果 pipeline 执行实例运行完毕，则会清理流水线作业的一些资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 比如，产生的Jenkins slave pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">Labels</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="nx">utils</span><span class="p">.</span><span class="nx">PipelineFinishLabel</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;true&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nf">doFinish</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果 pipeline 执行实例正在运行中，则直接返回，无操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecutionConditionInitialized</span><span class="p">.</span><span class="nf">GetStatus</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 判断流水线作业是否超出资源限额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">exceed</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">exceedQuota</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果超出资源限额，则会设置当前 pipeline 执行实例为阻塞状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">exceed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">obj</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ExecutionState</span> <span class="p">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">StateQueueing</span>
</span></span><span class="line"><span class="cl">        <span class="nx">obj</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="nx">utils</span><span class="p">.</span><span class="nx">PipelineFinishLabel</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">newExecutionUpdateLastRunState</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ExecutionState</span> <span class="o">==</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">StateQueueing</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">obj</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ExecutionState</span> <span class="p">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">StateWaiting</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新 pipeline 执行实例的状态: 比如运行序号+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">newExecutionUpdateLastRunState</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecutionConditionInitialized</span><span class="p">.</span><span class="nf">CreateUnknownIfNotExists</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">obj</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="nx">utils</span><span class="p">.</span><span class="nx">PipelineFinishLabel</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;false&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在数据面部署pipeline功能所需资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">deploy</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">ProjectName</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">obj</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="nx">utils</span><span class="p">.</span><span class="nx">PipelineFinishLabel</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">obj</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ExecutionState</span> <span class="p">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">StateFailed</span>
</span></span><span class="line"><span class="cl">        <span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecutionConditionInitialized</span><span class="p">.</span><span class="nf">False</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecutionConditionInitialized</span><span class="p">.</span><span class="nf">ReasonAndMessageFromError</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 将 configMap 存储的docker镜像仓库端口信息同步到pipeline执行实例中去.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">markLocalRegistryPort</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>其中，deploy函数的逻辑就是第一次运行时通过判断数据面中是否存在pipeline的命名空间，如果存在就代表基础资源已经配置完成，直接走reconcileRb函数，该函数的逻辑见下面；如果不存在，就会在数据面中初始化必要的基础资源，比如：pipeline命名空间, Jenkins docker minio服务, 配置configMap, secret等等。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Lifecycle</span><span class="p">)</span> <span class="nf">deploy</span><span class="p">(</span><span class="nx">projectName</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">clusterID</span><span class="p">,</span> <span class="nx">projectID</span> <span class="o">:=</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">projectName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ns</span> <span class="o">:=</span> <span class="nf">getPipelineNamespace</span><span class="p">(</span><span class="nx">clusterID</span><span class="p">,</span> <span class="nx">projectID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果该pipeline的namespace已经有了，说明下面的资源部署已经完成了，则直接走reconcileRb流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 否则走下面的资源部署流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">namespaceLister</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">Name</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nf">reconcileRb</span><span class="p">(</span><span class="nx">projectName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建pipeline对应的命名空间，如p-qqxs7-pipeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">namespaces</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ns</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the pipeline namespace&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 随机产生一个token，用于配置下面的secret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">randomtoken</span><span class="p">.</span><span class="nf">Generate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">nsName</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">GetPipelineCommonName</span><span class="p">(</span><span class="nx">projectName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ns</span> <span class="p">=</span> <span class="nf">getCommonPipelineNamespace</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建用于部署docker镜像仓库的代理服务的命名空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">namespaces</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ns</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the cattle-pipeline namespace&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建secret : pipeline-secret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">secret</span> <span class="o">:=</span> <span class="nf">getPipelineSecret</span><span class="p">(</span><span class="nx">nsName</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span><span class="p">.</span><span class="nx">secrets</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">secret</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取管理面项目的系统用户token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apikey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">systemAccountManager</span><span class="p">.</span><span class="nf">GetOrCreateProjectSystemToken</span><span class="p">(</span><span class="nx">projectID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建secret: pipeline-api-key，用于数据面与管理面通信的凭证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">secret</span> <span class="p">=</span> <span class="nf">GetAPIKeySecret</span><span class="p">(</span><span class="nx">nsName</span><span class="p">,</span> <span class="nx">apikey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span><span class="p">.</span><span class="nx">secrets</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">secret</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 调谐 docker 镜像仓库的证书配置（在控制面中）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">reconcileRegistryCASecret</span><span class="p">(</span><span class="nx">clusterID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 将控制面中的 docker 镜像仓库的证书配置同步到数据面中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">reconcileRegistryCrtSecret</span><span class="p">(</span><span class="nx">clusterID</span><span class="p">,</span> <span class="nx">projectID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建 serviceAccount : jenkins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sa</span> <span class="o">:=</span> <span class="nf">getServiceAccount</span><span class="p">(</span><span class="nx">nsName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">serviceAccounts</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">sa</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating a pipeline service account&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建 service: jenkins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">jenkinsService</span> <span class="o">:=</span> <span class="nf">getJenkinsService</span><span class="p">(</span><span class="nx">nsName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">jenkinsService</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the jenkins service&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建 deployment: jenkins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">jenkinsDeployment</span> <span class="o">:=</span> <span class="nf">GetJenkinsDeployment</span><span class="p">(</span><span class="nx">nsName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">deployments</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">jenkinsDeployment</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the jenkins deployment&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建 service: docker-registry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">registryService</span> <span class="o">:=</span> <span class="nf">getRegistryService</span><span class="p">(</span><span class="nx">nsName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">registryService</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the registry service&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建 deployment: docker-registry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">registryDeployment</span> <span class="o">:=</span> <span class="nf">GetRegistryDeployment</span><span class="p">(</span><span class="nx">nsName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">deployments</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">registryDeployment</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the registry deployment&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建 service: minio
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">minioService</span> <span class="o">:=</span> <span class="nf">getMinioService</span><span class="p">(</span><span class="nx">nsName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">minioService</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the minio service&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 在 pipeline namespace 内创建 deployment: minio
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">minioDeployment</span> <span class="o">:=</span> <span class="nf">GetMinioDeployment</span><span class="p">(</span><span class="nx">nsName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">deployments</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">minioDeployment</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the minio deployment&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 调谐 configMap: proxy-mappings，用于配置docker镜像仓库代理服务的端口信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">reconcileProxyConfigMap</span><span class="p">(</span><span class="nx">projectID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建secret: devops-docker-registry，存储访问docker仓库的认证信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">reconcileRegistryCredential</span><span class="p">(</span><span class="nx">projectName</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建 daemonset: registry-proxy，每个节点部署一套docker镜像仓库的nginx代理服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 可以在任意一个节点上通过不同的端口即可访问到不同的docker镜像仓库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nginxDaemonset</span> <span class="o">:=</span> <span class="nf">getProxyDaemonset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">daemonsets</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">nginxDaemonset</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error creating the nginx proxy&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nf">reconcileRb</span><span class="p">(</span><span class="nx">projectName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>reconcileRb函数的功能就是遍历所有namespace, 对其调谐rolebindings, 目的是让 pipeline serviceAccount(jenkins) 对该project下的所有namespace具有所需要的操作权限，这样Jenkins server才能够在数据面中正常提供CI/CD基础服务。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Lifecycle</span><span class="p">)</span> <span class="nf">reconcileRb</span><span class="p">(</span><span class="nx">projectName</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">namespacesInProject</span> <span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Namespace</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">namespace</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">namespaces</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">parts</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">projectIDLabel</span><span class="p">],</span> <span class="s">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">projectID</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 过滤出属于该project下的所有namespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">namespacesInProject</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">namespacesInProject</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 对非该project下的namespace, 清除有关该 pipeline 的 rolebinding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">roleBindings</span><span class="p">.</span><span class="nf">DeleteNamespaced</span><span class="p">(</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">commonName</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">namespace</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">namespacesInProject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 对属于该project下的namespace, 创建 rolebinding: 对 jenkins serviceAccount 绑定角色
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 即赋予 jenkins serviceAccount 对该project下的所有namespace所需要的操作权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">rb</span> <span class="o">:=</span> <span class="nf">getRoleBindings</span><span class="p">(</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">commonName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">roleBindings</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">rb</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error create role binding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 赋予 jenkins serviceAccount 在 cluster 内创建和修改 namespace 的权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 当部署应用时可以指定创建新的命名空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">clusterRbs</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">roleCreateNs</span><span class="p">,</span> <span class="nx">projectID</span> <span class="o">+</span> <span class="nx">roleEditNsSuffix</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">crbName</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">clusterRbs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">crb</span> <span class="o">:=</span> <span class="nf">getClusterRoleBindings</span><span class="p">(</span><span class="nx">commonName</span><span class="p">,</span> <span class="nx">crbName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">clusterRoleBindings</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">crb</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Error create cluster role binding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>goroutine（syncState）的代码逻辑比较简单，当产生新的pipeline执行实例时就会启动Jenkins server端流水线作业的运行并实时同步其运行状态到pipeline执行实例中。代码逻辑如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ExecutionStateSyncer</span><span class="p">)</span> <span class="nf">syncState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">set</span> <span class="o">:=</span> <span class="nx">labels</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="nx">utils</span><span class="p">.</span><span class="nx">PipelineFinishLabel</span><span class="p">:</span> <span class="s">&#34;false&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">allExecutions</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">pipelineExecutionLister</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">set</span><span class="p">.</span><span class="nf">AsSelector</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">executions</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecution</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 遍历该cluster下的 pipeline 执行实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">allExecutions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">ObjectInCluster</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterName</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">executions</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">executions</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">execution</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">executions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecutionConditionInitialized</span><span class="p">.</span><span class="nf">IsUnknown</span><span class="p">(</span><span class="nx">execution</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 检查数据面k8s中 Jenkins pod 是否正常，正常则运行该 pipeline job
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">s</span><span class="p">.</span><span class="nf">checkAndRun</span><span class="p">(</span><span class="nx">execution</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">PipelineExecutionConditionInitialized</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="nx">execution</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span> <span class="o">:=</span> <span class="nx">execution</span><span class="p">.</span><span class="nf">DeepCopy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果已经启动了，则同步运行状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">updated</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">pipelineEngine</span><span class="p">.</span><span class="nf">SyncExecution</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">updated</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 更新最新的状态到 pipelineExecution crd 中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">s</span><span class="p">.</span><span class="nf">updateExecutionAndLastRunState</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 更新最新的状态到 pipelineExecution crd 中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">s</span><span class="p">.</span><span class="nf">updateExecutionAndLastRunState</span><span class="p">(</span><span class="nx">execution</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">logrus</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Sync pipeline execution state complete&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="缓存支持">缓存支持</h3>
<p>云环境下的流水线是通过启动容器来运行具体的功能步骤，每次运行流水线可能会被调度到不同的计算节点上，这会导致一个问题：容器运行完是不会保存数据的，每当流水线重新运行时，又会重新拉取代码、编译代码、下载依赖包等等，失去了本地宿主机编译代码、构建镜像时缓存的作用，大大延长了流水线运行时间，浪费很多不必要的时间、网络和计算成本等。为了提高用户使用流水线的体验，加入支持缓存的功能。</p>
<p>为了让流水线具有缓存功能，我们需要在流水线运行时加入持久化数据的能力。首先想到的就是k8s提供的本地持久化存储（即Local Persistent Volume，以下简称Local PV），或依赖远程存储服务器来提供持久化，远程存储效率依赖于网络，并且还需要保证远程存储高可用，这回带来很多复杂性，也一定程度上失去了缓存的作用。综合考虑，我们选择本地存储实现缓存，但是k8s提供的Local PV是需要和节点绑定在一起的，也就是说一旦流水线调度到某个节点上运行，那么下次运行还会绑定到该节点运行，虽然实现了缓存的作用，但是也造成了流水线每次只能在该节点上运行，如果有多条流水线同时跑，可能会导致该节点资源耗尽或者缓存冲突，失去了云平台本身根据资源使用情况平衡调度的特性。</p>
<p>因此，为了平衡缓存与调度间的关系，我们采用了挂载hostPath Volume方式，这样依托于k8s强大的容器调度能力，我们可以同时运行很多条流水线而不用担心资源耗尽或缓存冲突的问题，但是流水线每次运行时可能会被调度到不同的节点上，如果当前节点没有运行过流水线，则起不到缓存的作用。那么如何解决hostPath Volume缓存与调度间的尴尬关系呢？我们巧妙地利用了k8s提供的亲和性调度特性，当流水线运行时我们会记录当前运行节点，下次运行时通过设置Pod的亲和性优先调度到该节点上，随着流水线运行次数越来越多，我们会得到一个运行节点列表。如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 按时间排序，最近运行流水线的节点排在最前面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">executionScheduledInfo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">creationTimestamp</span><span class="p">:</span> <span class="s">&#34;2020-09-02T06:42:45Z&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">executionId</span><span class="p">:</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeName</span><span class="p">:</span> <span class="o">******</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">creationTimestamp</span><span class="p">:</span> <span class="s">&#34;2020-08-26T14:19:21Z&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">executionId</span><span class="p">:</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeName</span><span class="p">:</span> <span class="o">******</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">creationTimestamp</span><span class="p">:</span> <span class="s">&#34;2020-08-26T10:52:15Z&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">executionId</span><span class="p">:</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeName</span><span class="p">:</span> <span class="o">******</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">creationTimestamp</span><span class="p">:</span> <span class="s">&#34;2020-08-26T10:48:43Z&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">executionId</span><span class="p">:</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeName</span><span class="p">:</span> <span class="o">******</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">creationTimestamp</span><span class="p">:</span> <span class="s">&#34;2020-08-25T07:47:27Z&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">executionId</span><span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeName</span><span class="p">:</span> <span class="o">******</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span> <span class="nx">creationTimestamp</span><span class="p">:</span> <span class="s">&#34;2020-08-25T07:16:29Z&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">executionId</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeName</span><span class="p">:</span> <span class="o">******</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span></code></pre></div><p>执行实例调度信息会保存到pipeline CRD对象中，每次运行流水线时，系统会根据节点列表设置Pod的亲和性，默认我们会取最近运行流水线的10个节点，原则是最近运行流水线的节点优先级越高。代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 获取流水线的节点调度列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">esi</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ExecutionScheduledInfo</span>
</span></span><span class="line"><span class="cl"><span class="nx">nodes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PreferredSchedulingTerm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">esi</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置亲和性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span> <span class="o">:=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PreferredSchedulingTerm</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Weight</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nx">i</span><span class="o">*</span><span class="mi">10</span><span class="p">),</span> <span class="c1">// 最近运行的节点权重越高
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">Preference</span><span class="p">:</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">NodeSelectorTerm</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">MatchExpressions</span><span class="p">:</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">NodeSelectorRequirement</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Key</span><span class="p">:</span>      <span class="s">&#34;kubernetes.io/hostname&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Operator</span><span class="p">:</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">NodeSelectorOpIn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Values</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">v</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">nodeAff</span><span class="p">.</span><span class="nx">PreferredDuringSchedulingIgnoredDuringExecution</span> <span class="p">=</span> <span class="nx">nodes</span>
</span></span></code></pre></div><p>创新性的“Hostpath Volume + 亲和性调度”缓存设计方案，不仅实现了流水线的并发性缓存功能，而且实现复杂度低，可自由配置任一阶段、步骤的缓存开关以及缓存路径。无缓存与有缓存运行的对比如下图所示，可见通过缓存加速大大提高了流水线的运行效率。</p>
<p>















<figure  id="figure-图5-缓存效果">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图5 缓存效果" srcset="
               /blog/cloudnative-devops/5_hu6c3c1ed7af809f560c8e7bc2c7f71cb6_385891_34192a2b9877be222af1f75a63447649.webp 400w,
               /blog/cloudnative-devops/5_hu6c3c1ed7af809f560c8e7bc2c7f71cb6_385891_7a4fa280c2da03a07b55f4ed75028587.webp 760w,
               /blog/cloudnative-devops/5_hu6c3c1ed7af809f560c8e7bc2c7f71cb6_385891_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/cloudnative-devops/5_hu6c3c1ed7af809f560c8e7bc2c7f71cb6_385891_34192a2b9877be222af1f75a63447649.webp"
               width="760"
               height="709"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图5 缓存效果
    </figcaption></figure>
</p>
<center>图5 缓存效果</center>
<h2 id="hcaas-devops使用">HCaaS DevOps使用</h2>
<p>以上设计在HCaaS平台上得到实现（<a href="https://cubepaas.com" target="_blank" rel="noopener">https://cubepaas.com</a>）在HCaaS控制台上点击DevOps标签，通过代码授权后，即可通过UI界面轻松地编辑流水线，也可通过编辑yaml文件配置具体的功能步骤，如图所示：</p>
<p>















<figure  id="figure-图6-流水线编辑">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图6 流水线编辑" srcset="
               /blog/cloudnative-devops/6_hucc1be72e5ca4da4faa6d7b5655a229ba_123059_28db65ba58054b28dab0c4ab580f64aa.webp 400w,
               /blog/cloudnative-devops/6_hucc1be72e5ca4da4faa6d7b5655a229ba_123059_ed37581994b20dd40af2c839ebd439a7.webp 760w,
               /blog/cloudnative-devops/6_hucc1be72e5ca4da4faa6d7b5655a229ba_123059_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/cloudnative-devops/6_hucc1be72e5ca4da4faa6d7b5655a229ba_123059_28db65ba58054b28dab0c4ab580f64aa.webp"
               width="760"
               height="383"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图6 流水线编辑
    </figcaption></figure>
</p>
<center>图6 流水线编辑</center>
<p>通过点击查看日志，你可以看到pipeline各个阶段运行的详细日志信息，如下图所示：</p>
<p>















<figure  id="figure-图7-流水线运行日志">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图7 流水线运行日志" srcset="
               /blog/cloudnative-devops/7_hu9cc51d8f5a21031551528b2e97d0921e_77193_cfb5127bead864511752717bed9ff6a0.webp 400w,
               /blog/cloudnative-devops/7_hu9cc51d8f5a21031551528b2e97d0921e_77193_2785272dd0ba224f4686fa193837b54f.webp 760w,
               /blog/cloudnative-devops/7_hu9cc51d8f5a21031551528b2e97d0921e_77193_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/cloudnative-devops/7_hu9cc51d8f5a21031551528b2e97d0921e_77193_cfb5127bead864511752717bed9ff6a0.webp"
               width="760"
               height="265"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图7 流水线运行日志
    </figcaption></figure>
</p>
<center>图7 流水线运行日志</center>
<p>【注意】首次运行pipeline时系统会从网络下载Jenkins、docker、minio以及其他pipeline-tools镜像，请稍作等待。如果长时间未运行，请查看网络是否有问题。</p>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/devops/">DevOps</a>
  
  <a class="badge badge-light" href="/tag/cicd/">CICD</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E9%99%88%E6%9C%88%E6%96%B0/"><img class="avatar mr-3 avatar-circle" src="/author/%E9%99%88%E6%9C%88%E6%96%B0/avatar_hu5f67caf2b707af3ace3b325bb180a40a_24123_270x270_fill_q75_lanczos_center.jpg" alt="陈月新"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E9%99%88%E6%9C%88%E6%96%B0/">陈月新</a></p>
      
      <p class="card-text">某公司DevOps工程师，云原生爱好者。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/istio-pilot-2/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>Istio Pilot 源码分析（二）</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/sig-envoy-announcement/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>云原生社区 Envoy SIG 成立啦！</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/cloudnative-devops/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/dev-env-as-code/">开发环境即代码：可以运行在云上的开发环境</a></li>
      
      <li><a href="/blog/flux-get-start-easy/">基于Flux项目的云原生GitOps实践</a></li>
      
      <li><a href="/blog/gitops-and-chatops/">GitOps 与 ChatOps 的落地实践</a></li>
      
      <li><a href="/blog/prow-quick-start-guide/">Prow 快速入门向导</a></li>
      
      <li><a href="/blog/gitops-flux/">多集群场景下基于Flux的应用持续交付实践</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2023 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
