<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="APIServer handler注册过程分析。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/apiserver-handler-register/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/apiserver-handler-register/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/apiserver-handler-register/" />
  <meta property="og:title" content="Kubernetes API Server handler 注册过程分析 | 云原生社区（中国）" />
  <meta property="og:description" content="APIServer handler注册过程分析。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2022-08-12T12:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-08-10T14:29:30&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/apiserver-handler-register/"
  },
  "headline": "Kubernetes API Server handler 注册过程分析",
  
  "datePublished": "2022-08-12T12:00:00+08:00",
  "dateModified": "2023-08-10T14:29:30+08:00",
  
  "author": {
    "@type": "Person",
    "name": "韩伟森"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "APIServer handler注册过程分析。"
}
</script>

  

  

  

  





  <title>Kubernetes API Server handler 注册过程分析 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="8ff1132675480cad1ff5aa05ad74849d" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>Kubernetes API Server handler 注册过程分析</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E9%9F%A9%E4%BC%9F%E6%A3%AE/">韩伟森</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/kubernetes/" class="text-capitalize">kubernetes</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2022-08-12
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 6151
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 28 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#apiserver启动过程介绍">APIServer启动过程介绍</a></li>
    <li><a href="#handler的注册过程">handler的注册过程</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#apiserver启动过程介绍">APIServer启动过程介绍</a></li>
    <li><a href="#handler的注册过程">handler的注册过程</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
</details>

                    
                    <h2 id="前言">前言</h2>
<p>K8s提供 <code>Aggregated APIServer</code> 的扩展方式，编写 <code>Aggregated APIServer</code> 本质上和K8s构建方式类似，理解 APiServer 资源的加载方式，能更好好的理解如何开发<code>Aggregated APIServer</code>。本文以内置资源的 handler 注册过程为线索介绍了 APiServer 的启动过程和 handler 注册过程。使用k8s代码commit id为c6970e64528ba78b74bf77b86f9b78b7b61bd0cd</p>
<h2 id="apiserver启动过程介绍">APIServer启动过程介绍</h2>
<p>















<figure  id="figure-图1-apiserver启动流程">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图1 APIServer启动流程"
           src="/blog/apiserver-handler-register/images/apiserver-startup-flow.svg"
           loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图1 APIServer启动流程
    </figcaption></figure>
</p>
<p>图1给出了 ApiServer 的初始化流程，首先通过 <code>CreateServerChain</code>  构造出3个APIServer：</p>
<p><strong>AggregatorServer：拦截</strong> <code>Aggregated APIServer</code> <strong>中定义的资源对象请求，并转发给相关的</strong> <code>Aggregated APIServer</code> <strong>处理。</strong></p>
<p><strong>KubeAPIServer：用于处理 k8s 的内建资源，如：Deployment，ConfigMap 等。</strong></p>
<p><strong>APIExtensionServer：负责处理用户自定义资源。</strong></p>
<p>它们之间的处理顺序为如下图所示，当用户请求进来，先判断 <code>AggregatorServer</code> 能否处理，否则代理给 <code>kubeApiServer</code> ，如果 <code>kubeApiServer</code> 不能处代理给 <code>ApiExtensionServer</code> 处理，如果都不能处理则交给 notFoundHandler 处理。</p>
<p>















<figure  id="figure-图2-三种-apiserver-请求顺序">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图2 三种 APIServer 请求顺序" srcset="
               /blog/apiserver-handler-register/images/apiserver-request-order_hu325fccf14009ead82292cb3e8a4c3466_261384_588e90db77ff0a4f7d7ff2d9cb0109bd.webp 400w,
               /blog/apiserver-handler-register/images/apiserver-request-order_hu325fccf14009ead82292cb3e8a4c3466_261384_a93f45bc9ab878d078ab2ae201ce793c.webp 760w,
               /blog/apiserver-handler-register/images/apiserver-request-order_hu325fccf14009ead82292cb3e8a4c3466_261384_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apiserver-handler-register/images/apiserver-request-order_hu325fccf14009ead82292cb3e8a4c3466_261384_588e90db77ff0a4f7d7ff2d9cb0109bd.webp"
               width="341"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图2 三种 APIServer 请求顺序
    </figcaption></figure>
</p>
<p>限于篇幅原因，本文主要分析 kubeapiserver 的启动过程。</p>
<p><code>CreateApiServerConfig</code> 通过调用 <code>buildGenericConfig</code> 构建 <code>genericapiserver.Config</code>。<code>genericapiserver.Config</code> 中包含了启动<code>Genericapiserver</code> 所需要的配置信息，比如：<code>RequestTimeout</code> 定义了请求的超时时间，<code>AdmissionControl</code> 对象进行准入控制。<code>buildGenericConfig</code> 中需要注意的是 <code>BuildHandlerChainFunc</code>，请求在路由给资源对象的handler前先经过的<code>BuildHandlerChainFunc</code> 中定义的 <code>Filter</code> 。参考图1，通过深入 <code>buildGenericConfig</code> 可以发现 <code>BuildHandlerChainFunc</code> 传入的是 <code>DefaultBuildHandlerChain</code> ，其中 <code>Filter</code> 先定义的后调用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// k8s.io/apiserver/pkg/server/config.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">DefaultBuildHandlerChain</span><span class="p">(</span><span class="nx">apiHandler</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="nx">filterlatency</span><span class="p">.</span><span class="nf">TrackCompleted</span><span class="p">(</span><span class="nx">apiHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 构造权限检查filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithAuthorization</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 构造认证filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithAuthentication</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">Authenticator</span><span class="p">,</span> <span class="nx">failedHandler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">APIAudiences</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 构造请求超时filter, LongRunningFunc会判断该请求是否是需要LongRunning的，比如watch的请求，如果是，该filter不会对这类请求生效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// WithTimeoutForNonLongRunningRequests will call the rest of the request handling in a go-routine with the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// context with deadline. The go-routine can keep running, while the timeout logic will return a timeout to the client.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithTimeoutForNonLongRunningRequests</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithRequestDeadline</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">AuditBackend</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">AuditPolicyRuleEvaluator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">RequestTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithWaitGroup</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">HandlerChainWaitGroup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 初始化RequestInfo的filter并将其放入context中，后续的处理逻辑可以从context直接获取RequestInfo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithRequestInfo</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">RequestInfoResolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">handler</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>CreateKubeAPIServer</code> 中调用了<code>kubeAPIServerConfig.Complete().New</code> 构造出了 <code>kubeAPIServer</code> 的 <code>GenericServer</code>。<code>kubeAPIServerConfig.Complete().New</code> 中通过调用 <code>m.InstallLegacyAPI</code> 初始化核心资源并添加进路由中，对应的是以 api 开头的资源，如：Pod，ConfigMap 等。调用 <code>m.InstallAPI</code> 初始化以 apis 开头的内置资源如：Deployment。</p>
<h2 id="handler的注册过程">handler的注册过程</h2>
<p>从图1可以看出 <code>InstallAPI</code> 与 <code>InstallLegacyAPI</code> 的创建过程基本类似，本文主要介绍 <code>InstallAPI</code> 的初始化过程。</p>
<p>在调用 <code>InstallAPI</code> 之前<code>kubeAPIServerConfig.Complete().New</code> 会先创建内置资源对象的<code>RESTStorageProvider</code> 作为 <code>InstallAPI</code> 的入参</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//pkg/controlplane/instance.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">New</span><span class="p">(</span><span class="nx">delegationTarget</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 构造内置资源的RESTStorageProvider
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">restStorageProviders</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">RESTStorageProvider</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiserverinternalrest</span><span class="p">.</span><span class="nx">StorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">authenticationrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{</span><span class="nx">Authenticator</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">Authenticator</span><span class="p">,</span> <span class="nx">APIAudiences</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">APIAudiences</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">authorizationrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{</span><span class="nx">Authorizer</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="nx">RuleResolver</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RuleResolver</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">autoscalingrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">batchrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">certificatesrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">coordinationrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">discoveryrest</span><span class="p">.</span><span class="nx">StorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">networkingrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">noderest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">policyrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rbacrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{</span><span class="nx">Authorizer</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">schedulingrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storagerest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">flowcontrolrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{</span><span class="nx">InformerFactory</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// See https://github.com/kubernetes/kubernetes/issues/42392
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">appsrest</span><span class="p">.</span><span class="nx">StorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">admissionregistrationrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">eventsrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{</span><span class="nx">TTL</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">EventTTL</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">InstallAPIs</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">APIResourceConfigSource</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">,</span> <span class="nx">restStorageProviders</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>RESTStorageProvider</code> 是一个接口，通过其 <code>NewRESTStorage</code> 构造出 <code>APIGroupInfo</code> ，<code>APIGroupInfo</code> 包含注册资源所需的基本信息比如编解码器，组下所有资源的 Storage 对象<code>VersionedResourcesStorageMap</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//k8s.io/apiserver/pkg/server/genericapiserver.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Info about an API group.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">APIGroupInfo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PrioritizedVersions</span> <span class="p">[]</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersion</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Info about the resources in this group. It&#39;s a map from version to resource to the storage.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">VersionedResourcesStorageMap</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NegotiatedSerializer controls how this group encodes and decodes data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NegotiatedSerializer</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">NegotiatedSerializer</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ParameterCodec performs conversions for query parameters passed to API calls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ParameterCodec</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">ParameterCodec</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>VersionedResourcesStorageMap</code> 需要重点注意，编写 <code>Aggregated APIServer</code> 主要逻辑是通过 <code>NewDefaultAPIGroupInfo</code> 初始化 <code>APIGroupInfo</code> 以后设置 <code>VersionedResourcesStorageMap</code> 属性。<code>VersionedResourcesStorageMap</code> 的签名是 <code>map[string]map[string]rest.Storage</code>。第一个key是版本号，第二个key是资源名称，资源名称可以是 deployment 这种资源，同时也能是子资源如 <code>pod/status</code> , <code>pod/log</code> 等是pod的子资源有单独的storage。最终构建handler的请求路径是基于 <code>VersionedResourcesStorageMap</code> 中提供的版本号和资源名称确定的 。<code>rest.Storage</code> 用于处理具体的请求，其声明如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// k8s.io/apiserver/pkg/registry/rest/rest.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Storage is a generic interface for RESTful storage services.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Resources which are exported to the RESTful API of apiserver need to implement this interface. It is expected
</span></span></span><span class="line"><span class="cl"><span class="c1">// that objects may implement any of the below interfaces.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Storage</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// New returns an empty object that can be used with Create and Update after request data has been put into it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">New</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Destroy cleans up its resources on shutdown.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Destroy has to be implemented in thread-safe way and be prepared
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// for being called more than once.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Destroy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>实现 <code>rest.Storage</code> 的接口最基本的，如果需要支持不同的请求，还需要实现其他的接口，相关定义在 <code>k8s.io/apiserver/pkg/registry/rest/rest.go</code> 中，如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// k8s.io/apiserver/pkg/registry/rest/rest.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 资源对象支持POST请求，例入通过kubectl create一个资源对象。
</span></span></span><span class="line"><span class="cl"><span class="c1">// Creater is an object that can create an instance of a RESTful object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Creater</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// New returns an empty object that can be used with Create after request data has been put into it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">New</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create creates a new version of a resource.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">createValidation</span> <span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 资源对象支持GET请求，例如通过kubectl get 一个资源对象。
</span></span></span><span class="line"><span class="cl"><span class="c1">// Getter is an object that can retrieve a named RESTful resource.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Getter</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Get finds a resource in the storage by name and returns it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Although it can return an arbitrary error value, IsNotFound(err) is true for the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// returned error value err when the specified resource is not found.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 支持对资源对象进行watch操作 例如通过kubectl get 资源对象 -w。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Watcher</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// &#39;label&#39; selects on labels; &#39;field&#39; selects on the object&#39;s fields. Not all fields
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// are supported; an error should be returned if &#39;field&#39; tries to select on a field that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// isn&#39;t supported. &#39;resourceVersion&#39; allows for continuing/starting a watch at a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// particular version.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>后续的处理中会依据 <code>Creater</code> ,<code>Getter</code> 和 <code>Watcher</code> 等接口生成对应请求的handler，后文会进行具体的分析。k8s的内置资源存储都使用 etcd，因此内置资源的 Storage 是通过 <code>Store</code> 构建。<code>Store</code> 定义在 <code>/k8s.io/apiserver/pkg/registry/generic/registry/store.go</code> 文件中，已经实现 <code>Creater</code> , <code>Getter</code>, <code>Watcher</code>等接口，其他的资源只需在初始化 <code>Store</code> 时传入一些必须的参数即可，无需编写存储层的交互代码。下面给出了构造 deployment 的 store 的过程，其他内置资源大同小异。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NewREST returns a RESTStorage object that will work against deployments.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewREST</span><span class="p">(</span><span class="nx">optsGetter</span> <span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">REST</span><span class="p">,</span> <span class="o">*</span><span class="nx">StatusREST</span><span class="p">,</span> <span class="o">*</span><span class="nx">RollbackREST</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 创建一个deployments的genericregistry.Store
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">store</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">genericregistry</span><span class="p">.</span><span class="nx">Store</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化一个空资源对象，这里使用的是internal的版本，下面定义的各种strategy操作的对象也是internal版本，这样就不用为每一种版本编写一个strategy策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">NewFunc</span><span class="p">:</span>                  <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">apps</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化一个空资源对象列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">NewListFunc</span><span class="p">:</span>              <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">apps</span><span class="p">.</span><span class="nx">DeploymentList</span><span class="p">{}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">		<span class="nx">DefaultQualifiedResource</span><span class="p">:</span> <span class="nx">apps</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="s">&#34;deployments&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建更新删除策略 主要是做校验及控制那些字段不能被用户覆盖用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">CreateStrategy</span><span class="p">:</span>      <span class="nx">deployment</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UpdateStrategy</span><span class="p">:</span>      <span class="nx">deployment</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DeleteStrategy</span><span class="p">:</span>      <span class="nx">deployment</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ResetFieldsStrategy</span><span class="p">:</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">		<span class="nx">TableConvertor</span><span class="p">:</span> <span class="nx">printerstorage</span><span class="p">.</span><span class="nx">TableConvertor</span><span class="p">{</span><span class="nx">TableGenerator</span><span class="p">:</span> <span class="nx">printers</span><span class="p">.</span><span class="nf">NewTableGenerator</span><span class="p">().</span><span class="nf">With</span><span class="p">(</span><span class="nx">printersinternal</span><span class="p">.</span><span class="nx">AddHandlers</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">options</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">generic</span><span class="p">.</span><span class="nx">StoreOptions</span><span class="p">{</span><span class="nx">RESTOptions</span><span class="p">:</span> <span class="nx">optsGetter</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 继续完成store其他属性的初始化，比如初始化store.Storage属性。Storage主要用于和底层存储层交互
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">store</span><span class="p">.</span><span class="nf">CompleteWithOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nx">statusStore</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">store</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// deployment的status子资源也是使用store, 区别是更新策略不一样, 即在update时会用旧对象的spec和lable覆盖新对象的，防止非status字段被用户意外覆盖
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">statusStore</span><span class="p">.</span><span class="nx">UpdateStrategy</span> <span class="p">=</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">StatusStrategy</span>
</span></span><span class="line"><span class="cl">	<span class="nx">statusStore</span><span class="p">.</span><span class="nx">ResetFieldsStrategy</span> <span class="p">=</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">StatusStrategy</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">REST</span><span class="p">{</span><span class="nx">store</span><span class="p">},</span> <span class="o">&amp;</span><span class="nx">StatusREST</span><span class="p">{</span><span class="nx">store</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">statusStore</span><span class="p">},</span> <span class="o">&amp;</span><span class="nx">RollbackREST</span><span class="p">{</span><span class="nx">store</span><span class="p">:</span> <span class="nx">store</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>InstallAPIs</code> 调用链条比较深。参考图1，最终会来到<code>k8s.io/apiserver/pkg/endpoints/groupversion.go</code> 的 <code>InstallREST</code> 方法。<code>InstallREST</code> 方法构造出 handler 的前缀，创建<code>APIInstaller</code>，然后调用<code>installer.Install()</code>方法继续handler的注册</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// k8s.io/apiserver/pkg/endpoints/groupversion.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">APIGroupVersion</span><span class="p">)</span> <span class="nf">InstallREST</span><span class="p">(</span><span class="nx">container</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Container</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">storageversion</span><span class="p">.</span><span class="nx">ResourceInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 从InstallAPI调用链下来这里的g.Root为/apis，这样就可以确定handler的前缀为/apis/{goup}/{version}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">prefix</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Root</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">.</span><span class="nx">Group</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">.</span><span class="nx">Version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">installer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">APIInstaller</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">group</span><span class="p">:</span>             <span class="nx">g</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">prefix</span><span class="p">:</span>            <span class="nx">prefix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">minRequestTimeout</span><span class="p">:</span> <span class="nx">g</span><span class="p">.</span><span class="nx">MinRequestTimeout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">apiResources</span><span class="p">,</span> <span class="nx">resourceInfos</span><span class="p">,</span> <span class="nx">ws</span><span class="p">,</span> <span class="nx">registrationErrors</span> <span class="o">:=</span> <span class="nx">installer</span><span class="p">.</span><span class="nf">Install</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">versionDiscoveryHandler</span> <span class="o">:=</span> <span class="nx">discovery</span><span class="p">.</span><span class="nf">NewAPIVersionHandler</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">,</span> <span class="nx">staticLister</span><span class="p">{</span><span class="nx">apiResources</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">versionDiscoveryHandler</span><span class="p">.</span><span class="nf">AddToWebService</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">removeNonPersistedResources</span><span class="p">(</span><span class="nx">resourceInfos</span><span class="p">),</span> <span class="nx">utilerrors</span><span class="p">.</span><span class="nf">NewAggregate</span><span class="p">(</span><span class="nx">registrationErrors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>installer.Install()</code> 方法会调用<code>registerResourceHandlers</code> 方法，真正开始创建和注册处理请求的 handler，需要说明的是<code>a.group.Storage</code> 是上文提到的<code>VersionedResourcesStorageMap</code> 传入版本号后获得的 map。读者可以自行参考图1的调用链进行分析。<code>a.registerResourceHandlers</code> 就是为每一种<code>Storage</code>注册handlers</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Install handlers for API resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">APIInstaller</span><span class="p">)</span> <span class="nf">Install</span><span class="p">()</span> <span class="p">([]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResource</span><span class="p">,</span> <span class="p">[]</span><span class="o">*</span><span class="nx">storageversion</span><span class="p">.</span><span class="nx">ResourceInfo</span><span class="p">,</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">WebService</span><span class="p">,</span> <span class="p">[]</span><span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">apiResources</span> <span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResource</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resourceInfos</span> <span class="p">[]</span><span class="o">*</span><span class="nx">storageversion</span><span class="p">.</span><span class="nx">ResourceInfo</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">errors</span> <span class="p">[]</span><span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ws</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">newWebService</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Register the paths in a deterministic (sorted) order to get a deterministic swagger spec.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">paths</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Storage</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">i</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// a.goup.Storage的签名是 map[string]Storage, for循环的path是map的key，即资源名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">path</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Storage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">paths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">path</span>
</span></span><span class="line"><span class="cl">		<span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sort</span><span class="p">.</span><span class="nf">Strings</span><span class="p">(</span><span class="nx">paths</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">path</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">paths</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiResource</span><span class="p">,</span> <span class="nx">resourceInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">registerResourceHandlers</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Storage</span><span class="p">[</span><span class="nx">path</span><span class="p">],</span> <span class="nx">ws</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>registerResourceHandlers</code> 会依据<code>rest.Storage</code>实现的接口生成相关的action。最终根据action生成handler并注册到rest容器中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// k8s.io/apiserver/pkg/endpoints/installer.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">APIInstaller</span><span class="p">)</span> <span class="nf">registerResourceHandlers</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">storage</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">,</span> <span class="nx">ws</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">WebService</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResource</span><span class="p">,</span> <span class="o">*</span><span class="nx">storageversion</span><span class="p">.</span><span class="nx">ResourceInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 初始化rest容器，根目录是APIInstaller的prefix属性，从InstallAPI调用链下来值为/apis/{goup}/{version}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">ws</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">newWebService</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 进行类型转换判断当前的storage支持哪些类型的操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">creater</span><span class="p">,</span> <span class="nx">isCreater</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Creater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">namedCreater</span><span class="p">,</span> <span class="nx">isNamedCreater</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">NamedCreater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lister</span><span class="p">,</span> <span class="nx">isLister</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Lister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">getter</span><span class="p">,</span> <span class="nx">isGetter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Getter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">getterWithOptions</span><span class="p">,</span> <span class="nx">isGetterWithOptions</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">GetterWithOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">gracefulDeleter</span><span class="p">,</span> <span class="nx">isGracefulDeleter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">GracefulDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">collectionDeleter</span><span class="p">,</span> <span class="nx">isCollectionDeleter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">CollectionDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">updater</span><span class="p">,</span> <span class="nx">isUpdater</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Updater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">patcher</span><span class="p">,</span> <span class="nx">isPatcher</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Patcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">watcher</span><span class="p">,</span> <span class="nx">isWatcher</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Watcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">connecter</span><span class="p">,</span> <span class="nx">isConnecter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Connecter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">storageMeta</span><span class="p">,</span> <span class="nx">isMetadata</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">StorageMetadata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">storageVersionProvider</span><span class="p">,</span> <span class="nx">isStorageVersionProvider</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">StorageVersionProvider</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Get the list of actions for the given scope.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="p">!</span><span class="nx">namespaceScoped</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造有无namespace资源的action
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Handle non-namespace scoped resources like nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造有namespace资源的action
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 构造handler的注册路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">namespaceParamName</span> <span class="o">:=</span> <span class="s">&#34;namespaces&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Handler for standard REST verbs (GET, PUT, POST and DELETE).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">namespaceParam</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">PathParameter</span><span class="p">(</span><span class="s">&#34;namespace&#34;</span><span class="p">,</span> <span class="s">&#34;object name and auth scope, such as for teams and projects&#34;</span><span class="p">).</span><span class="nf">DataType</span><span class="p">(</span><span class="s">&#34;string&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">namespacedPath</span> <span class="o">:=</span> <span class="nx">namespaceParamName</span> <span class="o">+</span> <span class="s">&#34;/{namespace}/&#34;</span> <span class="o">+</span> <span class="nx">resource</span>
</span></span><span class="line"><span class="cl">		<span class="nx">namespaceParams</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Parameter</span><span class="p">{</span><span class="nx">namespaceParam</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="c1">//resourcePath的值为 /namespaces/{namespace}/{resource}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">resourcePath</span> <span class="o">:=</span> <span class="nx">namespacedPath</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resourceParams</span> <span class="o">:=</span> <span class="nx">namespaceParams</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// itemPath： /namespaces/{namespace}/{resource}/{name}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// name是请求资源对象的名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">itemPath</span> <span class="o">:=</span> <span class="nx">namespacedPath</span> <span class="o">+</span> <span class="s">&#34;/{name}&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nameParams</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">namespaceParams</span><span class="p">,</span> <span class="nx">nameParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">proxyParams</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nameParams</span><span class="p">,</span> <span class="nx">pathParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">itemPathSuffix</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">isSubresource</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">itemPathSuffix</span> <span class="p">=</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">subresource</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// 有子资源等情况下 resourcePath被定义为：/namespaces/{namespace}/{resource}/{name}/{subResource}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">itemPath</span> <span class="p">=</span> <span class="nx">itemPath</span> <span class="o">+</span> <span class="nx">itemPathSuffix</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// itemPath与resourcePath的值一样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">resourcePath</span> <span class="p">=</span> <span class="nx">itemPath</span>
</span></span><span class="line"><span class="cl">			<span class="nx">resourceParams</span> <span class="p">=</span> <span class="nx">nameParams</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiResource</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">path</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiResource</span><span class="p">.</span><span class="nx">Namespaced</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiResource</span><span class="p">.</span><span class="nx">Kind</span> <span class="p">=</span> <span class="nx">resourceKind</span>
</span></span><span class="line"><span class="cl">		<span class="nx">namer</span> <span class="o">:=</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">ContextBasedNaming</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Namer</span><span class="p">:</span>         <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Namer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ClusterScoped</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据storage实现的接口添加添加相关的action
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;LIST&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isLister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isCreater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;DELETECOLLECTION&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isCollectionDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// DEPRECATED in 1.11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;WATCHLIST&#34;</span><span class="p">,</span> <span class="s">&#34;watch/&#34;</span> <span class="o">+</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">allowWatchList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">getSubpath</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">itemPath</span> <span class="o">+</span> <span class="s">&#34;/{path:*}&#34;</span><span class="p">,</span> <span class="nx">proxyParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;PUT&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isUpdater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;PATCH&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isPatcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;DELETE&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isGracefulDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// DEPRECATED in 1.11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;WATCH&#34;</span><span class="p">,</span> <span class="s">&#34;watch/&#34;</span> <span class="o">+</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isWatcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;CONNECT&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isConnecter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;CONNECT&#34;</span><span class="p">,</span> <span class="nx">itemPath</span> <span class="o">+</span> <span class="s">&#34;/{path:*}&#34;</span><span class="p">,</span> <span class="nx">proxyParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isConnecter</span> <span class="o">&amp;&amp;</span> <span class="nx">connectSubpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// list or post across namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// For ex: LIST all pods in all namespaces by sending a LIST request at /api/apiVersion/pods.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// TODO: more strongly type whether a resource allows these actions on &#34;all namespaces&#34; (bulk delete)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">isSubresource</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;LIST&#34;</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">isLister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// DEPRECATED in 1.11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;WATCHLIST&#34;</span><span class="p">,</span> <span class="s">&#34;watch/&#34;</span> <span class="o">+</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">allowWatchList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">action</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">actions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">action</span><span class="p">.</span><span class="nx">Verb</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s">&#34;GET&#34;</span><span class="p">:</span> <span class="c1">// Get a resource.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="kd">var</span> <span class="nx">handler</span> <span class="nx">restful</span><span class="p">.</span><span class="nx">RouteFunction</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 构造get请求的handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// restfulGetResourceWithOptions和restfulGetResource将handlers.GetResource函数转换成restful.RouteFunction，即handler的函数签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">isGetterWithOptions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">handler</span> <span class="p">=</span> <span class="nf">restfulGetResourceWithOptions</span><span class="p">(</span><span class="nx">getterWithOptions</span><span class="p">,</span> <span class="nx">reqScope</span><span class="p">,</span> <span class="nx">isSubresource</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">handler</span> <span class="p">=</span> <span class="nf">restfulGetResource</span><span class="p">(</span><span class="nx">getter</span><span class="p">,</span> <span class="nx">reqScope</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 将handler注册到rest容器中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// action.Path是上面定义的itemPath或resourcePath，对于GET来说是itemPath
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 当前注册的handler的路径是ws的根路径加上ation.Path. 完整的路径为：/apis/{goup}/{version}/namespaces/{namespace}/{resource}/{name}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">route</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">Path</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nx">handler</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">Doc</span><span class="p">(</span><span class="nx">doc</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">Param</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nf">QueryParameter</span><span class="p">(</span><span class="s">&#34;pretty&#34;</span><span class="p">,</span> <span class="s">&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">Operation</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="o">+</span><span class="nx">namespaced</span><span class="o">+</span><span class="nx">kind</span><span class="o">+</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Title</span><span class="p">(</span><span class="nx">subresource</span><span class="p">)</span><span class="o">+</span><span class="nx">operationSuffix</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">Produces</span><span class="p">(</span><span class="nb">append</span><span class="p">(</span><span class="nx">storageMeta</span><span class="p">.</span><span class="nf">ProducesMIMETypes</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">Verb</span><span class="p">),</span> <span class="nx">mediaTypes</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">Returns</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;OK&#34;</span><span class="p">,</span> <span class="nx">producedObject</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">Writes</span><span class="p">(</span><span class="nx">producedObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">isGetterWithOptions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">AddObjectParams</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">versionedGetOptions</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nf">addParams</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">Params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">routes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">routes</span><span class="p">,</span> <span class="nx">route</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s">&#34;LIST&#34;</span><span class="p">:</span> <span class="c1">// List all resources of a kind.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s">&#34;PUT&#34;</span><span class="p">:</span> <span class="c1">// Update a resource.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s">&#34;PATCH&#34;</span><span class="p">:</span> <span class="c1">// Partially update a resource
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s">&#34;POST&#34;</span><span class="p">:</span> <span class="c1">// Create a resource.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s">&#34;DELETE&#34;</span><span class="p">:</span> <span class="c1">// Delete a resource.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>registerResourceHandlers</code> 中创建的handler并不是直接调用<code>Creater</code> ,<code>Updater</code> 等接口定义的方法，而是在外面包了一层代码进行一些额外的处理，例如对象的编解码，admission control 的处理逻辑，针对 watch 这种长链接需要进行协议的处理等，相关的定义在<code>k8s.io/apiserver/pkg/endpoints/handlers</code> 包下。文本以Get和Create例，分析请求的处理逻辑。</p>
<p>Get请求的处理过程比较简单，通过请求的查询串构造出<code>metav1.GetOptions</code> ，然后交给 Getter 接口处理，最后在将查询结果进行转换发回给请求者。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// k8s.io/apiserver/pkg/endpoints/handlers/get.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// GetResource returns a function that handles retrieving a single resource from a rest.Storage object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">Getter</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">getResourceHandler</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">trace</span> <span class="o">*</span><span class="nx">utiltrace</span><span class="p">.</span><span class="nx">Trace</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// check for export
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">options</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 获取查询串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">values</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">();</span> <span class="nb">len</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将查询串解码成metav1.GetOptions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">metainternalversionscheme</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">.</span><span class="nf">DecodeParameters</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">MetaGroupVersion</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewBadRequest</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">trace</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">&#34;About to Get from storage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 交给Getter接口处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// getResourceHandler is an HTTP handler function for get requests. It delegates to the
</span></span></span><span class="line"><span class="cl"><span class="c1">// passed-in getterFunc to perform the actual get.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">getResourceHandler</span><span class="p">(</span><span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">getter</span> <span class="nx">getterFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Namer</span><span class="p">.</span><span class="nf">Name</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">WithNamespace</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getter</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">trace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对处理结果进行转化为用户期望的格式并写入到response中返回给用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">transformResponseObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">scope</span><span class="p">,</span> <span class="nx">trace</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">outputMediaType</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Create的处理逻辑在 <code>createHandler</code> 中，代码较长，主要做以下几件事情:</p>
<p>1 对查询串进行解码生成 <code>metav1.CreateOptions</code> 。</p>
<p>2 对请求的body体中的数据进行解码，生成资源对象。 解码的对象版本是 internal 版本，internal 版本是该资源对象所有版本字段的全集。针对不同版本的对象内部可以使用相同的代码进行处理。</p>
<p>3 对对象进行修改的准入控制，判断是否修需要修改对象。</p>
<p>4 交给creater接口创建资源对象。</p>
<p>5 将数据转换为期望的格式写入 response 中，调用 creater 接口返回的结果仍然是 internal 版本，编码时，会编码成用户请求的版本返回给用户。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// k8s.io/apiserver/pkg/endpoints/handlers/create.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// CreateNamedResource returns a function that will handle a resource creation with name.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CreateNamedResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">NamedCreater</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admission</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">createHandler</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">scope</span><span class="p">,</span> <span class="nx">admission</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createHandler</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">NamedCreater</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admit</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">includeName</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从request中取出请求body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">body</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">limitedReadBody</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">MaxRequestBodyBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对查询传进行解码生成metav1.CreateOptions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">options</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">values</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">metainternalversionscheme</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">.</span><span class="nf">DecodeParameters</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">MetaGroupVersion</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 将请求body解码成资源对象, defaultGVK是用户请求的版本，这里decoder解码出来的对象是internal版本的对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">obj</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">defaultGVK</span><span class="p">,</span> <span class="nx">original</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">admissionAttributes</span> <span class="o">:=</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">NewAttributesRecord</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Resource</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Subresource</span><span class="p">,</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Create</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">dryrun</span><span class="p">.</span><span class="nf">IsDryRun</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">),</span> <span class="nx">userInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 构建调用create方法的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">requestFunc</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ctx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">obj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rest</span><span class="p">.</span><span class="nf">AdmissionToValidateObjectFunc</span><span class="p">(</span><span class="nx">admit</span><span class="p">,</span> <span class="nx">admissionAttributes</span><span class="p">,</span> <span class="nx">scope</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Dedup owner references before updating managed fields
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">dedupOwnerReferencesAndAddWarning</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">(),</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">finisher</span><span class="p">.</span><span class="nf">FinishRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 执行mutation的admission操作，即在创建时对象进行修改操作。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// admin在buildGenericConfig中初始化，通过config传递给genericsever，然后传递到此处
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">mutatingAdmission</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">admit</span><span class="p">.(</span><span class="nx">admission</span><span class="p">.</span><span class="nx">MutationInterface</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">mutatingAdmission</span><span class="p">.</span><span class="nf">Handles</span><span class="p">(</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Create</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mutatingAdmission</span><span class="p">.</span><span class="nf">Admit</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">admissionAttributes</span><span class="p">,</span> <span class="nx">scope</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Dedup owner references again after mutating admission happens
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">dedupOwnerReferencesAndAddWarning</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">(),</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 调用创建方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">requestFunc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="o">...</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// resutl也是internal版本的对象，transformResponseObject会转换为用户请求的版本并输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">transformResponseObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">scope</span><span class="p">,</span> <span class="nx">trace</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">outputMediaType</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><p>Create请求的流程可以总结为下图</p>
<p>















<figure  id="figure-图3-create请求处理流程">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图3 create请求处理流程" srcset="
               /blog/apiserver-handler-register/images/create-process-flow_hudd1c8ff2a3404c1beeafe8a3236d6a07_326195_8c1532f33f83e79f00d18b81422e42bf.webp 400w,
               /blog/apiserver-handler-register/images/create-process-flow_hudd1c8ff2a3404c1beeafe8a3236d6a07_326195_c0babb93d469cb783257868427375e36.webp 760w,
               /blog/apiserver-handler-register/images/create-process-flow_hudd1c8ff2a3404c1beeafe8a3236d6a07_326195_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apiserver-handler-register/images/create-process-flow_hudd1c8ff2a3404c1beeafe8a3236d6a07_326195_8c1532f33f83e79f00d18b81422e42bf.webp"
               width="760"
               height="206"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图3 create请求处理流程
    </figcaption></figure>
</p>
<h2 id="总结">总结</h2>
<p>本文介绍了 K8s内置资源的注册过程，对APIServer的访问会先经过 filter，再路由给具体的 handler。filter 在 <code>DefaultBuildHandlerChain</code> 中定义，主要对请求做超时处理，认证，鉴权等操作。handler 的注册则是初始化 <code>APIGoupInfo</code> 并设置其 <code>VersionedResourcesStorageMap</code> 后作为入参，调用 <code>GenericAPIServer.InstallAPIGroups</code> 即可完成 handler 的注册。<code>k8s.io/apiserver/pkg/endpoints/handlers</code> 包中的代码则是对用户请求做编解码，对象版本转换，协议处理等操作，最后在交给<code>rest.Storage</code> 具体实现的接口进行处理。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://blog.tianfeiyu.com/source-code-reading-notes/kubernetes/kube_apiserver.html#kube-apiserver-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener">https://blog.tianfeiyu.com/source-code-reading-notes/kubernetes/kube_apiserver.html#kube-apiserver-处理流程</a></li>
<li><a href="https://hackerain.me/2020/10/05/kubernetes/kube-apiserver-genericapiserver.html" target="_blank" rel="noopener">https://hackerain.me/2020/10/05/kubernetes/kube-apiserver-genericapiserver.html</a></li>
<li><a href="https://hackerain.me/2020/09/19/kubernetes/kube-apiserver-storage-overview.html" target="_blank" rel="noopener">https://hackerain.me/2020/09/19/kubernetes/kube-apiserver-storage-overview.html</a></li>
<li><a href="https://github.com/gosoon/source-code-reading-notes/blob/master/kubernetes/kube_apiserver.md" target="_blank" rel="noopener">https://github.com/gosoon/source-code-reading-notes/blob/master/kubernetes/kube_apiserver.md</a></li>
<li><a href="https://time.geekbang.org/column/article/41876" target="_blank" rel="noopener">https://time.geekbang.org/column/article/41876</a></li>
</ul>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/kubernetes/">kubernetes</a>
  
  <a class="badge badge-light" href="/tag/apiserver/">APIServer</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E9%9F%A9%E4%BC%9F%E6%A3%AE/"><img class="avatar mr-3 avatar-circle" src="/author/%E9%9F%A9%E4%BC%9F%E6%A3%AE/avatar_hue9387f5a0c7772f70403049c6db82162_59626_270x270_fill_lanczos_center_3.png" alt="韩伟森"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E9%9F%A9%E4%BC%9F%E6%A3%AE/">韩伟森</a></p>
      
      <p class="card-text">就职于中国移动云能力中心，专注于云原生领域。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/envoy-stateful-session-hold-mechanism-design-and-implementation/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>Envoy 有状态会话保持机制设计与实现</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/microservice-engine-architecture-analysis/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>一种微服务引擎架构剖析及服务治理原理介绍</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/apiserver-handler-register/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/kubernetes-apiserver-cacher/">Kubernetes1.18 架构设计源码阅读</a></li>
      
      <li><a href="/blog/cloudnative-ci-argo-workflow/">Argo Workflow介绍：一款强大的云原生持续集成工具</a></li>
      
      <li><a href="/blog/kubernetes-gateway-api-explained/">Kubernetes Gateway API 深入解读和落地指南</a></li>
      
      <li><a href="/blog/egress-for-k8s/">是时候思考 Kubernetes 出向流量安全了</a></li>
      
      <li><a href="/blog/does-kubernetes-really-give-you-multicloud-portability/">Kubernetes 真的能提供多云可移植性吗？</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2023 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
