<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  
  <title>Kubernetes client-go informer原理 | 云原生社区</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这篇文章从Informer的初始化调用链和事件如何流向的角度分析了Informer各个组件。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/all.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/client-go-informer/" />
  <meta property="og:title" content="Kubernetes client-go informer原理" />
  <meta property="og:description" content="这篇文章从Informer的初始化调用链和事件如何流向的角度分析了Informer各个组件。" />
  <meta property="og:image" content="https://cloudnative.to/images/blog/kubernetes-simon-banner.jpg" />
</head>
<body>
<!-- header -->

<img src="images/logo-square.jpg" width="0" height="0" />
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
     <img src="" width='700'>
</div>
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog/">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/community/sig/">兴趣小组</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
                <a class="dropdown-item" href="https://istio.io/latest/zh/">Istio 中文文档</a>
                
              </div>
            </li>
            
            
          </ul>

          
          

          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3 text-capitalize">Kubernetes client go informer原理</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">这篇文章从Informer的初始化调用链和事件如何流向的角度分析了Informer各个组件。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/kubernetes-simon-banner.jpg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type"><a href="/categories/kubernetes">Kubernetes</a></div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://github.com/sundongmin">孙东民</a></strong>
          
            发表于 <strong class="text-dark">2020年8月28日</strong></div>
        <hr>
        <div class="content">
          <h2 id="informer原理图">Informer原理图</h2>
<p>为了便于理解，先上两张图。</p>
<h3 id="源码的调用流程图">源码的调用流程图</h3>
<p>可以对照着图中的代码文件及代码行数跟下代码。</p>
<p>注: 图中的代码行数基于<code>1.15</code>版。</p>
<p><img src="informer.png" alt="informer"></p>
<h3 id="数据结构图">数据结构图</h3>
<p><img src="informer-data-structure.png" alt="informer-data-structure"></p>
<h2 id="informer-工厂">Informer 工厂</h2>
<p>先来看下<code>cmd/kube-controller-manager/app/controllermanager.go:162</code>的<code>Run</code>方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">CompletedConfig</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">run</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
		<span style="color:#a6e22e">rootClientBuilder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">SimpleControllerClientBuilder</span>{
			<span style="color:#a6e22e">ClientConfig</span>: <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Kubeconfig</span>,
		}
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">clientBuilder</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">ControllerClientBuilder</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ComponentConfig</span>.<span style="color:#a6e22e">KubeCloudShared</span>.<span style="color:#a6e22e">UseServiceAccountCredentials</span> {
			<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ComponentConfig</span>.<span style="color:#a6e22e">SAController</span>.<span style="color:#a6e22e">ServiceAccountKeyFile</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
				<span style="color:#75715e">// It&#39;s possible another controller process is creating the tokens for us.
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// If one isn&#39;t, we&#39;ll timeout and exit when our client builder is unable to create the tokens.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;--use-service-account-credentials was specified without providing a --service-account-private-key-file&#34;</span>)
			}

			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shouldTurnOnDynamicClient</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Client</span>) {
				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;using dynamic client builder&#34;</span>)
				<span style="color:#75715e">//Dynamic builder will use TokenRequest feature and refresh service account token periodically
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">clientBuilder</span> = <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">NewDynamicClientBuilder</span>(
					<span style="color:#a6e22e">restclient</span>.<span style="color:#a6e22e">AnonymousClientConfig</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Kubeconfig</span>),
					<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">CoreV1</span>(),
					<span style="color:#e6db74">&#34;kube-system&#34;</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;using legacy client builder&#34;</span>)
				<span style="color:#a6e22e">clientBuilder</span> = <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">SAControllerClientBuilder</span>{
					<span style="color:#a6e22e">ClientConfig</span>:         <span style="color:#a6e22e">restclient</span>.<span style="color:#a6e22e">AnonymousClientConfig</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Kubeconfig</span>),
					<span style="color:#a6e22e">CoreClient</span>:           <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">CoreV1</span>(),
					<span style="color:#a6e22e">AuthenticationClient</span>: <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">AuthenticationV1</span>(),
					<span style="color:#a6e22e">Namespace</span>:            <span style="color:#e6db74">&#34;kube-system&#34;</span>,
				}
			}
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">clientBuilder</span> = <span style="color:#a6e22e">rootClientBuilder</span>
		}
		<span style="color:#a6e22e">controllerContext</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateControllerContext</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">rootClientBuilder</span>, <span style="color:#a6e22e">clientBuilder</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;error building controller context: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">saTokenControllerInitFunc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serviceAccountTokenControllerStarter</span>{<span style="color:#a6e22e">rootClientBuilder</span>: <span style="color:#a6e22e">rootClientBuilder</span>}.<span style="color:#a6e22e">startServiceAccountTokenController</span>

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">StartControllers</span>(<span style="color:#a6e22e">controllerContext</span>, <span style="color:#a6e22e">saTokenControllerInitFunc</span>, <span style="color:#a6e22e">NewControllerInitializers</span>(<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">LoopMode</span>), <span style="color:#a6e22e">unsecuredMux</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;error starting controllers: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		}

		<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">Stop</span>)
		<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">GenericInformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">Stop</span>)
		close(<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">InformersStarted</span>)

		<span style="color:#66d9ef">select</span> {}
	}
}
<span style="color:#f92672">...</span>
</code></pre></div><p>上面代码中比较重要的几个方法<code>CreateControllerContext</code>, <code>StartControllers</code>, <code>controllerContext.InformerFactory.Start</code>。</p>
<h3 id="创建controllercontext">创建ControllerContext</h3>
<p>再次进入<code>CreateControllerContext</code>方法中, 一直跟下去, 最终会调用到<code>vendor/k8s.io/client-go/informers/factory.go:108</code>的<code>NewSharedInformerFactoryWithOptions</code>方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewSharedInformerFactoryWithOptions</span>(<span style="color:#a6e22e">client</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#a6e22e">defaultResync</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">SharedInformerOption</span>) <span style="color:#a6e22e">SharedInformerFactory</span> {
	<span style="color:#a6e22e">factory</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sharedInformerFactory</span>{
		<span style="color:#a6e22e">client</span>:           <span style="color:#a6e22e">client</span>,
		<span style="color:#a6e22e">namespace</span>:        <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">NamespaceAll</span>,
		<span style="color:#a6e22e">defaultResync</span>:    <span style="color:#a6e22e">defaultResync</span>,
		<span style="color:#a6e22e">informers</span>:        make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>]<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span>),
		<span style="color:#a6e22e">startedInformers</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>]<span style="color:#66d9ef">bool</span>),
		<span style="color:#a6e22e">customResync</span>:     make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>]<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>),
	}

	<span style="color:#75715e">// Apply all options
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">opt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">options</span> {
		<span style="color:#a6e22e">factory</span> = <span style="color:#a6e22e">opt</span>(<span style="color:#a6e22e">factory</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">factory</span>
}
</code></pre></div><p>从上面的代码中, <code>sharedInformerFactory</code>结构体中，有一个<code>informers</code>的<code>map</code>，这个map的key为资源类型，value为关注该资源类型的Informer。</p>
<h3 id="启动所有内置的controller">启动所有内置的Controller</h3>
<p>再来看<code>StartControllers</code>方法, 调用<code>StartControllers</code>之前, 会先调用<code>NewControllerInitializers</code>方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewControllerInitializers</span>(<span style="color:#a6e22e">loopMode</span> <span style="color:#a6e22e">ControllerLoopMode</span>) <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">InitFunc</span> {
	<span style="color:#a6e22e">controllers</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">InitFunc</span>{}
    <span style="color:#f92672">...</span>
	<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;deployment&#34;</span>] = <span style="color:#a6e22e">startDeploymentController</span>
    <span style="color:#f92672">...</span>

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controllers</span>
}
</code></pre></div><p>通过这个方法可以返回所有的内置controller, 这里map中的value存的只是相应的回调函数, 此时还没调用, 在<code>StartControllers</code>方法中会实际调用。</p>
<p>接下来调用StartControllers方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">StartControllers</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">ControllerContext</span>, <span style="color:#a6e22e">startSATokenController</span> <span style="color:#a6e22e">InitFunc</span>, <span style="color:#a6e22e">controllers</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">InitFunc</span>, <span style="color:#a6e22e">unsecuredMux</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">PathRecorderMux</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">controllerName</span>, <span style="color:#a6e22e">initFn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">controllers</span> {
        <span style="color:#f92672">...</span>
		<span style="color:#a6e22e">debugHandler</span>, <span style="color:#a6e22e">started</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initFn</span>(<span style="color:#a6e22e">ctx</span>)
		<span style="color:#f92672">...</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>这里循环<code>NewControllerInitializers</code>方法返回的所有controller, 取到map的value, 然后调用.</p>
<h4 id="启动各个controller">启动各个Controller</h4>
<p>再来看上一步的<code>initFn</code>, 也就是各个<code>startXXXController</code>方法, 我们以<code>startDeploymentController</code>为例,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">startDeploymentController</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">ControllerContext</span>) (<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">AvailableResources</span>[<span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionResource</span>{<span style="color:#a6e22e">Group</span>: <span style="color:#e6db74">&#34;apps&#34;</span>, <span style="color:#a6e22e">Version</span>: <span style="color:#e6db74">&#34;v1&#34;</span>, <span style="color:#a6e22e">Resource</span>: <span style="color:#e6db74">&#34;deployments&#34;</span>}] {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#a6e22e">dc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">NewDeploymentController</span>(
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Deployments</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">ReplicaSets</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Pods</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ClientBuilder</span>.<span style="color:#a6e22e">ClientOrDie</span>(<span style="color:#e6db74">&#34;deployment-controller&#34;</span>),
	)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error creating Deployment controller: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">Run</span>(int(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ComponentConfig</span>.<span style="color:#a6e22e">DeploymentController</span>.<span style="color:#a6e22e">ConcurrentDeploymentSyncs</span>), <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Stop</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><code>deployment.NewDeploymentController</code>函数创建了<code>Deployment Controller</code>，而该创建函数的前三个参数分别为 Deployment、ReplicaSet、Pod 的 Informer. 可以看到, Informer的单例工厂以 ApiGroup 为路径提供了不同资源的 Informer.</p>
<p><code>.Apps().V1().Deployments()</code>方法返回的虽然叫<code>DeploymentInformer</code>, 但这不是真正的Informer</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">version</span>) <span style="color:#a6e22e">Deployments</span>() <span style="color:#a6e22e">DeploymentInformer</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">deploymentInformer</span>{<span style="color:#a6e22e">factory</span>: <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">factory</span>, <span style="color:#a6e22e">namespace</span>: <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">tweakListOptions</span>: <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">tweakListOptions</span>}
}
</code></pre></div><p>真正的<code>Informer</code>是在调用<code>NewDeploymentController</code> -&gt; <code>dInformer.Informer()</code> -&gt; <code>f.factory.InformerFor</code>方法创建的</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewDeploymentController</span>(<span style="color:#a6e22e">dInformer</span> <span style="color:#a6e22e">appsinformers</span>.<span style="color:#a6e22e">DeploymentInformer</span>, <span style="color:#a6e22e">rsInformer</span> <span style="color:#a6e22e">appsinformers</span>.<span style="color:#a6e22e">ReplicaSetInformer</span>, <span style="color:#a6e22e">podInformer</span> <span style="color:#a6e22e">coreinformers</span>.<span style="color:#a6e22e">PodInformer</span>, <span style="color:#a6e22e">client</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">Interface</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">DeploymentController</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">eventBroadcaster</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">NewBroadcaster</span>()
	<span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">StartLogging</span>(<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>)
	<span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">StartRecordingToSink</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1core</span>.<span style="color:#a6e22e">EventSinkImpl</span>{<span style="color:#a6e22e">Interface</span>: <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Events</span>(<span style="color:#e6db74">&#34;&#34;</span>)})

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">RESTClient</span>().<span style="color:#a6e22e">GetRateLimiter</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">RegisterMetricAndTrackRateLimiterUsage</span>(<span style="color:#e6db74">&#34;deployment_controller&#34;</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">RESTClient</span>().<span style="color:#a6e22e">GetRateLimiter</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
	}
	<span style="color:#a6e22e">dc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">DeploymentController</span>{
		<span style="color:#a6e22e">client</span>:        <span style="color:#a6e22e">client</span>,
		<span style="color:#a6e22e">eventRecorder</span>: <span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">NewRecorder</span>(<span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">Scheme</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">EventSource</span>{<span style="color:#a6e22e">Component</span>: <span style="color:#e6db74">&#34;deployment-controller&#34;</span>}),
		<span style="color:#a6e22e">queue</span>:         <span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">NewNamedRateLimitingQueue</span>(<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">DefaultControllerRateLimiter</span>(), <span style="color:#e6db74">&#34;deployment&#34;</span>),
	}
	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">rsControl</span> = <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">RealRSControl</span>{
		<span style="color:#a6e22e">KubeClient</span>: <span style="color:#a6e22e">client</span>,
		<span style="color:#a6e22e">Recorder</span>:   <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">eventRecorder</span>,
	}

	<span style="color:#a6e22e">dInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>:    <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">addDeployment</span>,
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">updateDeployment</span>,
		<span style="color:#75715e">// This will enter the sync loop and no-op, because the deployment has been deleted from the store.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">deleteDeployment</span>,
	})
	<span style="color:#a6e22e">rsInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>:    <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">addReplicaSet</span>,
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">updateReplicaSet</span>,
		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">deleteReplicaSet</span>,
	})
	<span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">deletePod</span>,
	})

	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">syncHandler</span> = <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">syncDeployment</span>
	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">enqueueDeployment</span> = <span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">enqueue</span>

	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">dLister</span> = <span style="color:#a6e22e">dInformer</span>.<span style="color:#a6e22e">Lister</span>()
	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">rsLister</span> = <span style="color:#a6e22e">rsInformer</span>.<span style="color:#a6e22e">Lister</span>()
	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">podLister</span> = <span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Lister</span>()
	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">dListerSynced</span> = <span style="color:#a6e22e">dInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>
	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">rsListerSynced</span> = <span style="color:#a6e22e">rsInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>
	<span style="color:#a6e22e">dc</span>.<span style="color:#a6e22e">podListerSynced</span> = <span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dc</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">staging</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">client</span><span style="color:#f92672">-</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">informers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apps</span><span style="color:#f92672">/</span><span style="color:#a6e22e">v1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">deployment</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">83</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">deploymentInformer</span>) <span style="color:#a6e22e">Informer</span>() <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">InformerFor</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>{}, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">defaultInformer</span>)
}

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">staging</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">client</span><span style="color:#f92672">-</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">informers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apps</span><span style="color:#f92672">/</span><span style="color:#a6e22e">v1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">deployment</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">79</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">deploymentInformer</span>) <span style="color:#a6e22e">defaultInformer</span>(<span style="color:#a6e22e">client</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewFilteredDeploymentInformer</span>(<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Indexers</span>{<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NamespaceIndex</span>: <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceIndexFunc</span>}, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">tweakListOptions</span>)
}

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">staging</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">client</span><span style="color:#f92672">-</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">informers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">factory</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">163</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedInformerFactory</span>) <span style="color:#a6e22e">InformerFor</span>(<span style="color:#a6e22e">obj</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">newFunc</span> <span style="color:#a6e22e">internalinterfaces</span>.<span style="color:#a6e22e">NewInformerFunc</span>) <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span> {
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">informerType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">obj</span>)
	<span style="color:#a6e22e">informer</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">informers</span>[<span style="color:#a6e22e">informerType</span>]
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">exists</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">informer</span>
	}

	<span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">customResync</span>[<span style="color:#a6e22e">informerType</span>]
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">exists</span> {
		<span style="color:#a6e22e">resyncPeriod</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">defaultResync</span>
	}

	<span style="color:#a6e22e">informer</span> = <span style="color:#a6e22e">newFunc</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">resyncPeriod</span>)
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">informers</span>[<span style="color:#a6e22e">informerType</span>] = <span style="color:#a6e22e">informer</span>

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">informer</span>
}
</code></pre></div><p>从上面的<code>InformerFor</code>方法可以看到,</p>
<ol>
<li>如果Informer工厂里已经存在informer, 就直接返回了, 也就是说一种资源始终只有一个informer</li>
<li>如果不存在, 则调用传进来的参数<code>newFunc</code>实例化informer(注: <code>newFunc</code>即为<code>defaultInformer</code>, 返回的类型为<code>cache.SharedIndexInformer</code></li>
</ol>
<p>至此, DeploymentInformer被实例化，并真正的承担Informer的职责, 同时添加到Informer工厂的map中.</p>
<h3 id="informerfactory启动">InformerFactory启动</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedInformerFactory</span>) <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">informerType</span>, <span style="color:#a6e22e">informer</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">informers</span> {
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">startedInformers</span>[<span style="color:#a6e22e">informerType</span>] {
			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)
			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">startedInformers</span>[<span style="color:#a6e22e">informerType</span>] = <span style="color:#66d9ef">true</span>
		}
	}
}

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">staging</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">client</span><span style="color:#f92672">-</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">shared_informer</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">242</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()

	<span style="color:#a6e22e">fifo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDeltaFIFO</span>(<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>)

	<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Config</span>{
		<span style="color:#a6e22e">Queue</span>:            <span style="color:#a6e22e">fifo</span>,
		<span style="color:#a6e22e">ListerWatcher</span>:    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">listerWatcher</span>,
		<span style="color:#a6e22e">ObjectType</span>:       <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">objectType</span>,
		<span style="color:#a6e22e">FullResyncPeriod</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span>,
		<span style="color:#a6e22e">RetryOnError</span>:     <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">ShouldResync</span>:     <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">shouldResync</span>,

		<span style="color:#a6e22e">Process</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">HandleDeltas</span>,
	}

	<span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Lock</span>()
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Unlock</span>()

		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">controller</span> = <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cfg</span>)
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">controller</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">controller</span>).<span style="color:#a6e22e">clock</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">clock</span>
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">started</span> = <span style="color:#66d9ef">true</span>
	}()

	<span style="color:#75715e">// Separate stop channel because Processor should be stopped strictly after controller
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">processorStopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Group</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()              <span style="color:#75715e">// Wait for Processor to stop
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">processorStopCh</span>) <span style="color:#75715e">// Tell Processor to stop
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">StartWithChannel</span>(<span style="color:#a6e22e">processorStopCh</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cacheMutationDetector</span>.<span style="color:#a6e22e">Run</span>)
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">StartWithChannel</span>(<span style="color:#a6e22e">processorStopCh</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">run</span>)

	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Lock</span>()
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Unlock</span>()
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">stopped</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e">// Don&#39;t want any new listeners
</span><span style="color:#75715e"></span>	}()
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)
}
</code></pre></div><p><code>sharedIndexInformer</code>的<code>Run</code>方法代码不多，但是很重要，这块逻辑即为第一张图中粉红色的地方，主要做了下面几件事：</p>
<ol>
<li>初始化fifo队列</li>
<li>初始化controller</li>
<li>启动cacheMutationDetector</li>
<li>启动processor</li>
<li>运行controller(此controller非XXXController)</li>
</ol>
<p>接下来, 看下这几件事情的详细过程</p>
<h4 id="sharedindexinformer">sharedIndexInformer</h4>
<p>我们先把视线拉回到上面第一张图片的最右侧, 因为这块做了一些初始化的工作，以便后面的逻辑使用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewSharedIndexInformer</span>(<span style="color:#a6e22e">lw</span> <span style="color:#a6e22e">ListerWatcher</span>, <span style="color:#a6e22e">objType</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">defaultEventHandlerResyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>, <span style="color:#a6e22e">indexers</span> <span style="color:#a6e22e">Indexers</span>) <span style="color:#a6e22e">SharedIndexInformer</span> {
	<span style="color:#a6e22e">realClock</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">RealClock</span>{}
	<span style="color:#a6e22e">sharedIndexInformer</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sharedIndexInformer</span>{
		<span style="color:#a6e22e">processor</span>:                       <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sharedProcessor</span>{<span style="color:#a6e22e">clock</span>: <span style="color:#a6e22e">realClock</span>},
		<span style="color:#a6e22e">indexer</span>:                         <span style="color:#a6e22e">NewIndexer</span>(<span style="color:#a6e22e">DeletionHandlingMetaNamespaceKeyFunc</span>, <span style="color:#a6e22e">indexers</span>),
		<span style="color:#a6e22e">listerWatcher</span>:                   <span style="color:#a6e22e">lw</span>,
		<span style="color:#a6e22e">objectType</span>:                      <span style="color:#a6e22e">objType</span>,
		<span style="color:#a6e22e">resyncCheckPeriod</span>:               <span style="color:#a6e22e">defaultEventHandlerResyncPeriod</span>,
		<span style="color:#a6e22e">defaultEventHandlerResyncPeriod</span>: <span style="color:#a6e22e">defaultEventHandlerResyncPeriod</span>,
		<span style="color:#a6e22e">cacheMutationDetector</span>:           <span style="color:#a6e22e">NewCacheMutationDetector</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%T&#34;</span>, <span style="color:#a6e22e">objType</span>)),
		<span style="color:#a6e22e">clock</span>:                           <span style="color:#a6e22e">realClock</span>,
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sharedIndexInformer</span>
}
</code></pre></div><p>在<code>sharedIndexInformer</code>的初始化逻辑中, 初始化了</p>
<ol>
<li>processor: 提供了 EventHandler 注册和事件分发的功能</li>
<li>indexer: 提供了资源缓存的功能</li>
<li>listerWatcher: 由模板类提供，包含特定资源的 List 和 Watch 方法</li>
<li>objectType: 用来标记关注哪种特定资源类型</li>
<li>cacheMutationDetector: 监控 Informer 的缓存</li>
</ol>
<h5 id="sharedprocessor">sharedProcessor</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">sharedProcessor</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">listenersStarted</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#a6e22e">listenersLock</span>    <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
	<span style="color:#a6e22e">listeners</span>        []<span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>
	<span style="color:#a6e22e">syncingListeners</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>
	<span style="color:#a6e22e">clock</span>            <span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">Clock</span>
	<span style="color:#a6e22e">wg</span>               <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Group</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">processorListener</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">nextCh</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">interface</span>{}
	<span style="color:#a6e22e">addCh</span>  <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">interface</span>{}

	<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">ResourceEventHandler</span>

	<span style="color:#75715e">// pendingNotifications is an unbounded ring buffer that holds all notifications not yet distributed.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// There is one per listener, but a failing/stalled listener will have infinite pendingNotifications
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// added until we OOM.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO: This is no worse than before, since reflectors were backed by unbounded DeltaFIFOs, but
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// we should try to do something better.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pendingNotifications</span> <span style="color:#a6e22e">buffer</span>.<span style="color:#a6e22e">RingGrowing</span>

	<span style="color:#75715e">// requestedResyncPeriod is how frequently the listener wants a full resync from the shared informer
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">requestedResyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
	<span style="color:#75715e">// resyncPeriod is how frequently the listener wants a full resync from the shared informer. This
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// value may differ from requestedResyncPeriod if the shared informer adjusts it to align with the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// informer&#39;s overall resync check period.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
	<span style="color:#75715e">// nextResync is the earliest time the listener should get a full resync
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nextResync</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
	<span style="color:#75715e">// resyncLock guards access to resyncPeriod and nextResync
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">resyncLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
}
</code></pre></div><p>在<code>sharedProcessor</code>结构体中, 可以看到有两个<code>processorListener</code>的切片</p>
<p>当我们注册一个 Handler 到 Informer 时, 最终会被转换为一个名为 <code>processorListener</code> 结构体的实例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newProcessListener</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">ResourceEventHandler</span>, <span style="color:#a6e22e">requestedResyncPeriod</span>, <span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>, <span style="color:#a6e22e">now</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">bufferSize</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span> {
	<span style="color:#a6e22e">ret</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">processorListener</span>{
		<span style="color:#a6e22e">nextCh</span>:                make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">interface</span>{}),
		<span style="color:#a6e22e">addCh</span>:                 make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">interface</span>{}),
		<span style="color:#a6e22e">handler</span>:               <span style="color:#a6e22e">handler</span>,
		<span style="color:#a6e22e">pendingNotifications</span>:  <span style="color:#f92672">*</span><span style="color:#a6e22e">buffer</span>.<span style="color:#a6e22e">NewRingGrowing</span>(<span style="color:#a6e22e">bufferSize</span>),
		<span style="color:#a6e22e">requestedResyncPeriod</span>: <span style="color:#a6e22e">requestedResyncPeriod</span>,
		<span style="color:#a6e22e">resyncPeriod</span>:          <span style="color:#a6e22e">resyncPeriod</span>,
	}

	<span style="color:#a6e22e">ret</span>.<span style="color:#a6e22e">determineNextResync</span>(<span style="color:#a6e22e">now</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret</span>
}
</code></pre></div><p>该实例主要包含两个 channel 和外面注册的 Handler 方法。而此处被实例化的 <code>processorListener</code> 对象最终会被添加到 <code>sharedProcessor.listeners</code> 列表中</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedProcessor</span>) <span style="color:#a6e22e">addListener</span>(<span style="color:#a6e22e">listener</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">addListenerLocked</span>(<span style="color:#a6e22e">listener</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersStarted</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">run</span>)
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">pop</span>)
	}
}
</code></pre></div><h4 id="初始化deltafifo">初始化DeltaFIFO</h4>
<p>有了前面初始化的<code>sharedIndexInformer</code>, 现在开始解析<code>sharedIndexInformer</code>的<code>Run</code>方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">fifo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDeltaFIFO</span>(<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>) <span style="color:#75715e">// s.indexer再前面已经初始化好
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewDeltaFIFO</span>(<span style="color:#a6e22e">keyFunc</span> <span style="color:#a6e22e">KeyFunc</span>, <span style="color:#a6e22e">knownObjects</span> <span style="color:#a6e22e">KeyListerGetter</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">DeltaFIFO</span> {
	<span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">DeltaFIFO</span>{
		<span style="color:#a6e22e">items</span>:        <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">Deltas</span>{},
		<span style="color:#a6e22e">queue</span>:        []<span style="color:#66d9ef">string</span>{},
		<span style="color:#a6e22e">keyFunc</span>:      <span style="color:#a6e22e">keyFunc</span>,
		<span style="color:#a6e22e">knownObjects</span>: <span style="color:#a6e22e">knownObjects</span>,
	}
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">L</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f</span>
}
</code></pre></div><h4 id="初始化controller注意此处的process字段被赋值为shandledeltas">初始化controller(注意此处的Process字段被赋值为s.HandleDeltas)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Config</span>{
	<span style="color:#a6e22e">Queue</span>:            <span style="color:#a6e22e">fifo</span>,
	<span style="color:#a6e22e">ListerWatcher</span>:    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">listerWatcher</span>,
	<span style="color:#a6e22e">ObjectType</span>:       <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">objectType</span>,
	<span style="color:#a6e22e">FullResyncPeriod</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span>,
	<span style="color:#a6e22e">RetryOnError</span>:     <span style="color:#66d9ef">false</span>,
	<span style="color:#a6e22e">ShouldResync</span>:     <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">shouldResync</span>,

	<span style="color:#a6e22e">Process</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">HandleDeltas</span>,
}
<span style="color:#66d9ef">func</span>() {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Unlock</span>()
    
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">controller</span> = <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cfg</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">controller</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">controller</span>).<span style="color:#a6e22e">clock</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">clock</span>
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">started</span> = <span style="color:#66d9ef">true</span>
}()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Config</span>) <span style="color:#a6e22e">Controller</span> {
	<span style="color:#a6e22e">ctlr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">controller</span>{
		<span style="color:#a6e22e">config</span>: <span style="color:#f92672">*</span><span style="color:#a6e22e">c</span>,
		<span style="color:#a6e22e">clock</span>:  <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">RealClock</span>{},
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctlr</span>
}
</code></pre></div><h4 id="启动processor">启动processor</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedProcessor</span>) <span style="color:#a6e22e">run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RLock</span>()
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RUnlock</span>()
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listeners</span> {
			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">run</span>)
			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">pop</span>)
		}
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersStarted</span> = <span style="color:#66d9ef">true</span>
	}()
	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RUnlock</span>()
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listeners</span> {
		close(<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">addCh</span>) <span style="color:#75715e">// Tell .pop() to stop. .pop() will tell .run() to stop
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>() <span style="color:#75715e">// Wait for all .pop() and .run() to stop
</span><span style="color:#75715e"></span>}
</code></pre></div><p>可以看到, 主要是循环<code>sharedProcessor</code>里所有的listener, 然后调用了<code>listener.run</code>和<code>listener.pop</code></p>
<h5 id="listenerrun">listener.run</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>) <span style="color:#a6e22e">run</span>() {
	<span style="color:#75715e">// this call blocks until the channel is closed.  When a panic happens during the notification
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// we will catch it, **the offending item will be skipped!**, and after a short delay (one second)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the next notification will be attempted.  This is usually better than the alternative of never
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// delivering again.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">// this gives us a few quick retries before a long pause and then a few more quick retries
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">ExponentialBackoff</span>(<span style="color:#a6e22e">retry</span>.<span style="color:#a6e22e">DefaultRetry</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">next</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">nextCh</span> {
				<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">notification</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">next</span>.(<span style="color:#66d9ef">type</span>) {
				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">updateNotification</span>:
					<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnUpdate</span>(<span style="color:#a6e22e">notification</span>.<span style="color:#a6e22e">oldObj</span>, <span style="color:#a6e22e">notification</span>.<span style="color:#a6e22e">newObj</span>)
				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">addNotification</span>:
					<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnAdd</span>(<span style="color:#a6e22e">notification</span>.<span style="color:#a6e22e">newObj</span>)
				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">deleteNotification</span>:
					<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnDelete</span>(<span style="color:#a6e22e">notification</span>.<span style="color:#a6e22e">oldObj</span>)
				<span style="color:#66d9ef">default</span>:
					<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unrecognized notification: %T&#34;</span>, <span style="color:#a6e22e">next</span>))
				}
			}
			<span style="color:#75715e">// the only way to get here is if the p.nextCh is empty and closed
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
		})

		<span style="color:#75715e">// the only way to get here is if the p.nextCh is empty and closed
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			close(<span style="color:#a6e22e">stopCh</span>)
		}
	}, <span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>, <span style="color:#a6e22e">stopCh</span>)
}
</code></pre></div><p>listener 包含了 Controller 注册进来的 Handler 方法，因此 listener 最重要的职能就是当事件发生时来触发这些方法。</p>
<p>可以看到，<code>listener.run</code> 不停的从 <code>nextCh</code> 这个 channel 中拿到事件，但是 <code>nextCh</code> 这个 channel 里的事件又是从哪来的呢？<code>listener.pop</code> 的职责便是将事件放入 <code>nextCh</code> 中。</p>
<h5 id="listenerpop">listener.pop</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>) <span style="color:#a6e22e">pop</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()
	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">nextCh</span>) <span style="color:#75715e">// Tell .run() to stop
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">nextCh</span> <span style="color:#66d9ef">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">interface</span>{}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">notification</span> <span style="color:#66d9ef">interface</span>{}
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">nextCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">notification</span>:
			<span style="color:#75715e">// Notification dispatched
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>
			<span style="color:#a6e22e">notification</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">pendingNotifications</span>.<span style="color:#a6e22e">ReadOne</span>()
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> { <span style="color:#75715e">// Nothing to pop
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">nextCh</span> = <span style="color:#66d9ef">nil</span> <span style="color:#75715e">// Disable this select case
</span><span style="color:#75715e"></span>			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">notificationToAdd</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">addCh</span>:
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">notification</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">// No notification to pop (and pendingNotifications is empty)
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// Optimize the case - skip adding to pendingNotifications
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">notification</span> = <span style="color:#a6e22e">notificationToAdd</span>
				<span style="color:#a6e22e">nextCh</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">nextCh</span>
			} <span style="color:#66d9ef">else</span> { <span style="color:#75715e">// There is already a notification waiting to be dispatched
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">pendingNotifications</span>.<span style="color:#a6e22e">WriteOne</span>(<span style="color:#a6e22e">notificationToAdd</span>)
			}
		}
	}
}
</code></pre></div><p><code>listener</code> 之所以包含了两个 channel：<code>addCh</code> 和 <code>nextCh</code>，是因为 Informer 无法预知 <code>listener.handler</code> 的事件消费的速度是否大于事件生产的速度，因此添加了一个名为 <code>pendingNotifications</code> 的缓冲队列来保存未来得及消费的事件</p>
<p><code>pop</code> 方法一方面会不停的从 <code>addCh</code> 中获得最新事件，以保证不会让生产方阻塞。然后判断是否存在 buffer，如果存在则把事件添加到 buffer 中，如果不存在则尝试推给 <code>nextCh</code>。</p>
<p>而另一方面，会判断 buffer 中是否还有事件，如果还有存量，则不停的传递给 <code>nextCh</code>。</p>
<p><code>pop</code> 方法实现了一个带 buffer 的分发机制，使得事件可以源源不断的从 <code>addCh</code> 到 <code>nextCh</code>。</p>
<h4 id="运行controller">运行controller</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">controller</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>.<span style="color:#a6e22e">Close</span>()
	}()
	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewReflector</span>(
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ListerWatcher</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ObjectType</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">FullResyncPeriod</span>,
	)
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ShouldResync</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShouldResync</span>
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">clock</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">clock</span>

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflectorMutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflector</span> = <span style="color:#a6e22e">r</span>
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflectorMutex</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Group</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()

	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">StartWithChannel</span>(<span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Run</span>)

	<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">processLoop</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
}
</code></pre></div><h5 id="初始化reflector并启动">初始化Reflector并启动</h5>
<p><code>Reflector</code>通过 sharedIndexInformer 里定义的 <code>listerWatcher</code> 进行 List-Watch，并将获得的事件推入 DeltaFIFO 中, <code>controller</code> 启动之后会先将 <code>Reflector</code> 启动。</p>
<h5 id="执行cprocessloop">执行c.processLoop</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">controller</span>) <span style="color:#a6e22e">processLoop</span>() {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>.<span style="color:#a6e22e">Pop</span>(<span style="color:#a6e22e">PopProcessFunc</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Process</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">FIFOClosedError</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">RetryOnError</span> {
				<span style="color:#75715e">// This is the safe way to re-enqueue.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>.<span style="color:#a6e22e">AddIfNotPresent</span>(<span style="color:#a6e22e">obj</span>)
			}
		}
	}
}
</code></pre></div><p>通过一个死循环，不停的将从 DeltaFIFO 读出需要处理的资源事件, 然后交给<code>c.config.Process</code>函数处理, 在前面初始化controller时, <code>c.config.Process</code>被赋值为<code>s.HandleDeltas</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">HandleDeltas</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#75715e">// from oldest to newest
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#a6e22e">Deltas</span>) {
		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">Added</span>, <span style="color:#a6e22e">Updated</span>:
			<span style="color:#a6e22e">isSync</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">Sync</span>
			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cacheMutationDetector</span>.<span style="color:#a6e22e">AddObject</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">updateNotification</span>{<span style="color:#a6e22e">oldObj</span>: <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#a6e22e">isSync</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">addNotification</span>{<span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#a6e22e">isSync</span>)
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Deleted</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
			}
			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">deleteNotification</span>{<span style="color:#a6e22e">oldObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#66d9ef">false</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>这里调用了<code>s.indexer.Add</code> <code>s.indexer.Update</code> <code>s.indexer.Delete</code>以及<code>s.processor.distribute</code>。</p>
<p><code>s.indexer.Add</code> <code>s.indexer.Update</code> <code>s.indexer.Delete</code>最后都调用了<code>queueActionLocked</code>方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeltaFIFO</span>) <span style="color:#a6e22e">queueActionLocked</span>(<span style="color:#a6e22e">actionType</span> <span style="color:#a6e22e">DeltaType</span>, <span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">KeyOf</span>(<span style="color:#a6e22e">obj</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">KeyError</span>{<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">err</span>}
	}

	<span style="color:#a6e22e">newDeltas</span> <span style="color:#f92672">:=</span> append(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>], <span style="color:#a6e22e">Delta</span>{<span style="color:#a6e22e">actionType</span>, <span style="color:#a6e22e">obj</span>})
	<span style="color:#a6e22e">newDeltas</span> = <span style="color:#a6e22e">dedupDeltas</span>(<span style="color:#a6e22e">newDeltas</span>)

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">newDeltas</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>]; !<span style="color:#a6e22e">exists</span> {
			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span> = append(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>, <span style="color:#a6e22e">id</span>)
		}
		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#a6e22e">newDeltas</span>
		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Broadcast</span>()
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#75715e">// We need to remove this from our map (extra items in the queue are
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// ignored if they are not in the map).
</span><span style="color:#75715e"></span>		delete(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">id</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>而<code>s.processor.distribute</code>是把事件分发到listener</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedProcessor</span>) <span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">sync</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RUnlock</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sync</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">syncingListeners</span> {
			<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">obj</span>)
		}
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listeners</span> {
			<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">obj</span>)
		}
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>) <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">notification</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">addCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">notification</span>
}
</code></pre></div><p>可以看到, <code>distribute</code>方法调用<code>listener.add</code>, <code>listener.add</code>会将事件发送到<code>addCh</code>。</p>
<p>至此, 整个事件流就打通了，如下图。</p>
<p><img src="informer-event-stream.png" alt="informer-event-stream"></p>
<h2 id="总结">总结</h2>
<p>Informer机制是kubernetes的核心, 了解清楚这个机制, 后续理解controller manager就容易多了, 而且也能更得心应手的编写自定义的controller。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://github.com/kubernetes/client-go">client-go 源码</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/client-go"> 
            Client-Go</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/informer"> , 
            Informer</a>
            
          </ul>
        </div>
        <!-- previous -->
        
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://cloudnative.to/blog/20200818-google-cloud-mesh/" data-toggle="tooltip" data-placement="top" title="Google Cloud 服务网格：Traffic Director 与 Anthos Service Mesh 的左右互搏">&larr; 上一篇</a>
</li>
 
<li class="next">
<a href="https://cloudnative.to/blog/client-go-informer-source-code/" data-toggle="tooltip" data-placement="top" title="深入了解 Kubernetes Informer">下一篇 &rarr;</a>
</li>

</ul>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/client-go-study/">client-go 源码学习总结</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
    <!-- categories -->
<div class="bg-pink px-4 py-5 box-shadow mb-5">
  <h4 class="mb-4">分类</h4>
  <ul class="list-unstyled">
    <li class="border-bottom"><a href="/categories/devops" class="d-block pb-3 mt-3 text-capitalize">Devops</a></li>
    <li class="border-bottom"><a href="/categories/envoy" class="d-block pb-3 mt-3 text-capitalize">Envoy</a></li>
    <li class="border-bottom"><a href="/categories/istio" class="d-block pb-3 mt-3 text-capitalize">Istio</a></li>
    <li class="border-bottom"><a href="/categories/kubernetes" class="d-block pb-3 mt-3 text-capitalize">Kubernetes</a></li>
    <li class="border-bottom"><a href="/categories/serverless" class="d-block pb-3 mt-3 text-capitalize">Serverless</a></li>
    <li class="border-bottom"><a href="/categories/service-mesh" class="d-block pb-3 mt-3 text-capitalize">Service mesh</a></li>
    <li class="border-bottom"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="d-block pb-3 mt-3 text-capitalize">云原生</a></li>
    <li class="border-bottom"><a href="/categories/%e5%85%b6%e4%bb%96" class="d-block pb-3 mt-3 text-capitalize">其他</a></li>
    <li class="border-bottom"><a href="/categories/%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">可观察性</a></li>
    <li class="border-bottom"><a href="/categories/%e5%ae%89%e5%85%a8" class="d-block pb-3 mt-3 text-capitalize">安全</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90" class="d-block pb-3 mt-3 text-capitalize">开源</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" class="d-block pb-3 mt-3 text-capitalize">开源社区</a></li>
    <li class="border-bottom"><a href="/categories/%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98" class="d-block pb-3 mt-3 text-capitalize">持续交付</a></li>
    <li class="border-bottom"><a href="/categories/%e7%a8%b3%e5%ae%9a%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">稳定性</a></li>
    <li class="border-bottom"><a href="/categories/%e8%be%b9%e7%bc%98%e8%ae%a1%e7%ae%97" class="d-block pb-3 mt-3 text-capitalize">边缘计算</a></li>
  </ul>
</div>

  <!-- tags -->
  

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <div class="mx-auto avatar-wrp">
        <img class="rounded-circle avatar-img" src="/images/profile/sundongmin.jpg">
      </div>
      <p class="avatar-name">
        <strong class="text-dark "><a href="https://github.com/sundongmin">孙东民</a></strong> 
      </p>
      <p>某教育公司研发工程师，云原生爱好者。</p>
    </div>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#informer原理图">Informer原理图</a>
      <ul>
        <li><a href="#源码的调用流程图">源码的调用流程图</a></li>
        <li><a href="#数据结构图">数据结构图</a></li>
      </ul>
    </li>
    <li><a href="#informer-工厂">Informer 工厂</a>
      <ul>
        <li><a href="#创建controllercontext">创建ControllerContext</a></li>
        <li><a href="#启动所有内置的controller">启动所有内置的Controller</a></li>
        <li><a href="#informerfactory启动">InformerFactory启动</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是国内最大的独立第三方云原生终端用户和泛开发者社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，提供云原生专业资讯，促进云原生产业发展。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fab fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fab fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://mp.weixin.qq.com/s/vWlSdzz2MNdXRr0sd2-LFg"><i class="fab fa-weixin"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="far fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://zhuanlan.zhihu.com/cloud-native"><i class="fab fa-zhihu"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://space.bilibili.com/515485124"><i class="fas fa-play-circle"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fas fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="/city/chengdu">成都</a>|<a href="/city/shenzhen">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="/city/guangzhou/">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2021 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/policy"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
