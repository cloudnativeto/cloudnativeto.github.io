<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  
  <title>Istio 安全最佳实践 | 云原生社区</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文列举了 Istio 安全的最佳实践。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/all.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/istio-security-best-practices/" />
  <meta property="og:title" content="Istio 安全最佳实践" />
  <meta property="og:description" content="本文列举了 Istio 安全的最佳实践。" />
  <meta property="og:image" content="https://cloudnative.to/images/blog/istio-security.jpg" />
</head>
<body>
<!-- header -->

<img src="images/logo-square.jpg" width="0" height="0" />
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
     <img src="" width='700'>
</div>
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog/">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/community/sig/">兴趣小组</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
                <a class="dropdown-item" href="https://istio.io/latest/zh/">Istio 中文文档</a>
                
              </div>
            </li>
            
            
          </ul>

          
          

          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">Istio 安全最佳实践</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">本文列举了 Istio 安全的最佳实践。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/istio-security.jpg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type"><a href="/categories/istio">Istio</a></div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://istio.io/latest/docs/ops/best-practices/security/">Istio 社区</a></strong>
          
          译者
          <strong class="text-dark">
          <a href="https://jimmysong.io">宋净超（Jimmy Song）</a>
          </strong>
          
            发表于 <strong class="text-dark">2021年8月2日</strong></div>
        <hr>
        <div class="content">
          <p>本文译自 Istio 官方博客 <a href="https://istio.io/latest/docs/ops/best-practices/security/">Security Best Practices</a>。</p>
<p>Istio 的安全功能提供了强大的身份、策略、透明的 TLS 加密以及认证、授权和审计（AAA）工具来保护你的服务和数据。然而，为了充分安全地利用这些功能，必须注意遵循最佳实践。建议在继续阅读之前，先回顾一下<a href="https://istio.io/latest/docs/concepts/security/">安全概述</a>。</p>
<h2 id="双向-tls">双向 TLS</h2>
<p>Istio 将尽可能使用<a href="https://istio.io/latest/docs/concepts/security/#mutual-tls-authentication">双向 TLS</a> 对流量进行<a href="https://istio.io/latest/docs/ops/configuration/traffic-management/tls-configuration/#auto-mtls">自动</a>加密。然而，代理在默认情况下被配置为<a href="https://istio.io/latest/docs/concepts/security/#permissive-mode">许可模式（Permissive Mode）</a>，这意味着他们将接受双向 TLS 和明文流量。</p>
<p>虽然这是为了增量采用或允许来自没有 Istio sidecar 的客户端的流量的需要，但它也削弱了安全立场。建议在可能的情况下<a href="https://istio.io/latest/docs/tasks/security/authentication/mtls-migration/">迁移到严格模式（Strict Mode）</a>，以强制使用双向 TLS。</p>
<p>然而，仅靠双向 TLS 并不足以保证流量的安全，因为它只提供认证，而不是授权。这意味着，任何拥有有效证书的人仍然可以访问一个服务。</p>
<p>为了完全锁定流量，建议配置<a href="https://istio.io/latest/docs/tasks/security/authorization/">授权策略</a>。这允许创建细粒度的策略来允许或拒绝流量。例如，你可以只允许来自 <code>app</code> 命名空间的请求访问 <code>hello-world</code> 服务。</p>
<h2 id="授权策略">授权策略</h2>
<p>Istio <a href="https://istio.io/latest/docs/concepts/security/#authorization">授权</a>在 Istio 安全中起着关键作用。它需要努力配置正确的授权策略，以最好地保护你的集群。了解这些配置的影响是很重要的，因为 Istio 无法确定所有用户的正确授权。请全程关注本节内容。</p>
<h3 id="应用默认拒绝的授权策略">应用默认拒绝的授权策略</h3>
<p>我们建议你按照 default-deny 模式定义你的 Istio 授权策略，以增强集群的安全态势。默认拒绝授权模式意味着你的系统默认拒绝所有请求，而你定义了允许请求的条件。如果你错过了一些条件，流量将被意外地拒绝，而不是流量被意外地允许。后者通常是一个安全事件，而前者可能会导致糟糕的用户体验、服务中断或不符合你的 SLO/SLA。</p>
<p>例如，在 <a href="https://istio.io/latest/docs/tasks/security/authorization/authz-http/">HTTP 流量的授权任</a>务中，名为 <code>allow-nothing</code> 的授权策略确保所有流量在默认情况下被拒绝。从这里开始，其他授权策略根据特定条件允许流量。</p>
<h3 id="在路径规范化上定制你的系统">在路径规范化上定制你的系统</h3>
<p>Istio 授权策略可以基于 HTTP 请求中的 URL 路径。<a href="https://en.wikipedia.org/wiki/URI_normalization">路径规范化（又称 URI 规范化）</a>对传入请求的路径进行修改和标准化，从而使规范化后的路径能够以标准方式进行处理。语法上不同的路径在路径规范化后可能是等同的。</p>
<p>Istio 支持以下请求路径的规范化方案，然后再根据授权策略进行评估和路由请求：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NONE</code></td>
<td>不做任何规范化处理。Envoy 收到的任何信息都会被原封不动地转发给任何后端服务。</td>
<td><code>../%2Fa../b</code> 由授权政策评估并发送给你的服务。</td>
</tr>
<tr>
<td><code>BASE</code></td>
<td>这是目前 Istio 默认安装中使用的选项。这在 Envoy 代理上应用了 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-normalize-path"><code>normalize_path</code></a>选项，该选项遵循 <a href="https://tools.ietf.org/html/rfc3986">RFC 3986</a>，有额外的规范化处理，将反斜线转换成正斜线。</td>
<td><code>/a/../b</code> 被规范化为 <code>/b</code>。<code>\da</code> 被规范化微 <code>/da</code>。</td>
</tr>
<tr>
<td><code>MERGE_SLASHES</code></td>
<td>斜线在 <em>BASE</em> 规范化之后被合并。</td>
<td><code>/a//b</code> 被规范化为 <code>/a/b</code>。</td>
</tr>
<tr>
<td><code>DECODE_AND_MERGE_SLASHES</code></td>
<td>最严格的设置，当你默认允许所有流量。这个设置是推荐的，但要注意的是，你需要彻底测试你的授权策略路径。百分比编码的斜线和反斜线字符（<code>%2F</code>、<code>%2f</code>、<code>%5C</code> 和 <code>%5c</code>）在 MERGE_SLASHES 被规范化之前被解码为 <code>/</code> 或 <code>\</code>。 | <code>/a%2fb</code> 被规范化为 <code>/a/b</code>。                        |</td>
<td></td>
</tr>
</tbody>
</table>
<p>该配置是通过 <a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/">mesh 配置</a>中的 <a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig-ProxyPathNormalization"><code>pathNormalization</code></a>字段指定的。</p>
<p>为了强调这一点，规范化算法是按照以下顺序进行的：</p>
<ol>
<li>百分比解码 <code>%2F</code>、<code>%2f</code>、<code>%5C</code> 和 <code>%5c</code>。</li>
<li><a href="https://tools.ietf.org/html/rfc3986">RFC 3986</a> 和其他由 Envoy 的 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-normalize-path"><code>normalize_path</code></a>选项实现的规范化。</li>
<li>合并斜线</li>
</ol>
<blockquote>
<p>虽然这些规范化选项代表了来自 HTTP 标准和常见行业惯例的建议，但应用程序可以以它选择的任何方式解释一个 URL。当使用拒绝策略时，请确保你了解你的应用程序的行为方式。</p>
</blockquote>
<h3 id="配置的例子">配置的例子</h3>
<p>确保 Envoy 规范化请求路径以符合你的后端服务的期望，对你的系统安全至关重要。下面的例子可以作为你配置系统的参考。规范化的 URL 路径，如果选择了 <code>NONE</code>，则是原始的 URL 路径将：</p>
<ol>
<li>用来对照授权策略进行检查</li>
<li>转发到后端应用程序</li>
</ol>
<table>
<thead>
<tr>
<th>你的应用程序</th>
<th>选择</th>
</tr>
</thead>
<tbody>
<tr>
<td>依靠代理进行规范化处理</td>
<td><code>BASE</code>, <code>MERGE_SLASHES</code> or <code>DECODE_AND_MERGE_SLASHES</code></td>
</tr>
<tr>
<td>根据 <a href="https://tools.ietf.org/html/rfc3986">RFC 3986</a> 规范化请求路径，不合并斜线</td>
<td><code>BASE</code></td>
</tr>
<tr>
<td>根据 <a href="https://tools.ietf.org/html/rfc3986">RFC 3986</a> 规范化请求路径，合并斜线，但不对<a href="https://tools.ietf.org/html/rfc3986#section-2.1">百分比编码</a>的斜线进行解码</td>
<td><code>MERGE_SLASHES</code></td>
</tr>
<tr>
<td>根据 <a href="https://tools.ietf.org/html/rfc3986">RFC 3986</a> 规范化请求路径，合并斜线，并对<a href="https://tools.ietf.org/html/rfc3986#section-2.1">百分比编码</a>的斜线进行解码</td>
<td><code>DECODE_AND_MERGE_SLASHES</code></td>
</tr>
<tr>
<td>处理请求路径的方式与 <a href="https://tools.ietf.org/html/rfc3986">RFC 3986</a> 不兼容</td>
<td><code>NONE</code></td>
</tr>
</tbody>
</table>
<h3 id="如何配置">如何配置</h3>
<p>你可以使用 <code>istioctl</code> 来更新 <a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/">mesh 配置</a>：</p>
<pre><code>$ istioctl upgrade --set meshConfig.pathNormalization.normalization=DECODE_AND_MERGE_SLASHES
</code></pre><p>或通过改变你的 Operator 重写文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">$ cat &lt;&lt;EOF &gt; iop.yaml
<span style="color:#66d9ef">apiVersion</span>: install.istio.io/v1alpha1
<span style="color:#66d9ef">kind</span>: IstioOperator
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">meshConfig</span>:
    <span style="color:#66d9ef">pathNormalization</span>:
      <span style="color:#66d9ef">normalization</span>: DECODE_AND_MERGE_SLASHES
EOF
$ istioctl install -f iop.yaml
</code></pre></div><p>另外，如果你想直接编辑 Mesh 配置，你可以将 <a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig-ProxyPathNormalization"><code>pathNormalization</code></a>添加到 <a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/">mesh 配置</a>中，该配置是 <code>istio-&lt;REVISION_ID&gt;</code> 的 CongfigMap，在 <code>istio-system</code> 命名空间。例如，如果你选择 <code>DECODE_AND_MERGE_SLASHES</code> 选项，你修改 mesh 配置如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
  <span style="color:#66d9ef">data</span>:
    <span style="color:#66d9ef">mesh</span>: |<span style="color:#e6db74">-
</span><span style="color:#e6db74">      ...</span>
      <span style="color:#66d9ef">pathNormalization</span>:
        <span style="color:#66d9ef">normalization</span>: DECODE_AND_MERGE_SLASHES
      ...      
</code></pre></div><h3 id="不太常见的规范化配置">不太常见的规范化配置</h3>
<h4 id="大小写规范化">大小写规范化</h4>
<p>在某些环境中，以不区分大小写的方式比较授权策略中的路径可能是有用的。例如，将 <code>https://myurl/get</code> 和 <code>https://myurl/GeT</code> 等同对待。在这些情况下，可以使用下面的 <code>EnvoyFilter</code>。这个过滤器将改变用于比较的路径和呈现给应用程序的路径。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#66d9ef">kind</span>: EnvoyFilter
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: ingress-case-insensitive
  <span style="color:#66d9ef">namespace</span>: istio-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">configPatches</span>:
  - <span style="color:#66d9ef">applyTo</span>: HTTP_FILTER
    <span style="color:#66d9ef">match</span>:
      <span style="color:#66d9ef">context</span>: GATEWAY
      <span style="color:#66d9ef">listener</span>:
        <span style="color:#66d9ef">filterChain</span>:
          <span style="color:#66d9ef">filter</span>:
            <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.filters.network.http_connection_manager&#34;</span>
            <span style="color:#66d9ef">subFilter</span>:
              <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.filters.http.router&#34;</span>
    <span style="color:#66d9ef">patch</span>:
      <span style="color:#66d9ef">operation</span>: INSERT_BEFORE
      <span style="color:#66d9ef">value</span>:
        <span style="color:#66d9ef">name</span>: envoy.lua
        <span style="color:#66d9ef">typed_config</span>:
            <span style="color:#66d9ef">&#34;@type&#34;: </span><span style="color:#e6db74">&#34;type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua&#34;</span>
            <span style="color:#66d9ef">inlineCode</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">              function envoy_on_request(request_handle)</span>
                local path = request_handle:headers():get(<span style="color:#e6db74">&#34;:path&#34;</span>)
                request_handle:headers():replace(<span style="color:#e6db74">&#34;:path&#34;</span>, string.lower(path))
              end              
</code></pre></div><h2 id="了解流量采集的限制">了解流量采集的限制</h2>
<p>Istio sidecar 的工作原理是捕获入站流量和出站流量，并通过 sidecar 代理引导它们。</p>
<p>然而，并不是所有的流量都被捕获：</p>
<ul>
<li>重定向只处理基于 TCP 的流量。任何 UDP 或 ICMP 数据包都不会被捕获或修改。</li>
<li><a href="https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio">Sidecar 使用的许多端口</a>以及 22 号端口的入站捕获被禁用。这个列表可以通过 <code>traffic.sidecar.istio.io/excludeInboundPorts</code> 等选项来扩展。</li>
<li>出站捕获同样可以通过 <code>traffic.sidecar.istio.io/excludeOutboundPorts</code> 等设置或其他方式减少。</li>
</ul>
<p>一般来说，应用程序和其 sidecar 代理之间的安全边界最小。对 sidecar 的配置是以每个模块为基础的，并且两者都在同一个网络 / 进程命名空间中运行。因此，应用程序可能有能力删除重定向规则，并删除、改变、终止或替换 sidecar 代理。这允许一个 pod 故意绕过它的 sidecar 的出站流量或故意让入站流量绕过它的 sidecar。</p>
<p>因此，依靠 Istio 无条件地捕获所有流量是不安全的。相反，安全边界是客户端不能绕过另一个 pod 的 sidecar。</p>
<p>例如，如果我在 9080 端口运行 <code>review</code> 应用程序，我可以假设来自 <code>productpage</code> 应用程序的所有流量将被 sidecar 代理捕获，其中 Istio 认证和授权策略可能适用。</p>
<h3 id="利用-networkpolicy-进行深度防御">利用 <code>NetworkPolicy</code> 进行深度防御</h3>
<p>为了进一步确保流量安全，Istio 策略可以与 Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">网络策略</a>分层。这实现了一个强大的<a href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)">深度防御</a>策略，可以用来进一步加强你的网格的安全性。</p>
<p>例如，你可以选择只允许流量到我们 <code>review</code> 应用程序的 <code>9080</code> 端口。如果集群中的 Pod 被破坏或存在安全漏洞，这可能会限制或阻止攻击者的进展。</p>
<h3 id="确保出口流量的安全">确保出口流量的安全</h3>
<p>一个常见的误解是，像 <a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/#envoy-passthrough-to-external-services"><code>outboundTrafficPolicy: REGISTRY_ONLY</code></a> 作为一个安全策略，防止所有对未申报服务的访问。然而，如上所述，这并不是一个强大的安全边界，应该被认为是尽力而为。</p>
<p>虽然这对防止意外的依赖性很有用，但如果你想保证出口流量的安全，并强制要求所有出站流量通过代理，你应该依靠 <a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway/">Egress Gateway</a>。当与<a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway/#apply-kubernetes-network-policies">网络策略</a>相结合时，你可以强制所有的流量，或一些子集，通过出口网关。这确保了即使客户意外地或恶意地绕过他们的 sidecar，该请求也会被阻止。</p>
<h2 id="当使用-tls-发起时在目的地规则中配置-tls-验证">当使用 TLS 发起时，在目的地规则中配置 TLS 验证</h2>
<p>Istio 提供了从一个 sidecar 代理或网关<a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-tls-origination/">发起 TLS</a> 的能力。这使得发送纯文本 HTTP 流量的应用程序能够透明地 “升级 “到 HTTPS。</p>
<p>在配置 <code>DestinationRule</code> 的 <code>tls</code> 设置时，必须注意指定 <code>caCertificates</code> 字段。如果没有设置，服务器的证书将不会被验证。</p>
<p>例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.istio.io/v1beta1
<span style="color:#66d9ef">kind</span>: DestinationRule
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: google-tls
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">host</span>: google.com
  <span style="color:#66d9ef">trafficPolicy</span>:
    <span style="color:#66d9ef">tls</span>:
      <span style="color:#66d9ef">mode</span>: SIMPLE
      <span style="color:#66d9ef">caCertificates</span>: /etc/ssl/certs/ca-certificates.crt
</code></pre></div><h2 id="网关">网关</h2>
<p>在运行 Istio <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/">网关</a>时，涉及一些资源：</p>
<ul>
<li><code>Gateways</code>，它控制网关的端口和 TLS 设置。</li>
<li><code>VirtualServices</code>，控制路由逻辑。这些都是通过在网关字段中的直接引用和在网关和 <code>VirtualService</code> 的 <code>hosts</code> 字段中的相互约定与 <code>Gateway</code> 相关联的。</li>
</ul>
<h3 id="限制-gateway-创建权限">限制 <code>Gateway</code> 创建权限</h3>
<p>建议将 Gateway 资源的创建限制在受信任的集群管理员。这可以通过 <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Kubernetes RBAC 策略</a>或 <a href="https://www.openpolicyagent.org/">Open Policy Agent</a> 等工具实现。</p>
<h3 id="避免过于宽泛的-hosts-配置">避免过于宽泛的 <code>hosts</code> 配置</h3>
<p>在可能的情况下，避免在 <code>Gateway</code> 中进行过于广泛的 <code>hosts</code> 设置。</p>
<p>例如，这种配置将允许任何 VirtualService 绑定到 <code>Gateway</code>，可能会暴露出意外的域：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">servers</span>:
- <span style="color:#66d9ef">port</span>:
    <span style="color:#66d9ef">number</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#66d9ef">name</span>: http
    <span style="color:#66d9ef">protocol</span>: HTTP
  <span style="color:#66d9ef">hosts</span>:
  - <span style="color:#e6db74">&#34;*&#34;</span>
</code></pre></div><p>这应该被锁定，只允许特定域或特定命名空间。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">servers</span>:
- <span style="color:#66d9ef">port</span>:
    <span style="color:#66d9ef">number</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#66d9ef">name</span>: http
    <span style="color:#66d9ef">protocol</span>: HTTP
  <span style="color:#66d9ef">hosts</span>:
  - <span style="color:#e6db74">&#34;foo.example.com&#34;</span> <span style="color:#75715e"># 只允许 foo.example.com 的 VirtualServices</span>
  - <span style="color:#e6db74">&#34;default/bar.example.com&#34;</span> <span style="color:#75715e"># 只允许 default 命名空间 bar.example.com 的 VirtualServices</span>
  - <span style="color:#e6db74">&#34;route-namespace/*&#34;</span> <span style="color:#75715e"># 只允许 route-namespace 命名空间的 VirtualServices</span>
</code></pre></div><h3 id="隔离敏感服务">隔离敏感服务</h3>
<p>可能需要对敏感服务实施更严格的物理隔离。例如，你可能想为敏感的 <code>payment.example.com</code> 运行一个<a href="https://istio.io/latest/docs/setup/install/istioctl/#configure-gateways">专用的网关实例</a>，而为不太敏感的域名如 <code>blog.example.com</code> 和 <code>store.example.com</code> 使用一个单一的共享网关实例。这可以提供一个更强大的深度防御，并有助于满足某些监管合规准则。</p>
<h3 id="在放宽的-sni-主机匹配下明确地禁用所有敏感的-http-主机">在放宽的 SNI 主机匹配下，明确地禁用所有敏感的 http 主机</h3>
<p>在不同的主机上使用多个 <code>Gateways</code> 来定义双向 TLS 和简单 TLS 是合理的。例如，对 SNI 主机 <code>admin.example.com</code> 使用双向 TLS，对 SNI 主机 <code>*.example.com</code> 使用简单 TLS。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">kind</span>: Gateway
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: guestgateway
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">istio</span>: ingressgateway
  <span style="color:#66d9ef">servers</span>:
  - <span style="color:#66d9ef">port</span>:
      <span style="color:#66d9ef">number</span>: <span style="color:#ae81ff">443</span>
      <span style="color:#66d9ef">name</span>: https
      <span style="color:#66d9ef">protocol</span>: HTTPS
    <span style="color:#66d9ef">hosts</span>:
    - <span style="color:#e6db74">&#34;*.example.com&#34;</span>
    <span style="color:#66d9ef">tls</span>:
      <span style="color:#66d9ef">mode</span>: SIMPLE
---
<span style="color:#66d9ef">kind</span>: Gateway
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: admingateway
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">istio</span>: ingressgateway
  <span style="color:#66d9ef">servers</span>:
  - <span style="color:#66d9ef">port</span>:
      <span style="color:#66d9ef">number</span>: <span style="color:#ae81ff">443</span>
      <span style="color:#66d9ef">name</span>: https
      <span style="color:#66d9ef">protocol</span>: HTTPS
    <span style="color:#66d9ef">hosts</span>:
    - admin.example.com
    <span style="color:#66d9ef">tls</span>:
      <span style="color:#66d9ef">mode</span>: MUTUAL
</code></pre></div><p>如果有必要进行上述操作，强烈建议在附加到 <code>*.example.com</code> 的 <code>VirtualService</code> 中明确禁用 http 主机 <code>admin.example.com</code>。原因是目前底层的 <a href="https://github.com/envoyproxy/envoy/issues/6767">envoy 代理不需要</a> http 1 头 <code>Host</code> 或 http 2 伪头<code>:authority</code> 的 SNI 约束后，攻击者可以重新使用 guest-SNI TLS 连接来访问 admin <code>VirtualService</code>。http 响应代码 421 是为这种 <code>Host</code> SNI 不匹配而设计的，可以用来实现禁用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#66d9ef">kind</span>: VirtualService
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: disable-sensitive
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">hosts</span>:
  - <span style="color:#e6db74">&#34;admin.example.com&#34;</span>
  <span style="color:#66d9ef">gateways</span>:
  - guestgateway
  <span style="color:#66d9ef">http</span>:
  - <span style="color:#66d9ef">match</span>:
    - <span style="color:#66d9ef">uri</span>:
        <span style="color:#66d9ef">prefix</span>: /
    <span style="color:#66d9ef">fault</span>:
      <span style="color:#66d9ef">abort</span>:
        <span style="color:#66d9ef">percentage</span>:
          <span style="color:#66d9ef">value</span>: <span style="color:#ae81ff">100</span>
        <span style="color:#66d9ef">httpStatus</span>: <span style="color:#ae81ff">421</span>
    <span style="color:#66d9ef">route</span>:
    - <span style="color:#66d9ef">destination</span>:
        <span style="color:#66d9ef">port</span>:
          <span style="color:#66d9ef">number</span>: <span style="color:#ae81ff">8000</span>
        <span style="color:#66d9ef">host</span>: dest.default.cluster.local
</code></pre></div><h2 id="协议检测">协议检测</h2>
<p>Istio 会<a href="https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/#automatic-protocol-selection">自动确定</a>它所看到的流量的<a href="https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/#automatic-protocol-selection">协议</a>。为了避免意外或故意的漏检，可能会导致意外的流量行为，建议在可能的情况下<a href="https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/#explicit-protocol-selection">明确声明协议</a>。</p>
<h2 id="cni">CNI</h2>
<p>为了透明地捕获所有流量，Istio 依赖于 <code>istio-init</code> <code>initContainer</code> 所配置的 <code>iptables</code> 规则。这增加了一个<a href="https://istio.io/latest/docs/ops/deployment/requirements/">要求</a>，即 <code>NET_ADMIN</code> 和 <code>NET_RAW</code><a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container">的能力</a>必须对 pod 可用。</p>
<p>为了减少授予 pod 的权限，Istio 提供了一个 <a href="https://istio.io/latest/docs/setup/additional-setup/cni/">CNI 插件</a>，它消除了这个要求。</p>
<p>Istio CNI 插件目前是一个 alpha 功能。</p>
<h2 id="使用加固的-docker-镜像">使用加固的 docker 镜像</h2>
<p>Istio 的默认 docker 镜像，包括那些由控制平面、网关和 sidecar 代理运行的镜像，都是基于 ubuntu 的。这提供了各种工具，如 bash 和 curl，这以方便为代价，增加了攻击面。</p>
<p>Istio 还提供了一个基于<a href="https://istio.io/latest/docs/ops/configuration/security/harden-docker-images/">无发行版镜像的</a>小型镜像，减少了镜像中的依赖性。</p>
<p>无发行版的镜像目前是一个 alpha 功能。</p>
<h2 id="发布和安全策略">发布和安全策略</h2>
<p>为了确保你的集群有最新的已知漏洞的安全补丁，重要的是保持在 Istio 的最新补丁版本上，并确保你在一个<a href="https://istio.io/latest/docs/releases/supported-releases">支持的版本</a>上，仍在接收安全补丁。</p>
<h2 id="检测无效配置">检测无效配置</h2>
<p>虽然 Istio 在创建资源时提供了验证，但这些检查不能抓住所有阻止配置在网格中分布的问题。这可能导致应用的策略被意外地忽略，从而导致意外的结果。</p>
<ul>
<li>在应用配置之前或之后运行 <code>istioctl analyze</code>，以确保配置有效。</li>
<li>监控控制平面的拒绝配置。除了日志之外，这些都是通过 <code>pilot_total_xds_rejects</code> 指标来显示的。</li>
<li>测试你的配置，以确保它给出预期的结果。对于安全策略来说，运行正面和负面的测试是有用的，以确保你不会意外地限制过多或过少的流量。</li>
</ul>
<h2 id="避免-alpha-和实验性功能">避免 alpha 和实验性功能</h2>
<p>所有 Istio 功能和 API 都被分配了一个<a href="https://istio.io/latest/docs/releases/feature-stages/">功能状态</a>，定义了它的稳定性、废止政策和安全政策。</p>
<p>由于 alpha 和实验性功能没有那么强的安全保证，建议尽可能避免使用它们。在这些功能中发现的安全问题可能不会被立即修复，或者不遵循我们的标准<a href="https://istio.io/latest/docs/releases/security-vulnerabilities/">安全漏洞</a>程序。</p>
<p>要确定在你的集群中使用的功能状态，请查阅 <a href="https://istio.io/latest/docs/releases/feature-stages/#istio-features">Istio 功能</a>列表。</p>
<h2 id="锁定端口">锁定端口</h2>
<p>Istio 配置了<a href="https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio">各种</a>可能被锁定的<a href="https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio">端口</a>，以提高安全性。</p>
<h3 id="控制平面">控制平面</h3>
<p>Istiod 为方便起见，默认暴露了几个未经认证的明文端口。如果需要，这些端口可以被关闭。</p>
<ul>
<li><code>8080</code> 端口暴露了调试接口，它提供了对集群状态的各种细节的读取权限。这可以通过在 Istiod 上设置环境变量 <code>ENABLE_DEBUG_ON_HTTP=false</code> 来禁用。警告：许多 <code>istioctl</code> 命令都依赖于这个接口，如果它被禁用，将无法运行。</li>
<li><code>15010</code> 端口通过明文暴露 XDS 服务。这可以通过在 Istiod 部署中添加 <code>--grpcAddr=&quot;&quot;</code> 标志来禁用。注意：高度敏感的服务，如证书签署和分发服务，绝不通过明文提供。</li>
</ul>
<h3 id="数据平面">数据平面</h3>
<p>该代理暴露了各种端口。对外暴露的是 <code>15090</code> 端口（遥测）和 <code>15021</code> 端口（健康检查）。端口 <code>15020</code> 和 <code>15000</code> 提供调试端点。这些端口只在本地主机上暴露。因此，运行在与代理相同的 pod 中的应用程序可以访问；在 sidecar 和应用程序之间没有信任边界。</p>
<h2 id="配置第三方服务账户令牌">配置第三方服务账户令牌</h2>
<p>为了与 Istio 控制平面进行认证，Istio 代理将使用服务账户令牌。Kubernetes 支持这种令牌的两种形式：</p>
<ul>
<li>第三方令牌，有一个范围内的受众和到期时间。</li>
<li>第一方令牌，没有过期，并被安装到所有的 Pod 中。</li>
</ul>
<p>由于第一方令牌的属性不太安全，Istio 将默认使用第三方令牌。然而，这个功能并不是在所有的 Kubernetes 平台上都启用的。</p>
<p>如果你使用 <code>istioctl</code> 来安装，将会自动检测到支持。这也可以手动完成，通过传递 <code>--set values.global.jwtPolicy=third-party-jwt</code> 或 -<code>-set values.global.jwtPolicy=first-party-jwt</code> 进行配置。</p>
<p>要确定你的集群是否支持第三方令牌，寻找 <code>TokenRequest</code> API。如果这没有返回响应，那么该功能就不被支持。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl get --raw /api/v1 | jq <span style="color:#e6db74">&#39;.resources[] | select(.name | index(&#34;serviceaccounts/token&#34;))&#39;</span>

<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;serviceaccounts/token&#34;</span>,
    <span style="color:#e6db74">&#34;singularName&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
    <span style="color:#e6db74">&#34;namespaced&#34;</span>: true,
    <span style="color:#e6db74">&#34;group&#34;</span>: <span style="color:#e6db74">&#34;authentication.k8s.io&#34;</span>,
    <span style="color:#e6db74">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>,
    <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;TokenRequest&#34;</span>,
    <span style="color:#e6db74">&#34;verbs&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#e6db74">&#34;create&#34;</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>虽然现在大多数云提供商都支持这一功能，但在 Kubernetes 1.20 之前，许多本地开发工具和自定义安装可能不支持。要启用该功能，请参考 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection">Kubernetes 文档</a>。</p>
<h2 id="配置下游连接的限制">配置下游连接的限制</h2>
<p>默认情况下，Istio（和 Envoy）对下游连接的数量没有限制。这可能被恶意行为者利用（见<a href="https://istio.io/latest/news/security/istio-security-2020-007/">安全公告 2020-007</a>）。为了解决这个问题，你必须为你的环境配置一个适当的连接限制。</p>
<ol>
<li>
<p>通过下载 <a href="https://istio.io/latest/news/security/istio-security-2020-007/custom-bootstrap-runtime.yaml">custom-bootstrap-runtime.yaml </a>创建一个 ConfigMap。根据你的部署中各个网关实例所需的并发连接数，更新 ConfigMap 中的 <code>global_downstream_max_connections</code>。一旦达到限制，Envoy 将开始拒绝 tcp 连接。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl -n istio-system apply -f custom-bootstrap-runtime.yaml
</code></pre></div></li>
<li>
<p>入口网关部署打补丁，以使用上述配置。下载 <a href="https://istio.io/latest/news/security/istio-security-2020-007/gateway-patch.yaml">gateway-patch.yaml</a> 并使用以下命令应用它。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl --namespace istio-system patch deployment istio-ingressgateway --patch <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat gateway-patch.yaml<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</code></pre></div></li>
<li>
<p>确认新的限制已经到位。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ISTIO_INGRESS_PODNAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pods -l app<span style="color:#f92672">=</span>istio-ingressgateway -n istio-system  -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#66d9ef">)</span>
$ kubectl --namespace istio-system exec -i -t  <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ISTIO_INGRESS_PODNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -c istio-proxy -- curl -sS http://localhost:15000/runtime
   
<span style="color:#f92672">{</span>
 <span style="color:#e6db74">&#34;entries&#34;</span>: <span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;overload.global_downstream_max_connections&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;layer_values&#34;</span>: <span style="color:#f92672">[</span>
      <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#e6db74">&#34;250000&#34;</span>,
      <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;final_value&#34;</span>: <span style="color:#e6db74">&#34;250000&#34;</span>
  <span style="color:#f92672">}</span>
 <span style="color:#f92672">}</span>,
 <span style="color:#e6db74">&#34;layers&#34;</span>: <span style="color:#f92672">[</span>
  <span style="color:#e6db74">&#34;static_layer_0&#34;</span>,
  <span style="color:#e6db74">&#34;admin&#34;</span>
 <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ol>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/istio"> 
            Istio</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/security"> , 
            Security</a>
            
          </ul>
        </div>
        <!-- previous -->
        
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://cloudnative.to/blog/devsecops/" data-toggle="tooltip" data-placement="top" title="DevSecOps——在多云环境中确保供应链安全的关键">&larr; 上一篇</a>
</li>
 
<li class="next">
<a href="https://cloudnative.to/blog/image-trusted-repository-with-open-policy-agent/" data-toggle="tooltip" data-placement="top" title="使用 Open Policy Agent 实现可信镜像仓库检查">下一篇 &rarr;</a>
</li>

</ul>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/devsecops/">DevSecOps——在多云环境中确保供应链安全的关键</a></li>
  
    <li><a href="/blog/istio-1-10-release/">Istio 1.10 版本发布并改版官网</a></li>
  
    <li><a href="/blog/k8s-1.18-container-start-sequence-control/">Kubernetes 上如何控制容器的启动顺序？</a></li>
  
    <li><a href="/blog/using-traefik-ingress-controller-with-istio-service-mesh/">在 Istio 服务网格中使用 Traefik Ingress Controller</a></li>
  
    <li><a href="/blog/istiocon-layer7-traffic/">使用 Aeraki 在 Isito 中支持 Dubbo、Thrift、Redis，以及任何七层协议</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
    <!-- categories -->
<div class="bg-pink px-4 py-5 box-shadow mb-5">
  <h4 class="mb-4">分类</h4>
  <ul class="list-unstyled">
    <li class="border-bottom"><a href="/categories/cloud-native-storage" class="d-block pb-3 mt-3 text-capitalize">Cloud native storage</a></li>
    <li class="border-bottom"><a href="/categories/devops" class="d-block pb-3 mt-3 text-capitalize">Devops</a></li>
    <li class="border-bottom"><a href="/categories/envoy" class="d-block pb-3 mt-3 text-capitalize">Envoy</a></li>
    <li class="border-bottom"><a href="/categories/istio" class="d-block pb-3 mt-3 text-capitalize">Istio</a></li>
    <li class="border-bottom"><a href="/categories/kubernetes" class="d-block pb-3 mt-3 text-capitalize">Kubernetes</a></li>
    <li class="border-bottom"><a href="/categories/serverless" class="d-block pb-3 mt-3 text-capitalize">Serverless</a></li>
    <li class="border-bottom"><a href="/categories/service-mesh" class="d-block pb-3 mt-3 text-capitalize">Service mesh</a></li>
    <li class="border-bottom"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="d-block pb-3 mt-3 text-capitalize">云原生</a></li>
    <li class="border-bottom"><a href="/categories/%e5%85%b6%e4%bb%96" class="d-block pb-3 mt-3 text-capitalize">其他</a></li>
    <li class="border-bottom"><a href="/categories/%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">可观察性</a></li>
    <li class="border-bottom"><a href="/categories/%e5%ae%89%e5%85%a8" class="d-block pb-3 mt-3 text-capitalize">安全</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90" class="d-block pb-3 mt-3 text-capitalize">开源</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" class="d-block pb-3 mt-3 text-capitalize">开源社区</a></li>
    <li class="border-bottom"><a href="/categories/%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98" class="d-block pb-3 mt-3 text-capitalize">持续交付</a></li>
    <li class="border-bottom"><a href="/categories/%e7%a8%b3%e5%ae%9a%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">稳定性</a></li>
    <li class="border-bottom"><a href="/categories/%e8%be%b9%e7%bc%98%e8%ae%a1%e7%ae%97" class="d-block pb-3 mt-3 text-capitalize">边缘计算</a></li>
  </ul>
</div>

  <!-- tags -->
  

  <!-- profile -->
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#双向-tls">双向 TLS</a></li>
    <li><a href="#授权策略">授权策略</a>
      <ul>
        <li><a href="#应用默认拒绝的授权策略">应用默认拒绝的授权策略</a></li>
        <li><a href="#在路径规范化上定制你的系统">在路径规范化上定制你的系统</a></li>
        <li><a href="#配置的例子">配置的例子</a></li>
        <li><a href="#如何配置">如何配置</a></li>
        <li><a href="#不太常见的规范化配置">不太常见的规范化配置</a></li>
      </ul>
    </li>
    <li><a href="#了解流量采集的限制">了解流量采集的限制</a>
      <ul>
        <li><a href="#利用-networkpolicy-进行深度防御">利用 <code>NetworkPolicy</code> 进行深度防御</a></li>
        <li><a href="#确保出口流量的安全">确保出口流量的安全</a></li>
      </ul>
    </li>
    <li><a href="#当使用-tls-发起时在目的地规则中配置-tls-验证">当使用 TLS 发起时，在目的地规则中配置 TLS 验证</a></li>
    <li><a href="#网关">网关</a>
      <ul>
        <li><a href="#限制-gateway-创建权限">限制 <code>Gateway</code> 创建权限</a></li>
        <li><a href="#避免过于宽泛的-hosts-配置">避免过于宽泛的 <code>hosts</code> 配置</a></li>
        <li><a href="#隔离敏感服务">隔离敏感服务</a></li>
        <li><a href="#在放宽的-sni-主机匹配下明确地禁用所有敏感的-http-主机">在放宽的 SNI 主机匹配下，明确地禁用所有敏感的 http 主机</a></li>
      </ul>
    </li>
    <li><a href="#协议检测">协议检测</a></li>
    <li><a href="#cni">CNI</a></li>
    <li><a href="#使用加固的-docker-镜像">使用加固的 docker 镜像</a></li>
    <li><a href="#发布和安全策略">发布和安全策略</a></li>
    <li><a href="#检测无效配置">检测无效配置</a></li>
    <li><a href="#避免-alpha-和实验性功能">避免 alpha 和实验性功能</a></li>
    <li><a href="#锁定端口">锁定端口</a>
      <ul>
        <li><a href="#控制平面">控制平面</a></li>
        <li><a href="#数据平面">数据平面</a></li>
      </ul>
    </li>
    <li><a href="#配置第三方服务账户令牌">配置第三方服务账户令牌</a></li>
    <li><a href="#配置下游连接的限制">配置下游连接的限制</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是国内最大的独立第三方云原生终端用户和泛开发者社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，提供云原生专业资讯，促进云原生产业发展。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fab fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fab fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://mp.weixin.qq.com/s/vWlSdzz2MNdXRr0sd2-LFg"><i class="fab fa-weixin"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="far fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://zhuanlan.zhihu.com/cloud-native"><i class="fab fa-zhihu"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://space.bilibili.com/515485124"><i class="fas fa-play-circle"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fas fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="/city/chengdu">成都</a>|<a href="/city/shenzhen">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="/city/guangzhou/">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.jpg" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2022 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/policy"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
