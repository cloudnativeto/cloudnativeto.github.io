<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>Istio Pilot 源码分析（一） | 云原生社区</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="基于 Istio 1.7 源码深入分析 Istio 流量管理、安全通信等方面的流程及原理，带你揭开 Istio 的神秘面纱。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/community">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                学院
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/sig-k8s-source-code">Kubernetes 源码研习社</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/sig-istio">Istio 特别兴趣小组</a>
                
                <a class="dropdown-item" href="/sig-envoy">Envoy 特别兴趣小组</a>
                
                <a class="dropdown-item" href="/sig-dapr">Dapr 特别兴趣小组</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                博客
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/categories/kubernetes">Kubernetes</a>
                
                <a class="dropdown-item" href="/categories/service-mesh">Service Mesh</a>
                
                <a class="dropdown-item" href="/categories/envoy">Envoy</a>
                
                <a class="dropdown-item" href="/categories/oam">OAM</a>
                
                <a class="dropdown-item" href="/categories/%E5%BC%80%E6%BA%90%E7%A4%BE%E5%8C%BA">开源社区</a>
                
                <a class="dropdown-item" href="/blog">所有</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 文档</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/academy">云原生学院直播分享</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                关于
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/about">介绍</a>
                
                <a class="dropdown-item" href="/contact">联系</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">Istio Pilot 源码分析（一）</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">基于 Istio 1.7 源码深入分析 Istio 流量管理、安全通信等方面的流程及原理，带你揭开 Istio 的神秘面纱。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/istio-pilot-banner.jpeg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">Istio</div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="http://haidong.dev/">张海东</a></strong>
          
            发表于 <strong class="text-dark">2020年9月8日</strong></div>
        <hr>
        <div class="content">
          <p><code>Istio</code> 作为目前 Service Mesh 方案中的翘楚，吸引着越来越多的企业及开发者。越来越多的团队想将其应用于微服务的治理，但在实际落地时却因为不了解 <code>Istio</code> 黑盒中的运行机制而左右为难，本文将基于 1.7 的源码讲解 <code>Istio</code> 的核心组件 <code>Pilot</code> 的结构及运行流程，希望对读者应用 <code>Istio</code> 有所助益。</p>
<p><em>注：本文基于 <code>istio release-1.7</code> 分支分析，其他版本的代码结构会有所不同。</em></p>
<h2 id="背景">背景</h2>
<p>随着 <code>Istio</code> 1.7 的发布，内部组件精简后的 <code>istiod</code> 日趋稳定，越来越多的公司将其应用到自身微服务的流量治理、安全通信及监测中。多点也不例外，应用 <code>Istio</code> 来落地业务系统所有 <code>Dubbo</code> 服务的网格化，下沉 <code>SDK</code> 逻辑，解决基础中间件与业务系统过于耦合等痛点。 目前，我们是通过自己开发的 <code>Controller</code> 组件对接 <code>Zookeeper</code> 等注册中心，将注册到 <code>Zookeeper</code> 的节点实时转化为 <code>ServiceEntry</code> 及 <code>WorkloadEntry</code> 等 <code>Istio</code> 配置类型写入 <code>kube-apiserver</code>，再由 <code>Pilot</code> 转化为 <code>xDS</code> 协议下发至数据面，同时对集群、虚拟机中的服务进行治理。随着公司服务网格化的逐步落地，对 <code>Istio</code> 及数据面组件源码级掌握的诉求越来越高，没有足够的深度及广度很难解决开发过程中遇到的难题，让我们一起揭开 <code>Istio</code> 神秘的面纱，看看黑箱内部是如何运作的。</p>
<p>本文作为 <code>Istio</code> 控制面组件 <code>Pilot</code> 的源码分析系列，主要面向刚接触 <code>Istio</code> 或仅停留在使用 <code>Istio</code> 基本配置类型（如 <code>VirtualService</code>、<code>DestinationRule</code> 等）的同学，需要熟悉 <code>Istio</code> 的一些 <a href="https://istio.io/latest/zh/docs/concepts/traffic-management/">基础概念及名词</a> 。文章会涉及较多的代码细节，我们会以不同的篇幅分别介绍以下内容：</p>
<ol>
<li><code>pilot-discovery</code> 宏观架构及启动流程梳理</li>
<li><code>pilot-discovery</code> 接口设计及关键接口分析</li>
<li><code>pilot-discovery xDS</code> 生成及下发流程梳理</li>
<li><code>pilot-agent</code> 流程梳理</li>
<li><code>pilot</code> 中的身份认证及安全通信解析</li>
</ol>
<p>相信通过源码一步一步分析，能消除读者对 <code>Pilot</code> 的陌生感，在基于 <code>Pilot</code> 做适配开发时会更加清楚的了解其底层运行逻辑，碰到问题时也能更好的定位。</p>
<p><code>Pilot</code> 的代码主要分为两部分:</p>
<ul>
<li><code>pilot-discovery</code></li>
<li><code>pilot-agent</code></li>
</ul>
<p>其中 <code>pilot-agent</code> 负责数据面 <code>Sidecar</code> 实例的生命周期管理，而 <code>pilot-discovery</code> 负责控制面流量管理配置及路由规则的生成和下发。</p>
<h2 id="宏观架构">宏观架构</h2>
<p><code>pilot-discovery</code> 的核心组件如图：
<img src="./images/pilot-discovery-struct.png" alt="pilot-discovery-struct"></p>
<p>其中 <code>Server</code> 为 <code>pilot-discovery</code> 的主服务，包含了三个比较重要的组件：</p>
<ul>
<li><code>Config Controller</code>：从不同来源接收流量控制和路由规则等 <code>Istio</code> 的配置，并响应各类事件。</li>
<li><code>Service Controller</code>：从不同注册中心同步服务及实例，并响应各类事件。</li>
<li><code>EnvoyXdsServer</code>：核心的 <code>xDS</code> 协议推送服务，根据上面组件的数据生成 <code>xDS</code> 协议并下发。</li>
</ul>
<p><code>Config Controller</code> 比较核心的就是对接 <code>Kubernetes</code>，从 <code>kube-apiserver</code> 中 <code>Watch</code> 集群中的 <code>VirtualService</code>、<code>ServiceEntry</code>、<code>DestinationRules</code> 等配置信息，有变化则生成 <code>PushRequest</code> 推送至 <code>EnvoyXdsServer</code> 中的推送队列。除此之外，还支持对接 <code>MCP(Mesh Configuration Protocol)</code> 协议的 <code>gRPC Server</code>，如 <code>Nacos</code> 的 <code>MCP</code> 服务等，只需要在 <code>meshconfig</code> 中配置 <code>configSources</code> 即可。最后一种是基于内存的 <code>Config Controller</code> 实现，通过 <code>Watch</code> 一个文件目录，加载目录中的 <code>yaml</code> 文件生成配置数据，主要用来测试。</p>
<p><code>Service Controller</code> 目前原生支持 <code>Kubernetes</code> 和 <code>Consul</code>，注册在这些注册中心中的服务可以无痛接入 <code>Mesh</code>，另外一种比较特殊，就是 <code>ServiceEntryStore</code>，它本质是储存在 <code>Config Controller</code> 中的 <code>Istio</code> 配置数据，但它描述的却是集群外部的服务信息，详情可阅读文档 <a href="https://istio.io/latest/docs/reference/config/networking/service-entry/">ServiceEntry</a>，<code>Istio</code> 通过它将集群外部，如部署在虚拟机中的服务、非 <code>Kubernetes</code> 的原生服务同步到 <code>Istio</code> 中，纳入网格统一进行流量控制和路由，所以 <code>ServiceEntryStore</code> 也可以视为一种注册中心。还有一种就是 <code>Mock Service Registry</code>，主要用来测试。</p>
<p><code>ServiceEntryStore</code> 从 <code>Config Controller</code> 到 <code>Service Controller</code> 的转化流程大致如图（后续会做详细的代码分析，这里简单了解一下即可）：</p>
<p><img src="./images/pilot-discovery-serviceentrystore.png" alt="pilot-discovery-serviceentrystore"></p>
<p><code>ConfigStores</code> 是一个列表，里面存储了各类 <code>Istio</code> 配置文件，包括 <code>ServiceEntry</code> 、<code>WorkloadEntry</code> 等服务数据，也包括 <code>VirtualService</code>、<code>DestinationRules</code>、<code>Sidecar</code> 等流量控制、路由规则的配置数据，<code>pilot-discovery</code> 将这些 <code>ConfigStores</code> 聚合成一个 <code>configController</code> 统一进行管理，之后再从其中衍生出 <code>IstioConfigStore</code>，将其作为 <code>serviceEntryStore</code> 的配置源。<code>serviceEntryStore</code> 其实就是 <code>ServiceEntry Controller</code>，响应 <code>ServiceEntry</code> 和 <code>WorkloadEntry</code> 这类服务信息的变化。</p>
<p><code>EnvoyXdsServer</code> 比较核心，一切与 <code>xDS</code> 协议相关的接收、转换、下发操作都由它完成。<code>EnvoyXdsServer</code> 对接所有集群中的边车代理，如 <code>Envoy</code>、<code>MOSN</code> 等，当配置或服务发生变化时主动推送，也会响应代理发送的请求，依据请求的信息下发相应的 <code>xDS</code> 配置。</p>
<p>理解了这三个核心组件的定义，就能比较好的理解下面分析的各类流程了。</p>
<p><code>pilot-discovery</code> 的整个业务流程梳理如下，可以先大概浏览一遍，之后我们逐一进行分析:
<img src="./images/pilot-discovery-sequence-all.png" alt="pilot-discovery-sequence-all"></p>
<h2 id="启动流程梳理">启动流程梳理</h2>
<p>首先详细看一下 <code>pilot-discovery</code> 的启动流程。<code>pilot-discovery</code> 组件的入口代码在 <code>istio/pilot/cmd/pilot-discovery</code> 中。该目录中包含两个文件: <code>main.go</code> 和 <code>request.go</code>。<code>main.go</code> 中定义了 <code>pilot-discovery</code> 根命令及 <code>discovery</code> 命令，是启动服务发现及配置下发的主流程; 另一个文件 <code>request.go</code> 中定义了 <code>request</code> 命令，用来请求 <code>Pilot</code> 中的 <code>metrics/debug</code> 接口，多用来调试。</p>
<p><code>main.go</code> 中 <code>discoveryCmd</code>的 <code>RunE</code> 函数定义了启动过程，代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 创建一个接收空结构的 stop channel 用来停止所有 servers
</span><span style="color:#75715e"></span><span style="color:#a6e22e">stop</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})

<span style="color:#75715e">// 创建服务发现的 Server
</span><span style="color:#75715e"></span><span style="color:#a6e22e">discoveryServer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bootstrap</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">serverArgs</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create discovery service: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
}

<span style="color:#75715e">// 运行 Server 中注册的所有服务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">discoveryServer</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stop</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to start discovery service: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
}

<span style="color:#75715e">// 等待 SIGINT 和 SIGTERM 信号并关闭 stop channel
</span><span style="color:#75715e"></span><span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">WaitSignal</span>(<span style="color:#a6e22e">stop</span>)
</code></pre></div><p>启动流程如图所示：
<img src="./images/pilot-discovery-sequence-init.png" alt="pilot-discovery-init"></p>
<h3 id="初始化流程">初始化流程</h3>
<p>接下来介绍 <code>discoveryServer</code> ，即 <code>pilot-discovery</code> 组件的核心。在这之前先看下 <code>Server</code> 的结构，代码位于 <code>istio/pilot/pkg/bootstrap/server.go</code> 文件中。</p>
<p><code>Server</code> 的关键字段如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">XDSServer</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">xds</span>.<span style="color:#a6e22e">DiscoveryServer</span>  <span style="color:#75715e">// Xds 服务
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">environment</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Environment</span>  <span style="color:#75715e">// Pilot 环境所需的 API 集合
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">kubeRegistry</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubecontroller</span>.<span style="color:#a6e22e">Controller</span>   <span style="color:#75715e">// 处理 Kubernetes 主集群的注册中心
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">multicluster</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubecontroller</span>.<span style="color:#a6e22e">Multicluster</span> <span style="color:#75715e">// 处理 Kubernetes 多个集群的注册中心
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">configController</span>  <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigStoreCache</span>  <span style="color:#75715e">// 统一处理配置数据（如 VirtualService 等) 的 Controller
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ConfigStores</span>      []<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigStoreCache</span> <span style="color:#75715e">// 不同配置信息的缓存器，提供 Get、List、Create 等方法
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">serviceEntryStore</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">serviceentry</span>.<span style="color:#a6e22e">ServiceEntryStore</span> <span style="color:#75715e">// 单独处理 ServiceEntry 的 Controller
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fileWatcher</span> <span style="color:#a6e22e">filewatcher</span>.<span style="color:#a6e22e">FileWatcher</span> <span style="color:#75715e">// 文件监听器，主要 watch meshconfig 和 networks 配置文件等
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">startFuncs</span> []<span style="color:#a6e22e">startFunc</span> <span style="color:#75715e">// 保存了上述所有服务的启动函数，便于在 Start() 方法中批量启动及管理
</span><span style="color:#75715e"></span>}
</code></pre></div><p>再看 <code>NewServer()</code> 方法中的内容，有以下几个关键步骤：</p>
<p><img src="https://i.loli.net/2020/09/03/P5eOiE2NwjMxLty.png" alt="image.png"></p>
<p>我们对每个步骤逐一进行分析:</p>
<ol>
<li>
<p>初始化 <code>Environment</code></p>
<p>什么是 <code>Environment</code> 呢？根据定义 <code>Environment</code> 为 <code>Pilot</code> 提供了一个汇总的、运行中所需的 API 集合。 <code>Environment</code> 中字段（接口）如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Environment</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ServiceDiscovery</span>  <span style="color:#75715e">// 服务发现的接口模型，主要列出 services 和 instances
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">IstioConfigStore</span>  <span style="color:#75715e">// Istio 配置文件的存储器，主要列出 ServiceEntry 等配置
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">mesh</span>.<span style="color:#a6e22e">Watcher</span>      <span style="color:#75715e">// mesh config 文件的监听器
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">mesh</span>.<span style="color:#a6e22e">NetworksWatcher</span> <span style="color:#75715e">// mesh network config 文件的监听器
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">PushContext</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PushContext</span> <span style="color:#75715e">// 在推送（下发 xDS）生成期间保存信息的上下文
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">DomainSuffix</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// istio server 默认的后缀域名
</span><span style="color:#75715e"></span>}
</code></pre></div><p>其中 <code>PushContext</code> 是 <code>Pilot</code> 在推送 <code>xDS</code> 前，生成配置期间保存相关信息的上下文的地方，在全量推送配置和配置发生改变时重置。它会保存所有的错误和统计信息，并缓存一些配置的计算信息。 <code>ServiceDiscovery</code> 提供了枚举 <code>Istio</code> 中服务和实例的方法。 <code>mesh.Watcher</code> 和 <code>mesh.NetworksWatcher</code> 负责监听 <code>istiod</code> 启动时挂载的两个配置文件，这两个配置文件是通过 <code>configmap</code> 映射到 <code>Pod</code> 的文件系统中的，监听器将在监听到配置文件变化时运行预先注册的 <code>Handler</code> 。文件挂载参考 <code>istiod</code> 的配置文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Pod
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: istiod-56c488887d-z9k5c
  <span style="color:#66d9ef">namespace</span>: istio-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">containers</span>:
    <span style="color:#66d9ef">volumeMounts</span>:
    - <span style="color:#66d9ef">mountPath</span>: /etc/istio/config
      <span style="color:#66d9ef">name</span>: config-volume
  <span style="color:#66d9ef">volumes</span>:
  - <span style="color:#66d9ef">configMap</span>:
      <span style="color:#66d9ef">defaultMode</span>: <span style="color:#ae81ff">420</span>
      <span style="color:#66d9ef">name</span>: istio
    <span style="color:#66d9ef">name</span>: config-volume
</code></pre></div><p>相应的配置存储在 <code>istio-system/istio</code> 这个 <code>configmap</code> 中，里面保存了 <code>mesh</code> 和 <code>meshNetworks</code> 两种配置，样例如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: istio
  <span style="color:#66d9ef">namespace</span>: istio-system
<span style="color:#66d9ef">data</span>:
  <span style="color:#66d9ef">mesh</span>: |<span style="color:#e6db74">-
</span><span style="color:#e6db74">    accessLogEncoding: TEXT</span>
    <span style="color:#66d9ef">accessLogFile</span>: <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">accessLogFormat</span>: <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">defaultConfig</span>:
      <span style="color:#66d9ef">binaryPath</span>: /usr/local/bin/mosn
      <span style="color:#66d9ef">concurrency</span>: <span style="color:#ae81ff">2</span>
      <span style="color:#66d9ef">configPath</span>: ./etc/istio/proxy
    ...
  <span style="color:#66d9ef">meshNetworks: &#39;networks</span>: {}&#39;
</code></pre></div><p>再回头看 <code>Environment</code> 的初始化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Environment</span>{
  <span style="color:#a6e22e">PushContext</span>:  <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">NewPushContext</span>(),
  <span style="color:#a6e22e">DomainSuffix</span>: <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">RegistryOptions</span>.<span style="color:#a6e22e">KubeOptions</span>.<span style="color:#a6e22e">DomainSuffix</span>,
}
<span style="color:#a6e22e">ac</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aggregate</span>.<span style="color:#a6e22e">NewController</span>(<span style="color:#a6e22e">aggregate</span>.<span style="color:#a6e22e">Options</span>{
  <span style="color:#a6e22e">MeshHolder</span>: <span style="color:#a6e22e">e</span>,
})
<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ServiceDiscovery</span> = <span style="color:#a6e22e">ac</span>
</code></pre></div><p>首先是初始化了一份 <code>PushContext</code> ，创建 <code>PushContext</code> 所需的各种列表和 <code>Map</code> 。 其次是初始化了一个聚合所有注册中心的 <code>Controller</code> 作为 <code>Environment</code> 中的 <code>ServiceDiscovery</code> 。 该 <code>Controller</code> 提供从所有注册中心（如 <code>Kubernetes, Consul, MCP</code> 等）获取服务和实例列表的方法。 这里传入了一个参数 <code>MeshHolder</code> 是想利用 <code>Environment</code> 中的 <code>mesh.Watcher</code> 将 <code>mesh</code> 这个配置同步过去。</p>
</li>
<li>
<p>初始化 <code>Server</code></p>
<p><code>Server</code> 的结构之前分析过，这里将之前初始化的 <code>Environment</code> 传入后，开始初始化 <code>XDSServer</code> 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
  <span style="color:#a6e22e">clusterID</span>:       <span style="color:#a6e22e">getClusterID</span>(<span style="color:#a6e22e">args</span>),
  <span style="color:#a6e22e">environment</span>:     <span style="color:#a6e22e">e</span>,
  <span style="color:#a6e22e">XDSServer</span>:       <span style="color:#a6e22e">xds</span>.<span style="color:#a6e22e">NewDiscoveryServer</span>(<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Plugins</span>), <span style="color:#75715e">// 初始化 XDSServer
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fileWatcher</span>:     <span style="color:#a6e22e">filewatcher</span>.<span style="color:#a6e22e">NewWatcher</span>(),
  <span style="color:#a6e22e">httpMux</span>:         <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>(),
  <span style="color:#a6e22e">monitoringMux</span>:   <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>(),
  <span style="color:#a6e22e">readinessProbes</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">readinessProbe</span>),
}
</code></pre></div><p><code>XDSServer</code> 相关的代码在 <code>istio/pilot/pkg/xds/discovery.go</code> 中，对应为 <code>DiscoveryServer</code> ，该服务为 <code>Envoy xDS APIs </code> 的 <code>gRPC</code> 实现。 <code>DiscoveryServer</code> 关键定义如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DiscoveryServer</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Env</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Environment</span>   <span style="color:#75715e">// 即上述 pilot server 中的 Environment
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ConfigGenerator</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">ConfigGenerator</span>  <span style="color:#75715e">// 控制面 Istio 配置的生成器，如 VirtualService 等
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Generators</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">XdsResourceGenerator</span> <span style="color:#75715e">// 针对不同配置类型的定制化生成器
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">concurrentPushLimit</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}
  <span style="color:#75715e">// 不同服务所有实例的集合，增量更新，key 为 service 和 namespace
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// EndpointShards 中是以不同的注册中心名为 key 分组保存实例
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">EndpointShardsByService</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">EndpointShards</span> 
  <span style="color:#a6e22e">pushChannel</span> <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">PushRequest</span>  <span style="color:#75715e">// 接收 push 请求的 channel
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">pushQueue</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PushQueue</span>     <span style="color:#75715e">// 防抖之后，真正 Push xDS 之前所用的缓冲队列
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">adsClients</span>      <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>  <span style="color:#75715e">// ADS 和 EDS 的 gRPC 连接
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">StatusReporter</span> <span style="color:#a6e22e">DistributionStatusCache</span>  <span style="color:#75715e">// 监听 xDS ACK 和连接断开
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// xDS 状态更新的生成器（更新 connect, disconnect, nacks, acks）
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// 状态更新后向所有 connection 推送 DiscoveryResponse
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">InternalGen</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">InternalGen</span> 
  <span style="color:#a6e22e">serverReady</span> <span style="color:#66d9ef">bool</span>     <span style="color:#75715e">// 表示缓存已同步，server 可以接受请求
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">debounceOptions</span> <span style="color:#a6e22e">debounceOptions</span>  <span style="color:#75715e">// 防抖设置
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">cache</span> <span style="color:#a6e22e">Cache</span> <span style="color:#75715e">// xDS 资源的缓存，目前仅适用于 EDS，线程安全
</span><span style="color:#75715e"></span>}
</code></pre></div></li>
<li>
<p>初始化 <code>MeshConfig</code> 、 <code>KubeClient</code> 、 <code>MeshNetworks</code> 和 <code>MeshHandlers</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initMeshConfiguration</span>(<span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fileWatcher</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initKubeClient</span>(<span style="color:#a6e22e">args</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error initializing kube client: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
}
<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initMeshNetworks</span>(<span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fileWatcher</span>)
<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initMeshHandlers</span>()
</code></pre></div><p>这几个初始化函数比较好理解， <code>initMeshConfiguration</code> 和 <code>initMeshNetworks</code> 都是通过 <code>fileWatcher</code> 对 <code>istiod</code> 从 <code>configmap</code> 中挂载的两个配置文件 <code>mesh</code> 和 <code>meshNetworks</code> 进行监听。当配置文件发生变化时重载配置并触发相应的 <code>Handlers</code> 。</p>
<p><code>filewatcher</code> 的代码在另一个管理通用工具包的项目里： <code>github.com/istio/pkg/filewatcher</code> ，感兴趣的同学可以再详细研究下，底层使用到了 <a href="https://github.com/fsnotify/fsnotify">fsnotify</a> 这个库来推送文件变化事件。</p>
<p><code>initMeshHandlers</code> 为上述两个配置文件注册了两个 <code>Handler</code> ，当配置文件发生变化时触发全量 <code>xDS</code> 下发。</p>
</li>
<li>
<p>初始化 <code>Controllers</code></p>
<p>这部分比较核心，初始化了三种控制器分别处理证书、配置信息和注册信息，证书及安全相关的内容本篇先暂不讨论。主要来看 <code>initConfigController</code> 和 <code>initServiceControllers</code> 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initControllers</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PilotArgs</span>) <span style="color:#66d9ef">error</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;initializing controllers&#34;</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initCertController</span>(<span style="color:#a6e22e">args</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error initializing certificate controller: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
  }
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initConfigController</span>(<span style="color:#a6e22e">args</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error initializing config controller: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
  }
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initServiceControllers</span>(<span style="color:#a6e22e">args</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error initializing service controllers: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
  }
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>配置信息大都是 <code>Istio</code> 定义的一系列 <code>CRD</code>（如 <code>VirtualService</code> 、 <code>DestinationRules</code> 等），一个控制面可以通过 <code>MCP</code> 同时接入多个 <code>Kubernetes</code> 之外的配置数据源，也可通过文件目录（主要用来调试）挂载，默认是读取 Kubernetes 中的配置数据：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initK8SConfigStore</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PilotArgs</span>) <span style="color:#66d9ef">error</span> {
  <span style="color:#a6e22e">configController</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">makeKubeConfigController</span>(<span style="color:#a6e22e">args</span>)
  <span style="color:#f92672">...</span>
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initStatusController</span>(<span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">EnableStatus</span>) <span style="color:#75715e">// 初始化上面提到的 StatusReporter
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>配置数据包括以下类型，具体每个类型的含义 <code>Istio</code> 官网都有介绍及用例，这里不再赘述：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// PilotServiceApi contains only collections used by Pilot, including experimental Service Api.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">PilotServiceApi</span> = <span style="color:#a6e22e">collection</span>.<span style="color:#a6e22e">NewSchemasBuilder</span>().
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Destinationrules</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Envoyfilters</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Gateways</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Serviceentries</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Sidecars</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Virtualservices</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Workloadentries</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioNetworkingV1Alpha3Workloadgroups</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioSecurityV1Beta1Authorizationpolicies</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioSecurityV1Beta1Peerauthentications</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">IstioSecurityV1Beta1Requestauthentications</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">K8SServiceApisV1Alpha1Gatewayclasses</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">K8SServiceApisV1Alpha1Gateways</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">K8SServiceApisV1Alpha1Httproutes</span>).
    <span style="color:#a6e22e">MustAdd</span>(<span style="color:#a6e22e">K8SServiceApisV1Alpha1Tcproutes</span>).
    <span style="color:#a6e22e">Build</span>()
</code></pre></div><p>详细看下 <code>initK8SConfigStore</code> 中的 <code>makeKubeConfigController</code> 方法，这里初始化了一个处理 <code>Istio CRDs</code> 的 <code>Client</code> ，实现 <code>ConfigStoreCache</code> 这个接口中增删改查等方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">makeKubeConfigController</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PilotArgs</span>) (<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigStoreCache</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">crdclient</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">buildLedger</span>(<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">RegistryOptions</span>), <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Revision</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">RegistryOptions</span>.<span style="color:#a6e22e">KubeOptions</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><code>Client</code> 定义如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Client</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">schemas</span> <span style="color:#a6e22e">collection</span>.<span style="color:#a6e22e">Schemas</span>  <span style="color:#75715e">// Istio CRDs shemas
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">domainSuffix</span> <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">configLedger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">Ledger</span>
  <span style="color:#a6e22e">revision</span> <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">kinds</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">GroupVersionKind</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">cacheHandler</span> <span style="color:#75715e">// 跟踪已知类型的所有缓存 handler
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">queue</span> <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Instance</span>
  <span style="color:#a6e22e">istioClient</span> <span style="color:#a6e22e">istioclient</span>.<span style="color:#a6e22e">Interface</span>
  <span style="color:#a6e22e">serviceApisClient</span> <span style="color:#a6e22e">serviceapisclient</span>.<span style="color:#a6e22e">Interface</span>
}
</code></pre></div><p>再依次对这些类型创建 <code>Informer</code> 开启监听。回到 <code>initConfigController</code> ，创建好 <code>ConfigStore</code> 之后，再对其进一步包装：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 将所有 ConfigStore 聚合并缓存
</span><span style="color:#75715e"></span><span style="color:#a6e22e">aggregateConfigController</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">configaggregate</span>.<span style="color:#a6e22e">MakeCache</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ConfigStores</span>)
<span style="color:#75715e">// 通过 s.configController 统一操作上面聚合的 ConfigStores
</span><span style="color:#75715e"></span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">configController</span> = <span style="color:#a6e22e">aggregateConfigController</span>
<span style="color:#75715e">// 将其包装为 IstioConfigStore 传入 environment，便于操作 ServiceEntry/Gateway 等资源
</span><span style="color:#75715e">// IstioConfigStore 会在之后的 ServiceEntryStore 中用到
</span><span style="color:#75715e"></span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">environment</span>.<span style="color:#a6e22e">IstioConfigStore</span> = <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">MakeIstioStore</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">configController</span>)
</code></pre></div><p>最后将该 <code>Controller</code> 的启动函数注册到 <code>startFuncs</code> 中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">addStartFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
  <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">configController</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stop</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
})
</code></pre></div><p>再来看 <code>initServiceControllers</code> 处理服务发现的 <code>Controller</code> 初始化:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initServiceControllers</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PilotArgs</span>) <span style="color:#66d9ef">error</span> {
  <span style="color:#a6e22e">serviceControllers</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ServiceController</span>()
  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">RegistryOptions</span>.<span style="color:#a6e22e">Registries</span> {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">serviceRegistry</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">serviceregistry</span>.<span style="color:#a6e22e">Kubernetes</span>:
      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initKubeRegistry</span>(<span style="color:#a6e22e">serviceControllers</span>, <span style="color:#a6e22e">args</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
      }
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  }
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>从之前初始化的 <code>environment.ServiceDiscovery</code> 中获取已注册的服务中心，如果是 <code>Kubernetes</code> 则执行 <code>initKubeRegistry</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// initKubeRegistry creates all the k8s service controllers under this pilot
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initKubeRegistry</span>(<span style="color:#a6e22e">serviceControllers</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">aggregate</span>.<span style="color:#a6e22e">Controller</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PilotArgs</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Initializing Kubernetes service registry %q&#34;</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">RegistryOptions</span>.<span style="color:#a6e22e">KubeOptions</span>.<span style="color:#a6e22e">ClusterID</span>)
  <span style="color:#a6e22e">kubeRegistry</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubecontroller</span>.<span style="color:#a6e22e">NewController</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">RegistryOptions</span>.<span style="color:#a6e22e">KubeOptions</span>)
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeRegistry</span> = <span style="color:#a6e22e">kubeRegistry</span>
  <span style="color:#a6e22e">serviceControllers</span>.<span style="color:#a6e22e">AddRegistry</span>(<span style="color:#a6e22e">kubeRegistry</span>)
  <span style="color:#66d9ef">return</span>
}
</code></pre></div><p>进一步初始化 <code>Kubernetes</code> 注册中心，方法为 <code>NewController</code> ，先看一下这个 <code>Controller</code> 的结构：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Controller</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">client</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">Interface</span>
  <span style="color:#a6e22e">queue</span> <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Instance</span>
  <span style="color:#a6e22e">serviceInformer</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span>
  <span style="color:#a6e22e">serviceLister</span>   <span style="color:#a6e22e">listerv1</span>.<span style="color:#a6e22e">ServiceLister</span>
  <span style="color:#a6e22e">endpoints</span> <span style="color:#a6e22e">kubeEndpointsController</span>
  <span style="color:#a6e22e">nodeInformer</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span>
  <span style="color:#a6e22e">nodeLister</span>   <span style="color:#a6e22e">listerv1</span>.<span style="color:#a6e22e">NodeLister</span>
  <span style="color:#a6e22e">pods</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PodCache</span>
  <span style="color:#a6e22e">metrics</span>         <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Metrics</span>
  <span style="color:#a6e22e">networksWatcher</span> <span style="color:#a6e22e">mesh</span>.<span style="color:#a6e22e">NetworksWatcher</span>
  <span style="color:#a6e22e">xdsUpdater</span>      <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">XDSUpdater</span>
  <span style="color:#a6e22e">domainSuffix</span>    <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">clusterID</span>       <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">serviceHandlers</span>  []<span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Service</span>, <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Event</span>)
  <span style="color:#a6e22e">instanceHandlers</span> []<span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ServiceInstance</span>, <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Event</span>)
  <span style="color:#a6e22e">workloadHandlers</span> []<span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">WorkloadInstance</span>, <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Event</span>)
  <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
  <span style="color:#a6e22e">servicesMap</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">host</span>.<span style="color:#a6e22e">Name</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Service</span>
  <span style="color:#a6e22e">nodeSelectorsForServices</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">host</span>.<span style="color:#a6e22e">Name</span>]<span style="color:#a6e22e">labels</span>.<span style="color:#a6e22e">Instance</span>
  <span style="color:#a6e22e">nodeInfoMap</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">kubernetesNode</span>
  <span style="color:#a6e22e">externalNameSvcInstanceMap</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">host</span>.<span style="color:#a6e22e">Name</span>][]<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ServiceInstance</span>
  <span style="color:#a6e22e">workloadInstancesByIP</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">WorkloadInstance</span>
  <span style="color:#a6e22e">ranger</span> <span style="color:#a6e22e">cidranger</span>.<span style="color:#a6e22e">Ranger</span>
  <span style="color:#a6e22e">networkForRegistry</span> <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">once</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Once</span>
}
</code></pre></div><p>可以看到 <code>Controller</code> 对 <code>Services</code> 、 <code>Nodes</code> 、 <code>Pods</code> 等资源各自初始化了 <code>Informer</code> 、 Lister 以及对应的 Map，各类 Handlers 在 Informer 监听到增删改查时推送相应的事件到 queue ，再由 <code>onServiceEvent</code> 、 <code>onNodeEvent</code> 、 <code>c.pods.onEvent</code> 中更新对应的 Map 。</p>
<p>回到 <code>initServiceControllers</code> ，初始化完 Kubernetes 注册中心之后，还需要关注 Kubernetes 集群之外的服务，这些服务基本都是通过 <code>ServiceEntry</code> 注册到控制面的，所有 <code>ServiceEntry</code> 配置数据目前还都在之前初始化的 <code>configController</code> 配置中心控制器中，这里将 <code>ServiceEntry</code> 数据单独拎出来初始化一个 <code>ServicEntry</code> 注册中心，加入到 <code>serviceControllers</code> 中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">serviceEntryStore</span> = <span style="color:#a6e22e">serviceentry</span>.<span style="color:#a6e22e">NewServiceDiscovery</span>(
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">configController</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">environment</span>.<span style="color:#a6e22e">IstioConfigStore</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">XDSServer</span>)
<span style="color:#a6e22e">serviceControllers</span>.<span style="color:#a6e22e">AddRegistry</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">serviceEntryStore</span>)
</code></pre></div><p><code>serviceEntryStore</code> 相关的逻辑会在后续 xDS 下发流程的分析中再阐述。</p>
<p>最后将 <code>serviceControllers</code> 中所有的服务注册中心的 <code>Controller</code> 的启动函数都注册到 <code>startFuncs</code> 中:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">addStartFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
  <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">serviceControllers</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stop</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
})
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Run starts all the controllers
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
    
  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetRegistries</span>() {
    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stop</span>)
  }
    
  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stop</span>
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Registry Aggregator terminated&#34;</span>)
}
</code></pre></div></li>
<li>
<p>初始化 <code>RegistryEventHandlers</code></p>
<p><code>initRegistryEventHandlers</code> 设置了三个事件处理器 <code>serviceHandler</code> 、 <code>instanceHandler</code> 和 <code>configHandler</code> 分别响应服务、实例和配置数据的更新事件。</p>
<p><code>serviceHandler</code> 如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">serviceHandler</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">svc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Service</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Event</span>) {
  <span style="color:#a6e22e">pushReq</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">PushRequest</span>{
    <span style="color:#a6e22e">Full</span>: <span style="color:#66d9ef">true</span>,
    <span style="color:#a6e22e">ConfigsUpdated</span>: <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigKey</span>]<span style="color:#66d9ef">struct</span>{}{{
      <span style="color:#a6e22e">Kind</span>:      <span style="color:#a6e22e">gvk</span>.<span style="color:#a6e22e">ServiceEntry</span>,
      <span style="color:#a6e22e">Name</span>:      string(<span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">Hostname</span>),
      <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">Attributes</span>.<span style="color:#a6e22e">Namespace</span>,
    }: {}},
    <span style="color:#a6e22e">Reason</span>: []<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">TriggerReason</span>{<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ServiceUpdate</span>},
  }
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">XDSServer</span>.<span style="color:#a6e22e">ConfigUpdate</span>(<span style="color:#a6e22e">pushReq</span>)
}
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ServiceController</span>().<span style="color:#a6e22e">AppendServiceHandler</span>(<span style="color:#a6e22e">serviceHandler</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;append service handler failed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
}
</code></pre></div><p>可以看到当服务本身发生变化时，会触发 <code>xDS</code> 的全量下发，所有与该服务相关的代理都会收到推送。</p>
<p>实例的变动也会触发 <code>xDS</code> 的全量下发，不过仅在连接 <code>Consul</code> 时生效。<code>Kubernetes</code> 和 <code>MCP</code> 这两种服务发现的场景下，更新事件的 <code>Handler</code> 是在别的地方注册的。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">instanceHandler</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">si</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ServiceInstance</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Event</span>) {
  <span style="color:#75715e">// TODO: This is an incomplete code. This code path is called for consul, etc.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// In all cases, this is simply an instance update and not a config update. So, we need to update
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// EDS in all proxies, and do a full config push for the instance that just changed (add/update only).
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">EnvoyXdsServer</span>.<span style="color:#a6e22e">ConfigUpdate</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">PushRequest</span>{
    <span style="color:#a6e22e">Full</span>: <span style="color:#66d9ef">true</span>,
    <span style="color:#a6e22e">ConfigsUpdated</span>: <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigKey</span>]<span style="color:#66d9ef">struct</span>{}{{
      <span style="color:#a6e22e">Kind</span>:      <span style="color:#a6e22e">gvk</span>.<span style="color:#a6e22e">ServiceEntry</span>,
      <span style="color:#a6e22e">Name</span>:      string(<span style="color:#a6e22e">si</span>.<span style="color:#a6e22e">Service</span>.<span style="color:#a6e22e">Hostname</span>),
      <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">si</span>.<span style="color:#a6e22e">Service</span>.<span style="color:#a6e22e">Attributes</span>.<span style="color:#a6e22e">Namespace</span>,
    }: {}},
    <span style="color:#a6e22e">Reason</span>: []<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">TriggerReason</span>{<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ServiceUpdate</span>},
  })
}
<span style="color:#75715e">// 跳过 Kubernetes 和 MCP
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">registry</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ServiceController</span>().<span style="color:#a6e22e">GetRegistries</span>() {
  <span style="color:#75715e">// Skip kubernetes and external registries as they are handled separately
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">Provider</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">serviceregistry</span>.<span style="color:#a6e22e">Kubernetes</span> <span style="color:#f92672">||</span>
    <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">Provider</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">serviceregistry</span>.<span style="color:#a6e22e">External</span> {
    <span style="color:#66d9ef">continue</span>
  }
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">AppendInstanceHandler</span>(<span style="color:#a6e22e">instanceHandler</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;append instance handler to registry %s failed: %v&#34;</span>, <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">Provider</span>(), <span style="color:#a6e22e">err</span>)
  }
}
</code></pre></div><p>上一步初始化了 <code>configController</code> ，它操作的对象主要是像 <code>VirtualService</code> 、 <code>DestinationRules</code> 这些 <code>Istio</code> 定义的配置，这些配置的变化也会触发 <code>xDS</code> 的全量下发，所有与该配置相关的代理都会收到推送。不过 <code>ServiceEntry</code> 和 <code>WorkloadEntry</code> 除外，这两个资源的配置下发是由 <code>ServiceEntryStore</code> 管理的，之前在初始化 <code>ServiceController</code> 时定义的 <code>s.serviceEntryStore</code> 会处理，之后的篇幅再做详细介绍。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">configHandler</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">curr</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Config</span>, <span style="color:#a6e22e">event</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Event</span>) {
  <span style="color:#a6e22e">pushReq</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">PushRequest</span>{
    <span style="color:#a6e22e">Full</span>: <span style="color:#66d9ef">true</span>,
    <span style="color:#a6e22e">ConfigsUpdated</span>: <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigKey</span>]<span style="color:#66d9ef">struct</span>{}{{
      <span style="color:#a6e22e">Kind</span>:      <span style="color:#a6e22e">curr</span>.<span style="color:#a6e22e">GroupVersionKind</span>,
      <span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">curr</span>.<span style="color:#a6e22e">Name</span>,
      <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">curr</span>.<span style="color:#a6e22e">Namespace</span>,
    }: {}},
    <span style="color:#a6e22e">Reason</span>: []<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">TriggerReason</span>{<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigUpdate</span>},
  }
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">EnvoyXdsServer</span>.<span style="color:#a6e22e">ConfigUpdate</span>(<span style="color:#a6e22e">pushReq</span>)
}
</code></pre></div><p>下面是跳过 <code>ServiceEntry</code> 和 <code>WorkloadEntry</code> 的代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">schema</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">schemas</span> {
  <span style="color:#75715e">// This resource type was handled in external/servicediscovery.go, no need to rehandle here.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">Resource</span>().<span style="color:#a6e22e">GroupVersionKind</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">collections</span>.<span style="color:#a6e22e">IstioNetworkingV1Alpha3Serviceentries</span>.
    <span style="color:#a6e22e">Resource</span>().<span style="color:#a6e22e">GroupVersionKind</span>() {
    <span style="color:#66d9ef">continue</span>
  }
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">Resource</span>().<span style="color:#a6e22e">GroupVersionKind</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">collections</span>.<span style="color:#a6e22e">IstioNetworkingV1Alpha3Workloadentries</span>.
    <span style="color:#a6e22e">Resource</span>().<span style="color:#a6e22e">GroupVersionKind</span>() {
    <span style="color:#66d9ef">continue</span>
  }
    
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">configController</span>.<span style="color:#a6e22e">RegisterEventHandler</span>(<span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">Resource</span>().<span style="color:#a6e22e">GroupVersionKind</span>(), <span style="color:#a6e22e">configHandler</span>)
}
</code></pre></div></li>
<li>
<p>初始化 <code>DiscoveryService</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initDiscoveryService</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PilotArgs</span>) <span style="color:#66d9ef">error</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;starting discovery service&#34;</span>)
  <span style="color:#75715e">// Implement EnvoyXdsServer grace shutdown
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">addStartFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">EnvoyXdsServer</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stop</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
  })
    
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">initGrpcServer</span>(<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">KeepaliveOptions</span>)
  <span style="color:#a6e22e">grpcListener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">ServerOptions</span>.<span style="color:#a6e22e">GRPCAddr</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
  }
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">GRPCListener</span> = <span style="color:#a6e22e">grpcListener</span>
    
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>这里将 <code>EnvoyXdsServer</code> 的启动添加至 <code>startFuncs</code> 中，便于后续统一启动。并初始化 <code>gRPC</code> 服务器，监听对应的端口。</p>
<p>初始化 <code>gRPC</code> 服务器，并注册 <code>xDS V2</code> 和 <code>xDS V3</code> 的 <code>ADS</code> 服务到 <code>gRPC</code> 服务器上:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">initGrpcServer</span>(<span style="color:#a6e22e">options</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">istiokeepalive</span>.<span style="color:#a6e22e">Options</span>) {
  <span style="color:#a6e22e">grpcOptions</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcServerOptions</span>(<span style="color:#a6e22e">options</span>)
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcServer</span> = <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">grpcOptions</span><span style="color:#f92672">...</span>)
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">EnvoyXdsServer</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcServer</span>)
  <span style="color:#a6e22e">reflection</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">grpcServer</span>)
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DiscoveryServer</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">rpcs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>) {
  <span style="color:#75715e">// Register v2 and v3 servers
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">discovery</span>.<span style="color:#a6e22e">RegisterAggregatedDiscoveryServiceServer</span>(<span style="color:#a6e22e">rpcs</span>, <span style="color:#a6e22e">s</span>)
  <span style="color:#a6e22e">discoveryv2</span>.<span style="color:#a6e22e">RegisterAggregatedDiscoveryServiceServer</span>(<span style="color:#a6e22e">rpcs</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">createV2Adapter</span>())
}
</code></pre></div><p>可以看到 <code>ADS</code> 的 <code>gRPC</code> 服务包含两个流式方法，一个是全量推送，一个是增量推送。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_AggregatedDiscoveryService_serviceDesc</span> = <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ServiceDesc</span>{
  <span style="color:#a6e22e">ServiceName</span>: <span style="color:#e6db74">&#34;envoy.service.discovery.v3.AggregatedDiscoveryService&#34;</span>,
  <span style="color:#a6e22e">HandlerType</span>: (<span style="color:#f92672">*</span><span style="color:#a6e22e">AggregatedDiscoveryServiceServer</span>)(<span style="color:#66d9ef">nil</span>),
  <span style="color:#a6e22e">Methods</span>:     []<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">MethodDesc</span>{},
  <span style="color:#a6e22e">Streams</span>: []<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">StreamDesc</span>{
    {
      <span style="color:#a6e22e">StreamName</span>:    <span style="color:#e6db74">&#34;StreamAggregatedResources&#34;</span>,
      <span style="color:#a6e22e">Handler</span>:       <span style="color:#a6e22e">_AggregatedDiscoveryService_StreamAggregatedResources_Handler</span>,
      <span style="color:#a6e22e">ServerStreams</span>: <span style="color:#66d9ef">true</span>,
      <span style="color:#a6e22e">ClientStreams</span>: <span style="color:#66d9ef">true</span>,
    },
    {
      <span style="color:#a6e22e">StreamName</span>:    <span style="color:#e6db74">&#34;DeltaAggregatedResources&#34;</span>,
      <span style="color:#a6e22e">Handler</span>:       <span style="color:#a6e22e">_AggregatedDiscoveryService_DeltaAggregatedResources_Handler</span>,
      <span style="color:#a6e22e">ServerStreams</span>: <span style="color:#66d9ef">true</span>,
      <span style="color:#a6e22e">ClientStreams</span>: <span style="color:#66d9ef">true</span>,
    },
  },
  <span style="color:#a6e22e">Metadata</span>: <span style="color:#e6db74">&#34;envoy/service/discovery/v3/ads.proto&#34;</span>,
}
</code></pre></div></li>
<li>
<p>注册 <code>kubeClient.RunAndWait</code></p>
<p>将 <code>kubeClient.RunAndWait</code> 方法注册至 <code>startFuncs</code> 中， <code>RunAndWait</code> 启动后所有 <code>Informer</code> 将开始缓存，并等待它们同步完成。之所以在最后运行，可以保证所有的 <code>Informer</code> 都已经注册。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">addStartFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">RunAndWait</span>(<span style="color:#a6e22e">stop</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
  })
}
</code></pre></div></li>
</ol>
<h3 id="启动过程">启动过程</h3>
<p>启动流程比较简单，核心是依次启动初始化过程中注册到 <code>startFuncs</code> 中的启动函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">fn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startFuncs</span> {
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fn</span>(<span style="color:#a6e22e">stop</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
  }
}
</code></pre></div><p>然后调用 <code>waitForCache</code> 等待需要监听资源的 <code>Informer</code> 缓存完毕，完成后开启 <code>HTTP</code> 服务响应 <code>readiness</code> 事件。</p>
<p>至此 <code>pilot-discovery</code> 的启动流程就结束了，有了大概了解后，可以大致归纳出整个 <code>Pilot</code> 的接口架构。</p>
<h2 id="接口设计">接口设计</h2>
<p>在接口设计方面，<code>Pilot</code> 主要有两类接口：一种是 <code>Store</code> 类接口，定义对资源的增删改查等方法；另一种是 <code>Controller</code> 类接口，定义了 <code>RegisterEventHandler</code> 和 <code>Run</code> 方法。</p>
<p><code>Store</code> 类接口主要指 <code>ConfigStore</code> 接口，以及它衍生出的 <code>IstioConfigStore</code>，后者操作的对象为 <code>Istio</code> 定义的配置类型，如 <code>VirtualService</code>、<code>ServiceEntry</code> 等。</p>
<p>而 <code>Controller</code> 类接口指基于 <code>ConfigStore</code>  定义的 <code>ConfigStoreCache</code> 接口，这个接口在哪里用到了呢？之前讨论初始化流程的时候，分析过 <code>Pilot</code> 的 <code>Server</code> 的结构，其中用到该接口的有如下几个字段：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">configController</span>  <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigStoreCache</span>
	<span style="color:#a6e22e">ConfigStores</span>      []<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">ConfigStoreCache</span>
	<span style="color:#a6e22e">serviceEntryStore</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">serviceentry</span>.<span style="color:#a6e22e">ServiceEntryStore</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ServiceEntryStore</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">store</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">IstioConfigStore</span>
}
</code></pre></div><p>可以看到 <code>ConfigStores</code> 是存储所有配置类数据的 <code>Controller</code> 的地方，<code>ConfigStores</code> 都是在哪里添加的呢？之前分析 <code>initConfigController</code> 方法中提到过，可以再对照代码看一下调用的地方：</p>
<p><img src="https://i.loli.net/2020/09/03/2IbDaBl91TOgNt7.png" alt="image.png"></p>
<p>都添加完毕后，会把这些 <code>ConfigStoreCache</code> 都聚合到 <code>Server.configController</code> 中统一处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#75715e">// Wrap the config controller with a cache.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">aggregateConfigController</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">configaggregate</span>.<span style="color:#a6e22e">MakeCache</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ConfigStores</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">configController</span> = <span style="color:#a6e22e">aggregateConfigController</span>
</code></pre></div><p>而 <code>ServiceEntryStore</code> 中用到的 <code>IstioConfigStore</code> 也是在这里得到的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">environment</span>.<span style="color:#a6e22e">IstioConfigStore</span> = <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">MakeIstioStore</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">configController</span>)
</code></pre></div><p>以上，当服务启动后，会逐个调用这些 <code>ConfigStoreCache</code> 中的 <code>Run</code> 方法处理资源的增删改事件。</p>
<h2 id="总结">总结</h2>
<p><code>pilot-discovery</code> 的启动流程初看是比较复杂，但理清楚中间核心的步骤后结构也比较清晰。有了本篇的介绍，之后再走读几遍代码，相信就能很好的掌握 <code>pilot-discovery</code> 初始化的流程。</p>
<p><code>Pilot</code> 源码分析的第一部分就到这里，后续会针对重要的组件和接口做更细致的分析，如 <code>EnvoyXdsServer</code> 、<code>ServiceEntryStore</code> 等，以及梳理 <code>xDS</code> 协议的生成和下发流程，会比 <code>pilot-discovery</code> 的启动流程复杂的多，敬请期待。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://zhaohuabing.com/post/2019-10-21-pilot-discovery-code-analysis/">Istio Pilot 代码深度解析 - 赵化冰</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/istio"> 
            Istio</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/service-mesh"> , 
            Service Mesh</a>
            
          </ul>
        </div>
        <!-- previous -->
        <div class="mb-3 link-article">
  <div class="pre-article">
    
    <div><i class="fa fa-arrow-left"></i> 上一篇</div>
    <a href="https://cloudnative.to/blog/client_go-informer/">Kubernetes client-go informer架构介绍</a>
    
  </div>
  <div class="next-article">
    
    <div>下一篇 <i class="fa fa-arrow-right"></i></div>
    <a href="https://cloudnative.to/blog/sig-envoy-announcement/">云原生社区 Envoy SIG 成立啦！</a>
  
  </div>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/microservices-ha-practice/">混合微服务高可用在企业级生产中的实践</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5 word-cloud">
    <h4 class="mb-4">标签</h4>
    
      
      
      
      
      
      
      
      
      
      
      
      <div id="tag-cloud" style="padding: 5px 15px">
      
        
          
          
          
          <a href="/tags/bpf" style="font-size:1rem">bpf</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cicd" style="font-size:1.1428571428571428rem">cicd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/client-go" style="font-size:1.2857142857142856rem">client-go</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cloud-native" style="font-size:1.1428571428571428rem">cloud-native</a>
        
      
        
          
          
          &middot;
          <a href="/tags/crossplane" style="font-size:1rem">crossplane</a>
        
      
        
          
          
          &middot;
          <a href="/tags/devops" style="font-size:1rem">devops</a>
        
      
        
          
          
          &middot;
          <a href="/tags/envoy" style="font-size:1.2857142857142856rem">envoy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/etcd" style="font-size:1rem">etcd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/flamegraph" style="font-size:1rem">flamegraph</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gateway" style="font-size:1rem">gateway</a>
        
      
        
          
          
          &middot;
          <a href="/tags/informer" style="font-size:1.4285714285714286rem">informer</a>
        
      
        
          
          
          &middot;
          <a href="/tags/istio" style="font-size:1.8571428571428572rem">istio</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubebuilder" style="font-size:1rem">kubebuilder</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetes" style="font-size:1.4285714285714286rem">kubernetes</a>
        
      
        
          
          
          &middot;
          <a href="/tags/linux%e5%86%85%e6%a0%b8" style="font-size:1rem">linux内核</a>
        
      
        
          
          
          &middot;
          <a href="/tags/microservices" style="font-size:1.1428571428571428rem">microservices</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mosn" style="font-size:1rem">mosn</a>
        
      
        
          
          
          &middot;
          <a href="/tags/oam" style="font-size:1.1428571428571428rem">oam</a>
        
      
        
          
          
          &middot;
          <a href="/tags/operator" style="font-size:1rem">operator</a>
        
      
        
          
          
          &middot;
          <a href="/tags/profile" style="font-size:1rem">profile</a>
        
      
        
          
          
          &middot;
          <a href="/tags/security" style="font-size:1rem">security</a>
        
      
        
          
          
          &middot;
          <a href="/tags/service-mesh" style="font-size:1.8571428571428572rem">service-mesh</a>
        
      
        
          
          
          &middot;
          <a href="/tags/spring-cloud" style="font-size:1rem">spring-cloud</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tcpdump" style="font-size:1rem">tcpdump</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tekton" style="font-size:1rem">tekton</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vxlan" style="font-size:1rem">vxlan</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wasm" style="font-size:1rem">wasm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wireshark" style="font-size:1rem">wireshark</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zookeeper" style="font-size:1rem">zookeeper</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e4%ba%91%e5%8e%9f%e7%94%9f%e5%ad%a6%e9%99%a2" style="font-size:1rem">云原生学院</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%ad%a6%e4%b9%a0%e5%b0%8f%e7%bb%84" style="font-size:1rem">学习小组</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%bc%80%e6%ba%90" style="font-size:1rem">开源</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" style="font-size:1rem">源码分析</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e7%90%86%e8%a7%a3" style="font-size:1.1428571428571428rem">源码理解</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%a4%be%e5%8c%ba" style="font-size:1.1428571428571428rem">社区</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%bf%bb%e8%af%91" style="font-size:1.2857142857142856rem">翻译</a>
        
      
      </div>
    
  </div>

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <div class="mx-auto avatar-wrp">
        <img class="rounded-circle avatar-img" src="/images/profile/haidong.jpeg">
      </div>
      <p class="avatar-name">
        <strong class="text-dark "><a href="http://haidong.dev/">张海东</a></strong> 
      </p>
      <p>多点生活（成都）云原生开发工程师。</p>
    </div>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#宏观架构">宏观架构</a></li>
    <li><a href="#启动流程梳理">启动流程梳理</a>
      <ul>
        <li><a href="#初始化流程">初始化流程</a></li>
        <li><a href="#启动过程">启动过程</a></li>
      </ul>
    </li>
    <li><a href="#接口设计">接口设计</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是一个中立的云原生终端用户社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，旨在推广云原生技术，构建开发者生态。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativeto"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnativecommunity.slack.com"><i class="fa fa-slack"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="https://github.com/cloudnativeto/community/issues/56">北京</a>|<a href="https://github.com/cloudnativeto/community/issues/51">上海</a>|<a href="https://github.com/cloudnativeto/community/issues/58">成都</a>|<a href="https://github.com/cloudnativeto/community/issues/60">深圳</a>|<a href="https://github.com/cloudnativeto/community/issues/53">杭州</a>|<a href="https://github.com/cloudnativeto/community/issues/59">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="https://github.com/cloudnativeto/community/issues/57">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2020 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/code-of-conduct"
                class="text-white">社区守则</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>

</body>

</html>
