<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="crane-sheduler 基于 prometheus 集群真实资源负载进行调度，将其应用于调度过程中的 Filter 和 Score 阶段，能够有效缓解集群资源负载不均的问题，真正实现企业的降本增效。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnativecn.com/blog/crane-scheduler/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.008259417e6adf8980695ebbbb46553f.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu11854384586569594417.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu14437075198232143360.png" />

  <link rel="canonical" href="https://cloudnativecn.com/blog/crane-scheduler/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnativecn.com/blog/crane-scheduler/" />
  <meta property="og:title" content="Crane 调度器介绍——一款在 Kubernetes 集群间迁移应用的调度插件 | 云原生社区（中国）" />
  <meta property="og:description" content="crane-sheduler 基于 prometheus 集群真实资源负载进行调度，将其应用于调度过程中的 Filter 和 Score 阶段，能够有效缓解集群资源负载不均的问题，真正实现企业的降本增效。" /><meta property="og:image" content="https://cloudnativecn.com/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnativecn.com/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2023-05-31T12:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2025-01-10T12:19:31&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnativecn.com/blog/crane-scheduler/"
  },
  "headline": "Crane 调度器介绍——一款在 Kubernetes 集群间迁移应用的调度插件",
  
  "datePublished": "2023-05-31T12:00:00+08:00",
  "dateModified": "2025-01-10T12:19:31+08:00",
  
  "author": {
    "@type": "Person",
    "name": "匡澄"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnativecn.com/media/logo.svg"
    }
  },
  "description": "crane-sheduler 基于 prometheus 集群真实资源负载进行调度，将其应用于调度过程中的 Filter 和 Score 阶段，能够有效缓解集群资源负载不均的问题，真正实现企业的降本增效。"
}
</script>

  

  

  

  





  <title>Crane 调度器介绍——一款在 Kubernetes 集群间迁移应用的调度插件 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="aafd9e409a9a0aeb8e792c401e9a04e2" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>小组</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/k8s-gateway-api"><span>Kubernetes Gateway API SIG</span></a>
              
            </div>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>云原生资料库</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>Crane 调度器介绍——一款在 Kubernetes 集群间迁移应用的调度插件</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E5%8C%A1%E6%BE%84/">匡澄</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/%E4%BA%91%E5%8E%9F%E7%94%9F/" class="text-capitalize">云原生</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2023-05-31
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 3373
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 15 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#背景">背景</a></li>
    <li><a href="#kubernetes-调度框架">Kubernetes 调度框架</a></li>
    <li><a href="#crane-scheduler-设计与实现">crane-scheduler 设计与实现</a>
      <ul>
        <li><a href="#总体架构">总体架构</a></li>
        <li><a href="#关键代码实现">关键代码实现</a></li>
        <li><a href="#使用流程">使用流程</a></li>
      </ul>
    </li>
    <li><a href="#真实环境测试">真实环境测试</a>
      <ul>
        <li><a href="#内存型服务测试">内存型服务测试</a></li>
        <li><a href="#cpu-型服务测试">CPU 型服务测试</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考文献">参考文献</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#背景">背景</a></li>
    <li><a href="#kubernetes-调度框架">Kubernetes 调度框架</a></li>
    <li><a href="#crane-scheduler-设计与实现">crane-scheduler 设计与实现</a>
      <ul>
        <li><a href="#总体架构">总体架构</a></li>
        <li><a href="#关键代码实现">关键代码实现</a></li>
        <li><a href="#使用流程">使用流程</a></li>
      </ul>
    </li>
    <li><a href="#真实环境测试">真实环境测试</a>
      <ul>
        <li><a href="#内存型服务测试">内存型服务测试</a></li>
        <li><a href="#cpu-型服务测试">CPU 型服务测试</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考文献">参考文献</a></li>
  </ul>
</nav>
</details>

                    
                    <h2 id="前言">前言</h2>
<p>原生 Kubernetes 调度器仅基于资源的 Request 进行调度，在生产环境资源的真实使用率和申请率往往相差巨大，造成资源浪费的同时也会造成节点的负载不均衡。crane-sheduler 基于 prometheus 集群真实资源负载进行调度，将其应用于调度过程中的 Filter 和 Score 阶段，能够有效缓解集群资源负载不均的问题，真正实现企业的降本增效。</p>
<h2 id="背景">背景</h2>
<p>Kubernetes 集群是现代许多企业的首选方案之一，因为它可以帮助企业实现自动化部署、弹性伸缩和容错处理等功能，从而减少了人工操作和维护工作量，提高了服务的可靠性和稳定性，实现了降本增效。但是 Kubernetes 默认的调度器存在以下问题：</p>
<ol>
<li>节点的实际利用率和节点申请率往往相差巨大，造成资源的浪费；</li>
<li>节点间资源分布不均，会带来负载不均的问题。</li>
</ol>
<p>crane-scheduler 由腾讯云团队开发，在一定程度上能够解决上述问题，直接基于资源的真实使用率进行调度，能够最大程度地利用资源，并排除了稳定性的后顾之忧，经过了长时间的实践和验证，可以很好地适应不同的场景和需求。开源后，crane-scheduler 受到了业界的广泛关注和支持，为 Kubernetes 社区的发展做出了贡献。（GitHub 链接地址：<a href="https://github.com/gocrane/crane-scheduler" target="_blank" rel="noopener">https://github.com/gocrane/crane-scheduler</a>）</p>
<h2 id="kubernetes-调度框架">Kubernetes 调度框架</h2>
<p>Kubernetes 官方提供了可插拔架构的调度框架，能够进一步扩展 Kubernetes 调度器，下图展示了调度框架中的调度上下文及其中的扩展点，一个扩展可以注册多个扩展点，以便可以执行更复杂的有状态的任务。</p>
<p>















<figure  id="figure-图-1-pod-调度流程">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图 1 Pod 调度流程" srcset="
               /blog/crane-scheduler/1_hu6252825251380067784.webp 400w,
               /blog/crane-scheduler/1_hu15506709478825344178.webp 760w,
               /blog/crane-scheduler/1_hu17913828119941943738.webp 1200w"
               src="/blog/crane-scheduler/1_hu6252825251380067784.webp"
               width="760"
               height="255"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图 1 Pod 调度流程
    </figcaption></figure>
</p>
<p>详细流程如下：</p>
<ol>
<li>Sort - 用于对 Pod 的待调度队列进行排序，以决定先调度哪个 Pod</li>
<li>Pre-filter - 用于对 Pod 的信息进行预处理</li>
<li>Filter - 用于排除那些不能运行该 Pod 的节点</li>
<li>Post-filter - 一个通知类型的扩展点，更新内部状态，或者产生日志</li>
<li>Scoring - 用于为所有可选节点进行打分</li>
<li>Normalize scoring - 在调度器对节点进行最终排序之前修改每个节点的评分结果</li>
<li>Reserve - 使用该扩展点获得节点上为 Pod 预留的资源，该事件发生在调度器将 Pod 绑定到节点前</li>
<li>Permit - 用于阻止或者延迟 Pod 与节点的绑定</li>
<li>Pre-bind - 用于在 Pod 绑定之前执行某些逻辑</li>
<li>Bind - 用于将 Pod 绑定到节点上</li>
<li>Post-bind - 是一个通知性质的扩展</li>
<li>Unreserve - 如果为 Pod 预留资源，又在被绑定过程中被拒绝绑定，则将被调用</li>
</ol>
<p>对于调度框架插件的启用或者禁用，我们同样可以使用上面的 <code>KubeSchedulerConfiguration</code> 资源对象来进行配置。下面的例子中的配置启用了一个实现了 <code>filter</code> 和 <code>scoring</code> 扩展点的插件，并且禁用了另外一个插件，同时为插件 foo 提供了一些配置信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubescheduler.config.k8s.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeSchedulerConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">plugins</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">filter</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">baz</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scoring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">baz</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">pluginConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    foo插件可以解析的任意内容</span><span class="w">    
</span></span></span></code></pre></div><p>扩展的调用顺序如下：</p>
<ul>
<li>如果某个扩展点没有配置对应的扩展，调度框架将使用默认插件中的扩展</li>
<li>如果为某个扩展点配置且激活了扩展，则调度框架将先调用默认插件的扩展，再调用配置中的扩展</li>
<li>默认插件的扩展始终被最先调用，然后按照 <code>KubeSchedulerConfiguration</code> 中扩展的激活 <code>enabled</code> 顺序逐个调用扩展点的扩展</li>
<li>可以先禁用默认插件的扩展，然后在 <code>enabled</code> 列表中的某个位置激活默认插件的扩展，这种做法可以改变默认插件的扩展被调用时的顺序</li>
</ul>
<p>Kubernetes 调度插件 demo：<a href="https://github.com/cnych/sample-scheduler-framework" target="_blank" rel="noopener">https://github.com/cnych/sample-scheduler-framework</a></p>
<h2 id="crane-scheduler-设计与实现">crane-scheduler 设计与实现</h2>
<h3 id="总体架构">总体架构</h3>
<p>















<figure  id="figure-图-2-crane-scheduler-总体架构">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="图 2 Crane-scheduler 总体架构" srcset="
               /blog/crane-scheduler/2_hu13996584553051102278.webp 400w,
               /blog/crane-scheduler/2_hu6712292932695736578.webp 760w,
               /blog/crane-scheduler/2_hu3797439034208222349.webp 1200w"
               src="/blog/crane-scheduler/2_hu13996584553051102278.webp"
               width="760"
               height="489"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图 2 Crane-scheduler 总体架构
    </figcaption></figure>
</p>
<p>动态调度器总体架构如上图所示，主要有两个组件组成：</p>
<ol>
<li><code>Node-annotator</code>定期从 Prometheus 拉取数据，并以注释的形式在节点上用时间戳标记它们。</li>
<li><code>Dynamic plugin</code>直接从节点的注释中读取负载数据，过滤并基于简单的算法对候选节点进行评分。</li>
</ol>
<p>同时动态调度器提供了一个默认值调度策略并支持用户自定义策略。默认策略依赖于以下指标：</p>
<pre tabindex="0"><code>cpu_usage_avg_5m
cpu_usage_max_avg_1h
cpu_usage_max_avg_1d
mem_usage_avg_5m
mem_usage_max_avg_1h
mem_usage_max_avg_1d
</code></pre><p>在调度的<code>Filter</code>阶段，如果该节点的实际使用率大于上述任一指标的阈值，则该节点将被过滤。而在<code>Score</code>阶段，最终得分是这些指标值的加权和。</p>
<p>在生产集群中，可能会频繁出现调度热点，因为创建 Pod 后节点的负载不能立即增加。因此定义了一个额外的指标，名为<code>Hot Value</code>，表示节点最近几次的调度频率。并且节点的最终优先级是最终得分减去<code>Hot Value</code>。</p>
<h3 id="关键代码实现">关键代码实现</h3>
<p><strong>Node-annotation</strong></p>
<p>定期从 Prometheus 拉取数据，并以注释的形式在节点上用时间戳标记它们</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="cl"><span class="c1">// /pkg/controller/annotator/node.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">nodeController</span><span class="p">)</span> <span class="nf">syncNode</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">startTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Finished syncing node event %q (%v)&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">startTime</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取 nodeName, metricName
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeName</span><span class="p">,</span> <span class="nx">metricName</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">splitMetaKeyWithMetricName</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过 nodeName 获取 node 的具体信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">node</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">nodeLister</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过 nodeIP 或者 nodeName 获取并更新 node 的监控指标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nf">annotateNodeLoad</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">promClient</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">metricName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取 node hotVaule，并更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nf">annotateNodeHotValue</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">bindingRecords</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">policy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">annotateNodeLoad</span><span class="p">(</span><span class="nx">promClient</span> <span class="nx">prom</span><span class="p">.</span><span class="nx">PromClient</span><span class="p">,</span> <span class="nx">kubeClient</span> <span class="nx">clientset</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">node</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过 nodeIp 查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">promClient</span><span class="p">.</span><span class="nf">QueryByNodeIP</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nf">getNodeInternalIP</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">patchNodeAnnotation</span><span class="p">(</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过 nodeName 查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">promClient</span><span class="p">.</span><span class="nf">QueryByNodeName</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nf">getNodeName</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">patchNodeAnnotation</span><span class="p">(</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get data %s{%s=%s}: %v&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Dynamic plugin</strong></p>
<p>Dynamic plugin 修改 filter 和 score 阶段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// /pkg/plugins/dynamic/plugins.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// Filter - 检查一个节点的实际负载是否过高
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ds</span> <span class="o">*</span><span class="nx">DynamicScheduler</span><span class="p">)</span> <span class="nf">Filter</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">state</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">CycleState</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeInfo</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">NodeInfo</span><span class="p">)</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Status</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">node</span> <span class="o">:=</span> <span class="nx">nodeInfo</span><span class="p">.</span><span class="nf">Node</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 读取 nodeAnnotation, nodeName
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeAnnotations</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="o">:=</span> <span class="nx">nodeInfo</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nx">Annotations</span><span class="p">,</span> <span class="nx">nodeInfo</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nx">Name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// filter - 过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">policy</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ds</span><span class="p">.</span><span class="nx">schedulerPolicy</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Predicate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 获取采样时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">activeDuration</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getActiveDuration</span><span class="p">(</span><span class="nx">ds</span><span class="p">.</span><span class="nx">schedulerPolicy</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">SyncPeriod</span><span class="p">,</span> <span class="nx">policy</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 根据指标，判断 node 是否过载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nf">isOverLoad</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">,</span> <span class="nx">nodeAnnotations</span><span class="p">,</span> <span class="nx">policy</span><span class="p">,</span> <span class="nx">activeDuration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">framework</span><span class="p">.</span><span class="nf">NewStatus</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Unschedulable</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Load[%s] of node[%s] is too high&#34;</span><span class="p">,</span> <span class="nx">policy</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">framework</span><span class="p">.</span><span class="nf">NewStatus</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Success</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Score - 它从节点注释中获取度量数据，并支持实际资源使用最少的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ds</span> <span class="o">*</span><span class="nx">DynamicScheduler</span><span class="p">)</span> <span class="nf">Score</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">state</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">CycleState</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过 nodeName，获取 node 具体信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ds</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nf">SnapshotSharedLister</span><span class="p">().</span><span class="nf">NodeInfos</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">node</span> <span class="o">:=</span> <span class="nx">nodeInfo</span><span class="p">.</span><span class="nf">Node</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodeAnnotations</span> <span class="o">:=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Annotations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 计算得分和 hotValue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">score</span><span class="p">,</span> <span class="nx">hotValue</span> <span class="o">:=</span> <span class="nf">getNodeScore</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">nodeAnnotations</span><span class="p">,</span> <span class="nx">ds</span><span class="p">.</span><span class="nx">schedulerPolicy</span><span class="p">.</span><span class="nx">Spec</span><span class="p">),</span> <span class="nf">getNodeHotValue</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">score</span> <span class="p">=</span> <span class="nx">score</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nx">hotValue</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="c1">// 计算总得分 finalScore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">finalScore</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">NormalizeScore</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">score</span><span class="p">),</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">MaxNodeScore</span><span class="p">,</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">MinNodeScore</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">finalScore</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="使用流程">使用流程</h3>
<h4 id="配置-prometheus-监测规则">配置 prometheus 监测规则</h4>
<ul>
<li>
<p><strong>syncPolicy</strong>: 用户可以自定义负载数据的类型与拉取周期；</p>
</li>
<li>
<p><strong>predicate</strong>:  Filter 策略，若候选节点的当前负载数据超过了任一所配置的指标阈值，则这个节点将会被过滤；</p>
</li>
<li>
<p><strong>priority</strong>：在 Score 策略中配置相关指标的权重，候选节点的最终得分为不同指标得分的加权和；</p>
</li>
<li>
<p><strong>hotValue</strong>：定义调度热点规则，最终节点的 Priority 为上一小节中的 Score 减去 Hot Value</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">scheduler.policy.crane.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DynamicSchedulerPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">syncPolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">##cpu usage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_avg_5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">period</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_max_avg_1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">period</span><span class="p">:</span><span class="w"> </span><span class="l">15m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_max_avg_1d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">period</span><span class="p">:</span><span class="w"> </span><span class="l">3h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">##memory usage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_avg_5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">period</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_max_avg_1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">period</span><span class="p">:</span><span class="w"> </span><span class="l">15m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_max_avg_1d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">period</span><span class="p">:</span><span class="w"> </span><span class="l">3h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">predicate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">##cpu usage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_avg_5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxLimitPecent</span><span class="p">:</span><span class="w"> </span><span class="m">0.65</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_max_avg_1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxLimitPecent</span><span class="p">:</span><span class="w"> </span><span class="m">0.75</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">##memory usage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_avg_5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxLimitPecent</span><span class="p">:</span><span class="w"> </span><span class="m">0.65</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_max_avg_1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxLimitPecent</span><span class="p">:</span><span class="w"> </span><span class="m">0.75</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">##cpu usage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_avg_5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">0.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_max_avg_1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">0.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu_usage_max_avg_1d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">0.5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">##memory usage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_avg_5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">0.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_max_avg_1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">0.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem_usage_max_avg_1d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">0.5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hotValue</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">timeRange</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">count</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">timeRange</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">count</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span></code></pre></div><h4 id="使用-crane-scheduler">使用 crane-scheduler</h4>
<p>这里有两种方式可供选择：</p>
<ol>
<li>
<p>作为 k8s 原生调度器之外的第二个调度器</p>
</li>
<li>
<p>替代 k8s 原生调度器成为默认的调度器</p>
</li>
<li>
<p><strong>作为 k8s 原生调度器之外的第二个调度器</strong></p>
<p>在 pod <code>spec.schedulerName</code> 指定 crane scheduler</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu-stress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">cpu-stress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">cpu-stress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l">crane-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node.kubernetes.io/network-unavailable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">Exists</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/gocrane/stress:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;stress&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p><strong>替代 k8s 原生调度器成为默认的调度器</strong></p>
<p>修改 kube 调度器的配置文件（scheduler config.yaml）以启用动态调度器插件并配置插件参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubescheduler.config.k8s.io/v1beta2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeSchedulerConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l">default-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">plugins</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">filter</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Dynamic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">score</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Dynamic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pluginConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Dynamic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">policyConfigPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/policy.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></div><p>/etc/kubernetes/policy.yaml 就是 4.3.1 中的 <code>DynamicSchedulerPolicy</code> 资源对象</p>
<p>修改 kube-scheduler.yaml，并将 kube 调度器映像替换为 Crane schedule</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/gocrane/crane-scheduler:0.0.23</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></div><p>安装 crane-scheduler-controller</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl apply ./deploy/controller/rbac.yaml <span class="o">&amp;&amp;</span> kubectl apply -f ./deploy/controller/deployment.yaml
</span></span></code></pre></div></li>
</ol>
<h2 id="真实环境测试">真实环境测试</h2>
<p>crane-sheduler 会将监控指标数据写在 node annotation 上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">metadata：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu_usage_avg_5m</span><span class="p">:</span><span class="w"> </span><span class="m">0.15079</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpu_usage_max_avg_ld</span><span class="p">:</span><span class="w"> </span><span class="m">0.16196</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cpuusage_max_avg_lh</span><span class="p">:</span><span class="w"> </span><span class="m">0.15790</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mem_usage_avg_5m</span><span class="p">:</span><span class="w"> </span><span class="m">0.89633</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mem_usage_max_avg_ld</span><span class="p">:</span><span class="w"> </span><span class="m">0.89753</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mem_usage_max_avg_lh</span><span class="p">:</span><span class="w"> </span><span class="m">0.89797</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">node.alpha.kubernetes.io/ttl</span><span class="p">:</span><span class="w"> </span><span class="l">&#39;0° </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">node hot value</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w"> 
</span></span></span></code></pre></div><h3 id="内存型服务测试">内存型服务测试</h3>
<p>测试服务单副本实际占用 2C 20G，申请资源 5C 40G：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">stress-ng </span><span class="w"> </span><span class="c"># 压力测试镜像工具</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;stress&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--vm&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--vm-bytes&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;20G&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--vm-keep&#34;</span><span class="p">]</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;40Gi&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">limits</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;80Gi&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w"> 
</span></span></span></code></pre></div><p><strong>k8s 默认调度器结果（%）</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/crane-scheduler/3_hu15307104234425467051.webp 400w,
               /blog/crane-scheduler/3_hu8958764653006593281.webp 760w,
               /blog/crane-scheduler/3_hu4637347686500701994.webp 1200w"
               src="/blog/crane-scheduler/3_hu15307104234425467051.webp"
               width="760"
               height="338"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>默认调度器根据 资源申请值<code>request</code> 调度服务，且节点间分布不均衡</p>
<p>当副本数到达 12 个时，默认调度器出现了资源分配严重不均的情况，且一些服务被挤占，出现 CrashLoopBackOff 错误：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">crone-system prometheus-prometheus-node-exporter-6rjvj           1/1 Running          <span class="m">1</span> 6d18h 
</span></span><span class="line"><span class="cl">crone-system prometheus-prometheus-node-exporter-g6gfm           0/1 CrashLoopBackOff <span class="m">9</span> 6d18h 
</span></span><span class="line"><span class="cl">crane-system prometheus-prometheus-node-exporter-kqbhf           1/1 Running          <span class="m">0</span> 6d18h 
</span></span><span class="line"><span class="cl">crone-system prometheus-prometheus-pushgoteway-78d668c9bd-91xpz  0/1 CrashLoopBackOff <span class="m">7</span> 6d17h 
</span></span><span class="line"><span class="cl">crone-system prometheus-server-6b84bbfc4f-25hpc                  0/2 CrashLoopBackOff <span class="m">2</span> 2m41s 
</span></span></code></pre></div><p><strong>crane-schedule 调度器结果（%）</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/crane-scheduler/4_hu5019214120491774895.webp 400w,
               /blog/crane-scheduler/4_hu15821738982355632927.webp 760w,
               /blog/crane-scheduler/4_hu6364654231373537467.webp 1200w"
               src="/blog/crane-scheduler/4_hu5019214120491774895.webp"
               width="760"
               height="451"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>当启动 11 个服务的时候，node03 中的<code>mem_usage_avg_5m</code>指标过高，禁止调度：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Events: 
</span></span><span class="line"><span class="cl">  Type     Reason              From             Message 
</span></span><span class="line"><span class="cl">Warning    FailedScheduling    crane-scheduler  0/3 nodes are available:1 Load<span class="o">[</span>mem_usage_avg_5m<span class="o">]</span> of <span class="o">[</span>node-03<span class="o">]</span> is too high, <span class="m">2</span> Insufficient memory           
</span></span></code></pre></div><h3 id="cpu-型服务测试">CPU 型服务测试</h3>
<p>测试服务单副本实际占用 8C 8G，申请资源 12C 12G</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">stress-ng </span><span class="w"> </span><span class="c"># 压力测试镜像工具</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;stress&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;8&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--vm&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--vm-bytes&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;8G&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--vm-keep&#34;</span><span class="p">]</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;12Gi&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;12&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">limits</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;12Gi&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;12&#34;</span><span class="w"> 
</span></span></span></code></pre></div><p><strong>k8s 默认调度器结果（%）</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/crane-scheduler/5_hu11348806957678322396.webp 400w,
               /blog/crane-scheduler/5_hu7456825060691648131.webp 760w,
               /blog/crane-scheduler/5_hu5039853368663637068.webp 1200w"
               src="/blog/crane-scheduler/5_hu11348806957678322396.webp"
               width="760"
               height="533"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>当启动 9 个服务的时候，出现 Insufficient cpu 的情况：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Events: 
</span></span><span class="line"><span class="cl">  Type     Reason              From               Message 
</span></span><span class="line"><span class="cl">Warning    FailedScheduling    default-scheduler  0/3 nodes are available: <span class="m">3</span> Insufficient memory                                
</span></span></code></pre></div><p><strong>crane-schedule 调度器结果（%）</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/crane-scheduler/6_hu10667869010444614950.webp 400w,
               /blog/crane-scheduler/6_hu2889123866889467339.webp 760w,
               /blog/crane-scheduler/6_hu17752341916289989275.webp 1200w"
               src="/blog/crane-scheduler/6_hu10667869010444614950.webp"
               width="758"
               height="578"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>当启动 8 服务的时候，node03 中的<code>mem_usage_avg_5m</code>指标过高，禁止调度：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Events: 
</span></span><span class="line"><span class="cl">  Type     Reason              From               Message 
</span></span><span class="line"><span class="cl">Warning    FailedScheduling    crane-scheduler    0/3 nodes are available: <span class="m">1</span> Load<span class="o">[</span>mem_usage_avg_5m<span class="o">]</span> of <span class="o">[</span>node-03<span class="o">]</span> is too high, <span class="m">2</span> Insufficient cpu
</span></span></code></pre></div><h2 id="总结">总结</h2>
<p>crane-scheduler 基于 prometheus 集群真实资源负载进行调度，经过在 linux 环境上的压力测试，与 k8s 默认的调度器相比，结果标明：</p>
<ol>
<li>crane-scheduler 应用于调度过程中的 Filter 和 Score 阶段，能够根据自定义指标实现资源的调度，在一定程度上缓解节点资源负载不均的问题；</li>
<li>crane-scheduler 通过设置水位线和热点限制，能够有效防止节点资源过载的情况发生；</li>
<li>但是在测试过程中，也发现当节点 request 接近 100% 时，尽管该节点真实使用率很低，crane-scheduler 是不能够调度上去的。为了进一步提高节点的资源利用率，后续需要考虑突破节点 request 值的限制，一种做法是屏蔽 k8s 对节点 request 值的校验，但是这样做法对 k8s 原生组件侵入性较大；另一种可行性较高的做法是通过资源的超卖去实现，利用节点的空闲资源区部署一些不重要的应用。</li>
</ol>
<h2 id="参考文献">参考文献</h2>
<ol>
<li><a href="http://kubernetes.p2hp.com/docs/" target="_blank" rel="noopener">http://kubernetes.p2hp.com/docs/</a></li>
<li><a href="https://www.qikqiak.com/post/custom-kube-scheduler/" target="_blank" rel="noopener">https://www.qikqiak.com/post/custom-kube-scheduler/</a></li>
<li><a href="https://gocrane.io/zh-cn/docs/tutorials/dynamic-scheduler-plugin/" target="_blank" rel="noopener">https://gocrane.io/zh-cn/docs/tutorials/dynamic-scheduler-plugin/</a></li>
<li><a href="https://github.com/gocrane/crane-scheduler" target="_blank" rel="noopener">https://github.com/gocrane/crane-scheduler</a></li>
<li><a href="https://blog.51cto.com/u_14120339/5363877" target="_blank" rel="noopener">https://blog.51cto.com/u_14120339/5363877</a></li>
</ol>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/prometheus/">Prometheus</a>
  
  <a class="badge badge-light" href="/tag/%E7%9B%91%E6%8E%A7/">监控</a>
  
  <a class="badge badge-light" href="/tag/victoriametrics/">VictoriaMetrics</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E5%8C%A1%E6%BE%84/"><img class="avatar mr-3 avatar-circle" src="/author/%E5%8C%A1%E6%BE%84/avatar_hu11707607627646792637.jpg" alt="匡澄"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E5%8C%A1%E6%BE%84/">匡澄</a></p>
      <p class="card-subtitle">中国移动云能力中心助理软件研发工程师</p>
      <p class="card-text">专注于云原生、微服务、算力网络等领域。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/what-is-cnapp/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>什么是 CNAPP（容器化应用保护平台）?</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/cloudnative-ci-argo-workflow/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>Argo Workflow 介绍：一款强大的云原生持续集成工具</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/crane-scheduler/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/victoriametrics/">优化云原生监控体验：VictoriaMetrics 入门指南</a></li>
      
      <li><a href="/blog/advanced-guide-for-cloudnative-architects/">云原生架构师进阶指南</a></li>
      
      <li><a href="/blog/why-are-prometheus-queries-hard/">为什么 Prometheus 查询很难？</a></li>
      
      <li><a href="/blog/the-importance-of-metadata-in-observability/">论元数据在可观测性中的重要性</a></li>
      
      <li><a href="/blog/custom-application-metrics-with-django-prometheus-and-kubernetes/">使用 Django，Prometheus，和 Kubernetes 定制应用指标</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnativecn.com",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2024 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.4684ca30d68fb8aed8d4debfcc18beed.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.85fc5fdbc5de9f11d741a1c4a48fe458.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
