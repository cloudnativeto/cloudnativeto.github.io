<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>在 Istio 中实现 Redis 集群的数据分片、读写分离和流量镜像 | 云原生社区</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文将介绍如何通过 Istio 和 Envoy 实现客户端无感知的 Redis Cluster 数据分片，并实现读写分离、流量镜像等高级流量管理功能。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="本文将介绍如何通过 Istio 和 Envoy 实现客户端无感知的 Redis Cluster 数据分片，并实现读写分离、流量镜像等高级流量管理功能。" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/redis-cluster-with-istio/" />
  <meta property="og:title" content="在 Istio 中实现 Redis 集群的数据分片、读写分离和流量镜像" />
  <meta property="og:description" content="本文将介绍如何通过 Istio 和 Envoy 实现客户端无感知的 Redis Cluster 数据分片，并实现读写分离、流量镜像等高级流量管理功能。" />
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png" />
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                兴趣小组
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="https://i.cloudnative.to/kubernetes/">Kubernetes SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/istio/">Istio SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/envoy/">Envoy SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/dapr/">Dapr SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/oam/">OAM SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/stability/">稳定性 SIG</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                博客
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/categories/kubernetes">Kubernetes</a>
                
                <a class="dropdown-item" href="/categories/service-mesh">Service Mesh</a>
                
                <a class="dropdown-item" href="/categories/envoy">Envoy</a>
                
                <a class="dropdown-item" href="/categories/oam">OAM</a>
                
                <a class="dropdown-item" href="/categories/%E5%BC%80%E6%BA%90%E7%A4%BE%E5%8C%BA">开源社区</a>
                
                <a class="dropdown-item" href="/blog">所有</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/academy">云原生学院分享归档</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                关于
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/about">介绍</a>
                
                <a class="dropdown-item" href="/contact">联系</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">在 Istio 中实现 Redis 集群的数据分片、读写分离和流量镜像</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">本文将介绍如何通过 Istio 和 Envoy 实现客户端无感知的 Redis Cluster 数据分片，并实现读写分离、流量镜像等高级流量管理功能。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='https:\/\/images.pexels.com\/photos\/358326\/pexels-photo-358326.jpeg?cs=srgb\x26dl=pexels-pixabay-358326.jpg\x26fm=jpg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">Service Mesh</div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://zhaohuabing.com">赵化冰</a></strong>
          
            发表于 <strong class="text-dark">2020年10月26日</strong></div>
        <hr>
        <div class="content">
          <p>Redis 是一个高性能的 key-value 存储系统，被广泛用于微服务架构中。如果我们想要使用 Redis 集群模式提供的高级特性，则需要对客户端代码进行改动，这带来了应用升级和维护的一些困难。利用 Istio 和 Envoy ，我们可以在不修改客户端代码的前提下实现客户端无感知的 Redis Cluster 数据分片，并提供读写分离、流量镜像等高级流量管理功能。</p>
<h2 id="redis-cluster">Redis Cluster</h2>
<p>Redis 的一个常见用途是用作数据高速缓存。通过在应用服务器和数据库服务器之间加入一个 Redis 缓存层，可以减少应用服务器对数据库的大量读操作，避免数据库服务器在大压力下响应缓慢甚至宕机的风险，显著加强整个系统的健壮性。Redis 作为数据缓存的原理如图所示：</p>
<p><img src="images/redis-as-cache.png" alt=""></p>
<p>在一个小规模的系统中，上图所示的单个 Redis 就可以很好地实现缓存层的功能。当系统中需要缓存的数据量较大时，一个 Redis 服务器无法承担所有应用服务器的缓存需求；同时单个 Redis 实例失效时也会导致大量读请求被直接发送到后端的数据库服务器上，导致数据库服务器瞬时压力超标，影响系统的稳定性。我们可以采用 <a href="https://redis.io/topics/cluster-spec">Redis Cluster</a> 来对缓存数据进行分片，将不同的数据放到不同的 Redis 分片中，以提高 Redis 缓存层的容量能力。在每个 Redis 分片中，还可以采用多个 replica 节点对缓存的读请求进行负载分担，并实现 Redis 的高可用。采用了 Redis Cluster 的系统如下图所示：</p>
<p><img src="images/redis-cluster-no-proxy.png" alt=""></p>
<p>从图中可以看到，在 Redis Cluster 模式下，客户端需要根据集群的分片规则将不同 key 的读写操作发送到集群中不同的 Redis 节点上，因此客户端需要了解 Redis Cluster 的拓扑结构，这导致我们无法在不修改客户端的情况下将一个使用 Redis 独立节点模式的应用平滑迁移到 Redis Cluster 上。另外，由于客户端需要了解 Redis Cluster 的内部拓扑，也将导致客户端代码和 Redis Cluster 运维上的耦合，例如要实现读写分离或者流量镜像的话，就需要修改每个客户端的代码并重新部署。</p>
<p>这种场景下，我们可以在应用服务器和 Redis Cluster 之间放置一个 Envoy 代理服务器，由 Envoy 来负责将应用发出的缓存读写请求路由到正确的 Redis 节点上。一个微服务系统中存在大量需要访问缓存服务器的应用进程，为了避免单点故障和性能瓶颈，我们以 Sidecar 的形式为每个应用进程部署一个 Envoy 代理。同时，为了简化对这些代理的管理工作，我们可以采用 Istio 作为控制面来统一对所有 Envoy 代理进行配置,如下图所示：</p>
<p><img src="images/redis-cluster-with-proxy.png" alt=""></p>
<p>在本文的后续部分，我们将介绍如何通过 Istio 和 Envoy 来管理 Redis Cluster，实现客户端无感知的数据分区，以及读写分离、流量镜像等高级路由策略。</p>
<h2 id="部署-istio">部署 Istio</h2>
<p>Pilot 中已经支持了 Redis 协议，但功能较弱，只能为 Redis 代理配置一个缺省路由，而且不支持 Redis Cluster 模式，无法实现 Redis filter 的数据分片、读写分离、流量镜像等高级流量管理功能。为了让 Istio 可以将 Redis Cluster 相关的配置下发到 Envoy Sidecar 上，我们修改了 EnvoyFilter 配置相关代码，以支持 EnvoyFilter 的 &ldquo;REPLCAE&rdquo; 操作。该修改的 PR <a href="https://github.com/istio/istio/pull/27426/">Implement REPLACE operation for EnvoyFilter patch</a> 已经提交到 Istio 社区，并合入到了主分支中，将在 Istio 后续的版本中发布。</p>
<p>在撰写本文的时候，最新的 Istio 发布版本 1.7.3 中尚未合入该 PR。因此我构建了一个 Pilot 镜像，以启用 EnvoyFilter 的 &ldquo;REPLACE&rdquo; 操作。在安装 Istio 时，我们需要在 istioctl 命令中指定采用该 Pilot 镜像，如下面的命令行所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd istio-1.7.3/bin
$ ./istioctl install --set components.pilot.hub<span style="color:#f92672">=</span>zhaohuabing --set components.pilot.tag<span style="color:#f92672">=</span>1.7.3-enable-ef-replace
</code></pre></div><p>备注：如果你采用的 Istio 版本新于 1.7.3，并且已经合入了该 PR，则可以直接采用 Istio 版本中缺省的 Pilot 镜像。</p>
<h2 id="部署-redis-cluster">部署 Redis Cluster</h2>
<p>请从 <a href="https://github.com/zhaohuabing/istio-redis-culster">https://github.com/zhaohuabing/istio-redis-culster</a> 下载下面示例中需要用到的相关代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/zhaohuabing/istio-redis-culster.git
$ cd istio-redis-culster
</code></pre></div><p>我们创建一个 &ldquo;redis&rdquo; namespace 来部署本例中的 Redis Cluster。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl create ns redis
namespace/redis created
</code></pre></div><p>部署 Redis 服务器的 Statefulset 和 Configmap。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f k8s/redis-cluster.yaml -n redis
configmap/redis-cluster created
statefulset.apps/redis-cluster created
service/redis-cluster created
</code></pre></div><h3 id="验证-redis-部署">验证 Redis 部署</h3>
<p>确认 Redis 节点已经启动并正常运行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get pod -n redis
NAME              READY   STATUS    RESTARTS   AGE
redis-cluster-0   2/2     Running   <span style="color:#ae81ff">0</span>          4m25s
redis-cluster-1   2/2     Running   <span style="color:#ae81ff">0</span>          3m56s
redis-cluster-2   2/2     Running   <span style="color:#ae81ff">0</span>          3m28s
redis-cluster-3   2/2     Running   <span style="color:#ae81ff">0</span>          2m58s
redis-cluster-4   2/2     Running   <span style="color:#ae81ff">0</span>          2m27s
redis-cluster-5   2/2     Running   <span style="color:#ae81ff">0</span>          117s
</code></pre></div><h3 id="创建-redis-cluster">创建 Redis Cluster</h3>
<p>在上面的步骤中，我们采用 Statefulset 部署了6个 Redis 节点，但目前这6个节点还是相互独立的，并未形成一个集群。下面我们采用 Redis 的 <code>cluster create</code> 命令将这些节点组成一个 Redis Cluster。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -it redis-cluster-0 -n redis -- redis-cli --cluster create --cluster-replicas <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">$(</span>kubectl get pods -l app<span style="color:#f92672">=</span>redis-cluster -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{range.items[*]}{.status.podIP}:6379 &#39;</span> -n redis<span style="color:#66d9ef">)</span>
Defaulting container name to redis.
Use <span style="color:#e6db74">&#39;kubectl describe pod/redis-cluster-0 -n redis&#39;</span> to see all of the containers in this pod.
&gt;&gt;&gt; Performing hash slots allocation on <span style="color:#ae81ff">6</span> nodes...
Master<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> -&gt; Slots <span style="color:#ae81ff">0</span> - <span style="color:#ae81ff">5460</span>
Master<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> -&gt; Slots <span style="color:#ae81ff">5461</span> - <span style="color:#ae81ff">10922</span>
Master<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> -&gt; Slots <span style="color:#ae81ff">10923</span> - <span style="color:#ae81ff">16383</span>
Adding replica 172.16.0.72:6379 to 172.16.0.138:6379
Adding replica 172.16.0.201:6379 to 172.16.1.52:6379
Adding replica 172.16.0.139:6379 to 172.16.1.53:6379
M: 8fdc7aa28a6217b049a2265b87bff9723f202af0 172.16.0.138:6379
   slots:<span style="color:#f92672">[</span>0-5460<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
M: 4dd6c1fecbbe4527e7d0de61b655e8b74b411e4c 172.16.1.52:6379
   slots:<span style="color:#f92672">[</span>5461-10922<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5462</span> slots<span style="color:#f92672">)</span> master
M: 0b86a0fbe76cdd4b48434b616b759936ca99d71c 172.16.1.53:6379
   slots:<span style="color:#f92672">[</span>10923-16383<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
S: 94b139d247e9274b553c82fbbc6897bfd6d7f693 172.16.0.139:6379
   replicates 0b86a0fbe76cdd4b48434b616b759936ca99d71c
S: e293d25881c3cf6db86034cd9c26a1af29bc585a 172.16.0.72:6379
   replicates 8fdc7aa28a6217b049a2265b87bff9723f202af0
S: ab897de0eca1376558e006c5b0a49f5004252eb6 172.16.0.201:6379
   replicates 4dd6c1fecbbe4527e7d0de61b655e8b74b411e4c
Can I set the above configuration? <span style="color:#f92672">(</span>type <span style="color:#e6db74">&#39;yes&#39;</span> to accept<span style="color:#f92672">)</span>: yes
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting <span style="color:#66d9ef">for</span> the cluster to join
.
&gt;&gt;&gt; Performing Cluster Check <span style="color:#f92672">(</span>using node 172.16.0.138:6379<span style="color:#f92672">)</span>
M: 8fdc7aa28a6217b049a2265b87bff9723f202af0 172.16.0.138:6379
   slots:<span style="color:#f92672">[</span>0-5460<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
M: 4dd6c1fecbbe4527e7d0de61b655e8b74b411e4c 172.16.1.52:6379
   slots:<span style="color:#f92672">[</span>5461-10922<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5462</span> slots<span style="color:#f92672">)</span> master
   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
S: 94b139d247e9274b553c82fbbc6897bfd6d7f693 172.16.0.139:6379
   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
   replicates 0b86a0fbe76cdd4b48434b616b759936ca99d71c
M: 0b86a0fbe76cdd4b48434b616b759936ca99d71c 172.16.1.53:6379
   slots:<span style="color:#f92672">[</span>10923-16383<span style="color:#f92672">]</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">5461</span> slots<span style="color:#f92672">)</span> master
   <span style="color:#ae81ff">1</span> additional replica<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
S: ab897de0eca1376558e006c5b0a49f5004252eb6 172.16.0.201:6379
   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
   replicates 4dd6c1fecbbe4527e7d0de61b655e8b74b411e4c
S: e293d25881c3cf6db86034cd9c26a1af29bc585a 172.16.0.72:6379
   slots: <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> slots<span style="color:#f92672">)</span> slave
   replicates 8fdc7aa28a6217b049a2265b87bff9723f202af0
<span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span> All nodes agree about slots configuration.
&gt;&gt;&gt; Check <span style="color:#66d9ef">for</span> open slots...
&gt;&gt;&gt; Check slots coverage...
<span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span> All <span style="color:#ae81ff">16384</span> slots covered.
</code></pre></div><h3 id="验证-redis-cluster">验证 Redis Cluster</h3>
<p>我们可以采用 <code>cluster info</code> 命令查看 Redis Cluster 的配置信息和 Cluster 中的成员节点，以验证集群是否创建成功。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -it redis-cluster-0 -c redis -n redis -- redis-cli cluster info 
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:206
cluster_stats_messages_pong_sent:210
cluster_stats_messages_sent:416
cluster_stats_messages_ping_received:205
cluster_stats_messages_pong_received:206
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:416
</code></pre></div><h3 id="部署测试用客户端">部署测试用客户端</h3>
<p>我们部署一个客户端，以用于发送测试命令:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f k8s/redis-client.yaml -n redis
deployment.apps/redis-client created
</code></pre></div><h2 id="通过-istio-下发-redis-cluster-相关的-envoy-配置">通过 Istio 下发 Redis Cluster 相关的 Envoy 配置</h2>
<p>在下面的步骤中，我们将通过 Istio 向 Envoy Sidecar 下发 Redis Cluster 相关配置，以在无需改动客户端的情况下启用 Redis Cluster 的高级功能，包括数据分片、读写分离和流量镜像。</p>
<h3 id="创建-envoy-redis-cluster">创建 Envoy Redis Cluster</h3>
<p>Envoy 提供了 &ldquo;envoy.clusters.redis&rdquo; 类型的 Envoy Cluster 来连接后端的 Redis Cluster，Envoy 会通过该 Cluster 获取后端 Redis Cluster 的拓扑结构，包括有多少个分片（shard），每个分片负责哪些 slot，以及分片中包含哪些节点，以将来自客户端的请求分发到正确的 Redis 节点上。</p>
<p>采用 EnvoyFilter 来创建所需的 Envoy Redis Cluster：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f istio/envoyfilter-custom-redis-cluster.yaml
envoyfilter.networking.istio.io/custom-redis-cluster created
</code></pre></div><h3 id="创建-envoy-redis-proxy">创建 Envoy Redis Proxy</h3>
<p>Istio 缺省下发的 LDS 中配置的是 TCP proxy filter，我们需要将其替换为 Redis Proxy filter。</p>
<p>由于 1.7.3 中尚不支持 EnvoyFilter 的 &ldquo;REPLACE&rdquo; 操作，我们首先需要更新 EnvoyFilter 的 CRD 定义，然后才能创建该 EnvoyFilter：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f istio/envoyfilter-crd.yaml 
customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io configured
</code></pre></div><p>采用 EnvoyFilter 来将 TCP proxy filter 替换为 Redis Proxy filter，以使 Envoy 可以代理来自客户端的 Redis 操作请求：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sed -i .bak <span style="color:#e6db74">&#34;s/\${REDIS_VIP}/`kubectl get svc redis-cluster -n redis -o=jsonpath=&#39;{.spec.clusterIP}&#39;`/&#34;</span> istio/envoyfilter-redis-proxy.yaml
$ kubectl apply -f istio/envoyfilter-redis-proxy.yaml
envoyfilter.networking.istio.io/add-redis-proxy created
</code></pre></div><h2 id="验证-redis-cluster-功能">验证 Redis Cluster 功能</h2>
<p>现在一切就绪，下面我们来验证 Redis Cluster 的各项功能。</p>
<h3 id="redis-数据分片">Redis 数据分片</h3>
<p>我们通过 Istio 将 EnvoyFilter 中定义的配置下发到 Envoy 后，Envoy 就能够自动发现后端 Redis Cluster 的拓扑结构，并根据客户端请求中的 key 将请求自动分发到 Redis Cluster 中正确的节点上。</p>
<p>根据前面创建 Redis Cluster 步骤中的命令行输出，我们可以看出该 Redis Cluster 的拓扑结构：Cluster 中有三个分片，每个分片中有一个 Master 节点，一个 Slave(Replica) 节点。客户端通过和其部署在同一个 Pod 中的 Envoy Proxy 访问 Redis Cluster，如下图所示：</p>
<p><img src="images/redis-cluster.png" alt=""></p>
<p>Redis Cluster 中各个分片的 Master 和 Slave 节点地址：</p>
<pre><code>Shard[0] Master[0]  redis-cluster-0 172.16.0.138:6379   replica  redis-cluster-4 172.16.0.72:6379  -&gt; Slots 0 - 5460 
Shard[1] Master[1]  redis-cluster-1 172.16.1.52:6379    replica  redis-cluster-5 172.16.0.201:6379 -&gt; Slots 5461 - 10922
Shard[2] Master[2]  redis-cluster-2 172.16.1.53:6379    replica  redis-cluster-3 172.16.0.139:6379 -&gt; Slots 10923 - 16383
</code></pre><p>备注：如果你在自己的 K8s cluster 中部署该示例，那么 Redis Cluster 中各个节点的 IP 地址和拓扑结构可能稍有不同，但基本结构应该是类似的。</p>
<p>我们尝试从客户端向 Rdeis Cluster 发送一些不同 key 的 <code>set</code> 请求:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -it <span style="color:#e6db74">`</span>kubectl get pod -l app<span style="color:#f92672">=</span>redis-client -n redis -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#e6db74">`</span> -c redis-client -n redis -- redis-cli -h redis-cluster
redis-cluster:6379&gt; set a a
OK
redis-cluster:6379&gt; set b b
OK
redis-cluster:6379&gt; set c c
OK
redis-cluster:6379&gt; set d d
OK
redis-cluster:6379&gt; set e e
OK
redis-cluster:6379&gt; set f f
OK
redis-cluster:6379&gt; set g g
OK
redis-cluster:6379&gt; set h h
OK
</code></pre></div><p>从客户端来看，所有的请求都成功了，我们可以使用 <code>scan</code> 命令在服务器端查看各个节点中的数据：</p>
<p>查看分片 Shard[0] 中的数据，master 节点是 redis-cluster-0 slave 节点是 redis-cluster-4。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec redis-cluster-0 -c redis -n redis -- redis-cli --scan
b
f
$ kubectl exec redis-cluster-4 -c redis -n redis -- redis-cli --scan
f
b
</code></pre></div><p>查看分片 Shard[1] 中的数据，master 节点是 redis-cluster-1 slave 节点是 redis-cluster-5。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec redis-cluster-1 -c redis -n redis -- redis-cli --scan
c
g
$ kubectl exec redis-cluster-5 -c redis -n redis -- redis-cli --scan
g
c
</code></pre></div><p>查看分片 Shard[2] 中的数据，master 节点是 redis-cluster-2 slave 节点是 redis-cluster-3。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec redis-cluster-2 -c redis -n redis -- redis-cli --scan
a
e
d
h
$ kubectl exec redis-cluster-3 -c redis -n redis -- redis-cli --scan
h
e
d
a
</code></pre></div><p>从上面的验证结果中可以看到，客户端设置的数据被分发到了 Redis Cluster 中的三个分片中。该数据分发过程是由 Envoy Redis Proxy 自动实现的，客户端并不感知后端的 Redis Cluster，对客户端而言，和该 Redis Cluster 的交互与和一个单一 Redis 节点的交互是相同的。</p>
<p>采用该方法，我们可以在应用业务规模逐渐扩张，单一 Redis 节点压力过大时，将系统中的 Redis 从单节点无缝迁移到集群模式。在集群模式下，不同 key 的数据被缓存在不同的数据分片中，我们可以增加分片中 Replica 节点的数量来对一个分片进行扩容，也可以增加分片个数来对整个集群进行扩展，以应对由于业务不断扩展而增加的数据压力。由于 Envoy 可以感知 Redis Cluster 集群拓扑，数据的分发由 Envoy 完成，整个迁移和扩容过程无需客户端，不会影响到线上业务的正常运行。</p>
<h3 id="redis-读写分离">Redis 读写分离</h3>
<p>在一个 Redis 分片中，通常有一个 Master 节点，一到多个 Slave（Replica）节点，Master 节点负责写操作，并将数据变化同步到 Slave 节点。当来自应用的读操作压力较大时，我们可以在分片中增加更多的 Replica，以对读操作进行负载分担。Envoy Redis Rroxy 支持设置不同的读策略：</p>
<ul>
<li><strong>MASTER：</strong>        只从 Master 节点读取数据，当客户端要求数据强一致性时需要采用该模式。该模式对 Master 压力较大，在同一个分片内无法采用多个节点对读操作进行负载分担。</li>
<li><strong>PREFER_MASTER：</strong>   优先从 Master 节点读取数据，当 Master 节点不可用时，从 Replica 节点读取。</li>
<li><strong>REPLICA：</strong>         只从 Replica 节点读取数据，由于 Master 到 Replica 的数据复制过程是异步执行的，采用该方式有可能读取到过期的数据，因此适用于客户端对数据一致性要求不高的场景。该模式下可以采用多个 Replica 节点来分担来自客户端的读负载。</li>
<li><strong>PREFER_REPLICA：</strong>  优先从 Replica 节点读取数据，当 Replica 节点不可用时，从 Master 节点读取。</li>
<li><strong>ANY：</strong>             从任意节点读取数据。</li>
</ul>
<p>在前面下发的 EnvoyFilter 中，我们将 Envoy Redis Proxy 的读策略设置为了 &ldquo;REPLICA&rdquo;， 因此客户端的读操作应该只会被发送到 Replica 节点。让我们使用下面的命令来验证读写分离的策略:</p>
<p>通过客户端发起一系列 key 为 &ldquo;b&rdquo; 的 <code>get</code> 和 <code>set</code> 操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -it <span style="color:#e6db74">`</span>kubectl get pod -l app<span style="color:#f92672">=</span>redis-client -n redis -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#e6db74">`</span> -c redis-client -n redis -- redis-cli -h redis-cluster

redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;b&#34;</span>
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;b&#34;</span>
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;b&#34;</span>
redis-cluster:6379&gt; set b bb
OK
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;bb&#34;</span>
redis-cluster:6379&gt; 
</code></pre></div><p>在前面的 Redis Cluster 拓扑中，我们已经得知 key &ldquo;b&rdquo; 属于 Shard[0] 这个分片。我们可以通过命令 <code>redis-cli monitor</code> 查看该分片中 Master 和 Replica 节点中收到的命令。</p>
<p>Master 节点：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec redis-cluster-0 -c redis -n redis -- redis-cli monitor
</code></pre></div><p>Slave 节点:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec redis-cluster-4 -c redis -n redis -- redis-cli monitor
</code></pre></div><p>从下图中可以看到，所有 <code>get</code> 请求都被 Envoy 发送到了 Replica 节点上。
<img src="images/redis-cluster-read-policy.png" alt=""></p>
<h3 id="redis-流量镜像">Redis 流量镜像</h3>
<p>Envoy Redis Proxy 支持流量镜像，即将客户端发送的请求同时发送到一个镜像 Redis 服务器/集群上。流量镜像是一个非常有用的功能，我们可以使用流量镜像将生产环境中的线上数据导入到测试环境中，以使用线上数据对应用进行尽可能真实的模拟测试，同时又不会影响到线上用户的正常使用。</p>
<p>我们创建一个单节点的 Redis 节点，用做镜像服务器：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f k8s/redis-mirror.yaml -n redis 
deployment.apps/redis-mirror created
service/redis-mirror created
</code></pre></div><p>采用 EnvoFilter 来启用镜像策略：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sed -i .bak <span style="color:#e6db74">&#34;s/\${REDIS_VIP}/`kubectl get svc redis-cluster -n redis -o=jsonpath=&#39;{.spec.clusterIP}&#39;`/&#34;</span> istio/envoyfilter-redis-proxy-with-mirror.yaml
$ kubectl apply -f istio/envoyfilter-redis-proxy-with-mirror.yaml
envoyfilter.networking.istio.io/add-redis-proxy configured
</code></pre></div><p>通过客户端发起一系列 key 为 &ldquo;b&rdquo; 的 <code>get</code> 和 <code>set</code> 操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -it <span style="color:#e6db74">`</span>kubectl get pod -l app<span style="color:#f92672">=</span>redis-client -n redis -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#e6db74">`</span> -c redis-client -n redis -- redis-cli -h redis-cluster
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;b&#34;</span>
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;b&#34;</span>
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;b&#34;</span>
redis-cluster:6379&gt; set b bb
OK
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;bb&#34;</span>
redis-cluster:6379&gt; set b bbb
OK
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;bbb&#34;</span>
redis-cluster:6379&gt; get b
<span style="color:#e6db74">&#34;bbb&#34;</span>
</code></pre></div><p>可以通过命令 <code>redis-cli monitor</code> 分别查看 Master、Replica 和镜像节点中收到的命令。</p>
<p>Master 节点:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec redis-cluster-0 -c redis -n redis -- redis-cli monitor
</code></pre></div><p>Slave 节点:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec redis-cluster-4 -c redis -n redis -- redis-cli monitor
</code></pre></div><p>镜像节点:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec -it <span style="color:#e6db74">`</span>kubectl get pod -l app<span style="color:#f92672">=</span>redis-mirror -n redis -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#e6db74">`</span> -c redis-mirror -n redis -- redis-cli monitor
</code></pre></div><p>从下图中可以看到，所有 <code>set</code> 请求都被 Envoy 发送到了一份镜像节点上。
<img src="images/redis-cluster-mirror-policy.png" alt=""></p>
<h2 id="实现原理">实现原理</h2>
<p>在上面的步骤中，我们在 Istio 中创建了两个 EnvoyFilter 配置对象。这两个 EnvoyFilter 修改了 Envoy 代理的配置，主要包括两部分内容：Redis Proxy Network Filter 配置和 Redis Cluster 配置。</p>
<p>下面的 EnvoyFilter 替换了 Pilot 为 Redis Service 创建的 Listener 中的 TCP Proxy Network Filter，将其替换为一个 &ldquo;type.googleapis.com/envoy.config.filter.network.redis_proxy.v2.RedisProxy&rdquo; 类型的 Network Filter。 该 Redis Proxy 的缺省路由指向 &ldquo;custom-redis-cluster&rdquo;，并且配置了读写分离策略和流量镜像策略。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#66d9ef">kind</span>: EnvoyFilter
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: add-redis-proxy
  <span style="color:#66d9ef">namespace</span>: istio-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">configPatches</span>:
  - <span style="color:#66d9ef">applyTo</span>: NETWORK_FILTER
    <span style="color:#66d9ef">match</span>:
      <span style="color:#66d9ef">listener</span>:
        <span style="color:#66d9ef">name</span>: ${REDIS_VIP}_6379             <span style="color:#75715e"># Replace REDIS_VIP with the cluster IP of &#34;redis-cluster service</span>
        <span style="color:#66d9ef">filterChain</span>:
          <span style="color:#66d9ef">filter</span>:
            <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;envoy.filters.network.tcp_proxy&#34;</span>
    <span style="color:#66d9ef">patch</span>:
      <span style="color:#66d9ef">operation</span>: REPLACE
      <span style="color:#66d9ef">value</span>:
        <span style="color:#66d9ef">name</span>: envoy.redis_proxy
        <span style="color:#66d9ef">typed_config</span>:
          <span style="color:#66d9ef">&#34;@type&#34;: </span>type.googleapis.com/envoy.config.filter.network.redis_proxy.v2.RedisProxy
          <span style="color:#66d9ef">stat_prefix</span>: redis_stats
          <span style="color:#66d9ef">prefix_routes</span>:
            <span style="color:#66d9ef">catch_all_route</span>:
              <span style="color:#66d9ef">request_mirror_policy</span>:            <span style="color:#75715e"># Send requests to the mirror cluster</span>
              - <span style="color:#66d9ef">cluster</span>: outbound|<span style="color:#ae81ff">6379</span>||redis-mirror.redis.svc.cluster.local
                <span style="color:#66d9ef">exclude_read_commands</span>: <span style="color:#66d9ef">True     # Mirror write commands only</span>:
              <span style="color:#66d9ef">cluster</span>: custom-redis-cluster
          <span style="color:#66d9ef">settings</span>:
            <span style="color:#66d9ef">op_timeout</span>: 5s
            <span style="color:#66d9ef">enable_redirection</span>: <span style="color:#66d9ef">true</span>
            <span style="color:#66d9ef">enable_command_stats</span>: <span style="color:#66d9ef">true</span>
            <span style="color:#66d9ef">read_policy</span>: REPLICA               <span style="color:#75715e"># Send read requests to replica</span>
</code></pre></div><p>下面的 EnvoyFilter 在 Pilot 下发的 CDS 中创建了一个 &ldquo;envoy.clusters.redis&rdquo; 类型的 Cluster： &ldquo;custom-redis-cluster&rdquo;，该 Cluster 会采用 <a href="https://redis.io/commands/cluster-slots">CLUSTER SLOTS 命令</a> 向 Redis 集群中的一个随机节点查询集群的拓扑结构，并在本地保存该拓扑结构，以将来自客户端的请求分发到集群中正确的 Redis 节点上。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#66d9ef">kind</span>: EnvoyFilter
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: custom-redis-cluster
  <span style="color:#66d9ef">namespace</span>: istio-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">configPatches</span>:
  - <span style="color:#66d9ef">applyTo</span>: CLUSTER
    <span style="color:#66d9ef">patch</span>:
      <span style="color:#66d9ef">operation</span>: INSERT_FIRST
      <span style="color:#66d9ef">value</span>:
        <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;custom-redis-cluster&#34;</span>
        <span style="color:#66d9ef">connect_timeout</span>: <span style="color:#ae81ff">0.</span>5s
        <span style="color:#66d9ef">lb_policy</span>: CLUSTER_PROVIDED
        <span style="color:#66d9ef">load_assignment</span>:
          <span style="color:#66d9ef">cluster_name</span>: custom-redis-cluster
          <span style="color:#66d9ef">endpoints</span>:
          - <span style="color:#66d9ef">lb_endpoints</span>:
            - <span style="color:#66d9ef">endpoint</span>:
                <span style="color:#66d9ef">address</span>:
                  <span style="color:#66d9ef">socket_address</span>:
                    <span style="color:#66d9ef">address</span>: redis-cluster<span style="color:#ae81ff">-0.</span>redis-cluster.redis.svc.cluster.local
                    <span style="color:#66d9ef">port_value</span>: <span style="color:#ae81ff">6379</span>
            - <span style="color:#66d9ef">endpoint</span>:
                <span style="color:#66d9ef">address</span>:
                  <span style="color:#66d9ef">socket_address</span>:
                    <span style="color:#66d9ef">address</span>: redis-cluster<span style="color:#ae81ff">-1.</span>redis-cluster.redis.svc.cluster.local
                    <span style="color:#66d9ef">port_value</span>: <span style="color:#ae81ff">6379</span>
            - <span style="color:#66d9ef">endpoint</span>:
                <span style="color:#66d9ef">address</span>:
                  <span style="color:#66d9ef">socket_address</span>:
                    <span style="color:#66d9ef">address</span>: redis-cluster<span style="color:#ae81ff">-2.</span>redis-cluster.redis.svc.cluster.local
                    <span style="color:#66d9ef">port_value</span>: <span style="color:#ae81ff">6379</span>
            - <span style="color:#66d9ef">endpoint</span>:
                <span style="color:#66d9ef">address</span>:
                  <span style="color:#66d9ef">socket_address</span>:
                    <span style="color:#66d9ef">address</span>: redis-cluster<span style="color:#ae81ff">-3.</span>redis-cluster.redis.svc.cluster.local
                    <span style="color:#66d9ef">port_value</span>: <span style="color:#ae81ff">6379</span>
            - <span style="color:#66d9ef">endpoint</span>:
                <span style="color:#66d9ef">address</span>:
                  <span style="color:#66d9ef">socket_address</span>:
                    <span style="color:#66d9ef">address</span>: redis-cluster<span style="color:#ae81ff">-4.</span>redis-cluster.redis.svc.cluster.local
                    <span style="color:#66d9ef">port_value</span>: <span style="color:#ae81ff">6379</span>
            - <span style="color:#66d9ef">endpoint</span>:
                <span style="color:#66d9ef">address</span>:
                  <span style="color:#66d9ef">socket_address</span>:
                    <span style="color:#66d9ef">address</span>: redis-cluster<span style="color:#ae81ff">-5.</span>redis-cluster.redis.svc.cluster.local
                    <span style="color:#66d9ef">port_value</span>: <span style="color:#ae81ff">6379</span>
        <span style="color:#66d9ef">cluster_type</span>:
          <span style="color:#66d9ef">name</span>: envoy.clusters.redis
          <span style="color:#66d9ef">typed_config</span>:
            <span style="color:#66d9ef">&#34;@type&#34;: </span>type.googleapis.com/google.protobuf.Struct
            <span style="color:#66d9ef">value</span>:
              <span style="color:#66d9ef">cluster_refresh_rate</span>: 5s
              <span style="color:#66d9ef">cluster_refresh_timeout</span>: 3s
              <span style="color:#66d9ef">redirect_refresh_interval</span>: 5s
              <span style="color:#66d9ef">redirect_refresh_threshold</span>: <span style="color:#ae81ff">5</span>
</code></pre></div><h2 id="小结">小结</h2>
<p>本文介绍了如何使用 Envoy 为微服务应用提供客户端无感知的 Redis 数据分片，以及如何通过 Istio 来统一管理系统中多个 Envoy 代理的 Redis Cluster 配置。我们可以看到，采用 Istio 和 Envoy 可以大大简化客户端使用 Redis Cluster 的编码和配置工作，并且可以在线修改 Redis Cluster 的运维策略，实现读写分离、流量镜像等高级流量管理。当然，引入 Istio 和 Envoy 并未减少整个系统的复杂度，而是将 Redis Cluster 维护的工作从各个分散的应用代码中集中到了服务网格基础设施层。对应广大应用开放者来说，其业务价值主要来自于应用代码，将大量精力投入此类基础设施是不太划算的。建议直接采用腾讯云上的云原生 Service Mesh 服务 TCM（Tencent Cloud Mesh），为微服务应用快速引入 Service Mesh 的流量管理和服务治理能力，而无需再关注 Service Mesh 基础设施自身的安装、维护、升级等事项。</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://rancher.com/blog/2019/deploying-redis-cluster">Deploying Redis Cluster on Top of Kubernetes</a></li>
<li><a href="https://medium.com/@fr33m0nk/migrating-to-redis-cluster-using-envoy-93a87ae79dc3">Migrating to Redis cluster using envoy proxy</a></li>
<li><a href="https://github.com/istio/istio/pull/27426/">Implement REPLACE operation for EnvoyFilter patch</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/service-mesh"> 
            Service Mesh</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/istio"> , 
            Istio</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/envoy"> , 
            Envoy</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/redis"> , 
            Redis</a>
            
          </ul>
        </div>
        <!-- previous -->
        <div class="mb-3 link-article">
  <div class="pre-article">
    
    <div><i class="fa fa-arrow-left"></i> 上一篇</div>
    <a href="https://cloudnative.to/blog/must-read-for-cloud-native-beginner/">云原生初学者入门必读</a>
    
  </div>
  <div class="next-article">
    
    <div>下一篇 <i class="fa fa-arrow-right"></i></div>
    <a href="https://cloudnative.to/blog/envoy-ama/">Envoy 调试流量的常用技巧直播分享及问答整理</a>
  
  </div>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/envoy-wasm/">Istio 进阶学习系列 - 基于 WebAssembly 实现 Envoy 与 Istio 的功能扩展</a></li>
  
    <li><a href="/blog/zero-trust-service-mesh/">服务网格的零信任安全</a></li>
  
    <li><a href="/blog/request-affinity-with-istio/">如何使用 Istio 处理亲和性网络请求</a></li>
  
    <li><a href="/blog/envoy-trans-recruit/">云原生社区 Envoy 官网翻译小组成员招募中</a></li>
  
    <li><a href="/blog/istio-pilot-3/">Istio Pilot 源码分析（三）</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5 word-cloud">
    <h4 class="mb-4">标签</h4>
    
      
      
      
      
      
      
      
      
      
      
      
      <div id="tag-cloud" style="padding: 5px 15px">
      
        
          
          
          
          <a href="/tags/arm" style="font-size:1rem">arm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/bpf" style="font-size:1.0714285714285714rem">bpf</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cicd" style="font-size:1.0714285714285714rem">cicd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/client-go" style="font-size:1.1428571428571428rem">client-go</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cloud-native" style="font-size:1.1428571428571428rem">cloud-native</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cloud-security" style="font-size:1rem">cloud-security</a>
        
      
        
          
          
          &middot;
          <a href="/tags/crossplane" style="font-size:1rem">crossplane</a>
        
      
        
          
          
          &middot;
          <a href="/tags/devops" style="font-size:1rem">devops</a>
        
      
        
          
          
          &middot;
          <a href="/tags/docker" style="font-size:1rem">docker</a>
        
      
        
          
          
          &middot;
          <a href="/tags/envoy" style="font-size:1.5714285714285714rem">envoy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/etcd" style="font-size:1rem">etcd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/flamegraph" style="font-size:1rem">flamegraph</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gateway" style="font-size:1rem">gateway</a>
        
      
        
          
          
          &middot;
          <a href="/tags/helm" style="font-size:1rem">helm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/informer" style="font-size:1.2142857142857142rem">informer</a>
        
      
        
          
          
          &middot;
          <a href="/tags/iptables" style="font-size:1rem">iptables</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ipvs" style="font-size:1rem">ipvs</a>
        
      
        
          
          
          &middot;
          <a href="/tags/istio" style="font-size:1.7142857142857142rem">istio</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kube-proxy" style="font-size:1rem">kube-proxy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubebuilder" style="font-size:1rem">kubebuilder</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetes" style="font-size:1.5714285714285714rem">kubernetes</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kylin" style="font-size:1rem">kylin</a>
        
      
        
          
          
          &middot;
          <a href="/tags/linux%e5%86%85%e6%a0%b8" style="font-size:1rem">linux内核</a>
        
      
        
          
          
          &middot;
          <a href="/tags/microservices" style="font-size:1.0714285714285714rem">microservices</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mosn" style="font-size:1rem">mosn</a>
        
      
        
          
          
          &middot;
          <a href="/tags/netfilter" style="font-size:1rem">netfilter</a>
        
      
        
          
          
          &middot;
          <a href="/tags/oam" style="font-size:1.0714285714285714rem">oam</a>
        
      
        
          
          
          &middot;
          <a href="/tags/observability" style="font-size:1rem">observability</a>
        
      
        
          
          
          &middot;
          <a href="/tags/operator" style="font-size:1rem">operator</a>
        
      
        
          
          
          &middot;
          <a href="/tags/profile" style="font-size:1rem">profile</a>
        
      
        
          
          
          &middot;
          <a href="/tags/rbac" style="font-size:1.0714285714285714rem">rbac</a>
        
      
        
          
          
          &middot;
          <a href="/tags/redis" style="font-size:1rem">redis</a>
        
      
        
          
          
          &middot;
          <a href="/tags/security" style="font-size:1.3571428571428572rem">security</a>
        
      
        
          
          
          &middot;
          <a href="/tags/service-mesh" style="font-size:1.9285714285714284rem">service-mesh</a>
        
      
        
          
          
          &middot;
          <a href="/tags/spring-cloud" style="font-size:1rem">spring-cloud</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tcpdump" style="font-size:1rem">tcpdump</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tekton" style="font-size:1rem">tekton</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vxlan" style="font-size:1.0714285714285714rem">vxlan</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wasm" style="font-size:1.0714285714285714rem">wasm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wireshark" style="font-size:1rem">wireshark</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zero-trust-cybersecurity" style="font-size:1rem">zero-trust-cybersecurity</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zookeeper" style="font-size:1rem">zookeeper</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e4%ba%91%e5%8e%9f%e7%94%9f" style="font-size:1rem">云原生</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e4%ba%91%e5%8e%9f%e7%94%9f%e5%ad%a6%e9%99%a2" style="font-size:1.0714285714285714rem">云原生学院</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%ad%a6%e4%b9%a0%e5%b0%8f%e7%bb%84" style="font-size:1rem">学习小组</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%bc%80%e6%ba%90" style="font-size:1rem">开源</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" style="font-size:1rem">开源社区</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" style="font-size:1rem">源码分析</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e7%90%86%e8%a7%a3" style="font-size:1.0714285714285714rem">源码理解</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%a4%be%e5%8c%ba" style="font-size:1.0714285714285714rem">社区</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%bf%bb%e8%af%91" style="font-size:1.1428571428571428rem">翻译</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e8%b4%a1%e7%8c%ae%e5%bc%80%e6%ba%90" style="font-size:1rem">贡献开源</a>
        
      
      </div>
    
  </div>

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <div class="mx-auto avatar-wrp">
        <img class="rounded-circle avatar-img" src="/images/profile/zhaohuabing.png">
      </div>
      <p class="avatar-name">
        <strong class="text-dark "><a href="https://zhaohuabing.com">赵化冰</a></strong> 
      </p>
      <p>腾讯云高级工程师，Istio contributor，ServiceMesher 管理委员，热衷于开源、网络和云计算。目前主要从事服务网格的开源和研发工作。</p>
    </div>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#redis-cluster">Redis Cluster</a></li>
    <li><a href="#部署-istio">部署 Istio</a></li>
    <li><a href="#部署-redis-cluster">部署 Redis Cluster</a>
      <ul>
        <li><a href="#验证-redis-部署">验证 Redis 部署</a></li>
        <li><a href="#创建-redis-cluster">创建 Redis Cluster</a></li>
        <li><a href="#验证-redis-cluster">验证 Redis Cluster</a></li>
        <li><a href="#部署测试用客户端">部署测试用客户端</a></li>
      </ul>
    </li>
    <li><a href="#通过-istio-下发-redis-cluster-相关的-envoy-配置">通过 Istio 下发 Redis Cluster 相关的 Envoy 配置</a>
      <ul>
        <li><a href="#创建-envoy-redis-cluster">创建 Envoy Redis Cluster</a></li>
        <li><a href="#创建-envoy-redis-proxy">创建 Envoy Redis Proxy</a></li>
      </ul>
    </li>
    <li><a href="#验证-redis-cluster-功能">验证 Redis Cluster 功能</a>
      <ul>
        <li><a href="#redis-数据分片">Redis 数据分片</a></li>
        <li><a href="#redis-读写分离">Redis 读写分离</a></li>
        <li><a href="#redis-流量镜像">Redis 流量镜像</a></li>
      </ul>
    </li>
    <li><a href="#实现原理">实现原理</a></li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是一个中立的云原生终端用户社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，旨在推广云原生技术，构建开发者生态。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="https://github.com/cloudnativeto/community/issues/58">成都</a>|<a href="https://github.com/cloudnativeto/community/issues/60">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="https://github.com/cloudnativeto/community/issues/59">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2021 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/code-of-conduct"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
