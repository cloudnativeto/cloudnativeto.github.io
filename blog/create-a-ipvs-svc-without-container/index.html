<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  
  <title>在非容器环境上实现散装的 IPVS SVC | 云原生社区</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在没有容器的环境下，靠基础的软件实现一个 IPVS 的 SVC 负载。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/all.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/create-a-ipvs-svc-without-container/" />
  <meta property="og:title" content="在非容器环境上实现散装的 IPVS SVC" />
  <meta property="og:description" content="在没有容器的环境下，靠基础的软件实现一个 IPVS 的 SVC 负载。" />
  <meta property="og:image" content="https://cloudnative.to/images/blog/loadbalance-banner.jpg" />
</head>
<body>
<!-- header -->

<img src="images/logo-square.jpg" width="0" height="0" />
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
     <img src="" width='700'>
</div>
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog/">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/community/sig/">兴趣小组</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
                <a class="dropdown-item" href="https://istio.io/latest/zh/">Istio 中文文档</a>
                
              </div>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3 text-capitalize">在非容器环境上实现散装的 i p v s s v c</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">在没有容器的环境下，靠基础的软件实现一个 IPVS 的 SVC 负载。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/loadbalance-banner.jpg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type"><a href="/categories/ipvs">IPVS</a></div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://zhangguanzhang.github.io/">张浩</a></strong>
          
            发表于 <strong class="text-dark">2021年9月29日</strong></div>
        <hr>
        <div class="content">
          <h2 id="前言">前言</h2>
<p>内部有非 K8S 环境上需要类似 SVC 的负载实现，一开始是用 NGINX 做的，所有 SVC 域名都解析成一个 dummy IP ，然后 NGINX 根据 <code>server_name</code> 去 proxy 不同的 upstream 。 开始还是能用的，但是后面结果后面很多服务依赖 <code>host</code> 这个 header ，报错签名错误，而且毕竟这样是在用户态，效率不如内核态高。于是打算搞下之前的打算：把 IPVS 的 <code>ClusterIP</code> 的 SVC 扣到非 K8S 环境上使用。</p>
<p>kube-proxy 的 SVC 简单讲就是 node 上任何进程访问 <code>SVC IP:SVC PORT</code> 会被 dnat 成 <code>endpoint</code> ，是工作在内核态的四层负载，不会在机器上看到端口监听，而默认非集群的机器是无法访问 SVC IP 。在 K8S 里，endpoint 的 ip 无非就是 <code>POD IP</code>，<code>host IP</code>。前者就是 SVC 选中 POD ，后者例如 <code>kubernetes</code> 这个 SVC ，会 DNAT 成每个 <code>kube-apiserver</code> 的 <code>host IP:6443</code> 端口，也可能是 <code>ExternalName</code> 或者手动创建的 endpoint 。既然 <code>kubernetes</code> 这个 SVC 可以。那我的打算应该也是可以实现的。但是一开始实际按照思路试了下发现不行，网上的文章基本都是在单机 docker 或者现有的 K8S 环境上搞的，漏掉了很多精华和核心思想，这里记录下我的思路和实现过程。</p>
<h2 id="环境信息">环境信息</h2>
<p>前面说的 SVC 现象是和 <code>kube-proxy</code> 的模式无关的。<code>iptables</code> 模式排查不直观，我更倾向于 <code>IPVS</code> 去搞，它更直观，而且支持更多的调度算法。管理 IPVS 规则的话我们需要安装 <code>ipvsadm</code> ，这里我是两台干净的 CentOS 7.8 来做环境。</p>
<table>
<thead>
<tr>
<th align="left">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">192.168.2.111</td>
</tr>
<tr>
<td align="left">192.168.2.222</td>
</tr>
</tbody>
</table>
<p>先安装下基础需要的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y ipvsadm curl wget tcpdump ipset conntrack-tools

<span style="color:#75715e"># 开启转发</span>

sysctl -w net.ipv4.ip_forward<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

<span style="color:#75715e"># 确认 iptables 规则清空</span>
$ iptables -S
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
$ iptables -t nat -S
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
</code></pre></div><h2 id="过程">过程</h2>
<p>先思考下 kube-proxy 的 IPVS ，因为 SVC 端口和 POD 的端口不一样，所以 kube-proxy 使用的 <code>nat</code> 模式。暂且打算添加一个下面类似的 SVC ：</p>
<pre><code>IP:                169.254.11.2
Port:              https  80/TCP
TargetPort:        6443/TCP
Endpoints:         192.168.2.111:8080,192.168.2.222:8080
Session Affinity:  None
</code></pre><h3 id="准备工作">准备工作</h3>
<p>web 的话我是使用的 golang 的一个简单 web 二进制起的 <a href="https://github.com/m3ng9i/ran">ran</a> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/m3ng9i/ran/releases/download/v0.1.6/ran_linux_amd64.zip
unzip -x ran_linux_amd64.zip
mkdir www

<span style="color:#75715e"># 两个机器创建不同的 index 文件</span>
echo 192.168.2.111 &gt; www/test
echo 192.168.2.222 &gt; www/test

./ran_linux_amd64 -port <span style="color:#ae81ff">8080</span> -listdir www
</code></pre></div><p>两个机器的这个 web 都起来后我们开个窗口去 <code>192.168.2.111</code> 上继续后面的操作。</p>
<h3 id="lvs-nat">lvs nat</h3>
<p>kube-proxy 并没有像 lvs nat 那样有单独的机器做 <code>NAT GW</code>，或者认为每个 node 都是自己的 <code>NAT GW</code>。现在来添加 <code>169.254.11.2:80</code> 这个 SVC ，使用 ipvsadm 添加：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ipvsadm --add-service --tcp-service 169.254.11.2:80 --scheduler rr
</code></pre></div><p>先添加本地的 web 作为 real server ，下面含义是添加为一个 nat 类型的 real server ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ipvsadm --add-server --tcp-service 169.254.11.2:80 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --real-server 192.168.2.111:8080 --masquerading --weight <span style="color:#ae81ff">1</span>
</code></pre></div><p>查看下当前列表：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ipvsadm -ln
IP Virtual Server version 1.2.1 <span style="color:#f92672">(</span>size<span style="color:#f92672">=</span>4096<span style="color:#f92672">)</span>
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  169.254.11.2:80 rr
  -&gt; 192.168.2.111:8080           Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span> 
</code></pre></div><p>因为是自己的 <code>NAT GW</code>，所以 VIP 配置在自己身上：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ip addr add 169.254.11.2/32 dev eth0
</code></pre></div><p>测试下访问看看：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl 169.254.11.2/www/test
192.168.2.111
</code></pre></div><p>添加上另一个节点的 8080：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ipvsadm --add-server --tcp-service 169.254.11.2:80 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --real-server 192.168.2.222:8080 --masquerading --weight <span style="color:#ae81ff">1</span>

$ ipvsadm -ln
IP Virtual Server version 1.2.1 <span style="color:#f92672">(</span>size<span style="color:#f92672">=</span>4096<span style="color:#f92672">)</span>
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  169.254.11.2:80 rr
  -&gt; 192.168.2.111:8080           Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>         
  -&gt; 192.168.2.222:8080           Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</code></pre></div><p>测试下访问看看：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl 169.254.11.2/www/test

</code></pre></div><p>发现 curl 在卡住和能访问返回 <code>192.168.2.111</code> 之间切换，没有返回 <code>192.168.2.222</code> 的。查看下 IPVS 的 connection ，发现调度到非本机才会卡住：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ipvsadm -lnc
IPVS connection entries
pro expire state       source             virtual            destination
TCP 00:48  SYN_RECV    169.254.11.2:50698 169.254.11.2:80    192.168.2.222:8080
</code></pre></div><p>在 <code>192.168.2.222</code> 上抓包看看：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ tcpdump -nn -i eth0 port <span style="color:#ae81ff">8080</span>
tcpdump: verbose output suppressed, use -v or -vv <span style="color:#66d9ef">for</span> full protocol decode
listening on eth0, link-type EN10MB <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>, capture size <span style="color:#ae81ff">262144</span> bytes
07:38:26.360716 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span style="color:#f92672">[</span>S<span style="color:#f92672">]</span>, seq 768065283, win 43690, options <span style="color:#f92672">[</span>mss 65495,sackOK,TS val <span style="color:#ae81ff">12276183</span> ecr 0,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:26.360762 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 2142784980, ack 768065284, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676518144</span> ecr 12276183,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:27.362848 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span style="color:#f92672">[</span>S<span style="color:#f92672">]</span>, seq 768065283, win 43690, options <span style="color:#f92672">[</span>mss 65495,sackOK,TS val <span style="color:#ae81ff">12277186</span> ecr 0,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:27.362884 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 2142784980, ack 768065284, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676519146</span> ecr 12276183,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:28.562629 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 2142784980, ack 768065284, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676520346</span> ecr 12276183,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:29.368811 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span style="color:#f92672">[</span>S<span style="color:#f92672">]</span>, seq 768065283, win 43690, options <span style="color:#f92672">[</span>mss 65495,sackOK,TS val <span style="color:#ae81ff">12279192</span> ecr 0,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:29.368853 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 2142784980, ack 768065284, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676521152</span> ecr 12276183,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:31.562633 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 2142784980, ack 768065284, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676523346</span> ecr 12276183,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:33.376829 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span style="color:#f92672">[</span>S<span style="color:#f92672">]</span>, seq 768065283, win 43690, options <span style="color:#f92672">[</span>mss 65495,sackOK,TS val <span style="color:#ae81ff">12283200</span> ecr 0,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:33.376869 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 2142784980, ack 768065284, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676525160</span> ecr 12276183,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
07:38:37.562632 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 2142784980, ack 768065284, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676529346</span> ecr 12276183,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
</code></pre></div><p>从 <code>Flags</code> 看，就是 tcp 重传，并且 <code>SRC IP</code> 是 VIP 。节点 <code>192.168.2.222.8080</code> 给 <code>169.254.11.2.50710</code> 回包会走到网关上去。网关上抓包也看到确实如此：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ tcpdump -nn -i eth0 host 169.254.11.2
tcpdump: verbose output suppressed, use -v or -vv <span style="color:#66d9ef">for</span> full protocol decode
listening on eth0, link-type EN10MB <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>, capture size <span style="color:#ae81ff">262144</span> bytes
19:39:47.487362 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 4149799699, ack 251479303, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676599263</span> ecr 12357303,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
19:39:47.487405 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 4149799699, ack 251479303, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676599263</span> ecr 12357303,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
19:39:48.487838 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 4149799699, ack 251479303, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676600264</span> ecr 12357303,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
19:39:48.487868 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 4149799699, ack 251479303, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676600264</span> ecr 12357303,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
19:39:49.569667 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 4149799699, ack 251479303, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676601346</span> ecr 12357303,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
19:39:49.569699 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span style="color:#f92672">[</span>S.<span style="color:#f92672">]</span>, seq 4149799699, ack 251479303, win 28960, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">676601346</span> ecr 12357303,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
</code></pre></div><h4 id="lvs-和-netfilter">lvs 和 netfilter</h4>
<p>在介绍 lvs 的实现之前，我们需要了解 netfilter ，Linux 的所有数据包都会经过它，而我们使用的 iptables 是用户态提供的操作工具之一。Linux 内核处理进出的数据包分为了 5 个阶段。netfilter 在这 5 个阶段提供了 hook 点，来让注册的 hook 函数来实现对包的过滤和修改。下图的 local process 就是上层的协议栈。</p>
<p>下面是 IPVS 在 netfilter 里的模型图，IPVS 也是基于 netfilter 框架的，但只工作在 <code>INPUT</code> 链上，通过注册 <code>ip_vs_in</code> 钩子函数来处理请求。因为 VIP 我们配置在机器上（常规的 lvs nat 的 VIP 是在 NAT GW 上，我们这里是自己），我们 curl 的时候就会进到 <code>INPUT</code> 链，<code>ip_vs_in</code> 会匹配然后直接跳转触发 <code>POSTROUTING</code> 链，跳过 iptables 规则。</p>
<p><img src="lvs-netfilter.png" alt="lvs-netfilter"></p>
<p>所以请求流程是：</p>
<pre><code># CIP: client IP    # RIP: real server IP

	CLIENT
	   | CIP:CPORT -&gt; VIP:VPORT
	   |		||
	   |		\/
    	   | CIP:CPORT -&gt; VIP:VPORT
   	LVS DNAT
   	   | CIP:CPORT -&gt; RIP:RPORT
   	   |		||
	   |		\/
	   | CIP:CPORT -&gt; RIP:RPORT
	   +
	REAL SERVER
</code></pre><p>lvs 做了 DNAT 并没有做 SNAT ，所以我们利用 iptables 做 SNAT ：</p>
<pre><code>$ iptables -t nat -A POSTROUTING -m ipvs --vaddr 169.254.11.2 --vport 80 -j MASQUERADE
</code></pre><p>访问看看还是不通，抓包看还是没生效，nat 是依赖 <code>conntrack</code> 的，而 IPVS 默认不会记录 conntrack，我们需要开启 IPVS 的 conntrack 才可以让 MASQUERADE 生效。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 让 Netfilter 的 conntrack 状态管理功能也能应用于 IPVS 模块</span>
$ echo <span style="color:#ae81ff">1</span> &gt;  /proc/sys/net/ipv4/vs/conntrack
$  curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.222
$ curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.222
$ curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.222
</code></pre></div><p>现在实现了单个 SVC 的，但是仔细思考下还是有问题，如果后续增加另一个 SVC 又得增加一个 iptables 规则了，那就又回到 iptables 的匹配复杂度耗时长上去了。所以我们可以利用 iptables 的 mark 和 ipset 配合减少 iptables 规则。</p>
<h3 id="利用-ipset-和-iptable-的-mark">利用 ipset 和 iptable 的 mark</h3>
<p><img src="iptables_netfilter.png" alt="iptables_netfilter"></p>
<p>iptables 的五链四表如上图所示，我们先删掉原有的规则：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ iptables -t nat -D POSTROUTING -m ipvs --vaddr 169.254.11.2 --vport <span style="color:#ae81ff">80</span> -j MASQUERADE
</code></pre></div><p>平时自己家里使用了 openwrt ，之前看了下上面的 iptables 规则设计挺好的，特别是预留了很多链专门给用户在合适的位置插入规则，比如下面的 <code>INPUT</code> 规则：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-A INPUT -i eth0 -m comment --comment <span style="color:#e6db74">&#34;!fw3&#34;</span> -j zone_lan_input
...
-A zone_lan_input -m comment --comment <span style="color:#e6db74">&#34;!fw3: Custom lan input rule chain&#34;</span> -j input_lan_rule
-A zone_lan_input -m conntrack --ctstate DNAT -m comment --comment <span style="color:#e6db74">&#34;!fw3: Accept port redirections&#34;</span> -j ACCEPT
-A zone_lan_input -m comment --comment <span style="color:#e6db74">&#34;!fw3&#34;</span> -j zone_lan_src_ACCEPT
</code></pre></div><p><code>zone_lan_src_ACCEPT</code> 是最后面，<code>zone_lan_input</code> 是最开始，那用户向 <code>input_lan_rule</code> 链里插入规则即可，利用多个链来设计也方便别人。
规则设计我们先逆着来思考下，最后肯定是 <code>MASQUERADE</code> 的，得在 nat 表的 <code>POSTROUTING</code> 链创建 <code>MASQUERADE</code> 的规则。</p>
<p>但是添加之前先思考下，lvs 做了 DNAT 后，最后包走向了 <code>POSTROUTING</code> 链，而且后面我们是有多个 SVC 的。此刻包的 <code>SRC IP</code> 会是 <code>VIP</code>，而 <code>DEST IP</code> 是做了 DNAT 后的 <code>real server</code> ，而且后续可能是在在 docker 环境上部署，可能默认桥接网络的容器也会去访问 <code>SVC</code>，此刻的 <code>SRC IP</code> 就不会是网卡上的 <code>VIP</code> 了，但是在 <code>PREROUTING</code> 链的时候，<code>DEST IP</code> 还没变，我们可以在此刻利用一个 ipset 存储所有的 <code>SVC_IP:SVC_PORT</code> 匹配，然后打上 mark，然后在 <code>POSTROUTING</code> 链去根据 mark 去做 <code>MASQUERADE</code> 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># PREROUTING 阶段处理</span>

<span style="color:#75715e"># 提供一个入口链，而不是直接添加在 PREROUTING 链上</span>
iptables -t nat -N ZGZ-SERVICES
iptables -t nat -A PREROUTING -m comment --comment <span style="color:#e6db74">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES

<span style="color:#75715e"># 在 PREROUTING 子链里去 ipset 匹配，跳转到我们 mark 的链</span>
iptables -t nat -N ZGZ-MARK-MASQ
<span style="color:#75715e"># 创建存储所有 `SVC_IP:SVC_PORT` 的 ipset</span> 
ipset create ZGZ-CLUSTER-IP hash:ip,port -exist
iptables -t nat -A ZGZ-SERVICES -m comment --comment <span style="color:#e6db74">&#34;zgz service cluster ip + port for masquerade purpose&#34;</span> -m set --match-set ZGZ-CLUSTER-IP dst,dst -j ZGZ-MARK-MASQ

<span style="color:#75715e"># 专门 mark 的链</span>
iptables -t nat -A ZGZ-MARK-MASQ -j MARK --set-xmark 0x2000/0x2000

<span style="color:#75715e"># POSTROUTING 阶段处理</span>

<span style="color:#75715e"># 提供一个入口链，而不是直接添加在 POSTROUTING 链上</span>
iptables -t nat -N ZGZ-POSTROUTING
iptables -t nat -A POSTROUTING -m comment --comment <span style="color:#e6db74">&#34;zgz postrouting rules&#34;</span> -j ZGZ-POSTROUTING
<span style="color:#75715e"># 在 POSTROUTING 阶段做 snat</span>
iptables -t nat -A ZGZ-POSTROUTING -m comment --comment <span style="color:#e6db74">&#34;zgz service traffic requiring SNAT&#34;</span> -m mark --mark 0x2000/0x2000 -j MASQUERADE
</code></pre></div><p>然后添加下 <code>SVC_IP:SVC_PORT</code> 到我们的 ipset 里：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ipset add ZGZ-CLUSTER-IP 169.254.11.2,tcp:80 -exist
</code></pre></div><p>上面我们创建的 ipset 里 <code>ip,port</code> 和 iptables 里 <code>--match-set</code> 后面的 <code>dst,dst</code> 组合在一起就是 <code>DEST IP</code> 和 <code>DEST PORT</code> 同时匹配，下面是一些举例：</p>
<table>
<thead>
<tr>
<th align="left">ipset type</th>
<th align="left">iptables match-set</th>
<th align="left">Packet fields</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">hash:net,port,net</td>
<td align="left">src,dst,dst</td>
<td align="left">src IP CIDR address, dst port, dst IP CIDR address</td>
</tr>
<tr>
<td align="left">hash:net,port,net</td>
<td align="left">dst,src,src</td>
<td align="left">dst IP CIDR address, src port, src IP CIDR address</td>
</tr>
<tr>
<td align="left">hash:ip,port,ip</td>
<td align="left">src,dst,dst</td>
<td align="left">src IP address, dst port, dst IP address</td>
</tr>
<tr>
<td align="left">hash:ip,port,ip</td>
<td align="left">dst,src,src</td>
<td align="left">dst IP address, src port, src ip address</td>
</tr>
<tr>
<td align="left">hash:mac</td>
<td align="left">src</td>
<td align="left">src mac address</td>
</tr>
<tr>
<td align="left">hash:mac</td>
<td align="left">dst</td>
<td align="left">dst mac address</td>
</tr>
<tr>
<td align="left">hash:ip,mac</td>
<td align="left">src,src</td>
<td align="left">src IP address, src mac address</td>
</tr>
<tr>
<td align="left">hash:ip,mac</td>
<td align="left">dst,dst</td>
<td align="left">dst IP address, dst mac address</td>
</tr>
<tr>
<td align="left">hash:ip,mac</td>
<td align="left">dst,src</td>
<td align="left">dst IP address, src mac address</td>
</tr>
</tbody>
</table>
<p>然后访问下还是不通，突然想起来在机器上访问本机的 IP 端口的时候是内核直接转发给本地进程，这种数据包会只经过 <code>OUTPUT</code> 链，不会过 <code>PREROUTING</code> ，不过我们上面的 <code>PREROUTING</code> 链可以处理后续的 docker 容器。 调试了下发现确实会走 <code>OUTPUT</code> 链：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#39;kern.warning /var/log/iptables.log&#39;</span> &gt;&gt; /etc/rsyslog.conf
$ systemctl restart rsyslog
$ iptables -t nat -I OUTPUT -m set --match-set ZGZ-CLUSTER-IP dst,dst  -j LOG --log-prefix <span style="color:#e6db74">&#39;**log-test**&#39;</span>
$ curl 169.254.11.2/www/test
$ cat /var/log/iptables.log
Sep <span style="color:#ae81ff">27</span> 23:17:51 centos7 kernel: **log-test**IN<span style="color:#f92672">=</span> OUT<span style="color:#f92672">=</span>lo SRC<span style="color:#f92672">=</span>169.254.11.2 DST<span style="color:#f92672">=</span>169.254.11.2 LEN<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span> TOS<span style="color:#f92672">=</span>0x00 PREC<span style="color:#f92672">=</span>0x00 TTL<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> ID<span style="color:#f92672">=</span><span style="color:#ae81ff">44864</span> DF PROTO<span style="color:#f92672">=</span>TCP SPT<span style="color:#f92672">=</span><span style="color:#ae81ff">50794</span> DPT<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> WINDOW<span style="color:#f92672">=</span><span style="color:#ae81ff">43690</span> RES<span style="color:#f92672">=</span>0x00 SYN URGP<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> 
Sep <span style="color:#ae81ff">27</span> 23:17:52 centos7 kernel: **log-test**IN<span style="color:#f92672">=</span> OUT<span style="color:#f92672">=</span>lo SRC<span style="color:#f92672">=</span>169.254.11.2 DST<span style="color:#f92672">=</span>169.254.11.2 LEN<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span> TOS<span style="color:#f92672">=</span>0x00 PREC<span style="color:#f92672">=</span>0x00 TTL<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> ID<span style="color:#f92672">=</span><span style="color:#ae81ff">2010</span> DF PROTO<span style="color:#f92672">=</span>TCP SPT<span style="color:#f92672">=</span><span style="color:#ae81ff">50796</span> DPT<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> WINDOW<span style="color:#f92672">=</span><span style="color:#ae81ff">43690</span> RES<span style="color:#f92672">=</span>0x00 SYN URGP<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> 
</code></pre></div><p>需要添加下面规则：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">iptables -t nat -A OUTPUT -m comment --comment <span style="color:#e6db74">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES
</code></pre></div><h3 id="keepalived-的自动化实现">keepalived 的自动化实现</h3>
<p>到目前为止都是手动挡，而且没健康检查，其实我们可以利用 keepalived 做个自动挡的。</p>
<h4 id="安装-keepalived-2">安装 keepalived 2</h4>
<p>CentOS7 自带的源里 <code>keepalived</code> 版本很低，我们安装下比自带新的版本：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y http://www.nosuchhost.net/~cheese/fedora/packages/epel-7/x86_64/cheese-release-7-1.noarch.rpm
yum install -y keepalived
<span style="color:#75715e"># 备份下自带的配置文件</span>
cp /etc/keepalived/keepalived.conf<span style="color:#f92672">{</span>,.bak<span style="color:#f92672">}</span>
</code></pre></div><h4 id="配置-keepalived">配置 keepalived</h4>
<p>我们需要配置下 keepalived ，修改之前先看下默认相关的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl cat keepalived
<span style="color:#75715e"># /usr/lib/systemd/system/keepalived.service</span>
<span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
Description<span style="color:#f92672">=</span>LVS and VRRP High Availability Monitor
After<span style="color:#f92672">=</span>syslog.target network-online.target

<span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
Type<span style="color:#f92672">=</span>forking
KillMode<span style="color:#f92672">=</span>process
EnvironmentFile<span style="color:#f92672">=</span>-/etc/sysconfig/keepalived
ExecStart<span style="color:#f92672">=</span>/usr/sbin/keepalived $KEEPALIVED_OPTIONS
ExecReload<span style="color:#f92672">=</span>/bin/kill -HUP $MAINPID

<span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
WantedBy<span style="color:#f92672">=</span>multi-user.target
$ cat /etc/sysconfig/keepalived
<span style="color:#75715e"># Options for keepalived. See `keepalived --help&#39; output and keepalived(8) and</span>
<span style="color:#75715e"># keepalived.conf(5) man pages for a list of all options. Here are the most</span>
<span style="color:#75715e"># common ones :</span>
#
<span style="color:#75715e"># --vrrp               -P    Only run with VRRP subsystem.</span>
<span style="color:#75715e"># --check              -C    Only run with Health-checker subsystem.</span>
<span style="color:#75715e"># --dont-release-vrrp  -V    Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.</span>
<span style="color:#75715e"># --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.</span>
<span style="color:#75715e"># --dump-conf          -d    Dump the configuration data.</span>
<span style="color:#75715e"># --log-detail         -D    Detailed log messages.</span>
<span style="color:#75715e"># --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)</span>
#

KEEPALIVED_OPTIONS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-D&#34;</span>
</code></pre></div><p><code>/etc/sysconfig/keepalived</code> 里修改为下面：</p>
<pre><code class="language-conf" data-lang="conf">KEEPALIVED_OPTIONS=&quot;-D --log-console --log-detail --use-file=/etc/keepalived/keepalived.conf&quot;
</code></pre><p>我们选择在主配置文件里去 include 子配置文件，keepalivd 接收 <code>kill -HUP</code> 信号触发 reload ，后续自动化添加 SVC 的时候添加子配置文件后发送信号即可。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat &gt; /etc/keepalived/keepalived.conf <span style="color:#e6db74">&lt;&lt; EOF
</span><span style="color:#e6db74">! Configuration File for keepalived
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">global_defs {
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"># 记住 keepalived 的任何配置文件不能有 x 权限
</span><span style="color:#e6db74">include /etc/keepalived/conf.d/*.conf
</span><span style="color:#e6db74">EOF</span>
mkdir -p /etc/keepalived/conf.d/
</code></pre></div><p>我们写一个脚本，一个是用来添加一个子配置文件里的相关信息到 ipset 里，另一方面也让它在重启或者启动 keepalived 的时候每次能初始化，先添加 systemd 的部分：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /usr/lib/systemd/system/keepalived.service.d
cat &gt; /usr/lib/systemd/system/keepalived.service.d/10.keepalived.conf <span style="color:#e6db74">&lt;&lt; EOF
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">ExecStartPre=/etc/keepalived/ipvs.sh
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>然后编写脚本 <code>/etc/keepalived/ipvs.sh</code> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
set -e

dummy_if<span style="color:#f92672">=</span>svc
CONF_DIR<span style="color:#f92672">=</span>/etc/keepalived/conf.d/


<span style="color:#66d9ef">function</span> ipset_init<span style="color:#f92672">(){</span>
    ipset create ZGZ-CLUSTER-IP hash:ip,port -exist
    ipset flush ZGZ-CLUSTER-IP
    local f ip port protocol
    <span style="color:#66d9ef">for</span> f in <span style="color:#66d9ef">$(</span>find  <span style="color:#e6db74">${</span>CONF_DIR<span style="color:#e6db74">}</span> -maxdepth <span style="color:#ae81ff">1</span> -type f -name <span style="color:#e6db74">&#39;*.conf&#39;</span><span style="color:#66d9ef">)</span>;<span style="color:#66d9ef">do</span>
        awk <span style="color:#e6db74">&#39;{if($1==&#34;virtual_server&#34;){printf $2&#34; &#34;$3&#34; &#34;;flag=1;};if(flag==1 &amp;&amp; $1==&#34;protocol&#34;){print $2;flag=0}}&#39;</span> <span style="color:#e6db74">&#34;</span>$f<span style="color:#e6db74">&#34;</span> | <span style="color:#66d9ef">while</span> read ip port protocol;<span style="color:#66d9ef">do</span>
            <span style="color:#75715e"># SVC IP port 插入 ipset 里</span>
            ipset add ZGZ-CLUSTER-IP <span style="color:#e6db74">${</span>ip<span style="color:#e6db74">}</span>,<span style="color:#e6db74">${</span>protocol,,<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span> -exist
            <span style="color:#75715e"># 添加 SVC IP 到 dummy 接口上</span>
            <span style="color:#66d9ef">if</span> ! ip r g <span style="color:#e6db74">${</span>ip<span style="color:#e6db74">}</span> | grep -qw lo;<span style="color:#66d9ef">then</span>
                ip addr add <span style="color:#e6db74">${</span>ip<span style="color:#e6db74">}</span>/32 dev <span style="color:#e6db74">${</span>dummy_if<span style="color:#e6db74">}</span>
            <span style="color:#66d9ef">fi</span>
        <span style="color:#66d9ef">done</span>
    <span style="color:#66d9ef">done</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">function</span> create_Chain_in_nat<span style="color:#f92672">(){</span>
    <span style="color:#75715e"># delete use -X</span>
    local Chain option
    option<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-t nat --wait&#34;</span>

    <span style="color:#66d9ef">for</span> Chain in $@;<span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">if</span> ! iptables $option -S | grep -Eq -- <span style="color:#e6db74">&#34;-N\s+</span><span style="color:#e6db74">${</span>Chain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>;<span style="color:#66d9ef">then</span>
        iptables $option -N <span style="color:#e6db74">${</span>Chain<span style="color:#e6db74">}</span>
    <span style="color:#66d9ef">fi</span>
    <span style="color:#66d9ef">done</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">function</span> create_Rule_in_nat<span style="color:#f92672">(){</span>
    local cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;iptables -t nat --wait &#39;</span>
    <span style="color:#66d9ef">if</span> ! <span style="color:#e6db74">${</span>cmd<span style="color:#e6db74">}</span>  --check <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span> 2&gt;/dev/null;<span style="color:#66d9ef">then</span>
        <span style="color:#e6db74">${</span>cmd<span style="color:#e6db74">}</span> -A <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">function</span> iptables_init<span style="color:#f92672">(){</span>
    create_Chain_in_nat ZGZ-SERVICES  ZGZ-SERVICES-POSTROUTING ZGZ-SERVICES-MARK-MASQ

    create_Rule_in_nat ZGZ-SERVICES-MARK-MASQ -j MARK --set-xmark 0x2000/0x2000

    create_Rule_in_nat ZGZ-SERVICES -m comment --comment <span style="color:#e6db74">&#34;zgz service cluster ip + port for masquerade purpose&#34;</span> -m set --match-set ZGZ-CLUSTER-IP dst,dst -j ZGZ-SERVICES-MARK-MASQ

    create_Rule_in_nat PREROUTING -m comment --comment <span style="color:#e6db74">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES
    create_Rule_in_nat OUTPUT -m comment --comment <span style="color:#e6db74">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES

    create_Rule_in_nat ZGZ-SERVICES-POSTROUTING -m comment --comment <span style="color:#e6db74">&#34;zgz service traffic requiring SNAT&#34;</span> -m mark --mark 0x2000/0x2000 -j MASQUERADE
    create_Rule_in_nat POSTROUTING -m comment --comment <span style="color:#e6db74">&#34;zgz postrouting rules&#34;</span> -j ZGZ-SERVICES-POSTROUTING

<span style="color:#f92672">}</span>

<span style="color:#66d9ef">function</span> ipvs_svc_run<span style="color:#f92672">(){</span>
  ip addr flush dev <span style="color:#e6db74">${</span>dummy_if<span style="color:#e6db74">}</span>
  ipset_init
  iptables_init
<span style="color:#f92672">}</span>
<span style="color:#75715e"># 无参数则是 keepalived 启动，也可以接收单个配置文件参数</span>
<span style="color:#66d9ef">function</span> main<span style="color:#f92672">(){</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d /proc/sys/net/ipv4/conf/<span style="color:#e6db74">${</span>dummy_if<span style="color:#e6db74">}</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
    ip link add <span style="color:#e6db74">${</span>dummy_if<span style="color:#e6db74">}</span> type dummy
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$#<span style="color:#e6db74">&#34;</span> -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
    ipvs_svc_run
    <span style="color:#66d9ef">return</span>
  <span style="color:#66d9ef">fi</span>

  local file fullFile ip port protocol
  <span style="color:#66d9ef">for</span> file in $@;<span style="color:#66d9ef">do</span>
    fullFile<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CONF_DIR<span style="color:#e6db74">}</span>/$file
      awk <span style="color:#e6db74">&#39;{if($1==&#34;virtual_server&#34;){printf $2&#34; &#34;$3&#34; &#34;;flag=1;};if(flag==1 &amp;&amp; $1==&#34;protocol&#34;){print $2;flag=0}}&#39;</span> <span style="color:#e6db74">&#34;</span>$f<span style="color:#e6db74">&#34;</span> | <span style="color:#66d9ef">while</span> read ip port protocol;<span style="color:#66d9ef">do</span>
          <span style="color:#75715e"># SVC IP port 插入 ipset 里</span>
          ipset add ZGZ-CLUSTER-IP <span style="color:#e6db74">${</span>ip<span style="color:#e6db74">}</span>,<span style="color:#e6db74">${</span>protocol,,<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span> -exist
          <span style="color:#75715e"># 添加 SVC IP 到 dummy 接口上</span>
          <span style="color:#66d9ef">if</span> ! ip r g <span style="color:#e6db74">${</span>ip<span style="color:#e6db74">}</span> | grep -qw lo;<span style="color:#66d9ef">then</span>
              ip addr add <span style="color:#e6db74">${</span>ip<span style="color:#e6db74">}</span>/32 dev <span style="color:#e6db74">${</span>dummy_if<span style="color:#e6db74">}</span>
          <span style="color:#66d9ef">fi</span>
      <span style="color:#66d9ef">done</span>
  <span style="color:#66d9ef">done</span>
  <span style="color:#75715e"># 重新 reload</span> 
  pkill --signal HUP keepalived
<span style="color:#f92672">}</span>

main $@

</code></pre></div><p>脚本就如上面所示，读取 keepalived 的 lvs 文件，把 <code>VIP:PORT</code> 加到 ipset 里，VIP 加到 <code>dummy</code> 接口上，之前是加到 eth0 上，但是业务网卡可能会重启影响，dummy 接口和 loopback 类似，它总是 up 的，除非你 down 掉它，SVC 地址配置在它上面不会随着物理接口状态变化而受到影响。删除掉之前 eth0 上的 VIP <code>ip addr del 169.254.11.2/32 dev eth0</code>，然后把前面的转成 keepalived 的配置文件测试下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod a+x /etc/keepalived/ipvs.sh
cat &gt; /etc/keepalived/conf.d/test.conf <span style="color:#e6db74">&lt;&lt; EOF
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">virtual_server 169.254.11.2 80 {
</span><span style="color:#e6db74">    delay_loop 6
</span><span style="color:#e6db74">    lb_algo rr
</span><span style="color:#e6db74">    lb_kind NAT
</span><span style="color:#e6db74">    protocol TCP
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    real_server  192.168.2.111 8080 {
</span><span style="color:#e6db74">        weight 1
</span><span style="color:#e6db74">        HTTP_GET  {
</span><span style="color:#e6db74">            url {
</span><span style="color:#e6db74">              path /404
</span><span style="color:#e6db74">              status_code 404
</span><span style="color:#e6db74">            }
</span><span style="color:#e6db74">            connect_port    8080
</span><span style="color:#e6db74">            connect_timeout 2
</span><span style="color:#e6db74">            retry 2
</span><span style="color:#e6db74">            delay_before_retry 2
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">    }
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    real_server  192.168.2.222 8080 {
</span><span style="color:#e6db74">        weight 1
</span><span style="color:#e6db74">        HTTP_GET  {
</span><span style="color:#e6db74">            url {
</span><span style="color:#e6db74">              path /404
</span><span style="color:#e6db74">              status_code 404
</span><span style="color:#e6db74">            }
</span><span style="color:#e6db74">            connect_port    8080
</span><span style="color:#e6db74">            connect_timeout 2
</span><span style="color:#e6db74">            retry 2
</span><span style="color:#e6db74">            delay_before_retry 2
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">    }
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>测试下</p>
<pre><code># 先清理掉之前手动添加的
ipvsadm --clear

systemctl daemon-reload
systemctl restart keepalived

$ curl 169.254.11.2/www/test
192.168.2.222
$ curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.222
$ curl 169.254.11.2/www/test
192.168.2.111
$ ip a s SVC
4: SVC: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether e6:a3:29:07:fa:57 brd ff:ff:ff:ff:ff:ff
    inet 169.254.11.2/32 scope global SVC
       valid_lft forever preferred_lft forever
</code></pre><p>停掉一个 web 后在我们配置的健康检查几秒也剔除了 rs ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl 169.254.11.2/www/test
curl: <span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> Failed connect to 169.254.11.2:80; Connection refused
$ curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.111
</code></pre></div><h4 id="系统的相关配置">系统的相关配置</h4>
<p>后面重启后发现不通，发现内核模块没加载，使用 <code>systemd-modules-load</code> 去开机加载：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat  &gt; /etc/modules-load.d/ipvs.conf <span style="color:#e6db74">&lt;&lt; EOF
</span><span style="color:#e6db74">ip_vs
</span><span style="color:#e6db74">ip_vs_rr
</span><span style="color:#e6db74">ip_vs_wrr
</span><span style="color:#e6db74">ip_vs_sh
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EOF</span>

cat &gt; /etc/sysctl.d/90.ipvs.conf <span style="color:#e6db74">&lt;&lt; EOF 
</span><span style="color:#e6db74"># https://github.com/moby/moby/issues/31208 
</span><span style="color:#e6db74"># ipvsadm -l --timout
</span><span style="color:#e6db74"># 修复ipvs模式下长连接timeout问题 小于900即可
</span><span style="color:#e6db74">net.ipv4.tcp_keepalive_time=600
</span><span style="color:#e6db74">net.ipv4.tcp_keepalive_intvl=30
</span><span style="color:#e6db74">net.ipv4.vs.conntrack=1
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><h3 id="docker-运行的方案">docker 运行的方案</h3>
<p><code>docker-compose</code> 文件如下，自己把脚本挂载进去即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#39;3.5&#39;</span>
<span style="color:#66d9ef">services</span>:
  <span style="color:#66d9ef">keepalived</span>: 
    <span style="color:#66d9ef">image</span>: <span style="color:#e6db74">&#39;registry.aliyuncs.com/zhangguanzhang/keepalived:v2.2.0&#39;</span>
    <span style="color:#66d9ef">hostname</span>: <span style="color:#e6db74">&#39;keepalived-ipvs&#39;</span>
    <span style="color:#66d9ef">restart</span>: unless-stopped
    <span style="color:#66d9ef">container_name</span>: <span style="color:#e6db74">&#34;keepalived-ipvs&#34;</span>
    <span style="color:#66d9ef">labels</span>: 
      - app=keepalived
    <span style="color:#66d9ef">network_mode</span>: host
    <span style="color:#66d9ef">privileged</span>: <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">cap_drop</span>:
      - ALL
    <span style="color:#66d9ef">cap_add</span>:
      - NET_BIND_SERVICE
    <span style="color:#66d9ef">volumes</span>:
      - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro
      - /lib/modules:/lib/modules
      - /run/xtables.lock:/run/xtables.lock
      - ./conf.d/:/etc/keepalived/conf.d/
      - ./keepalived.conf:/etc/keepalived/keepalived.conf
      - ./always-initsh.d:/always-initsh.d
    <span style="color:#66d9ef">command</span>: 
      - --dont-fork
      - --log-console
      - --log-detail
      - --use-file=/etc/keepalived/keepalived.conf
    <span style="color:#66d9ef">logging</span>:
      <span style="color:#66d9ef">driver</span>: json-file
      <span style="color:#66d9ef">options</span>:
        <span style="color:#66d9ef">max-file</span>: <span style="color:#e6db74">&#39;3&#39;</span>
        <span style="color:#66d9ef">max-size</span>: 20m
</code></pre></div><h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.filter_rules.html">Interaction between LVS and netfilter</a></li>
<li><a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.LVS-NAT.html#lvs_nat_intro">lvs nat</a></li>
<li><a href="https://github.com/liexusong/linux-source-code-analyze/blob/master/lvs-principle-and-source-analysis-part2.md">lvs-principle-and-source-analysis</a></li>
<li><a href="https://www.zsythink.net/archives/1199">朱双印大佬的 iptables 技术系列</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/ipvs"> 
            IPVS</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/lvs"> , 
            Lvs</a>
            
          </ul>
        </div>
        <!-- previous -->
        
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://cloudnative.to/blog/edge-sig-learn-20/" data-toggle="tooltip" data-placement="top" title="边缘计算专家长成计划入门20篇">&larr; 上一篇</a>
</li>
 
</ul>
</div>


        <!-- previous -->

        <!-- recommend -->
        


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
    <!-- categories -->
<div class="bg-pink px-4 py-5 box-shadow mb-5">
  <h4 class="mb-4">分类</h4>
  <ul class="list-unstyled">
    <li class="border-bottom"><a href="/categories/devops" class="d-block pb-3 mt-3 text-capitalize">Devops</a></li>
    <li class="border-bottom"><a href="/categories/devsecops" class="d-block pb-3 mt-3 text-capitalize">Devsecops</a></li>
    <li class="border-bottom"><a href="/categories/envoy" class="d-block pb-3 mt-3 text-capitalize">Envoy</a></li>
    <li class="border-bottom"><a href="/categories/ipvs" class="d-block pb-3 mt-3 text-capitalize">Ipvs</a></li>
    <li class="border-bottom"><a href="/categories/istio" class="d-block pb-3 mt-3 text-capitalize">Istio</a></li>
    <li class="border-bottom"><a href="/categories/kubernetes" class="d-block pb-3 mt-3 text-capitalize">Kubernetes</a></li>
    <li class="border-bottom"><a href="/categories/serverless" class="d-block pb-3 mt-3 text-capitalize">Serverless</a></li>
    <li class="border-bottom"><a href="/categories/service-mesh" class="d-block pb-3 mt-3 text-capitalize">Service mesh</a></li>
    <li class="border-bottom"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="d-block pb-3 mt-3 text-capitalize">云原生</a></li>
    <li class="border-bottom"><a href="/categories/%e5%85%b6%e4%bb%96" class="d-block pb-3 mt-3 text-capitalize">其他</a></li>
    <li class="border-bottom"><a href="/categories/%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">可观察性</a></li>
    <li class="border-bottom"><a href="/categories/%e5%ae%89%e5%85%a8" class="d-block pb-3 mt-3 text-capitalize">安全</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90" class="d-block pb-3 mt-3 text-capitalize">开源</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" class="d-block pb-3 mt-3 text-capitalize">开源社区</a></li>
    <li class="border-bottom"><a href="/categories/%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98" class="d-block pb-3 mt-3 text-capitalize">持续交付</a></li>
    <li class="border-bottom"><a href="/categories/%e7%a8%b3%e5%ae%9a%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">稳定性</a></li>
    <li class="border-bottom"><a href="/categories/%e8%be%b9%e7%bc%98%e8%ae%a1%e7%ae%97" class="d-block pb-3 mt-3 text-capitalize">边缘计算</a></li>
  </ul>
</div>

  <!-- tags -->
  

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <div class="mx-auto avatar-wrp">
        <img class="rounded-circle avatar-img" src="/images/profile/zhangguanzhang.png">
      </div>
      <p class="avatar-name">
        <strong class="text-dark "><a href="https://zhangguanzhang.github.io/">张浩</a></strong> 
      </p>
      <p>金山办公软件运维开发工程师，containers/podman 的 Collaborator。目前主要从事运维开发和 K8S 相关的工作。</p>
    </div>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#环境信息">环境信息</a></li>
    <li><a href="#过程">过程</a>
      <ul>
        <li><a href="#准备工作">准备工作</a></li>
        <li><a href="#lvs-nat">lvs nat</a></li>
        <li><a href="#利用-ipset-和-iptable-的-mark">利用 ipset 和 iptable 的 mark</a></li>
        <li><a href="#keepalived-的自动化实现">keepalived 的自动化实现</a></li>
        <li><a href="#docker-运行的方案">docker 运行的方案</a></li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是国内最大的独立第三方云原生终端用户和泛开发者社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，提供云原生专业资讯，促进云原生产业发展。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fab fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fab fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://mp.weixin.qq.com/s/vWlSdzz2MNdXRr0sd2-LFg"><i class="fab fa-weixin"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="far fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://zhuanlan.zhihu.com/cloud-native"><i class="fab fa-zhihu"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://space.bilibili.com/515485124"><i class="fas fa-play-circle"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fas fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="/city/chengdu">成都</a>|<a href="/city/shenzhen">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="/city/guangzhou/">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2021 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/policy"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
