<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="在没有容器的环境下，靠基础的软件实现一个 IPVS 的 SVC 负载。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/create-a-ipvs-svc-without-container/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.008259417e6adf8980695ebbbb46553f.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0802e500a55b0406ddf0453824effa47_6997_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/create-a-ipvs-svc-without-container/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/create-a-ipvs-svc-without-container/" />
  <meta property="og:title" content="在非容器环境上实现散装的 IPVS SVC | 云原生社区（中国）" />
  <meta property="og:description" content="在没有容器的环境下，靠基础的软件实现一个 IPVS 的 SVC 负载。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2021-09-29T00:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2024-06-14T16:16:36&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/create-a-ipvs-svc-without-container/"
  },
  "headline": "在非容器环境上实现散装的 IPVS SVC",
  
  "datePublished": "2021-09-29T00:00:00+08:00",
  "dateModified": "2024-06-14T16:16:36+08:00",
  
  "author": {
    "@type": "Person",
    "name": "张浩"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "在没有容器的环境下，靠基础的软件实现一个 IPVS 的 SVC 负载。"
}
</script>

  

  

  

  





  <title>在非容器环境上实现散装的 IPVS SVC | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="e69c338004fa2e77144dd60bc5c4e13a" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>小组</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/k8s-gateway-api"><span>Kubernetes Gateway API SIG</span></a>
              
            </div>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>在非容器环境上实现散装的 IPVS SVC</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E5%BC%A0%E6%B5%A9/">张浩</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/kubernetes/" class="text-capitalize">kubernetes</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2021-09-29
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 4383
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 20 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#环境信息">环境信息</a></li>
    <li><a href="#过程">过程</a>
      <ul>
        <li><a href="#准备工作">准备工作</a></li>
        <li><a href="#lvs-nat">lvs nat</a></li>
        <li><a href="#利用-ipset-和-iptable-的-mark">利用 ipset 和 iptable 的 mark</a></li>
        <li><a href="#keepalived-的自动化实现">keepalived 的自动化实现</a></li>
        <li><a href="#docker-运行的方案">docker 运行的方案</a></li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#环境信息">环境信息</a></li>
    <li><a href="#过程">过程</a>
      <ul>
        <li><a href="#准备工作">准备工作</a></li>
        <li><a href="#lvs-nat">lvs nat</a></li>
        <li><a href="#利用-ipset-和-iptable-的-mark">利用 ipset 和 iptable 的 mark</a></li>
        <li><a href="#keepalived-的自动化实现">keepalived 的自动化实现</a></li>
        <li><a href="#docker-运行的方案">docker 运行的方案</a></li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
</details>

                    
                    <h2 id="前言">前言</h2>
<p>内部有非 K8S 环境上需要类似 SVC 的负载实现，一开始是用 NGINX 做的，所有 SVC 域名都解析成一个 dummy IP，然后 NGINX 根据 <code>server_name</code> 去 proxy 不同的 upstream。开始还是能用的，但是后面结果后面很多服务依赖 <code>host</code> 这个 header，报错签名错误，而且毕竟这样是在用户态，效率不如内核态高。于是打算搞下之前的打算：把 IPVS 的 <code>ClusterIP</code> 的 SVC 扣到非 K8S 环境上使用。</p>
<p>kube-proxy 的 SVC 简单讲就是 node 上任何进程访问 <code>SVC IP:SVC PORT</code> 会被 dnat 成 <code>endpoint</code> ，是工作在内核态的四层负载，不会在机器上看到端口监听，而默认非集群的机器是无法访问 SVC IP。在 K8S 里，endpoint 的 ip 无非就是 <code>POD IP</code>，<code>host IP</code>。前者就是 SVC 选中 POD，后者例如 <code>kubernetes</code> 这个 SVC，会 DNAT 成每个 <code>kube-apiserver</code> 的 <code>host IP:6443</code> 端口，也可能是 <code>ExternalName</code> 或者手动创建的 endpoint。既然 <code>kubernetes</code> 这个 SVC 可以。那我的打算应该也是可以实现的。但是一开始实际按照思路试了下发现不行，网上的文章基本都是在单机 docker 或者现有的 K8S 环境上搞的，漏掉了很多精华和核心思想，这里记录下我的思路和实现过程。</p>
<h2 id="环境信息">环境信息</h2>
<p>前面说的 SVC 现象是和 <code>kube-proxy</code> 的模式无关的。<code>iptables</code> 模式排查不直观，我更倾向于 <code>IPVS</code> 去搞，它更直观，而且支持更多的调度算法。管理 IPVS 规则的话我们需要安装 <code>ipvsadm</code> ，这里我是两台干净的 CentOS 7.8 来做环境。</p>
<table>
<thead>
<tr>
<th style="text-align:left">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">192.168.2.111</td>
</tr>
<tr>
<td style="text-align:left">192.168.2.222</td>
</tr>
</tbody>
</table>
<p>先安装下基础需要的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yum install -y ipvsadm curl wget tcpdump ipset conntrack-tools
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 开启转发</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 确认 iptables 规则清空</span>
</span></span><span class="line"><span class="cl">$ iptables -S
</span></span><span class="line"><span class="cl">-P INPUT ACCEPT
</span></span><span class="line"><span class="cl">-P FORWARD ACCEPT
</span></span><span class="line"><span class="cl">-P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">$ iptables -t nat -S
</span></span><span class="line"><span class="cl">-P PREROUTING ACCEPT
</span></span><span class="line"><span class="cl">-P INPUT ACCEPT
</span></span><span class="line"><span class="cl">-P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">-P POSTROUTING ACCEPT
</span></span></code></pre></div><h2 id="过程">过程</h2>
<p>先思考下 kube-proxy 的 IPVS，因为 SVC 端口和 POD 的端口不一样，所以 kube-proxy 使用的 <code>nat</code> 模式。暂且打算添加一个下面类似的 SVC：</p>
<pre tabindex="0"><code>IP:                169.254.11.2
Port:              https  80/TCP
TargetPort:        6443/TCP
Endpoints:         192.168.2.111:8080,192.168.2.222:8080
Session Affinity:  None
</code></pre><h3 id="准备工作">准备工作</h3>
<p>web 的话我是使用的 golang 的一个简单 web 二进制起的 <a href="https://github.com/m3ng9i/ran" target="_blank" rel="noopener">ran</a> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/m3ng9i/ran/releases/download/v0.1.6/ran_linux_amd64.zip
</span></span><span class="line"><span class="cl">unzip -x ran_linux_amd64.zip
</span></span><span class="line"><span class="cl">mkdir www
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 两个机器创建不同的 index 文件</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 192.168.2.111 &gt; www/test
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 192.168.2.222 &gt; www/test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./ran_linux_amd64 -port <span class="m">8080</span> -listdir www
</span></span></code></pre></div><p>两个机器的这个 web 都起来后我们开个窗口去 <code>192.168.2.111</code> 上继续后面的操作。</p>
<h3 id="lvs-nat">lvs nat</h3>
<p>kube-proxy 并没有像 lvs nat 那样有单独的机器做 <code>NAT GW</code>，或者认为每个 node 都是自己的 <code>NAT GW</code>。现在来添加 <code>169.254.11.2:80</code> 这个 SVC，使用 ipvsadm 添加：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ipvsadm --add-service --tcp-service 169.254.11.2:80 --scheduler rr
</span></span></code></pre></div><p>先添加本地的 web 作为 real server，下面含义是添加为一个 nat 类型的 real server：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ipvsadm --add-server --tcp-service 169.254.11.2:80 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --real-server 192.168.2.111:8080 --masquerading --weight <span class="m">1</span>
</span></span></code></pre></div><p>查看下当前列表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ipvsadm -ln
</span></span><span class="line"><span class="cl">IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span class="line"><span class="cl">TCP  169.254.11.2:80 rr
</span></span><span class="line"><span class="cl">  -&gt; 192.168.2.111:8080           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span> 
</span></span></code></pre></div><p>因为是自己的 <code>NAT GW</code>，所以 VIP 配置在自己身上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip addr add 169.254.11.2/32 dev eth0
</span></span></code></pre></div><p>测试下访问看看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span></code></pre></div><p>添加上另一个节点的 8080：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ipvsadm --add-server --tcp-service 169.254.11.2:80 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --real-server 192.168.2.222:8080 --masquerading --weight <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ipvsadm -ln
</span></span><span class="line"><span class="cl">IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span class="line"><span class="cl">TCP  169.254.11.2:80 rr
</span></span><span class="line"><span class="cl">  -&gt; 192.168.2.111:8080           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
</span></span><span class="line"><span class="cl">  -&gt; 192.168.2.222:8080           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span></code></pre></div><p>测试下访问看看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span></code></pre></div><p>发现 curl 在卡住和能访问返回 <code>192.168.2.111</code> 之间切换，没有返回 <code>192.168.2.222</code> 的。查看下 IPVS 的 connection，发现调度到非本机才会卡住：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ipvsadm -lnc
</span></span><span class="line"><span class="cl">IPVS connection entries
</span></span><span class="line"><span class="cl">pro expire state       <span class="nb">source</span>             virtual            destination
</span></span><span class="line"><span class="cl">TCP 00:48  SYN_RECV    169.254.11.2:50698 169.254.11.2:80    192.168.2.222:8080
</span></span></code></pre></div><p>在 <code>192.168.2.222</code> 上抓包看看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tcpdump -nn -i eth0 port <span class="m">8080</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">07:38:26.360716 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span class="o">[</span>S<span class="o">]</span>, seq 768065283, win 43690, options <span class="o">[</span>mss 65495,sackOK,TS val <span class="m">12276183</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:26.360762 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 2142784980, ack 768065284, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676518144</span> ecr 12276183,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:27.362848 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span class="o">[</span>S<span class="o">]</span>, seq 768065283, win 43690, options <span class="o">[</span>mss 65495,sackOK,TS val <span class="m">12277186</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:27.362884 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 2142784980, ack 768065284, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676519146</span> ecr 12276183,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:28.562629 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 2142784980, ack 768065284, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676520346</span> ecr 12276183,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:29.368811 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span class="o">[</span>S<span class="o">]</span>, seq 768065283, win 43690, options <span class="o">[</span>mss 65495,sackOK,TS val <span class="m">12279192</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:29.368853 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 2142784980, ack 768065284, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676521152</span> ecr 12276183,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:31.562633 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 2142784980, ack 768065284, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676523346</span> ecr 12276183,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:33.376829 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags <span class="o">[</span>S<span class="o">]</span>, seq 768065283, win 43690, options <span class="o">[</span>mss 65495,sackOK,TS val <span class="m">12283200</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:33.376869 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 2142784980, ack 768065284, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676525160</span> ecr 12276183,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">07:38:37.562632 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 2142784980, ack 768065284, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676529346</span> ecr 12276183,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span></code></pre></div><p>从 <code>Flags</code> 看，就是 tcp 重传，并且 <code>SRC IP</code> 是 VIP。节点 <code>192.168.2.222.8080</code> 给 <code>169.254.11.2.50710</code> 回包会走到网关上去。网关上抓包也看到确实如此：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tcpdump -nn -i eth0 host 169.254.11.2
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">19:39:47.487362 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 4149799699, ack 251479303, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676599263</span> ecr 12357303,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">19:39:47.487405 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 4149799699, ack 251479303, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676599263</span> ecr 12357303,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">19:39:48.487838 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 4149799699, ack 251479303, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676600264</span> ecr 12357303,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">19:39:48.487868 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 4149799699, ack 251479303, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676600264</span> ecr 12357303,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">19:39:49.569667 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 4149799699, ack 251479303, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676601346</span> ecr 12357303,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">19:39:49.569699 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 4149799699, ack 251479303, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">676601346</span> ecr 12357303,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span></code></pre></div><h4 id="lvs-和-netfilter">lvs 和 netfilter</h4>
<p>在介绍 lvs 的实现之前，我们需要了解 netfilter，Linux 的所有数据包都会经过它，而我们使用的 iptables 是用户态提供的操作工具之一。Linux 内核处理进出的数据包分为了 5 个阶段。netfilter 在这 5 个阶段提供了 hook 点，来让注册的 hook 函数来实现对包的过滤和修改。下图的 local process 就是上层的协议栈。</p>
<p>下面是 IPVS 在 netfilter 里的模型图，IPVS 也是基于 netfilter 框架的，但只工作在 <code>INPUT</code> 链上，通过注册 <code>ip_vs_in</code> 钩子函数来处理请求。因为 VIP 我们配置在机器上（常规的 lvs nat 的 VIP 是在 NAT GW 上，我们这里是自己），我们 curl 的时候就会进到 <code>INPUT</code> 链，<code>ip_vs_in</code> 会匹配然后直接跳转触发 <code>POSTROUTING</code> 链，跳过 iptables 规则。</p>
<p>















<figure  id="figure-lvs-netfilter">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="lvs-netfilter" srcset="
               /blog/create-a-ipvs-svc-without-container/lvs-netfilter_hu5d707f2602b042ea90cf8a8f122bcebe_17969_6f0d9b8c65a8d0fa8a11e56fb8fc4d2d.webp 400w,
               /blog/create-a-ipvs-svc-without-container/lvs-netfilter_hu5d707f2602b042ea90cf8a8f122bcebe_17969_7fb6ce1beefbd7e885bac370026f751f.webp 760w,
               /blog/create-a-ipvs-svc-without-container/lvs-netfilter_hu5d707f2602b042ea90cf8a8f122bcebe_17969_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/create-a-ipvs-svc-without-container/lvs-netfilter_hu5d707f2602b042ea90cf8a8f122bcebe_17969_6f0d9b8c65a8d0fa8a11e56fb8fc4d2d.webp"
               width="718"
               height="311"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      lvs-netfilter
    </figcaption></figure>
</p>
<p>所以请求流程是：</p>
<pre tabindex="0"><code># CIP: client IP    # RIP: real server IP

	CLIENT
	   | CIP:CPORT -&gt; VIP:VPORT
	   |		||
	   |		\/
    	   | CIP:CPORT -&gt; VIP:VPORT
   	LVS DNAT
   	   | CIP:CPORT -&gt; RIP:RPORT
   	   |		||
	   |		\/
	   | CIP:CPORT -&gt; RIP:RPORT
	   +
	REAL SERVER
</code></pre><p>lvs 做了 DNAT 并没有做 SNAT，所以我们利用 iptables 做 SNAT：</p>
<pre tabindex="0"><code>$ iptables -t nat -A POSTROUTING -m ipvs --vaddr 169.254.11.2 --vport 80 -j MASQUERADE
</code></pre><p>访问看看还是不通，抓包看还是没生效，nat 是依赖 <code>conntrack</code> 的，而 IPVS 默认不会记录 conntrack，我们需要开启 IPVS 的 conntrack 才可以让 MASQUERADE 生效。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 让 Netfilter 的 conntrack 状态管理功能也能应用于 IPVS 模块</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="m">1</span> &gt;  /proc/sys/net/ipv4/vs/conntrack
</span></span><span class="line"><span class="cl">$  curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.222
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.222
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.222
</span></span></code></pre></div><p>现在实现了单个 SVC 的，但是仔细思考下还是有问题，如果后续增加另一个 SVC 又得增加一个 iptables 规则了，那就又回到 iptables 的匹配复杂度耗时长上去了。所以我们可以利用 iptables 的 mark 和 ipset 配合减少 iptables 规则。</p>
<h3 id="利用-ipset-和-iptable-的-mark">利用 ipset 和 iptable 的 mark</h3>
<p>















<figure  id="figure-iptables_netfilter">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="iptables_netfilter" srcset="
               /blog/create-a-ipvs-svc-without-container/iptables_netfilter_hu791469d1e639189dc2ab87e87a05257d_132347_fe5327fda4944f2642d3be1f81371b24.webp 400w,
               /blog/create-a-ipvs-svc-without-container/iptables_netfilter_hu791469d1e639189dc2ab87e87a05257d_132347_051347fe693117f9b3c279aaa272fbe8.webp 760w,
               /blog/create-a-ipvs-svc-without-container/iptables_netfilter_hu791469d1e639189dc2ab87e87a05257d_132347_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/create-a-ipvs-svc-without-container/iptables_netfilter_hu791469d1e639189dc2ab87e87a05257d_132347_fe5327fda4944f2642d3be1f81371b24.webp"
               width="760"
               height="401"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      iptables_netfilter
    </figcaption></figure>
</p>
<p>iptables 的五链四表如上图所示，我们先删掉原有的规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -D POSTROUTING -m ipvs --vaddr 169.254.11.2 --vport <span class="m">80</span> -j MASQUERADE
</span></span></code></pre></div><p>平时自己家里使用了 openwrt，之前看了下上面的 iptables 规则设计挺好的，特别是预留了很多链专门给用户在合适的位置插入规则，比如下面的 <code>INPUT</code> 规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-A INPUT -i eth0 -m comment --comment <span class="s2">&#34;!fw3&#34;</span> -j zone_lan_input
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">-A zone_lan_input -m comment --comment <span class="s2">&#34;!fw3: Custom lan input rule chain&#34;</span> -j input_lan_rule
</span></span><span class="line"><span class="cl">-A zone_lan_input -m conntrack --ctstate DNAT -m comment --comment <span class="s2">&#34;!fw3: Accept port redirections&#34;</span> -j ACCEPT
</span></span><span class="line"><span class="cl">-A zone_lan_input -m comment --comment <span class="s2">&#34;!fw3&#34;</span> -j zone_lan_src_ACCEPT
</span></span></code></pre></div><p><code>zone_lan_src_ACCEPT</code> 是最后面，<code>zone_lan_input</code> 是最开始，那用户向 <code>input_lan_rule</code> 链里插入规则即可，利用多个链来设计也方便别人。
规则设计我们先逆着来思考下，最后肯定是 <code>MASQUERADE</code> 的，得在 nat 表的 <code>POSTROUTING</code> 链创建 <code>MASQUERADE</code> 的规则。</p>
<p>但是添加之前先思考下，lvs 做了 DNAT 后，最后包走向了 <code>POSTROUTING</code> 链，而且后面我们是有多个 SVC 的。此刻包的 <code>SRC IP</code> 会是 <code>VIP</code>，而 <code>DEST IP</code> 是做了 DNAT 后的 <code>real server</code> ，而且后续可能是在在 docker 环境上部署，可能默认桥接网络的容器也会去访问 <code>SVC</code>，此刻的 <code>SRC IP</code> 就不会是网卡上的 <code>VIP</code> 了，但是在 <code>PREROUTING</code> 链的时候，<code>DEST IP</code> 还没变，我们可以在此刻利用一个 ipset 存储所有的 <code>SVC_IP:SVC_PORT</code> 匹配，然后打上 mark，然后在 <code>POSTROUTING</code> 链去根据 mark 去做 <code>MASQUERADE</code> 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># PREROUTING 阶段处理</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提供一个入口链，而不是直接添加在 PREROUTING 链上</span>
</span></span><span class="line"><span class="cl">iptables -t nat -N ZGZ-SERVICES
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -m comment --comment <span class="s2">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在 PREROUTING 子链里去 ipset 匹配，跳转到我们 mark 的链</span>
</span></span><span class="line"><span class="cl">iptables -t nat -N ZGZ-MARK-MASQ
</span></span><span class="line"><span class="cl"><span class="c1"># 创建存储所有 `SVC_IP:SVC_PORT` 的 ipset </span>
</span></span><span class="line"><span class="cl">ipset create ZGZ-CLUSTER-IP hash:ip,port -exist
</span></span><span class="line"><span class="cl">iptables -t nat -A ZGZ-SERVICES -m comment --comment <span class="s2">&#34;zgz service cluster ip + port for masquerade purpose&#34;</span> -m <span class="nb">set</span> --match-set ZGZ-CLUSTER-IP dst,dst -j ZGZ-MARK-MASQ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 专门 mark 的链</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A ZGZ-MARK-MASQ -j MARK --set-xmark 0x2000/0x2000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POSTROUTING 阶段处理</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提供一个入口链，而不是直接添加在 POSTROUTING 链上</span>
</span></span><span class="line"><span class="cl">iptables -t nat -N ZGZ-POSTROUTING
</span></span><span class="line"><span class="cl">iptables -t nat -A POSTROUTING -m comment --comment <span class="s2">&#34;zgz postrouting rules&#34;</span> -j ZGZ-POSTROUTING
</span></span><span class="line"><span class="cl"><span class="c1"># 在 POSTROUTING 阶段做 snat</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A ZGZ-POSTROUTING -m comment --comment <span class="s2">&#34;zgz service traffic requiring SNAT&#34;</span> -m mark --mark 0x2000/0x2000 -j MASQUERADE
</span></span></code></pre></div><p>然后添加下 <code>SVC_IP:SVC_PORT</code> 到我们的 ipset 里：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ipset add ZGZ-CLUSTER-IP 169.254.11.2,tcp:80 -exist
</span></span></code></pre></div><p>上面我们创建的 ipset 里 <code>ip,port</code> 和 iptables 里 <code>--match-set</code> 后面的 <code>dst,dst</code> 组合在一起就是 <code>DEST IP</code> 和 <code>DEST PORT</code> 同时匹配，下面是一些举例：</p>
<table>
<thead>
<tr>
<th style="text-align:left">ipset type</th>
<th style="text-align:left">iptables match-set</th>
<th style="text-align:left">Packet fields</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">hash:net,port,net</td>
<td style="text-align:left">src,dst,dst</td>
<td style="text-align:left">src IP CIDR address, dst port, dst IP CIDR address</td>
</tr>
<tr>
<td style="text-align:left">hash:net,port,net</td>
<td style="text-align:left">dst,src,src</td>
<td style="text-align:left">dst IP CIDR address, src port, src IP CIDR address</td>
</tr>
<tr>
<td style="text-align:left">hash:ip,port,ip</td>
<td style="text-align:left">src,dst,dst</td>
<td style="text-align:left">src IP address, dst port, dst IP address</td>
</tr>
<tr>
<td style="text-align:left">hash:ip,port,ip</td>
<td style="text-align:left">dst,src,src</td>
<td style="text-align:left">dst IP address, src port, src ip address</td>
</tr>
<tr>
<td style="text-align:left">hash:mac</td>
<td style="text-align:left">src</td>
<td style="text-align:left">src mac address</td>
</tr>
<tr>
<td style="text-align:left">hash:mac</td>
<td style="text-align:left">dst</td>
<td style="text-align:left">dst mac address</td>
</tr>
<tr>
<td style="text-align:left">hash:ip,mac</td>
<td style="text-align:left">src,src</td>
<td style="text-align:left">src IP address, src mac address</td>
</tr>
<tr>
<td style="text-align:left">hash:ip,mac</td>
<td style="text-align:left">dst,dst</td>
<td style="text-align:left">dst IP address, dst mac address</td>
</tr>
<tr>
<td style="text-align:left">hash:ip,mac</td>
<td style="text-align:left">dst,src</td>
<td style="text-align:left">dst IP address, src mac address</td>
</tr>
</tbody>
</table>
<p>然后访问下还是不通，突然想起来在机器上访问本机的 IP 端口的时候是内核直接转发给本地进程，这种数据包会只经过 <code>OUTPUT</code> 链，不会过 <code>PREROUTING</code> ，不过我们上面的 <code>PREROUTING</code> 链可以处理后续的 docker 容器。调试了下发现确实会走 <code>OUTPUT</code> 链：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;kern.warning /var/log/iptables.log&#39;</span> &gt;&gt; /etc/rsyslog.conf
</span></span><span class="line"><span class="cl">$ systemctl restart rsyslog
</span></span><span class="line"><span class="cl">$ iptables -t nat -I OUTPUT -m <span class="nb">set</span> --match-set ZGZ-CLUSTER-IP dst,dst  -j LOG --log-prefix <span class="s1">&#39;**log-test**&#39;</span>
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">$ cat /var/log/iptables.log
</span></span><span class="line"><span class="cl">Sep <span class="m">27</span> 23:17:51 centos7 kernel: **log-test**IN<span class="o">=</span> <span class="nv">OUT</span><span class="o">=</span>lo <span class="nv">SRC</span><span class="o">=</span>169.254.11.2 <span class="nv">DST</span><span class="o">=</span>169.254.11.2 <span class="nv">LEN</span><span class="o">=</span><span class="m">60</span> <span class="nv">TOS</span><span class="o">=</span>0x00 <span class="nv">PREC</span><span class="o">=</span>0x00 <span class="nv">TTL</span><span class="o">=</span><span class="m">64</span> <span class="nv">ID</span><span class="o">=</span><span class="m">44864</span> DF <span class="nv">PROTO</span><span class="o">=</span>TCP <span class="nv">SPT</span><span class="o">=</span><span class="m">50794</span> <span class="nv">DPT</span><span class="o">=</span><span class="m">80</span> <span class="nv">WINDOW</span><span class="o">=</span><span class="m">43690</span> <span class="nv">RES</span><span class="o">=</span>0x00 SYN <span class="nv">URGP</span><span class="o">=</span><span class="m">0</span> 
</span></span><span class="line"><span class="cl">Sep <span class="m">27</span> 23:17:52 centos7 kernel: **log-test**IN<span class="o">=</span> <span class="nv">OUT</span><span class="o">=</span>lo <span class="nv">SRC</span><span class="o">=</span>169.254.11.2 <span class="nv">DST</span><span class="o">=</span>169.254.11.2 <span class="nv">LEN</span><span class="o">=</span><span class="m">60</span> <span class="nv">TOS</span><span class="o">=</span>0x00 <span class="nv">PREC</span><span class="o">=</span>0x00 <span class="nv">TTL</span><span class="o">=</span><span class="m">64</span> <span class="nv">ID</span><span class="o">=</span><span class="m">2010</span> DF <span class="nv">PROTO</span><span class="o">=</span>TCP <span class="nv">SPT</span><span class="o">=</span><span class="m">50796</span> <span class="nv">DPT</span><span class="o">=</span><span class="m">80</span> <span class="nv">WINDOW</span><span class="o">=</span><span class="m">43690</span> <span class="nv">RES</span><span class="o">=</span>0x00 SYN <span class="nv">URGP</span><span class="o">=</span><span class="m">0</span> 
</span></span></code></pre></div><p>需要添加下面规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">iptables -t nat -A OUTPUT -m comment --comment <span class="s2">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES
</span></span></code></pre></div><h3 id="keepalived-的自动化实现">keepalived 的自动化实现</h3>
<p>到目前为止都是手动挡，而且没健康检查，其实我们可以利用 keepalived 做个自动挡的。</p>
<h4 id="安装-keepalived-2">安装 keepalived 2</h4>
<p>CentOS7 自带的源里 <code>keepalived</code> 版本很低，我们安装下比自带新的版本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yum install -y http://www.nosuchhost.net/~cheese/fedora/packages/epel-7/x86_64/cheese-release-7-1.noarch.rpm
</span></span><span class="line"><span class="cl">yum install -y keepalived
</span></span><span class="line"><span class="cl"><span class="c1"># 备份下自带的配置文件</span>
</span></span><span class="line"><span class="cl">cp /etc/keepalived/keepalived.conf<span class="o">{</span>,.bak<span class="o">}</span>
</span></span></code></pre></div><h4 id="配置-keepalived">配置 keepalived</h4>
<p>我们需要配置下 keepalived，修改之前先看下默认相关的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ systemctl cat keepalived
</span></span><span class="line"><span class="cl"><span class="c1"># /usr/lib/systemd/system/keepalived.service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Unit<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Description</span><span class="o">=</span>LVS and VRRP High Availability Monitor
</span></span><span class="line"><span class="cl"><span class="nv">After</span><span class="o">=</span>syslog.target network-online.target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Type</span><span class="o">=</span>forking
</span></span><span class="line"><span class="cl"><span class="nv">KillMode</span><span class="o">=</span>process
</span></span><span class="line"><span class="cl"><span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/keepalived
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/keepalived <span class="nv">$KEEPALIVED_OPTIONS</span>
</span></span><span class="line"><span class="cl"><span class="nv">ExecReload</span><span class="o">=</span>/bin/kill -HUP <span class="nv">$MAINPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Install<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></span><span class="line"><span class="cl">$ cat /etc/sysconfig/keepalived
</span></span><span class="line"><span class="cl"><span class="c1"># Options for keepalived. See `keepalived --help&#39; output and keepalived(8) and</span>
</span></span><span class="line"><span class="cl"><span class="c1"># keepalived.conf(5) man pages for a list of all options. Here are the most</span>
</span></span><span class="line"><span class="cl"><span class="c1"># common ones :</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --vrrp               -P    Only run with VRRP subsystem.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --check              -C    Only run with Health-checker subsystem.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --dont-release-vrrp  -V    Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --dump-conf          -d    Dump the configuration data.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --log-detail         -D    Detailed log messages.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">KEEPALIVED_OPTIONS</span><span class="o">=</span><span class="s2">&#34;-D&#34;</span>
</span></span></code></pre></div><p><code>/etc/sysconfig/keepalived</code> 里修改为下面：</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">KEEPALIVED_OPTIONS=&#34;-D --log-console --log-detail --use-file=/etc/keepalived/keepalived.conf&#34;
</code></pre><p>我们选择在主配置文件里去 include 子配置文件，keepalivd 接收 <code>kill -HUP</code> 信号触发 reload，后续自动化添加 SVC 的时候添加子配置文件后发送信号即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat &gt; /etc/keepalived/keepalived.conf <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">! Configuration File for keepalived
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">global_defs {
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s"># 记住 keepalived 的任何配置文件不能有 x 权限
</span></span></span><span class="line"><span class="cl"><span class="s">include /etc/keepalived/conf.d/*.conf
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">mkdir -p /etc/keepalived/conf.d/
</span></span></code></pre></div><p>我们写一个脚本，一个是用来添加一个子配置文件里的相关信息到 ipset 里，另一方面也让它在重启或者启动 keepalived 的时候每次能初始化，先添加 systemd 的部分：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p /usr/lib/systemd/system/keepalived.service.d
</span></span><span class="line"><span class="cl">cat &gt; /usr/lib/systemd/system/keepalived.service.d/10.keepalived.conf <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">[Service]
</span></span></span><span class="line"><span class="cl"><span class="s">ExecStartPre=/etc/keepalived/ipvs.sh
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>然后编写脚本 <code>/etc/keepalived/ipvs.sh</code> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">dummy_if</span><span class="o">=</span>svc
</span></span><span class="line"><span class="cl"><span class="nv">CONF_DIR</span><span class="o">=</span>/etc/keepalived/conf.d/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> ipset_init<span class="o">(){</span>
</span></span><span class="line"><span class="cl">    ipset create ZGZ-CLUSTER-IP hash:ip,port -exist
</span></span><span class="line"><span class="cl">    ipset flush ZGZ-CLUSTER-IP
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> f ip port protocol
</span></span><span class="line"><span class="cl">    <span class="k">for</span> f in <span class="k">$(</span>find  <span class="si">${</span><span class="nv">CONF_DIR</span><span class="si">}</span> -maxdepth <span class="m">1</span> -type f -name <span class="s1">&#39;*.conf&#39;</span><span class="k">)</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">        awk <span class="s1">&#39;{if($1==&#34;virtual_server&#34;){printf $2&#34; &#34;$3&#34; &#34;;flag=1;};if(flag==1 &amp;&amp; $1==&#34;protocol&#34;){print $2;flag=0}}&#39;</span> <span class="s2">&#34;</span><span class="nv">$f</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> ip port protocol<span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># SVC IP port 插入 ipset 里</span>
</span></span><span class="line"><span class="cl">            ipset add ZGZ-CLUSTER-IP <span class="si">${</span><span class="nv">ip</span><span class="si">}</span>,<span class="si">${</span><span class="nv">protocol</span><span class="p">,,</span><span class="si">}</span>:<span class="si">${</span><span class="nv">port</span><span class="si">}</span> -exist
</span></span><span class="line"><span class="cl">            <span class="c1"># 添加 SVC IP 到 dummy 接口上</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> ! ip r g <span class="si">${</span><span class="nv">ip</span><span class="si">}</span> <span class="p">|</span> grep -qw lo<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">                ip addr add <span class="si">${</span><span class="nv">ip</span><span class="si">}</span>/32 dev <span class="si">${</span><span class="nv">dummy_if</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> create_Chain_in_nat<span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># delete use -X</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> Chain option
</span></span><span class="line"><span class="cl">    <span class="nv">option</span><span class="o">=</span><span class="s2">&#34;-t nat --wait&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> Chain in <span class="nv">$@</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! iptables <span class="nv">$option</span> -S <span class="p">|</span> grep -Eq -- <span class="s2">&#34;-N\s+</span><span class="si">${</span><span class="nv">Chain</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">        iptables <span class="nv">$option</span> -N <span class="si">${</span><span class="nv">Chain</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> create_Rule_in_nat<span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">cmd</span><span class="o">=</span><span class="s1">&#39;iptables -t nat --wait &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! <span class="si">${</span><span class="nv">cmd</span><span class="si">}</span>  --check <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span> 2&gt;/dev/null<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="si">${</span><span class="nv">cmd</span><span class="si">}</span> -A <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> iptables_init<span class="o">(){</span>
</span></span><span class="line"><span class="cl">    create_Chain_in_nat ZGZ-SERVICES  ZGZ-SERVICES-POSTROUTING ZGZ-SERVICES-MARK-MASQ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_Rule_in_nat ZGZ-SERVICES-MARK-MASQ -j MARK --set-xmark 0x2000/0x2000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_Rule_in_nat ZGZ-SERVICES -m comment --comment <span class="s2">&#34;zgz service cluster ip + port for masquerade purpose&#34;</span> -m <span class="nb">set</span> --match-set ZGZ-CLUSTER-IP dst,dst -j ZGZ-SERVICES-MARK-MASQ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_Rule_in_nat PREROUTING -m comment --comment <span class="s2">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES
</span></span><span class="line"><span class="cl">    create_Rule_in_nat OUTPUT -m comment --comment <span class="s2">&#34;zgz service portals&#34;</span> -j ZGZ-SERVICES
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_Rule_in_nat ZGZ-SERVICES-POSTROUTING -m comment --comment <span class="s2">&#34;zgz service traffic requiring SNAT&#34;</span> -m mark --mark 0x2000/0x2000 -j MASQUERADE
</span></span><span class="line"><span class="cl">    create_Rule_in_nat POSTROUTING -m comment --comment <span class="s2">&#34;zgz postrouting rules&#34;</span> -j ZGZ-SERVICES-POSTROUTING
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> ipvs_svc_run<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  ip addr flush dev <span class="si">${</span><span class="nv">dummy_if</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">  ipset_init
</span></span><span class="line"><span class="cl">  iptables_init
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 无参数则是 keepalived 启动，也可以接收单个配置文件参数</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> main<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> ! -d /proc/sys/net/ipv4/conf/<span class="si">${</span><span class="nv">dummy_if</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    ip link add <span class="si">${</span><span class="nv">dummy_if</span><span class="si">}</span> <span class="nb">type</span> dummy
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    ipvs_svc_run
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">local</span> file fullFile ip port protocol
</span></span><span class="line"><span class="cl">  <span class="k">for</span> file in <span class="nv">$@</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nv">fullFile</span><span class="o">=</span><span class="si">${</span><span class="nv">CONF_DIR</span><span class="si">}</span>/<span class="nv">$file</span>
</span></span><span class="line"><span class="cl">      awk <span class="s1">&#39;{if($1==&#34;virtual_server&#34;){printf $2&#34; &#34;$3&#34; &#34;;flag=1;};if(flag==1 &amp;&amp; $1==&#34;protocol&#34;){print $2;flag=0}}&#39;</span> <span class="s2">&#34;</span><span class="nv">$f</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> ip port protocol<span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># SVC IP port 插入 ipset 里</span>
</span></span><span class="line"><span class="cl">          ipset add ZGZ-CLUSTER-IP <span class="si">${</span><span class="nv">ip</span><span class="si">}</span>,<span class="si">${</span><span class="nv">protocol</span><span class="p">,,</span><span class="si">}</span>:<span class="si">${</span><span class="nv">port</span><span class="si">}</span> -exist
</span></span><span class="line"><span class="cl">          <span class="c1"># 添加 SVC IP 到 dummy 接口上</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> ! ip r g <span class="si">${</span><span class="nv">ip</span><span class="si">}</span> <span class="p">|</span> grep -qw lo<span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">              ip addr add <span class="si">${</span><span class="nv">ip</span><span class="si">}</span>/32 dev <span class="si">${</span><span class="nv">dummy_if</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">fi</span>
</span></span><span class="line"><span class="cl">      <span class="k">done</span>
</span></span><span class="line"><span class="cl">  <span class="k">done</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 重新 reload </span>
</span></span><span class="line"><span class="cl">  pkill --signal HUP keepalived
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">main <span class="nv">$@</span>
</span></span></code></pre></div><p>脚本就如上面所示，读取 keepalived 的 lvs 文件，把 <code>VIP:PORT</code> 加到 ipset 里，VIP 加到 <code>dummy</code> 接口上，之前是加到 eth0 上，但是业务网卡可能会重启影响，dummy 接口和 loopback 类似，它总是 up 的，除非你 down 掉它，SVC 地址配置在它上面不会随着物理接口状态变化而受到影响。删除掉之前 eth0 上的 VIP <code>ip addr del 169.254.11.2/32 dev eth0</code>，然后把前面的转成 keepalived 的配置文件测试下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod a+x /etc/keepalived/ipvs.sh
</span></span><span class="line"><span class="cl">cat &gt; /etc/keepalived/conf.d/test.conf <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">virtual_server 169.254.11.2 80 {
</span></span></span><span class="line"><span class="cl"><span class="s">    delay_loop 6
</span></span></span><span class="line"><span class="cl"><span class="s">    lb_algo rr
</span></span></span><span class="line"><span class="cl"><span class="s">    lb_kind NAT
</span></span></span><span class="line"><span class="cl"><span class="s">    protocol TCP
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    real_server  192.168.2.111 8080 {
</span></span></span><span class="line"><span class="cl"><span class="s">        weight 1
</span></span></span><span class="line"><span class="cl"><span class="s">        HTTP_GET  {
</span></span></span><span class="line"><span class="cl"><span class="s">            url {
</span></span></span><span class="line"><span class="cl"><span class="s">              path /404
</span></span></span><span class="line"><span class="cl"><span class="s">              status_code 404
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">            connect_port    8080
</span></span></span><span class="line"><span class="cl"><span class="s">            connect_timeout 2
</span></span></span><span class="line"><span class="cl"><span class="s">            retry 2
</span></span></span><span class="line"><span class="cl"><span class="s">            delay_before_retry 2
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    real_server  192.168.2.222 8080 {
</span></span></span><span class="line"><span class="cl"><span class="s">        weight 1
</span></span></span><span class="line"><span class="cl"><span class="s">        HTTP_GET  {
</span></span></span><span class="line"><span class="cl"><span class="s">            url {
</span></span></span><span class="line"><span class="cl"><span class="s">              path /404
</span></span></span><span class="line"><span class="cl"><span class="s">              status_code 404
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">            connect_port    8080
</span></span></span><span class="line"><span class="cl"><span class="s">            connect_timeout 2
</span></span></span><span class="line"><span class="cl"><span class="s">            retry 2
</span></span></span><span class="line"><span class="cl"><span class="s">            delay_before_retry 2
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>测试下</p>
<pre tabindex="0"><code># 先清理掉之前手动添加的
ipvsadm --clear

systemctl daemon-reload
systemctl restart keepalived

$ curl 169.254.11.2/www/test
192.168.2.222
$ curl 169.254.11.2/www/test
192.168.2.111
$ curl 169.254.11.2/www/test
192.168.2.222
$ curl 169.254.11.2/www/test
192.168.2.111
$ ip a s SVC
4: SVC: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether e6:a3:29:07:fa:57 brd ff:ff:ff:ff:ff:ff
    inet 169.254.11.2/32 scope global SVC
       valid_lft forever preferred_lft forever
</code></pre><p>停掉一个 web 后在我们配置的健康检查几秒也剔除了 rs：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>7<span class="o">)</span> Failed connect to 169.254.11.2:80<span class="p">;</span> Connection refused
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span><span class="line"><span class="cl">$ curl 169.254.11.2/www/test
</span></span><span class="line"><span class="cl">192.168.2.111
</span></span></code></pre></div><h4 id="系统的相关配置">系统的相关配置</h4>
<p>后面重启后发现不通，发现内核模块没加载，使用 <code>systemd-modules-load</code> 去开机加载：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat  &gt; /etc/modules-load.d/ipvs.conf <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs_rr
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs_wrr
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs_sh
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat &gt; /etc/sysctl.d/90.ipvs.conf <span class="s">&lt;&lt; EOF 
</span></span></span><span class="line"><span class="cl"><span class="s"># https://github.com/moby/moby/issues/31208 
</span></span></span><span class="line"><span class="cl"><span class="s"># ipvsadm -l --timout
</span></span></span><span class="line"><span class="cl"><span class="s"># 修复ipvs模式下长连接timeout问题 小于900即可
</span></span></span><span class="line"><span class="cl"><span class="s">net.ipv4.tcp_keepalive_time=600
</span></span></span><span class="line"><span class="cl"><span class="s">net.ipv4.tcp_keepalive_intvl=30
</span></span></span><span class="line"><span class="cl"><span class="s">net.ipv4.vs.conntrack=1
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><h3 id="docker-运行的方案">docker 运行的方案</h3>
<p><code>docker-compose</code> 文件如下，自己把脚本挂载进去即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.5&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">keepalived</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;registry.aliyuncs.com/zhangguanzhang/keepalived:v2.2.0&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;keepalived-ipvs&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">unless-stopped</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;keepalived-ipvs&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">app=keepalived</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l">host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cap_drop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">NET_BIND_SERVICE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/lib/modules:/lib/modules</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/run/xtables.lock:/run/xtables.lock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./conf.d/:/etc/keepalived/conf.d/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./keepalived.conf:/etc/keepalived/keepalived.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./always-initsh.d:/always-initsh.d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- --<span class="l">dont-fork</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- --<span class="l">log-console</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- --<span class="l">log-detail</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- --<span class="l">use-file=/etc/keepalived/keepalived.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">json-file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">options</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-file</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-size</span><span class="p">:</span><span class="w"> </span><span class="l">20m</span><span class="w">
</span></span></span></code></pre></div><h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.filter_rules.html" target="_blank" rel="noopener">Interaction between LVS and netfilter</a></li>
<li><a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.LVS-NAT.html#lvs_nat_intro" target="_blank" rel="noopener">lvs nat</a></li>
<li><a href="https://github.com/liexusong/linux-source-code-analyze/blob/master/lvs-principle-and-source-analysis-part2.md" target="_blank" rel="noopener">lvs-principle-and-source-analysis</a></li>
<li><a href="https://www.zsythink.net/archives/1199" target="_blank" rel="noopener">朱双印大佬的 iptables 技术系列</a></li>
</ul>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/ipvs/">IPVS</a>
  
  <a class="badge badge-light" href="/tag/lvs/">lvs</a>
  
  <a class="badge badge-light" href="/tag/kubernetes/">kubernetes</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E5%BC%A0%E6%B5%A9/"><img class="avatar mr-3 avatar-circle" src="/author/%E5%BC%A0%E6%B5%A9/avatar_hud68548513b001ec088db8eb8343de5a4_23649_270x270_fill_q75_lanczos_center.jpg" alt="张浩"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E5%BC%A0%E6%B5%A9/">张浩</a></p>
      
      <p class="card-text">金山办公软件运维开发工程师，containers/podman 的 Collaborator。目前主要从事运维和 K8S 相关的工作。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/edge-sig-learn-20/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>边缘计算专家长成计划入门 20 篇</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/service-mesh-unnecessary-complexity/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>远离复杂性——服务网格需要更加务实</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/create-a-ipvs-svc-without-container/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/battle-of-the-pods-kubernetes-autoscaling-showdown-keda-vs-vanilla-kubernetes/">KEDA vs. 原生 Kubernetes：谁是云原生应用的自动伸缩王者？</a></li>
      
      <li><a href="/blog/what-is-a-kubernetes-cluster-mesh-and-what-are-the-benefits/">如何使用 Calico 构建和管理 Kubernetes Cluster Mesh</a></li>
      
      <li><a href="/blog/does-kubernetes-really-perform-better-on-bare-metal-vs-vms/">Kubernetes 在裸机上比虚拟机表现更好吗：Kubernetes 性能对比实验</a></li>
      
      <li><a href="/blog/ordering-containers-within-pod/">解密 Kubernetes Pod 中容器的有序部署：Kubexit 工具的妙用</a></li>
      
      <li><a href="/blog/why-we-decided-to-start-fresh-with-our-nginx-gateway-fabric/">为什么我们决定从新开始我们的 NGINX Gateway Fabric</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2024 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.b4708d4364577c16ab7001b265a063a4.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.27bfa4a749fe1d78b45ea21d607b67f4.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
