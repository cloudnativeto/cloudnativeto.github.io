<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>一文带你彻底厘清 Istio 中的证书工作机制 | 云原生社区</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Istio 为微服务提供了无侵入，可插拔的安全框架。应用不需要修改代码，就可以利用 Istio 提供的双向 TLS 认证实现服务身份认证，并基于服务身份信息提供细粒度的访问控制。本文将为你揭秘 Istio 双向 TLS 认证的实现机制。">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="Istio 为微服务提供了无侵入，可插拔的安全框架。应用不需要修改代码，就可以利用 Istio 提供的双向 TLS 认证实现服务身份认证，并基于服务身份信息提供细粒度的访问控制。本文将为你揭秘 Istio 双向 TLS 认证的实现机制。" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/istio-certificate/" />
  <meta property="og:title" content="一文带你彻底厘清 Istio 中的证书工作机制" />
  <meta property="og:description" content="Istio 为微服务提供了无侵入，可插拔的安全框架。应用不需要修改代码，就可以利用 Istio 提供的双向 TLS 认证实现服务身份认证，并基于服务身份信息提供细粒度的访问控制。本文将为你揭秘 Istio 双向 TLS 认证的实现机制。" />
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png" />
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                兴趣小组
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="https://i.cloudnative.to/kubernetes/">Kubernetes SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/istio/">Istio SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/envoy/">Envoy SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/dapr/">Dapr SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/oam/">OAM SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/stability/">稳定性 SIG</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/observability/">可观察性 SIG</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                博客
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/categories/kubernetes">Kubernetes</a>
                
                <a class="dropdown-item" href="/categories/service-mesh">Service Mesh</a>
                
                <a class="dropdown-item" href="/categories/envoy">Envoy</a>
                
                <a class="dropdown-item" href="/categories/oam">OAM</a>
                
                <a class="dropdown-item" href="/categories/%E5%BC%80%E6%BA%90%E7%A4%BE%E5%8C%BA">开源社区</a>
                
                <a class="dropdown-item" href="/blog">所有</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/academy">云原生学院分享归档</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                关于
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/about">介绍</a>
                
                <a class="dropdown-item" href="/contact">联系</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">一文带你彻底厘清 Istio 中的证书工作机制</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">Istio 为微服务提供了无侵入，可插拔的安全框架。应用不需要修改代码，就可以利用 Istio 提供的双向 TLS 认证实现服务身份认证，并基于服务身份信息提供细粒度的访问控制。本文将为你揭秘 Istio 双向 TLS 认证的实现机制。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/blog-3.jpg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">Istio</div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://zhaohuabing.com">赵化冰</a></strong>
          
            发表于 <strong class="text-dark">2020年5月25日</strong></div>
        <hr>
        <div class="content">
          <p>在上一篇文章<a href="/blog/k8s-certificate/">一文带你彻底厘清 Kubernetes 中的证书工作机制</a>中，我们介绍了 Kubernetes 中证书的工作机制。在这篇文章中，我们继续探讨 Istio 是如何使用证书来实现网格中服务的身份认证和安全通信的。</p>
<p>本文是对 Istio 认证工作机制的深度分析，假设读者已经了解 Service Mesh 以及 Istio 的相关基础概念，因此在本文对此类基础概念不再解释。对于 Istio 不熟悉的读者，建议先阅读 Istio 官方网站上的的这篇基础介绍 <a href="https://istio.io/docs/concepts/what-is-istio/">What is Istio?</a>。</p>
<h2 id="istio-安全架构">Istio 安全架构</h2>
<p>Istio 为微服务提供了无侵入，可插拔的安全框架。应用不需要修改代码，就可以利用 Istio 提供的双向 TLS 认证实现服务身份认证，并基于服务身份信息提供细粒度的访问控制。Istio 安全的高层架构如下图所示：</p>
<p><img src="arch-sec.svg" alt="">
图1. Istio Security Architecture，图片来源<a href="https://istio.io/docs/concepts/security/#high-level-architecture">istio.io</a></p>
<p>图中展示了 Istio 中的服务认证和授权两部分内容。让我们暂时忽略掉授权部分，先关注认证部分。服务认证是通过控制面和数据面一起实现的：</p>
<ul>
<li>控制面：Istiod 中实现了一个 CA （Certificate Authority，证书机构） 服务器。该 CA 服务器负责为网格中的各个服务签发证书，并将证书分发给数据面的各个服务的sidecar代理。</li>
<li>数据面：在网格中的服务相互之间发起 plain HTTP/TCP 通信时，和服务同一个 pod 中的sidecar代理会拦截服务请求，采用证书和对端服务的sidecar代理进行双向 TLS 认证并建立一个 TLS 连接，使用该 TLS 连接来在网络中传输数据。</li>
</ul>
<h2 id="控制面证书签发流程">控制面证书签发流程</h2>
<p>图1是对 Istio 安全架构的一个高度概括的描述，让我们把图1中控制面的交互展开，看一下其中的细节。</p>
<p><img src="istio-ca.svg" alt="">
图2. Istio 证书分发流程</p>
<p>我们先暂时忽略图中右边蓝色虚线的部分（稍后会在 <a href="#heading1">控制面身份认证</a> 部分讲到），图中左半部分描述了 Istio 控制面向 Envoy 签发证书的流程：</p>
<ol>
<li>Envoy 向 pilot-agent 发起一个 SDS (Secret Discovery Service) 请求，要求获取自己的证书和私钥。</li>
<li>Pilot-agent 生成私钥和 CSR （Certificates Signing Request，证书签名请求），向 Istiod 发送证书签发请求，请求中包含 CSR 和该 pod 中服务的身份信息。</li>
<li>Istiod 根据请求中服务的身份信息（Service Account）为其签发证书，将证书返回给 Pilot-agent。</li>
<li>Pilot-agent 将证书和私钥通过 SDS 接口返回给 Envoy。</li>
</ol>
<h3 id="为什么要通过-pilot-agent-中转">为什么要通过 Pilot-agent 中转？</h3>
<p>从图2可以看到，Istio 证书签发的过程中涉及到了三个组件： Istiod (Istio CA) &mdash;&gt; Pilot-agent &mdash;&gt; Enovy。为什么其他 xDS 接口都是由 Istiod 直接向 Envoy 提供，但 SDS 却要通过 Pilot-agent 进行一次中转，而不是直接由 Envoy 通过 SDS 接口从 Istiod 获取证书呢？这样做主要有两个原因。</p>
<p>首先，在 Istio 的证书签发流程中，由 Pilot-agent 生成私钥和 CSR，再通过 CSR 向 Istiod 中的 CA 申请证书。在整个过程中，私钥只存在于本地的 Istio-proxy 容器中。如果去掉中间 Pilot-agent 这一步，直接由 Envoy 向 Istiod 申请证书，则需要由 Istiod 生成私钥，并将私钥和证书一起通过网络返回给 Envoy，这将大大增加私钥泄露的风险。</p>
<p>另一方面，通过 Pilot-agent 来提供 SDS 服务，由 Pilot-agent 生成标准的 CSR 证书签名请求，可以很容易地对接不同的 CA 服务器，方便 Istio 和其他证书机构进行集成。</p>
<h3 id="控制面身份认证">控制面身份认证</h3>
<p>要通过服务证书来实现网格中服务的身份认证，必须首先确保服务从控制面获取自身证书的流程是安全的。Istio 通过 Istiod 和 Pilog-agent 之间的 gRPC 通道传递 CSR 和证书，因此在这两个组件进行通信时，双方需要先验证对方的身份，以避免恶意第三方伪造 CSR 请求或者假冒 Istiod CA 服务器。在目前的版本中(Istio1.6)，Pilot-agent 和 Istiod 分布采用了不同的认证方式。</p>
<ul>
<li>Istiod 身份认证
<ul>
<li>Istiod 采用其内置的 CA 服务器为自身签发一个服务器证书（图2中的 Istiod certificate），并采用该服务器证书对外提供基于 TLS 的 gPRC 服务。</li>
<li>Istiod 调用 Kube-apiserver 生成一个 ConfigMap， 在该 ConfigMap 中放入了 Istiod 的 CA 根证书(图2中的 istio-ca-root-cert)。</li>
<li>该 ConfigMap 被 Mount 到 Istio-proxy 容器中，被 Pilot-agent 用于验证 Istiod 的服务器证书。</li>
<li>在 Pilot-agent 和 Istiod 建立 gRPC 连接时，Pilot-agent 采用标准的 TLS 服务器认证流程对 Istiod 的服务器证书进行认证。</li>
</ul>
</li>
<li>Pilot-agent 身份认证
<ul>
<li>在 Kubernetes 中可以为每一个 pod 关联一个 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Service Account</a>，以表明该 pod 中运行的服务的身份信息。例如 bookinfo 中 reviews 服务的 service accout 是 “bookinfo-reviews” 。</li>
<li>Kubernetes 会为该 service account 生成一个 jwt token，并将该 token 通过 secret 加载到 pod 中的一个文件。</li>
<li>Pilot-agent 在向 Istiod 发送 CSR 时，将其所在 pod 的 service account token 也随请求发送给 Istiod。</li>
<li>Istiod 调用 Kube-apiserver 接口验证请求中附带的 service account token，以确认请求证书的服务身份是否合法。</li>
</ul>
</li>
</ul>
<p>备注：除了 Kubernetes 之外， Istio 也支持虚机部署，在虚机部署的场景下，由于没有 service account，Pilot-agent 和 Pilotd 之间的身份认证方式有所不同。由于 Istio 的主要使用场景还是 Kubernetes，本文只分析 Kubernetes 部署场景。</p>
<h2 id="sds-工作原理">SDS 工作原理</h2>
<p>和其他 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-docs/xds_protocol">xDS</a> 接口一样，SDS 也是 Envoy 支持的一种动态配置服务接口。Envoy 可以通过 <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/security/secret">SDS（secret discovery service）</a> 接口从 SDS 服务器自动获取证书。和之前的方式相比，SDS 最大的好处就是简化了证书管理。在没有使用 SDS 前，Istio 中的服务证书被创建为 Kubernetes secret，并挂载到代理容器中。如果证书过期了，则需要更新 secret 并重启 Envoy 容器，以启用新的证书。使用SDS后，SDS 服务器（Pilot-agent充当了 SDS 服务器的角色）将向 Envoy 实例主动推送证书。如果证书过期，SDS 服务器只需将新的证书推送到 Envoy 例中，Envoy 会使用新的证书来创建链接，无需重新启动。</p>
<p><img src="envoy-sds.svg" alt="">
图3. Envoy SDS 服务</p>
<p>可以看到，Istio 采用 SDS 后，避免了在证书更新后重启 Envoy，大大减少了证书更新对业务的影响。同时，由于 Pilot-agent 和 Envoy 处于同一容器中，私钥只存在于本地容器，避免了在网络中传递私钥，也降低了私钥泄露的安全风险。</p>
<p>SDS 服务向 Envoy 下发的数据结构为<code>extensions.transport_sockets.tls.v3.Secret</code>,其结构如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>,                            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">Secret</span> <span style="color:#960050;background-color:#1e0010">名称</span>
  <span style="color:#f92672">&#34;tls_certificate&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,               <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">数字证书</span>
  <span style="color:#f92672">&#34;session_ticket_keys&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,
  <span style="color:#f92672">&#34;validation_context&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">证书验证信息</span>
  <span style="color:#f92672">&#34;generic_secret&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>
}
</code></pre></div><p>其中在 Istio 中用到的主要是 <code>tls_certificate</code> 和 <code>validation_context</code>。 分别用于传递数字证书和验证对方证书使用到的根证书。下面是这两个字段的结构，结构中标注了我们主要需要关注的内容。</p>
<p><code>tls_certificate</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;certificate_chain&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,           <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">证书内容</span>
  <span style="color:#f92672">&#34;private_key&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,                 <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">证书的私钥</span>
  <span style="color:#f92672">&#34;private_key_provider&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,
  <span style="color:#f92672">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>
}
</code></pre></div><p><code>validation_context</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;trusted_ca&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,                 <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">CA</span> <span style="color:#960050;background-color:#1e0010">根证书</span>
  <span style="color:#f92672">&#34;verify_certificate_spki&#34;</span>: [],
  <span style="color:#f92672">&#34;verify_certificate_hash&#34;</span>: [],
  <span style="color:#f92672">&#34;match_subject_alt_names&#34;</span>: [],         <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">需要验证的</span> <span style="color:#960050;background-color:#1e0010">subject</span> <span style="color:#960050;background-color:#1e0010">alt</span> <span style="color:#960050;background-color:#1e0010">name</span>
  <span style="color:#f92672">&#34;crl&#34;</span>: <span style="color:#e6db74">&#34;{...}&#34;</span>,
  <span style="color:#f92672">&#34;allow_expired_certificate&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>,
  <span style="color:#f92672">&#34;trust_chain_verification&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>
}
</code></pre></div><h2 id="网格-sidecar-证书配置">网格 Sidecar 证书配置</h2>
<p>在 Istio 的 Enovy sidecar 配置中，有两处需要通过 SDS 来配置证书：</p>
<ul>
<li>Inbound Listener：由于Enovy 通过 Listener 对外提供服务，需要通过 SDS 配置服务器证书，服务器证书私钥，以及验证下游客户端证书的 CA 根证书。</li>
<li>Outbound Cluster：对于上游的 Cluster 而言，Envoy 是客户端的角色，因此需要在 Cluster 中通过 SDS 配置客户端证书，客户端证书私钥，以及验证上游服务器的 CA 根证书。</li>
</ul>
<p>下面我们来看一下 bookinfo 示例中 Envoy sidecar代理上 reviews 微服务相关的证书配置，以对 Istio 中 SDS 的运作机制有一个更清晰的认识。为了简略起见，本文只显示了部分关键的配置。你也可以查看 Github 上的<a href="https://github.com/zhaohuabing/bookinfo-bookinfo-config-dump/blob/istio1.5.4/reviews-config-dump">完整配置</a>。</p>
<p>通过 Envoy 的管理端口，可以导出 Envoy 中的当前配置，导出命令如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl exec reviews-v1-6d8bc58dd7-ts8kw -c istio-proxy curl http://127.0.0.1:15000/config_dump &gt; config_dump
</code></pre></div><p>配置文件中 SDS 服务器的定义如下，Pilot-agent 在 <code>/etc/istio/proxy/SDS</code> 这路径上通过 unix domain socket 提供了一个 SDS 服务器。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;sds-grpc&#34;</span>,
  <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;STATIC&#34;</span>,
  <span style="color:#f92672">&#34;connect_timeout&#34;</span>: <span style="color:#e6db74">&#34;10s&#34;</span>,
  <span style="color:#f92672">&#34;hidden_envoy_deprecated_hosts&#34;</span>: [
   {
    <span style="color:#f92672">&#34;pipe&#34;</span>: {
     <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/etc/istio/proxy/SDS&#34;</span>
    }
   }
  ],
  <span style="color:#f92672">&#34;http2_protocol_options&#34;</span>: {}
}
</code></pre></div><p>Details Pod 在 9080 端口对外提供服务，因此需要通过 SDS 配置 9080 端口上的服务端证书和验证客户端证书的 CA 根证书。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;virtualInbound&#34;</span>,                                <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">15006端口上的虚拟入向监听器</span>
  <span style="color:#f92672">&#34;active_state&#34;</span>: {
  <span style="color:#f92672">&#34;version_info&#34;</span>: <span style="color:#e6db74">&#34;2020-05-14T03:59:54Z/25&#34;</span>,
  <span style="color:#f92672">&#34;listener&#34;</span>: {
   <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.api.v2.Listener&#34;</span>,
   <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;virtualInbound&#34;</span>,
   <span style="color:#f92672">&#34;address&#34;</span>: {
    <span style="color:#f92672">&#34;socket_address&#34;</span>: {
     <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
     <span style="color:#f92672">&#34;port_value&#34;</span>: <span style="color:#ae81ff">15006</span>
    }
   },
   <span style="color:#f92672">&#34;filter_chains&#34;</span>: [
   {
     <span style="color:#f92672">&#34;filter_chain_match&#34;</span>: {
      <span style="color:#f92672">&#34;prefix_ranges&#34;</span>: [
       {
        <span style="color:#f92672">&#34;address_prefix&#34;</span>: <span style="color:#e6db74">&#34;10.44.0.8&#34;</span>,
        <span style="color:#f92672">&#34;prefix_len&#34;</span>: <span style="color:#ae81ff">32</span>
       }
      ],
      <span style="color:#f92672">&#34;destination_port&#34;</span>: <span style="color:#ae81ff">9080</span>                            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">用于处理发向reviews服务</span><span style="color:#ae81ff">9080</span><span style="color:#960050;background-color:#1e0010">端口的业务请求的filter</span> <span style="color:#960050;background-color:#1e0010">chain</span>
     },
     <span style="color:#f92672">&#34;filters&#34;</span>: [<span style="color:#960050;background-color:#1e0010">...</span>],
     <span style="color:#f92672">&#34;transport_socket&#34;</span>: {
      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.transport_sockets.tls&#34;</span>,
      <span style="color:#f92672">&#34;typed_config&#34;</span>: {
       <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&#34;</span>,
       <span style="color:#f92672">&#34;common_tls_context&#34;</span>: {
        <span style="color:#f92672">&#34;alpn_protocols&#34;</span>: [
         <span style="color:#e6db74">&#34;h2&#34;</span>,
         <span style="color:#e6db74">&#34;http/1.1&#34;</span>
        ],
        <span style="color:#f92672">&#34;tls_certificate_sds_secret_configs&#34;</span>: [          <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置服务器端证书</span>
         {
          <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,                             <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">服务器证书</span> <span style="color:#960050;background-color:#1e0010">Secret</span> <span style="color:#960050;background-color:#1e0010">名称</span>
          <span style="color:#f92672">&#34;sds_config&#34;</span>: {
           <span style="color:#f92672">&#34;api_config_source&#34;</span>: {
            <span style="color:#f92672">&#34;api_type&#34;</span>: <span style="color:#e6db74">&#34;GRPC&#34;</span>,
            <span style="color:#f92672">&#34;grpc_services&#34;</span>: [
             {
              <span style="color:#f92672">&#34;envoy_grpc&#34;</span>: {
               <span style="color:#f92672">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;sds-grpc&#34;</span>               <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置用于获取服务器端证书的</span> <span style="color:#960050;background-color:#1e0010">SDS</span> <span style="color:#960050;background-color:#1e0010">服务器</span>
              }
             }
            ]
           }
          }
         }
        ],
        <span style="color:#f92672">&#34;combined_validation_context&#34;</span>: {
         <span style="color:#f92672">&#34;default_validation_context&#34;</span>: {},
         <span style="color:#f92672">&#34;validation_context_sds_secret_config&#34;</span>: {     <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置验证客户端证书的</span> <span style="color:#960050;background-color:#1e0010">CA</span> <span style="color:#960050;background-color:#1e0010">根证书</span>
          <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;ROOTCA&#34;</span>,                            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">CA</span> <span style="color:#960050;background-color:#1e0010">根证书</span> <span style="color:#960050;background-color:#1e0010">Secret</span> <span style="color:#960050;background-color:#1e0010">名称</span>
          <span style="color:#f92672">&#34;sds_config&#34;</span>: {
           <span style="color:#f92672">&#34;api_config_source&#34;</span>: {
            <span style="color:#f92672">&#34;api_type&#34;</span>: <span style="color:#e6db74">&#34;GRPC&#34;</span>,
            <span style="color:#f92672">&#34;grpc_services&#34;</span>: [
             {
              <span style="color:#f92672">&#34;envoy_grpc&#34;</span>: {
               <span style="color:#f92672">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;sds-grpc&#34;</span>             <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置用于获取</span> <span style="color:#960050;background-color:#1e0010">CA</span> <span style="color:#960050;background-color:#1e0010">根证书的</span> <span style="color:#960050;background-color:#1e0010">SDS</span> <span style="color:#960050;background-color:#1e0010">服务器</span>
              }
             }
            ]
           }
          }
         }
        }
       },
       <span style="color:#f92672">&#34;require_client_certificate&#34;</span>: <span style="color:#66d9ef">true</span>
      }
     }
    }
   ],
 }
}
</code></pre></div><p>客户端 Pod 上的 Enovy 通过 reviews outbound cluster 访问上游 reviews 服务，因此需要在该 cluster 上配置客户端证书以及验证服务器端证书的 CA 根证书。在这里我们需要注意的是，Envoy 在验证服务器端证书时会同时验证证书中的 subject alternative name 字段。该字段中设置的是 reviews 服务 Pod 关联的 Service Account 名称。 由于 Service Account 是 Istio 中认可的一种用户账户，因此通过为 Service Account 设置不同的资源访问权限，可以进一步实现细粒度的权限控制，例如按照 URL 进行授权。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"> {
  <span style="color:#f92672">&#34;version_info&#34;</span>: <span style="color:#e6db74">&#34;2020-05-14T03:15:47Z/18&#34;</span>,
  <span style="color:#f92672">&#34;cluster&#34;</span>: {
   <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.api.v2.Cluster&#34;</span>,
   <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;outbound|9080||reviews.default.svc.cluster.local&#34;</span>,
   <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;EDS&#34;</span>,
   <span style="color:#f92672">&#34;eds_cluster_config&#34;</span>: {
    <span style="color:#f92672">&#34;eds_config&#34;</span>: {
     <span style="color:#f92672">&#34;ads&#34;</span>: {}
    },
    <span style="color:#f92672">&#34;service_name&#34;</span>: <span style="color:#e6db74">&#34;outbound|9080||reviews.default.svc.cluster.local&#34;</span>
   },
   <span style="color:#f92672">&#34;service_name&#34;</span>: <span style="color:#e6db74">&#34;outbound|9080||reviews.default.svc.cluster.local&#34;</span>
  },
  <span style="color:#f92672">&#34;circuit_breakers&#34;</span>: {<span style="color:#960050;background-color:#1e0010">...</span>},
  <span style="color:#f92672">&#34;filters&#34;</span>: [<span style="color:#960050;background-color:#1e0010">...</span>],
  <span style="color:#f92672">&#34;transport_socket_matches&#34;</span>: [
   {
    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;tlsMode-istio&#34;</span>,
    <span style="color:#f92672">&#34;match&#34;</span>: {
     <span style="color:#f92672">&#34;tlsMode&#34;</span>: <span style="color:#e6db74">&#34;istio&#34;</span>
    },
    <span style="color:#f92672">&#34;transport_socket&#34;</span>: {
     <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.transport_sockets.tls&#34;</span>,
     <span style="color:#f92672">&#34;typed_config&#34;</span>: {
      <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.api.v2.auth.UpstreamTlsContext&#34;</span>,
      <span style="color:#f92672">&#34;common_tls_context&#34;</span>: {
       <span style="color:#f92672">&#34;alpn_protocols&#34;</span>: [
        <span style="color:#e6db74">&#34;istio-peer-exchange&#34;</span>,
        <span style="color:#e6db74">&#34;istio&#34;</span>
       ],
       <span style="color:#f92672">&#34;tls_certificate_sds_secret_configs&#34;</span>: [
        {
         <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,                                     <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置用于访问</span> <span style="color:#960050;background-color:#1e0010">reviews</span> <span style="color:#960050;background-color:#1e0010">服务的客户端证书</span>
         <span style="color:#f92672">&#34;sds_config&#34;</span>: {
          <span style="color:#f92672">&#34;api_config_source&#34;</span>: {
           <span style="color:#f92672">&#34;api_type&#34;</span>: <span style="color:#e6db74">&#34;GRPC&#34;</span>,
           <span style="color:#f92672">&#34;grpc_services&#34;</span>: [
            {
             <span style="color:#f92672">&#34;envoy_grpc&#34;</span>: {
              <span style="color:#f92672">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;sds-grpc&#34;</span>                        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置用于获取客户端证书的</span> <span style="color:#960050;background-color:#1e0010">SDS</span> <span style="color:#960050;background-color:#1e0010">服务器</span>
             }
            }
           ]
          }
         }
        }
       ],
       <span style="color:#f92672">&#34;combined_validation_context&#34;</span>: {
        <span style="color:#f92672">&#34;default_validation_context&#34;</span>: {
         <span style="color:#f92672">&#34;verify_subject_alt_name&#34;</span>: [
          <span style="color:#e6db74">&#34;spiffe://cluster.local/ns/default/sa/bookinfo-reviews&#34;</span>  <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">验证服务器证书时需要验证</span> <span style="color:#960050;background-color:#1e0010">SAN</span> <span style="color:#960050;background-color:#1e0010">中的</span> <span style="color:#960050;background-color:#1e0010">service</span> <span style="color:#960050;background-color:#1e0010">account</span> <span style="color:#960050;background-color:#1e0010">名称</span>
         ]
        },
        <span style="color:#f92672">&#34;validation_context_sds_secret_config&#34;</span>: {
         <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;ROOTCA&#34;</span>,                                     <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置验证</span> <span style="color:#960050;background-color:#1e0010">reviews</span> <span style="color:#960050;background-color:#1e0010">服务器证书的</span> <span style="color:#960050;background-color:#1e0010">CA</span> <span style="color:#960050;background-color:#1e0010">根证书</span>
         <span style="color:#f92672">&#34;sds_config&#34;</span>: {
          <span style="color:#f92672">&#34;api_config_source&#34;</span>: {
           <span style="color:#f92672">&#34;api_type&#34;</span>: <span style="color:#e6db74">&#34;GRPC&#34;</span>,
           <span style="color:#f92672">&#34;grpc_services&#34;</span>: [
            {
             <span style="color:#f92672">&#34;envoy_grpc&#34;</span>: {
              <span style="color:#f92672">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;sds-grpc&#34;</span>                       <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">配置用于获取</span> <span style="color:#960050;background-color:#1e0010">CA</span> <span style="color:#960050;background-color:#1e0010">根证书的</span> <span style="color:#960050;background-color:#1e0010">SDS</span> <span style="color:#960050;background-color:#1e0010">服务器</span>
             }
            }
           ]
          }
         }
        }
       }
      },
      <span style="color:#f92672">&#34;sni&#34;</span>: <span style="color:#e6db74">&#34;outbound_.9080_._.reviews.default.svc.cluster.local&#34;</span>
     }
    }
   },
  ]
 }<span style="color:#960050;background-color:#1e0010">,</span>
 <span style="color:#e6db74">&#34;last_updated&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;2020-05-14T03:16:33.061Z&#34;</span>
<span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><p>上面配置中 SAN 中的 service account 名称来自于 reviews pod 中的 service account 配置。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: reviews-v1
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: reviews
    <span style="color:#66d9ef">version</span>: v1
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app</span>: reviews
      <span style="color:#66d9ef">version</span>: v1
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app</span>: reviews
        <span style="color:#66d9ef">version</span>: v1
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">serviceAccountName</span>: bookinfo-reviews                             // 设置 reviews pod 的 service account
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">name</span>: reviews
        <span style="color:#66d9ef">image</span>: docker.io/istio/examples-bookinfo-reviews-v1:<span style="color:#ae81ff">1.15.0</span>
        <span style="color:#66d9ef">imagePullPolicy</span>: IfNotPresent
        <span style="color:#66d9ef">env</span>:
        - <span style="color:#66d9ef">name</span>: LOG_DIR
          <span style="color:#66d9ef">value</span>: <span style="color:#e6db74">&#34;/tmp/logs&#34;</span>
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">9080</span>
...

</code></pre></div><p>在导出的配置中可以看到 Envoy 通过 SDS 服务器获取到的证书（为了简略起见，省略了证书中间的部分内容）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"> {
   <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.admin.v3.SecretsConfigDump&#34;</span>,
   <span style="color:#f92672">&#34;dynamic_active_secrets&#34;</span>: [
    {
     <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
     <span style="color:#f92672">&#34;version_info&#34;</span>: <span style="color:#e6db74">&#34;05-14 03:16:30.900&#34;</span>,
     <span style="color:#f92672">&#34;last_updated&#34;</span>: <span style="color:#e6db74">&#34;2020-05-14T03:16:31.125Z&#34;</span>,
     <span style="color:#f92672">&#34;secret&#34;</span>: {
      <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span>,
      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
      <span style="color:#f92672">&#34;tls_certificate&#34;</span>: {
       <span style="color:#f92672">&#34;certificate_chain&#34;</span>: {
        <span style="color:#f92672">&#34;inline_bytes&#34;</span>: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FUXXXXXXXXXXXXXXUZJQ0FURS0tLS0tCg==&#34;</span>           <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">details</span> <span style="color:#960050;background-color:#1e0010">服务的证书，该证书被同时用作了服务器证书和客户端证书</span>
       },
       <span style="color:#f92672">&#34;private_key&#34;</span>: {
        <span style="color:#f92672">&#34;inline_bytes&#34;</span>: <span style="color:#e6db74">&#34;W3JlZGFjdGVkXQ==&#34;</span>                                                        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">detatils</span> <span style="color:#960050;background-color:#1e0010">服务证书对应的私钥</span>
       }
      }
     }
    },
    {
     <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;ROOTCA&#34;</span>,
     <span style="color:#f92672">&#34;version_info&#34;</span>: <span style="color:#e6db74">&#34;2020-05-14 03:16:31.300416193 +0000 UTC m=+1.537483882&#34;</span>,
     <span style="color:#f92672">&#34;last_updated&#34;</span>: <span style="color:#e6db74">&#34;2020-05-14T03:16:31.343Z&#34;</span>,
     <span style="color:#f92672">&#34;secret&#34;</span>: {
      <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span>,
      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;ROOTCA&#34;</span>,
      <span style="color:#f92672">&#34;validation_context&#34;</span>: {
       <span style="color:#f92672">&#34;trusted_ca&#34;</span>: {
        <span style="color:#f92672">&#34;inline_bytes&#34;</span>: <span style="color:#e6db74">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0XXXXXXXXXXXXXXXXXXXXJQ0FURS0tLS0tCg==&#34;</span>       <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">用于验证通信对方证书的</span> <span style="color:#960050;background-color:#1e0010">CA</span> <span style="color:#960050;background-color:#1e0010">根证书</span>
       }
      }
     }
    }
   ]
  }
</code></pre></div><p>通过上面的配置，我们可以看到，虽然需要在 Enovy sidecar配置文件中不同的位置为 Envoy 配置服务器、客户端证书以及验证对方的 CA 根证书，但 Istio 中实际上只采用了一个服务证书和 CA 根证书。Istio 将名称为 default 的证书被同时用于 Inbound Listener 的服务器证书和 Outbound Cluster 的客户端证书，并将名称为 ROOTCA 的证书被用于验证下游客户端证书和上游服务器证书的根证书。</p>
<h2 id="gateway-证书配置">Gateway 证书配置</h2>
<p>除了需要和网格内部的服务进行通信之外，Ingress Gateway 和 Egress Gateway 还需要连接到网格外部的系统。如果这些外部连接也需要采用 TLS，则 Gateway 中也要配置这些外部系统的相关证书。</p>
<p>Ingress Gateway 中需要如下证书相关的配置：</p>
<ul>
<li>作为客户端和网格内部其他服务进行通信的客户端证书和私钥，和其他服务使用的证书类似，该证书也是由 Istio CA 颁发的。</li>
<li>验证网格内其他服务证书的 CA 根证书，该根证书是 Istio CA 的根证书。</li>
<li>作为网关向网格外部提供服务使用的服务器端证书和私钥，该证书一般是由一个权威 CA 或者第三方 CA 签发的。如果有多个 host，需要为每一个 host 分别配置配置不同的证书。</li>
<li>如果对外提供的服务需要双向 TLS 认证，还需要配置用于验证客户端证书的 CA 根证书。</li>
</ul>
<p>Egress Gateway 中需要如下证书相关的配置：</p>
<ul>
<li>作为服务器接受网格内部其他服务访问的服务器证书和私钥，和其他服务使用的证书类似，该证书也是由 Istio CA 颁发的。</li>
<li>验证网格内其他服务证书的 CA 根证书，该根证书是 Istio CA 的根证书。</li>
<li>作为出口网关访问外部服务时，如果该外部服务采用了 TLS，则需要配置一个验证该服务器证书的 CA 根证书来验证该服务器。该根证书一般是一个权威 CA 或者第三方 CA。</li>
<li>如果访问的外部服务要求双向 TLS 认证，则还需要网关配置一个该外部服务认可的客户端证书。该证书一般是由一个权威 CA 或者第三方 CA 签发的。</li>
</ul>
<p>由于 Gateway 中配置的和外部系统相关的证书不是通过 SDS 从 Istio CA 获取的，而是采用第三方 CA 颁发的，因此到期后并不能自动更新，而需要手动进行更新。因此需要注意这些证书的有效期，在证书过期前及时重新申请证书并更新到 Gateway 配置中，以避免影响业务。</p>
<p>在 Gateway 上配置第三方证书的方法是采用 Kubernetes Secret 和 Istio Gateway CRD。例如我们可以采用下面的步骤在 Ingress Gateway 上配置对外提供服务使用的服务器证书。</p>
<p>首先创建一个 secret，该 secret 中包含了服务器证书和私钥：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -n istio-system secret tls bookinfo-credential --key<span style="color:#f92672">=</span>bookinfo.example.com.key --cert<span style="color:#f92672">=</span>bookinfo.example.com.crt
</code></pre></div><p>然后通过 Gateway CRD 定义一个对外提供服务的虚拟主机，并指定使用刚才定义的 secret。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.istio.io/v1alpha3
<span style="color:#66d9ef">kind</span>: Gateway
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: mygateway
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">istio</span>: ingressgateway
  <span style="color:#66d9ef">servers</span>:
  - <span style="color:#66d9ef">port</span>:
      <span style="color:#66d9ef">number</span>: <span style="color:#ae81ff">443</span>
      <span style="color:#66d9ef">name</span>: https
      <span style="color:#66d9ef">protocol</span>: HTTPS
    <span style="color:#66d9ef">tls</span>:
      <span style="color:#66d9ef">mode</span>: SIMPLE
      <span style="color:#66d9ef">credentialName</span>: httpbin-credential <span style="color:#75715e"># 在此处设置包含了服务器证书和私钥的 secret</span>
    <span style="color:#66d9ef">hosts</span>:
    - bookinfo.example.com
</code></pre></div><p>Istio 将此配置通过 xDS 接口下发到 Ingress Gateway Pod 中的 Envoy 上，可以在该 Envoy 的配置导出中看到 Ingress 网关对外提供的 443 端口上的证书配置（配置文件中的端口是8443，这是因为 Pod 内使用了8443端口，但对外暴露的 LoadBalancer 上的端口是443）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0_8443&#34;</span>,
  <span style="color:#f92672">&#34;active_state&#34;</span>: {
   <span style="color:#f92672">&#34;version_info&#34;</span>: <span style="color:#e6db74">&#34;2020-05-27T07:43:51Z/21&#34;</span>,
   <span style="color:#f92672">&#34;listener&#34;</span>: {
    <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.api.v2.Listener&#34;</span>,
    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0_8443&#34;</span>,
    <span style="color:#f92672">&#34;address&#34;</span>: {
     <span style="color:#f92672">&#34;socket_address&#34;</span>: {
      <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
      <span style="color:#f92672">&#34;port_value&#34;</span>: <span style="color:#ae81ff">8443</span>
     }
    },
    <span style="color:#f92672">&#34;filter_chains&#34;</span>: [
     {
      <span style="color:#f92672">&#34;filter_chain_match&#34;</span>: {
       <span style="color:#f92672">&#34;server_names&#34;</span>: [
        <span style="color:#e6db74">&#34;bookinfo.example.com&#34;</span>
       ]
      },
      <span style="color:#f92672">&#34;filters&#34;</span>: [<span style="color:#960050;background-color:#1e0010">...</span>],
      <span style="color:#f92672">&#34;transport_socket&#34;</span>: {
       <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.transport_sockets.tls&#34;</span>,
       <span style="color:#f92672">&#34;typed_config&#34;</span>: {
        <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&#34;</span>,
        <span style="color:#f92672">&#34;common_tls_context&#34;</span>: {
         <span style="color:#f92672">&#34;alpn_protocols&#34;</span>: [
          <span style="color:#e6db74">&#34;h2&#34;</span>,
          <span style="color:#e6db74">&#34;http/1.1&#34;</span>
         ],
         <span style="color:#f92672">&#34;tls_certificate_sds_secret_configs&#34;</span>: [
          {
           <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;bookinfo-credential&#34;</span>,                            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">Ingress</span> <span style="color:#960050;background-color:#1e0010">Gateway</span> <span style="color:#960050;background-color:#1e0010">中配置的</span> <span style="color:#960050;background-color:#1e0010">Kubernetes</span> <span style="color:#960050;background-color:#1e0010">secret</span>
           <span style="color:#f92672">&#34;sds_config&#34;</span>: {
            <span style="color:#f92672">&#34;api_config_source&#34;</span>: {
             <span style="color:#f92672">&#34;api_type&#34;</span>: <span style="color:#e6db74">&#34;GRPC&#34;</span>,
             <span style="color:#f92672">&#34;grpc_services&#34;</span>: [
              {
               <span style="color:#f92672">&#34;google_grpc&#34;</span>: {
                <span style="color:#f92672">&#34;target_uri&#34;</span>: <span style="color:#e6db74">&#34;unix:/var/run/ingress_gateway/sds&#34;</span>,   <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">从本地</span> <span style="color:#960050;background-color:#1e0010">unix</span> <span style="color:#960050;background-color:#1e0010">domain</span> <span style="color:#960050;background-color:#1e0010">socket</span> <span style="color:#960050;background-color:#1e0010">上的</span> <span style="color:#960050;background-color:#1e0010">SDS</span> <span style="color:#960050;background-color:#1e0010">服务器获取服务器证书</span>
                <span style="color:#f92672">&#34;stat_prefix&#34;</span>: <span style="color:#e6db74">&#34;sdsstat&#34;</span>
               }
              }
             ]
            }
           }
          }
         ]
        },
        <span style="color:#f92672">&#34;require_client_certificate&#34;</span>: <span style="color:#66d9ef">false</span>
       }
      }
     }
    ],
   },
  }
 }
</code></pre></div><p>从配置中可以看出，Ingress Gateway 使用的服务器证书也是通过 SDS 服务获取的。Pilot-agent 在路径<code>unix:/var/run/ingress_gateway/sds</code> 上为 Ingress Gateway 提供了一个基于 unix domain socket 的 SDS 服务。Ingress Gateway 中的 Envoy 向该 SDS 服务器请求上述配置文件中的 secret，Pilot-agent 从 Kubernetes 中查到该 同名 secret，然后转换为 SDS 消息返回给 Envoy。</p>
<p>备注：</p>
<ol>
<li>Ingress Gateway 用于和网格内其他服务通信的服务身份证书还是由 Istio CA 颁发的，其证书获取的流程同图2。</li>
<li>Egress Gateway 未使用 SDS 获取用于访问外部服务的客户端证书（1.6 现状，后续也许会修改）。</li>
</ol>
<p><img src="ingress-gateway-ca-sds.svg" alt="">
图4. Ingress Gateway 证书获取流程</p>
<h2 id="数据面使用的所有证书">数据面使用的所有证书</h2>
<p>下图中以 bookinfo 来举例说明 Istio 在数据面使用到的所有证书。为了方便说明 Gateway 的证书配置，我们假设在 Ingress Gateway 上以 bookinfo.example.com 的主机名对外提供服务，并且 ratings 服务通过 Egress Gateway 访问了一个网格外部的第三方 TLS 服务。</p>
<p>图中不同颜色边框的图标代表了不同的证书。该示例中一共使用了七个不同的证书，分别为3个服务的证书（同时用作服务器和客户端证书），Ingress Gateway 自身的客户端证书，Ingress Gateway 对外部提供服务的服务器证书，Egress Gateway 自身的服务器证书，Egress Gateway 访问外部服务使用的客户端证书。</p>
<p>除了 Ingress Gateway 对外提供服务的服务器证书和 Egress Gateway 访问第三方服务的客户端证书之外，其他证书都是 Envoy 通过 SDS 服务从 Istio CA 获取的，因此都使用 Istio Root CA 证书进行验证。这两个第三方证书则需要采用第三方 CA 根证书进行验证。</p>
<p><img src="bookinfo-ca.svg" alt="">
图5. Istio 数据面使用到的所有证书</p>
<h2 id="小结">小结</h2>
<p>微服务应用本质上是一个分布式的网络程序，在微服务应用内存在大量的服务间网络通信。在云化部署环境中，服务间的身份认证和安全通信是微服务面临的一大挑战。Istio 建立了一套以数字证书为基础的服务认证安全框架，在不修改应用的前提下提供了服务之间的身份认证和安全通信，并以身份认证为基础提供了强大的授权机制。</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://istio.io/docs/tasks/traffic-management/ingress/secure-ingress/">Istio Secure Gateways</a></li>
<li><a href="https://istio.io/docs/tasks/traffic-management/egress/egress-gateway-tls-origination/#perform-tls-origination-with-an-egress-gateway">Istio Egress Gateways with TLS Origination</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/istio"> 
            Istio</a>
            
          </ul>
        </div>
        <!-- previous -->
        <div class="mb-3 link-article">
  <div class="pre-article">
    
    <div><i class="fa fa-arrow-left"></i> 上一篇</div>
    <a href="https://cloudnative.to/blog/how-tekton-works/">Tekton 的工作原理</a>
    
  </div>
  <div class="next-article">
    
    <div>下一篇 <i class="fa fa-arrow-right"></i></div>
    <a href="https://cloudnative.to/blog/oam-crossplane/">OAM和Crossplane: 构建现代应用的下一个阶段</a>
  
  </div>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/20190910-horizontal-pod-autoscaling-based-on-custom-istio-metrics/">基于自定义Istio指标的Pod水平自动缩放</a></li>
  
    <li><a href="/blog/201905-servicemesh-development-trend/">Service Mesh发展趋势：云原生中流砥柱</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5 word-cloud">
    <h4 class="mb-4">标签</h4>
    
      
      
      
      
      
      
      
      
      
      
      
      <div id="tag-cloud" style="padding: 5px 15px">
      
        
          
          
          
          <a href="/tags/anthos-service-mesh" style="font-size:1rem">anthos-service-mesh</a>
        
      
        
          
          
          &middot;
          <a href="/tags/arm" style="font-size:1rem">arm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/bpf" style="font-size:1.0454545454545454rem">bpf</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cicd" style="font-size:1.0454545454545454rem">cicd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/client-go" style="font-size:1.0909090909090908rem">client-go</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cloud-native" style="font-size:1.0909090909090908rem">cloud-native</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cloud-security" style="font-size:1rem">cloud-security</a>
        
      
        
          
          
          &middot;
          <a href="/tags/community" style="font-size:1rem">community</a>
        
      
        
          
          
          &middot;
          <a href="/tags/crossplane" style="font-size:1rem">crossplane</a>
        
      
        
          
          
          &middot;
          <a href="/tags/devops" style="font-size:1rem">devops</a>
        
      
        
          
          
          &middot;
          <a href="/tags/docker" style="font-size:1rem">docker</a>
        
      
        
          
          
          &middot;
          <a href="/tags/envoy" style="font-size:1.4090909090909092rem">envoy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/etcd" style="font-size:1rem">etcd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/flamegraph" style="font-size:1rem">flamegraph</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gateway" style="font-size:1rem">gateway</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gitops" style="font-size:1rem">gitops</a>
        
      
        
          
          
          &middot;
          <a href="/tags/google-cloud" style="font-size:1rem">google-cloud</a>
        
      
        
          
          
          &middot;
          <a href="/tags/helm" style="font-size:1rem">helm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/informer" style="font-size:1.1363636363636362rem">informer</a>
        
      
        
          
          
          &middot;
          <a href="/tags/iptables" style="font-size:1rem">iptables</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ipvs" style="font-size:1rem">ipvs</a>
        
      
        
          
          
          &middot;
          <a href="/tags/istio" style="font-size:1.9545454545454546rem">istio</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kube-proxy" style="font-size:1rem">kube-proxy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubebuilder" style="font-size:1rem">kubebuilder</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetes" style="font-size:1.5454545454545454rem">kubernetes</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kylin" style="font-size:1rem">kylin</a>
        
      
        
          
          
          &middot;
          <a href="/tags/linux%e5%86%85%e6%a0%b8" style="font-size:1rem">linux内核</a>
        
      
        
          
          
          &middot;
          <a href="/tags/microservices" style="font-size:1.0454545454545454rem">microservices</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mosn" style="font-size:1rem">mosn</a>
        
      
        
          
          
          &middot;
          <a href="/tags/netfilter" style="font-size:1rem">netfilter</a>
        
      
        
          
          
          &middot;
          <a href="/tags/oam" style="font-size:1.0454545454545454rem">oam</a>
        
      
        
          
          
          &middot;
          <a href="/tags/observability" style="font-size:1rem">observability</a>
        
      
        
          
          
          &middot;
          <a href="/tags/operator" style="font-size:1rem">operator</a>
        
      
        
          
          
          &middot;
          <a href="/tags/profile" style="font-size:1rem">profile</a>
        
      
        
          
          
          &middot;
          <a href="/tags/rbac" style="font-size:1.0454545454545454rem">rbac</a>
        
      
        
          
          
          &middot;
          <a href="/tags/redis" style="font-size:1rem">redis</a>
        
      
        
          
          
          &middot;
          <a href="/tags/security" style="font-size:1.2272727272727273rem">security</a>
        
      
        
          
          
          &middot;
          <a href="/tags/service-mesh" style="font-size:1.7272727272727273rem">service-mesh</a>
        
      
        
          
          
          &middot;
          <a href="/tags/spring-boot" style="font-size:1rem">spring-boot</a>
        
      
        
          
          
          &middot;
          <a href="/tags/spring-cloud" style="font-size:1rem">spring-cloud</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tcpdump" style="font-size:1rem">tcpdump</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tekton" style="font-size:1rem">tekton</a>
        
      
        
          
          
          &middot;
          <a href="/tags/traffic-director" style="font-size:1rem">traffic-director</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vxlan" style="font-size:1.0454545454545454rem">vxlan</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wasm" style="font-size:1.0454545454545454rem">wasm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wireshark" style="font-size:1rem">wireshark</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zero-trust-cybersecurity" style="font-size:1rem">zero-trust-cybersecurity</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zookeeper" style="font-size:1rem">zookeeper</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e4%ba%91%e5%8e%9f%e7%94%9f" style="font-size:1rem">云原生</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e4%ba%91%e5%8e%9f%e7%94%9f%e5%ad%a6%e9%99%a2" style="font-size:1.0454545454545454rem">云原生学院</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%ad%a6%e4%b9%a0%e5%b0%8f%e7%bb%84" style="font-size:1rem">学习小组</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%bc%80%e6%ba%90" style="font-size:1rem">开源</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" style="font-size:1rem">开源社区</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" style="font-size:1rem">源码分析</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e7%90%86%e8%a7%a3" style="font-size:1.0454545454545454rem">源码理解</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%a4%be%e5%8c%ba" style="font-size:1.0454545454545454rem">社区</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%bf%bb%e8%af%91" style="font-size:1.0909090909090908rem">翻译</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e8%b4%a1%e7%8c%ae%e5%bc%80%e6%ba%90" style="font-size:1rem">贡献开源</a>
        
      
      </div>
    
  </div>

  <!-- profile -->
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#istio-安全架构">Istio 安全架构</a></li>
    <li><a href="#控制面证书签发流程">控制面证书签发流程</a>
      <ul>
        <li><a href="#为什么要通过-pilot-agent-中转">为什么要通过 Pilot-agent 中转？</a></li>
        <li><a href="#控制面身份认证">控制面身份认证</a></li>
      </ul>
    </li>
    <li><a href="#sds-工作原理">SDS 工作原理</a></li>
    <li><a href="#网格-sidecar-证书配置">网格 Sidecar 证书配置</a></li>
    <li><a href="#gateway-证书配置">Gateway 证书配置</a></li>
    <li><a href="#数据面使用的所有证书">数据面使用的所有证书</a></li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是一个中立的云原生终端用户社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，旨在推广云原生技术，构建开发者生态。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="https://github.com/cloudnativeto/community/issues/58">成都</a>|<a href="https://github.com/cloudnativeto/community/issues/60">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="https://github.com/cloudnativeto/community/issues/59">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2021 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/code-of-conduct"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
