<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="该篇博客是本人在学习 client-go 源码时的一些总结和个人感受，希望可以能够给后面的学者一些帮助。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnativecn.com/blog/client-go-study/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.008259417e6adf8980695ebbbb46553f.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu11854384586569594417.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu14437075198232143360.png" />

  <link rel="canonical" href="https://cloudnativecn.com/blog/client-go-study/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnativecn.com/blog/client-go-study/" />
  <meta property="og:title" content="client-go 源码学习总结 | 云原生社区（中国）" />
  <meta property="og:description" content="该篇博客是本人在学习 client-go 源码时的一些总结和个人感受，希望可以能够给后面的学者一些帮助。" /><meta property="og:image" content="https://cloudnativecn.com/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnativecn.com/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2020-08-07T21:28:37&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2025-04-18T10:12:29&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnativecn.com/blog/client-go-study/"
  },
  "headline": "client-go 源码学习总结",
  
  "datePublished": "2020-08-07T21:28:37Z",
  "dateModified": "2025-04-18T10:12:29+08:00",
  
  "author": {
    "@type": "Person",
    "name": "姚沈结"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnativecn.com/media/logo.svg"
    }
  },
  "description": "该篇博客是本人在学习 client-go 源码时的一些总结和个人感受，希望可以能够给后面的学者一些帮助。"
}
</script>

  

  

  

  





  <title>client-go 源码学习总结 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="a003e79cf328f0a3ba63d3c811c9db10" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>云原生资料库</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>client-go 源码学习总结</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E5%A7%9A%E6%B2%88%E7%BB%93/">姚沈结</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/kubernetes/" class="text-capitalize">Kubernetes</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2020-08-07
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 3699
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 17 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#概括">概括</a></li>
    <li><a href="#restclient-客户端">RESTClient 客户端</a></li>
    <li><a href="#dynamicclient-客户端">DynamicClient 客户端</a></li>
    <li><a href="#clientset-客户端">ClientSet 客户端</a></li>
    <li><a href="#discoveryclient-客户端">DiscoveryClient 客户端</a></li>
    <li><a href="#clientset-vs-dynamicclient">ClientSet VS DynamicClient</a></li>
    <li><a href="#informer-分析">Informer 分析</a>
      <ul>
        <li><a href="#informer-源码类图">Informer 源码类图</a></li>
        <li><a href="#indexer-分析">Indexer 分析</a></li>
        <li><a href="#threadsafemap-分析">threadSafeMap 分析</a></li>
      </ul>
    </li>
    <li><a href="#workqueue-分析">WorkQueue 分析</a></li>
    <li><a href="#示例参考">示例参考</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block my-4">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#概括">概括</a></li>
    <li><a href="#restclient-客户端">RESTClient 客户端</a></li>
    <li><a href="#dynamicclient-客户端">DynamicClient 客户端</a></li>
    <li><a href="#clientset-客户端">ClientSet 客户端</a></li>
    <li><a href="#discoveryclient-客户端">DiscoveryClient 客户端</a></li>
    <li><a href="#clientset-vs-dynamicclient">ClientSet VS DynamicClient</a></li>
    <li><a href="#informer-分析">Informer 分析</a>
      <ul>
        <li><a href="#informer-源码类图">Informer 源码类图</a></li>
        <li><a href="#indexer-分析">Indexer 分析</a></li>
        <li><a href="#threadsafemap-分析">threadSafeMap 分析</a></li>
      </ul>
    </li>
    <li><a href="#workqueue-分析">WorkQueue 分析</a></li>
    <li><a href="#示例参考">示例参考</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav>
</details>

                    
                    <p>目前在云原生社区的 Kubernetes 源码研习社中和广大学友们共同学习郑东旭大佬的 <a href="https://item.jd.com/12665791.html" target="_blank" rel="noopener">Kubernetes 源码剖析</a>这本书。当前正在开展第一期学习活动，第五章节 client-go 的学习。之所以从这一章节开始学习，主要是考虑到 client-go 在源码中相对比较独立，可以单独阅读。更主要的是它是 Kubernetes 的核心处理框架，基本上运用在 Kubernetes 各个组件中，因此，如果你学好了这一章节，对于后面 Kubernetes 源码的阅读，将会有很大的帮助。此外随着 Operator 的盛行，一些开源的生成框架也受到广大 Operator 开发者们的青睐。例如 kubebuilder 和 operator-SDK 等。而精通了 client-go，将对你理解这些生成框架及编写 Operator 也是有很好的帮助。</p>
<p>下面内容是在学习过程中总结的相关笔记及个人见解。</p>
<h2 id="概括">概括</h2>
<p>client-go 是用 Golang 语言编写的官方编程式交互客户端库，提供对 Kubernetes API server 服务的交互访问。</p>
<p>其源码目录结构如下：</p>
<ol>
<li><strong>discovery</strong>: 提供 DiscoveryClient 发现客户端。</li>
<li><strong>dynamic</strong>: 提供 DynamicClient 动态客户端。</li>
<li><strong>informers</strong>: 每种 K8S 资源的 Informer 实现。</li>
<li><strong>kubernetes</strong>: 提供 ClientSet 客户端。</li>
<li><strong>listers</strong>: 为每一个 K8S 资源提供 Lister 功能，该功能对 Get 和 List 请求提供只读的缓存数据。</li>
<li><strong>plugin</strong>: 提供 OpenStack，GCP 和 Azure 等云服务商授权插件。</li>
<li><strong>rest</strong>: 提供 RESTClient 客户端，对 K8S API Server 执行 RESTful 操作。</li>
<li><strong>scale</strong>: 提供 ScaleClient 客户端，用于扩容或缩容 Deployment, Replicaset, Replication Controller 等资源对象。</li>
<li><strong>tools</strong>: 提供常用工具，例如 SharedInformer, Reflector, DeltaFIFO 及 Indexers。提供 Client 查询和缓存机制，以减少向 kube-apiserver 发起的请求数等。主要子目录为/tools/cache。</li>
<li><strong>transport</strong>: 提供安全的 TCP 连接，支持 HTTP Stream，某些操作需要在客户端和容器之间传输二进制流，例如 exec，attach 等操作。该功能由内部的 SPDY 包提供支持。</li>
<li><strong>util</strong>: 提供常用方法。例如 WorkQueue 工作队列，Certificate 证书管理等。</li>
</ol>
<h2 id="restclient-客户端">RESTClient 客户端</h2>
<p>RESTful Client 是最基础的客户端，它主要是对 HTTP 请求进行了封装，并且支持 JSON 和 Protobuf 格式数据。</p>
<h2 id="dynamicclient-客户端">DynamicClient 客户端</h2>
<p>DynamicClient 是一种动态客户端，它可以动态的指定资源的组，版本和资源。因此它可以对任意 K8S 资源进行 RESTful 操作，包括 CRD 自定义资源。它封装了 RESTClient。所以同样提供 RESTClient 的各种方法。</p>
<p>具体使用方法，可参考官方示例：<a href="https://github.com/kubernetes/client-go/tree/master/examples/dynamic-create-update-delete-deployment" target="_blank" rel="noopener">dynamic-create-update-delete-deployment</a>。</p>
<p><strong>注意</strong>: 该官方示例是基于集群外的环境，如果你需要在集群内部使用（例如你需要在 container 中访问），你将需要调用 <code>rest.InClusterConfig()</code> 生成一个 configuration。具体的示例请参考 <a href="https://github.com/kubernetes/client-go/tree/master/examples/in-cluster-client-configuration" target="_blank" rel="noopener">in-cluster-client-configuration</a>。</p>
<h2 id="clientset-客户端">ClientSet 客户端</h2>
<p>ClientSet 客户端在 RESTClient 的基础上封装了对资源和版本的管理方法。每个资源可以理解为一个客户端，而 ClientSet 则是多个客户端的集合，每一个资源和版本都以函数的方式暴露给开发者。</p>
<p>具体使用方法，可参考官方示例：<a href="https://github.com/kubernetes/client-go/tree/master/examples/create-update-delete-deployment" target="_blank" rel="noopener">create-update-delete-deployment</a>。</p>
<h2 id="discoveryclient-客户端">DiscoveryClient 客户端</h2>
<p>DiscoveryClient 是一个发现客户端，它主要用于发现 K8S API Server 支持的资源组，资源版本和资源信息。所以开发者可以通过使用 DiscoveryClient 客户端查看所支持的资源组，资源版本和资源信息。</p>
<h2 id="clientset-vs-dynamicclient">ClientSet VS DynamicClient</h2>
<p>类型化 <code>ClientSets</code> 使得使用预先生成的本地 API 对象与 API 服务器通信变得简单，从而获得类似 <code>RPC</code> 的编程体验。类型化客户端使用程序编译来强制执行数据安全性和一些验证。然而，在使用类型化客户端时，程序被迫与所使用的版本和类型紧密耦合。</p>
<p>而 <code>DynamicClient</code> 则使用 <code>unstructured.Unstructured</code> 表示来自 API Server 的所有对象值。<code>Unstructured</code> 类型是一个嵌套的 <code>map[string]inferface{}</code> 值的集合来创建一个内部结构，该结构和服务端的 REST 负载非常相似。</p>
<p><code>DynamicClient</code> 将所有数据绑定推迟到运行时，这意味着程序运行之前，使用 <code>DynamicClient</code> 的的程序将不会获取到类型验证的任何好处。对于某些需要强数据类型检查和验证的应用程序来说，这可能是一个问题。</p>
<p>然而，松耦合意味着当客户端 API 发生变化时，使用 <code>DynamicClient</code> 的程序不需要重新编译。客户端程序在处理 API 表面更新时具有更大的灵活性，而无需提前知道这些更改是什么。</p>
<h2 id="informer-分析">Informer 分析</h2>
<p>这是一个官方图形表示，展示了 client-go 库中的各种组件如何工作，以及它们与将要编写的自定义控制器代码的交互点。</p>
<p>















<figure  id="figure-ldquocustom-controllerrdquo">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="&ldquo;custom controller&rdquo;" srcset="
               /blog/client-go-study/informer_hu8106387590596319033.webp 400w,
               /blog/client-go-study/informer_hu951792774307255356.webp 760w,
               /blog/client-go-study/informer_hu15833439809673982721.webp 1200w"
               src="/blog/client-go-study/informer_hu8106387590596319033.webp"
               width="760"
               height="570"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      &ldquo;custom controller&rdquo;
    </figcaption></figure>
</p>
<p>下面对图中每个组件进行简单介绍：</p>
<ol>
<li>
<p><em><strong>client-go 组件</strong></em></p>
<ul>
<li>
<p><strong>Reflector</strong>: 定义在 <a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/reflector.go" target="_blank" rel="noopener">/tools/cache 包内的 Reflector 类型</a> 中的 reflector 监视 Kubernetes API 以获取指定的资源类型 (Kind)。完成此操作的函数是 ListAndWatch。监视可以用于内建资源，也可以用于自定义资源。当 reflector 通过监视 API 的收到关于新资源实例存在的通知时，它使用相应的 listing API 获取新创建的对象，并将其放入 watchHandler 函数内的 Delta Fifo 队列中。</p>
</li>
<li>
<p><strong>Informer</strong>: 在 <a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/controller.go" target="_blank" rel="noopener">/tools/cache 包内的基础 controller</a> 中定义的一个 informer 从 Delta FIFO 队列中弹出对象。完成此操作的函数是 processLoop。这个基础 controller 的任务是保存对象以供以后检索，并调用 controller 将对象传递给它。</p>
</li>
<li>
<p><strong>Indexer</strong>: indexer 为对象提供索引功能。它定义在 <a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/index.go" target="_blank" rel="noopener">/tools/cache 包内的 Indexer 类型</a>。一个典型的索引用例是基于对象标签创建索引。Indexer 可以基于多个索引函数维护索引。Indexer 使用线程安全的数据存储来存储对象及其键值。在 <a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/store.go" target="_blank" rel="noopener">/tools/cache 包内的 Store 类型</a> 定义了一个名为<code>MetaNamespaceKeyFunc</code>的默认函数，该函数为该对象生成一个名为 <code>&lt;namespace&gt;/&lt;name&gt;</code> 组合的对象键值。</p>
</li>
</ul>
</li>
<li>
<p><em><strong>Custom Controller 组件</strong></em></p>
<ul>
<li>
<p><strong>Informer reference</strong>: 这是一个知道如何使用自定义资源对象的 Informer 实例的引用。您的自定义控制器代码需要创建适当的 Informer。</p>
</li>
<li>
<p><strong>Indexer reference</strong>: 这是一个知道如何使用自定义资源对象的 Indexer 实例的引用。您的自定义控制器代码需要创建这个。您将使用此引用检索对象，以便稍后处理。</p>
</li>
<li>
<p><strong>Resource Event Handlers</strong>: 当 Informer 想要分发一个对象给你的控制器时，会调用这些回调函数。编写这些函数的典型模式是获取已分配对象的键值，并将该键值放入一个工作队列中进行进一步处理。</p>
</li>
<li>
<p><strong>Work queue</strong>: 这是在控制器代码中创建的队列，用于将对象的分发与处理解耦。编写 Resource Event Handler 函数来提取所分发对象的键值并将其添加到工作队列中。</p>
</li>
<li>
<p><strong>Process Item</strong>: 这是在代码中创建的处理 work queue 中的 items 的函数。可以有一个或多个其他函数来执行实际的处理。这些函数通常使用 <a href="https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go#L73" target="_blank" rel="noopener">Indexer 引用</a> 或 Listing wrapper 来获取与键值对应的对象。</p>
</li>
</ul>
</li>
</ol>
<h3 id="informer-源码类图">Informer 源码类图</h3>
<p>















<figure  id="figure-ldquoinformer-class-diagramrdquo">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="&ldquo;Informer class diagram&rdquo;" srcset="
               /blog/client-go-study/clientgo_hu11412934179616496601.webp 400w,
               /blog/client-go-study/clientgo_hu218198765252053343.webp 760w,
               /blog/client-go-study/clientgo_hu14354877451566142623.webp 1200w"
               src="/blog/client-go-study/clientgo_hu11412934179616496601.webp"
               width="760"
               height="664"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      &ldquo;Informer class diagram&rdquo;
    </figcaption></figure>
</p>
<p>该类图主要描述了 Informer 中主要的接口和类之前的调用关系。大家可以参考这个类图去阅读源码。其中每个类或接口具体功能，请参考 <a href="https://item.jd.com/12665791.html" target="_blank" rel="noopener">Kubernetes 源码剖析</a>第五章节 client-go。</p>
<h3 id="indexer-分析">Indexer 分析</h3>
<ol>
<li><strong>Store</strong> : 是一个通用对象存储和处理接口。</li>
<li><strong>Indexer</strong> : Indexer 扩展了多个索引的 Store，并限制每个累加器只保存当前对象（删除后为空）。</li>
<li><strong>cache</strong> : 根据 ThreadSafeStore 和关联的 KeyFunc 实现的 Indexer。</li>
<li><strong>ThreadSafeStore</strong> : 是一个允许对存储后端进行并发索引访问的接口。它类似于 Indexer，但不（必须）知道如何从给定对象中提取存储键。</li>
<li><strong>threadSafeMap</strong> : 实现了 ThreadSafeStore。</li>
</ol>
<p>下面为具体的类图展示：</p>
<p>















<figure  id="figure-ldquoindexerrdquo">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="&ldquo;indexer&rdquo;" srcset="
               /blog/client-go-study/indexer_hu5735890999096622281.webp 400w,
               /blog/client-go-study/indexer_hu7757065081145967985.webp 760w,
               /blog/client-go-study/indexer_hu2906336001637684108.webp 1200w"
               src="/blog/client-go-study/indexer_hu5735890999096622281.webp"
               width="740"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      &ldquo;indexer&rdquo;
    </figcaption></figure>
</p>
<h3 id="threadsafemap-分析">threadSafeMap 分析</h3>
<p><strong>threadSafeMap</strong> 类中包含下面三个属性：</p>
<ol>
<li><code>items map[string]interface{}</code> 保存所有数据的 map 结构。</li>
<li><code>indexers Indexers</code> 通过一个名字映射一个 IndexFunc 索引处理函数。</li>
<li><code>indices Indices</code> 通过一个名字映射一个 Index。</li>
</ol>
<p>下面是 threadSafeMap 结构的源码定义：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// threadSafeMap implements ThreadSafeStore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">threadSafeMap</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lock</span>  <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">items</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// indexers maps a name to an IndexFunc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">indexers</span> <span class="nx">Indexers</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// indices maps a name to an Index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">indices</span> <span class="nx">Indices</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>下面是 Indexers, Indices and Index 的源码定义：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// IndexFunc knows how to compute the set of indexed values for an object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">IndexFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Index maps the indexed value to a set of keys in the store that match on that value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Index</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">sets</span><span class="p">.</span><span class="nx">String</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Indexers maps a name to a IndexFunc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Indexers</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">IndexFunc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Indices maps a name to an Index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Indices</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Index</span>
</span></span></code></pre></div><p>这是一个 threadSafeMap 存储结构的示例图：</p>
<p>















<figure  id="figure-ldquothreadsafemapstoragestructurerdquo">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="&ldquo;threadSafeMapStorageStructure&rdquo;" srcset="
               /blog/client-go-study/threadSafeMapStorageStructure_hu9820354424330142350.webp 400w,
               /blog/client-go-study/threadSafeMapStorageStructure_hu9449063545762364000.webp 760w,
               /blog/client-go-study/threadSafeMapStorageStructure_hu1158134071677348470.webp 1200w"
               src="/blog/client-go-study/threadSafeMapStorageStructure_hu9820354424330142350.webp"
               width="760"
               height="387"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      &ldquo;threadSafeMapStorageStructure&rdquo;
    </figcaption></figure>
</p>
<p>最后以添加一个新的对象到 threadSafeMap 为例，分析具体需要哪些操作。</p>
<p>首先列出源码以供参考：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">threadSafeMap</span><span class="p">)</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oldObject</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">obj</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nf">updateIndices</span><span class="p">(</span><span class="nx">oldObject</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// updateIndices modifies the objects location in the managed indexes, if this is an update, you must provide an oldObj
</span></span></span><span class="line"><span class="cl"><span class="c1">// updateIndices must be called from a function that already has a lock on the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">threadSafeMap</span><span class="p">)</span> <span class="nf">updateIndices</span><span class="p">(</span><span class="nx">oldObj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if we got an old object, we need to remove it before we add it again
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">oldObj</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">deleteFromIndices</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">indexFunc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">indexers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">indexValues</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">indexFunc</span><span class="p">(</span><span class="nx">newObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to calculate an index entry for key %q on index %q: %v&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">index</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">index</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">index</span> <span class="p">=</span> <span class="nx">Index</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="p">=</span> <span class="nx">index</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">indexValue</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">indexValues</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">set</span> <span class="o">:=</span> <span class="nx">index</span><span class="p">[</span><span class="nx">indexValue</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">set</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">set</span> <span class="p">=</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">String</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">index</span><span class="p">[</span><span class="nx">indexValue</span><span class="p">]</span> <span class="p">=</span> <span class="nx">set</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">set</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>从上面代码可以总结出下面几个步骤：</p>
<ol>
<li>从 items 中获取旧的对象值，并将新的对象添加到 items 中指定键值的位置。</li>
<li>将新加入对象的键值更新到索引中。
<ol>
<li>如果旧的对象存在，则将其从索引中删除，否则进行下一步。</li>
<li>迭代 indexers 进行新对象的索引处理。</li>
<li>通过 indexers 中的 indexFunc 处理新对象，找到相应的 indexValues。</li>
<li>使用 indexer 的 name 从 indices 中找到对应的 index。如果对应的 index 是空，则创建一个新的 index。</li>
<li>迭代 indexValues 进行 index 处理。</li>
<li>通过 indexValue 在 index 中找到对应的 set，如果 set 不存在，则创建一个新的 set。并添加到 index 中。</li>
<li>添加新对象的键值到 set 中。</li>
<li>返回第 5 步，直到迭代完成。</li>
<li>返回第 2 步，直到迭代完成。</li>
</ol>
</li>
</ol>
<h2 id="workqueue-分析">WorkQueue 分析</h2>
<p><strong>Interface</strong> : FIFO 队列接口，并支持去重处理。</p>
<p><strong>DelayingInterface</strong>: 延迟队列接口，基于 <strong>Interface</strong> 接口封装。</p>
<p><strong>RateLimitingInterface</strong>: 速率限制接口，基于 <strong>DelayingInterface</strong> 接口封装。</p>
<p>下面是相关类图：</p>
<p>















<figure  id="figure-ldquoworkqueuerdquo">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="&ldquo;workqueue&rdquo;" srcset="
               /blog/client-go-study/workqueue_hu13263401567674469010.webp 400w,
               /blog/client-go-study/workqueue_hu4668064115896736177.webp 760w,
               /blog/client-go-study/workqueue_hu4007318847814125603.webp 1200w"
               src="/blog/client-go-study/workqueue_hu13263401567674469010.webp"
               width="760"
               height="517"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      &ldquo;workqueue&rdquo;
    </figcaption></figure>
</p>
<h2 id="示例参考">示例参考</h2>
<ol>
<li>
<p>参考 K8S 官方示例 <a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener">Kubernetes/sample-controller</a>。</p>
</li>
<li>
<p>参考 client-go 官方示例 <a href="https://github.com/kubernetes/client-go/tree/master/examples/workqueue" target="_blank" rel="noopener">workqueue</a>。这是一个典型的使用 client-go informer 的例子，它完全基于 client-go informer 的框架。几乎所有的 K8S 控制器都是基于这个框架实现的。所以个人认为 client-go 的 informer 机制是 k8S controller 实现的基石。</p>
</li>
</ol>
<h2 id="总结">总结</h2>
<p>可以说 Kubernetes 是当前云原生的基石。所以想要进军云原生领域，kubernetes 的学习必不可少。kubernetes 的设计理念就是通过各种控制器将系统的实际运行状态协调到声明 API 中的期待状态。而这种协调机制就是基于 client-go 实现的。同样，kubernetes 对于 ETCD 存储的缓存处理也使用到了 client-go 中的 Reflector 机制。所以学好 client-go，等于迈入了 Kubernetes 的大门。</p>
<p>学习 Kubernetes 及更多云原生相关技术是一个漫长的过程。所以需要一个人有极强的意志力和学习动力。如果你觉得自己缺乏这些能力，可以加入我们 <a href="https://cloudnative.to/" target="_blank" rel="noopener">云原生社区</a>。大家一起学习，相互督促，相互分享，相互学习，相互成长。</p>
<p>最后送自己和正在学习及将要学习 Kubernetes 源码的同学们一句话：<strong>不积跬步，无以至千里；不积小流，无以成江海！</strong></p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener">Source code</a></li>
<li><a href="https://github.com/opsnull/kubernetes-dev-docs/tree/master/client-go" target="_blank" rel="noopener">Kubernetes client-go 库介绍和源码解析</a></li>
<li><a href="https://tangxusc.github.io/blog/2019/05/client-go-informer%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">Client-Go informer 机制</a></li>
<li><a href="https://www.jianshu.com/p/76e7b1a57d2c" target="_blank" rel="noopener">informer 之 store 和 index</a></li>
<li><a href="https://xigang.github.io/2019/09/21/client-go/" target="_blank" rel="noopener">Kubernetes Client-Go Informer 实现源码剖析</a></li>
<li><a href="http://www.programmersought.com/article/6135240470/" target="_blank" rel="noopener">client-go package Informer source code analysis</a></li>
<li><a href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kube-controller-manager/sharedIndexInformer.html" target="_blank" rel="noopener">kube-controller-manager 源码分析（三）之 Informer 机制</a></li>
<li><a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md" target="_blank" rel="noopener">Sample-controller</a></li>
<li><a href="https://studygolang.com/articles/20402" target="_blank" rel="noopener">Indexer</a></li>
</ul>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/client-go/">Client-Go</a>
  
  <a class="badge badge-light" href="/tag/kubernetes/">Kubernetes</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E5%A7%9A%E6%B2%88%E7%BB%93/"><img class="avatar mr-3 avatar-circle" src="/author/%E5%A7%9A%E6%B2%88%E7%BB%93/avatar_hu11923143467678028498.jpg" alt="姚沈结"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E5%A7%9A%E6%B2%88%E7%BB%93/">姚沈结</a></p>
      
      <p class="card-text">爱立信上海研发工程师，云原生爱好者。</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/bpf-intro/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>eBPF 技术简介</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/compile-bpf-examples/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>编译运行 Linux 内核源码中的 eBPF 示例代码</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/client-go-study/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/battle-of-the-pods-kubernetes-autoscaling-showdown-keda-vs-vanilla-kubernetes/">KEDA vs. 原生 Kubernetes：谁是云原生应用的自动伸缩王者？</a></li>
      
      <li><a href="/blog/what-is-a-kubernetes-cluster-mesh-and-what-are-the-benefits/">如何使用 Calico 构建和管理 Kubernetes Cluster Mesh</a></li>
      
      <li><a href="/blog/does-kubernetes-really-perform-better-on-bare-metal-vs-vms/">Kubernetes 在裸机上比虚拟机表现更好吗：Kubernetes 性能对比实验</a></li>
      
      <li><a href="/blog/ordering-containers-within-pod/">解密 Kubernetes Pod 中容器的有序部署：Kubexit 工具的妙用</a></li>
      
      <li><a href="/blog/why-we-decided-to-start-fresh-with-our-nginx-gateway-fabric/">为什么我们决定从新开始我们的 NGINX Gateway Fabric</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnativecn.com",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2024 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.4684ca30d68fb8aed8d4debfcc18beed.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.85fc5fdbc5de9f11d741a1c4a48fe458.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
