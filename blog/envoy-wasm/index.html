<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>Istio 进阶学习系列 - 基于 WebAssembly 实现 Envoy 与 Istio 的功能扩展 | 云原生社区</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文对 WebAssembly 和 Envoy 技术进行了介绍，通过 WASM Filter 的构建、发布和部署过程，方便读者了解 Envoy WASM Filter 的扩展方式及其实现原理。">
  
  <meta name="author" content="Cloud Native Community">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">

  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="Cloud Native Community"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">初创成员</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/community/issues/50">城市站</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/community">参与进来</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                学院
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/sig-k8s-source-code">Kubernetes 源码研习社</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                博客
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/categories/kubernetes">Kubernetes</a>
                
                <a class="dropdown-item" href="/categories/service-mesh">Service Mesh</a>
                
                <a class="dropdown-item" href="/categories/envoy">Envoy</a>
                
                <a class="dropdown-item" href="/categories/oam">OAM</a>
                
                <a class="dropdown-item" href="/categories/%E5%BC%80%E6%BA%90%E7%A4%BE%E5%8C%BA">开源社区</a>
                
                <a class="dropdown-item" href="/blog">所有</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 文档</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/slides">幻灯片</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                关于
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/about">介绍</a>
                
                <a class="dropdown-item" href="/contact">联系</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">Istio 进阶学习系列 - 基于 WebAssembly 实现 Envoy 与 Istio 的功能扩展</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">本文对 WebAssembly 和 Envoy 技术进行了介绍，通过 WASM Filter 的构建、发布和部署过程，方便读者了解 Envoy WASM Filter 的扩展方式及其实现原理。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/envoy-wasm.png'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">Envoy</div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://github.com/sunzhaochang">孙召昌</a></strong>
          
            发表于 <strong class="text-dark">2020年6月12日</strong></div>
        <hr>
        <div class="content">
          <h2 id="背景">背景</h2>
<p>Istio 从发布开始就使用 Envoy 作为自己的数据平面，充分利用了 Envoy 提供的服务发现、路由、熔断、负载均衡等功能。与此同时，Istio 项目也一直致力于提供一个便于灵活扩展的平台，以满足用户多样化的需求。在过去的一年半中， Google 的团队一直在努力用 WebAssembly 技术为 Envoy 代理添加动态扩展，并推出了针对 Envoy 代理的 WebAssembly (以下简称为WASM) 扩展机制，包括标准化的 ABI，SDK，以及该扩展机制的第一个重点实现：全新的、低延迟的 Istio 遥测系统。</p>
<p>本文主要对 Envoy 和 WebAssembly 技术进行介绍，并使用 solo.io 团队推出的 wasme 工具完成 WASM filter 的构建、发布和部署，方便读者了解 Envoy WASM Filter 的扩展方式及其实现原理。</p>
<h2 id="envoy-的过滤器机制">Envoy 的过滤器机制</h2>
<p>Envoy 是 Istio 中的 Sidecar 官方标配，是一个面向服务架构的高性能网络代理，由 C++ 语言实现，拥有强大的定制化能力。Envoy 提供了进程外架构、支持L3/L4 filter、HTTP L7 filter、服务发现和动态配置、健康检查等高级功能。这里我们重点介绍一下 Envoy 流量处理过程中的 filter 机制。</p>
<h3 id="过滤器机制">过滤器机制</h3>
<p>Envoy 是面向服务架构设计的L7代理和通信总线，核心是一个 L3/L4 网络代理。可插入 filter 链机制允许开发人员编写 filter 来执行不同的 TCP 代理任务并将其插入到主体服务中。Envoy 还支持额外的 HTTP L7 filter 层。可以将 HTTP filter 插入执行不同任务的 HTTP 连接管理子系统。</p>
<p><img src="envoy-wasm-1.png" alt=""></p>
<p>目前，Envoy 提供的过滤器包括侦听器过滤器（Listener Filters）、网络过滤器（Network Filters）、HTTP过滤器（HTTP Filters）三种类型，它们共同组成了一个层次化的过滤器链。</p>
<p><strong>1、侦听器过滤器</strong></p>
<p>侦听器过滤器在初始连接阶段访问原始数据并操作 L4 连接的元数据。例如，TLS 检查器过滤器（TLS Inspector Filter）标识连接是否经过 TLS 加密，并解析与该连接关联的 TLS 元数据（SNI或ALPN协商的协议类型）；HTTP Inspector Filter 检测应用协议是否是 HTTP，如果是的话，再进一步检测 HTTP 协议类型 (HTTP/1.x or HTTP/2) ，这两种过滤器解析到的元数据都可以和 FilterChainMatch 结合使用。</p>
<p><strong>2、网络过滤器</strong></p>
<p>网络过滤器访问和操作 L4 连接上的原始数据，即TCP数据包。例如，TCP代理过滤器（TCP Proxy Filter）将客户端连接数据路由到上游主机，它还可以生成连接统计数据。此外，MySQL proxy、Redis proxy、Dubbo proxy、Thrift proxy等都属于网络过滤器。</p>
<p><strong>3、HTTP过滤器</strong></p>
<p>HTTP 过滤器在 L7 上运行，由网络过滤器（即 HTTP 连接管理器，HTTP Connection Manager）创建。这些过滤器用于访问、操作 HTTP 请求和响应，例如，gRPC-JSON 转码器过滤器（gRPC-JSON Transcoder Filter）可以为 gRPC 后端提供一个 REST API，并将请求和响应转换为相应的格式。此外，还包括  JWT、Router、RBAC 等多种过滤器。</p>
<p>整体来看，Envoy 的过滤器机制为用户提供了很多好处，比如：用户可以创建一个中间层，以便在与不兼容的服务器通信时优雅地处理客户端请求；代理可以执行协议转换，允许不同的协议互操作；代理可以通过过滤器做出智能路由决策等。</p>
<h3 id="扩展方式">扩展方式</h3>
<p>现有的 Filter 可能无法满足用户的使用需求，这时候就需要对 Envoy 进行功能扩展，通过在现有的过滤链基础上自定义新的 filter，实现定制化需求。用户可以通过以下三种方式对 Envoy 进行扩展。</p>
<p><strong>1、编写 C++ 代码扩展 Envoy</strong></p>
<p>这种方式直接在 Envoy 基础上编写 C++ 代码进行功能增强，实现自定义的 filter 之后，重新编译新的二进制可执行文件，完成现有业务的升级替换。这种方式有以下两方面问题：</p>
<p>受语言限制，只能使用 C++ 进行扩展，不利于生态发展；
提高了部署、运维、升级的复杂性，Envoy将会变得越来越重，并且每次更改都需要重新编译二进制文件，不利于技术迭代和管理。</p>
<p><strong>2、使用 lua 脚本扩展 filter</strong></p>
<p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。HTTP Lua Filter 允许在请求和响应流程中运行 Lua 脚本，在运行时使用 LuaJIT。该过滤器仅支持在配置中直接加载 Lua 代码。</p>
<p>目前支持的主要功能包括：对传输的请求或响应流，提供头部、正文和尾部的检查；对头部和尾部进行修改；对上游主机执行异步HTTP调用；直接执行响应并跳过后续的过滤器等。</p>
<p>然而，HTTP Lua Filter 是实验性的，在生产中使用需要自担风险。若存在非常复杂或更高性能的场景，建议使用本地 C++ 过滤器。</p>
<p><strong>3、使用 WASM 扩展 envoy</strong></p>
<p>为了提供更加方便、更加灵活的扩展方式，Google 团队计划用 WebAssembly 为 Envoy 代理添加动态扩展。用户可以使用自己擅长的编程语言编写 filter，并使用工具编译成 wasm 格式，嵌入到 Envoy 中运行即可。目前，Google 也与社区紧密合作，以确保为用户提供良好的开发者体验，帮助用户快速上手。Google 团队也一直与 Solo.io 团队紧密合作，Solo 团队已经建立了 WebAssembly Hub 服务，用于构建，共享，发现和部署 WASM 扩展。有了 WebAssembly Hub，WASM 扩展就会像容器一样易于管理，安装和运行。</p>
<h2 id="wasm-概述">WASM 概述</h2>
<h3 id="介绍">介绍</h3>
<p>WebAssembly（WASM）是一种由多种语言编写的，可移植的字节码格式，它能以接近本机的速度执行。作为一种可移植、体积小、加载快并且兼容 Web 的全新格式，wasm具有以下特点：</p>
<ul>
<li>高效：WASM 有一套完整的语义，实际上 WASM 是体积小且加载快的二进制格式， 其目标就是充分发挥硬件能力以达到原生执行效率。</li>
<li>安全：WASM 运行在一个沙箱化的执行环境中，甚至可以在现有的 JavaScript 虚拟机中实现。</li>
<li>开放：WASM 设计了一个非常规整的文本格式，用于调试、测试、实验、优化、学习、教学或者编写程序。</li>
<li>标准：WASM 在 web 中被设计成无版本、特性可测试、向后兼容的特点。WASM 不仅可以运行在浏览器上，也可以运行在非web环境下。</li>
</ul>
<p>需要注意的是，WASM 是一个编译目标，不是一种编程语言。WebAssembly 是经过编译器编译之后的目标格式，体积小、起步快。在语法上完全脱离 JavaScript，同时具有沙盒化的执行环境。</p>
<p>尽管 WASM 最初是作为客户端技术诞生的，但它应用于服务器端时也有很多优势。比如运行时是内存安全的，并且以沙盒方式运行以确保其安全性。</p>
<h3 id="工具链">工具链</h3>
<p>这里简单介绍一下 WASM 编译相关的工具链。传统的编译器设计都是三步式的：Frontend(前端)，Optimizer（优化器），Backend(后端)。</p>
<ul>
<li>Frontend ：源代码解析，错误检查，然后构建一个语言相关的抽象语法树(AST)来表示输入的代码。</li>
<li>Optimizer：优化器会做很多的转换来减少代码的运行时间，比如说减少冗余的计算。</li>
<li>Backend：将优化后的代码映射到目标指令集，也可以被称为代码生成器。</li>
</ul>
<p>而在一个基于 LLVM 的编译器中，一个 Frontend 的任务是对源代码进行解析、错误诊断，然后将解析后的的代码转换为 LLVM IR（Intermediate Representation），IR 会经过一系列的分析和优化以便提高代码性能，最后基于优化后的代码生成相应的机器代码。这种方式十分灵活，当扩展编程语言或硬件类型时，添加对应的前端或后端即可，优化阶段则成为了一个通用的阶段。</p>
<p>Emscripten 的底层就是 LLVM 编译器，可以将 LLVM 字节码编译成 JavaScript，还支持 WebAssembly 这一更加先进的 Web 技术，可以生成 WASM 字节码文件。</p>
<h2 id="wasm与envoy和istio">WASM与Envoy和Istio</h2>
<h3 id="istio-引入-webassembly">Istio 引入 WebAssembly</h3>
<p>该特性在 Istio 1.5 自带的 Envoy 中以 Alpha 版本推出，其源代码在 envoy-wasm 开发分支中，并且正在努力将其合并到 Envoy 主干上。该实现使用了 Google 高性能 V8 引擎 中内置的 WebAssembly 运行时。</p>
<p>除了构建底层的运行时，Google 团队还开展了以下关键工作：</p>
<ul>
<li>制定 Wasm 嵌入代理的通用应用程序二进制接口（ABI），这意味着编译后的扩展将可以在不同版本的 Envoy 中工作，甚至其它代理也可以，前提是其它代理实现了 ABI</li>
<li>用 C++, Rust 和 AssemblyScript 可以方便进行扩展开发的 SDK，后续还会支持更多类型的编程语言</li>
<li>全面的示例和说明，介绍如何在 Istio 和独立的 Envoy 中部署</li>
<li>允许使用其它 WASM 运行时的抽象，包括把扩展直接编译进 Envoy 中 “null” 运行时，这对于测试和调试非常有用</li>
</ul>
<p>使用 WASM 扩展 Envoy 带来了很多好处：</p>
<ul>
<li>敏捷性：可以用 Istio 控制平面在运行时下发和重载扩展，这就可以快速的进行开发、测试、发布，而无需重启 Envoy。</li>
<li>可靠性和隔离性：扩展模块部署在具有资源限制的沙箱中，这意味着虽然该模块可能崩溃或泄漏内存，但不会让整个 Envoy 挂掉。</li>
<li>灵活性：可以将多种编程语言编译为 WASM，让各种技术背景的开发人员都可以选择自己的语言来编写 Envoy 扩展，比如：C++，Go，Rust，Java，TypeScript 等。</li>
</ul>
<h3 id="wasme-实践">WASME 实践</h3>
<p>Solo.io 团队发布了 WebAssembly Hub，这是一套为 Envoy 和 Istio 准备的，用于构建、部署、共享和发现 Envoy Proxy WASM 扩展的工具和仓库。</p>
<p>WebAssembly Hub 将开发和部署 Wasm 扩展所需的许多步骤都自动化了。使用 WebAssembly Hub 提供的工具，用户可以轻松地把任何受支持语言开发的代码编译为 WASM 扩展，并将这些扩展上传到 Hub 仓库，使用单个命令就将其在 Istio 中部署和删除。</p>
<p>WebAssembly Hub 工具提供了功能强大的 CLI 和优雅且易于使用的图形用户界面，该产品的一个重要目标是简化构建 WASM 模块的体验。下面介绍一下使用 wasme 工具开发、构建和部署 filter 的整体流程。</p>
<p><strong>1、安装 wasme cli</strong></p>
<p>wasme 命令行工具用于构建、管理 wasm filter，作用和流程有点像 docker 构建和管理容器。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 安装wasme</span>
curl -sL https://run.solo.io/wasme/install | sh
export PATH<span style="color:#f92672">=</span>$HOME/.wasme/bin:$PATH
<span style="color:#75715e"># 查看版本号</span>
wasme --version
</code></pre></div><p><strong>2、初始化filter项目</strong></p>
<p>创建一个新的filter项目：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wasme init ./new-filter
</code></pre></div><p>根据命令行的提示可以知道，现在只支持cpp、assemblyscript两种语言；可以选择部署到 Istio 或 Gloo 平台。这里我们选择cpp、istio选项，完成项目创建。</p>
<p><img src="envoy-wasm-2.png" alt=""></p>
<p>我们可以看一下生成的项目包括哪些文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># tree</span>
.
|-- bazel
|   <span style="color:#e6db74">`</span>-- external
|       |-- BUILD
|       |-- emscripten-toolchain.BUILD
|       <span style="color:#e6db74">`</span>-- envoy-wasm-api.BUILD
|-- BUILD
|-- filter.cc
|-- filter.proto
|-- README.md
|-- runtime-config.json
|-- toolchain
|   |-- BUILD
|   |-- cc_toolchain_config.bzl
|   |-- common.sh
|   |-- emar.sh
|   <span style="color:#e6db74">`</span>-- emcc.sh
<span style="color:#e6db74">`</span>-- WORKSPACE
 
<span style="color:#ae81ff">3</span> directories, <span style="color:#ae81ff">14</span> files
</code></pre></div><p>这些文件的作用分别为：</p>
<ul>
<li>BUILD：用于编译 filter 的 bazel 编译文件</li>
<li>WORKSPACE：用于编译 filter 的 bazel WORKSPACE 文件</li>
<li>bazel/：bazel 外部依赖</li>
<li>toolchain/：编译 WASM 模块的 bazel 工具链</li>
<li>filter.cc：filter 源代码，这里是C++语言</li>
<li>filter.proto：filter配置的 protobuf schema</li>
<li>runtime-config.json：和 filter 镜像共同存储的 config 文件，用于在运行时加载 filter</li>
</ul>
<p>这里重点关注 filter.cc 文件即可，里面定义了一组接口和实现，只需要对相关的方法进行修改，就可以实现自定义的filter。其他文件主要用于编译，可以看到这里也引入了 emscripten 工具链，用于编译成 wasm 字节码格式。</p>
<p><strong>3、修改和编译</strong></p>
<p>这里我们在响应头添加一组 header 信息，以验证 filter 功能是否符合预期。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">FilterHeadersStatus AddHeaderContext<span style="color:#f92672">::</span>onResponseHeaders(<span style="color:#66d9ef">uint32_t</span>) {
  LOG_DEBUG(std<span style="color:#f92672">::</span>string(<span style="color:#e6db74">&#34;onResponseHeaders &#34;</span>) <span style="color:#f92672">+</span> std<span style="color:#f92672">::</span>to_string(id()));
  addResponseHeader(root_<span style="color:#f92672">-&gt;</span>header_name_, root_<span style="color:#f92672">-&gt;</span>header_value_);
  replaceResponseHeader(<span style="color:#e6db74">&#34;location&#34;</span>, <span style="color:#e6db74">&#34;envoy-wasm&#34;</span>);
  addResponseHeader(<span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#e6db74">&#34;world!&#34;</span>);
  <span style="color:#66d9ef">return</span> FilterHeadersStatus<span style="color:#f92672">::</span>Continue;
}
</code></pre></div><p>接下来使用 wasme 命令编译 filter，这里会自动拉取quay.io/solo-io/ee-builder镜像完成编译过程，构建完成的filter镜像将会存储在本地的 registry中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wasme build cpp -t webassemblyhub.io/sunboy0213/add-header:v0.1 .
</code></pre></div><p>查看本地编译完成的filter镜像：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wasme list
NAME                                    TAG  SIZE   SHA      UPDATED
webassemblyhub.io/sunboy0213/add-header v0.1 1.0 MB 72ad74e2 <span style="color:#ae81ff">15</span> Apr <span style="color:#ae81ff">20</span> 11:03 CST
</code></pre></div><p>这里可以看一下我们最终编译生成的文件如下，目标文件 filter.wasm 只有 1021K，可以很方便的集成到 envoy 中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls store/41aabc92e1f91207d4b4e12385fd5bca/ -alh
total 1.1M
drwxr-xr-x <span style="color:#ae81ff">2</span> root root  4.0K Apr <span style="color:#ae81ff">15</span> 12:19 .
drwxr-xr-x <span style="color:#ae81ff">4</span> root root  4.0K Apr <span style="color:#ae81ff">15</span> 12:19 ..
-rw-r--r-- <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">226</span> Apr <span style="color:#ae81ff">15</span> 20:58 descriptor.json
-rw-r--r-- <span style="color:#ae81ff">1</span> root root 1021K Apr <span style="color:#ae81ff">15</span> 20:58 filter.wasm
-rw-r--r-- <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">44</span> Apr <span style="color:#ae81ff">15</span> 20:58 image_ref
-rw-r--r-- <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">128</span> Apr <span style="color:#ae81ff">15</span> 20:58 runtime-config.json
</code></pre></div><p><strong>4、推送到 WebAssembly hub</strong></p>
<p>这里需要首先注册https://webassemblyhub.io账号，然后将本地编译完成的镜像推送到远程仓库。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 登录账号</span>
wasme login -u $YOUR_USERNAME -p $YOUR_PASSWORD
<span style="color:#75715e"># 推送镜像</span>
wasme push webassemblyhub.io/sunboy0213/add-header:v0.1
<span style="color:#75715e"># 查找我的远程镜像</span>
wasme list --search $YOUR_USERNAME
</code></pre></div><p><strong>5、部署到istio集群</strong></p>
<p>这一步的前提是已经搭建了 Istio 运行环境，并部署好了 bookinfo 示例应用。测试服务间的访问连通性如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># kubectl exec -ti deploy/productpage-v1 -c istio-proxy -- curl -v http://details:9080/details/123</span>
*   Trying 172.18.233.86...
* TCP_NODELAY set
* Connected to details <span style="color:#f92672">(</span>172.18.233.86<span style="color:#f92672">)</span> port <span style="color:#ae81ff">9080</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
&gt; GET /details/123 HTTP/1.1
&gt; Host: details:9080
&gt; User-Agent: curl/7.58.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span style="color:#ae81ff">200</span> OK
&lt; content-type: application/json
&lt; server: istio-envoy
&lt; date: Thu, <span style="color:#ae81ff">23</span> Apr <span style="color:#ae81ff">2020</span> 09:16:53 GMT
&lt; content-length: <span style="color:#ae81ff">180</span>
&lt; x-envoy-upstream-service-time: <span style="color:#ae81ff">1</span>
&lt; x-envoy-peer-metadata: Ch4KDElOU1RBTkNFX0lQUxIOGgwxNzIuMTYuMC4yMDYK1QEKBkxBQkVMUxLKASrHAQoQCgNhcHASCRoHZGV0YWlscwohChFwb2QtdGVtcGxhdGUtaGFzaBIMGgo3NWQ5NGM0OGY1CiQKGXNlY3VyaXR5LmlzdGlvLmlvL3Rsc01vZGUSBxoFaXN0aW8KLAofc2VydmljZS5pc3Rpby5pby9jYW5vbmljYWwtbmFtZRIJGgdkZXRhaWxzCisKI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEgQaAnYxCg8KB3ZlcnNpb24SBBoCdjEKGgoHTUVTSF9JRBIPGg1jbHVzdGVyLmxvY2FsCiUKBE5BTUUSHRobZGV0YWlscy12MS03NWQ5NGM0OGY1LTdibHhtChYKCU5BTUVTUEFDRRIJGgdkZWZhdWx0Ck4KBU9XTkVSEkUaQ2t1YmVybmV0ZXM6Ly9hcGlzL2FwcHMvdjEvbmFtZXNwYWNlcy9kZWZhdWx0L2RlcGxveW1lbnRzL2RldGFpbHMtdjEKJQoPU0VSVklDRV9BQ0NPVU5UEhIaEGJvb2tpbmZvLWRldGFpbHMKHQoNV09SS0xPQURfTkFNRRIMGgpkZXRhaWxzLXYx
&lt; x-envoy-peer-metadata-id: sidecar~172.16.0.206~details-v1-75d94c48f5-7blxm.default~default.svc.cluster.local
&lt; x-envoy-decorator-operation: details.default.svc.cluster.local:9080/*
&lt;
* Connection <span style="color:#75715e">#0 to host details left intact</span>
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;id&#34;</span>:123,<span style="color:#e6db74">&#34;author&#34;</span>:<span style="color:#e6db74">&#34;William Shakespeare&#34;</span>,<span style="color:#e6db74">&#34;year&#34;</span>:1595,<span style="color:#e6db74">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;paperback&#34;</span>,<span style="color:#e6db74">&#34;pages&#34;</span>:200,<span style="color:#e6db74">&#34;publisher&#34;</span>:<span style="color:#e6db74">&#34;PublisherA&#34;</span>,<span style="color:#e6db74">&#34;language&#34;</span>:<span style="color:#e6db74">&#34;English&#34;</span>,<span style="color:#e6db74">&#34;ISBN-10&#34;</span>:<span style="color:#e6db74">&#34;1234567890&#34;</span>,<span style="color:#e6db74">&#34;ISBN-13&#34;</span>:<span style="color:#e6db74">&#34;123-1234567890&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p>部署我们刚才定制开发的filter：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wasme deploy istio webassemblyhub.io/sunboy0213/add-header:v0.1 --id<span style="color:#f92672">=</span>myfilter
</code></pre></div><p>再次访问，可以发现响应头已经增加了 &ldquo;hello: world!&rdquo; 键值对。注意：该部署过程会触发pod重建操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl exec -ti deploy/productpage-v1 -c istio-proxy -- curl -v http://details:9080/details/123
*   Trying 172.18.233.86...
* TCP_NODELAY set
* Connected to details <span style="color:#f92672">(</span>172.18.233.86<span style="color:#f92672">)</span> port <span style="color:#ae81ff">9080</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
&gt; GET /details/123 HTTP/1.1
&gt; Host: details:9080
&gt; User-Agent: curl/7.58.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span style="color:#ae81ff">200</span> OK
&lt; content-type: application/json
&lt; server: istio-envoy
&lt; date: Thu, <span style="color:#ae81ff">23</span> Apr <span style="color:#ae81ff">2020</span> 09:20:12 GMT
&lt; content-length: <span style="color:#ae81ff">180</span>
&lt; x-envoy-upstream-service-time: <span style="color:#ae81ff">2</span>
&lt; :
&lt; location: envoy-wasm
&lt; hello: world!
&lt; x-envoy-peer-metadata: Ch4KDElOU1RBTkNFX0lQUxIOGgwxNzIuMTYuMC4yMDgK1QEKBkxBQkVMUxLKASrHAQoQCgNhcHASCRoHZGV0YWlscwohChFwb2QtdGVtcGxhdGUtaGFzaBIMGgo3NzdkOGY1NDc1CiQKGXNlY3VyaXR5LmlzdGlvLmlvL3Rsc01vZGUSBxoFaXN0aW8KLAofc2VydmljZS5pc3Rpby5pby9jYW5vbmljYWwtbmFtZRIJGgdkZXRhaWxzCisKI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEgQaAnYxCg8KB3ZlcnNpb24SBBoCdjEKGgoHTUVTSF9JRBIPGg1jbHVzdGVyLmxvY2FsCiUKBE5BTUUSHRobZGV0YWlscy12MS03NzdkOGY1NDc1LWY0Z3c0ChYKCU5BTUVTUEFDRRIJGgdkZWZhdWx0Ck4KBU9XTkVSEkUaQ2t1YmVybmV0ZXM6Ly9hcGlzL2FwcHMvdjEvbmFtZXNwYWNlcy9kZWZhdWx0L2RlcGxveW1lbnRzL2RldGFpbHMtdjEKJQoPU0VSVklDRV9BQ0NPVU5UEhIaEGJvb2tpbmZvLWRldGFpbHMKHQoNV09SS0xPQURfTkFNRRIMGgpkZXRhaWxzLXYx
&lt; x-envoy-peer-metadata-id: sidecar~172.16.0.208~details-v1-777d8f5475-f4gw4.default~default.svc.cluster.local
&lt; x-envoy-decorator-operation: details.default.svc.cluster.local:9080/*
&lt;
* Connection <span style="color:#75715e">#0 to host details left intact</span>
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;id&#34;</span>:123,<span style="color:#e6db74">&#34;author&#34;</span>:<span style="color:#e6db74">&#34;William Shakespeare&#34;</span>,<span style="color:#e6db74">&#34;year&#34;</span>:1595,<span style="color:#e6db74">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;paperback&#34;</span>,<span style="color:#e6db74">&#34;pages&#34;</span>:200,<span style="color:#e6db74">&#34;publisher&#34;</span>:<span style="color:#e6db74">&#34;PublisherA&#34;</span>,<span style="color:#e6db74">&#34;language&#34;</span>:<span style="color:#e6db74">&#34;English&#34;</span>,<span style="color:#e6db74">&#34;ISBN-10&#34;</span>:<span style="color:#e6db74">&#34;1234567890&#34;</span>,<span style="color:#e6db74">&#34;ISBN-13&#34;</span>:<span style="color:#e6db74">&#34;123-1234567890&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p><strong>6、生产环境的部署</strong></p>
<p>前面我们使用的 wasme 命令行提供了一种编译、部署 wasm filter 的简单方式，可以方便的在开发和测试环境中使用，但该方式显然无法用于声明式、无状态的k8s生产环境中。</p>
<p>为此，官方推荐使用 Wasme Operator 管理 Service Mesh 集群中的 wasm filter。主要包括两个组件：</p>
<ul>
<li>镜像缓存：从 filter registry 拉取 filter 镜像，并缓存到本地，该组件以 DaemonSet 的形式进行部署；</li>
<li>operator：安装、配置 wasm filter 到数据面代理，以 Kubernetes Deployment 的形式部署。</li>
</ul>
<p>用户提交的 FilterDeployment 示例如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: wasme.io/v1
<span style="color:#66d9ef">kind</span>: FilterDeployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: bookinfo-custom-filter
  <span style="color:#66d9ef">namespace</span>: bookinfo
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">deployment</span>:
    <span style="color:#66d9ef">istio</span>:
      <span style="color:#66d9ef">kind</span>: Deployment
  <span style="color:#66d9ef">filter</span>:
    <span style="color:#66d9ef">config</span>: <span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;hello&#34;,&#34;value&#34;:&#34;world&#34;}&#39;</span>
    <span style="color:#66d9ef">image</span>: webassemblyhub.io/ilackarms/istio-test:<span style="color:#ae81ff">1.5.0-0</span>
</code></pre></div><h3 id="工作原理分析">工作原理分析</h3>
<p>刚才我们使用 wasme 命令行工具完成了 wasm filter 的构建、部署过程，其背后的工作原理简单描述如下：</p>
<ol>
<li>由 Wasme Operator 设置 wasm filter 的本地缓存信息，同时生成 EnvoyFilter 资源提交给k8s；</li>
<li>镜像缓存模块拉取需要的 wasm filter 到本地缓存中，该模块以 DaemonSet 的形式部署在集群节点中；</li>
<li>缓存模块拉取完成后，将 wasm 文件挂载到目标的workload中；</li>
<li>同时，Istiod 监测到 EnvoyFilter 变更，通过 xDS API 将 wasm 文件的信息下发到 envoy 代理。</li>
</ol>
<p><img src="envoy-wasm-3.png" alt=""></p>
<p>目前，WASM 扩展是通过 mount 机制来分发给对应的 workload，这种方式显然不够灵活，理想的方案是通过网络拉取 WASM 文件，完成实时加载。针对该问题，社区也正在积极优化。</p>
<p>结合前面的实践内容和原理分析，这里我们可以查看已经添加的 EnvoyFilter 资源。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>root@c-wfodwhfz-aaxyxwyz ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get envoyfilters.networking.istio.io</span>
NAME                      AGE
details-v1-myfilter       50m
productpage-v1-myfilter   50m
ratings-v1-myfilter       50m
reviews-v1-myfilter       50m
reviews-v2-myfilter       50m
reviews-v3-myfilter       50m
</code></pre></div><p>这里的 EnvoyFilter 是 Istio 提供的一种资源对象，用来更新配置 Envoy 中的 filter，为服务网格控制面提供了强大的扩展能力。可以详细看一下 productpage-v1-myfilter 的具体描述。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  creationTimestamp: <span style="color:#e6db74">&#34;2020-04-23T09:19:34Z&#34;</span>
  generation: <span style="color:#ae81ff">1</span>
  name: productpage-v1-myfilter
  namespace: default
  resourceVersion: <span style="color:#e6db74">&#34;9071122&#34;</span>
  selfLink: /apis/networking.istio.io/v1alpha3/namespaces/default/envoyfilters/productpage-v1-myfilter
  uid: b528b175-5e08-4b08-85ed-a324a2418a64
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.http_connection_manager
            subFilter:
              name: envoy.router
    patch:
      operation: INSERT_BEFORE
      value:
        config:
          config:
            name: myfilter
            rootId: add_header_root_id
            vmConfig:
              code:
                local:
                  filename: /var/local/lib/wasme-cache/72ad74e260c99fd77bbfd62f5dfab16af666dbdee8bacca39d97eafe60c69584
              runtime: envoy.wasm.runtime.v8
              vmId: myfilter
        name: envoy.filters.http.wasm
  workloadSelector:
    labels:
      app: productpage
      version: v1
</code></pre></div><p>该配置内容通过 xDS API 下发到 Envoy 代理之后，envoy 的运行时配置就会出现如下类型的 http filter，可以看到该 filter 指定了wasm文件的位置，并将wasm的运行时设置为v8引擎，从而实现了 wasm filter 的加载和运行。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
 <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.filters.http.wasm&#34;</span>,
 <span style="color:#f92672">&#34;config&#34;</span>: {
  <span style="color:#f92672">&#34;config&#34;</span>: {
   <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;myfilter&#34;</span>,
   <span style="color:#f92672">&#34;rootId&#34;</span>: <span style="color:#e6db74">&#34;add_header_root_id&#34;</span>,
   <span style="color:#f92672">&#34;vmConfig&#34;</span>: {
    <span style="color:#f92672">&#34;code&#34;</span>: {
     <span style="color:#f92672">&#34;local&#34;</span>: {
      <span style="color:#f92672">&#34;filename&#34;</span>: <span style="color:#e6db74">&#34;/var/local/lib/wasme-cache/72ad74e260c99fd77bbfd62f5dfab16af666dbdee8bacca39d97eafe60c69584&#34;</span>
     }
    },
    <span style="color:#f92672">&#34;runtime&#34;</span>: <span style="color:#e6db74">&#34;envoy.wasm.runtime.v8&#34;</span>,
    <span style="color:#f92672">&#34;vmId&#34;</span>: <span style="color:#e6db74">&#34;myfilter&#34;</span>
   }
  }
 }
}<span style="color:#960050;background-color:#1e0010">,</span>
</code></pre></div><h2 id="小结">小结</h2>
<p>本文首先介绍了 Envoy 的过滤器模型和 WASM 扩展技术，并结合 Solo 团队提供的 wasme 工具完成了 WASM 扩展的构建、部署过程，最后对背后的工作原理进行了分析。可以看到，使用 WASM 可以很方便的将自定义 filter 集成到 Envoy 中，实现 Envoy 代理的功能增强，同时我们也发现 envoy-wasm 仍然处于初步阶段，在支持的语言类型、运行性能、部署运维等方面仍然有待完善，相信在社区的不断努力下，WASM 技术能够走向成熟并应用于更多的使用场景中。</p>
<h2 id="参考">参考</h2>
<p><a href="https://istio.io/latest/zh/blog/2020/wasm-announce/">重新定义代理的扩展性：Envoy 和 Istio 引入 WebAssembly</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1548607">如何高效地编写Envoy过滤器！第1部分</a></p>
<p><a href="https://github.com/proxy-wasm/spec">WebAssembly for Proxies (ABI specification)</a></p>
<p><a href="https://istio.io/latest/blog/2020/deploy-wasm-declarative/">Declarative WebAssembly deployment for Istio</a></p>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/istio"> 
            Istio</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/envoy"> , 
            Envoy</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/wasm"> , 
            WASM</a>
            
          </ul>
        </div>
        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/istio-certificate/">一文带你彻底厘清 Isito 中的证书工作机制</a></li>
  
  </ul>
</div>


        <!-- comments -->
        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5 word-cloud">
    <h4 class="mb-4">标签</h4>
    
      
      
      
      
      
      
      
      
      
      
      
      <div id="tag-cloud" style="padding: 5px 15px">
      
        
          
          
          
          <a href="/tags/bpf" style="font-size:1rem">bpf</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cicd" style="font-size:1rem">cicd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/client-go" style="font-size:1.5rem">client-go</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cloud-native" style="font-size:1.25rem">cloud-native</a>
        
      
        
          
          
          &middot;
          <a href="/tags/crossplane" style="font-size:1rem">crossplane</a>
        
      
        
          
          
          &middot;
          <a href="/tags/envoy" style="font-size:1rem">envoy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/etcd" style="font-size:1rem">etcd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/flamegraph" style="font-size:1rem">flamegraph</a>
        
      
        
          
          
          &middot;
          <a href="/tags/informer" style="font-size:1.75rem">informer</a>
        
      
        
          
          
          &middot;
          <a href="/tags/istio" style="font-size:1.5rem">istio</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubebuilder" style="font-size:1rem">kubebuilder</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetes" style="font-size:1.75rem">kubernetes</a>
        
      
        
          
          
          &middot;
          <a href="/tags/linux%e5%86%85%e6%a0%b8" style="font-size:1rem">linux内核</a>
        
      
        
          
          
          &middot;
          <a href="/tags/microservices" style="font-size:1.25rem">microservices</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mosn" style="font-size:1rem">mosn</a>
        
      
        
          
          
          &middot;
          <a href="/tags/oam" style="font-size:1.25rem">oam</a>
        
      
        
          
          
          &middot;
          <a href="/tags/operator" style="font-size:1rem">operator</a>
        
      
        
          
          
          &middot;
          <a href="/tags/profile" style="font-size:1rem">profile</a>
        
      
        
          
          
          &middot;
          <a href="/tags/service-mesh" style="font-size:1rem">service-mesh</a>
        
      
        
          
          
          &middot;
          <a href="/tags/spring-cloud" style="font-size:1rem">spring-cloud</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tcpdump" style="font-size:1rem">tcpdump</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tekton" style="font-size:1rem">tekton</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vxlan" style="font-size:1rem">vxlan</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wasm" style="font-size:1rem">wasm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wireshark" style="font-size:1rem">wireshark</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zookeeper" style="font-size:1rem">zookeeper</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%ad%a6%e4%b9%a0%e5%b0%8f%e7%bb%84" style="font-size:1rem">学习小组</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%bc%80%e6%ba%90" style="font-size:1rem">开源</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" style="font-size:1rem">源码分析</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e7%90%86%e8%a7%a3" style="font-size:1.25rem">源码理解</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%a4%be%e5%8c%ba" style="font-size:1.25rem">社区</a>
        
      
      </div>
    
  </div>

  <!-- profile -->
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#envoy-的过滤器机制">Envoy 的过滤器机制</a>
      <ul>
        <li><a href="#过滤器机制">过滤器机制</a></li>
        <li><a href="#扩展方式">扩展方式</a></li>
      </ul>
    </li>
    <li><a href="#wasm-概述">WASM 概述</a>
      <ul>
        <li><a href="#介绍">介绍</a></li>
        <li><a href="#工具链">工具链</a></li>
      </ul>
    </li>
    <li><a href="#wasm与envoy和istio">WASM与Envoy和Istio</a>
      <ul>
        <li><a href="#istio-引入-webassembly">Istio 引入 WebAssembly</a></li>
        <li><a href="#wasme-实践">WASME 实践</a></li>
        <li><a href="#工作原理分析">工作原理分析</a></li>
      </ul>
    </li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="Cloud Native Community" width="60%"></a>
          <p class="text-light mb-5">云原生社区始于 2016 年成立的 Kubernetes &amp; CloudNative 实战群，覆盖了上千名早期云原生拥护者。在此基础上于 2020 年 5 月，由 CNCF 大使、开源领域意见领袖共同发起将原社群升级为云原生社区，旨在构建一个开放、包容的沟通环境，促进云原生技术的传播和普及。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativeto"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnativecommunity.slack.com"><i class="fa fa-slack"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="https://github.com/cloudnativeto/community/issues/56">北京</a>|<a href="https://github.com/cloudnativeto/community/issues/51">上海</a>|<a href="https://github.com/cloudnativeto/community/issues/58">成都</a>|<a href="https://github.com/cloudnativeto/community/issues/60">深圳</a>|<a href="https://github.com/cloudnativeto/community/issues/53">杭州</a>|<a href="https://github.com/cloudnativeto/community/issues/59">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="https://github.com/cloudnativeto/community/issues/57">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="https://github.com/cloudnativeto/community/issues/62">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="356px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2020 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/code-of-conduct"
                class="text-white">社区守则</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>

</body>

</html>
