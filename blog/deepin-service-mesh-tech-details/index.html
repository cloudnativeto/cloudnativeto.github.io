<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="在Kubernetes称为容器编排的标准之后，Service Mesh开始火了起来，但是很多文章讲概念的多，讲技术细节的少，所以专门写一篇文章，来解析Service Mesh背后的技术细节。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/deepin-service-mesh-tech-details/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/deepin-service-mesh-tech-details/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/deepin-service-mesh-tech-details/" />
  <meta property="og:title" content="深入解读Service Mesh背后的技术细节 | 云原生社区（中国）" />
  <meta property="og:description" content="在Kubernetes称为容器编排的标准之后，Service Mesh开始火了起来，但是很多文章讲概念的多，讲技术细节的少，所以专门写一篇文章，来解析Service Mesh背后的技术细节。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2018-05-23T16:09:57&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-08-07T11:22:51&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/deepin-service-mesh-tech-details/"
  },
  "headline": "深入解读Service Mesh背后的技术细节",
  
  "datePublished": "2018-05-23T16:09:57+08:00",
  "dateModified": "2023-08-07T11:22:51+08:00",
  
  "author": {
    "@type": "Person",
    "name": "刘超"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "在Kubernetes称为容器编排的标准之后，Service Mesh开始火了起来，但是很多文章讲概念的多，讲技术细节的少，所以专门写一篇文章，来解析Service Mesh背后的技术细节。"
}
</script>

  

  

  

  





  <title>深入解读Service Mesh背后的技术细节 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="e73aa5b1dddc4f8e580c152c7cde1f29" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>深入解读Service Mesh背后的技术细节</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E5%88%98%E8%B6%85/">刘超</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/service-mesh/" class="text-capitalize">service mesh</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2018-05-23
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 5273
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 24 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents"></nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents"></nav>
</details>

                    
                    <p>在Kubernetes称为容器编排的标准之后，Service Mesh开始火了起来，但是很多文章讲概念的多，讲技术细节的少，所以专门写一篇文章，来解析Service Mesh背后的技术细节。</p>
<p><strong>一、Service Mesh是Kubernetes支撑微服务能力拼图的最后一块</strong></p>
<p>在上一篇文章<a href="http://mp.weixin.qq.com/s?__biz=MzI1NzYzODk4OQ==&amp;mid=2247484871&amp;idx=1&amp;sn=4c40df039911e7ef7d355c1435271eb0&amp;chksm=ea1512e5dd629bf368bae145c6c42ad89f260c529d0eb006779768c6f124e0318b653d2d1821&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">为什么 kubernetes 天然适合微服务</a>中我们提到，Kubernetes是一个奇葩所在，他的组件复杂，概念复杂，在没有实施微服务之前，你可能会觉得为什么Kubernetes要设计的这么复杂，但是一旦你要实施微服务，你会发现Kubernetes中的所有概念，都是有用的。</p>
<p>















<figure  id="figure-微服务设计">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="微服务设计" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlc9gw4y0j30u00bm122_hu82087d4186d318616dce5ad14ea4f2d2_292918_08982cce642f5ea1ee6241f4ba0573a1.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlc9gw4y0j30u00bm122_hu82087d4186d318616dce5ad14ea4f2d2_292918_65c8dae5f94d43b7c38ac17d07672a14.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlc9gw4y0j30u00bm122_hu82087d4186d318616dce5ad14ea4f2d2_292918_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frlc9gw4y0j30u00bm122_hu82087d4186d318616dce5ad14ea4f2d2_292918_08982cce642f5ea1ee6241f4ba0573a1.webp"
               width="760"
               height="294"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      微服务设计
    </figcaption></figure>
</p>
<p>在我们微服务设计的十个要点中，我们会发现Kubernetes都能够有相应的组件和概念，提供相应的支持。</p>
<p>其中最后的一块拼图就是服务发现，与熔断限流降级。</p>
<p>众所周知，Kubernetes的服务发现是通过Service来实现的，服务之间的转发是通过kube-proxy下发iptables规则来实现的，这个只能实现最基本的服务发现和转发能力，不能满足高并发应用下的高级的服务特性，比较SpringCloud和Dubbo有一定的差距，于是Service Mesh诞生了，他期望讲熔断，限流，降级等特性，从应用层，下沉到基础设施层去实现，从而使得Kubernetes和容器全面接管微服务。</p>
<p><strong>二、以Istio为例讲述Service Mesh中的技术关键点</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle3moclsj30u00gmn2n_huc87ec88cdac7cdcae9d5792952577d1f_149157_269cf4dd8e440c18c35d4be57faab7fa.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle3moclsj30u00gmn2n_huc87ec88cdac7cdcae9d5792952577d1f_149157_d52f3cbdf146a9d30b41ff6a6d29781a.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle3moclsj30u00gmn2n_huc87ec88cdac7cdcae9d5792952577d1f_149157_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle3moclsj30u00gmn2n_huc87ec88cdac7cdcae9d5792952577d1f_149157_269cf4dd8e440c18c35d4be57faab7fa.webp"
               width="760"
               height="421"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>就如SDN一样，Service Mesh将服务请求的转发分为控制面和数据面，因而分析他，也是从数据面先分析转发的能力，然后再分析控制面如何下发命令。今天这篇文章重点讲述两个组件Envoy和Pilot</p>
<p><strong>一切从Envoy开始</strong></p>
<p>我们首先来看，如果没有融入Service Mesh，Envoy本身能够做什么事情呢？</p>
<p>Envoy是一个高性能的C++写的proxy转发器，那Envoy如何转发请求呢？需要定一些规则，然后按照这些规则进行转发。</p>
<p>规则可以是静态的，放在配置文件中的，启动的时候加载，要想重新加载，一般需要重新启动，但是Envoy支持热加载和热重启，一定程度上缓解了这个问题。</p>
<p>当然最好的方式是规则设置为动态的，放在统一的地方维护，这个统一的地方在Envoy眼中看来称为Discovery Service，过一段时间去这里拿一下配置，就修改了转发策略。</p>
<p>无论是静态的，还是动态的，在配置里面往往会配置四个东西。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle43cmthj30py0gignh_huc4259382e04afe819deb47f8803889aa_83642_3a92eedcb013bc454ca98068fc24fb4d.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle43cmthj30py0gignh_huc4259382e04afe819deb47f8803889aa_83642_d7c2a34959810eb9e82586a580acb158.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle43cmthj30py0gignh_huc4259382e04afe819deb47f8803889aa_83642_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle43cmthj30py0gignh_huc4259382e04afe819deb47f8803889aa_83642_3a92eedcb013bc454ca98068fc24fb4d.webp"
               width="760"
               height="483"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>一是listener，也即envoy既然是proxy，专门做转发，就得监听一个端口，接入请求，然后才能够根据策略转发，这个监听的端口称为listener</p>
<p>二是endpoint，是目标的ip地址和端口，这个是proxy最终将请求转发到的地方。</p>
<p>三是cluster，一个cluster是具有完全相同行为的多个endpoint，也即如果有三个容器在运行，就会有三个IP和端口，但是部署的是完全相同的三个服务，他们组成一个Cluster，从cluster到endpoint的过程称为负载均衡，可以轮询等。</p>
<p>四是route，有时候多个cluster具有类似的功能，但是是不同的版本号，可以通过route规则，选择将请求路由到某一个版本号，也即某一个cluster。</p>
<p>这四个的静态配置的例子如下：</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle4hlg1wj30u00kewn6_hue82a4afc7199b58c784e12b7090ecc80_199562_f69971b55abaded1b40faeed6f9c86f1.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle4hlg1wj30u00kewn6_hue82a4afc7199b58c784e12b7090ecc80_199562_efe4c94e2728b08dd5401d57de002a41.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle4hlg1wj30u00kewn6_hue82a4afc7199b58c784e12b7090ecc80_199562_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle4hlg1wj30u00kewn6_hue82a4afc7199b58c784e12b7090ecc80_199562_f69971b55abaded1b40faeed6f9c86f1.webp"
               width="760"
               height="517"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>如图所示，listener被配置为监听本地127.0.0.1的10000接口，route配置为某个url的前缀转发到哪个cluster，cluster里面配置负载均衡策略，hosts里面是所有的endpoint。</p>
<p>如果你想简单的将envoy使用起来，不用什么service mesh，一个进程，加上这个配置文件，就可以了，就能够转发请求了。</p>
<p>对于动态配置，也应该配置发现中心，也即Discovery Service，对于上述四种配置，各对应相应的DS，所以有LDS, RDS, CDS, EDS。</p>
<p>动态配置的例子如下：</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle4uy7ghj30u00onaie_hu9177881bfc384ab544612c10ee026252_181245_637c8f9f7b2f3905086ab8036acc0894.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle4uy7ghj30u00onaie_hu9177881bfc384ab544612c10ee026252_181245_3f99975b2310e06fee7409755398224c.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle4uy7ghj30u00onaie_hu9177881bfc384ab544612c10ee026252_181245_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle4uy7ghj30u00onaie_hu9177881bfc384ab544612c10ee026252_181245_637c8f9f7b2f3905086ab8036acc0894.webp"
               width="760"
               height="624"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p><strong>控制面Pilot的工作模式</strong></p>
<p>数据面envoy可以通过加装静态配置文件的方式运行，而动态信息，需要从Discovery Service去拿。</p>
<p>Discovery Service就是部署在控制面的，在istio中，是Pilot。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5drdsxj30u00l944h_hub3ad73a6409efe05a26b11f77f3bbf63_196377_0c479c367d8f83bd09cce7c9f94ea146.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5drdsxj30u00l944h_hub3ad73a6409efe05a26b11f77f3bbf63_196377_59a9d908c507b01f1a44a62d1aca53fb.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5drdsxj30u00l944h_hub3ad73a6409efe05a26b11f77f3bbf63_196377_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle5drdsxj30u00l944h_hub3ad73a6409efe05a26b11f77f3bbf63_196377_0c479c367d8f83bd09cce7c9f94ea146.webp"
               width="760"
               height="538"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>如图为Pilot的架构，最下面一层是envoy的API，就是提供Discovery Service的API，这个API的规则由envoy定，但不是Pilot调用Envoy，而是Envoy去主动调用Pilot的这个API。</p>
<p>Pilot最上面一层称为Platform Adapter，这一层是干什么的呢？这一层不是Kubernetes, Mesos调用Pilot，而是Pilot通过调用Kubernetes来发现服务之间的关系。</p>
<p>这是理解Istio比较绕的一个点。也即pilot使用Kubernetes的Service，仅仅使用它的服务发现功能，而不使用它的转发功能，pilot通过在kubernetes里面注册一个controller来监听事件，从而获取Service和Kubernetes的Endpoint以及Pod的关系，但是在转发层面，就不会再使用kube-proxy根据service下发的iptables规则进行转发了，而是将这些映射关系转换成为pilot自己的转发模型，下发到envoy进行转发，envoy不会使用kube-proxy的那些iptables规则。这样就把控制面和数据面彻底分离开来，服务之间的相互关系是管理面的事情，不要和真正的转发绑定在一起，而是绕到pilot后方。</p>
<p>Pilot另外一个对外的接口是Rules API，这是给管理员的接口，管理员通过这个接口设定一些规则，这些规则往往是应用于Routes, Clusters, Endpoints的，而都有哪些Clusters和Endpoints，是由Platform Adapter这面通过服务发现得到的。</p>
<p>自动发现的这些Clusters和Endpoints，外加管理员设置的规则，形成了Pilot的数据模型，其实就是他自己定义的一系列数据结构，然后通过envoy API暴露出去，等待envoy去拉取这些规则。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5pyxirj30t60tqgsg_hu4325c27290689e86afde846394a3b7b4_198370_b000c3472f6440383dd909c523162d6f.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5pyxirj30t60tqgsg_hu4325c27290689e86afde846394a3b7b4_198370_acdf893723130135741f48bc56741a15.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5pyxirj30t60tqgsg_hu4325c27290689e86afde846394a3b7b4_198370_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle5pyxirj30t60tqgsg_hu4325c27290689e86afde846394a3b7b4_198370_b000c3472f6440383dd909c523162d6f.webp"
               width="746"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>常见的一种人工规则是Routes，通过服务发现，Pilot可以从Kubernetes那里知道Service B有两个版本，一般是两个Deployment，属于同一个Service，管理员通过调用Pilot的Rules API，来设置两个版本之间的Route规则，一个占99%的流量，一个占1%的流量，这两方面信息形成Pilot的数据结构模型，然后通过Envoy API下发，Envoy就会根据这个规则设置转发策略了。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5xv31mj30u00ladlv_hudf3d7026bb70816bee87eb3897274d87_165640_0cd542bc3f39e3abd4e2a8031eaf8c48.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5xv31mj30u00ladlv_hudf3d7026bb70816bee87eb3897274d87_165640_9228101ae31d16e070f2f11487e63476.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle5xv31mj30u00ladlv_hudf3d7026bb70816bee87eb3897274d87_165640_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle5xv31mj30u00ladlv_hudf3d7026bb70816bee87eb3897274d87_165640_0cd542bc3f39e3abd4e2a8031eaf8c48.webp"
               width="760"
               height="539"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>另一个常用的场景就是负载均衡，Pilot通过Kubernetes的Service发现Service B包含一个Deployment，但是有三个副本，于是通过Envoy API下发规则，使得Envoy在这三个副本之间进行负载均衡，而非通过Kubernetes本身Service的负载均衡机制。</p>
<p>三、以Istio为例解析Service Mesh的技术细节</p>
<p>了解了Service Mesh的大概原理，接下来我们通过一个例子来解析其中的技术细节。</p>
<p>凡是试验过Istio的同学都应该尝试过下面这个BookInfo的例子，不很复杂，但是麻雀虽小五脏俱全。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle6640jlj30u00kgn3e_hubbf6dc24944d6444a29c3352a95b3f8a_189104_1baa88de745f6a1bbd1abe7d1ac7029a.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle6640jlj30u00kgn3e_hubbf6dc24944d6444a29c3352a95b3f8a_189104_ee5f3a5aeba648bfbe12d23f10b8fe0d.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle6640jlj30u00kgn3e_hubbf6dc24944d6444a29c3352a95b3f8a_189104_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle6640jlj30u00kgn3e_hubbf6dc24944d6444a29c3352a95b3f8a_189104_1baa88de745f6a1bbd1abe7d1ac7029a.webp"
               width="760"
               height="518"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>在这个例子中，我们重点关注ProductPage这个服务，对Reviews服务的调用，这里涉及到路由策略和负载均衡。</p>
<p><strong>Productpage就是个Python程序</strong></p>
<p>productpage是一个简单的用python写的提供restful API的程序。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle6n0fjej30u00p2tn6_hu5654d79a4c8c36a7ca0cec90c7ea38f2_307967_165c2486300abef2a30e7df6edd0483b.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle6n0fjej30u00p2tn6_hu5654d79a4c8c36a7ca0cec90c7ea38f2_307967_eed9bdf6757df4c71df6e2cad974ef19.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle6n0fjej30u00p2tn6_hu5654d79a4c8c36a7ca0cec90c7ea38f2_307967_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle6n0fjej30u00p2tn6_hu5654d79a4c8c36a7ca0cec90c7ea38f2_307967_165c2486300abef2a30e7df6edd0483b.webp"
               width="760"
               height="635"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>在里面定义了很多的route，来接收API请求，并做相应的操作。</p>
<p>在需要请求其他服务，例如reviews, ratings的时候，则需要向后方发起restful调用。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle78bzolj30j10lnwhz_hu3b9abf81d24f4cbcc8dae2c22ffc742f_109016_8ab1cea06a9a01ab67ca7b3e95613b15.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle78bzolj30j10lnwhz_hu3b9abf81d24f4cbcc8dae2c22ffc742f_109016_7f875f884e0c1d675966999f107a3325.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle78bzolj30j10lnwhz_hu3b9abf81d24f4cbcc8dae2c22ffc742f_109016_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle78bzolj30j10lnwhz_hu3b9abf81d24f4cbcc8dae2c22ffc742f_109016_8ab1cea06a9a01ab67ca7b3e95613b15.webp"
               width="668"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>从代码可以看出，productpage对于后端的调用，都是通过域名来的。</p>
<p>对于productpage这个程序来讲，他觉得很简单，通过这个域名就可以调用了，既不需要通过服务发现系统获取这个域名，也不需要关心转发，更意识不到自己是部署在kubernetes上的，是否用了service mesh，所以服务之间的通信完全交给了基础设施层。</p>
<p>通过Kubernetes编排productpage</p>
<p>有了productpage程序，接下来就是将他部署到kubernetes上，这里没有什么特殊的，用的就是kubernetes默认的编排文件。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7huccpj30u00hk452_huc896af9b7791f32322955c71c8686383_142667_3a22d8e60bd82775146c3b911019239b.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7huccpj30u00hk452_huc896af9b7791f32322955c71c8686383_142667_4a23b60bf46a600e336b608d69b7bbd2.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7huccpj30u00hk452_huc896af9b7791f32322955c71c8686383_142667_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle7huccpj30u00hk452_huc896af9b7791f32322955c71c8686383_142667_3a22d8e60bd82775146c3b911019239b.webp"
               width="760"
               height="445"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>首先定义了一个Deployment，使用bookinfo的容器镜像，然后定义一个Service，用于这个Deployment的服务发现。</p>
<p><strong>通过Kubernetes编排reviews</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7ojet2j30u00ftdkz_hu6ec75636d8b9435f82e92875ccaec6eb_101025_7cd96955800d6c63c484c43c15d99151.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7ojet2j30u00ftdkz_hu6ec75636d8b9435f82e92875ccaec6eb_101025_dab429e7cba15a6e334c22a3aa25cf81.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7ojet2j30u00ftdkz_hu6ec75636d8b9435f82e92875ccaec6eb_101025_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle7ojet2j30u00ftdkz_hu6ec75636d8b9435f82e92875ccaec6eb_101025_7cd96955800d6c63c484c43c15d99151.webp"
               width="760"
               height="400"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>这个稍微有些复杂，定义了三个Deployment，但是版本号分别为V1, V2, V3，但是label都是app: reviews。</p>
<p>最后定义了一个Service，对应的label是app: reviews，作为这三个Deployment的服务发现。</p>
<p><strong>istioctl对productpage进行定制化之一：嵌入proxy_init作为InitContainer</strong>到目前为止，一切正常，接下来就是见证奇迹的时刻，也即istio有个工具istioctl可以对于yaml文件进行定制化</p>
<p>定制化的第一项就是添加了一个initContainer，这种类型的container可以做一些初始化的工作后，成功退出，kubernetes不会保持他长期运行。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7tzrk3j30u00kijw8_hu3dd25cf68bd5e64aa703b16dda855e66_111492_2b067084a65b4772a2ea0f2fe6080eca.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7tzrk3j30u00kijw8_hu3dd25cf68bd5e64aa703b16dda855e66_111492_6bf2186aa388199534cc2ce7d26bcf0c.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7tzrk3j30u00kijw8_hu3dd25cf68bd5e64aa703b16dda855e66_111492_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle7tzrk3j30u00kijw8_hu3dd25cf68bd5e64aa703b16dda855e66_111492_2b067084a65b4772a2ea0f2fe6080eca.webp"
               width="760"
               height="519"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>在这个InitContainer里面做什么事情呢？</p>
<p>我们登录进去发现，在这个InitContainer里面运行了一个shell脚本。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7xxsqtj30u00bdgsi_hu23ac1d2e0b6e1947bcdf640af2bc4fa1_188723_a3712d4ac0e111f11a858a5ab9310e68.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7xxsqtj30u00bdgsi_hu23ac1d2e0b6e1947bcdf640af2bc4fa1_188723_48ccba6c0c1731882c327c3c37ded1b7.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle7xxsqtj30u00bdgsi_hu23ac1d2e0b6e1947bcdf640af2bc4fa1_188723_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle7xxsqtj30u00bdgsi_hu23ac1d2e0b6e1947bcdf640af2bc4fa1_188723_a3712d4ac0e111f11a858a5ab9310e68.webp"
               width="760"
               height="288"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>就是这个shell脚本在容器里面写入了大量的iptables规则。</p>
<p>首先定义的一条规则是ISTIO_REDIRECT转发链，这条链不分三七二十一，都将网络包转发给envoy的15000端口。</p>
<p>但是一开始这条链没有被挂到iptables默认的几条链中，所以不起作用。</p>
<p>接下来就是在PREROUTING规则中，使用这个转发链，从而进入容器的所有流量，都被先转发到envoy的15000端口。</p>
<p>envoy作为一个代理，已经被配置好了，将请求转发给productpage程序。</p>
<p>productpage程序接受到请求，会转向调用外部的reviews或者ratings，从上面的分析我们知道，productpage只是做普通的域名调用。</p>
<p>当productpage往后端进行调用的时候，就碰到了output链，这个链会使用转发链，将所有出容器的请求都转发到envoy的15000端口。</p>
<p>这样无论是入口的流量，还是出口的流量，全部用envoy做成了汉堡包。</p>
<p>envoy根据服务发现的配置，知道reviews或者ratings如何访问，于是做最终的对外调用。</p>
<p>这个时候iptables规则会对从envoy出去的流量做一个特殊处理，允许他发出去，不再使用上面的output规则。</p>
<p><strong>istioctl对productpage进行定制化之二：嵌入proxy容器作为sidecar</strong></p>
<p>istioctl做的第二项定制化是，嵌入proxy容器作为sidecar。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle8uebg9j30hr12448p_hua8e128fb4f8c776485d549962897e26e_234420_2f412d6ef91fefa35725d0f7be05597f.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle8uebg9j30hr12448p_hua8e128fb4f8c776485d549962897e26e_234420_03f03fcb426b67314d89fd554ea6eae9.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle8uebg9j30hr12448p_hua8e128fb4f8c776485d549962897e26e_234420_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle8uebg9j30hr12448p_hua8e128fb4f8c776485d549962897e26e_234420_2f412d6ef91fefa35725d0f7be05597f.webp"
               width="354"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>这个似乎看起来更加复杂，但是进入容器我们可以看到，启动了两个进程。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hlljbllj30u00bn41y_hu8db918909537edc2ab0c05ce66cf897e_125702_edc68d1683dada39c9e741db492911da.webp 400w,
               /blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hlljbllj30u00bn41y_hu8db918909537edc2ab0c05ce66cf897e_125702_5bf3989f05ca20568dbb9a69df802b35.webp 760w,
               /blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hlljbllj30u00bn41y_hu8db918909537edc2ab0c05ce66cf897e_125702_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hlljbllj30u00bn41y_hu8db918909537edc2ab0c05ce66cf897e_125702_edc68d1683dada39c9e741db492911da.webp"
               width="760"
               height="295"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>一个是我们熟悉的envoy，他有一个配置文件是/etc/istio/proxy/envoy-rev0.json</p>
<p>我们再前面讲述envoy的时候说过，有了配置文件，envoy就能够转发了，我们先来看看配置文件里面都有啥。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hluiu2xj30u00gcmzx_hu616d02d9e42e5cc1d5ba5cfc25dc6e73_101236_affd68ef2c0c10dc9e37531e1b4f9896.webp 400w,
               /blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hluiu2xj30u00gcmzx_hu616d02d9e42e5cc1d5ba5cfc25dc6e73_101236_9eb94afaf4c6f02dc343dd513a097c9b.webp 760w,
               /blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hluiu2xj30u00gcmzx_hu616d02d9e42e5cc1d5ba5cfc25dc6e73_101236_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/006tNc79gy1ft3hluiu2xj30u00gcmzx_hu616d02d9e42e5cc1d5ba5cfc25dc6e73_101236_affd68ef2c0c10dc9e37531e1b4f9896.webp"
               width="760"
               height="414"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>在这里面配置了envoy的管理端口，等一下我们会通过这个端口查看envoy被pilot下发了哪些转发策略。</p>
<p>然后就是动态资源，也即从各种discovery service去拿转发策略。</p>
<p>还有就是静态资源，也即静态配置的，需要重启才能加载的。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ch3yzj30u00gcte2_hu8a5dc2ff2aa5e7494acbc1efb28d6bbf_129815_40a7c06dc370ff9237fa0a9a2ed1e7ed.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ch3yzj30u00gcte2_hu8a5dc2ff2aa5e7494acbc1efb28d6bbf_129815_adf9bf05d900d1259acd340d49db0913.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ch3yzj30u00gcte2_hu8a5dc2ff2aa5e7494acbc1efb28d6bbf_129815_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ch3yzj30u00gcte2_hu8a5dc2ff2aa5e7494acbc1efb28d6bbf_129815_40a7c06dc370ff9237fa0a9a2ed1e7ed.webp"
               width="760"
               height="414"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>这就是pilot-agent的作用，他是envoy的一个简单的管理器，因为有些静态资源，如果TLS的证书，envoy还不支持动态下发，因而需要重新静态配置，然后pilot-agent负责将envoy进行热重启加载。</p>
<p>好在envoy有良好的热重启机制，重启的时候，会先启动一个备用进程，将转发的统计数据通过shared memory在两个进程间共享。</p>
<p><strong>深入解析pilot的工作机制</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ka5fnj30u00hytid_hu1437ec7815f7bfa6648e0a3d8089b545_218180_202043c358a170791f13d2a9f5edb477.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ka5fnj30u00hytid_hu1437ec7815f7bfa6648e0a3d8089b545_218180_d9e5320d7b620ff042d111770707a235.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ka5fnj30u00hytid_hu1437ec7815f7bfa6648e0a3d8089b545_218180_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle9ka5fnj30u00hytid_hu1437ec7815f7bfa6648e0a3d8089b545_218180_202043c358a170791f13d2a9f5edb477.webp"
               width="760"
               height="455"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Pilot的工作机制展开后如图所示。</p>
<p>istio config是管理员通过管理接口下发的转发规则。</p>
<p>Service Discovery模块对于Kubernetes来讲，就是创建了一个controller来监听Service创建和删除的事件，当service有变化时，会通知pilot，pilot会根据变化更新下发给envoy的规则。</p>
<p>pilot将管理员输入的转发策略配置和服务发现的当前状态，变成pilot自己的数据结构模型，然后暴露成envoy的api，由于是envoy来调用，因而要实现一个服务端，这里有lds, rds, cds, eds。</p>
<p>接下来我们看，在pilot上配置route之后会发生什么？</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9rqoj3j30qr0k1n0f_hu88ccfdc69d186c033af6ae8d3503f6fa_116853_c38dc898263a8d3874c773f488dee939.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9rqoj3j30qr0k1n0f_hu88ccfdc69d186c033af6ae8d3503f6fa_116853_5558b7167ed819620b4fd7cd07ad0944.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frle9rqoj3j30qr0k1n0f_hu88ccfdc69d186c033af6ae8d3503f6fa_116853_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frle9rqoj3j30qr0k1n0f_hu88ccfdc69d186c033af6ae8d3503f6fa_116853_c38dc898263a8d3874c773f488dee939.webp"
               width="760"
               height="569"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>如图，我们将所有的流量都发给版本1。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlea2rgpqj30u00gv7it_hucf273b33c687a2b6155f85281c75d0f7_279418_d4365ea36edeab18e7f5893303432c5b.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlea2rgpqj30u00gv7it_hucf273b33c687a2b6155f85281c75d0f7_279418_d37d57a7d4856ca25d2da979e109f9be.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlea2rgpqj30u00gv7it_hucf273b33c687a2b6155f85281c75d0f7_279418_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frlea2rgpqj30u00gv7it_hucf273b33c687a2b6155f85281c75d0f7_279418_d4365ea36edeab18e7f5893303432c5b.webp"
               width="760"
               height="427"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>我们查看envoy的管理端口，可以看到只配置了reviews的v1。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frleac3yuwj30u00fmadw_hubeb4580883eb6a68a5b985f679c7943b_85311_5afe36eecf06715506e4f1e408c2ac3b.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frleac3yuwj30u00fmadw_hubeb4580883eb6a68a5b985f679c7943b_85311_ad595c60f1db046e74cee2cc9011b6b4.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frleac3yuwj30u00fmadw_hubeb4580883eb6a68a5b985f679c7943b_85311_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frleac3yuwj30u00fmadw_hubeb4580883eb6a68a5b985f679c7943b_85311_5afe36eecf06715506e4f1e408c2ac3b.webp"
               width="760"
               height="395"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>当我们修改路由为v1和v3比例是五十比五十。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlealzahyj30u00mdqpx_hua11527eb990b2510ca12d8e908b2e290_430553_8b54d94b5d43eb40f92a240fda528145.webp 400w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlealzahyj30u00mdqpx_hua11527eb990b2510ca12d8e908b2e290_430553_0f175b779d7157860609a7290e953874.webp 760w,
               /blog/deepin-service-mesh-tech-details/00704eQkgy1frlealzahyj30u00mdqpx_hua11527eb990b2510ca12d8e908b2e290_430553_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/blog/deepin-service-mesh-tech-details/00704eQkgy1frlealzahyj30u00mdqpx_hua11527eb990b2510ca12d8e908b2e290_430553_8b54d94b5d43eb40f92a240fda528145.webp"
               width="760"
               height="566"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>可以看到envoy的管理端口，路由有了两个版本的配置，也对应后端的两个ip地址。</p>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/istio/">Istio</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E5%88%98%E8%B6%85/"><img class="avatar mr-3 avatar-circle" src="/author/%E5%88%98%E8%B6%85/avatar_hue38add62c87b7486d80c9f3fda25dfc1_12220_270x270_fill_q75_lanczos_center.jpg" alt="刘超"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E5%88%98%E8%B6%85/">刘超</a></p>
      
      <p class="card-text">腾讯</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/the-desigin-patterns-for-a-commercial-service-mesh/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>一个商用级Service Mesh服务的设计之道</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/istio-service-mesh-tutorial/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>Istio Service Mesh教程</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/deepin-service-mesh-tech-details/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/istio-gateway-api-beta/">Istio 扩展对 Gateway API 的支持</a></li>
      
      <li><a href="/blog/istio-traffic-management-series-service-management-concept-theory/">浅析 Istio——服务治理之概念和原理</a></li>
      
      <li><a href="/blog/istio-traffic-management-series-route-management/">浅析 Istio——流量治理之路由管理</a></li>
      
      <li><a href="/blog/validating-a-request-payload-with-wasm/">使用 WebAssembly 验证请求负载</a></li>
      
      <li><a href="/blog/resiliency-app-aware-network/">利用服务网格和智能应用感知网络增强应用弹性</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2023 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
