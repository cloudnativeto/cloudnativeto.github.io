<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="作为开源 Service Mesh 明星项目 Istio 背后的主要厂商，Google 也在其公有云上推出了 Service Mesh 管理服务。让人迷惑的是 Google Cloud 上有两个 Service Mesh 产品：Traffic Director 与 Anthos Service Mesh。Google 同时推出两个 Servcie Mesh 产品的原因是什么？这两个产品的定位有何不同？" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/google-cloud-mesh/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/google-cloud-mesh/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/google-cloud-mesh/" />
  <meta property="og:title" content="Google Cloud 服务网格：Traffic Director 与 Anthos Service Mesh 的左右互搏 | 云原生社区（中国）" />
  <meta property="og:description" content="作为开源 Service Mesh 明星项目 Istio 背后的主要厂商，Google 也在其公有云上推出了 Service Mesh 管理服务。让人迷惑的是 Google Cloud 上有两个 Service Mesh 产品：Traffic Director 与 Anthos Service Mesh。Google 同时推出两个 Servcie Mesh 产品的原因是什么？这两个产品的定位有何不同？" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2020-08-26T12:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-03-20T19:40:22&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/google-cloud-mesh/"
  },
  "headline": "Google Cloud 服务网格：Traffic Director 与 Anthos Service Mesh 的左右互搏",
  
  "datePublished": "2020-08-26T12:00:00+08:00",
  "dateModified": "2023-03-20T19:40:22+08:00",
  
  "author": {
    "@type": "Person",
    "name": "赵化冰"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "作为开源 Service Mesh 明星项目 Istio 背后的主要厂商，Google 也在其公有云上推出了 Service Mesh 管理服务。让人迷惑的是 Google Cloud 上有两个 Service Mesh 产品：Traffic Director 与 Anthos Service Mesh。Google 同时推出两个 Servcie Mesh 产品的原因是什么？这两个产品的定位有何不同？"
}
</script>

  

  

  

  





  <title>Google Cloud 服务网格：Traffic Director 与 Anthos Service Mesh 的左右互搏 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="fc94c62dc7f02e2f7b23a5324081b08c" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>Google Cloud 服务网格：Traffic Director 与 Anthos Service Mesh 的左右互搏</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E8%B5%B5%E5%8C%96%E5%86%B0/">赵化冰</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/service-mesh/" class="text-capitalize">service mesh</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2020-08-26
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 6314
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 29 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#traffic-director">Traffic Director</a>
      <ul>
        <li><a href="#traffic-director-架构">Traffic Director 架构</a></li>
        <li><a href="#服务注册发现机制">服务注册发现机制</a></li>
        <li><a href="#流量管理实现原理">流量管理实现原理</a></li>
        <li><a href="#sidecar-proxy-部署机制">Sidecar Proxy 部署机制</a></li>
        <li><a href="#vm和gke混合部署示例">VM和GKE混合部署示例</a></li>
      </ul>
    </li>
    <li><a href="#anthos-service-mesh">Anthos Service Mesh</a>
      <ul>
        <li><a href="#anthos-的整体架构">Anthos 的整体架构</a></li>
        <li><a href="#anthos-gke-集群管理">Anthos GKE 集群管理</a></li>
        <li><a href="#anthos-service-mesh-的混合云多云解决方案">Anthos Service Mesh 的混合云/多云解决方案</a></li>
        <li><a href="#anthos-service-mesh-多集群部署示例">Anthos Service Mesh 多集群部署示例</a></li>
      </ul>
    </li>
    <li><a href="#相互竞争还是优势互补">相互竞争还是优势互补？</a></li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#traffic-director">Traffic Director</a>
      <ul>
        <li><a href="#traffic-director-架构">Traffic Director 架构</a></li>
        <li><a href="#服务注册发现机制">服务注册发现机制</a></li>
        <li><a href="#流量管理实现原理">流量管理实现原理</a></li>
        <li><a href="#sidecar-proxy-部署机制">Sidecar Proxy 部署机制</a></li>
        <li><a href="#vm和gke混合部署示例">VM和GKE混合部署示例</a></li>
      </ul>
    </li>
    <li><a href="#anthos-service-mesh">Anthos Service Mesh</a>
      <ul>
        <li><a href="#anthos-的整体架构">Anthos 的整体架构</a></li>
        <li><a href="#anthos-gke-集群管理">Anthos GKE 集群管理</a></li>
        <li><a href="#anthos-service-mesh-的混合云多云解决方案">Anthos Service Mesh 的混合云/多云解决方案</a></li>
        <li><a href="#anthos-service-mesh-多集群部署示例">Anthos Service Mesh 多集群部署示例</a></li>
      </ul>
    </li>
    <li><a href="#相互竞争还是优势互补">相互竞争还是优势互补？</a></li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
</details>

                    
                    <p>作为开源 Service Mesh 明星项目 Istio 背后的主要厂商，Google 也在其公有云上推出了 Service Mesh 管理服务。让人迷惑的是 Google Cloud 上有两个 Service Mesh 产品：Traffic Director 与 Anthos Service Mesh。Google Cloud 首先在2019年3月发布了其第一个 Service Mesh 产品 Traffic Director，随后不久在2019 年9月紧接着发布了另一个 Service Mesh 产品 Anthos Service Mesh，随后两个产品独立并行发展，直到如今。</p>
<p>Google Cloud 同时推出两个 Service Mesh 产品的原因是什么？这两个产品的定位有何不同？本文将分别分析这两个产品的架构和功能，以试图解答该疑问。</p>
<h2 id="traffic-director">Traffic Director</h2>
<p>Traffic Director 是 Google Cloud 专为服务网格打造的全托管式流量控制平面，用户不需要对 Traffic Director 进行部署，维护和管理。我们可以把 Traffic Director 看作一个托管的 Pilot（备注：并不确定其内部是否使用的 Pilot），其只提供了流量管理能力，不提供 Istio 控制面的其他能力。用户可以使用 Traffic Director 创建跨区域的、同时支持集群和虚拟机实例的服务网格，并对多个集群和虚拟机的工作负载进行统一的流量控制。Traffic Director 托管控制面 提供了跨地域容灾能力，可以保证99.99%的SLA。</p>
<p>总而言之，Traffic Director 的关键特性包括：</p>
<ul>
<li>全托管控制面</li>
<li>控制面高可用</li>
<li>同时支持 K8s 集群和虚拟机</li>
<li>跨地域的流量管理</li>
</ul>
<h3 id="traffic-director-架构">Traffic Director 架构</h3>
<p>Traffic Director 的总体架构和 Istio 类似，也采用了“控制面 + 数据面”的结构，控制面托管在 Google Cloud 中，对用户不可见。用户只需要在创建 project 时启用 Traffic Director API，即可使用 Traffic Director 提供的网格服务。数据面则采用了和 Istio 相同的 Envoy 作为 proxy。 控制面和数据面采用标准的 xDS v2 进行通信。控制面对外采用了一套自定义的 API 来实现流量管理，并不支持 Istio API。Traffic Director 也没有采用 Istio/K8s 的服务发现，而是采用了一套 Google Cloud 自己的服务注册发现机制，该服务注册发现机制以统一的模型同时支持了容器和虚拟机上的服务，并为工作负载提供了健康检测。</p>
<p>Traffic Director 架构</p>
<p>















<figure  id="figure-traffic-director-架构">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Traffic Director 架构" srcset="
               /blog/google-cloud-mesh/traffic-director-arch_hu55545e668281c27a97a8d7f51e3befdb_120468_8f9ba3dd241b486fe62258060fd602fd.webp 400w,
               /blog/google-cloud-mesh/traffic-director-arch_hu55545e668281c27a97a8d7f51e3befdb_120468_abeabc3726ddd5ace6e29246420604e1.webp 760w,
               /blog/google-cloud-mesh/traffic-director-arch_hu55545e668281c27a97a8d7f51e3befdb_120468_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/traffic-director-arch_hu55545e668281c27a97a8d7f51e3befdb_120468_8f9ba3dd241b486fe62258060fd602fd.webp"
               width="760"
               height="373"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Traffic Director 架构
    </figcaption></figure>
</p>
<h3 id="服务注册发现机制">服务注册发现机制</h3>
<p>Traffic Director 采用了 Google Cloud 的一种称为 Backend Service 的服务注册机制。通过 Backend Service 支持了 GKE 集群中容器工作负载和虚拟机工作负载两种方式的服务注册发现，不过和 Istio 不同的是，Traffic Director 并不支持 K8s 原生的服务注册发现机制。</p>
<h4 id="服务注册发现资源模型">服务注册发现资源模型</h4>
<p>Traffic Director 的服务注册发现资源模型如下图所示，图中蓝色的图形为 Traffic Director 中使用的资源，桔色的图形为这些资源对应在 K8s 中的概念。Backend Service 是一个逻辑服务，可以看作 K8s 中的 Service，Backend Service 中可以包含 GKE 集群中的 NEG （Network Endpoint Group），GCE 虚拟机 的 MIG （Managed Instance Group），或者无服务的 NEG 。NEG 中则是具体的一个个工作负载，即服务实例。</p>
<p>Traffic Director 服务发现资源模型</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/traffic-director-service-discovery_hub5991621e549579e90fe91e46d29fffb_50585_5ab59c70cdec616e83ca1518d3162a8e.webp 400w,
               /blog/google-cloud-mesh/traffic-director-service-discovery_hub5991621e549579e90fe91e46d29fffb_50585_c1c64ee1dbe97bf95879300aeed15262.webp 760w,
               /blog/google-cloud-mesh/traffic-director-service-discovery_hub5991621e549579e90fe91e46d29fffb_50585_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/traffic-director-service-discovery_hub5991621e549579e90fe91e46d29fffb_50585_5ab59c70cdec616e83ca1518d3162a8e.webp"
               width="618"
               height="390"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Google Cloud 的这一套服务注册的机制并不只是为 Traffic Director 而定制的，还可以和 Google Cloud 上的各种负载均衡服务一起使用，作为负载均衡的后端。熟悉 K8s 的同学应该清楚，进入 K8s 集群的流量经过 Load Balancer 后会被首先发送到一个 node 的 nodeport 上，然后再通过 DNAT 转发到 Service 后端的一个 Pod IP 上。Google Cloud 在 cluster 上提供了一个 <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips" target="_blank" rel="noopener">VPC native</a> 的网络特性，可以在 VPC 中直接路由 Pod ，在打开 VPC native 特性的集群中，通过将 NEG 而不是 K8s service 放到 Load balancer 后端，可以跳过 Kubeproxy iptables 转发这一跳，直接将流量发送到 Pod，降低转发延迟，并可以应用更灵活的 LB 和路由算法。</p>
<p>虽然 Backend Service 已经支持了无服务 NEG，但目前 Traffic Director 还不支持，但从资源模型的角度来看，应该很容易扩展目前的功能，以将无服务工作负载加入到服务网格中。</p>
<p>下面举例说明如何创建 Backend Service，并将 GKE 和 VM 中运行的服务实例加入到 Backend Service中，以了解相关资源的内部结构。</p>
<h4 id="注册-gke-集群中的容器服务">注册 GKE 集群中的容器服务</h4>
<p>1、 创建 GKE NEG：在 K8s Service 的 yaml 定义中通过 annotation 创建 NEG</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/gke-neg-define_huce15e232ac3c6746a419aa97c9fd4dee_46586_179ef6e34543024a1b527783d2c8d573.webp 400w,
               /blog/google-cloud-mesh/gke-neg-define_huce15e232ac3c6746a419aa97c9fd4dee_46586_7e020326400bd3bc9de089037e3215f1.webp 760w,
               /blog/google-cloud-mesh/gke-neg-define_huce15e232ac3c6746a419aa97c9fd4dee_46586_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/gke-neg-define_huce15e232ac3c6746a419aa97c9fd4dee_46586_179ef6e34543024a1b527783d2c8d573.webp"
               width="608"
               height="609"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>2、 创建防火墙规则：需要创建一条防火墙规则，以允许 gcloud 对 GKE NEG 中的服务实例进行健康检查</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute firewall-rules create fw-allow-health-checks <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --action ALLOW <span class="se">\ </span>   
</span></span><span class="line"><span class="cl">  --direction INGRESS <span class="se">\ </span>   
</span></span><span class="line"><span class="cl">  --source-ranges 35.191.0.0/16,130.211.0.0/22 <span class="se">\ </span>   
</span></span><span class="line"><span class="cl">  --rules tcp
</span></span></code></pre></div><p>3、创建健康检查</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute health-checks create http td-gke-health-check <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --use-serving-port
</span></span></code></pre></div><p>4、创建 Backend Service，创建时需要指定上一步创建的健康检查</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute backend-services create td-gke-service <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --global <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --health-checks td-gke-health-check <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --load-balancing-scheme INTERNAL_SELF_MANAGED
</span></span></code></pre></div><p>5、将 GKE NEG 加入到上一步创建的 Backend service 中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">NEG_NAME</span><span class="o">=</span><span class="k">$(</span>gcloud beta compute network-endpoint-groups list <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="p">|</span> grep service-test <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">gcloud compute backend-services add-backend td-gke-service <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --global <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --network-endpoint-group <span class="si">${</span><span class="nv">NEG_NAME</span><span class="si">}</span> <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --network-endpoint-group-zone us-central1-a <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --balancing-mode RATE <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --max-rate-per-endpoint <span class="m">5</span>
</span></span></code></pre></div><h4 id="注册-gce-虚拟机服务">注册 GCE 虚拟机服务</h4>
<p>1、 创建虚机模版：在创建模版时可以通过命令参数 &ndash;service-proxy=enabled 声明使用该模版创建的虚拟机需要安装 Envoy sidecar 代理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud beta compute instance-templates create td-vm-template-auto <span class="se">\ </span>   
</span></span><span class="line"><span class="cl">  --service-proxy<span class="o">=</span>enabled
</span></span></code></pre></div><p>2、 创建 MIG：使用虚拟机模版创建一个 managed instance group，该 group 中的实例数为2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute instance-groups managed create td-vm-mig-us-central1 <span class="se">\ </span>   
</span></span><span class="line"><span class="cl">  --zone us-central1-a 
</span></span><span class="line"><span class="cl">  --size<span class="o">=</span><span class="m">2</span> 
</span></span><span class="line"><span class="cl">  --template<span class="o">=</span>td-vm-template-auto
</span></span></code></pre></div><p>3、 创建防火墙规则</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute firewall-rules create fw-allow-health-checks <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --action ALLOW <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --direction INGRESS <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --source-ranges 35.191.0.0/16,130.211.0.0/22 <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --target-tags td-http-server <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --rules tcp:80
</span></span></code></pre></div><p>4、 创建健康检查</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute health-checks create http td-vm-health-check
</span></span></code></pre></div><p>5、 创建 Backend Service，创建时需要指定上一步创建的健康检查</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute backend-services create td-vm-service <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --global <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --load-balancing-scheme<span class="o">=</span>INTERNAL_SELF_MANAGED <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --connection-draining-timeout<span class="o">=</span>30s <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --health-checks td-vm-health-check
</span></span></code></pre></div><p>6、 将 MIG 加入到上一步创建的 Backend service 中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud compute backend-services add-backend td-vm-service <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --instance-group td-demo-hello-world-mig <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --instance-group-zone us-central1-a <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --global
</span></span></code></pre></div><h3 id="流量管理实现原理">流量管理实现原理</h3>
<p>Traffic Diretor 的主要功能就是跨地域的全局流量管理能力，该能力是建立在 Google Cloud 强大的 VPC 机制基础上的， Google Cloud 的 VPC 可以跨越多个 Region，因此一个 VPC 中的服务网格中可以有来自多个 Region 的服务。另外 Traffic Director 并未直接采用 Istio 的 API，而是自定义了一套 API 来对网格中的流量进行管理。</p>
<h4 id="控制面流量规则定义">控制面流量规则定义</h4>
<p>Traffic Director 流量规则相关的控制面资源模型如下图所示，图中下半部分是 Istio 中和这些资源对应的 CRD。</p>
<ul>
<li>Forwarding Rule：定义服务的入口 VIP 和 Port。</li>
<li>Target Proxy：用于关联 Forwarding Rule 和 URL Map，可以看作网格中代理的一个资源抽象。</li>
<li>URL Map：用于设置路由规则，包括规则匹配条件和规则动作两部分。匹配条件支持按照 HTTP 的 Host、Path、Header进行匹配。匹配后可以执行 Traffic Splitting、Redirects、URL Rewrites、Traffic Mirroring、Fault Injection、Header Transformation 等动作。</li>
<li>Backend Service：前面在服务发现中已经介绍了 Backend Service 用于服务发现，其实还可以在 Backen Service 上设置流量策略，包括LB策略，断路器配置，实例离线检测等。可以看到 Backend Service 在 Traffic Director 的流量管理模型中同时承担了 Istio 中的 ServiceEntry 和 Destionation Rule 两个资源等功能。</li>
</ul>
<p>客户端直接通过 VIP 访问服务其实是一个不太友好的方式，因此我们还需要通过一个 DNS 服务将 Forwarding Rule 中的 VIP 和一个 DNS record 关联起来，在 Google Cloud 中可以采用 <a href="https://cloud.google.com/dns/" target="_blank" rel="noopener">Cloud DNS</a> 来将 Forwarding Rule 的 VIP 关联到一个内部的全局 DNS 名称上。</p>
<p>Traffic Director 流量管理资源模型</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/traffic-managemetn-resources_hu0550bdb77ad62134a95ee86055926a1e_118610_d707113ac9406e3ceced0ecb37fc8de2.webp 400w,
               /blog/google-cloud-mesh/traffic-managemetn-resources_hu0550bdb77ad62134a95ee86055926a1e_118610_3faca048936789c81b3f7f257969341c.webp 760w,
               /blog/google-cloud-mesh/traffic-managemetn-resources_hu0550bdb77ad62134a95ee86055926a1e_118610_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/traffic-managemetn-resources_hu0550bdb77ad62134a95ee86055926a1e_118610_d707113ac9406e3ceced0ecb37fc8de2.webp"
               width="760"
               height="365"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>下面举例说明这些资源的定义，以及它们是如何相互作用，以实现Service Mesh中的流量管理。</p>
<p>下图中的forwarding rule定义了一个暴露在 10.0.0.1:80 上的服务，该服务对应的url map 定义了两条路由规则，对应的主机名分别为 * 和 hello-worold，请求将被路由到后端的 td-vm-service backend service 中的服务实例。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/traffic-managemetn-resources-example_hue7b04f48e08b3c3acd8a57f654c9c9f1_23761_2f0938f7e4814f5c5fc7bf683678df7a.webp 400w,
               /blog/google-cloud-mesh/traffic-managemetn-resources-example_hue7b04f48e08b3c3acd8a57f654c9c9f1_23761_59bf72ce18106922dbcae7165969d1e9.webp 760w,
               /blog/google-cloud-mesh/traffic-managemetn-resources-example_hue7b04f48e08b3c3acd8a57f654c9c9f1_23761_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/traffic-managemetn-resources-example_hue7b04f48e08b3c3acd8a57f654c9c9f1_23761_2f0938f7e4814f5c5fc7bf683678df7a.webp"
               width="687"
               height="348"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Forwarding Rule 定义</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/forwarding-rule_huc27f73109a06293a69b705fd1048915c_47427_083c7f5749f58450b1f4846ce6b30781.webp 400w,
               /blog/google-cloud-mesh/forwarding-rule_huc27f73109a06293a69b705fd1048915c_47427_c00e00c79b5105f78a8c760516f546e0.webp 760w,
               /blog/google-cloud-mesh/forwarding-rule_huc27f73109a06293a69b705fd1048915c_47427_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/forwarding-rule_huc27f73109a06293a69b705fd1048915c_47427_083c7f5749f58450b1f4846ce6b30781.webp"
               width="760"
               height="185"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Target Proxy 定义</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/target-proxy_hueadf7133c9ed5fbcf9628e0e8c7c287c_12153_bc726449940eb7f543ec5d9cd66281dd.webp 400w,
               /blog/google-cloud-mesh/target-proxy_hueadf7133c9ed5fbcf9628e0e8c7c287c_12153_91721d713db6c588c5fc26c91445f31a.webp 760w,
               /blog/google-cloud-mesh/target-proxy_hueadf7133c9ed5fbcf9628e0e8c7c287c_12153_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/target-proxy_hueadf7133c9ed5fbcf9628e0e8c7c287c_12153_bc726449940eb7f543ec5d9cd66281dd.webp"
               width="760"
               height="84"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>URL Map 定义</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/url-map_hu4a391bf6dd67a9aad40e4cb7139d34f4_43013_8a8151bf2988cf172ebd17bb93575d0f.webp 400w,
               /blog/google-cloud-mesh/url-map_hu4a391bf6dd67a9aad40e4cb7139d34f4_43013_56a38410b288aa75fefe0555e8d12829.webp 760w,
               /blog/google-cloud-mesh/url-map_hu4a391bf6dd67a9aad40e4cb7139d34f4_43013_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/url-map_hu4a391bf6dd67a9aad40e4cb7139d34f4_43013_8a8151bf2988cf172ebd17bb93575d0f.webp"
               width="760"
               height="219"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Backend Service 定义</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/backend-service_hu61e5bce5af87baa090d40878943299bd_55482_95dac655daca7f628de569731ef05c88.webp 400w,
               /blog/google-cloud-mesh/backend-service_hu61e5bce5af87baa090d40878943299bd_55482_e961f5cccce8f1a24c54cd9421791ac1.webp 760w,
               /blog/google-cloud-mesh/backend-service_hu61e5bce5af87baa090d40878943299bd_55482_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/backend-service_hu61e5bce5af87baa090d40878943299bd_55482_95dac655daca7f628de569731ef05c88.webp"
               width="760"
               height="257"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Managed Instance Group 定义</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/mig_hu1575ad643bb11e0f42dafc2767bbfd27_35307_bf9170e734b9fb97365ee2ff550f95ff.webp 400w,
               /blog/google-cloud-mesh/mig_hu1575ad643bb11e0f42dafc2767bbfd27_35307_07b4245e4fd21221ebc2a9a925e259cc.webp 760w,
               /blog/google-cloud-mesh/mig_hu1575ad643bb11e0f42dafc2767bbfd27_35307_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/mig_hu1575ad643bb11e0f42dafc2767bbfd27_35307_bf9170e734b9fb97365ee2ff550f95ff.webp"
               width="760"
               height="415"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h4 id="数据面-sidecar-配置">数据面 Sidecar 配置</h4>
<p>Traffic Director 将服务发现信息和路由规则转换为 Envoy 配置，通过 xDS 下发到 Envoy sidecar，控制面规则和数据面配置的对应关系下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Forwarding Rule    -&gt;    Envoy Listener
</span></span><span class="line"><span class="cl">URL Map            -&gt;    Envoy Route
</span></span><span class="line"><span class="cl">Backend Service    -&gt;    Envoy Cluster
</span></span><span class="line"><span class="cl">NEG/MIG            -&gt;    Envoy endpoint
</span></span></code></pre></div><p>Listener 配置</p>
<p>Listener 中的 Http Connection Manager filter 配置定义了 IP+Port 层面的入口，这里只接受 Forwarding Rule 中指定的 VIP 10.0.0.1。我们也可以在 Forwarding Rule 中将 VIP 设置为 0.0.0.0，这样的话任何目的 IP 的请求都可以处理。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/envoy-listener_hu3264693b5b9bc0b0ba7fb919484126ae_33461_3627b158557ad7f466c6ab319b877fcb.webp 400w,
               /blog/google-cloud-mesh/envoy-listener_hu3264693b5b9bc0b0ba7fb919484126ae_33461_b77875951799d36f2b361afc0ab773c2.webp 760w,
               /blog/google-cloud-mesh/envoy-listener_hu3264693b5b9bc0b0ba7fb919484126ae_33461_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/envoy-listener_hu3264693b5b9bc0b0ba7fb919484126ae_33461_3627b158557ad7f466c6ab319b877fcb.webp"
               width="760"
               height="278"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Route 配置</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/envoy-route_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_ddb7cc96b4be5e45bffbc2edaf4e46ec.webp 400w,
               /blog/google-cloud-mesh/envoy-route_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_c6ad41b97dedbb2ce6ada3d77774237a.webp 760w,
               /blog/google-cloud-mesh/envoy-route_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/envoy-route_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_ddb7cc96b4be5e45bffbc2edaf4e46ec.webp"
               width="661"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Cluster 配置</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/envoy-cluster_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_c5c7c9fc07da83a720150cf57a82dc98.webp 400w,
               /blog/google-cloud-mesh/envoy-cluster_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_6cac08245a26d7fc00fb72a9f7ea4241.webp 760w,
               /blog/google-cloud-mesh/envoy-cluster_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/envoy-cluster_hu27d9b8dbbdb9ee8bd62bbe1120cebe18_84483_c5c7c9fc07da83a720150cf57a82dc98.webp"
               width="661"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h4 id="高级流量规则">高级流量规则</h4>
<p>在 URL Map 中设置 Traffic Splitting</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostRules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pathMatcher</span><span class="p">:</span><span class="w"> </span><span class="l">matcher1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pathMatchers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">defaultService</span><span class="p">:</span><span class="w"> </span><span class="l">global/backendServices/review1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">matcher1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">routeRules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchRules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">prefixMatch</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">routeAction</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">weightedBackendServices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span>- <span class="nt">backendService</span><span class="p">:</span><span class="w"> </span><span class="l">global/backendServices/review1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">95</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span>- <span class="nt">backendService</span><span class="p">:</span><span class="w"> </span><span class="l">global/backendServices/review2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span></code></pre></div><p>在 Backend Service 中设置 Circuit Breaker</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w"> </span><span class="nt">affinityCookieTtlSec</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">backends</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span>- <span class="nt">balancingMode</span><span class="p">:</span><span class="w"> </span><span class="l">UTILIZATION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">capacityScaler</span><span class="p">:</span><span class="w"> </span><span class="m">1.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">group:https://www.googleapis.com/compute/v1/projects/&lt;var&gt;PROJECT_ID&lt;/var&gt;/zones/&lt;var&gt;ZONE&lt;/var&gt;/instanceGroups/&lt;var&gt;INSTANCE_GROUP_NAME&lt;/var&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">maxUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">circuitBreakers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">maxConnections</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">maxPendingRequests</span><span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">maxRequests</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">maxRequestsPerConnection</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">maxRetries</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">connectionDraining</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">drainingTimeoutSec</span><span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">healthChecks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="l">https://www.googleapis.com/compute/v1/projects/&lt;var&gt;PROJECT_ID&lt;/var&gt;/global/healthChecks/&lt;var&gt;HEALTH_CHECK_NAME&lt;/var&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">loadBalancingScheme</span><span class="p">:</span><span class="w"> </span><span class="l">INTERNAL_SELF_MANAGED</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">localityLbPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ROUND_ROBIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;var&gt;BACKEND_SERVICE_NAME&lt;/var&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">portName</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l">NONE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">timeoutSec</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span></code></pre></div><p>从这两个规则的定义可以看出，虽然文件结构有所差异，但实际上 Traffic Director yaml 路由规则的定义和 Istio 非常相似。</p>
<p>与 Istio 相比，Traffic Director 的流量管理机制更为灵活，可以在 Mesh 中同时接入 K8s 集群和虚拟机中的工作负载。但 Traffic Director 需要手动进行较多的配置才能对服务进行管理，包括 backend service，forwarding rule，url map 和 DNS，而在 Istio 中，如果不需要进行特殊的路由和流量策略，这些配置都是不需要手动进行的，pilot 会自动创建默认配置。</p>
<h3 id="sidecar-proxy-部署机制">Sidecar Proxy 部署机制</h3>
<p>Traffic Director 数据面采用了和 Istio 相同的机制，通过 Iptables 规则将应用服务的出入流量重定向到 Envoy sidecar，由 Envoy 进行流量路由。Traffic Director 采用了下面的方式来在 K8s 集群的 Pod 或者虚拟机中安装数据面组件。</p>
<h4 id="vm-手动部署">VM 手动部署</h4>
<p>通过脚本从 gcloud 上下载 envoy 二机制，并安装 iptables 流量拦截规则，启动envoy。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Add a system user to run Envoy binaries. Login is disabled for this user</span>
</span></span><span class="line"><span class="cl">sudo adduser --system --disabled-login envoy
</span></span><span class="line"><span class="cl"><span class="c1"># Download and extract the Traffic Director tar.gz file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 下载traffic director相关文件</span>
</span></span><span class="line"><span class="cl">sudo wget -P /home/envoy https://storage.googleapis.com/traffic-director/traffic-director.tar.gz
</span></span><span class="line"><span class="cl">sudo tar -xzf /home/envoy/traffic-director.tar.gz -C /home/envoy
</span></span><span class="line"><span class="cl"><span class="c1">#下载 Envoy 的初始化配置，配置中包含了控制面traffic director的地址</span>
</span></span><span class="line"><span class="cl">sudo wget -O - https://storage.googleapis.com/traffic-director/demo/observability/envoy_stackdriver_trace_config.yaml &gt;&gt; /home/envoy/traffic-director/bootstrap_template.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># 设置iptables流量拦截规则的相关参数</span>
</span></span><span class="line"><span class="cl">sudo cat <span class="s">&lt;&lt; END &gt; /home/envoy/traffic-director/sidecar.env
</span></span></span><span class="line"><span class="cl"><span class="s">ENVOY_USER=envoy
</span></span></span><span class="line"><span class="cl"><span class="s"># Exclude the proxy user from redirection so that traffic doesn&#39;t loop back
</span></span></span><span class="line"><span class="cl"><span class="s"># to the proxy
</span></span></span><span class="line"><span class="cl"><span class="s">EXCLUDE_ENVOY_USER_FROM_INTERCEPT=&#39;true&#39;
</span></span></span><span class="line"><span class="cl"><span class="s"># Intercept all traffic by default
</span></span></span><span class="line"><span class="cl"><span class="s">SERVICE_CIDR=&#39;10.10.10.0/24&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">GCP_PROJECT_NUMBER=&#39;${GCP_PROJECT_NUMBER}&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">VPC_NETWORK_NAME=&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">ENVOY_PORT=&#39;15001&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">ENVOY_ADMIN_PORT=&#39;15000&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">LOG_DIR=&#39;/var/log/envoy/&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">LOG_LEVEL=&#39;info&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">XDS_SERVER_CERT=&#39;/etc/ssl/certs/ca-certificates.crt&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">TRACING_ENABLED=&#39;true&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">ACCESSLOG_PATH=&#39;/var/log/envoy/access.log&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">END</span>
</span></span><span class="line"><span class="cl">sudo apt-get update -y
</span></span><span class="line"><span class="cl">sudo apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common -y
</span></span><span class="line"><span class="cl">sudo curl -fsSL https://download.docker.com/linux/debian/gpg <span class="p">|</span> sudo apt-key add -
</span></span><span class="line"><span class="cl">sudo add-apt-repository <span class="s1">&#39;deb [arch=amd64] https://download.docker.com/linux/debian stretch stable&#39;</span> -y
</span></span><span class="line"><span class="cl">sudo apt-get update -y
</span></span><span class="line"><span class="cl">sudo apt-get install docker-ce -y
</span></span><span class="line"><span class="cl"><span class="c1">#下载envoy二机制</span>
</span></span><span class="line"><span class="cl">sudo /home/envoy/traffic-director/pull_envoy.sh
</span></span><span class="line"><span class="cl"><span class="c1">#设置iptables规则，启动envoy</span>
</span></span><span class="line"><span class="cl">sudo /home/envoy/traffic-director/run.sh start<span class="s2">&#34;
</span></span></span></code></pre></div><h4 id="vm-自动部署">VM 自动部署</h4>
<p>在创建虚拟机模版时添加注入proxy的参数，可以在VM中自动部署Envoy sidecar。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud beta compute instance-templates create td-vm-template-auto <span class="se">\ </span>   
</span></span><span class="line"><span class="cl">--service-proxy<span class="o">=</span>enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gcloud compute instance-groups managed create td-vm-mig-us-central1 <span class="se">\ </span>   
</span></span><span class="line"><span class="cl">--zone us-central1-a --size<span class="o">=</span><span class="m">2</span> --template<span class="o">=</span>td-vm-template-auto
</span></span></code></pre></div><h4 id="gke-通过-deployment-部署">GKE 通过 deployment 部署</h4>
<p>GKE 提供 yaml 模版，需要修改 deployment 文件，在 yaml 中增加 sidecar 相关的镜像。未提供 webhook,参见 Traffic Director 的<a href="https://storage.googleapis.com/traffic-director/trafficdirector_istio_sidecar.yaml" target="_blank" rel="noopener">示例文件</a>。</p>
<h3 id="vm和gke混合部署示例">VM和GKE混合部署示例</h3>
<p>下面我们创建一个示例程序，将 V 和 GKE 中的服务同时加入到 traffic director 管理的 service mesh 中，以展示 traffic director 的对 VM 和容器服务流量统一管理能力。
该程序的组成如下图所示。程序中部署了三个服务，在 us-central1-a 中部署了两个 VM MIG 服务，在 us-west1-a 中部署了一个 GKE NEG 服务，这三个服务处于同一个 VPC 中，因此网络是互通的。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/traffic-director-example_hu3f712a5e99bc2dcae0b04eb6414eba0a_79868_ac55cc819274f627af931f469d110fdb.webp 400w,
               /blog/google-cloud-mesh/traffic-director-example_hu3f712a5e99bc2dcae0b04eb6414eba0a_79868_3b89d148ededed317ef6aaba6bed536f.webp 760w,
               /blog/google-cloud-mesh/traffic-director-example_hu3f712a5e99bc2dcae0b04eb6414eba0a_79868_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/traffic-director-example_hu3f712a5e99bc2dcae0b04eb6414eba0a_79868_ac55cc819274f627af931f469d110fdb.webp"
               width="760"
               height="507"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>通过 us-central1-a region 上的客户端向三个服务分别发送请求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> Access service in VM managed instance group td-demo-hello-world-mig
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..4<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    curl http://10.0.0.1
</span></span><span class="line"><span class="cl">    sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> Access service in VM managed instance group td-observability-service-vm-mig 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..4<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    curl http://10.10.10.10
</span></span><span class="line"><span class="cl">    sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> Access service in GKE network endpoint group k8s1-e403ff53-default-service-test-80-e849f707 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..4<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    curl http://10.0.0.2
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">    sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>服务端会在请求响应消息中打印自身的 host name。我们从客户端循环访问三个服务，从命令结果可见每次的输出是不同的，这是因为 envoy 会通过缺省 lb 算法将请求分发到不同的服务实例上。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Access service in VM managed instance group td-demo-hello-world-mig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-demo-hello-world-mig-ccx4&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-demo-hello-world-mig-658w&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-demo-hello-world-mig-ccx4&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-demo-hello-world-mig-658w&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Access service in VM managed instance group td-observability-service-vm-mig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-observability-service-vm-mig-50tq&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-observability-service-vm-mig-16pr&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-observability-service-vm-mig-50tq&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;td-observability-service-vm-mig-16pr&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Access service in GKE network endpoint group k8s1-e403ff53-default-service-test-80-e849f707
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">app1-84996668df-dlccn
</span></span><span class="line"><span class="cl">app1-84996668df-t4qmn
</span></span><span class="line"><span class="cl">app1-84996668df-dlccn
</span></span><span class="line"><span class="cl">app1-84996668df-t4qmn
</span></span></code></pre></div><h2 id="anthos-service-mesh">Anthos Service Mesh</h2>
<p>Anthos Service Mesh 是 Google 混合云和多云解决方案 Anthos 中负责服务管理的部分。和 Traffic Director 的主要区别是，Anthos Service Mesh 直接采用了开源 Istio， 并且未对控制面进行托管，而是将 Istio 控制面部署在了用户集群中，只是将遥测信息接入了 Google Cloud，并在 Google cloud console 的 Anthos Service Mesh 界面中提供了服务网格的查看和监控界面。
Anthos Service Mesh关键特性包括：</p>
<ul>
<li>原生Istio多集群方案</li>
<li>支持多云/混合云（不支持虚机）</li>
<li>集中的服务监控控制台。</li>
</ul>
<h3 id="anthos-的整体架构">Anthos 的整体架构</h3>
<p>Google Cloud Anthos 旨在提供一个跨越 Google Cloud、私有云和其他公有云的统一解决方案，为客户在混合云/多云环境下的集群和应用管理提供一致的体验。Anthos 包含了统一的 GKE 集群管理，服务管理和配置管理三大部分功能。其中 Anthos Service Mesh 负责其中统一的服务管理部分，可以将部署在多个不同云环境中的 Istio 集群在 Anthos Service Mesh 控制台中进行统一的管理和监控。</p>
<p>Anthos 架构</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/anthos_hub652c65ff66ddfce98782a3c3805b67f_107083_162dfd7dfb9fc00effd800f361c84d6b.webp 400w,
               /blog/google-cloud-mesh/anthos_hub652c65ff66ddfce98782a3c3805b67f_107083_fe4f2faaaf95833e17561dbae6b901eb.webp 760w,
               /blog/google-cloud-mesh/anthos_hub652c65ff66ddfce98782a3c3805b67f_107083_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/anthos_hub652c65ff66ddfce98782a3c3805b67f_107083_162dfd7dfb9fc00effd800f361c84d6b.webp"
               width="760"
               height="469"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h3 id="anthos-gke-集群管理">Anthos GKE 集群管理</h3>
<p>Anthos 对 On-Perm 和多云的 K8s 集群的管理采用了代理的方式，Anthos 会在每个加入 Anthos 的集群中安装一个 agent，由 agent 主动建立一个到 Anthos 控制面的连接，以穿透 NAT，连接建立后，Anthos 控制面会连接集群的 API Server，对集群进查看和行管理。</p>
<p>Anthos 采用 agent 接入 K8s 集群</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/anthos-cluster-management_hu03d41c913304d8a92c30bbd3084168d4_148338_e65eeb72d04815ea13ff8b967ae6ffc2.webp 400w,
               /blog/google-cloud-mesh/anthos-cluster-management_hu03d41c913304d8a92c30bbd3084168d4_148338_88ee7918a32cbd3a1cd9b00e441662d6.webp 760w,
               /blog/google-cloud-mesh/anthos-cluster-management_hu03d41c913304d8a92c30bbd3084168d4_148338_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/anthos-cluster-management_hu03d41c913304d8a92c30bbd3084168d4_148338_e65eeb72d04815ea13ff8b967ae6ffc2.webp"
               width="760"
               height="426"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h3 id="anthos-service-mesh-的混合云多云解决方案">Anthos Service Mesh 的混合云/多云解决方案</h3>
<p>由于采用了开源 Istio，因此 Anthos Service Mesh 的混合云/多云解决方案实际上采用的是 Istio 的多集群方案。Istio 自身的多集群方案是非常灵活的，根据网络模式和控制面的安装模式，可以有多种灵活的搭配组合。Anthos Service Mesh 中推荐使用的是多控制面方案。</p>
<h4 id="多网络多控制平面">多网络多控制平面</h4>
<p>该方案中多个集群在不同网络中，不同集群中的 Pod IP 之间是不能通过路由互通的，只能通过网关进行访问。即使在不同集群中部署相同的服务，对远端集群中服务的访问方式也和本地服务不同，即不能采用同一服务名来访问不同集群中的相同服务，因此无法实现跨集群/地域的负载均衡或容灾。</p>
<p>由于上诉特点，多网络多控制平面的部署方案一般用于需要隔离不同服务的场景，如下图所示，通常会在不同集群中部署不同的服务，跨集群进行服务调用时通过 Ingress Gateway 进行。</p>
<p>Anthos Service Mesh 多集群管理-多网络多控制平面</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/multi-network-deployment_hud87f5e983895a90751aaa1657d9a1b5d_233918_69556e043b1461d852fca3d33bc92589.webp 400w,
               /blog/google-cloud-mesh/multi-network-deployment_hud87f5e983895a90751aaa1657d9a1b5d_233918_ba9b7296939c13b7a9eb5d2dac2f15fc.webp 760w,
               /blog/google-cloud-mesh/multi-network-deployment_hud87f5e983895a90751aaa1657d9a1b5d_233918_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/multi-network-deployment_hud87f5e983895a90751aaa1657d9a1b5d_233918_69556e043b1461d852fca3d33bc92589.webp"
               width="760"
               height="491"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h4 id="单网络多控制平面">单网络多控制平面</h4>
<p>在该方案中，多个集群处于同一个扁平三层网络之中，各个集群中的服务可以直接相互访问。如下图所示，两个集群中的 Istio 控制面都通过访问对方的 API server 拿到了对方的服务信息。在这种场景中，通常会在不同集群中部署相同的服务，以实现跨地域的负载均衡和容灾。</p>
<p>如图中箭头所示，在正常情况下，每个 region 中的服务只会访问自己 region 中的其他服务，以避免跨 region 调用导致时延较长，影响用户体验。当左边 region 中的 ratings 服务由于故障不能访问时，reviews 服务会通过 Istio 提供的 Locality Load Balancing 能力访问右侧 region 中的 ratings 服务，以实现跨 region 的容灾，避免服务中断。</p>
<p>Anthos Service Mesh 多集群管理-单网络多控制平面</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/single-network-deployment_hu2fd964f009b526d07e0c4ffed6c461cb_80093_e610bd3d1dd474eeddac4da171c1a322.webp 400w,
               /blog/google-cloud-mesh/single-network-deployment_hu2fd964f009b526d07e0c4ffed6c461cb_80093_d68e0f2275e9778c9523a7fe0e06504d.webp 760w,
               /blog/google-cloud-mesh/single-network-deployment_hu2fd964f009b526d07e0c4ffed6c461cb_80093_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/single-network-deployment_hu2fd964f009b526d07e0c4ffed6c461cb_80093_e610bd3d1dd474eeddac4da171c1a322.webp"
               width="760"
               height="483"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h3 id="anthos-service-mesh-多集群部署示例">Anthos Service Mesh 多集群部署示例</h3>
<p>对于 Istio 来讲，其管理的 Mesh 中的多个集群是否跨云/混合云并不影响集群管理的部署方案，因为本质上都是同一网络/多个网络两种情况下的多集群管理。本示例的两个集群都使用了 GKE 的 Cluster。但只要把网络打通，本示例也适用于跨云/混合云的情况。</p>
<p>本示例的部署如图“单网络多控制面“所示，在同一个 VPC 中的两个 region 中部署了两个 GKE cluster。部署时需要注意几点：</p>
<ul>
<li>需要将 cluster 的网络方案设置为 vpc-native，这样 pod ip 在 vpc 中就是可以路由的，以让两个 cluster 的网络可以互通。</li>
<li>需要为两个 cluster 中部署的 Istio 控制面设置对方 api server 的 remote secret，以使 stio 获取对方的 Service 信息。</li>
</ul>
<p>具体的安装步骤可以参见 Anthos Service Mesh 的<a href="https://cloud.google.com/service-mesh/docs/gke-project-setup" target="_blank" rel="noopener">帮助文档</a>。</p>
<p>从导出的 Envoy sidecar 配置可以看到，其连接的 xds server 为本地集群中的 istiod。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl">        <span class="s2">&#34;cluster_name&#34;</span><span class="err">:</span> <span class="s2">&#34;xds-grpc&#34;</span><span class="err">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;endpoints&#34;</span><span class="err">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;lb_endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">           <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;socket_address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;istiod.istio-system.svc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="nt">&#34;port_value&#34;</span><span class="p">:</span> <span class="mi">15012</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span></code></pre></div><p>Metric，Access log和 tracing 过 Envoy stackdriver http filter 上报到 Google Cloud，以便通过 Anthos Service Mesh 控制台统一查看。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl">              <span class="s2">&#34;name&#34;</span><span class="err">:</span> <span class="s2">&#34;istio.stackdriver&#34;</span><span class="err">,</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;typed_config&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/udpa.type.v1.TypedStruct&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="nt">&#34;type_url&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nt">&#34;root_id&#34;</span><span class="p">:</span> <span class="s2">&#34;stackdriver_outbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="nt">&#34;vm_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;vm_id&#34;</span><span class="p">:</span> <span class="s2">&#34;stackdriver_outbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;runtime&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.wasm.runtime.null&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                   <span class="nt">&#34;local&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;inline_string&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.wasm.null.stackdriver&#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                 <span class="p">},</span>
</span></span><span class="line"><span class="cl">                 <span class="nt">&#34;configuration&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;enable_mesh_edges_reporting\&#34;: true, \&#34;disable_server_access_logging\&#34;: false, \&#34;meshEdgesReportingDuration\&#34;: \&#34;600s\&#34;}\n&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span></code></pre></div><p>尝试从位于 west1-a Region 集群的 sleep pod 中访问 helloworld 服务，可以看到缺省会访问本集群中的 helloword v1 版本的服务实例，不会跨地域访问。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">g********@cloudshell:~ <span class="o">(</span>huabingzhao-anthos<span class="o">)</span>$ 
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CTX1</span><span class="o">=</span>gke_huabingzhao-anthos_us-west1-a_anthos-mesh-cluster-1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..4<span class="o">}</span>
</span></span><span class="line"><span class="cl">&gt; <span class="k">do</span>
</span></span><span class="line"><span class="cl">&gt; kubectl <span class="nb">exec</span> --context<span class="o">=</span><span class="si">${</span><span class="nv">CTX1</span><span class="si">}</span> -it -n sample -c sleep  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt;    <span class="k">$(</span>kubectl get pod --context<span class="o">=</span><span class="si">${</span><span class="nv">CTX1</span><span class="si">}</span> -n sample -l    <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt;    <span class="nv">app</span><span class="o">=</span>sleep -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span>  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt;    -- curl helloworld.sample:5000/hello
</span></span><span class="line"><span class="cl">&gt; <span class="k">done</span>
</span></span><span class="line"><span class="cl">Hello version: v1, instance: helloworld-v1-578dd69f69-c2fmz
</span></span><span class="line"><span class="cl">Hello version: v1, instance: helloworld-v1-578dd69f69-c2fmz
</span></span><span class="line"><span class="cl">Hello version: v1, instance: helloworld-v1-578dd69f69-c2fmz
</span></span><span class="line"><span class="cl">Hello version: v1, instance: helloworld-v1-578dd69f69-c2fmz
</span></span></code></pre></div><p>将 west1-a 集群中 helloworld deployment 的副本数设置为0，再进行访问，由于本地没有可用实例，会访问到部署在 east1-b region 的 helloworld v2，实现了跨地域的容灾。这里需要注意一点：虽然两个集群的 IP 是可路由的，但 Google cloud 的防火墙缺省并不允许集群之间相互访问，需要先创建相应的防火墙规则，以允许跨集群的网格访问流量。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl edit deployment helloworld-v1 -nsample --context<span class="o">=</span><span class="si">${</span><span class="nv">CTX1</span><span class="si">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">deployment.kubernetes.io/revision</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-08-14T12:00:32Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">helloworld-v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;54763&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/apps/v1/namespaces/sample/deployments/helloworld-v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">d6c79e00-e62d-411a-8986-25513d805eeb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">helloworld</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">......</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">g********@cloudshell:~ <span class="o">(</span>huabingzhao-anthos<span class="o">)</span>$ <span class="k">for</span> i in <span class="o">{</span>1..4<span class="o">}</span>
</span></span><span class="line"><span class="cl">&gt; <span class="k">do</span>
</span></span><span class="line"><span class="cl">&gt; kubectl <span class="nb">exec</span> --context<span class="o">=</span><span class="si">${</span><span class="nv">CTX1</span><span class="si">}</span> -it -n sample -c sleep  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt;    <span class="k">$(</span>kubectl get pod --context<span class="o">=</span><span class="si">${</span><span class="nv">CTX1</span><span class="si">}</span> -n sample -l    <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt;    <span class="nv">app</span><span class="o">=</span>sleep -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span>  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt;    -- curl helloworld.sample:5000/hello
</span></span><span class="line"><span class="cl">&gt; <span class="k">done</span>
</span></span><span class="line"><span class="cl">Hello version: v2, instance: helloworld-v2-776f74c475-jws5r
</span></span><span class="line"><span class="cl">Hello version: v2, instance: helloworld-v2-776f74c475-jws5r
</span></span><span class="line"><span class="cl">Hello version: v2, instance: helloworld-v2-776f74c475-jws5r
</span></span><span class="line"><span class="cl">Hello version: v2, instance: helloworld-v2-776f74c475-jws5r
</span></span></code></pre></div><h2 id="相互竞争还是优势互补">相互竞争还是优势互补？</h2>
<p>从前面的分析可以看出， Google Cloud 推出的 Traffic Director 和 Anthos Service Mesh 这两个服务网格的产品各有侧重点：</p>
<ul>
<li>Traffic Director 关注重点为流量管理。依靠 Google Cloud 强大的网络能力提供了跨区域的 Mesh 流量管理，支持本地服务出现问题时将流量导向另一个地域的相同服务，以避免用户业务中断；并且通过统一的服务发现机制实现了 K8s 集群和虚拟机的混合部署。</li>
<li>Anthos Service Mesh 关注重点为跨云/多云的统一管理。这是出于用户业务部署的实际环境和业务向云迁移的较长过程的实际考虑，但目前未支持虚拟机，并且其对于 Mesh 中全局流量的管理能力不如 Traffic Director 这样强大。</li>
</ul>
<p>由于目的不同，两者在控制面也采用不同的实现方案。由于 Traffic Director 只需要支持 Google Cloud，处于一个可控的网络环境中，因此采用托管的自定义控制面实现，并对接了 Google Cloud 上的服务发现机制；而 Anthos Service Mesh 考虑到多云/混合云场景下复杂的网络环境和部署限制，采用了开源 Istio 的多控制面方案，在每个集群中都单独安装了一个 Istio，只是接入了 Google Cloud 的遥测数据，以对网格中的服务进行统一监控。</p>
<p>虽然 Traffic Director 和 Anthos Service Mesh 两者都是 Google Cloud 上的 Service Mesh 产品，似乎存在竞争关系，但从两者的功能和定位可以看出，这两个产品其实是互补的，可以结合两者以形成一个比较完善的 Service Mesh 托管解决方案。因此 Google Cloud 会对两个产品持续进行整合。下图为 Traffic Director Road Map 中 Anthos 和 Istio 的整合计划。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/google-cloud-mesh/traffic-director-anthos-int_hu02fa7c856a743b24e6fd5a8bd9cde958_303815_f8491f8989c4ab364959105e1cf70d29.webp 400w,
               /blog/google-cloud-mesh/traffic-director-anthos-int_hu02fa7c856a743b24e6fd5a8bd9cde958_303815_8854dd104a8b337188639ed438cc4839.webp 760w,
               /blog/google-cloud-mesh/traffic-director-anthos-int_hu02fa7c856a743b24e6fd5a8bd9cde958_303815_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/google-cloud-mesh/traffic-director-anthos-int_hu02fa7c856a743b24e6fd5a8bd9cde958_303815_f8491f8989c4ab364959105e1cf70d29.webp"
               width="760"
               height="367"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips" target="_blank" rel="noopener">Creating a VPC-native cluster</a></li>
<li><a href="https://cloud.google.com/traffic-director" target="_blank" rel="noopener">Traffic Director</a></li>
<li><a href="https://cloud.google.com/anthos/service-mesh" target="_blank" rel="noopener">Anthos Service Mesh</a></li>
</ul>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/service-mesh/">service mesh</a>
  
  <a class="badge badge-light" href="/tag/istio/">Istio</a>
  
  <a class="badge badge-light" href="/tag/traffic-director/">Traffic Director</a>
  
  <a class="badge badge-light" href="/tag/anthos-service-mesh/">Anthos Service Mesh</a>
  
  <a class="badge badge-light" href="/tag/google-cloud/">Google Cloud</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E8%B5%B5%E5%8C%96%E5%86%B0/"><img class="avatar mr-3 avatar-circle" src="/author/%E8%B5%B5%E5%8C%96%E5%86%B0/avatar_hu584c926f62a0fa050bae237d0ba2c125_11613_270x270_fill_q75_lanczos_center.jpg" alt="赵化冰"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E8%B5%B5%E5%8C%96%E5%86%B0/">赵化冰</a></p>
      
      <p class="card-text">腾讯</p>
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/client-go-informer/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>Kubernetes client-go informer原理</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/istio-1-7-explanation/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>Istio 1.7 发布——进击的追风少年</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/google-cloud-mesh/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/resiliency-app-aware-network/">利用服务网格和智能应用感知网络增强应用弹性</a></li>
      
      <li><a href="/blog/ebpf-solve-service-mesh-sidecar/">告别 Sidecar——使用 eBPF 解锁内核级服务网格</a></li>
      
      <li><a href="/blog/jimmy-service-mesh-talk/">都 2021 年了，对于服务网格，社区到底在讨论什么？</a></li>
      
      <li><a href="/blog/istiocon-layer7-traffic/">使用 Aeraki 在 Isito 中支持 Dubbo、Thrift、Redis，以及任何七层协议</a></li>
      
      <li><a href="/blog/the-facts-of-using-istio/">在生产环境使用 Istio 前的若干考虑要素</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2023 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
