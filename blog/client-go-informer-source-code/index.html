<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  
  <title>深入了解 Kubernetes Informer | 云原生社区</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Kubernetes Client-go Informer 机制及源码理解">
  
  <meta name="author" content=" 云原生社区">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">
  <meta property="og:image" content="https://cloudnative.to/images/favicon.png">
  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="Cloud Native Community|云原生社区" />
  <meta name="twitter:creator" content="@CloudNativeCN" />
  <meta property="og:url" content="https://cloudnative.to/blog/client-go-informer-source-code/" />
  <meta property="og:title" content="深入了解 Kubernetes Informer" />
  <meta property="og:description" content="Kubernetes Client-go Informer 机制及源码理解" />
  <meta property="og:image" content="https://cloudnative.to/images/blog/k8s-client-go-informer-source-code.jpg" />
</head>
<body>
<!-- header -->

<img src="images/logo-square.jpg" width="0" height="0" />
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
     <img src="" width='700'>
</div>
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="云原生社区"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog/">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="https://i.cloudnative.to/community/sig/">兴趣小组</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/team">管理委员会</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/academy/">云原生学院</a>
                
                <a class="dropdown-item" href="/city">城市站</a>
                
                <a class="dropdown-item" href="https://i.cloudnative.to/community/">社区资料</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="http://landscape.opensourcecloud.cn/">云原生生态图景</a>
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder 中文文档</a>
                
                <a class="dropdown-item" href="/envoy">Envoy 中文文档</a>
                
                <a class="dropdown-item" href="https://istio.io/latest/zh/">Istio 中文文档</a>
                
              </div>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title-5.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3 text-capitalize">深入了解 kubernetes informer</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">Kubernetes Client-go Informer 机制及源码理解</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/k8s-client-go-informer-source-code.jpg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type"><a href="/categories/kubernetes">Kubernetes</a></div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://github.com/linxuyalun">林许亚伦</a></strong>
          
            发表于 <strong class="text-dark">2020年8月28日</strong></div>
        <hr>
        <div class="content">
          <p>本文主要根据书籍 《Kubernetes 源码剖析》的基础上，对 Client-go 部分的 Informer 机制进行了解与学习。</p>
<h2 id="informer-机制">Informer 机制</h2>
<p>Kubernetes 中使用 http 进行通信，<strong>如何不依赖中间件的情况下保证消息的实时性，可靠性和顺序性等呢</strong>？答案就是利用了 Informer 机制。Informer 的机制，降低了了 Kubernetes 各个组件跟 Etcd 与 Kubernetes API Server 的通信压力。</p>
<h3 id="informer-机制架构设计">Informer 机制架构设计</h3>
<p><img src="01.jpg" alt=""></p>
<p>图片源自 <a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">Client-go under the hood</a></p>
<p>⚠️  这张图分为两部分，黄色图标是开发者需要自行开发的部分，而其它的部分是 client-go 已经提供的，直接使用即可。</p>
<ol>
<li><strong>Reflector</strong>：用于 Watch 指定的 Kubernetes 资源，当 watch 的资源发生变化时，触发变更的事件，比如 Added，Updated 和 Deleted 事件，并将资源对象存放到本地缓存 DeltaFIFO；</li>
<li><strong>DeltaFIFO</strong>：拆开理解，FIFO 就是一个队列，拥有队列基本方法（ADD，UPDATE，DELETE，LIST，POP，CLOSE 等），Delta 是一个资源对象存储，保存存储对象的消费类型，比如 Added，Updated，Deleted，Sync 等；</li>
<li><strong>Indexer</strong>：Client-go 用来存储资源对象并自带索引功能的本地存储，Reflector 从 DeltaFIFO 中将消费出来的资源对象存储到 Indexer，Indexer 与 Etcd 集群中的数据完全保持一致。从而 client-go 可以本地读取，减少 Kubernetes API 和 Etcd 集群的压力。</li>
</ol>
<p>看书本上的一个例子，想使用 Informer 的关键流程如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">clientset</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">stopch</span>)
<span style="color:#a6e22e">sharedInformers</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">clientset</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>)
<span style="color:#a6e22e">informer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sharedInformer</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Pods</span>().<span style="color:#a6e22e">Informer</span>()
<span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
  <span style="color:#a6e22e">AddFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{} {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  },
  <span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{} {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  },
  <span style="color:#a6e22e">DeleteFunc</span>  : <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{} {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  })
  <span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)
})
</code></pre></div><ul>
<li>Informer 需要通过 ClientSet 与 Kubernetes API Server 交互；</li>
<li>创建 stopCh 是用于在程序进程退出前通知 Informer 提前退出，Informer 是一个持久运行的 goroutine；</li>
<li>NewSharedInformerFactory 实例化了一个 SharedInformer 对象，用于进行本地资源存储；</li>
<li>sharedInformer.Core().V1().Pods().Informer() 得到了具体 Pod 资源的 informer 对象；</li>
<li>AddEventHandler 即图中的第6步，这是一个资源事件回调方法，上例中即为当创建/更新/删除 Pod 时触发事件回调方法；</li>
<li>一般而言，其他组件使用 Informer 机制触发资源回调方法会将资源对象推送到 WorkQueue 或其他队列中，具体推送的位置要去回调方法里自行实现。</li>
</ul>
<p>上面这个示例，当触发了 Add，Update 或者 Delete 事件，就通知 Client-go，告知 Kubernetes 资源事件发生变更并且需要进行相应的处理。</p>
<ol>
<li>资源 Informer</li>
</ol>
<p>每一个 k8s Resource 都实现了 Informer 机制，<strong>均有 Informer 和 Lister 方法</strong>，以 PodInformer 为例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PodInformer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Informer</span>() <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span>
	<span style="color:#a6e22e">Lister</span>() <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">PodLister</span>
}
</code></pre></div><ol start="2">
<li>Shared Informer 共享机制</li>
</ol>
<p>Informer 又称为 Shared Informer，表明是可以共享使用的，在使用 client-go 写代码时，若同一资源的 Informer 被实例化太多次，每个 Informer 使用一个 Reflector，会运行过多的相同 ListAndWatch（<strong>即图中的第一步</strong>），太多重复的序列化和反序列化会导致 k8s API Server 负载过重。</p>
<p>而 Shared Informer 通过对同一类资源 Informer 共享一个 Reflector 可以节约很多资源，这<strong>通过 map 数据结构</strong>即可实现这样一个共享 Informer 机制。</p>
<p><code>vendor/k8s.io/client-go/informers/factory.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">sharedInformerFactory</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  
  <span style="color:#75715e">// map 数据结构
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">informers</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>]<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span>
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">// ...
</span><span style="color:#75715e">// InternalInformerFor returns the SharedIndexInformer for obj using an internal client.
</span><span style="color:#75715e">// 当示例中调用 xxx.Informer() 时，内部调用了该方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedInformerFactory</span>) <span style="color:#a6e22e">InformerFor</span>(<span style="color:#a6e22e">obj</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">newFunc</span> <span style="color:#a6e22e">internalinterfaces</span>.<span style="color:#a6e22e">NewInformerFunc</span>) <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span> {
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">informerType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">obj</span>)
	<span style="color:#a6e22e">informer</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">informers</span>[<span style="color:#a6e22e">informerType</span>]
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">exists</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">informer</span>
	}

	<span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">customResync</span>[<span style="color:#a6e22e">informerType</span>]
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">exists</span> {
		<span style="color:#a6e22e">resyncPeriod</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">defaultResync</span>
	}

	<span style="color:#a6e22e">informer</span> = <span style="color:#a6e22e">newFunc</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">resyncPeriod</span>)
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">informers</span>[<span style="color:#a6e22e">informerType</span>] = <span style="color:#a6e22e">informer</span>

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">informer</span>
}
</code></pre></div><h3 id="reflector">Reflector</h3>
<p>Reflector 用于 Watch 指定的 Kubernetes 资源，当 watch 的资源发生变化时，触发变更的事件，并将资源对象存放到本地缓存 DeltaFIFO。</p>
<p>通过 NewReflector 实例化 Reflector 对象，实例化过程必须传入 ListerWatcher 数据接口对象，它拥有 List 和 Watch 方法。Reflector 对象通过 Run 行数启动监控并处理监控事件，在实现中，其核心为 ListAndWatch 函数。</p>
<p>以 Example 的代码为例，我们在最后一步执行了 <code>informer.Run(stopCh)</code>，内部会执行一个 ListAndWatch 方法：</p>
<p><code>vendor/k8s.io/client-go/tools/cache/reflector.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Run 执行一个 watch 并且把握所有的 watch events，watch 关闭后会重启
</span><span style="color:#75715e">// stopCh 关闭时 Run 退出
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reflector</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">3</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Starting reflector %v (%s) from %s&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">expectedType</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>)
	<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ListAndWatch</span>(<span style="color:#a6e22e">stopCh</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">err</span>)
		}
	}, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">period</span>, <span style="color:#a6e22e">stopCh</span>)
}
</code></pre></div><ol>
<li><strong>获取资源数据列表</strong></li>
</ol>
<p>以之前提过的 Example 的代码为例，通过 <code>Run</code> 获取了所有 Pod 的资源数据，List 流程如下：</p>
<ol>
<li><code>r.ListWatcher.List</code> 获取资源数据；</li>
<li><code>listMetaInterface.GetResourceVersion</code> 获取资源版本号；</li>
<li><code>meta.ExtractList</code> 将资源数据转换为资源对象列表；</li>
<li><code>r.SyncWith</code> 将资源对象列表的资源对象和资源版本号存储到 DeltaFIFO 中；</li>
<li><code>r.setLastSyncResourceVersion</code> 设置最新的资源版本号。</li>
</ol>
<p>具体的，</p>
<ul>
<li><code>r.ListWatcher.List</code> 根据 ResourceVersion 获取资源下的所有对象数据。以 Example 为例，该方法调用的就是 Pod Informer 下的 <code>ListFunc</code> 函数，通过 ClientSet 客户端与 Kubernetes API Server 交互并获取 Pod 资源列表数据；</li>
<li><code>listMetaInterface.GetResourceVersion</code> 获取 ResourceVersion，即资源版本号，注意这里的资源版本号并不是指前面各个客户端的不同 kind 的不同 Version，所有资源都拥有 ResourceVersion，标识当前资源对象的版本号。每次修改 etcd 集群中存储的对象时，Kubernetes API Server 都会更改 ResourceVersion，使得 client-go 执行 watch 时可以根据 ResourceVersion 判断当前资源对象是否发生变化；</li>
<li><code>meta.ExtractList</code> 将 runtime.Object 对象转换为 []runtime.Object 对象。因为 <code>r.ListWatcher.List</code> 获取的是资源下所有对象的数据，因此应当是一个列表；</li>
<li><code>r.SyncWith </code>将结果同步到 DeltaFIFO 中；</li>
<li><code>r.setLastSyncResourceVersion</code> 设置最新的资源版本号。</li>
</ul>
<ol start="2">
<li><strong>监控资源对象</strong></li>
</ol>
<p>Watch 通过 HTTP 协议与 Kubernetes API Server 建立长连接，接收 Kubernetes API Server 发来的资源变更事件。Watch 操作的实现机制使用 HTTP 协议的分块传输编码——当 client-go 调用 Kubernetes API Server 时，Kubernetes API Server 在 Response 的 HTTP Header 中设置 Transfer-Encoding 的值为 chunked，表示采用分块传输编码，客户端收到消息后，与服务端进行连接，并等待下一个数据块。</p>
<p><strong>在源码中关键为 watch 和 watchHandler 函数</strong>：</p>
<p><code>staging/src/k8s.io/client-go/tools/cache/reflector.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reflector</span>) <span style="color:#a6e22e">ListAndWatch</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// 前面提到的 list 部分代码
</span><span style="color:#75715e"></span>  
  <span style="color:#75715e">// watch part
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">// 收到 stopCh 停止循环
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		<span style="color:#66d9ef">default</span>:
		}

		<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">options</span> = <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{
			<span style="color:#a6e22e">ResourceVersion</span>: <span style="color:#a6e22e">resourceVersion</span>,
      <span style="color:#75715e">// 设置超时时间避免将 watchers 挂起
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">TimeoutSeconds</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">timeoutSeconds</span>,
		}

		<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">listerWatcher</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">options</span>)
		<span style="color:#75715e">// error handling 部分
</span><span style="color:#75715e"></span>    
    <span style="color:#75715e">// 另一个核心函数 watchHandler，后文介绍
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">watchHandler</span>(<span style="color:#a6e22e">w</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">resourceVersion</span>, <span style="color:#a6e22e">resyncerrc</span>, <span style="color:#a6e22e">stopCh</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">errorStopRequested</span> {
				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;%s: watch of %v ended with: %v&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">expectedType</span>, <span style="color:#a6e22e">err</span>)
			}
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}
	}
}
</code></pre></div><p>以之前的 Example 为例子，<code>r.listerWatcher.Watch</code> 实际调用了 Pod Informer 下的 Watch 函数，通过 ClientSet 客户端与 Kubernetes API Server 建立长链接，监控指定资源的变更事件，如下：</p>
<p><code>staging/src/k8s.io/client-go/informers/core/v1/pod.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFilteredPodInformer</span>(<span style="color:#f92672">...</span>) <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SharedIndexInformer</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewSharedIndexInformer</span>(
		  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">WatchFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">options</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>) (<span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#66d9ef">error</span>) {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tweakListOptions</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">tweakListOptions</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">options</span>)
				}
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">options</span>)
			},
		},
		<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	)
}
</code></pre></div><p><code>r.watchHandler</code> 处理资源的变更事件，将对应资源更新到本地缓存 DeltaFIFO 并更新 ResourceVersion 资源版本号。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// watchHandler watches w and keeps *resourceVersion up to date.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reflector</span>) <span style="color:#a6e22e">watchHandler</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#a6e22e">resourceVersion</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">errc</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">eventCount</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Stop</span>()

<span style="color:#75715e">// 循环嵌套循环时，在 break 后指定标签。用标签决定哪个循环被终止
</span><span style="color:#75715e"></span><span style="color:#a6e22e">loop</span>:
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errorStopRequested</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">errc</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">event</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">ResultChan</span>():
      <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
        <span style="color:#75715e">// 直接跳出 for 循环
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">break</span> <span style="color:#a6e22e">loop</span>
			}
			<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">newResourceVersion</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">GetResourceVersion</span>()
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Type</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Added</span>:
				<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>)
				<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Modified</span>:
				<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>)
				<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Deleted</span>:
				<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>)
				<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">default</span>:
				<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			}
			<span style="color:#f92672">*</span><span style="color:#a6e22e">resourceVersion</span> = <span style="color:#a6e22e">newResourceVersion</span>
			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">setLastSyncResourceVersion</span>(<span style="color:#a6e22e">newResourceVersion</span>)
			<span style="color:#a6e22e">eventCount</span><span style="color:#f92672">++</span>
		}
	}
<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="deltafifo">DeltaFIFO</h3>
<p>DeltaFIFO 拆开理解，FIFO 就是一个队列，拥有队列基本方法（ADD，UPDATE，DELETE，LIST，POP，CLOSE 等），Delta 是一个资源对象存储，保存存储对象的消费类型，比如 Added，Updated，Deleted，Sync 等。</p>
<p>看 DeltaFIFO 的数据结构：</p>
<p><code>vendor/k8s.io/client-go/tools/cache/delta_fifo.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DeltaFIFO</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// lock/cond protects access to &#39;items&#39; and &#39;queue&#39;.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
	<span style="color:#a6e22e">cond</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>

	<span style="color:#75715e">// We depend on the property that items in the set are in
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the queue and vice versa, and that all Deltas in this
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// map have at least one Delta.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">items</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">Deltas</span>
	<span style="color:#a6e22e">queue</span> []<span style="color:#66d9ef">string</span>

	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>其中，Deltas 部分的数据结构如下：</p>
<p><code>staging/src/k8s.io/client-go/tools/cache/delta_fifo.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// DeltaType is the type of a change (addition, deletion, etc)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DeltaType</span> <span style="color:#66d9ef">string</span>

<span style="color:#75715e">// Delta is the type stored by a DeltaFIFO. It tells you what change
</span><span style="color:#75715e">// happened, and the object&#39;s state after* that change.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Delta</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Type</span>   <span style="color:#a6e22e">DeltaType</span>
	<span style="color:#a6e22e">Object</span> <span style="color:#66d9ef">interface</span>{}
}

<span style="color:#75715e">// Deltas is a list of one or more &#39;Delta&#39;s to an individual object.
</span><span style="color:#75715e">// The oldest delta is at index 0, the newest delta is the last one.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Deltas</span> []<span style="color:#a6e22e">Delta</span>
</code></pre></div><p>DeltaFIFO 会保留所有关于资源对象（obj）的操作类型，队列中会存在拥有不同操作类型的同一资源对象，<strong>使得消费者在处理该资源对象时能够了解资源对象所发生的事情</strong>。queue 字段存储资源对象的 key，这个 key 通过 KeyOf 函数计算得到，items 字段通过 map 数据结构的方式存储，value 存储的是对象 Deltas 数组，一个结构示例图如下：</p>
<pre><code>        ┌───────┐┌───────┐┌───────┐
queue   │ObjKey1││ObjKey2││ObjKey3│
        └───────┘└───────┘└───────┘

        ┌─────────────────────────────────────────────────────────────┐
itmes   │ObjKey1: [{&quot;Added&quot;,Obj1} {&quot;Updated&quot;,Obj1}]                   │
        ├─────────────────────────────────────────────────────────────┤
        │ObjKey2: [{&quot;Added&quot;,Obj2},{&quot;Deleted&quot;,Obj2},{&quot;Sync&quot;,Obj2}]     │
        ├─────────────────────────────────────────────────────────────┤
        │ObjKey3: [{&quot;Added&quot;,Obj3},{&quot;Updated&quot;,Obj3},{&quot;Deleted&quot;,Obj3}]  │
        └─────────────────────────────────────────────────────────────┘

</code></pre><p>作为一个 FIFO 的队列，有数据的生产者和消费者，其中生产者是 Reflector 调用的 Add 方法，消费者是 Controller 调用的 Pop 方法。三个核心方法为<strong>生产者方法，消费者方法和 Resync 机制</strong>。</p>
<h4 id="生产者方法">生产者方法</h4>
<p>DeltaFIFO 队列中的资源对象在调用 Added，Updated，Deleted 等事件时都调用了 queueActionLocked 函数：</p>
<p><img src="02.png" alt=""></p>
<p>它是 DeltaFIFO 实现的关键：</p>
<p><code>vendor/k8s.io/client-go/tools/cache/delta_fifo.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// queueActionLocked 为一个 delta list 添加一个 object
</span><span style="color:#75715e">// 调用方必须先上锁
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeltaFIFO</span>) <span style="color:#a6e22e">queueActionLocked</span>(<span style="color:#a6e22e">actionType</span> <span style="color:#a6e22e">DeltaType</span>, <span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
  <span style="color:#75715e">// 通过 KeyOf 函数计算出对象的 key
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">KeyOf</span>(<span style="color:#a6e22e">obj</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">KeyError</span>{<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">err</span>}
	}

  <span style="color:#75715e">// 将 actionType 以及对应的 id 添加到 items 中，并通过 dedupDeltas 对数组中最新的两次添加进行去重
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">newDeltas</span> <span style="color:#f92672">:=</span> append(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>], <span style="color:#a6e22e">Delta</span>{<span style="color:#a6e22e">actionType</span>, <span style="color:#a6e22e">obj</span>})
	<span style="color:#a6e22e">newDeltas</span> = <span style="color:#a6e22e">dedupDeltas</span>(<span style="color:#a6e22e">newDeltas</span>)

  <span style="color:#75715e">// 一般不会出现 &lt;= 0， 属冗余判断
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">newDeltas</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>]; !<span style="color:#a6e22e">exists</span> {
			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span> = append(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>, <span style="color:#a6e22e">id</span>)
		}
		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#a6e22e">newDeltas</span>
    <span style="color:#75715e">// 广播所有消费者解除阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Broadcast</span>()
	} <span style="color:#66d9ef">else</span> {
		delete(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">id</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><ol>
<li>通过 KeyOf 函数计算出对象的 key；</li>
<li>将 actionType 以及对应的 id 添加到 items 中，并通过 dedupDeltas 对数组中最新的两次添加进行去重；</li>
<li>更新构造后的 Deleta 并通过 cond.Broadcast() 广播所有消费者解除阻塞。</li>
</ol>
<h4 id="消费者方法">消费者方法</h4>
<p>Pop 函数作为消费者使用方法，从 DeltaFIFO 的头部取出最早进入队列中的资源对象数据。Pop 方法必须传入 process 函数，用于接收并处理对象的回调方法，如下：</p>
<p><code>vendor/k8s.io/client-go/tools/cache/delta_fifo.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeltaFIFO</span>) <span style="color:#a6e22e">Pop</span>(<span style="color:#a6e22e">process</span> <span style="color:#a6e22e">PopProcessFunc</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">for</span> len(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
      <span style="color:#75715e">// 空队列时阻塞 Pop 方法
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">IsClosed</span>() {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">FIFOClosedError</span>
			}

			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Wait</span>()
		}
		<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>[<span style="color:#ae81ff">0</span>]
		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>[<span style="color:#ae81ff">1</span>:]
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">initialPopulationCount</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">initialPopulationCount</span><span style="color:#f92672">--</span>
		}
		<span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>]
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#75715e">// Item may have been deleted subsequently.
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">continue</span>
		}
    <span style="color:#75715e">// 注意这里在执行之前会把该 obj 旧的 delta 数据清空
</span><span style="color:#75715e"></span>		delete(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">id</span>)
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">item</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#a6e22e">ErrRequeue</span>); <span style="color:#a6e22e">ok</span> {
			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">addIfNotPresent</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">item</span>)
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Err</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">err</span>
	}
}
</code></pre></div><p>首先，使用 <code>f.lock.Lock()</code> 确保了数据的同步，当队列不为空时，取出 <code>f.queue</code> 的头部数据，将对象传入 process 回调函数，由上层消费者进行处理，如果 process 回调方法处理出错，将该对象重新存入队列。</p>
<p>Controller 的 <code>processLoop</code> 方法负责从 DeltaFIFO 队列中取出数据传递给 process 回调函数，process 函数的类型如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PopProcessFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
</code></pre></div><p>一个 process 回调函数代码示例如下：</p>
<p><code>vendor/k8s.io/client-go/tools/cache/shared_informer.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">HandleDeltas</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#75715e">// from oldest to newest
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#a6e22e">Deltas</span>) {
		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">Added</span>, <span style="color:#a6e22e">Updated</span>:
			<span style="color:#a6e22e">isSync</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">Sync</span>
			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cacheMutationDetector</span>.<span style="color:#a6e22e">AddObject</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">updateNotification</span>{<span style="color:#a6e22e">oldObj</span>: <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#a6e22e">isSync</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">addNotification</span>{<span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#a6e22e">isSync</span>)
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Deleted</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
			}
			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">deleteNotification</span>{<span style="color:#a6e22e">oldObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#66d9ef">false</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>在这个例子中，HandleDeltas 作为 process 的一个回调函数，当资源对象操作类型为 Added，Updated 和 Delted 时，该资源对象存储至 Indexer（它是并发安全的），并通过 distribute 函数将资源对象分发到 SharedInformer，在之前 <a href="#informer-%E6%9C%BA%E5%88%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">Informer 机制架构设计</a>的示例代码中，通过 <code>informer.AddEventHandler</code> 函数添加了对资源事件进行处理的函数，distribute 函数将资源对象分发到该事件处理函数。</p>
<h4 id="resync-机制">Resync 机制</h4>
<blockquote>
<p>本节内容主要参考自 <a href="https://github.com/cloudnativeto/sig-k8s-source-code/issues/11">【提问】Informer 中为什么需要引入 Resync 机制？</a></p>
</blockquote>
<p>Resync 机制会将 Indexer 本地存储中的资源对象同步到 DeltaFIFO 中，并将这些资源对象设置为 Sync 的操作类型，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 重新同步一次 Indexer 缓存数据到 Delta FIFO
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeltaFIFO</span>) <span style="color:#a6e22e">Resync</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">knownObjects</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#75715e">// 遍历 indexer 中的 key，传入 syncKeyLocked 中处理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">keys</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">knownObjects</span>.<span style="color:#a6e22e">ListKeys</span>()
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">keys</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">syncKeyLocked</span>(<span style="color:#a6e22e">k</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeltaFIFO</span>) <span style="color:#a6e22e">syncKeyLocked</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">knownObjects</span>.<span style="color:#a6e22e">GetByKey</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Unexpected error %v during lookup of key %v, unable to queue object for sync&#34;</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">exists</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Key %v does not exist in known objects store, unable to queue object for sync&#34;</span>, <span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#75715e">// 若 FIFO 队列中已经有相同 key 的 event 进来了，说明该资源对象有了新的 event，
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Indexer 中旧的缓存失效，直接返回 nil
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">KeyOf</span>(<span style="color:#a6e22e">obj</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">KeyError</span>{<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">err</span>}
	}
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>]) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
  <span style="color:#75715e">// 重新放入 FIFO 队列中
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queueActionLocked</span>(<span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">obj</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;couldn&#39;t queue object: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>为什么需要 Resync 机制呢？因为在处理 SharedInformer 事件回调时，可能存在处理失败的情况，定时的 Resync 让这些处理失败的事件有了重新 onUpdate 处理的机会。</p>
<p>那么经过 Resync 重新放入 Delta FIFO 队列的事件，和直接从 apiserver 中 watch 得到的事件处理起来有什么不一样呢？在消费者方法中有介绍过 <code>HandleDeltas</code>，其中就有关于 Resync 的部分：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">HandleDeltas</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// 上锁
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#a6e22e">Deltas</span>) {
		<span style="color:#75715e">// 判断事件类型
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">Replaced</span>, <span style="color:#a6e22e">Added</span>, <span style="color:#a6e22e">Updated</span>:
			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cacheMutationDetector</span>.<span style="color:#a6e22e">AddObject</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				
				<span style="color:#a6e22e">isSync</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
				<span style="color:#66d9ef">switch</span> {
				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">Sync</span>:
					<span style="color:#75715e">// 如果是通过 Resync 重新同步得到的事件则做个标记
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">isSync</span> = <span style="color:#66d9ef">true</span>
				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">Replaced</span>:
					<span style="color:#f92672">...</span>
				}
				<span style="color:#75715e">// 如果是通过 Resync 重新同步得到的事件，则触发 onUpdate 回调
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">updateNotification</span>{<span style="color:#a6e22e">oldObj</span>: <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#a6e22e">isSync</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">addNotification</span>{<span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#66d9ef">false</span>)
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Deleted</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
			}
			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">deleteNotification</span>{<span style="color:#a6e22e">oldObj</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>}, <span style="color:#66d9ef">false</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>从上面对 Delta FIFO 的队列处理源码可看出，当从 Resync 重新同步到 Delta FIFO 队列的事件，会分发到 updateNotification 中触发 onUpdate 的回调。Resync 机制的引入，定时将 Indexer 缓存事件重新同步到 Delta FIFO 队列中，在处理 SharedInformer 事件回调时，让处理失败的事件得到重新处理。并且通过入队前判断 FIFO 队列中是否已经有了更新版本的 event，来决定是否丢弃 Indexer 缓存不进行 Resync 入队。在处理 Delta FIFO 队列中的 Resync 的事件数据时，触发 onUpdate 回调来让事件重新处理。</p>
<h3 id="indexer">Indexer</h3>
<p>Client-go 用来存储资源对象并自带索引功能的本地存储，Reflector 从 DeltaFIFO 中将消费出来的资源对象存储到 Indexer，Indexer 与 Etcd 集群中的数据完全保持一致。从而 client-go 可以本地读取，减少 Kubernetes API 和 Etcd 集群的压力。</p>
<p>了解 Indexer 之前，先了解 ThreadSafeMap，ThreadSafeMap 是实现并发安全存储，就像 Go 1.9 后推出 <code>sync.Map</code> 一样。Kubernetes 开始编写的时候还没有 <code>sync.Map</code>。Indexer 在 ThreadSafeMap 的基础上进行了封装，继承了 ThreadSafeMap 的存储相关的增删改查相关操作方法，实现了 Indexer Func 等功能，例如 Index，IndexKeys，GetIndexers 等方法，这些方法为 ThreadSafeMap 提供了索引功能。如下图：</p>
<pre><code>        ┌───────────────┐    ┌──────────────┐
        │   Indeices    │---&gt;│    Index     │
        └───────────────┘    └──────────────┘

        ┌───────────────┐    ┌──────────────┐
        │   Indexers    │---&gt;│  IndexFun    │
        └───────────────┘    └──────────────┘

        ┌───────────────────────────────────┐
        │          ThreadSafeStore          │
        └───────────────────────────────────┘
</code></pre><h4 id="threadsafestore">ThreadSafeStore</h4>
<p>ThreadSafeStore 是一个<strong>内存中存储</strong>，数据不会写入本地磁盘，增删改查都会加锁，保证数据一致性。结构如下：</p>
<p><code>vendor/k8s.io/client-go/tools/cache/store.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// threadSafeMap implements ThreadSafeStore
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">threadSafeMap</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">lock</span>  <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
	<span style="color:#a6e22e">items</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}

	<span style="color:#75715e">// indexers maps a name to an IndexFunc
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">indexers</span> <span style="color:#a6e22e">Indexers</span>
	<span style="color:#75715e">// indices maps a name to an Index
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">indices</span> <span style="color:#a6e22e">Indices</span>
}
</code></pre></div><p>items 字段存储资源对象数据，其中 items 的 key 通过 keyFunc 函数计算得到，计算默认使用 MetaNamespaceKeyFunc 函数，该函数根据资源对象计算出 <code>&lt;namespace&gt;/&lt;name&gt;</code> 格式的 key，value 用于存储资源对象。</p>
<p>而后面两个字段的定义类型如下：</p>
<p><code>vendor/k8s.io/client-go/tools/cache/index.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Index maps the indexed value to a set of keys in the store that match on that value
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Index</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">String</span>

<span style="color:#75715e">// Indexers maps a name to a IndexFunc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Indexers</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">IndexFunc</span>

<span style="color:#75715e">// Indices maps a name to an Index
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Indices</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">Index</span>
</code></pre></div><h4 id="indexer-索引器">Indexer 索引器</h4>
<p>每次增删改 ThreadSafeStore 的数据时，都会通过 updateIndices 或 deleteFormIndices 函数变更 Indexer。Indexer 被设计为可以自定义索引函数，他有重要的四个数据结构，<strong>Indexers</strong>，<strong>IndexFunc</strong>，<strong>Indices</strong> 和 <strong>Index</strong>。</p>
<p>看下面这个例子的关键流程：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UsersIndexFunc</span>(<span style="color:#a6e22e">obj</span> <span style="color:#a6e22e">interfaces</span>{}) ([]<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>)
  <span style="color:#a6e22e">usersString</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#e6db74">&#34;users&#34;</span>]
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">userString</span>, <span style="color:#e6db74">&#34;,&#34;</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
  <span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewIndexer</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Indexers</span>{<span style="color:#e6db74">&#34;byUser&#34;</span>: <span style="color:#a6e22e">UsersIndexFunc</span>})
  <span style="color:#a6e22e">pod1</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>{<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;one&#34;</span>, <span style="color:#a6e22e">Annotations</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;users&#34;</span>: <span style="color:#e6db74">&#34;ernie,bert&#34;</span>}}}
  <span style="color:#75715e">// Initialize pod2 and pod3
</span><span style="color:#75715e"></span>  
  <span style="color:#a6e22e">index</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">pod1</span>)
  <span style="color:#75715e">// Add pod2 and pod3
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">erniePods</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">omdex</span>.<span style="color:#a6e22e">ByIndex</span>(<span style="color:#e6db74">&#34;byUser&#34;</span>, <span style="color:#e6db74">&#34;ernie&#34;</span>)
}
</code></pre></div><p>首先定义了一个索引器函数（IndexFunc），UsersIndexFunc。该函数定义查询所有 Pod 资源下 Annotations 字段的 key 为 users 的 Pod：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UsersIndexFunc</span>(<span style="color:#a6e22e">obj</span> <span style="color:#a6e22e">interfaces</span>{}) ([]<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>)
  <span style="color:#a6e22e">usersString</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#e6db74">&#34;users&#34;</span>]
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">userString</span>, <span style="color:#e6db74">&#34;,&#34;</span>), <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Main 函数中 <code>cache.NewIndexer</code> 实例化了一个 Indexer 对象：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewIndexer</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Indexers</span>{<span style="color:#e6db74">&#34;byUser&#34;</span>: <span style="color:#a6e22e">UsersIndexFunc</span>})
</code></pre></div><p>第一个参数计算资源对象的 key，默认就是 MetaNamespaceKeyFunc，第二个参数是一个 Indexers 对象，如上一节展示的定义那样，key 为索引器（IndexFunc）的名称，value 为索引器函数。</p>
<p>通过 index.Add 添加了三个 Pod，再通过 index.ByIndex 函数查询使用 byUser 索引器下匹配 ernie 字段的 Pod 列表：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">erniePods</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">index</span>.<span style="color:#a6e22e">ByIndex</span>(<span style="color:#e6db74">&#34;byUser&#34;</span>, <span style="color:#e6db74">&#34;ernie&#34;</span>)
</code></pre></div><p>回看这四个类型：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Indexers maps a name to a IndexFunc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Indexers</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">IndexFunc</span>

<span style="color:#75715e">// IndexFunc knows how to provide an indexed value for an object.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IndexFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>)

<span style="color:#75715e">// Indices maps a name to an Index
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Indices</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">Index</span>

<span style="color:#75715e">// Index maps the indexed value to a set of keys in the store that match on that value
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Index</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">String</span>
</code></pre></div><ul>
<li>Indexers：存储索引器，key 为 索引器名称，value 为索引器实现函数；</li>
<li>IndexFunc：索引器函数，定义为接收一个资源对象，返回检索结果列表；</li>
<li>Indices：存储缓存器，key 为缓存器名称，value 为缓存数据；</li>
<li>Index：存储缓存数据，结构为 K/V。</li>
</ul>
<h4 id="indexer-索引器核心实现">Indexer 索引器核心实现</h4>
<p><code>vendor/k8s.io/client-go/tools/cache/thread_safe_store.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// ByIndex returns a list of items that match an exact value on the index function
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">threadSafeMap</span>) <span style="color:#a6e22e">ByIndex</span>(<span style="color:#a6e22e">indexName</span>, <span style="color:#a6e22e">indexKey</span> <span style="color:#66d9ef">string</span>) ([]<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">RUnlock</span>()

	<span style="color:#a6e22e">indexFunc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">indexers</span>[<span style="color:#a6e22e">indexName</span>]
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">indexFunc</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Index with name %s does not exist&#34;</span>, <span style="color:#a6e22e">indexName</span>)
	}

	<span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">indices</span>[<span style="color:#a6e22e">indexName</span>]

	<span style="color:#a6e22e">set</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">index</span>[<span style="color:#a6e22e">indexKey</span>]
	<span style="color:#a6e22e">list</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">interface</span>{}, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">set</span>.<span style="color:#a6e22e">Len</span>())
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">set</span>.<span style="color:#a6e22e">List</span>() {
		<span style="color:#a6e22e">list</span> = append(<span style="color:#a6e22e">list</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">key</span>])
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">list</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>ByIndex 接收两个参数：indexName（索引器名字）以及 indexKey（需要检索的 key），首先从 c.indexers 查找制定的索引器函数，然后从 c.indices 查找返回的缓存器函数，最后根据需要索引的 indexKey 从缓存数据中查到并返回。</p>
<p>⚠️ K8s 将 map 结构类型的 key 作为 Set 数据结构，实现 Set 去重特性。</p>
<h2 id="总结">总结</h2>
<p>本文从 Informer 的整体架构开始说起，介绍了各个核心组件的功能和作用，Kubernetes 之所以设计这样一个机制架构，核心是为了减少 Ectd 和 Kubernetes API Server 的压力，增强集群的稳定性。</p>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/kubernetes"> 
            Kubernetes</a>
            
          </ul>
        </div>
        <!-- previous -->
        
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://cloudnative.to/blog/client-go-informer/" data-toggle="tooltip" data-placement="top" title="Kubernetes client-go informer原理">&larr; 上一篇</a>
</li>
 
<li class="next">
<a href="https://cloudnative.to/blog/kubebuilder-summary/" data-toggle="tooltip" data-placement="top" title="Kubebuilder 中文翻译总结">下一篇 &rarr;</a>
</li>

</ul>
</div>


        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/kubernetes-programming-base/">Kubernetes 编程基础知识</a></li>
  
    <li><a href="/blog/study-groups/">如何学习开源项目源码</a></li>
  
    <li><a href="/blog/k8s-certificate/">一文带你彻底厘清 Kubernetes 中的证书工作机制</a></li>
  
    <li><a href="/blog/20190910-horizontal-pod-autoscaling-based-on-custom-istio-metrics/">基于自定义Istio指标的Pod水平自动缩放</a></li>
  
    <li><a href="/blog/architecting-kubernetes-clusters-choosing-a-worker-node-size/">构建 Kubernetes 集群 —— 选择工作节点数量和大小</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
    <!-- categories -->
<div class="bg-pink px-4 py-5 box-shadow mb-5">
  <h4 class="mb-4">分类</h4>
  <ul class="list-unstyled">
    <li class="border-bottom"><a href="/categories/devops" class="d-block pb-3 mt-3 text-capitalize">Devops</a></li>
    <li class="border-bottom"><a href="/categories/devsecops" class="d-block pb-3 mt-3 text-capitalize">Devsecops</a></li>
    <li class="border-bottom"><a href="/categories/envoy" class="d-block pb-3 mt-3 text-capitalize">Envoy</a></li>
    <li class="border-bottom"><a href="/categories/istio" class="d-block pb-3 mt-3 text-capitalize">Istio</a></li>
    <li class="border-bottom"><a href="/categories/kubernetes" class="d-block pb-3 mt-3 text-capitalize">Kubernetes</a></li>
    <li class="border-bottom"><a href="/categories/serverless" class="d-block pb-3 mt-3 text-capitalize">Serverless</a></li>
    <li class="border-bottom"><a href="/categories/service-mesh" class="d-block pb-3 mt-3 text-capitalize">Service mesh</a></li>
    <li class="border-bottom"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="d-block pb-3 mt-3 text-capitalize">云原生</a></li>
    <li class="border-bottom"><a href="/categories/%e5%85%b6%e4%bb%96" class="d-block pb-3 mt-3 text-capitalize">其他</a></li>
    <li class="border-bottom"><a href="/categories/%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">可观察性</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90" class="d-block pb-3 mt-3 text-capitalize">开源</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90%e7%a4%be%e5%8c%ba" class="d-block pb-3 mt-3 text-capitalize">开源社区</a></li>
    <li class="border-bottom"><a href="/categories/%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98" class="d-block pb-3 mt-3 text-capitalize">持续交付</a></li>
    <li class="border-bottom"><a href="/categories/%e7%a8%b3%e5%ae%9a%e6%80%a7" class="d-block pb-3 mt-3 text-capitalize">稳定性</a></li>
    <li class="border-bottom"><a href="/categories/%e8%be%b9%e7%bc%98%e8%ae%a1%e7%ae%97" class="d-block pb-3 mt-3 text-capitalize">边缘计算</a></li>
  </ul>
</div>

  <!-- tags -->
  

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <div class="mx-auto avatar-wrp">
        <img class="rounded-circle avatar-img" src="/profile/linxuyalun.png">
      </div>
      <p class="avatar-name">
        <strong class="text-dark "><a href="https://github.com/linxuyalun">林许亚伦</a></strong> 
      </p>
      <p>林许亚伦，上海交通大学学生，云原生爱好者。</p>
    </div>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#informer-机制">Informer 机制</a>
      <ul>
        <li><a href="#informer-机制架构设计">Informer 机制架构设计</a></li>
        <li><a href="#reflector">Reflector</a></li>
        <li><a href="#deltafifo">DeltaFIFO</a></li>
        <li><a href="#indexer">Indexer</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="云原生社区" width="60%"></a>
          <p class="text-light mb-5">云原生社区是国内最大的独立第三方云原生终端用户和泛开发者社区，由 CNCF 大使、开源意见领袖共同发起成立于 2020 年 5 月 12 日，提供云原生专业资讯，促进云原生产业发展。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativecn"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://mp.weixin.qq.com/s/vWlSdzz2MNdXRr0sd2-LFg"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5 address">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3"><a href="/city/beijing">北京</a>|<a href="/city/shanghai">上海</a>|<a href="/city/chengdu">成都</a>|<a href="/city/shenzhen">深圳</a>|<a href="/city/hangzhou/">杭州</a>|<a href="/city/guangzhou/">广州</a>|<a href="https://github.com/cloudnativeto/community/issues/55">武汉</a>|<a href="/city/nanjing">南京</a>|<a href="https://github.com/cloudnativeto/community/issues/61">西安</a>|<a href="/city/dalian">大连</a>|<a href="https://github.com/cloudnativeto/community/issues/52">长沙</a>|<a href="https://github.com/cloudnativeto/community/issues/66">苏州</a>|<a href="https://github.com/cloudnativeto/community/issues/67">珠海</a>|<a href="https://github.com/cloudnativeto/community/issues/78">重庆</a>|<a href="https://github.com/cloudnativeto/community/issues/82">济南</a>|<a href="https://github.com/cloudnativeto/community/issues/83">厦门</a>|<a href="https://github.com/cloudnativeto/community/issues/86">无锡</a>|<a href="https://github.com/cloudnativeto/community/issues/91">青岛</a>|<a href="https://github.com/cloudnativeto/community/issues/103">郑州</a>|<a href="https://github.com/cloudnativeto/community/issues/107">合肥</a></p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="128px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2021 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/policy"
                class="text-white">声明与政策</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- baidu tongji-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>


</body>

</html>
