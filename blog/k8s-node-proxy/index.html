<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="带你一步步理解 kube-proxy。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/k8s-node-proxy/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/k8s-node-proxy/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区（中国）" />
  <meta property="og:url" content="https://cloudnative.to/blog/k8s-node-proxy/" />
  <meta property="og:title" content="深入理解 Kubernetes 网络模型：自己实现 kube-proxy 的功能 | 云原生社区（中国）" />
  <meta property="og:description" content="带你一步步理解 kube-proxy。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2020-10-19T16:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-08-07T20:38:22&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/k8s-node-proxy/"
  },
  "headline": "深入理解 Kubernetes 网络模型：自己实现 kube-proxy 的功能",
  
  "datePublished": "2020-10-19T16:00:00+08:00",
  "dateModified": "2023-08-07T20:38:22+08:00",
  
  "author": {
    "@type": "Person",
    "name": "赵亚楠"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区（中国）",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "带你一步步理解 kube-proxy。"
}
</script>

  

  

  

  





  <title>深入理解 Kubernetes 网络模型：自己实现 kube-proxy 的功能 | 云原生社区（中国）</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="00e0a6c70d8c729f8501cb007a19c6fb" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区（中国）"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder/"><span>Kubebuilder 中文文档</span></a>
              
                <a class="dropdown-item" href="https://lib.jimmysong.io/"><span>云原生资料库</span></a>
              
                <a class="dropdown-item" href="https://istio.io/latest/zh/"><span>Istio 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>深入理解 Kubernetes 网络模型：自己实现 kube-proxy 的功能</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/%E8%B5%B5%E4%BA%9A%E6%A5%A0/">赵亚楠</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
    <i class="fa fa-language"></i>
    

  <span >
      <a href="/translators/%E5%BE%90%E9%B9%8F/">徐鹏</a></span>
    <span class="middot-divider"></span>
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/kubernetes/" class="text-capitalize">kubernetes</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2020-10-19
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 8145
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 37 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#背景知识">背景知识</a>
      <ul>
        <li><a href="#netfilter">Netfilter</a></li>
        <li><a href="#vip-与负载均衡-lb">VIP 与负载均衡 (LB)</a></li>
        <li><a href="#cross-host-网络模型">Cross-host 网络模型</a></li>
      </ul>
    </li>
    <li><a href="#节点代理模型">节点代理模型</a>
      <ul>
        <li><a href="#service-类型">Service 类型</a></li>
        <li><a href="#节点代理">节点代理</a></li>
        <li><a href="#节点代理的角色反向代理">节点代理的角色：反向代理</a></li>
        <li><a href="#性能问题">性能问题</a></li>
      </ul>
    </li>
    <li><a href="#测试环境">测试环境</a>
      <ul>
        <li><a href="#集群拓扑和测试环境">集群拓扑和测试环境</a></li>
        <li><a href="#创建一个-service">创建一个 Service</a></li>
        <li><a href="#可达性测试">可达性测试</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-userspace-socket-实现-proxy">实现：通过 userspace socket 实现 proxy</a>
      <ul>
        <li><a href="#中间人模型">中间人模型</a></li>
        <li><a href="#poc-实现">POC 实现</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-iptables-实现-proxy">实现：通过 iptables 实现 proxy</a>
      <ul>
        <li><a href="#host---clusterip单一后端">Host -&gt; ClusterIP（单一后端）</a></li>
        <li><a href="#host---clusterip-多个后端">Host -&gt; ClusterIP （多个后端）</a></li>
        <li><a href="#pod-app-a---clusterip-app-b">Pod (app A) -&gt; ClusterIP (app B)</a></li>
        <li><a href="#重新构造-iptables-规则">重新构造 iptables 规则</a></li>
        <li><a href="#进一步重新构造-iptables-规则">进一步重新构造 iptables 规则</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-ipvs-实现-proxy">实现：通过 ipvs 实现 proxy</a>
      <ul>
        <li><a href="#安装-ipvs">安装 IPVS</a></li>
        <li><a href="#验证-1">验证</a></li>
        <li><a href="#清理-2">清理</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-bpf-实现-proxy">实现：通过 bpf 实现 proxy</a>
      <ul>
        <li><a href="#先决条件">先决条件</a></li>
        <li><a href="#实现">实现</a></li>
        <li><a href="#编译并加载到内核中">编译并加载到内核中</a></li>
        <li><a href="#验证-2">验证</a></li>
        <li><a href="#清理-3">清理</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a>
      <ul>
        <li><a href="#参考文献">参考文献</a></li>
      </ul>
    </li>
    <li><a href="#附录">附录</a></li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#背景知识">背景知识</a>
      <ul>
        <li><a href="#netfilter">Netfilter</a></li>
        <li><a href="#vip-与负载均衡-lb">VIP 与负载均衡 (LB)</a></li>
        <li><a href="#cross-host-网络模型">Cross-host 网络模型</a></li>
      </ul>
    </li>
    <li><a href="#节点代理模型">节点代理模型</a>
      <ul>
        <li><a href="#service-类型">Service 类型</a></li>
        <li><a href="#节点代理">节点代理</a></li>
        <li><a href="#节点代理的角色反向代理">节点代理的角色：反向代理</a></li>
        <li><a href="#性能问题">性能问题</a></li>
      </ul>
    </li>
    <li><a href="#测试环境">测试环境</a>
      <ul>
        <li><a href="#集群拓扑和测试环境">集群拓扑和测试环境</a></li>
        <li><a href="#创建一个-service">创建一个 Service</a></li>
        <li><a href="#可达性测试">可达性测试</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-userspace-socket-实现-proxy">实现：通过 userspace socket 实现 proxy</a>
      <ul>
        <li><a href="#中间人模型">中间人模型</a></li>
        <li><a href="#poc-实现">POC 实现</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-iptables-实现-proxy">实现：通过 iptables 实现 proxy</a>
      <ul>
        <li><a href="#host---clusterip单一后端">Host -&gt; ClusterIP（单一后端）</a></li>
        <li><a href="#host---clusterip-多个后端">Host -&gt; ClusterIP （多个后端）</a></li>
        <li><a href="#pod-app-a---clusterip-app-b">Pod (app A) -&gt; ClusterIP (app B)</a></li>
        <li><a href="#重新构造-iptables-规则">重新构造 iptables 规则</a></li>
        <li><a href="#进一步重新构造-iptables-规则">进一步重新构造 iptables 规则</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-ipvs-实现-proxy">实现：通过 ipvs 实现 proxy</a>
      <ul>
        <li><a href="#安装-ipvs">安装 IPVS</a></li>
        <li><a href="#验证-1">验证</a></li>
        <li><a href="#清理-2">清理</a></li>
      </ul>
    </li>
    <li><a href="#实现通过-bpf-实现-proxy">实现：通过 bpf 实现 proxy</a>
      <ul>
        <li><a href="#先决条件">先决条件</a></li>
        <li><a href="#实现">实现</a></li>
        <li><a href="#编译并加载到内核中">编译并加载到内核中</a></li>
        <li><a href="#验证-2">验证</a></li>
        <li><a href="#清理-3">清理</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a>
      <ul>
        <li><a href="#参考文献">参考文献</a></li>
      </ul>
    </li>
    <li><a href="#附录">附录</a></li>
  </ul>
</nav>
</details>

                    
                    <p>本文译自 <a href="https://arthurchiao.art/blog/cracking-k8s-node-proxy/" target="_blank" rel="noopener">Cracking kubernetes node proxy (aka kube-proxy)</a>。</p>
<p>Kubernetes 中有几种类型的代理。其中有 <strong>node proxier</strong> 或 <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/" target="_blank" rel="noopener">kube-proxy</a>，它在每个节点上反映 Kubernetes API 中定义的服务，可以跨一组后端执行简单的 TCP/UDP/SCTP 流转发 [1]。</p>
<p>为了更好地理解节点代理模型，在这篇文章中，我们将用不同的方法设计和实现我们自己版本的 <code>kube-proxy</code>; 尽管这些只是 <code>toy-proxy</code>，但从<strong>透明流量拦截、转发、负载均衡</strong>等方面来说，它们的工作方式与 K8S 集群中运行的普通 <code>kube-proxy</code> 基本相同。</p>
<p>通过我们的 <code>toy-proxy</code> 程序，非 K8S 节点（不在 K8S 集群中）上的应用程序（无论是宿主本地应用程序，还是在 VM/容器中运行的应用程序）也可以通过 <strong>ClusterIP</strong> 访问 K8S 服务 &ndash; <strong>注意，在 kubernetes 的设计中，ClusterIP 只能在 K8S 集群节点中访问（在某种意义上，我们的 <code>toy-proxy</code> 程序将非 K8S 节点变成了 K8S 节点）。</strong></p>
<h2 id="背景知识">背景知识</h2>
<p>了解 Linux 内核中的流量拦截和代理需要具备以下背景知识。</p>
<h3 id="netfilter">Netfilter</h3>
<p>Netfilter 是 Linux 内核内部的<strong>包过滤和处理框架</strong>。如果你不熟悉 Iptables 和 Netfilter 体系结构，请参阅 <a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture" target="_blank" rel="noopener">A Deep Dive into Iptables and Netfilter Architecture</a></p>
<p>一些要点：</p>
<ul>
<li>主机上的<strong>所有数据包</strong>都将通过 netfilter 框架</li>
<li>在 netfilter 框架中有 <strong>5 个钩子</strong>点：<code>PRE_ROUTING</code>, <code>INPUT</code>, <code>FORWARD</code>, <code>OUTPUT</code>, <code>POST_ROUTING</code></li>
<li>命令行工具 <code>iptables</code> 可用于<strong>动态地将规则插入到钩子点中</strong></li>
<li>可以通过组合各种 <code>iptables</code> 规则来操作数据包（接受/重定向/删除/修改，等等）</li>
</ul>
<p>















<figure  id="figure-the-5-hook-points-in-netfilter-framework">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="The 5 hook points in netfilter framework" srcset="
               /blog/k8s-node-proxy/proxy_hooks_hu32cd341d175950bccf22249f40a39ef5_22212_5765932d51e3a90d8b28974815ebb8ba.webp 400w,
               /blog/k8s-node-proxy/proxy_hooks_hu32cd341d175950bccf22249f40a39ef5_22212_a3b00b99bf06ea6496db7de2640b0e14.webp 760w,
               /blog/k8s-node-proxy/proxy_hooks_hu32cd341d175950bccf22249f40a39ef5_22212_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_hooks_hu32cd341d175950bccf22249f40a39ef5_22212_5765932d51e3a90d8b28974815ebb8ba.webp"
               width="760"
               height="366"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      The 5 hook points in netfilter framework
    </figcaption></figure>

此外，这 5 个钩子点还可以与内核的其他网络设施，如内核路由子系统进行协同工作。</p>
<p>此外，在每个钩子点中，规则被组织到具有预定义优先级的不同链中。为了按目的管理链，链被进一步组织到表中。现在有 5 个表：</p>
<ul>
<li><code>filter</code>：做正常的过滤，如接受，拒绝/删，跳</li>
<li><code>nat</code>：网络地址转换，包括 SNAT（源 nat) 和 DNAT（目的 nat)</li>
<li><code>mangle</code>：修改包属性，例如 TTL</li>
<li><code>raw</code>：最早的处理点，连接跟踪前的特殊处理 (conntrack 或 CT，也包含在上图中，但这不是链）</li>
<li><code>security</code>：本文未涉及</li>
</ul>
<p>将表/链添加到上图中，我们可以得到更详细的视图：</p>
<p>















<figure  id="figure-iptables-tablechains-inside-hook-points">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="iptables table/chains inside hook points" srcset="
               /blog/k8s-node-proxy/proxy_hooks-and-tables_hu334a5b06ae4c1b7754cb8dcf03701434_75314_d549b07b96b70370663d5de0a833dad9.webp 400w,
               /blog/k8s-node-proxy/proxy_hooks-and-tables_hu334a5b06ae4c1b7754cb8dcf03701434_75314_03dba6f39ff91179fa28fbe34f857067.webp 760w,
               /blog/k8s-node-proxy/proxy_hooks-and-tables_hu334a5b06ae4c1b7754cb8dcf03701434_75314_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_hooks-and-tables_hu334a5b06ae4c1b7754cb8dcf03701434_75314_d549b07b96b70370663d5de0a833dad9.webp"
               width="760"
               height="455"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      iptables table/chains inside hook points
    </figcaption></figure>
</p>
<h3 id="vip-与负载均衡-lb">VIP 与负载均衡 (LB)</h3>
<p>虚拟 IP (IP) 将所有后端 IP 隐藏给客户端/用户，因此客户端/用户总是与 VIP 的后端服务通信，而不需要关心 VIP 后面有多少实例。</p>
<p>VIP 总是伴随着负载均衡，因为它需要在不同的后端之间分配流量。</p>
<p>















<figure  id="figure-vip-and-load-balancing">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="VIP and load balancing" srcset="
               /blog/k8s-node-proxy/proxy_vip-and-lb_hu0082f57c2c2cc41c2e5db6097bfa1b69_35020_07c645827b6ed3fe5e132e90f9e49a8a.webp 400w,
               /blog/k8s-node-proxy/proxy_vip-and-lb_hu0082f57c2c2cc41c2e5db6097bfa1b69_35020_2d674de9c996c2b521ca73c26e54591f.webp 760w,
               /blog/k8s-node-proxy/proxy_vip-and-lb_hu0082f57c2c2cc41c2e5db6097bfa1b69_35020_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_vip-and-lb_hu0082f57c2c2cc41c2e5db6097bfa1b69_35020_07c645827b6ed3fe5e132e90f9e49a8a.webp"
               width="760"
               height="504"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      VIP and load balancing
    </figcaption></figure>
</p>
<h3 id="cross-host-网络模型">Cross-host 网络模型</h3>
<p>主机 A 上的实例（容器、VM 等）如何与主机 B 上的另一个实例通信？有很多解决方案：</p>
<ul>
<li>直接路由：BGP 等</li>
<li>隧道：VxLAN, IPIP, GRE 等</li>
<li>NAT：例如 docker 的桥接网络模式</li>
<li>其它方式</li>
</ul>
<h2 id="节点代理模型">节点代理模型</h2>
<p>在 kubernetes 中，你可以将应用程序定义为 <code>Service</code>。<code>Service</code> 是一种抽象，它定义了一组 pod 的逻辑集和访问它们的策略。</p>
<h3 id="service-类型">Service 类型</h3>
<p>K8S 中定义了 4 种 <code>Service</code> 类型：</p>
<ul>
<li><code>ClusterIP</code>：通过 VIP 访问 Service，但该 VIP 只能在此集群内访问</li>
<li><code>NodePort</code>：通过 NodeIP:NodePort 访问 Service，这意味着该端口将暴露在集群内的所有节点上</li>
<li><code>ExternalIP</code>：与 <code>ClusterIP</code> 相同，但是这个 VIP 可以从这个集群之外访问</li>
<li><code>LoadBalancer</code></li>
</ul>
<p>这篇文章将关注 <code>ClusterIP</code>，但是其他三种类型在流量拦截和转发方面的底层实现非常相似。</p>
<h3 id="节点代理">节点代理</h3>
<p>一个 Service 有一个 VIP（本文中的 <code>ClusterIP</code>）和多个端点（后端 pod）。每个 pod 或节点都可以通过 VIP 直接访问应用程序。要做到这一点，节点代理程序需要在每个节点上运行，它应该能够透明地拦截到任何 <code>ClusterIP:Port</code>[注解 1] 的流量，并将它们重定向到一个或多个后端 pod。</p>
<p>















<figure  id="figure-kubernetes-proxier-model">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Kubernetes proxier model" srcset="
               /blog/k8s-node-proxy/proxy_k8s-proxier-model_hu6e1f2168d39a570b65caf605a63e1eb9_44765_961ddeed5f9b3ab3bf28fd666528177a.webp 400w,
               /blog/k8s-node-proxy/proxy_k8s-proxier-model_hu6e1f2168d39a570b65caf605a63e1eb9_44765_9515de70ff1e7c63a15d63b8b57800d4.webp 760w,
               /blog/k8s-node-proxy/proxy_k8s-proxier-model_hu6e1f2168d39a570b65caf605a63e1eb9_44765_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_k8s-proxier-model_hu6e1f2168d39a570b65caf605a63e1eb9_44765_961ddeed5f9b3ab3bf28fd666528177a.webp"
               width="760"
               height="206"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Kubernetes proxier model
    </figcaption></figure>
</p>
<blockquote>
<p>注解 1：</p>
<p>对 <code>ClusterIP</code> 的一个常见误解是，<code>ClusterIP</code> 是可访问的——它们不是通过定义访问的。如果 ping 一个 <code>ClusterIP</code>，可能会发现它不可访问。</p>
<p>根据定义，<strong>&lt;Protocol,ClusterIP,Port&gt;</strong> 元组独特地定义了一个服务（因此也定义了一个拦截规则）。例如，如果一个服务被定义为 <code>&lt;tcp,10.7.0.100,80&gt;</code>，那么代理只处理 <code>tcp:10.7.0.100:80</code> 的流量，其他流量，例如。<code>tcp:10.7.0.100:8080</code>, <code>udp:10.7.0.100:80</code> 将不会被代理。因此，也无法访问 ClusterIP（ICMP 流量）。</p>
<p>但是，如果你使用的是带有 IPVS 模式的 <code>kube-proxy</code>，那么确实可以通过 ping 访问 <code>ClusterIP</code>。这是因为 IPVS 模式实现比定义所需要的做得更多。你将在下面几节中看到不同之处。</p>
</blockquote>
<h3 id="节点代理的角色反向代理">节点代理的角色：反向代理</h3>
<p>想想节点代理的作用，在 K8S 网络模型中，它实际上是一个反向代理，也就是说，在每个节点上，它将：</p>
<ul>
<li>将所有后端 pod 隐藏到客户端</li>
<li>过滤所有出口流量（对后端的请求）</li>
</ul>
<p>对于 ingress traffic，它什么也不做。</p>
<h3 id="性能问题">性能问题</h3>
<p>如果我们在主机上有一个应用程序，并且在 K8S 集群中有 1K 个服务，那么我们永远无法猜测该应用程序在下一时刻将访问哪个服务（这里忽略网络策略）。因此，为了让应用程序能够访问所有服务，我们必须为节点上的所有服务应用所有代理规则。将这个想法推广到整个集群，这意味着：</p>
<p><strong>所有服务的代理规则应该应用于整个集群中的所有节点。</strong></p>
<p>在某种意义上，这是一个完全分布式的代理模型，因为任何节点都拥有集群的所有规则。</p>
<p>当集群变大时，这会导致严重的性能问题，因为每个节点上可能有数十万条规则 [6,7]。</p>
<h2 id="测试环境">测试环境</h2>
<h3 id="集群拓扑和测试环境">集群拓扑和测试环境</h3>
<p>我们将使用以下环境进行测试：</p>
<ul>
<li>一个 k8s 集群
<ul>
<li>一个 master 节点</li>
<li>一个 node 节点</li>
<li>网络解决方案：直接路由（PodIP 可直接路由）</li>
</ul>
</li>
<li>一个非 k8s 节点，但是它可以到达工作节点和 Pod（得益于直接路由网络方案）</li>
</ul>
<p>















<figure  id="figure-test-env">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="test env" srcset="
               /blog/k8s-node-proxy/proxy_test-env_huc0e6acd22275d83a17219e05931cef7e_74058_71417ed547b1bbdec161b3114e56c15f.webp 400w,
               /blog/k8s-node-proxy/proxy_test-env_huc0e6acd22275d83a17219e05931cef7e_74058_ad4ea73237b70f48b8226082efe4a533.webp 760w,
               /blog/k8s-node-proxy/proxy_test-env_huc0e6acd22275d83a17219e05931cef7e_74058_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_test-env_huc0e6acd22275d83a17219e05931cef7e_74058_71417ed547b1bbdec161b3114e56c15f.webp"
               width="760"
               height="385"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      test env
    </figcaption></figure>
</p>
<p>我们将在工作节点上部署 pod，并从 test 节点通过 <code>ClusterIP</code> 访问 pod 中的应用程序。</p>
<h3 id="创建一个-service">创建一个 Service</h3>
<p>创建一个简单的 <code>Statefulset</code>，其中包括一个 <code>Service</code>，该 <code>Service</code> 将有一个或多个后端 pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># see appendix for webapp.yaml</span>
</span></span><span class="line"><span class="cl">$ kubectl create -f webapp.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get svc -o wide webapp
</span></span><span class="line"><span class="cl">NAME     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE     SELECTOR
</span></span><span class="line"><span class="cl">webapp   ClusterIP   10.7.111.132   &lt;none&gt;        80/TCP    2m11s   <span class="nv">app</span><span class="o">=</span>webapp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pod -o wide <span class="p">|</span> grep webapp
</span></span><span class="line"><span class="cl">webapp-0    2/2     Running   <span class="m">0</span>    2m12s 10.5.41.204    node1    &lt;none&gt;  &lt;none&gt;
</span></span></code></pre></div><p>应用程序在带有 tcp 协议的 80 端口上运行。</p>
<h3 id="可达性测试">可达性测试</h3>
<p>首先访问 PodIP+Port:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl 10.5.41.204:80
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>成功的！然后用 <code>ClusterIP</code> 替换 PodIP 再试一次：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl 10.7.111.132:80
</span></span><span class="line"><span class="cl">^C
</span></span></code></pre></div><p>正如所料，它是不可访问的！</p>
<p>在下一节中，我们将研究如何使用不同的方法使 <code>ClusterIP</code> 可访问。</p>
<h2 id="实现通过-userspace-socket-实现-proxy">实现：通过 userspace socket 实现 proxy</h2>
<h3 id="中间人模型">中间人模型</h3>
<p>最容易理解的实现是在此主机上的通信路径中插入我们的 <code>toy-proxy</code> 作为中间人：对于从本地客户端到 ClusterIP:Port 的每个连接，<strong>我们拦截该连接并将其分割为两个单独的连接</strong>:</p>
<ul>
<li>本地客户端和 <code>toy-proxy</code> 之间的连接</li>
<li>连接 <code>toy-proxy</code> 和后端 pod</li>
</ul>
<p>实现此目的的最简单方法是在用户空间中实现它：</p>
<ul>
<li><code>监听资源</code>：启动一个守护进程，监听 K8S apiserver、监视服务 (ClusterIP) 和端点 (Pod) 的变化</li>
<li><code>代理通信</code>：对于从本地客户端到服务 (ClusterIP) 的每个连接请求，通过充当中间人来拦截请求</li>
<li><code>动态应用代理规则</code>：对于任何 Service/Endpoint 更新，相应地更改 <code>toy-proxy</code> 连接设置</li>
</ul>
<p>对于我们上面的测试应用 <code>webapp</code>，数据流程如下图：</p>
<p>















<figure  id="figure-userspace-proxier">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="userspace-proxier" srcset="
               /blog/k8s-node-proxy/proxy_userspace-proxier_hu9082d6a31e4883e3abfd9a839459509f_32580_988f401c1712f9579f336cdba279658a.webp 400w,
               /blog/k8s-node-proxy/proxy_userspace-proxier_hu9082d6a31e4883e3abfd9a839459509f_32580_02625968caf183dfecc2fcaf9d559880.webp 760w,
               /blog/k8s-node-proxy/proxy_userspace-proxier_hu9082d6a31e4883e3abfd9a839459509f_32580_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_userspace-proxier_hu9082d6a31e4883e3abfd9a839459509f_32580_988f401c1712f9579f336cdba279658a.webp"
               width="760"
               height="478"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      userspace-proxier
    </figcaption></figure>
</p>
<h3 id="poc-实现">POC 实现</h3>
<p>让我们来看看上图的概念验证实现。</p>
<h4 id="代码">代码</h4>
<p>以下代码省略了一些错误处理代码，便于阅读：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">clusterIP</span> <span class="o">:=</span> <span class="s">&#34;10.7.111.132&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">podIP</span> <span class="o">:=</span> <span class="s">&#34;10.5.41.204&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">port</span> <span class="o">:=</span> <span class="mi">80</span>
</span></span><span class="line"><span class="cl">	<span class="nx">proto</span> <span class="o">:=</span> <span class="s">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">addRedirectRules</span><span class="p">(</span><span class="nx">clusterIP</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">proto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">createProxy</span><span class="p">(</span><span class="nx">podIP</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">proto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">addRedirectRules</span><span class="p">(</span><span class="nx">clusterIP</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">port</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">proto</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="s">&#34;iptables&#34;</span><span class="p">,</span> <span class="s">&#34;-t&#34;</span><span class="p">,</span> <span class="s">&#34;nat&#34;</span><span class="p">,</span> <span class="s">&#34;-A&#34;</span><span class="p">,</span> <span class="s">&#34;OUTPUT&#34;</span><span class="p">,</span> <span class="s">&#34;-p&#34;</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;-d&#34;</span><span class="p">,</span> <span class="nx">clusterIP</span><span class="p">,</span> <span class="s">&#34;--dport&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="s">&#34;-j&#34;</span><span class="p">,</span> <span class="s">&#34;REDIRECT&#34;</span><span class="p">,</span> <span class="s">&#34;--to-port&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createProxy</span><span class="p">(</span><span class="nx">podIP</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">port</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">proto</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">host</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">listener</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="nx">proto</span><span class="p">,</span> <span class="nx">net</span><span class="p">.</span><span class="nf">JoinHostPort</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">port</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">inConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">outConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">proto</span><span class="p">,</span> <span class="nx">net</span><span class="p">.</span><span class="nf">JoinHostPort</span><span class="p">(</span><span class="nx">podIP</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">port</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="nx">out</span> <span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPConn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">			<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Proxying %v &lt;-&gt; %v &lt;-&gt; %v &lt;-&gt; %v\n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">in</span><span class="p">.</span><span class="nf">RemoteAddr</span><span class="p">(),</span> <span class="nx">in</span><span class="p">.</span><span class="nf">LocalAddr</span><span class="p">(),</span> <span class="nx">out</span><span class="p">.</span><span class="nf">LocalAddr</span><span class="p">(),</span> <span class="nx">out</span><span class="p">.</span><span class="nf">RemoteAddr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="nf">copyBytes</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">wg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="nf">copyBytes</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">wg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">inConn</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPConn</span><span class="p">),</span> <span class="nx">outConn</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPConn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">listener</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">copyBytes</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">src</span> <span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPConn</span><span class="p">,</span> <span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">src</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="s">&#34;use of closed network connection&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;io.Copy error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dst</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">src</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="一些解释">一些解释</h4>
<h5 id="traffic-拦截">traffic 拦截</h5>
<p>我们想拦截所有发往 <code>ClusterIP:Port</code> 的流量，但是在这个节点上任何设备都没有配置<code>ClusterIP</code>，因此我们无法执行诸如 listen（ClusterIP，Port）之类的操作，那么我们如何才能拦截呢？答案是：使用<code>iptables/netfilter</code> 提供的 <code>REDIRECT</code> 能力。</p>
<p>以下命令会将所有发往 <code>ClusterIP:Port</code> 的流量定向到 <code>localhost:Port</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo iptables -t nat -A OUTPUT -p tcp -d <span class="nv">$CLUSTER_IP</span> --dport <span class="nv">$PORT</span> -j REDIRECT --to-port <span class="nv">$PORT</span>
</span></span></code></pre></div><p>如果你现在不能理解这一点，不要害怕。稍后我们将讨论这个问题。</p>
<p>通过下面命令的输出来验证这一点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -L -n
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>      destination
</span></span><span class="line"><span class="cl">REDIRECT   tcp  --  0.0.0.0/0   10.7.111.132         tcp dpt:80 redir ports <span class="m">80</span>
</span></span></code></pre></div><p>在代码中，函数 <code>addRedirectRules()</code> 包装了上述过程。</p>
<h5 id="创建-proxy">创建 proxy</h5>
<p>函数 <code>createProxy()</code> 创建用户空间代理，并执行双向转发。</p>
<h4 id="可达性测试-1">可达性测试</h4>
<p>编译代码并执行二进制文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go build toy-proxy-userspace.go
</span></span><span class="line"><span class="cl">$ sudo ./toy-proxy-userspace
</span></span></code></pre></div><p>现在测试访问：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>成功！我们的代理传达的信息是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo ./toy-proxy-userspace
</span></span><span class="line"><span class="cl">Creating proxy between &lt;host ip&gt;:53912 &lt;-&gt; 127.0.0.1:80 &lt;-&gt; &lt;host ip&gt;:40194 &lt;-&gt; 10.5.41.204:80
</span></span></code></pre></div><p>表示，对于原 <code>&lt;host ip&gt;:53912 &lt;-&gt; 10.7.111.132:80</code> 的连接请求，将其拆分为两个连接：</p>
<ol>
<li><code>&lt;host ip&gt;:53912 &lt;-&gt; 127.0.0.1:80</code></li>
<li><code>&lt;host ip&gt;:40194 &lt;-&gt; 10.5.41.204:80</code></li>
</ol>
<p>删除这条规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -L -n --line-numbers
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">num  target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl"><span class="m">2</span>    REDIRECT   tcp  --  0.0.0.0/0   10.7.111.132         tcp dpt:80 redir ports <span class="m">80</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -t nat -D OUTPUT &lt;num&gt;</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -D OUTPUT <span class="m">2</span>
</span></span></code></pre></div><p>或者删除（刷新）所有规则，如果你把 iptabels 弄的一团糟的情况下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -F <span class="c1"># delete all rules</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -X <span class="c1"># delete all custom chains</span>
</span></span></code></pre></div><h4 id="改进">改进</h4>
<p>在这个 <code>toy-proxy</code> 实现中，我们拦截了 <code>ClusterIP:80</code> 到 <code>localhost:80</code>，但是如果该主机上的本机应用程序也想使用 <code>localhost:80</code> 怎么办？此外，如果多个服务都公开 80 端口会怎样？显然，我们需要区分这些应用程序或服务。解决这个问题的正确方法是：为每个代理分配一个未使用的临时端口 TmpPort，拦截 <code>ClusterIP:Port</code> 到 <code>local:TmpPort</code>。例如，app1 使用 10001, app2 使用 10002。</p>
<p>其次，上面的代码只处理一个后端，如果有多个后端 pod 怎么办？因此，我们需要通过负载均衡算法将请求分发到不同的后端 pod。</p>
<p>















<figure  id="figure-userspace-proxier-2">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="userspace-proxier-2" srcset="
               /blog/k8s-node-proxy/proxy_userspace-proxier-2_huf67b69a0faa8def717a3172c121fcb25_37904_c90ddc39ff57b2df64617aa0103cb9d0.webp 400w,
               /blog/k8s-node-proxy/proxy_userspace-proxier-2_huf67b69a0faa8def717a3172c121fcb25_37904_2242801d47f71b19e960c1ddbbe49fc5.webp 760w,
               /blog/k8s-node-proxy/proxy_userspace-proxier-2_huf67b69a0faa8def717a3172c121fcb25_37904_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_userspace-proxier-2_huf67b69a0faa8def717a3172c121fcb25_37904_c90ddc39ff57b2df64617aa0103cb9d0.webp"
               width="760"
               height="478"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      userspace-proxier-2
    </figcaption></figure>
</p>
<h4 id="优缺点">优缺点</h4>
<p>这种方法非常容易理解和实现，但是，它的性能会很差，因为它必须在两端以及内核和用户空间内存之间复制字节。</p>
<p>我们没有在这上面花太多时间，如果你感兴趣，可以在这里查看用户空间 <code>kube-proxy</code> 的简单实现。</p>
<p>接下来，让我们看看实现这个任务的另一种方法。</p>
<h2 id="实现通过-iptables-实现-proxy">实现：通过 iptables 实现 proxy</h2>
<p>用户空间代理程序的主要瓶颈来自内核-用户空间切换和数据复制。<strong>如果我们可以完全在内核空间中实现代理</strong>，它将在性能上大大提高，从而击败用户空间的代理。<code>iptables</code> 可用于实现这一目标。</p>
<p>在开始之前，让我们首先弄清楚在执行 <code>curl ClusterIP:Port</code> 时的流量路径，然后研究如何使用 <code>iptables</code> 规则使其可访问。</p>
<h3 id="host---clusterip单一后端">Host -&gt; ClusterIP（单一后端）</h3>
<p><code>ClusterIP</code> 不存在于任何网络设备上，所以为了让我们的数据包最终到达后端 Pod，我们需要将 <code>ClusterIP</code> 转换为 PodIP（可路由），即：</p>
<ul>
<li>条件：匹配 <code>dst=ClusterIP,proto=tcp,dport=80</code> 的数据包</li>
<li>操作：将数据包的 IP 报头中的 <code>dst=ClusterIP</code> 替换为 <code>dst=PodIP</code></li>
</ul>
<p>用网络术语来说，这是一个网络地址转换 (NAT) 过程。</p>
<h4 id="在哪里做-dnat">在哪里做 DNAT</h4>
<p>通过 curl 查看出口数据包路径（下图展示了数据流向过程）：</p>
<p>















<figure  id="figure-host-to-clusterip-dnat">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="host-to-clusterip-dnat" srcset="
               /blog/k8s-node-proxy/proxy_host-to-clusterip-dnat_huad7d6b1d23181dfcfc8262cef1a50023_98381_9600b74b370001618a8fdf08b3e437b3.webp 400w,
               /blog/k8s-node-proxy/proxy_host-to-clusterip-dnat_huad7d6b1d23181dfcfc8262cef1a50023_98381_d927eb4a584eab8329b30cbe0a96a1df.webp 760w,
               /blog/k8s-node-proxy/proxy_host-to-clusterip-dnat_huad7d6b1d23181dfcfc8262cef1a50023_98381_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_host-to-clusterip-dnat_huad7d6b1d23181dfcfc8262cef1a50023_98381_9600b74b370001618a8fdf08b3e437b3.webp"
               width="760"
               height="453"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      host-to-clusterip-dnat
    </figcaption></figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;curl process&gt; -&gt; raw -&gt; CT -&gt; mangle -&gt; dnat -&gt; filter -&gt; security -&gt; snat -&gt; &lt;ROUTING&gt; -&gt; mangle -&gt; snat -&gt; NIC
</span></span></code></pre></div><p>很明显，在 OUTPUT 钩中只有一个 dnat（链），我们可以在其中进行 DNAT。</p>
<p>让我们看看我们将如何进行黑客入侵。</p>
<h4 id="检查当前的-nat-规则">检查当前的 NAT 规则</h4>
<p><code>NAT</code> 规则被组织到 <code>nat</code> 表中。检查 <code>nat</code> 表中的当前规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># -t &lt;table&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -L list rules</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -n numeric output</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -L -n
</span></span><span class="line"><span class="cl">Chain PREROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">DOCKER     all  --  0.0.0.0/0    !127.0.0.0/8   ADDRTYPE match dst-type LOCAL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain POSTROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span></code></pre></div><p>输出显示除了与 DOCKER 相关的规则外，没有其他规则。这些 DOCKER 规则是 DOCKER 在安装时插入的，但它们不会影响我们在这篇文章中的实验。所以我们忽略它们。</p>
<h4 id="增加-dnat-规则">增加 DNAT 规则</h4>
<p>为了便于查看，我们不会用 go 代码包装 <code>iptables</code> 命令，而是直接显示命令本身。</p>
<blockquote>
<p>注意：在继续之前，请确保删除了在上一节中添加的所有规则。</p>
</blockquote>
<p>确认目前无法访问 ClusterIP：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">^C
</span></span></code></pre></div><p>现在添加我们的出口 NAT 规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat ENV
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_IP</span><span class="o">=</span>10.7.111.132
</span></span><span class="line"><span class="cl"><span class="nv">POD_IP</span><span class="o">=</span>10.5.41.204
</span></span><span class="line"><span class="cl"><span class="nv">PORT</span><span class="o">=</span><span class="m">80</span>
</span></span><span class="line"><span class="cl"><span class="nv">PROTO</span><span class="o">=</span>tcp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -p               &lt;protocol&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -A               add rule</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --dport          &lt;dst port&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -d               &lt;dst ip&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -j               jump to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --to-destination &lt;ip&gt;:&lt;port&gt;</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -A OUTPUT -p <span class="nv">$PROTO</span> --dport <span class="nv">$PORT</span> -d <span class="nv">$CLUSTER_IP</span> -j DNAT --to-destination <span class="nv">$POD_IP</span>:<span class="nv">$PORT</span>
</span></span></code></pre></div><p>再次检查规则表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -L -n
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>      destination
</span></span><span class="line"><span class="cl">DNAT       tcp  --  0.0.0.0/0   10.7.111.132   tcp dpt:80 to:10.5.41.204:80
</span></span></code></pre></div><p>我们可以看到规则已经被添加。</p>
<h4 id="测试可达性">测试可达性</h4>
<p>现在再一次访问：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>就是这样！访问成功。</p>
<p>但是等等！我们期望出口的交通应该是正确的，但我们没有添加任何 NAT 规则的入口路径，怎么可能交通是正常的两个方向？事实证明，当你为一个方向添加一个 NAT 规则时，Linux 内核会自动为另一个方向添加保留规则！这与 conntrack (CT，连接跟踪）模块协同工作。</p>
<p>















<figure  id="figure-host-to-clusterip-dnat-ct">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="host-to-clusterip-dnat-ct" srcset="
               /blog/k8s-node-proxy/proxy_host-to-clusterip-dnat-ct_huf5fa03ef7c625a87f1840c5bc6327608_106547_e648f91daeb724d469a488e8735ae0ed.webp 400w,
               /blog/k8s-node-proxy/proxy_host-to-clusterip-dnat-ct_huf5fa03ef7c625a87f1840c5bc6327608_106547_4b1c9ab89b89282102d61b5e4070711a.webp 760w,
               /blog/k8s-node-proxy/proxy_host-to-clusterip-dnat-ct_huf5fa03ef7c625a87f1840c5bc6327608_106547_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_host-to-clusterip-dnat-ct_huf5fa03ef7c625a87f1840c5bc6327608_106547_e648f91daeb724d469a488e8735ae0ed.webp"
               width="760"
               height="453"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      host-to-clusterip-dnat-ct
    </figcaption></figure>
</p>
<h4 id="清理">清理</h4>
<p>删除这些规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -L -n --line-numbers
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">num  target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl"><span class="m">2</span>    DNAT       tcp  --  0.0.0.0/0   10.7.111.132   tcp dpt:80 to:10.5.41.204:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -t &lt;table&gt; -D &lt;chain&gt; &lt;num&gt;</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -D OUTPUT <span class="m">2</span>
</span></span></code></pre></div><h3 id="host---clusterip-多个后端">Host -&gt; ClusterIP （多个后端）</h3>
<p>在上一节中，我们展示了如何使用一个后端 Pod 执行 NAT。现在让我们看看多后端情况。</p>
<blockquote>
<p>注意：在继续之前，请确保删除了在上一节中添加的所有规则。</p>
</blockquote>
<h4 id="伸缩-webapp">伸缩 webapp</h4>
<p>首先扩大我们的服务到 2 个后端 pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl scale sts webapp --replicas<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">statefulset.apps/webapp scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pod -o wide <span class="p">|</span> grep webapp
</span></span><span class="line"><span class="cl">webapp-0   2/2     Running   <span class="m">0</span>   1h24m   10.5.41.204    node1    &lt;none&gt; &lt;none&gt;
</span></span><span class="line"><span class="cl">webapp-1   2/2     Running   <span class="m">0</span>   11s     10.5.41.5      node1    &lt;none&gt; &lt;none&gt;
</span></span></code></pre></div><h4 id="通过负载平衡添加-dnat-规则">通过负载平衡添加 DNAT 规则</h4>
<p>我们需要 <code>iptables</code> 中的 <code>statistic</code> 模块以概率的方式将请求分发到后端 pod，这样才能达到负载均衡的效果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># -m &lt;module&gt;</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -A OUTPUT -p <span class="nv">$PROTO</span> --dport <span class="nv">$PORT</span> -d <span class="nv">$CLUSTER_IP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -m statistic --mode random --probability 0.5  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -j DNAT --to-destination <span class="nv">$POD1_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -A OUTPUT -p <span class="nv">$PROTO</span> --dport <span class="nv">$PORT</span> -d <span class="nv">$CLUSTER_IP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -m statistic --mode random --probability 1.0  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -j DNAT --to-destination <span class="nv">$POD2_IP</span>:<span class="nv">$PORT</span>
</span></span></code></pre></div><p>上面的命令指定在两个 pod 之间随机分配请求，每个都有 50% 的概率。</p>
<p>现在检查这些规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -L -n
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target  prot opt <span class="nb">source</span>      destination
</span></span><span class="line"><span class="cl">DNAT    tcp  --  0.0.0.0/0   10.7.111.132  tcp dpt:80 statistic mode random probability 0.50000000000 to:10.5.41.204:80
</span></span><span class="line"><span class="cl">DNAT    tcp  --  0.0.0.0/0   10.7.111.132  tcp dpt:80 statistic mode random probability 1.00000000000 to:10.5.41.5:80
</span></span></code></pre></div><p>















<figure  id="figure-host-to-clusterip-lb-ct">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="host-to-clusterip-lb-ct" srcset="
               /blog/k8s-node-proxy/proxy_host-to-clusterip-lb-ct_hua38a8d048355d0d5f50924cf38e8a9eb_123406_c1d077dbf8461eef13d95c489aed6520.webp 400w,
               /blog/k8s-node-proxy/proxy_host-to-clusterip-lb-ct_hua38a8d048355d0d5f50924cf38e8a9eb_123406_a8e0d0abc245f1b54339d3aa584bc908.webp 760w,
               /blog/k8s-node-proxy/proxy_host-to-clusterip-lb-ct_hua38a8d048355d0d5f50924cf38e8a9eb_123406_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_host-to-clusterip-lb-ct_hua38a8d048355d0d5f50924cf38e8a9eb_123406_c1d077dbf8461eef13d95c489aed6520.webp"
               width="760"
               height="453"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      host-to-clusterip-lb-ct
    </figcaption></figure>
</p>
<h4 id="验证">验证</h4>
<p>现在，我们来验证下负载均衡是否生效。我们发出 8 个 请求，并捕获到这个主机通信的真实 PodIPs:</p>
<p>在测试节点上打开一个 shell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="k">for</span> i in <span class="o">{</span>1..8<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> &gt;/dev/null<span class="p">;</span> sleep 1<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></div><p>测试节点上的另一个 shell 窗口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tcpdump -nn -i eth0 port <span class="nv">$PORT</span> <span class="p">|</span> grep <span class="s2">&#34;GET /&#34;</span>
</span></span><span class="line"><span class="cl">10.21.0.7.48306 &gt; 10.5.41.5.80:   ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10.21.0.7.48308 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10.21.0.7.48310 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10.21.0.7.48312 &gt; 10.5.41.5.80:   ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10.21.0.7.48314 &gt; 10.5.41.5.80:   ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10.21.0.7.48316 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10.21.0.7.48318 &gt; 10.5.41.5.80:   ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10.21.0.7.48320 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span></code></pre></div><p>在 Pod1 中有 4 次，在 Pod2 中有 4 次，每个 pod 有 50%，这正是我们所期望的。</p>
<h4 id="清理-1">清理</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -L -n --line-numbers
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">num  target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl"><span class="m">2</span>    DNAT    tcp  --  0.0.0.0/0   10.7.111.132  tcp dpt:80 statistic mode random probability 0.50000000000 to:10.5.41.204:80
</span></span><span class="line"><span class="cl"><span class="m">3</span>    DNAT    tcp  --  0.0.0.0/0   10.7.111.132  tcp dpt:80 statistic mode random probability 1.00000000000 to:10.5.41.5:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ iptables -t nat -D OUTPUT <span class="m">2</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -D OUTPUT <span class="m">3</span>
</span></span></code></pre></div><h3 id="pod-app-a---clusterip-app-b">Pod (app A) -&gt; ClusterIP (app B)</h3>
<p>如果想通过 hostA 上的 <code>Pod A</code> 通过 <code>ClusterIP</code> 访问 <code>Pod B</code>，B 的 Pod 驻留在 hostB 上，我们应该做什么？</p>
<p>实际上，这与 <code>Host -&gt; ClusterIP</code> 情况非常相似，但是有一点需要注意：在执行 NAT 之后，源节点 (hostA) 需要将包发送到目的地 Pod 所在的正确目的地节点 (hostB)。根据不同的跨主机网络解决方案，这有很大不同：</p>
<ol>
<li>对于直接路由的情况下，主机只是发送数据包。对应的有这些解决方案：
<ul>
<li>calico + bird</li>
<li>cilium + kube-router（Cilium BGP 的默认解决方案）</li>
<li>cilium + bird（实际上这只是我们的测试环境网络解决方案）</li>
</ul>
</li>
<li>对于隧道的情况，每个主机上必须有一个代理，它在 DNAT 之后执行 encap，在 SNAT 之前执行 decap。这些解决方案包括：
<ul>
<li>calico + VxLAN 模式</li>
<li>flannel + IPIP 模式</li>
<li>flannel + VxLAN 模式</li>
<li>cilium + VxLAN 模式</li>
</ul>
</li>
<li>像 aws 的 ENI 模式：类似于直接路由，但不需要 BGP 代理
<ul>
<li>cilium + ENI 模式</li>
</ul>
</li>
</ol>
<p>下图展示了隧道的情况：</p>
<p>















<figure  id="figure-tunneling">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="tunneling" srcset="
               /blog/k8s-node-proxy/proxy_tunneling_hudd27817631bb1a427e8e2d50e9758fd9_86556_b124d08dac357ec312292d722000913f.webp 400w,
               /blog/k8s-node-proxy/proxy_tunneling_hudd27817631bb1a427e8e2d50e9758fd9_86556_5034afc1bcddaa2eb87fa44f83267384.webp 760w,
               /blog/k8s-node-proxy/proxy_tunneling_hudd27817631bb1a427e8e2d50e9758fd9_86556_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/k8s-node-proxy/proxy_tunneling_hudd27817631bb1a427e8e2d50e9758fd9_86556_b124d08dac357ec312292d722000913f.webp"
               width="760"
               height="353"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      tunneling
    </figcaption></figure>
</p>
<p>代理与隧道相关的职责包括：</p>
<ul>
<li><strong>同步所有节点之间的隧道信息</strong>，例如描述哪个实例在哪个节点上的信息</li>
<li><strong>在 DNAT 之后对 pod 流量执行封装</strong>：对于所有的出口流量，例如来自 hostA 的 <code>dst=&lt;PodIP&gt;</code>，其中 PodIP 在 hostB 上，通过添加另一个头来封装数据包，例如 VxLAN 头，其中封装头有 <code>src=hostA_IP,dst=hostB_IP</code></li>
<li><strong>在 SNAT 之前对 Pod 流量执行解封装</strong>：解封装每个入口封装的数据包：删除外层（例如 VxLAN 标头）</li>
</ul>
<p>同时，主机需要决定：</p>
<ul>
<li>哪些数据包应该交给解码器（pod 流量），哪些不应该（例如主机流量）</li>
<li>哪些包应该封装（pod 流量），哪些不应该（例如主机流量）</li>
</ul>
<h3 id="重新构造-iptables-规则">重新构造 iptables 规则</h3>
<blockquote>
<p>注意：在继续之前，请确保删除了在上一节中添加的所有规则。</p>
</blockquote>
<p>当你有大量的 Service 时，每个节点上的 iptables 规则将相当复杂，因此你需要进行一些结构化工作来组织这些规则。</p>
<p>在本节中，我们将在 nat 表中创建几个专用的 iptables 链，具体如下：</p>
<ul>
<li>链 <code>KUBE-SERVICES</code>：拦截 nat 表的输出链中所有到此链的出口流量，如果它们被指定为 ClusterIP，则执行 DNAT</li>
<li>链 <code>KUBE-SVC-WEBAPP</code>：如果 <code>dst</code>、<code>proto</code> 和 <code>port</code> 匹配，则拦截该链 <code>KUBE-SERVICES</code> 中的所有流量</li>
<li>链 <code>KUBE-SEP-WEBAPP1</code>：拦截 50% 的流量在 <code>KUBE-SVC-WEBAPP</code> 到这里</li>
<li>链 <code>KUBE-SEP-WEBAPP2</code>：拦截 50% 的流量在 <code>KUBE-SVC-WEBAPP</code> 到这里</li>
</ul>
<p>DNAT 路径现在为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">OUTPUT -&gt; KUBE-SERVICES -&gt; KUBE-SVC-WEBAPP --&gt; KUBE-SEP-WEBAPP1
</span></span><span class="line"><span class="cl">                                         <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                                          <span class="se">\-</span>-&gt; KUBE-SEP-WEBAPP2
</span></span></code></pre></div><p>如果你有多个 Service，DNAT 路径如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">OUTPUT -&gt; KUBE-SERVICES -&gt; KUBE-SVC-A --&gt; KUBE-SEP-A1
</span></span><span class="line"><span class="cl">                      <span class="p">|</span>              <span class="se">\-</span>-&gt; KUBE-SEP-A2
</span></span><span class="line"><span class="cl">                      <span class="p">|</span>
</span></span><span class="line"><span class="cl">                      <span class="p">|</span>--&gt; KUBE-SVC-B --&gt; KUBE-SEP-B1
</span></span><span class="line"><span class="cl">                      <span class="p">|</span>              <span class="se">\-</span>-&gt; KUBE-SEP-B2
</span></span><span class="line"><span class="cl">                      <span class="p">|</span>
</span></span><span class="line"><span class="cl">                      <span class="p">|</span>--&gt; KUBE-SVC-C --&gt; KUBE-SEP-C1
</span></span><span class="line"><span class="cl">                                     <span class="se">\-</span>-&gt; KUBE-SEP-C2
</span></span></code></pre></div><p>iptables 命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat add-dnat-structured.sh
</span></span><span class="line"><span class="cl"><span class="nb">source</span> ../ENV
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -x
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">KUBE_SVCS</span><span class="o">=</span><span class="s2">&#34;KUBE-SERVICES&#34;</span>        <span class="c1"># chain that serves as kubernetes service portal</span>
</span></span><span class="line"><span class="cl"><span class="nv">SVC_WEBAPP</span><span class="o">=</span><span class="s2">&#34;KUBE-SVC-WEBAPP&#34;</span>     <span class="c1"># chain that serves as DNAT entrypoint for webapp</span>
</span></span><span class="line"><span class="cl"><span class="nv">WEBAPP_EP1</span><span class="o">=</span><span class="s2">&#34;KUBE-SEP-WEBAPP1&#34;</span>    <span class="c1"># chain that performs dnat to pod1</span>
</span></span><span class="line"><span class="cl"><span class="nv">WEBAPP_EP2</span><span class="o">=</span><span class="s2">&#34;KUBE-SEP-WEBAPP2&#34;</span>    <span class="c1"># chain that performs dnat to pod2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># OUTPUT -&gt; KUBE-SERVICES</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -N <span class="nv">$KUBE_SVCS</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -A OUTPUT -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j <span class="nv">$KUBE_SVCS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># KUBE-SERVICES -&gt; KUBE-SVC-WEBAPP</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -N <span class="nv">$SVC_WEBAPP</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -A <span class="nv">$KUBE_SVCS</span> -p <span class="nv">$PROTO</span> -s 0.0.0.0/0 -d <span class="nv">$CLUSTER_IP</span> --dport <span class="nv">$PORT</span> -j <span class="nv">$SVC_WEBAPP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># KUBE-SVC-WEBAPP -&gt; KUBE-SEP-WEBAPP*</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -N <span class="nv">$WEBAPP_EP1</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -N <span class="nv">$WEBAPP_EP2</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -A <span class="nv">$WEBAPP_EP1</span> -p <span class="nv">$PROTO</span> -s 0.0.0.0/0 -d 0.0.0.0/0 --dport <span class="nv">$PORT</span> -j DNAT --to-destination <span class="nv">$POD1_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -A <span class="nv">$WEBAPP_EP2</span> -p <span class="nv">$PROTO</span> -s 0.0.0.0/0 -d 0.0.0.0/0 --dport <span class="nv">$PORT</span> -j DNAT --to-destination <span class="nv">$POD2_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -A <span class="nv">$SVC_WEBAPP</span> -p <span class="nv">$PROTO</span> -s 0.0.0.0/0 -d 0.0.0.0/0 -m statistic --mode random --probability 0.5  -j <span class="nv">$WEBAPP_EP1</span>
</span></span><span class="line"><span class="cl">sudo iptables -t nat -A <span class="nv">$SVC_WEBAPP</span> -p <span class="nv">$PROTO</span> -s 0.0.0.0/0 -d 0.0.0.0/0 -m statistic --mode random --probability 1.0  -j <span class="nv">$WEBAPP_EP2</span>
</span></span></code></pre></div><p>现在测试我们设计：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./add-dnat-structured.sh
</span></span><span class="line"><span class="cl">++ <span class="nv">KUBE_SVCS</span><span class="o">=</span>KUBE-SERVICES
</span></span><span class="line"><span class="cl">++ <span class="nv">SVC_WEBAPP</span><span class="o">=</span>KUBE-SVC-WEBAPP
</span></span><span class="line"><span class="cl">++ <span class="nv">WEBAPP_EP1</span><span class="o">=</span>KUBE-SEP-WEBAPP1
</span></span><span class="line"><span class="cl">++ <span class="nv">WEBAPP_EP2</span><span class="o">=</span>KUBE-SEP-WEBAPP2
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -N KUBE-SERVICES
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -A OUTPUT -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SERVICES
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -N KUBE-SVC-WEBAPP
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -A KUBE-SERVICES -p tcp -s 0.0.0.0/0 -d 10.7.111.132 --dport <span class="m">80</span> -j KUBE-SVC-WEBAPP
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -N KUBE-SEP-WEBAPP1
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -N KUBE-SEP-WEBAPP2
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -A KUBE-SEP-WEBAPP1 -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 --dport <span class="m">80</span> -j DNAT --to-destination 10.5.41.204:80
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -A KUBE-SEP-WEBAPP2 -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 --dport <span class="m">80</span> -j DNAT --to-destination 10.5.41.5:80
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -A KUBE-SVC-WEBAPP -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -m statistic --mode random --probability 0.5 -j KUBE-SEP-WEBAPP1
</span></span><span class="line"><span class="cl">++ sudo iptables -t nat -A KUBE-SVC-WEBAPP -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -m statistic --mode random --probability 1.0 -j KUBE-SEP-WEBAPP2
</span></span></code></pre></div><p>检查这些规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo iptables -t nat -L -n
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SEP-WEBAPP1 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.5.41.204:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SEP-WEBAPP2 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.5.41.5:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SERVICES <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">KUBE-SVC-WEBAPP  tcp  --  0.0.0.0/0            10.7.111.132         tcp dpt:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SVC-WEBAPP <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">KUBE-SEP-WEBAPP1  tcp  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.50000000000
</span></span><span class="line"><span class="cl">KUBE-SEP-WEBAPP2  tcp  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 1.00000000000
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>成功！</p>
<p>如果你将上面的输出与普通的 <code>kube-proxy</code> 规则进行比较，这两个规则是非常相似的，下面是从启用 <code>kube-proxy</code> 的节点提取的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target         prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SERVICES <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target                     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">KUBE-SVC-YK2SNH4V42VSDWIJ  tcp  --  0.0.0.0/0            10.7.22.18           /* default/nginx:web cluster IP */ tcp dpt:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SVC-YK2SNH4V42VSDWIJ <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target                     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">KUBE-SEP-GL2BLSI2B4ICU6WH  all  --  0.0.0.0/0            0.0.0.0/0            /* default/nginx:web */ statistic mode random probability 0.33332999982
</span></span><span class="line"><span class="cl">KUBE-SEP-AIRRSG3CIF42U3PX  all  --  0.0.0.0/0            0.0.0.0/0            /* default/nginx:web */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SEP-GL2BLSI2B4ICU6WH <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target          prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">DNAT            tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/nginx:web */ tcp to:10.244.3.181:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain KUBE-SEP-AIRRSG3CIF42U3PX <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target          prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">DNAT            tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/nginx:web */ tcp to:10.244.3.182:80
</span></span></code></pre></div><h3 id="进一步重新构造-iptables-规则">进一步重新构造 iptables 规则</h3>
<p>TODO：为来自集群外部的流量添加规则。</p>
<h2 id="实现通过-ipvs-实现-proxy">实现：通过 ipvs 实现 proxy</h2>
<p>虽然基于 iptables 的代理在性能上优于基于用户空间的代理，但在集群服务过多的情况下也会导致性能严重下降 [6,7]。</p>
<p>本质上，这是因为 iptables 判决是基于链的，它是一个复杂度为 O(n) 的线性算法。iptables 的一个好的替代方案是 IPVS——内核中的 L4 负载均衡器，它在底层使用 ipset（哈希实现），因此复杂度为 O(1)。</p>
<p>让我们看看如何使用 ipvs 实现相同的目标。</p>
<blockquote>
<p>注意：在继续之前，请确保删除了在上一节中添加的所有规则。</p>
</blockquote>
<h3 id="安装-ipvs">安装 IPVS</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ yum install -y ipvsadm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -l  list load balancing status</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -n  numeric output</span>
</span></span><span class="line"><span class="cl">$ ipvsadm -ln
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span></code></pre></div><p>默认无规则</p>
<h4 id="增加虚拟真正的-services">增加虚拟/真正的 services</h4>
<p>使用 ipvs 实现负载均衡：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># -A/--add-service           add service</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -t/--tcp-service &lt;address&gt; VIP + Port</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -s &lt;method&gt;                scheduling-method</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -r/--real-server &lt;address&gt; real backend IP + Port</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -m                         masquerading (NAT)</span>
</span></span><span class="line"><span class="cl">$ ipvsadm -A -t <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span> -s rr
</span></span><span class="line"><span class="cl">$ ipvsadm -a -t <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span> -r <span class="nv">$POD1_IP</span> -m
</span></span><span class="line"><span class="cl">$ ipvsadm -a -t <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span> -r <span class="nv">$POD2_IP</span> -m
</span></span></code></pre></div><p>或者使用我的脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./ipvs-add-server.sh
</span></span><span class="line"><span class="cl">Adding virtual server CLUSTER_IP:PORT<span class="o">=</span>10.7.111.132:80 ...
</span></span><span class="line"><span class="cl">Adding real servers ...
</span></span><span class="line"><span class="cl">10.7.111.132:80 -&gt; 10.5.41.204
</span></span><span class="line"><span class="cl">10.7.111.132:80 -&gt; 10.5.41.5
</span></span><span class="line"><span class="cl">Done
</span></span></code></pre></div><p>再次检查状态：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ipvsadm -ln
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span class="line"><span class="cl">TCP  10.7.111.132:80 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.5.41.5:80                 Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.5.41.204:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span></code></pre></div><p>一些解释：</p>
<ul>
<li>对于所有发往 <code>10.7.111.132:80</code> 的流量，将负载均衡到 <code>10.5.41.5:80</code> 和 <code>10.5.41.204:80</code></li>
<li>使用轮询 (rr) 算法实现负载均衡</li>
<li>两个后端，每个后端的权重为 1（各 50％）</li>
<li>使用 MASQ（增强型 SNAT）在 VIP 和 RealIP 之间进行流量转发</li>
</ul>
<h3 id="验证-1">验证</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="k">for</span> i in <span class="o">{</span>1..8<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> &gt;/dev/null<span class="p">;</span> sleep 1<span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ tcpdump -nn -i eth0 port <span class="nv">$PORT</span> <span class="p">|</span> grep <span class="s2">&#34;HTTP: GET&#34;</span>
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49556 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49558 &gt; 10.5.41.5.80  : ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49560 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49562 &gt; 10.5.41.5.80  : ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49566 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49568 &gt; 10.5.41.5.80  : ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49570 &gt; 10.5.41.204.80: ... HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">IP 10.21.0.7.49572 &gt; 10.5.41.5.80  : ... HTTP: GET / HTTP/1.1
</span></span></code></pre></div><p>完美！</p>
<h3 id="清理-2">清理</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./ipvs-del-server.sh
</span></span><span class="line"><span class="cl">Deleting real servers ...
</span></span><span class="line"><span class="cl">10.7.111.132:80 -&gt; 10.5.41.204
</span></span><span class="line"><span class="cl">10.7.111.132:80 -&gt; 10.5.41.5
</span></span><span class="line"><span class="cl">Deleting virtual server CLUSTER_IP:PORT<span class="o">=</span>10.7.111.132:80 ...
</span></span><span class="line"><span class="cl">Done
</span></span></code></pre></div><h2 id="实现通过-bpf-实现-proxy">实现：通过 bpf 实现 proxy</h2>
<p>这也是一个 <code>O(1)</code> 代理，但是与 IPVS 相比具有更高的性能。</p>
<p>让我们看看如何在不到 100 行 C 代码中使用 eBPF 实现代理功能。</p>
<h3 id="先决条件">先决条件</h3>
<p>如果你有足够的时间和兴趣来阅读 eBPF/BPF，可以考虑阅读 <a href="https://docs.cilium.io/en/v1.6/bpf/" target="_blank" rel="noopener">Cilium: BPF and XDP Reference Guide</a>，它对开发人员来说是一个完美的 BPF 文档。</p>
<h3 id="实现">实现</h3>
<p>让我们看看出口部分的基本概念：</p>
<ol>
<li>对于所有流量，匹配 <code>dst=CLUSTER_IP &amp;&amp; proto==TCP &amp;&amp; dport==80</code></li>
<li>更改目标 IP：<code>CLUSTER_IP -&gt; POD_IP</code></li>
<li>更新 IP 和 TCP 报头中的校验和文件（否则我们的数据包将被丢弃）</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__section</span><span class="p">(</span><span class="s">&#34;egress&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">tc_egress</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">__be32</span> <span class="n">cluster_ip</span> <span class="o">=</span> <span class="mh">0x846F070A</span><span class="p">;</span> <span class="c1">// 10.7.111.132
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">__be32</span> <span class="n">pod_ip</span> <span class="o">=</span> <span class="mh">0x0529050A</span><span class="p">;</span>     <span class="c1">// 10.5.41.5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">l3_off</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>    <span class="c1">// IP header offset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">l4_off</span> <span class="o">=</span> <span class="n">l3_off</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">// TCP header offset: l3_off + sizeof(struct iphdr)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__be32</span> <span class="n">sum</span><span class="p">;</span>                     <span class="c1">// IP checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">data_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data_end</span> <span class="o">&lt;</span> <span class="n">data</span> <span class="o">+</span> <span class="n">l4_off</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// not our packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">l3_off</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ip4</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">!=</span> <span class="n">cluster_ip</span> <span class="o">||</span> <span class="n">ip4</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span> <span class="cm">/* || tcp-&gt;dport == 80 */</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// DNAT: cluster_ip -&gt; pod_ip, then update L3 and L4 checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sum</span> <span class="o">=</span> <span class="n">csum_diff</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pod_ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">skb_store_bytes</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l3_off</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pod_ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">l3_csum_replace</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l3_off</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">l4_csum_replace</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l4_off</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="n">BPF_F_PSEUDO_HDR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>对于入口部分，非常类似于出口代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__section</span><span class="p">(</span><span class="s">&#34;ingress&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">tc_ingress</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">__be32</span> <span class="n">cluster_ip</span> <span class="o">=</span> <span class="mh">0x846F070A</span><span class="p">;</span> <span class="c1">// 10.7.111.132
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">__be32</span> <span class="n">pod_ip</span> <span class="o">=</span> <span class="mh">0x0529050A</span><span class="p">;</span>     <span class="c1">// 10.5.41.5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">l3_off</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>    <span class="c1">// IP header offset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">l4_off</span> <span class="o">=</span> <span class="n">l3_off</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">// TCP header offset: l3_off + sizeof(struct iphdr)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__be32</span> <span class="n">sum</span><span class="p">;</span>                     <span class="c1">// IP checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">data_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data_end</span> <span class="o">&lt;</span> <span class="n">data</span> <span class="o">+</span> <span class="n">l4_off</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// not our packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">l3_off</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ip4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">!=</span> <span class="n">pod_ip</span> <span class="o">||</span> <span class="n">ip4</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span> <span class="cm">/* || tcp-&gt;dport == 80 */</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// SNAT: pod_ip -&gt; cluster_ip, then update L3 and L4 header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sum</span> <span class="o">=</span> <span class="n">csum_diff</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cluster_ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">skb_store_bytes</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l3_off</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cluster_ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">l3_csum_replace</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l3_off</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">l4_csum_replace</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l4_off</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="n">BPF_F_PSEUDO_HDR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">__license</span><span class="p">[]</span> <span class="n">__section</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;GPL&#34;</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="编译并加载到内核中">编译并加载到内核中</h3>
<p>现在使用我的小脚本编译和加载到内核：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./compile-and-load.sh
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">++ sudo tc filter show dev eth0 egress
</span></span><span class="line"><span class="cl">filter protocol all pref <span class="m">49152</span> bpf chain <span class="m">0</span>
</span></span><span class="line"><span class="cl">filter protocol all pref <span class="m">49152</span> bpf chain <span class="m">0</span> handle 0x1 toy-proxy-bpf.o:<span class="o">[</span>egress<span class="o">]</span> direct-action not_in_hw id <span class="m">18</span> tag f5f39a21730006aa jited
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">++ sudo tc filter show dev eth0 ingress
</span></span><span class="line"><span class="cl">filter protocol all pref <span class="m">49152</span> bpf chain <span class="m">0</span>
</span></span><span class="line"><span class="cl">filter protocol all pref <span class="m">49152</span> bpf chain <span class="m">0</span> handle 0x1 toy-proxy-bpf.o:<span class="o">[</span>ingress<span class="o">]</span> direct-action not_in_hw id <span class="m">19</span> tag b41159c5873bcbc9 jited
</span></span></code></pre></div><p>脚本是这样的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat compile-and-load.sh
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -x
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">NIC</span><span class="o">=</span>eth0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># compile c code into bpf code</span>
</span></span><span class="line"><span class="cl">clang -O2 -Wall -c toy-proxy-bpf.c -target bpf -o toy-proxy-bpf.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># add tc queuing discipline (egress and ingress buffer)</span>
</span></span><span class="line"><span class="cl">sudo tc qdisc del dev <span class="nv">$NIC</span> clsact 2&gt;<span class="p">&amp;</span><span class="m">1</span> &gt;/dev/null
</span></span><span class="line"><span class="cl">sudo tc qdisc add dev <span class="nv">$NIC</span> clsact
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># load bpf code into the tc egress and ingress hook respectively</span>
</span></span><span class="line"><span class="cl">sudo tc filter add dev <span class="nv">$NIC</span> egress bpf da obj toy-proxy-bpf.o sec egress
</span></span><span class="line"><span class="cl">sudo tc filter add dev <span class="nv">$NIC</span> ingress bpf da obj toy-proxy-bpf.o sec ingress
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># show info</span>
</span></span><span class="line"><span class="cl">sudo tc filter show dev <span class="nv">$NIC</span> egress
</span></span><span class="line"><span class="cl">sudo tc filter show dev <span class="nv">$NIC</span> ingress
</span></span></code></pre></div><h3 id="验证-2">验证</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl <span class="nv">$CLUSTER_IP</span>:<span class="nv">$PORT</span>
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>完美！</p>
<h3 id="清理-3">清理</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo tc qdisc del dev <span class="nv">$NIC</span> clsact 2&gt;<span class="p">&amp;</span><span class="m">1</span> &gt;/dev/null
</span></span></code></pre></div><h2 id="总结">总结</h2>
<p>在这篇文章中，我们用不同的方法手工实现了 <code>kube-proxy</code> 的核心功能。希望你现在对 kubernetes 节点代理有了更好的理解，以及关于网络的其他一些配置。</p>
<p>在这篇文章中使用的代码和脚本：<a href="https://github.com/icyxp/icyxp.github.io/tree/mastercode" target="_blank" rel="noopener">这里</a>。</p>
<h3 id="参考文献">参考文献</h3>
<ol>
<li><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/" target="_blank" rel="noopener">Kubernetes Doc: CLI - kube-proxy</a></li>
<li><a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/0011-ipvs-proxier.md" target="_blank" rel="noopener">kubernetes/enhancements: enhancements/0011-ipvs-proxier.md</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types" target="_blank" rel="noopener">Kubernetes Doc: Service types</a></li>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/proxies/" target="_blank" rel="noopener">Proxies in Kubernetes - Kubernetes</a></li>
<li><a href="https://medium.com/@benmeier_/a-quick-minimal-ipvs-load-balancer-demo-d5cc42d0deb4" target="_blank" rel="noopener">A minimal IPVS Load Balancer demo</a></li>
<li><a href="https://docs.google.com/presentation/d/1BaIAywY2qqeHtyGZtlyAp89JIZs59MZLKcFLxKE6LyM/edit#slide=id.p3" target="_blank" rel="noopener">Scaling Kubernetes to Support 50,000 Services</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/37230013" target="_blank" rel="noopener">华为云在 K8S 大规模场景下的 Service 性能优化实践</a></li>
</ol>
<h2 id="附录">附录</h2>
<p>webapp.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;webapp&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># affinity:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#   nodeAffinity:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#     requiredDuringSchedulingIgnoredDuringExecution:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#       nodeSelectorTerms:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#       - matchExpressions:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#         - key: kubernetes.io/hostname</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#           operator: In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#           values:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#           - node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">smoke</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">Equal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-slim:0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span></code></pre></div>
                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/iptables/">iptables</a>
  
  <a class="badge badge-light" href="/tag/ipvs/">IPVS</a>
  
  <a class="badge badge-light" href="/tag/bpf/">BPF</a>
  
  <a class="badge badge-light" href="/tag/netfilter/">netfilter</a>
  
  <a class="badge badge-light" href="/tag/kube-proxy/">kube-proxy</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/%E8%B5%B5%E4%BA%9A%E6%A5%A0/"><img class="avatar mr-3 avatar-circle" src="/author/%E8%B5%B5%E4%BA%9A%E6%A5%A0/avatar_hu930effec276c7637ba7278ad15fdbba3_14784_270x270_fill_q75_lanczos_center.jpg" alt="赵亚楠"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/%E8%B5%B5%E4%BA%9A%E6%A5%A0/">赵亚楠</a></p>
      
      <p class="card-text">大型互联网公司高级软件工程师，专注于网络 SDN，云原生，虚拟化，分布式存储，以及底层技术等。</p>
      
    </div>
  </div>


  


  
  
    




  




<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/academy-6/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>基于 Red Hat OpenShift 4 构建 Paas、DevOps 平台</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/zero-trust-service-mesh/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>服务网格的零信任安全</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/k8s-node-proxy/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/create-a-ipvs-svc-without-container/">在非容器环境上实现散装的 IPVS SVC</a></li>
      
      <li><a href="/blog/bpf-intro/">eBPF 技术简介</a></li>
      
      <li><a href="/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/">理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持</a></li>
      
      <li><a href="/blog/how-cilium-enhances-istio-with-socket-aware-bpf-programs/">使用Cilium增强Istio—通过Socket感知BPF程序</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2023 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
