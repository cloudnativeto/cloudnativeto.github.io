<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>Zookeeper operator 实战 | 云原生社区</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Zookeeper作为最新完成 operator 化的组件，除了可以快速部署以外，还实现了 Operator 对 scale up/down 的进度干预，控制 rolling 的重启顺序，感知组件实际运行状态等，具体实现请阅读对于相关章节。">
  
  <meta name="author" content="Cloud Native Community">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">

  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="Cloud Native Community"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/about">社区介绍</a>
                
                <a class="dropdown-item" href="/team">初创成员</a>
                
                <a class="dropdown-item" href="https://github.com/cloudnativeto/community/issues/50">城市站</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog">博客</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/kubebuilder">Kubebuilder</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contact">联系</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/job">招聘</a>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->

	<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">Zookeeper operator 实战</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">Zookeeper作为最新完成 operator 化的组件，除了可以快速部署以外，还实现了 Operator 对 scale up/down 的进度干预，控制 rolling 的重启顺序，感知组件实际运行状态等，具体实现请阅读对于相关章节。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->

	

<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/zookeeper-operator-1.png'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">Operator</div>
        </div>
        <div class="card-meta mb-2">作者  <strong class="text-dark"><a href="https://github.com/Ghostbaby">朱慧君</a></strong>
          
            发表于 <strong class="text-dark">2020年6月8日</strong></div>
        <hr>
        <div class="content">
          <h2 id="导言">导言</h2>
<p>2018年 kubecon 大会上，阿里的陈俊大佬分享 Node-operator 的主题让我印象深刻，回来之后开始着手研究 Operator。正好当时老板希望能够将公司正在使用的 Nosql 组件容器化，顺势给老板安利一波 Operator 的思想。随后以 opentsdb 的容器为开端，后续完成一系列组件容器化，一路走来不断学习和借鉴其他 operator 的先进经验。Zookeeper作为最新完成 operator 化的组件，除了可以快速部署以外，还实现了 Operator 对 scale up/down 的进度干预，控制 rolling 的重启顺序，感知组件实际运行状态等，具体实现请阅读对于相关章节。</p>
<h2 id="功能需求">功能需求</h2>
<p>目前 operator 主要实现如下功能：</p>
<ul>
<li>快速部署</li>
<li>安全伸缩容</li>
<li>自动化监控</li>
<li>故障自愈</li>
<li>可视化操作</li>
</ul>
<h2 id="crd">CRD</h2>
<p>Operator 设计第一步是定义声明式接口的 Item，spec 主要包含节点资源、监控组件、副本数、持久化存储。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: database.ymm-inc.com/v1beta1
<span style="color:#66d9ef">kind</span>: ZooKeeper
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: zookeeper-sample
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">version</span>: v3<span style="color:#ae81ff">.5.6</span>
  <span style="color:#66d9ef">cluster</span>:
    <span style="color:#66d9ef">name</span>: test
    <span style="color:#66d9ef">resources</span>:
      <span style="color:#66d9ef">requests</span>:
        <span style="color:#66d9ef">cpu</span>: 1000m
        <span style="color:#66d9ef">memory</span>: 2Gi
      <span style="color:#66d9ef">limits</span>:
        <span style="color:#66d9ef">cpu</span>: 2000m
        <span style="color:#66d9ef">memory</span>: 2Gi
    <span style="color:#66d9ef">exporter</span>:
      <span style="color:#66d9ef">exporter</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#66d9ef">exporterImage</span>: harbor.ymmoa.com/monitoring/zookeeper_exporter
      <span style="color:#66d9ef">exporterVersion</span>: v3<span style="color:#ae81ff">.5.6</span>
      <span style="color:#66d9ef">disableExporterProbes</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">nodeCount</span>: <span style="color:#ae81ff">3</span>
    <span style="color:#66d9ef">storage</span>:
      <span style="color:#66d9ef">size</span>: 100Gi
</code></pre></div><h2 id="架构图">架构图</h2>
<p>Operator 主要包含：Deploy、Monitor、Scale 三个大模块。</p>
<ul>
<li>Deploy：主要用于生成和创建 Statefulset、Service、ConfigMap、PV 等原生资源，用于快速部署 zookeeper 集群。</li>
<li>Monitor：主要用于生成和创建 ServiceMonitor、PrometheusRule 资源，用于自动化注册 target、添加告警策略，实现对集群的监控和告警。</li>
<li>Scale：主要用于把控扩缩容以及滚动升级的进度，确保以最少的主从切换完成重启。</li>
</ul>
<p><img src="/images/blog/zookeeper-operator-2.png" alt="架构图"></p>
<h2 id="具体方案">具体方案</h2>
<h3 id="快速部署">快速部署</h3>
<h4 id="基本知识">基本知识</h4>
<ul>
<li>
<p>Kubernetes Labels</p>
<ul>
<li>Labels：是一对 key/value，被关联到特定对象上，标签一般用来表示同一类资源，用来划分特定的对象，一个对象可以有多个标签，但是，key 值必须是唯一的。这里我们将在 list-watch 的时候用这个 labels 进行过滤，从所有的 Kubernetes event 中过滤出符合特定 label 的 event，用来触发 operator 的主流程。</li>
</ul>
</li>
<li>
<p>Kubernetes Informer</p>
<ul>
<li>
<p>watch：可以是 Kubernetes 内建的资源或者是自定义的资源。当 reflector 通过 watch API 接收到有关新资源实例存在的通知时，它使用相应的列表 API 获取新创建的对象，并将其放入 watchHandler 函数内的 Delta Fifo 队列中。</p>
</li>
<li>
<p>Informer：informer 从 Delta Fifo 队列中弹出对象。执行此操作的功能是 processLoop。Base controller 的作用是保存对象以供以后检索，并调用我们的控制器将对象传递给它。</p>
</li>
<li>
<p>Indexer：索引器提供对象的索引功能。典型的索引用例是基于对象标签创建索引。 Indexer 可以根据多个索引函数维护索引。Indexer 使用线程安全的数据存储来存储对象及其键。 在 Store 中定义了一个名为 MetaNamespaceKeyFunc 的默认函数，该函数生成对象的键作为该对象的 <!-- raw HTML omitted --> / <!-- raw HTML omitted --> 组合。</p>
</li>
</ul>
</li>
</ul>
<h4 id="labels">Labels</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">labels</span>:
  <span style="color:#66d9ef">app</span>: zookeeper
  <span style="color:#66d9ef">app.kubernetes.io/instance</span>: zookeeper-sample
  <span style="color:#66d9ef">app.kubernetes.io/managed-by</span>: zookeeper-operator
  <span style="color:#66d9ef">app.kubernetes.io/name</span>: zookeeper
  <span style="color:#66d9ef">app.kubernetes.io/part-of</span>: zookeeper
  <span style="color:#66d9ef">component</span>: zookeeper
  <span style="color:#66d9ef">zookeeper</span>: zookeeper-sample
</code></pre></div><h4 id="节点部署">节点部署</h4>
<h5 id="容器分类">容器分类</h5>
<ul>
<li>InitContainer
<ul>
<li>配置文件初始化容器，主要用于 zk config 文件复制到工作区域。</li>
</ul>
</li>
<li>Container
<ul>
<li>主进程容器</li>
<li>监控容器</li>
<li>Agent</li>
</ul>
</li>
</ul>
<h5 id="初始化容器">初始化容器</h5>
<blockquote>
<p>zoo.cfg.dynamic，这个文件同样以 configmap 方式挂入主容器，主要用于zk节点发现和注册，下面将详细介绍下这个zk 3.5之后的特性。</p>
</blockquote>
<ul>
<li>具体可以参考 ZooKeeper 动态重新配置</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">server.1<span style="color:#f92672">=</span>zookeeper-sample-0.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.2<span style="color:#f92672">=</span>zookeeper-sample-1.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.3<span style="color:#f92672">=</span>zookeeper-sample-2.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.4<span style="color:#f92672">=</span>zookeeper-sample-3.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.5<span style="color:#f92672">=</span>zookeeper-sample-4.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
</code></pre></div><ul>
<li>更新目录权限</li>
</ul>
<blockquote>
<p>设置 data 和 logs 目录的权限，确保 zk 能够正常启动。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">echo <span style="color:#e6db74">&#34;chowning /data to zookeeper:zookeeper&#34;</span>
chown -v zookeeper:zookeeper /data
 
echo <span style="color:#e6db74">&#34;chowning /logs to zookeeper:zookeeper&#34;</span>
chown -v zookeeper:zookeeper /logs
</code></pre></div><h5 id="主进程容器">主进程容器</h5>
<ul>
<li>环境变量</li>
</ul>
<blockquote>
<p>POD_IP、POD_NAME，主要将 node 的 pod ip 和名称传到 pod 内部，方便容器内部调用。</p>
<p>ZK_SERVER_HEAP，这变量为限制 zk 启动 heapsize 大小，由 operator 根据 request 内部大小设置，zk启动会读取这个变量。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">name</span>: POD_IP
  <span style="color:#66d9ef">valueFrom</span>:
    <span style="color:#66d9ef">fieldRef</span>:
      <span style="color:#66d9ef">apiVersion</span>: v1
      <span style="color:#66d9ef">fieldPath</span>: status.podIP
- <span style="color:#66d9ef">name</span>: POD_NAME
  <span style="color:#66d9ef">valueFrom</span>:
    <span style="color:#66d9ef">fieldRef</span>:
      <span style="color:#66d9ef">apiVersion</span>: v1
      <span style="color:#66d9ef">fieldPath</span>: metadata.name
- <span style="color:#66d9ef">name</span>: ZK_SERVER_HEAP
  <span style="color:#66d9ef">value</span>: <span style="color:#e6db74">&#34;2048&#34;</span>
- <span style="color:#66d9ef">name</span>: ZK_CLIENT_HEAP
  <span style="color:#66d9ef">value</span>: <span style="color:#e6db74">&#34;512&#34;</span>
</code></pre></div><ul>
<li>Readiness探针</li>
</ul>
<blockquote>
<p>主要通过 zk 客户端端口传入 ruok 命令，检查返回码，返回 imok 认为 zk node 已经准备完毕，zk node 将会被更新到上面说到的 zoo.cfg.dynamic 文件，zk cluster 将会自动发现该节点。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">ZK_CLIENT_PORT<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ZK_CLIENT_PORT<span style="color:#66d9ef">:-</span>2181<span style="color:#e6db74">}</span>
OK<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo ruok | nc 127.0.0.1 $ZK_CLIENT_PORT<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$OK<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;imok&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    exit <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">else</span>
    exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><h5 id="监控容器">监控容器</h5>
<blockquote>
<p>github 项目（https://github.com/dabealu/zookeeper-exporter）
exporter 跟随主进程一同启动，后续会介绍如何注册到 prometheus target 以及告警策略。</p>
</blockquote>
<h5 id="访问控制">访问控制</h5>
<ul>
<li>暴露端口</li>
</ul>
<blockquote>
<p>9114：该端口为 exporter 服务端口，通过 servicemonitor 注册 prometheus target 时将通过 labels 匹配该端口。</p>
<p>1988：该端口为 zk-agent 服务端口，通过该接口 operator 可以查询到当前节点运行状态，后面会详解介绍。</p>
<p>2181：该端口为 zk 客户端端口，该端口创建 Kubernetes headless 模式 svc，方便客户端一次获取所有节点 ip。</p>
<p>3888：选举 leader 使用</p>
<p>2888：集群内机器通讯使用（ Leader 监听此端口）</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">ports</span>:
- <span style="color:#66d9ef">name</span>: client
  <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">2181</span>
  <span style="color:#66d9ef">protocol</span>: TCP
  <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">2181</span>
- <span style="color:#66d9ef">name</span>: server
  <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">2888</span>
  <span style="color:#66d9ef">protocol</span>: TCP
  <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">2888</span>
- <span style="color:#66d9ef">name</span>: leader-election
  <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">3888</span>
  <span style="color:#66d9ef">protocol</span>: TCP
  <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">3888</span>
- <span style="color:#66d9ef">name</span>: http-metrics
  <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">9114</span>
  <span style="color:#66d9ef">protocol</span>: TCP
  <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">9114</span>
- <span style="color:#66d9ef">name</span>: http-agent
  <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">1988</span>
  <span style="color:#66d9ef">protocol</span>: TCP
  <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">1988</span>
</code></pre></div><ul>
<li>暴露方式</li>
</ul>
<blockquote>
<p>这里主要 kubernetes service 的两种模式：Headless 和 Cluster</p>
<blockquote>
<p>Headless Services：简单而言就是，每次访问 headless service，kube-dns 将返回后端一组 ip，在我们这种场景下，即会返回 es 所有节点 ip 给客户端，再由客户端自己判断通过哪个 ip 访问 es 集群。</p>
<p>Cluster：这种模式是默认配置，创建此类 service 之后，将分配一个 cluster ip，这个 ip 类似 vip，每次访问这个 service name，kube-dns 将会随机返回一个节点 ip。</p>
</blockquote>
<p>operator 在创建 service 的时候，上面两种都会创建，headless 类型主要给 kubernetes 内部应用访问，cluster 类型主要通过 NodePort 暴露给外部应用访问。</p>
</blockquote>
<h5 id="配置信息">配置信息</h5>
<ul>
<li>配置文件</li>
</ul>
<pre><code class="language-textmate" data-lang="textmate">autopurge.purgeInterval=24
autopurge.snapRetainCount=20
initLimit=10
syncLimit=5
skipACL=yes
maxClientCnxns=300
4lw.commands.whitelist=cons, envi, conf, crst, srvr, stat, mntr, ruok
tickTime=2000
dataDir=/data
dataLogDir=/logs
reconfigEnabled=true
standaloneEnabled=false
dynamicConfigFile=/conf/zoo.cfg.dynamic.c00000002
</code></pre><h5 id="数据存储">数据存储</h5>
<ul>
<li>PersistentVolume</li>
</ul>
<blockquote>
<p>StorageClass PROVISIONER: diskplugin.csi.alibabacloud.com，阿里云CSI插件实现了 Kubernetes 平台使用阿里云云存储卷的生命周期管理，支持动态创建、挂载、使用云数据卷。 当前的 CSI 实现基于kubernetes 1.14以上的版本。</p>
<p>云盘 CSI 插件支持动态创建云盘数据卷、挂载数据卷。云盘是一种块存储类型，只能同时被一个负载使用(ReadWriteOnce)。</p>
<p>operator 会将 CRD 中配置的 pvc 信息，透传到 sts 中去，并挂载到 zk data 目录下 。</p>
</blockquote>
<h3 id="自动化监控">自动化监控</h3>
<h4 id="监控注册">监控注册</h4>
<h5 id="servicemonitor">ServiceMonitor</h5>
<p><code>selector.matchLabels</code>：这里通过 zookeeper: zookeeper-sample 来匹配 service。</p>
<p><code>port: http-metrics</code>：这里通过匹配 service 中到 port name 来注册到 prometheus target。</p>
<p>operator 调用 prometheus-operator client 完成 ServiceMonitor 资源的创建，实现新建zk集群自动注册到prometheus的功能。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: monitoring.coreos.com/v1
<span style="color:#66d9ef">kind</span>: ServiceMonitor
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: zookeeper
    <span style="color:#66d9ef">app.kubernetes.io/instance</span>: zookeeper-sample
    <span style="color:#66d9ef">app.kubernetes.io/managed-by</span>: zookeeper-operator
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: zookeeper
    <span style="color:#66d9ef">app.kubernetes.io/part-of</span>: zookeeper
    <span style="color:#66d9ef">component</span>: zookeeper
    <span style="color:#66d9ef">zookeeper</span>: zookeeper-sample
  <span style="color:#66d9ef">name</span>: zookeeper-sample
  <span style="color:#66d9ef">namespace</span>: default
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">endpoints</span>:
  - <span style="color:#66d9ef">interval</span>: 30s
    <span style="color:#66d9ef">port</span>: http-metrics
  <span style="color:#66d9ef">namespaceSelector</span>: {}
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">zookeeper</span>: zookeeper-sample
</code></pre></div><h5 id="prometheusrule">PrometheusRule</h5>
<p>operator 调用 prometheus-operator client 完成 PrometheusRule 资源的创建，实现将告警策略自动注册到 prometheus。</p>
<p>告警策略中的 dingtalkRobot 标签，主要用来重定向告警信息到指定钉钉群中，这里可以添加多个钉钉群机器人。</p>
<h3 id="安全伸缩容">安全伸缩容</h3>
<h4 id="扩缩节点">扩缩节点</h4>
<ul>
<li>
<p>更新 Zookeeper CR 中 spec.cluster.nodeCount 配置。</p>
</li>
<li>
<p>触发 operator 主流程，判断期望副本数大于实际副本数继续流程，否则退出主流程。</p>
</li>
<li>
<p>更新 zk 集群 records，提交两种 record：</p>
<ul>
<li>
<p>Zookeeper upscale from 3 to 4.</p>
</li>
<li>
<p>Zookeeper Statefulset %s already update.</p>
</li>
</ul>
</li>
<li>
<p>更新 zk 集群 StatefulSet 资源，StatefulSet 控制器将会新建节点，zk 将新建节点加入集群中，数据将会自动做同步。</p>
</li>
<li>
<p>Reconfig 模块将从集群中添加或者剔除节点</p>
</li>
</ul>
<h4 id="扩资源">扩资源</h4>
<ul>
<li>
<p>更新 Zookeeper CR 中 spec.node.resources 配置。</p>
</li>
<li>
<p>如果zk节点数与期望节点数不一致，退出主流程，直到节点数一致，所有 pod 全部 ready。</p>
</li>
<li>
<p>通过节点数量检查之后，更新 StatefulSet 资源，由于我们这边 StatefulSet 设置的 RollingUpdate 策略为 OnDelete，即更新 StatefulSet 配置之后，StatefulSet 将不会主动重启节点以完成升级，需要我们自己手动去重启节点。</p>
</li>
<li>
<p>获取当前集群中节点角色，将 leader 节点放到最后重启，尽量减少集群不可用时间。</p>
</li>
<li>
<p>operator 比对 StatefulSet 和 pod resourceVersion值，如果不一致将节点加入到需要重启节点列表中。</p>
</li>
<li>
<p>operator 执行对节点如下检查项：</p>
<ul>
<li>
<p>当前重启中对节点是否超过 MaxUnavailable 值，目前 MaxUnavailable 值默认为1.</p>
</li>
<li>
<p>跳过节点状态为 Terminating 的节点。</p>
</li>
</ul>
</li>
<li>
<p>从重启节点中取一个节点，调用 kubernetes 接口，执行重启操作。</p>
</li>
<li>
<p>第一个节点重启完成之后，将 requeue 主流程，继续其他节点重启。</p>
</li>
<li>
<p>所有节点全部重启完成，滚动升级成功。</p>
</li>
</ul>
<h3 id="故障自愈">故障自愈</h3>
<h4 id="observer">Observer</h4>
<ul>
<li>
<p>operator 会为每一个创建的 zk 集群启动一个 observer，每个 observer 将会启动两个 goroutine：</p>
<ul>
<li>
<p>GetClusterStatus，获取 zk-agent /status 接口数据。</p>
</li>
<li>
<p>GetClusterUp，获取 /runok 接口数据。</p>
</li>
</ul>
</li>
<li>
<p>operator 将每10秒获取集群最新状态，包括集群状态、node 节点数、leader 节点等。</p>
</li>
<li>
<p>operator 获取到最新集群状态之后，将更新CR的 status 中，达到实时更新 CR 中 zk 集群状态的功能，效果如下图。</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">status</span>:
  <span style="color:#66d9ef">availableNodes</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#66d9ef">leaderNode</span>: zookeeper-sample<span style="color:#ae81ff">-1.</span>zookeeper-sample.default.svc.cluster.local
</code></pre></div><ul>
<li>如果zk集群被销毁, operator 将调用 finalizers 方法停止 observer 协程。</li>
</ul>
<h4 id="触发主流程">触发主流程</h4>
<ul>
<li>
<p>operator 控制器在初始化的时候，将 watch 一个自定义的 event channel，等待 event 通过 channel 传递过来，触发主控流程执行。</p>
</li>
<li>
<p>observer 初始化的时候，创建一个 listeners 函数数组，用于 observer 状态刷新时候调用，每新建一个 zk 集群将加入一个 listener。</p>
</li>
<li>
<p>observer 执行一次，listeners 数组中的函数将会执行一次，获取最新各个 zk 集群的 health 状态。</p>
</li>
<li>
<p>listeners 数组的函数将判断，集群新状态与老状态是否一致，一致则返回 nil，否则进一步处理。</p>
</li>
<li>
<p>如果状态不一致将传值到 event channel，由 watch 消费以触发 operator 主控流程执行。</p>
</li>
</ul>
<h3 id="可视化操作">可视化操作</h3>
<p>可视化操作，主要实现一下功能：</p>
<ul>
<li>zk 集群的查询、创建、伸缩、资源调整</li>
<li>支持多 kubernetes 环境</li>
<li>支持集群监控展示</li>
</ul>
<h4 id="多kubernetes环境">多kubernetes环境</h4>
<p>对于多 kubernetes 环境的支持，主要通过在每个环境部署 agent 组件，组件通过 rbac 进行授权，确保agent组件只能操作指定资源。将 agent 注册到管理平台，管理平台按照环境请求不同环境接口即可。</p>
<h4 id="接口列表">接口列表</h4>
<table>
<thead>
<tr>
<th>模式</th>
<th>接口</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/zookeeper/list</td>
<td>查询所有zookeeper集群信息</td>
<td></td>
</tr>
<tr>
<td>POST</td>
<td>/zookeeper/info</td>
<td>查询单个zookeeper集群信息</td>
<td></td>
</tr>
<tr>
<td>POST</td>
<td>/zookeeper/create</td>
<td>创建单个zookeeper集群</td>
<td></td>
</tr>
<tr>
<td>POST</td>
<td>/zookeeper/update</td>
<td>更新单个zookeeper集群</td>
<td></td>
</tr>
<tr>
<td>POST</td>
<td>/zookeeper/delete</td>
<td>销毁单个zookeeper集群</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="参数校验">参数校验</h3>
<h4 id="admission-webhooks">Admission Webhooks</h4>
<ul>
<li>ValidatingWebhook：主要实现验证检测，即检查通过 kubernetes API client 提交到CR参数是否合法，如果不符合要求直接拒绝资源创建。检查项如下：
<ul>
<li>检查节点资源，request CPU/mem 是否小于 limit CPU/mem</li>
</ul>
</li>
<li>MutatingWebhook：主要实现注入默认参数，即检查到提交参数缺少一些关键性参数，将由 webhook 补齐并注入到创建资源中。补全项如下：
<ul>
<li>节点资源限制，比如request cpu/mem和limit cpu/mem。</li>
<li>exporter配置，默认开启exporter，</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">Exporter</span>:              <span style="color:#66d9ef">true</span>,
<span style="color:#66d9ef">ExporterImage</span>:         <span style="color:#e6db74">&#34;harbor.ymmoa.com/monitoring/zookeeper_exporter&#34;</span>,
<span style="color:#66d9ef">ExporterVersion</span>:       <span style="color:#e6db74">&#34;1.1.0&#34;</span>,
<span style="color:#66d9ef">DisableExporterProbes</span>: <span style="color:#66d9ef">false</span>,
</code></pre></div><h3 id="升级策略">升级策略</h3>
<p>StatefulSets 提供了多种升级策略：OnDelete，RollingUpdate，RollingUpdate with partition。</p>
<h4 id="ondelete的一般方法">OnDelete的一般方法</h4>
<p>使用 OnDelete，除非 Pod 的数量高于预期的副本数，否则 StatefulSet 控制器不会从 StatefulSet 中删除 Pod。</p>
<p>Operator 决定何时要删除 Pod。一旦删除，便会由 StatefulSet 控制器自动重新创建一个 Pod，该 Pod 具有相同的名称，但是最新的规范。</p>
<p>我们的操作员永远不会创建 Pod，但是当我们决定准备删除 Pod 时，它将负责 Pod 的删除。</p>
<p>当对 StatefulSet 进行修改时（例如，更改 Pod 资源限制），我们最终得到一个新的 revision（基于模板规范的哈希值）。</p>
<p>查看 StatefulSet 状态，我们可以获得当前的修订版（currentRevision: zookeeper-sample-7b889dd5b4），使用该修订版的容器的数量以及仍在使用旧修订版的容器的数量（updateRevision: zookeeper-sample-74597f9b9d）。</p>
<p>通过列出该 StatefulSet 中的 Pod，我们可以检查每个 Pod（metadata.labels[&ldquo;controller-revision-hash&rdquo;]: &ldquo;zookeeper-sample-7b889dd5b4&rdquo;）的当前版本。</p>
<h4 id="rollingupdatepartition-方法">RollingUpdate.Partition 方法</h4>
<p>使用此策略，我们定义了一个 partition 索引：这允许使用 StatefulSet 控制器替换序数高于此索引的 Pod。</p>
<p>例如，如果我们有一个带有5个副本的 StatefulSet：</p>
<ul>
<li>zookeeper-sample-0</li>
<li>zookeeper-sample-1</li>
<li>zookeeper-sample-2</li>
<li>zookeeper-sample-3</li>
<li>zookeeper-sample-4</li>
</ul>
<p>如果分区索引为3，则允许 StatefulSet 控制器自动删除然后重新创建 Pod zookeeper-sample-3 和 zookeeper-sample-4。</p>
<p>在此模式下，操作员永远不会删除 Pod。它所做的就是：</p>
<ul>
<li>当应添加新容器或应除去容器时，更新 StatefulSets 副本</li>
<li>当应更换某些 Pod 时更新分区索引</li>
</ul>
<p>要对上面的 StatefulSet 进行滚动升级，我们将从索引开始5，确保4可以安全地替换 Pod ，然后将索引更新为4。这将触发更换 Pod。</p>
<p>OnDelete 除了不显式删除 Pod 而是管理索引外，其他逻辑与适用相同。</p>
<h3 id="agent">Agent</h3>
<p>zk agent 作为 sidecar 伴随主容器一并启动，提供如下接口：</p>
<ul>
<li>status：返回宿主 zk 节点当前运行状态，参考 zk srvr 命令。</li>
<li>runok：返回宿主 zk 节点是否正常运行且无错误，参考 zk ruok 命令。</li>
<li>health：返回 agent 运行状态，用于 agent 的心跳检测。</li>
<li>get：返回 zk 集群节点列表，查询 /zookeeper/config 文件。</li>
<li>add：增加节点到 zk 集群中，主要依赖 zk reconfigure 特性，集群扩容时使用。</li>
<li>del：从现有 zk 集群中删除某个节点，如果删除节点是主节点，会先做主节点切换，之后才会移除节点，集群缩容时使用。</li>
</ul>
<h4 id="接口列表-1">接口列表</h4>
<table>
<thead>
<tr>
<th>模式</th>
<th>接口</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/status</td>
<td>getZkStatus</td>
<td></td>
</tr>
<tr>
<td>GET</td>
<td>/runok</td>
<td>getZkRunok</td>
<td></td>
</tr>
<tr>
<td>GET</td>
<td>/health</td>
<td>Health</td>
<td></td>
</tr>
<tr>
<td>GET</td>
<td>/get</td>
<td>getMember</td>
<td></td>
</tr>
<tr>
<td>POST</td>
<td>/add</td>
<td>addMember</td>
<td></td>
</tr>
<tr>
<td>POST</td>
<td>/del</td>
<td>delMember</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="get">GET</h4>
<p>/status, 获取当前 zk 节点运行状态，字段含义对照 <code>mntr</code> 查看信息，包括如下字段：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
   <span style="color:#f92672">&#34;Sent&#34;</span>: <span style="color:#ae81ff">1617</span>,
   <span style="color:#f92672">&#34;Received&#34;</span>: <span style="color:#ae81ff">1618</span>,
   <span style="color:#f92672">&#34;NodeCount&#34;</span>: <span style="color:#ae81ff">5</span>,
   <span style="color:#f92672">&#34;MinLatency&#34;</span>: <span style="color:#ae81ff">0</span>,
   <span style="color:#f92672">&#34;AvgLatency&#34;</span>: <span style="color:#ae81ff">2</span>,
   <span style="color:#f92672">&#34;MaxLatency&#34;</span>: <span style="color:#ae81ff">5</span>,
   <span style="color:#f92672">&#34;Connections&#34;</span>: <span style="color:#ae81ff">1</span>,
   <span style="color:#f92672">&#34;Outstanding&#34;</span>: <span style="color:#ae81ff">0</span>,
   <span style="color:#f92672">&#34;Epoch&#34;</span>: <span style="color:#ae81ff">14</span>,
   <span style="color:#f92672">&#34;Counter&#34;</span>: <span style="color:#ae81ff">82</span>,
   <span style="color:#f92672">&#34;BuildTime&#34;</span>: <span style="color:#e6db74">&#34;2019-10-08T20:18:00Z&#34;</span>,
   <span style="color:#f92672">&#34;Mode&#34;</span>: <span style="color:#ae81ff">2</span>,                      <span style="color:#960050;background-color:#1e0010">//0表示Unknown，1代表Leader，2代表follower</span>
   <span style="color:#f92672">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;3.5.6-c11b7e26bc554b8523dc929761dd28808913f091&#34;</span>,
   <span style="color:#f92672">&#34;Error&#34;</span>: <span style="color:#66d9ef">null</span>
}
</code></pre></div><p>/runok，获取当前节点是否正常启动。</p>
<p>/health，获取 zk-agent 是否正常启动。</p>
<p>/get，获取当前 Reconfig 动态配置节点信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
   <span style="color:#f92672">&#34;record&#34;</span>: <span style="color:#e6db74">&#34;server.1=zookeeper-sample-0.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181\nserver.2=zookeeper-sample-1.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181\nserver.3=zookeeper-sample-2.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181\nversion=c00000002&#34;</span>
}
</code></pre></div><h4 id="post">POST</h4>
<p>/add，获取客户端传入需要新增的节点信息，并更新到动态节点配置中。</p>
<p>/del，获取客户端传入需要删除到节点信息，并更新到动态节点配置中。传入值参考 add 接口格式。</p>
<h2 id="oam对接">OAM对接</h2>
<p><img src="/images/blog/oam.jpeg" alt="转自 孙健波 OAM 深入解读：OAM 为云原生应用带来哪些价值？"></p>
<blockquote>
<p>OAM 是一个专注于描述应用的标准规范。有了这个规范，应用描述就可以彻底与基础设施部署和管理应用的细节分开。这种关注点分离（Seperation of Conerns）的设计好处是非常明显的。</p>
</blockquote>
<h3 id="应用组件components">应用组件（Components）</h3>
<blockquote>
<p>组件（Components）：概念让平台架构师等能够将应用分解成成一个个可被复用的模块，这种模块化封装应用组成部分的思想，代表了一种构建安全、高可扩展性应用的最佳实践：通过一个完全分布式的架构模型，实现了应用组件描述和实现的解耦。</p>
</blockquote>
<p>按照应用组件的定义，对应到目前zk operator的快速部署模块上，部署模块主要生成和创建原生资源，完成容器化zk集群搭建，并持续维持声明式定义的集群终态。部署模块可以单独定义CRD, 比如 <code>workload.zookeeper.example.com</code>。</p>
<h3 id="应用运维特征traits">应用运维特征（Traits）</h3>
<blockquote>
<p>运维特征（Traits）：它们描述了应用在具体部署环境中的运维特征，比如应用的水平扩展的策略和 Ingress 规则，这些特征对于应用的运维来说非常重要，但它们在不同的部署环境里却往往有着截然不同的实现方式。</p>
</blockquote>
<p>Traits则对应 zk operator 模块中的 伸缩、滚动升级两个模块，这两个模块可以抽出来定义为单独CRD，比如 <code>scale.zookeeper.example.com</code> 和 <code>rolling.zookeeper.example.com</code>。</p>
<h2 id="小结">小结</h2>
<p>目前 zk operator 的实现能力也仅仅实现 部署、伸缩、滚动升级、监控等能力，还有很多模块可以做，比如：备份、重置、迁移、调度策略、暂停等等。</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li> <a href="https://mp.weixin.qq.com/s/O94sUDPlEcNKvfbQyrb8-w">阿里云携手微软与 Crossplane 社区发布 OAM Kubernetes 标准实现与核心依赖库</a></li>
<li><a href="https://www.infoq.cn/article/gizNAvObXREqfvWMTvYt">OAM 正式开源：全球首个云原生应用标准定义与架构模型</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/zookeeper"> 
            Zookeeper</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/operator"> , 
            Operator</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/oam"> , 
            OAM</a>
            
          </ul>
        </div>
        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/oam-crossplane/">(译)OAM和Crossplane: 构建现代应用的下一个阶段</a></li>
  
  </ul>
</div>


        <!-- comments -->
        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: '0f001988910adcfadfb7',
              clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
              repo: 'cloudnativeto.github.io',
              owner: 'cloudnativeto',
              admin: ['rootsongjc'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5 word-cloud">
    <h4 class="mb-4">标签</h4>
    
      
      
      
      
      
      
      
      
      
      
      
      <div id="tag-cloud" style="padding: 5px 15px">
      
        
          
          
          
          <a href="/tags/bpf" style="font-size:1rem">bpf</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cicd" style="font-size:1rem">cicd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/client-go" style="font-size:1rem">client-go</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cloud-native" style="font-size:1rem">cloud-native</a>
        
      
        
          
          
          &middot;
          <a href="/tags/crossplane" style="font-size:1rem">crossplane</a>
        
      
        
          
          
          &middot;
          <a href="/tags/envoy" style="font-size:1rem">envoy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/etcd" style="font-size:1rem">etcd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/flamegraph" style="font-size:1rem">flamegraph</a>
        
      
        
          
          
          &middot;
          <a href="/tags/istio" style="font-size:1.5rem">istio</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetes" style="font-size:1.5rem">kubernetes</a>
        
      
        
          
          
          &middot;
          <a href="/tags/linux%e5%86%85%e6%a0%b8" style="font-size:1rem">linux内核</a>
        
      
        
          
          
          &middot;
          <a href="/tags/microservices" style="font-size:1.5rem">microservices</a>
        
      
        
          
          
          &middot;
          <a href="/tags/oam" style="font-size:1.5rem">oam</a>
        
      
        
          
          
          &middot;
          <a href="/tags/operator" style="font-size:1rem">operator</a>
        
      
        
          
          
          &middot;
          <a href="/tags/profile" style="font-size:1rem">profile</a>
        
      
        
          
          
          &middot;
          <a href="/tags/service-mesh" style="font-size:1rem">service-mesh</a>
        
      
        
          
          
          &middot;
          <a href="/tags/spring-cloud" style="font-size:1rem">spring-cloud</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tcpdump" style="font-size:1rem">tcpdump</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tekton" style="font-size:1rem">tekton</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vxlan" style="font-size:1rem">vxlan</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wasm" style="font-size:1rem">wasm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wireshark" style="font-size:1rem">wireshark</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zookeeper" style="font-size:1rem">zookeeper</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%ad%a6%e4%b9%a0%e5%b0%8f%e7%bb%84" style="font-size:1rem">学习小组</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e5%bc%80%e6%ba%90" style="font-size:1rem">开源</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" style="font-size:1rem">源码分析</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e7%a4%be%e5%8c%ba" style="font-size:1.5rem">社区</a>
        
      
      </div>
    
  </div>

  <!-- profile -->
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#导言">导言</a></li>
    <li><a href="#功能需求">功能需求</a></li>
    <li><a href="#crd">CRD</a></li>
    <li><a href="#架构图">架构图</a></li>
    <li><a href="#具体方案">具体方案</a>
      <ul>
        <li><a href="#快速部署">快速部署</a></li>
        <li><a href="#自动化监控">自动化监控</a></li>
        <li><a href="#安全伸缩容">安全伸缩容</a></li>
        <li><a href="#故障自愈">故障自愈</a></li>
        <li><a href="#可视化操作">可视化操作</a></li>
        <li><a href="#参数校验">参数校验</a></li>
        <li><a href="#升级策略">升级策略</a></li>
        <li><a href="#agent">Agent</a></li>
      </ul>
    </li>
    <li><a href="#oam对接">OAM对接</a>
      <ul>
        <li><a href="#应用组件components">应用组件（Components）</a></li>
        <li><a href="#应用运维特征traits">应用运维特征（Traits）</a></li>
      </ul>
    </li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="Cloud Native Community" width="60%"></a>
          <p class="text-light mb-5">云原生社区始于 2016 年成立的 Kubernetes &amp; CloudNative 实战群，覆盖了上千名早期云原生拥护者。在此基础上于 2020 年 5 月，由 CNCF 大使、开源领域意见领袖共同发起将原社群升级为云原生社区，旨在构建一个开放、包容的沟通环境，促进云原生技术的传播和普及。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativeto"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnativecommunity.slack.com"><i class="fa fa-slack"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3">北京 · 上海 · 成都 · 深圳 · 伦敦</p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="356px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright © 2020 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/code-of-conduct"
                class="text-white">社区守则</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '870a8addaf7a712ecc6e33ce9def93b1',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>

</body>

</html>
