<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="云原生社区" />

  
  
  
    
  
  <meta name="description" content="本文针对云原生网关 APISIX 的核心流程以源码分析的方式剖析其工作原理，并对于网关未来的发展方向进行了思考。" />

  
  <link rel="alternate" hreflang="zh" href="https://cloudnative.to/blog/apisix-source-code-reading/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.2f500d272ea4379dca952215a5d02351.css" />

  



  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f3dc895ea3bd6186cd835841d365c103";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu12a4295615259de83f102fd096a49a31_6281_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://cloudnative.to/blog/apisix-source-code-reading/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@CloudNativeCN" />
    <meta property="twitter:creator" content="@CloudNativeCN" />
  
  <meta property="og:site_name" content="云原生社区" />
  <meta property="og:url" content="https://cloudnative.to/blog/apisix-source-code-reading/" />
  <meta property="og:title" content="云原生网关 APISIX 核心流程源码分析与进化方向思考 | 云原生社区" />
  <meta property="og:description" content="本文针对云原生网关 APISIX 的核心流程以源码分析的方式剖析其工作原理，并对于网关未来的发展方向进行了思考。" /><meta property="og:image" content="https://cloudnative.to/media/sharing.png" />
    <meta property="twitter:image" content="https://cloudnative.to/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2021-10-24T14:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2022-11-23T10:59:57&#43;08:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cloudnative.to/blog/apisix-source-code-reading/"
  },
  "headline": "云原生网关 APISIX 核心流程源码分析与进化方向思考",
  
  "datePublished": "2021-10-24T14:00:00+08:00",
  "dateModified": "2022-11-23T10:59:57+08:00",
  
  "author": {
    "@type": "Person",
    "name":  77 
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "云原生社区",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cloudnative.to/media/logo.svg"
    }
  },
  "description": "本文针对云原生网关 APISIX 的核心流程以源码分析的方式剖析其工作原理，并对于网关未来的发展方向进行了思考。"
}
</script>

  

  

  

  





  <title>云原生网关 APISIX 核心流程源码分析与进化方向思考 | 云原生社区</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="3e195288c801ab8a371bf1bec3a95147" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生社区"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/community"><span>社区</span></a>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/blog"><span>博客</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>资料</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/envoy/"><span>Envoy 中文文档</span></a>
              
                <a class="dropdown-item" href="/kubebuilder"><span>Kubebuilder 中文文档</span></a>
              
            </div>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/event"><span>活动</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        

        
        <li class="nav-item">
            <a class="nav-link" href="/community/join/" data-toggle="tooltip" data-placement="bottom" title="加入社区" aria-label="主站"><i class="fa-brands fa-weixin" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/cloudnativeto/cloudnative.to" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <div class="container-xl">
    <div class="post-container">
        












  

  
  
  
<div class="article-container pt-3">
  <h1>云原生网关 APISIX 核心流程源码分析与进化方向思考</h1>

  

  
    


<div class="article-metadata">

  <div>
  
  
  
  
    <i class="fa-solid fa-feather"></i>
    

  <span >
      <a href="/author/mayo-cream/">Mayo Cream</a></span>
    
    <span class="middot-divider"></span>
    
  
  
  
  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/%E4%BA%91%E5%8E%9F%E7%94%9F/" class="text-capitalize">云原生</a></span>
  
  </div>

  
  <span class="article-date">
    
    
      
          
          发布于
      
    
    2021-10-24
  </span>
  

  

  
  <span class="middot-divider"></span>
  字数 9185
  <span class="middot-divider"></span>
  <span class="article-reading-time">
      阅读时长 42 分钟
  </span>
  

  
  
  
  

</div>

    





  
</div>


    </div>
    <div class="border-bottom mb-2"></div>
    <div class="row flex-xl-nowrap">
        <div class="col-3 d-none d-xl-block docs-toc">
            <!-- toc -->
            
<div class="">
    <ul class="nav toc-top">
        <li>
            <a href="#" id="back_to_top" class="docs-toc-title">目录</a>
        </li>
    </ul>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-apisix-概述">1. APISIX 概述</a>
      <ul>
        <li><a href="#11-项目概述">1.1. 项目概述</a></li>
        <li><a href="#12-生态概述">1.2. 生态概述</a></li>
      </ul>
    </li>
    <li><a href="#2-基本流程">2. 基本流程</a>
      <ul>
        <li><a href="#21-目录结构">2.1. 目录结构</a></li>
        <li><a href="#22-启动流程">2.2. 启动流程</a></li>
      </ul>
    </li>
    <li><a href="#3-基本类型操作">3. 基本类型操作</a>
      <ul>
        <li><a href="#31-字符串">3.1. 字符串</a></li>
        <li><a href="#32-table">3.2. Table</a></li>
      </ul>
    </li>
    <li><a href="#4-工具类">4. 工具类</a>
      <ul>
        <li><a href="#41-json-操作">4.1. JSON 操作</a></li>
        <li><a href="#42-lru-缓存">4.2. LRU 缓存</a></li>
        <li><a href="#43-后台任务">4.3. 后台任务</a></li>
      </ul>
    </li>
    <li><a href="#5-请求生命周期">5. 请求生命周期</a>
      <ul>
        <li><a href="#51-ctx">5.1. ctx</a></li>
        <li><a href="#52-headers">5.2. headers</a></li>
      </ul>
    </li>
    <li><a href="#6-etcd">6. etcd</a>
      <ul>
        <li><a href="#61-初始化">6.1. 初始化</a></li>
        <li><a href="#62-数据校验">6.2. 数据校验</a></li>
        <li><a href="#63-后台数据同步">6.3. 后台数据同步</a></li>
        <li><a href="#64-配置同步">6.4. 配置同步</a></li>
      </ul>
    </li>
    <li><a href="#7-router">7. Router</a>
      <ul>
        <li><a href="#71-路由构建">7.1. 路由构建</a></li>
        <li><a href="#72-路由初始化">7.2. 路由初始化</a></li>
        <li><a href="#73-路由匹配">7.3. 路由匹配</a></li>
      </ul>
    </li>
    <li><a href="#8-balancer">8. Balancer</a>
      <ul>
        <li><a href="#81-服务发现">8.1. 服务发现</a></li>
        <li><a href="#82-负载均衡">8.2. 负载均衡</a></li>
      </ul>
    </li>
    <li><a href="#9-plugin">9. Plugin</a>
      <ul>
        <li><a href="#91-插件加载">9.1. 插件加载</a></li>
        <li><a href="#92-插件匹配">9.2. 插件匹配</a></li>
        <li><a href="#93-插件执行">9.3. 插件执行</a></li>
      </ul>
    </li>
    <li><a href="#10-主流程">10. 主流程</a>
      <ul>
        <li><a href="#101-init_by_lua">10.1. init_by_lua</a></li>
        <li><a href="#102-init_worker_by_lua">10.2. init_worker_by_lua</a></li>
        <li><a href="#103-access_by_lua">10.3. access_by_lua</a></li>
      </ul>
    </li>
    <li><a href="#11-一些思考">11. 一些思考</a>
      <ul>
        <li><a href="#111-边缘计算">11.1. 边缘计算</a></li>
        <li><a href="#112-serverless">11.2. Serverless</a></li>
        <li><a href="#113-webassembly">11.3. WebAssembly</a></li>
        <li><a href="#114-service-mesh">11.4. Service Mesh</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>

            <!-- /toc -->
            
            <div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.jpg" alt="image" title="云原生社区的微信公众号"/>
    <p class="text-center pt-1">关注「云原生社区动态」微信公众号，获取本站更新</p>
</div>

            
        </div>
        <main class="article-body col-9 container docs-content" role="main">
            <article class="article">
                <div class="article-style">
                    
                    <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">点击查看目录</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-apisix-概述">1. APISIX 概述</a>
      <ul>
        <li><a href="#11-项目概述">1.1. 项目概述</a></li>
        <li><a href="#12-生态概述">1.2. 生态概述</a></li>
      </ul>
    </li>
    <li><a href="#2-基本流程">2. 基本流程</a>
      <ul>
        <li><a href="#21-目录结构">2.1. 目录结构</a></li>
        <li><a href="#22-启动流程">2.2. 启动流程</a></li>
      </ul>
    </li>
    <li><a href="#3-基本类型操作">3. 基本类型操作</a>
      <ul>
        <li><a href="#31-字符串">3.1. 字符串</a></li>
        <li><a href="#32-table">3.2. Table</a></li>
      </ul>
    </li>
    <li><a href="#4-工具类">4. 工具类</a>
      <ul>
        <li><a href="#41-json-操作">4.1. JSON 操作</a></li>
        <li><a href="#42-lru-缓存">4.2. LRU 缓存</a></li>
        <li><a href="#43-后台任务">4.3. 后台任务</a></li>
      </ul>
    </li>
    <li><a href="#5-请求生命周期">5. 请求生命周期</a>
      <ul>
        <li><a href="#51-ctx">5.1. ctx</a></li>
        <li><a href="#52-headers">5.2. headers</a></li>
      </ul>
    </li>
    <li><a href="#6-etcd">6. etcd</a>
      <ul>
        <li><a href="#61-初始化">6.1. 初始化</a></li>
        <li><a href="#62-数据校验">6.2. 数据校验</a></li>
        <li><a href="#63-后台数据同步">6.3. 后台数据同步</a></li>
        <li><a href="#64-配置同步">6.4. 配置同步</a></li>
      </ul>
    </li>
    <li><a href="#7-router">7. Router</a>
      <ul>
        <li><a href="#71-路由构建">7.1. 路由构建</a></li>
        <li><a href="#72-路由初始化">7.2. 路由初始化</a></li>
        <li><a href="#73-路由匹配">7.3. 路由匹配</a></li>
      </ul>
    </li>
    <li><a href="#8-balancer">8. Balancer</a>
      <ul>
        <li><a href="#81-服务发现">8.1. 服务发现</a></li>
        <li><a href="#82-负载均衡">8.2. 负载均衡</a></li>
      </ul>
    </li>
    <li><a href="#9-plugin">9. Plugin</a>
      <ul>
        <li><a href="#91-插件加载">9.1. 插件加载</a></li>
        <li><a href="#92-插件匹配">9.2. 插件匹配</a></li>
        <li><a href="#93-插件执行">9.3. 插件执行</a></li>
      </ul>
    </li>
    <li><a href="#10-主流程">10. 主流程</a>
      <ul>
        <li><a href="#101-init_by_lua">10.1. init_by_lua</a></li>
        <li><a href="#102-init_worker_by_lua">10.2. init_worker_by_lua</a></li>
        <li><a href="#103-access_by_lua">10.3. access_by_lua</a></li>
      </ul>
    </li>
    <li><a href="#11-一些思考">11. 一些思考</a>
      <ul>
        <li><a href="#111-边缘计算">11.1. 边缘计算</a></li>
        <li><a href="#112-serverless">11.2. Serverless</a></li>
        <li><a href="#113-webassembly">11.3. WebAssembly</a></li>
        <li><a href="#114-service-mesh">11.4. Service Mesh</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

                    
                    <p>本文基于 <a href="https://github.com/apache/apisix" target="_blank" rel="noopener">APISIX</a> 2.6 版本进行源码分析，源码阅读注释仓库: <a href="https://github.com/mayocream/apisix/tree/review" target="_blank" rel="noopener">review</a>，分析主要流程以及核心机制。</p>
<h2 id="1-apisix-概述">1. APISIX 概述</h2>
<p>APISIX 与 Kong 类似，是一个基于 OpenResty 构建的 API 网关，如果你熟悉 OpenResty，你大概能猜到本文会讲述 APISIX 在 OpenResty 的几大生命周期中，
做了什么动作来进行路由匹配、服务发现、负载均衡以及加载插件。
如果你还想了解 Kong 网关是如何运作的，可以查看我的另一篇文章 <a href="https://shoujo.ink/2021/09/kong-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">Kong 源码分析</a>。
当然，APISIX 不同于 Kong 的地方，例如 etcd 数据变化监听、强大的缓存机制、以及在性能优化上做的尝试，本文也会一一阐述。</p>
<h3 id="11-项目概述">1.1. 项目概述</h3>
<p>APISIX 是基于 OpenResty 开发的 API 网关，与 OpenResty 的请求生命周期一致，APISIX 利用 Lua Nginx Module 提供的 <code>*_by_lua</code> 添加 Hook。</p>
<p>















<figure  id="figure-api-gateway-traffic">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="API Gateway traffic" srcset="
               /blog/apisix-source-code-reading/gateway-traffic_hu26b90607eb81bb36f1ae7e47ce36ffcf_20716_4c4731c1d31a7d81d5bd653ba1b96981.webp 400w,
               /blog/apisix-source-code-reading/gateway-traffic_hu26b90607eb81bb36f1ae7e47ce36ffcf_20716_fdff3a8e83a839690c75e269281022ae.webp 760w,
               /blog/apisix-source-code-reading/gateway-traffic_hu26b90607eb81bb36f1ae7e47ce36ffcf_20716_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/gateway-traffic_hu26b90607eb81bb36f1ae7e47ce36ffcf_20716_4c4731c1d31a7d81d5bd653ba1b96981.webp"
               width="760"
               height="160"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      API Gateway traffic
    </figcaption></figure>
</p>
<p>APISIX 抽象了 Route、Service、Upstream、Plugin、Consumer 等数据模型，与 Kong 网关如出一辙。</p>
<p>















<figure  id="figure-apisix">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="APISIX" srcset="
               /blog/apisix-source-code-reading/114740649-a9bf2200-9d67-11eb-8e1d-1409fb5c18c2_hu71d65a55f3849eaf2104a73c3e38a9cc_164453_174b2eab1797b730d253833c2c9ef3f6.webp 400w,
               /blog/apisix-source-code-reading/114740649-a9bf2200-9d67-11eb-8e1d-1409fb5c18c2_hu71d65a55f3849eaf2104a73c3e38a9cc_164453_ed7dae27b21e509bc784851895522d48.webp 760w,
               /blog/apisix-source-code-reading/114740649-a9bf2200-9d67-11eb-8e1d-1409fb5c18c2_hu71d65a55f3849eaf2104a73c3e38a9cc_164453_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/114740649-a9bf2200-9d67-11eb-8e1d-1409fb5c18c2_hu71d65a55f3849eaf2104a73c3e38a9cc_164453_174b2eab1797b730d253833c2c9ef3f6.webp"
               width="760"
               height="435"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      APISIX
    </figcaption></figure>

















<figure  id="figure-kong">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="Kong" srcset="
               /blog/apisix-source-code-reading/Kong-GS-overview_hua36b292d10a143a8ac15dfe08a9c7096_89518_eee6feb2e5a8d2d0d689ffc8da60764a.webp 400w,
               /blog/apisix-source-code-reading/Kong-GS-overview_hua36b292d10a143a8ac15dfe08a9c7096_89518_2cdb00d78a5963d7d7a8c6c10de41248.webp 760w,
               /blog/apisix-source-code-reading/Kong-GS-overview_hua36b292d10a143a8ac15dfe08a9c7096_89518_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/Kong-GS-overview_hua36b292d10a143a8ac15dfe08a9c7096_89518_eee6feb2e5a8d2d0d689ffc8da60764a.webp"
               width="760"
               height="426"
               loading="lazy" data-zoomable /></div>
  </div><figcaption>
      Kong
    </figcaption></figure>
</p>
<p>基本上可以看作 APISIX 是 Kong 网关的重构——运用大量 LuaJIT、OpenResty 技巧优化性能、简化复杂的数据结构、替换储存引擎为 etcd 等。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img src="graph-1.png" alt="" loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>值得一提的是，在 APISIX 的一个 issue 中，项目开发者说不确定是什么原因，我们看看 Kong 网关是怎么解决的吧。</p>
<blockquote>
<p>&ldquo;How does Kong solve similar problems?&rdquo;<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
</blockquote>
<h3 id="12-生态概述">1.2. 生态概述</h3>
<p>Kong 网关开源生态有的，APISIX 基本都有或者正在做。包含：Kubernetes Ingress Controller、Mesh、Dashboard。</p>
<p>插件方面比 Kong 开源版本多了 Skywalking APM 数据上报、Traffit 流量拆分、Mirror 流量镜像等功能。</p>
<h2 id="2-基本流程">2. 基本流程</h2>
<p>本节概述 APISIX 的目录结构，以及其启动流程。</p>
<h3 id="21-目录结构">2.1. 目录结构</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tree -L <span class="m">2</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── apisix
</span></span><span class="line"><span class="cl">│   ├── admin <span class="c1"># Admin API</span>
</span></span><span class="line"><span class="cl">│   ├── api_router.lua
</span></span><span class="line"><span class="cl">│   ├── balancer <span class="c1"># 负载均衡器</span>
</span></span><span class="line"><span class="cl">│   ├── balancer.lua
</span></span><span class="line"><span class="cl">│   ├── cli <span class="c1"># CLI, Lua 脚本</span>
</span></span><span class="line"><span class="cl">│   ├── constants.lua <span class="c1"># 常量</span>
</span></span><span class="line"><span class="cl">│   ├── consumer.lua
</span></span><span class="line"><span class="cl">│   ├── control
</span></span><span class="line"><span class="cl">│   ├── core <span class="c1"># 主要是封装的公共方法</span>
</span></span><span class="line"><span class="cl">│   ├── core.lua
</span></span><span class="line"><span class="cl">│   ├── debug.lua
</span></span><span class="line"><span class="cl">│   ├── discovery <span class="c1"># 服务发现, 支持 consul, eruka, dns</span>
</span></span><span class="line"><span class="cl">│   ├── http
</span></span><span class="line"><span class="cl">│   ├── init.lua <span class="c1"># _by_lua 函数入口</span>
</span></span><span class="line"><span class="cl">│   ├── patch.lua
</span></span><span class="line"><span class="cl">│   ├── plugin_config.lua
</span></span><span class="line"><span class="cl">│   ├── plugin.lua <span class="c1"># 插件</span>
</span></span><span class="line"><span class="cl">│   ├── plugins
</span></span><span class="line"><span class="cl">│   ├── router.lua <span class="c1"># Router</span>
</span></span><span class="line"><span class="cl">│   ├── schema_def.lua <span class="c1"># jsonschema 定义</span>
</span></span><span class="line"><span class="cl">│   ├── script.lua
</span></span><span class="line"><span class="cl">│   ├── ssl
</span></span><span class="line"><span class="cl">│   ├── ssl.lua
</span></span><span class="line"><span class="cl">│   ├── stream
</span></span><span class="line"><span class="cl">│   ├── timers.lua <span class="c1"># timer 封装</span>
</span></span><span class="line"><span class="cl">│   ├── upstream.lua
</span></span><span class="line"><span class="cl">│   └── utils
</span></span><span class="line"><span class="cl">├── bin
</span></span><span class="line"><span class="cl">│   └── apisix <span class="c1"># apisix CLI, shell 脚本</span>
</span></span><span class="line"><span class="cl">├── ci <span class="c1"># CI 脚本</span>
</span></span><span class="line"><span class="cl">├── conf <span class="c1"># 默认配置文件</span>
</span></span><span class="line"><span class="cl">├── deps
</span></span><span class="line"><span class="cl">├── docs
</span></span><span class="line"><span class="cl">├── Makefile <span class="c1"># 快捷指令</span>
</span></span><span class="line"><span class="cl">├── rockspec <span class="c1"># luarocks 包管理</span>
</span></span><span class="line"><span class="cl">├── t <span class="c1"># Test::Nginx 测试</span>
</span></span><span class="line"><span class="cl">└── utils <span class="c1"># Shell 脚本</span>
</span></span></code></pre></div><h3 id="22-启动流程">2.2. 启动流程</h3>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-2_hu3eedeb1622be7f387ac42e5d872f36de_14576_ec805743ac8b2e97610904a9c9c44824.webp 400w,
               /blog/apisix-source-code-reading/graph-2_hu3eedeb1622be7f387ac42e5d872f36de_14576_16f90a429977e72198d106e7b782b774.webp 760w,
               /blog/apisix-source-code-reading/graph-2_hu3eedeb1622be7f387ac42e5d872f36de_14576_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-2_hu3eedeb1622be7f387ac42e5d872f36de_14576_ec805743ac8b2e97610904a9c9c44824.webp"
               width="760"
               height="149"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>CLI 默认会用 LuaJIT 启动，若版本不够便退回到 Lua 5.1 解释器执行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查找 APISIX LUA 包路径</span>
</span></span><span class="line"><span class="cl"><span class="c1"># shell -s 判断文件是否存在且 size &gt; 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ref: https://stackoverflow.com/questions/53319817/what-is-the-meaning-of-n-z-x-l-d-etc-in-shell-script</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -s <span class="s1">&#39;./apisix/cli/apisix.lua&#39;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">	...
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># shell -e 判断文件是否存在</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$OR_EXEC</span> <span class="o">&amp;&amp;</span> <span class="s2">&#34;</span><span class="nv">$OR_VER</span><span class="s2">&#34;</span> <span class="o">=</span>~ <span class="s2">&#34;1.19&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># use the luajit of openresty</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$LUAJIT_BIN</span><span class="s2"> </span><span class="nv">$APISIX_LUA</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exec</span> <span class="nv">$LUAJIT_BIN</span> <span class="nv">$APISIX_LUA</span> <span class="nv">$*</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$LUA_VERSION</span><span class="s2">&#34;</span> <span class="o">=</span>~ <span class="s2">&#34;Lua 5.1&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># OpenResty version is not 1.19, use Lua 5.1 by default</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># shell &amp;* 传递所有 args</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ref: https://stackoverflow.com/questions/4824590/propagate-all-arguments-in-a-bash-shell-script</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;lua </span><span class="nv">$APISIX_LUA</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exec</span> lua <span class="nv">$APISIX_LUA</span> <span class="nv">$*</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>启动过程中：</p>
<ul>
<li>调用 <code>popen</code> 执行 CMD 命令；</li>
<li>使用 <a href="https://github.com/diegonehab/luasocket" target="_blank" rel="noopener">luasocket</a> 库发起 HTTP 请求（非 OpenResty 运行时）；</li>
<li>使用 ltn12 <a href="http://lua-users.org/wiki/FiltersSourcesAndSinks" target="_blank" rel="noopener">sink</a> 进行流处理；</li>
<li>创建 etcd prefix，value 为 <code>init</code>；</li>
</ul>
<h2 id="3-基本类型操作">3. 基本类型操作</h2>
<p>基本上为了追求极致性能，能用 FFI 调用实现的都用了。</p>
<h3 id="31-字符串">3.1. 字符串</h3>
<p>使用 FFI 调用 libc 函数 <code>memcmp</code> 进行字符串比较内存地址的前 n 长度是否相同。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">ffi</span>         <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ffi&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">C</span>           <span class="o">=</span> <span class="n">ffi.C</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- ref: https://www.cplusplus.com/reference/cstring/memcmp/</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- ref: https://www.tutorialspoint.com/c_standard_library/c_function_memcmp.htm</span>
</span></span><span class="line"><span class="cl"><span class="n">ffi.cdef</span><span class="s">[[
</span></span></span><span class="line"><span class="cl"><span class="s">    int memcmp(const void *s1, const void *s2, size_t n);
</span></span></span><span class="line"><span class="cl"><span class="s">]]</span>
</span></span></code></pre></div><p>接收类型是 <code>const void *</code>，不可变类型可以直接传入 Lua string 类型。</p>
<blockquote>
<p>如果你的 C 函数接受 <code>const char *</code> 或者等价的 <code>const unsigned char/int8_t/... *</code> 这样的参数类型，
可以直接传递 Lua string 进去，而无需另外准备一个 <code>ffi.new</code> 申请的数组。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
</blockquote>
<p>string 前缀比较，比较 s, prefix 内存地址的前 n (#prefix) 长度是否相同。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 用 ffi 扩展 string 方法</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">has_prefix</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="ow">or</span> <span class="n">type</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="p">(</span><span class="s2">&#34;unexpected type: s:&#34;</span> <span class="o">..</span> <span class="n">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">..</span> <span class="s2">&#34;, prefix:&#34;</span> <span class="o">..</span> <span class="n">type</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="o">#</span><span class="n">s</span> <span class="o">&lt;</span> <span class="o">#</span><span class="n">prefix</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 比较 s, prefix 内存地址的前 n (#prefix) 长度是否相同</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">C.memcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">#</span><span class="n">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>同理比较后缀：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">C.memcmp</span><span class="p">(</span><span class="n">ffi_cast</span><span class="p">(</span><span class="s2">&#34;char *&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="o">#</span><span class="n">s</span> <span class="o">-</span> <span class="o">#</span><span class="n">suffix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="o">#</span><span class="n">suffix</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="32-table">3.2. Table</h3>
<p>Table 是 Lua 中最常用的类型了，与其他语言比较的话相当于 PHP 的 Array 一样实用。</p>
<p>Lua Table 需要注意的地方其一：</p>
<blockquote>
<p>table.new(narray, nhash)</p>
<p>这个函数，会预先分配好指定的数组和哈希的空间大小，而不是在插入元素时自增长，这也是它的两个参数 narray 和 nhash 的含义。
如果不使用这个函数，自增长是一个代价比较高的操作，会涉及到空间分配、resize 和 rehash 等，我们应该尽量避免。</p>
<p>table.new 的文档并没有出现在 LuaJIT 的官网，而是深藏在 GitHub 项目的 <a href="https://github.com/openresty/luajit2/blob/v2.1-agentzh/doc/extensions.html" target="_blank" rel="noopener">扩展文档</a> 里，用谷歌也很难找到，所以很多人并不知道这个函数的存在。</p>
<p>超出预设的空间大小，也可以正常使用，只不过性能会退化，也就失去了使用 table.new 的意义。</p>
<p>需要根据实际场景，来预设好 table.new 中数组和哈希空间的大小，这样才能在性能和内存占用上找到一个平衡点。<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
</blockquote>
<p>Lua Table 需要注意的地方其二：</p>
<blockquote>
<p>table.insert 虽然是一个很常见的操作，但性能并不乐观。
如果不是根据指定下标来插入元素，那么每次都需要调用 LuaJIT 的 lj_tab_len 来获取数组的长度，以便插入队尾。获取 table 长度的时间复杂度为 O(n) 。</p>
</blockquote>
<p>参考 APISIX 作者给 <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">ingress-nginx</a> 项目提的 Table 操作优化 PR：<a href="https://github.com/kubernetes/ingress-nginx/pull/3673" target="_blank" rel="noopener">used table functions of LuaJIT for better performance.</a></p>
<p>OpenResty Fork 的 LuaJIT 新增的 table 函数<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>：</p>
<ul>
<li>table.isempty</li>
<li>table.isarray</li>
<li>table.nkeys</li>
<li>table.clone</li>
</ul>
<p>回到 APISIX 封装的 Table 操作符：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 自行构建 index 插入 table, 比 table.insert 效率高</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">insert_tail</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">idx</span> <span class="o">=</span> <span class="o">#</span><span class="n">tab</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 遍历输入的参数</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">select</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">tab</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">idx</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>select('#', ...)</code> 获取输入参数的数量，<code>select(i, ...)</code> 获取第 n 个参数，Table 的遍历中大量使用该结构。</p>
<p><code>try_read_attr</code> 实现了 <code>path.node.x</code> 的 table 访问方式，便于读取多层级配置项。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">try_read_attr</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">select</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;table&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tab</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">tab</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>使用示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="n">core_tab.try_read_attr</span><span class="p">(</span><span class="n">local_conf</span><span class="p">,</span> <span class="s2">&#34;graphql&#34;</span><span class="p">,</span> <span class="s2">&#34;max_size&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">size</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_size</span> <span class="o">=</span> <span class="n">size</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span></code></pre></div><h2 id="4-工具类">4. 工具类</h2>
<p>APISIX 封装了许多工具类，这些工具共同组成了 APISIX 的 PDK（Plugin Development Kit），利用这些方法，插件开发能够增速许多。</p>
<h3 id="41-json-操作">4.1. JSON 操作</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">delay_tab</span> <span class="o">=</span> <span class="n">setmetatable</span><span class="p">({</span><span class="n">data</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="kc">false</span><span class="p">},</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__tostring</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">res</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">self.data</span><span class="p">,</span> <span class="n">self.force</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">ngx.log</span><span class="p">(</span><span class="n">ngx.WARN</span><span class="p">,</span> <span class="s2">&#34;failed to encode: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34; force: &#34;</span><span class="p">,</span> <span class="n">self.force</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- this is a non-thread safe implementation</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- it works well with log, eg: log.info(..., json.delay_encode({...}))</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">delay_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay_tab.data</span> <span class="o">=</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay_tab.force</span> <span class="o">=</span> <span class="n">force</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">delay_tab</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>设置了元表的 <code>__tostring</code> 方法，在字符串转换时才使用匿名函数调用 <code>json.encode</code>，在日志打印时，被忽略的日志会不执行 JSON 压缩，避免额外的性能损耗。</p>
<h3 id="42-lru-缓存">4.2. LRU 缓存</h3>
<p><a href="https://github.com/openresty/lua-resty-lrucache" target="_blank" rel="noopener">lua-resty-lrucache</a> 在写入时会清理 TTL 过期的缓存，读时如果数据过期了，会作为第二个参数返回：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">hasht</span> <span class="o">=</span> <span class="n">self.hasht</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">val</span> <span class="o">=</span> <span class="n">hasht</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">val</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">node</span> <span class="o">=</span> <span class="n">self.key2node</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- print(key, &#34;: moving node &#34;, tostring(node), &#34; to cache queue head&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">cache_queue</span> <span class="o">=</span> <span class="n">self.cache_queue</span>
</span></span><span class="line"><span class="cl">    <span class="n">queue_remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">queue_insert_head</span><span class="p">(</span><span class="n">cache_queue</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">node.expire</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">node.expire</span> <span class="o">&lt;</span> <span class="n">ngx_now</span><span class="p">()</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- print(&#34;expired: &#34;, node.expire, &#34; &gt; &#34;, ngx_now())</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">node.user_flags</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">val</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">node.user_flags</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-3_hu2779c3f4ac287ca75d7b6b73c3fc570c_71264_328c2e92370628ba6bab2580bfa1d454.webp 400w,
               /blog/apisix-source-code-reading/graph-3_hu2779c3f4ac287ca75d7b6b73c3fc570c_71264_ae688da2a5f51067fe889666529013c0.webp 760w,
               /blog/apisix-source-code-reading/graph-3_hu2779c3f4ac287ca75d7b6b73c3fc570c_71264_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-3_hu2779c3f4ac287ca75d7b6b73c3fc570c_71264_328c2e92370628ba6bab2580bfa1d454.webp"
               width="383"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">fetch_valid_cache</span><span class="p">(</span><span class="n">lru_obj</span><span class="p">,</span> <span class="n">invalid_stale</span><span class="p">,</span> <span class="n">item_ttl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">item_release</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stale_obj</span> <span class="o">=</span> <span class="n">lru_obj</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">obj.ver</span> <span class="o">==</span> <span class="n">version</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">obj</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 如果 TTL 到期的数据版本号仍一致, 重新 set 该缓存</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">invalid_stale</span> <span class="ow">and</span> <span class="n">stale_obj</span> <span class="ow">and</span> <span class="n">stale_obj.ver</span> <span class="o">==</span> <span class="n">version</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">lru_obj</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">stale_obj</span><span class="p">,</span> <span class="n">item_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">stale_obj</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- release 回调</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">item_release</span> <span class="ow">and</span> <span class="n">obj</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">item_release</span><span class="p">(</span><span class="n">obj.val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 返回创建 LRU 的匿名函数</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">new_lru_fun</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">item_count</span><span class="p">,</span> <span class="n">item_ttl</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.type</span> <span class="o">==</span> <span class="s1">&#39;plugin&#39;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">item_count</span> <span class="o">=</span> <span class="n">opts.count</span> <span class="ow">or</span> <span class="n">PLUGIN_ITEMS_COUNT</span>
</span></span><span class="line"><span class="cl">        <span class="n">item_ttl</span> <span class="o">=</span> <span class="n">opts.ttl</span> <span class="ow">or</span> <span class="n">PLUGIN_TTL</span>
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">item_count</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.count</span> <span class="ow">or</span> <span class="n">GLOBAL_ITEMS_COUNT</span>
</span></span><span class="line"><span class="cl">        <span class="n">item_ttl</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.ttl</span> <span class="ow">or</span> <span class="n">GLOBAL_TTL</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">item_release</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.release</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">invalid_stale</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.invalid_stale</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 是否使用并发锁</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">serial_creating</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.serial_creating</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 参数为 LRU size</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">lru_obj</span> <span class="o">=</span> <span class="n">lru_new</span><span class="p">(</span><span class="n">item_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kr">function</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">create_obj_fun</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 不支持的 yielding 的 Nginx phase 无法使用 resty.lock</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">serial_creating</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">can_yield_phases</span><span class="p">[</span><span class="n">get_phase</span><span class="p">()]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">cache_obj</span> <span class="o">=</span> <span class="n">fetch_valid_cache</span><span class="p">(</span><span class="n">lru_obj</span><span class="p">,</span> <span class="n">invalid_stale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">item_ttl</span><span class="p">,</span> <span class="n">item_release</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">cache_obj</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="kr">return</span> <span class="n">cache_obj.val</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">obj</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">create_obj_fun</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">obj</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">lru_obj</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">version</span><span class="p">},</span> <span class="n">item_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">cache_obj</span> <span class="o">=</span> <span class="n">fetch_valid_cache</span><span class="p">(</span><span class="n">lru_obj</span><span class="p">,</span> <span class="n">invalid_stale</span><span class="p">,</span> <span class="n">item_ttl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item_release</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">cache_obj</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="n">cache_obj.val</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 当缓存失效时获取锁</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 创建共享内存 lock</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">lock</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">resty_lock</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="n">lock_shdict_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">lock</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to create lock: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">key_s</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">log.info</span><span class="p">(</span><span class="s2">&#34;try to lock with key &#34;</span><span class="p">,</span> <span class="n">key_s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 获取 lock</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">lock</span><span class="p">:</span><span class="n">lock</span><span class="p">(</span><span class="n">key_s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">elapsed</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to acquire the lock: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 再次获取缓存</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache_obj</span> <span class="o">=</span> <span class="n">fetch_valid_cache</span><span class="p">(</span><span class="n">lru_obj</span><span class="p">,</span> <span class="n">invalid_stale</span><span class="p">,</span> <span class="n">item_ttl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kc">nil</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">cache_obj</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="p">:</span><span class="n">unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">log.info</span><span class="p">(</span><span class="s2">&#34;unlock with key &#34;</span><span class="p">,</span> <span class="n">key_s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="n">cache_obj.val</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">obj</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">create_obj_fun</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">obj</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">lru_obj</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">version</span><span class="p">},</span> <span class="n">item_ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="p">:</span><span class="n">unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">log.info</span><span class="p">(</span><span class="s2">&#34;unlock with key &#34;</span><span class="p">,</span> <span class="n">key_s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>这段代码关联到两个 PR:</p>
<ol>
<li><a href="https://github.com/apache/apisix/pull/1486" target="_blank" rel="noopener">bugfix(lrucache): when creating cached objects, use resty-lock to avoid repeated creation.</a></li>
<li><a href="https://github.com/apache/apisix/pull/2575" target="_blank" rel="noopener">change: make lrucache lock optional</a></li>
</ol>
<p>使用 <a href="https://github.com/openresty/lua-resty-lock" target="_blank" rel="noopener">lua-resty-lock</a> 通过共享内存竞争锁，用在缓存中避免缓存击穿，当该 Lib 出于 Luajit 限制，无法在 <code>init_by_lua</code>, <code>init_worker_by_lua</code>, <code>header_filter_by_lua</code>, <code>body_filter_by_lua</code>, <code>balancer_by_lua</code>, <code>log_by_lua </code> 阶段中使用。</p>
<p>引入的 <code>serial_creating</code> 属性用于判断插件是否需要启用锁。</p>
<blockquote>
<p>Kong 使用的 <a href="https://github.com/thibaultcha/lua-resty-mlcache" target="_blank" rel="noopener">lua-resty-mlcache</a> 库内部也使用 resty.lock 防止缓存击穿（可选）。</p>
</blockquote>
<h3 id="43-后台任务">4.3. 后台任务</h3>
<p>两个地方默认初始化了定时器（Nginx Timer）执行后台任务。</p>
<ol>
<li><code>init_by_lua</code> 阶段创建 OpenResty 特权进程，负责执行特定的后台任务，不会干扰其他 Worker 进程，权限相当于 root；</li>
<li><code>init_by_worker</code> 阶段创建 Background Timer，执行并发执行后台任务。</li>
</ol>
<p>OpenResty 特权进程不能处理请求，只能由 Timer 触发，逻辑上编写 <code>if type(ngx.process.type()) == &quot;privileged agent&quot;</code> 只在特权进程中执行操作。<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>
<blockquote>
<p>Enables the privileged agent process in Nginx.</p>
<p>The privileged agent process does not listen on any virtual server ports like those worker processes. And it uses the same system account as the nginx master process, which is usually a privileged account like <code>root</code>.</p>
<p>The <code>init_worker_by_lua*</code> directive handler still runs in the privileged agent process. And one can use the <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/process.md#type" target="_blank" rel="noopener">type</a> function provided by this module to check if the current process is a privileged agent.<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- worker 默认后台运行的 timer, 执行各种后台任务 </span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">background_timer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">core.table</span><span class="p">.</span><span class="n">nkeys</span><span class="p">(</span><span class="n">timers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">timer</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">timers</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;run timer[&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&#34;]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 开启协程执行</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">th</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">thread_spawn</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">th</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to spawn thread for timer [&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&#34;]: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">goto</span> <span class="nl">continue</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">core.table</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">::</span><span class="nl">continue</span><span class="p">::</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">thread_wait</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">threads</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to wait threads: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">each_ttl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep_succ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">check_interval</span> <span class="o">=</span> <span class="n">check_interval</span><span class="p">,</span> <span class="c1">-- 默认间隔为 1 秒</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">timer</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">core.timer</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&#34;background&#34;</span><span class="p">,</span> <span class="n">background_timer</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">timer</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to create background timer: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">core.log</span><span class="p">.</span><span class="n">notice</span><span class="p">(</span><span class="s2">&#34;succeed to create background timer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>APISIX 引入特权进程的一个目的在于实现 Log Rotate 插件功能。</p>
<h2 id="5-请求生命周期">5. 请求生命周期</h2>
<h3 id="51-ctx">5.1. ctx</h3>
<blockquote>
<p>Use <code>ngx.ctx</code> wherever you can. <code>ngx.var</code> is much  more expensive and is also limited to string values. The latter should  only be used to exchange data with other nginx C modules.<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup></p>
</blockquote>
<p>APISIX 中使用缓存 <code>ngx.var</code> 获取的结果， 在不同生命周期中传递。使用 <a href="https://github.com/api7/lua-var-nginx-module" target="_blank" rel="noopener">lua-var-nginx-module</a> Nginx C 模块和 FFI 获取变量，在没有开启 Nginx C 模块的情况下回退到 <code>ngx.var</code> 方式获取。APISIX 默认没有在构建脚本中加载 C 模块，提交的 PR <a href="https://github.com/api7/apisix-build-tools/pull/44" target="_blank" rel="noopener">feat: add lua-var-nginx-module</a> 在编译 OpenResty 时添加了该模块。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">set_vars_meta</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 从 table 池中获取/创建一个 hash 长度为 32 的 table</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">var</span> <span class="o">=</span> <span class="n">tablepool.fetch</span><span class="p">(</span><span class="s2">&#34;ctx_var&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">var._cache</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">var._cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 通过 resty.core.base 获取原始 request C 指针 (?)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- ref: https://github.com/openresty/lua-resty-core/blob/master/lib/resty/core/base.lua</span>
</span></span><span class="line"><span class="cl">    <span class="n">var._request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 绑定元表</span>
</span></span><span class="line"><span class="cl">    <span class="n">setmetatable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 缓存到 ngx ctx 中</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx.var</span> <span class="o">=</span> <span class="n">var</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>使用 <a href="https://github.com/openresty/lua-tablepool" target="_blank" rel="noopener">tablepool</a> 从 Lua table 池中获取 table，避免频繁分配内存。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 获取特殊 var 类型的方法</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">var_methods</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span> <span class="o">=</span> <span class="n">ngx.req</span><span class="p">.</span><span class="n">get_method</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- ref: https://github.com/cloudflare/lua-resty-cookie</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span> <span class="o">=</span> <span class="kr">function</span> <span class="p">()</span> <span class="kr">return</span> <span class="n">ck</span><span class="p">:</span><span class="n">new</span><span class="p">()</span> <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ngx_var_names</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">upstream_scheme</span>            <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">upstream_host</span>              <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">var_x_forwarded_proto</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">mt</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 重载 hash 元方法</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- t 是 self</span>
</span></span><span class="line"><span class="cl">        <span class="n">__index</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">-- 若 cache table 存在直接返回</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">t._cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">cached</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="kr">return</span> <span class="n">cached</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;string&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">error</span><span class="p">(</span><span class="s2">&#34;invalid argument, expect string value&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- 如果是特殊类型, 使用特定方法获取</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">method</span> <span class="o">=</span> <span class="n">var_methods</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">method</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">method</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">core_str.has_prefix</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&#34;cookie_&#34;</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- 通过 var_methods 访问到 resty.cookie</span>
</span></span><span class="line"><span class="cl">                <span class="kd">local</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">t.cookie</span>
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="n">cookie</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">local</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">                    <span class="n">val</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">sub_str</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="kr">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                        <span class="n">log.warn</span><span class="p">(</span><span class="s2">&#34;failed to fetch cookie value by key: &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">key</span><span class="p">,</span> <span class="s2">&#34; error: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">core_str.has_prefix</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&#34;http_&#34;</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">:</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">key</span> <span class="o">=</span> <span class="n">re_gsub</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&#34;-&#34;</span><span class="p">,</span> <span class="s2">&#34;_&#34;</span><span class="p">,</span> <span class="s2">&#34;jo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- 最终通过 ngx.var 获取</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">get_var</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">t._request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">core_str.has_prefix</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&#34;graphql_&#34;</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- trim the &#34;graphql_&#34; prefix</span>
</span></span><span class="line"><span class="cl">                <span class="n">key</span> <span class="o">=</span> <span class="n">sub_str</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">get_parsed_graphql</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;route_id&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span> <span class="ow">and</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx.route_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;service_id&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span> <span class="ow">and</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx.service_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;consumer_name&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span> <span class="ow">and</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx.consumer_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;route_name&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span> <span class="ow">and</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx.route_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;service_name&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span> <span class="ow">and</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx.service_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;balancer_ip&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span> <span class="ow">and</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx.balancer_ip</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;balancer_port&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span> <span class="ow">and</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx.balancer_port</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">get_var</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">t._request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">val</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">t._cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">-- 为空返回 nil</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">__newindex</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">ngx_var_names</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">ngx_var</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">-- log.info(&#34;key: &#34;, key, &#34; new val: &#34;, val)</span>
</span></span><span class="line"><span class="cl">            <span class="n">t._cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>部分 APISIX 路由匹配的内部参数在其他阶段注入。</p>
<h3 id="52-headers">5.2. headers</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 用 ngx.ctx table 缓存 headers, 避免再进行一次 ffi 调用</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">_headers</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ctx</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ngx.ctx</span><span class="p">.</span><span class="n">api_ctx</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">ctx.headers</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">headers</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span> <span class="o">=</span> <span class="n">get_headers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx.headers</span> <span class="o">=</span> <span class="n">headers</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">headers</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>用到了上述的 ctx 库。</p>
<h2 id="6-etcd">6. etcd</h2>
<p>etcd 在 APISIX 中作用相同与 PostgreSQL 之于 Kong，内部使用 <a href="https://github.com/api7/lua-resty-etcd" target="_blank" rel="noopener">lua-resty-etcd</a> 作为客户端，使用 timer 定时执行和长轮询获取跟踪 etcd 中数据的变化。</p>
<p>这里的优化点与 Kong 一样，在 <code>init_by_lua</code> 阶段进行数据的 warm up，之后数据会 fork 到其他的进程中。</p>
<blockquote>
<p>It does not really make much sense to use this library in the context of <a href="https://github.com/openresty/lua-nginx-module#lua_shared_dict" target="_blank" rel="noopener">init_by_lua</a> because the cache will not get shared by any of the worker processes (unless you just want to &ldquo;warm up&rdquo; the cache with predefined items which will get inherited by the workers via <code>fork()</code>).<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup></p>
</blockquote>
<h3 id="61-初始化">6.1. 初始化</h3>
<p>读取 etcd 数据到全局单例的 Lua table。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 初始化 etcd</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">local_conf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">config_local.local_conf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">local_conf</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">table.try_read_attr</span><span class="p">(</span><span class="n">local_conf</span><span class="p">,</span> <span class="s2">&#34;apisix&#34;</span><span class="p">,</span> <span class="s2">&#34;disable_sync_configuration_during_start&#34;</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 获取 etcd cli</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">etcd_cli</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_etcd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">etcd_cli</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to start a etcd instance: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">etcd_conf</span> <span class="o">=</span> <span class="n">local_conf.etcd</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">etcd_conf.prefix</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 加载 etcd 所有数据到 lua table 中, 单例模式</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">res</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">etcd_cli</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">create_formatter</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>对数据进行格式化，存入 Lua table 中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 创建格式化 formatter</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">create_formatter</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 返回闭包函数, 对 etcd 返回的结果进行格式化</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 格式个毛, 这就是个 hook 函数</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kr">function</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">res.body</span><span class="p">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">dirs</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">is_http</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">dirs</span> <span class="o">=</span> <span class="n">constants.HTTP_ETCD_DIRECTORY</span>
</span></span><span class="line"><span class="cl">        <span class="kr">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">dirs</span> <span class="o">=</span> <span class="n">constants.STREAM_ETCD_DIRECTORY</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">curr_dir_data</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">curr_key</span>
</span></span><span class="line"><span class="cl">        <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">item</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">res.body</span><span class="p">.</span><span class="n">kvs</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">curr_dir_data</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- 将匹配的内容插入 table</span>
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="n">core_str.has_prefix</span><span class="p">(</span><span class="n">item.key</span><span class="p">,</span> <span class="n">curr_key</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                    <span class="n">table.insert</span><span class="p">(</span><span class="n">curr_dir_data</span><span class="p">,</span> <span class="n">etcd_apisix.kvs_to_node</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="kr">goto</span> <span class="nl">CONTINUE</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">curr_dir_data</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">-- 截取 prefix 后的 key</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">key</span> <span class="o">=</span> <span class="n">sub_str</span><span class="p">(</span><span class="n">item.key</span><span class="p">,</span> <span class="o">#</span><span class="n">prefix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">dirs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- single item</span>
</span></span><span class="line"><span class="cl">                <span class="n">loaded_configuration</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">body</span> <span class="o">=</span> <span class="n">etcd_apisix.kvs_to_node</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">headers</span> <span class="o">=</span> <span class="n">res.headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="kr">else</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- 前缀一致</span>
</span></span><span class="line"><span class="cl">                <span class="kd">local</span> <span class="n">key</span> <span class="o">=</span> <span class="n">sub_str</span><span class="p">(</span><span class="n">item.key</span><span class="p">,</span> <span class="o">#</span><span class="n">prefix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">item.key</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">-- 去掉末尾的 /</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- ensure the same key hasn&#39;t been handled as single item</span>
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="n">dirs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">loaded_configuration</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                    <span class="n">loaded_configuration</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">nodes</span> <span class="o">=</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">headers</span> <span class="o">=</span> <span class="n">res.headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">curr_dir_data</span> <span class="o">=</span> <span class="n">loaded_configuration</span><span class="p">[</span><span class="n">key</span><span class="p">].</span><span class="n">body.nodes</span>
</span></span><span class="line"><span class="cl">                    <span class="n">curr_key</span> <span class="o">=</span> <span class="n">item.key</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">::</span><span class="nl">CONTINUE</span><span class="p">::</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>这部分逻辑在 <code>init_by_lua</code> 执行，fork 到其他子进程。</p>
<h3 id="62-数据校验">6.2. 数据校验</h3>
<p><code>schema_def.lua</code> 文件中定义了所有储存数据结构的 schema 校验规则，使用 <a href="https://github.com/api7/jsonschema" target="_blank" rel="noopener">jsonschema</a> 库进行数据校验。</p>
<p><code>core/schema.lua</code> 中使用 LRU 缓存校验器。</p>
<p><code>load_full_data</code> 函数加载数据结构所需的 etcd kvs，并进行数据转换、校验、格式化、执行回调。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-4_huc8d6f72b75c05795fcfda6cf451a7b1c_22405_e4d9b27c3318206dbbd6501931928acd.webp 400w,
               /blog/apisix-source-code-reading/graph-4_huc8d6f72b75c05795fcfda6cf451a7b1c_22405_d8e17dca350974d944ef184925d24feb.webp 760w,
               /blog/apisix-source-code-reading/graph-4_huc8d6f72b75c05795fcfda6cf451a7b1c_22405_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-4_huc8d6f72b75c05795fcfda6cf451a7b1c_22405_e4d9b27c3318206dbbd6501931928acd.webp"
               width="760"
               height="549"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">load_full_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dir_res</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">changed</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">self.single_item</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- table size 为 1</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 执行逻辑与下面数组格式类似</span>
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">dir_res.nodes</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">dir_res.nodes</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">self.values</span> <span class="o">=</span> <span class="n">new_tab</span><span class="p">(</span><span class="o">#</span><span class="n">dir_res.nodes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">self.values_hash</span> <span class="o">=</span> <span class="n">new_tab</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">#</span><span class="n">dir_res.nodes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">item</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">dir_res.nodes</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">key</span> <span class="o">=</span> <span class="n">short_key</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item.key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">data_valid</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">-- 数据格式校验...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">-- schema 校验...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">-- 过滤器...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">data_valid</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">changed</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="n">insert_tab</span><span class="p">(</span><span class="n">self.values</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">self.values_hash</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">#</span><span class="n">self.values</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">item.value</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">                <span class="n">item.clean_handlers</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">-- 执行回调</span>
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="n">self.filter</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                    <span class="n">self.filter</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">			<span class="c1">-- 更新 mvcc 版本</span>
</span></span><span class="line"><span class="cl">            <span class="n">self</span><span class="p">:</span><span class="n">upgrade_version</span><span class="p">(</span><span class="n">item.modifiedIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">self.need_reload</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="63-后台数据同步">6.3. 后台数据同步</h3>
<p>利用 etcd watch 机制进行数据变更的同步。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-5_hu82f5b014c7d25ae877f8d7b7e6e0ea2b_44799_6a4a590940faf3f67aac3c25d6355c55.webp 400w,
               /blog/apisix-source-code-reading/graph-5_hu82f5b014c7d25ae877f8d7b7e6e0ea2b_44799_70d723f01cd4ede621d78656f4d77bc8.webp 760w,
               /blog/apisix-source-code-reading/graph-5_hu82f5b014c7d25ae877f8d7b7e6e0ea2b_44799_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-5_hu82f5b014c7d25ae877f8d7b7e6e0ea2b_44799_6a4a590940faf3f67aac3c25d6355c55.webp"
               width="754"
               height="760"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 定时器自动同步 etcd 数据</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">_automatic_fetch</span><span class="p">(</span><span class="n">premature</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">premature</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="kr">while</span> <span class="ow">not</span> <span class="n">exiting</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self.running</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">xpcall</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="ow">not</span> <span class="n">self.etcd_cli</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="kd">local</span> <span class="n">etcd_cli</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_etcd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="ow">not</span> <span class="n">etcd_cli</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                    <span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to create etcd instance for key [&#34;</span>
</span></span><span class="line"><span class="cl">                          <span class="o">..</span> <span class="n">self.key</span> <span class="o">..</span> <span class="s2">&#34;]: &#34;</span> <span class="o">..</span> <span class="p">(</span><span class="n">err</span> <span class="ow">or</span> <span class="s2">&#34;unknown&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">                <span class="n">self.etcd_cli</span> <span class="o">=</span> <span class="n">etcd_cli</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">-- 同步数据</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">sync_data</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="n">err</span> <span class="o">~=</span> <span class="s2">&#34;timeout&#34;</span> <span class="ow">and</span> <span class="n">err</span> <span class="o">~=</span> <span class="s2">&#34;Key not found&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="ow">and</span> <span class="n">self.last_err</span> <span class="o">~=</span> <span class="n">err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log.error</span><span class="p">(</span><span class="s2">&#34;failed to fetch data from etcd: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s2">&#34;, &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">tostring</span><span class="p">(</span><span class="n">self</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kr">if</span> <span class="n">err</span> <span class="o">~=</span> <span class="n">self.last_err</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                    <span class="n">self.last_err</span> <span class="o">=</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">                    <span class="n">self.last_err_time</span> <span class="o">=</span> <span class="n">ngx_time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="kr">else</span>
</span></span><span class="line"><span class="cl">                    <span class="kr">if</span> <span class="n">ngx_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self.last_err_time</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                        <span class="n">self.last_err</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">ngx_sleep</span><span class="p">(</span><span class="n">self.resync_delay</span> <span class="o">+</span> <span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">self.resync_delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">elseif</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- no error. reentry the sync with different state</span>
</span></span><span class="line"><span class="cl">                <span class="n">ngx_sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">end</span><span class="p">,</span> <span class="n">debug.traceback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">log.error</span><span class="p">(</span><span class="s2">&#34;failed to fetch data from etcd: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s2">&#34;, &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">tostring</span><span class="p">(</span><span class="n">self</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">ngx_sleep</span><span class="p">(</span><span class="n">self.resync_delay</span> <span class="o">+</span> <span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">self.resync_delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">break</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 进行下一次循环</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">exiting</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self.running</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">ngx_timer_at</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_automatic_fetch</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="64-配置同步">6.4. 配置同步</h3>
<p>封装上述的逻辑提供给 <code>routes</code>、<code>plugins</code>、<code>services</code> 等数据结构使用，每个数据结构监听自己的 prefix，同步数据并执行回调，通常在回调逻辑上触发更新，例如重新构建 Router、重新构建 plugins table 等。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- etcd 配置创建</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">local_conf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">config_local.local_conf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">local_conf</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- etcd 重新同步事件 5 秒, 与 Kong 重新 poll db 数据一致</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">etcd_conf</span> <span class="o">=</span> <span class="n">local_conf.etcd</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">etcd_conf.prefix</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">resync_delay</span> <span class="o">=</span> <span class="n">etcd_conf.resync_delay</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">resync_delay</span> <span class="ow">or</span> <span class="n">resync_delay</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">resync_delay</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">automatic</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.automatic</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">item_schema</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.item_schema</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">filter_fun</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.filter</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.timeout</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">single_item</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.single_item</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">checker</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">and</span> <span class="n">opts.checker</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">setmetatable</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="n">etcd_cli</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">..</span> <span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">automatic</span> <span class="o">=</span> <span class="n">automatic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">item_schema</span> <span class="o">=</span> <span class="n">item_schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">checker</span> <span class="o">=</span> <span class="n">checker</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">sync_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">values</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">need_reload</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">routes_hash</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_err</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_err_time</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">resync_delay</span> <span class="o">=</span> <span class="n">resync_delay</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">single_item</span> <span class="o">=</span> <span class="n">single_item</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">filter</span> <span class="o">=</span> <span class="n">filter_fun</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">mt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">automatic</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- timer 定时获取数据</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;missing `key` argument&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 从单例 table 获取 etcd 数据, 进行处理</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">loaded_configuration</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">loaded_configuration</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- 清空 table</span>
</span></span><span class="line"><span class="cl">            <span class="n">loaded_configuration</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span> <span class="c1">-- tried to load</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">log.notice</span><span class="p">(</span><span class="s2">&#34;use loaded configuration &#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">dir_res</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">res.body</span><span class="p">,</span> <span class="n">res.headers</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- 加载数据并校验数据, 过滤数据</span>
</span></span><span class="line"><span class="cl">            <span class="n">load_full_data</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dir_res</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 创建定时器自动同步</span>
</span></span><span class="line"><span class="cl">        <span class="n">ngx_timer_at</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_automatic_fetch</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">etcd_cli</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_etcd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">etcd_cli</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s2">&#34;failed to start a etcd instance: &#34;</span> <span class="o">..</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="n">obj.etcd_cli</span> <span class="o">=</span> <span class="n">etcd_cli</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">key</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">created_obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">obj</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h2 id="7-router">7. Router</h2>
<p>APISIX 的 Router 匹配基于压缩字典树（Radix Tree）实现，主要使用 <a href="https://github.com/api7/lua-resty-radixtree" target="_blank" rel="noopener">lua-resty-radixtree</a> 库。内置多种解析模式，这里只关注 HTTP 默认的 <code>radixtree_uri</code> 实现。</p>
<h3 id="71-路由构建">7.1. 路由构建</h3>
<p><code>core.config.new</code> 调用的是 etcd 库（<code>config_etcd.lua</code>）维护的配置同步方法，返回原表，可以访问从 etcd 同步的数据。<code>core.schema.route</code> 包含了 route 这个数据结构的 schema 及校验规则，<code>check_route</code> 内部检查 route 直接绑定 plugin 的数据结构。</p>
<blockquote>
<p>APISIX 引入 route 直接绑定 plugin 的简化配置，不需要额外创建 plugin 对象。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 初始化 router</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">init_worker</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">user_routes</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">core.config</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&#34;/routes&#34;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">automatic</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 自动同步</span>
</span></span><span class="line"><span class="cl">            <span class="n">item_schema</span> <span class="o">=</span> <span class="n">core.schema</span><span class="p">.</span><span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">checker</span> <span class="o">=</span> <span class="n">check_route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">filter</span> <span class="o">=</span> <span class="n">filter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">user_routes</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to create etcd instance for fetching /routes : &#34;</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">user_routes</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>filter</code> 是回调函数，下述的流程中会注入。</p>
<h3 id="72-路由初始化">7.2. 路由初始化</h3>
<p><code>router.http_init_worker</code> 中进行 Router 初始化。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-6_hu1a1eda452c9e489ee77deea598c36663_31155_7890882f2b98c798aa5200a68d57f2d4.webp 400w,
               /blog/apisix-source-code-reading/graph-6_hu1a1eda452c9e489ee77deea598c36663_31155_1ab71088db1d370335beb95e9aab2b27.webp 760w,
               /blog/apisix-source-code-reading/graph-6_hu1a1eda452c9e489ee77deea598c36663_31155_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-6_hu1a1eda452c9e489ee77deea598c36663_31155_7890882f2b98c798aa5200a68d57f2d4.webp"
               width="760"
               height="709"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- attach common methods if the router doesn&#39;t provide its custom implementation</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">attach_http_router_common_methods</span><span class="p">(</span><span class="n">http_router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">http_router.init_worker</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">http_router.init_worker</span> <span class="o">=</span> <span class="kr">function</span> <span class="p">(</span><span class="n">filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- 添加路由</span>
</span></span><span class="line"><span class="cl">            <span class="n">http_router.user_routes</span> <span class="o">=</span> <span class="n">http_route.init_worker</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">http_init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">core.config</span><span class="p">.</span><span class="n">local_conf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 默认的匹配模式</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">router_http_name</span> <span class="o">=</span> <span class="s2">&#34;radixtree_uri&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">router_ssl_name</span> <span class="o">=</span> <span class="s2">&#34;radixtree_sni&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">conf</span> <span class="ow">and</span> <span class="n">conf.apisix</span> <span class="ow">and</span> <span class="n">conf.apisix</span><span class="p">.</span><span class="n">router</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">router_http_name</span> <span class="o">=</span> <span class="n">conf.apisix</span><span class="p">.</span><span class="n">router.http</span> <span class="ow">or</span> <span class="n">router_http_name</span>
</span></span><span class="line"><span class="cl">        <span class="n">router_ssl_name</span> <span class="o">=</span> <span class="n">conf.apisix</span><span class="p">.</span><span class="n">router.ssl</span> <span class="ow">or</span> <span class="n">router_ssl_name</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 创建 router 实例</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">router_http</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.http.router.&#34;</span> <span class="o">..</span> <span class="n">router_http_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 修改 router 的 table</span>
</span></span><span class="line"><span class="cl">    <span class="n">attach_http_router_common_methods</span><span class="p">(</span><span class="n">router_http</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 初始化路由</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 调用 apisix.http.route.init_worker 方法</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 从 etcd 获取数据并执行回调</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- filter 为格式化, 解析 upstream</span>
</span></span><span class="line"><span class="cl">    <span class="n">router_http.init_worker</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_M.router_http</span> <span class="o">=</span> <span class="n">router_http</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">router_ssl</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.ssl.router.&#34;</span> <span class="o">..</span> <span class="n">router_ssl_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">router_ssl.init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">_M.router_ssl</span> <span class="o">=</span> <span class="n">router_ssl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_M.api</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.api_router&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>http_router.user_routes</code> 储存在 router 的 table 中，会在路由匹配时用到（懒加载）。</p>
<h3 id="73-路由匹配">7.3. 路由匹配</h3>
<p><code>access_by_lua</code> 阶段中进行路由匹配，将匹配结果（route、service）传递到 ctx 中供 balancer 请求上游。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">uri_routes</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">uri_router</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">match_opts</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 从 module 的 user_routes 属性获取路由, 在 etcd route 变化时回调添加</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">user_routes</span> <span class="o">=</span> <span class="n">_M.user_routes</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">cached_version</span> <span class="ow">or</span> <span class="n">cached_version</span> <span class="o">~=</span> <span class="n">user_routes.conf_version</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">uri_router</span> <span class="o">=</span> <span class="n">base_router.create_radixtree_uri_router</span><span class="p">(</span><span class="n">user_routes.values</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                <span class="n">uri_routes</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cached_version</span> <span class="o">=</span> <span class="n">user_routes.conf_version</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">uri_router</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to fetch valid `uri` router: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">base_router.match_uri</span><span class="p">(</span><span class="n">uri_router</span><span class="p">,</span> <span class="n">match_opts</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><code>radixtree</code> 路由匹配库提供了匹配成功回调 handler，匹配成功后传递到 ctx 中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">core.table</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">uri_routes</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="p">...</span>
</span></span><span class="line"><span class="cl">                <span class="n">handler</span> <span class="o">=</span> <span class="kr">function</span> <span class="p">(</span><span class="n">api_ctx</span><span class="p">,</span> <span class="n">match_opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">api_ctx.matched_params</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                    <span class="n">api_ctx.matched_route</span> <span class="o">=</span> <span class="n">route</span>
</span></span><span class="line"><span class="cl">                    <span class="n">api_ctx.curr_req_matched</span> <span class="o">=</span> <span class="n">match_opts.matched</span>
</span></span><span class="line"><span class="cl">                <span class="kr">end</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span></code></pre></div><h2 id="8-balancer">8. Balancer</h2>
<p>Balancer 部分与 Kong 逻辑一致，甚至代码里函数名都一样，主要逻辑是 Service/Upstream 节点解析、负载均衡策略、健康检查与失败重试。</p>
<p>APISIX 支持的一特性是外部服务发现，Kong 中默认支持通过 DNS 解析 Service host，根据 AAAA、A、SRV 记录添加 IP 与优先级，APISIX 支持了从 consul、eruka 和其他注册中心获取 IP 地址列表，并同步节点数据（长轮询）。</p>
<h3 id="81-服务发现">8.1. 服务发现</h3>
<p>如果 serivce host 是域名, 通过外部注册中心进行服务发现，获取上游 IP 列表。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">set_by_route</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 如果 serivce host 是域名, 通过 discovery 发现, dns 解析</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">up_conf.service_name</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 外部注册中心</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">dis</span> <span class="o">=</span> <span class="n">discovery</span><span class="p">[</span><span class="n">up_conf.discovery_type</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">dis</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&#34;discovery &#34;</span> <span class="o">..</span> <span class="n">up_conf.discovery_type</span> <span class="o">..</span> <span class="s2">&#34; is uninitialized&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 从注册中心数据源（缓存本地 table）获取 IP</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">new_nodes</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dis.nodes</span><span class="p">(</span><span class="n">up_conf.service_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">new_nodes</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kr">return</span> <span class="n">HTTP_CODE_UPSTREAM_UNAVAILABLE</span><span class="p">,</span> <span class="s2">&#34;no valid upstream node: &#34;</span> <span class="o">..</span> <span class="p">(</span><span class="n">err</span> <span class="ow">or</span> <span class="s2">&#34;nil&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 将 upstream 节点信息存入 ctx</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_directly</span><span class="p">(</span><span class="n">api_ctx</span><span class="p">,</span> <span class="n">up_conf.type</span> <span class="o">..</span> <span class="s2">&#34;#upstream_&#34;</span> <span class="o">..</span> <span class="n">tostring</span><span class="p">(</span><span class="n">up_conf</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                 <span class="n">api_ctx.conf_version</span><span class="p">,</span> <span class="n">up_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">nodes_count</span> <span class="o">=</span> <span class="n">up_conf.nodes</span> <span class="ow">and</span> <span class="o">#</span><span class="n">up_conf.nodes</span> <span class="ow">or</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">nodes_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">HTTP_CODE_UPSTREAM_UNAVAILABLE</span><span class="p">,</span> <span class="s2">&#34;no valid upstream node&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">set_upstream_scheme</span><span class="p">(</span><span class="n">api_ctx</span><span class="p">,</span> <span class="n">up_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">fill_node_info</span><span class="p">(</span><span class="n">up_conf</span><span class="p">,</span> <span class="n">api_ctx.upstream_scheme</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="mi">503</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">scheme</span> <span class="o">=</span> <span class="n">up_conf.scheme</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&#34;https&#34;</span> <span class="ow">or</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s2">&#34;grpcs&#34;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">up_conf.tls</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="82-负载均衡">8.2. 负载均衡</h3>
<p>不同于 Kong 使用自己封装的 <a href="https://github.com/Kong/lua-resty-dns-client/tree/master/src/resty/dns/balancer" target="_blank" rel="noopener">lua-resty-dns-client/balancer</a> 作为负载均衡器，APISIX 基于 <a href="https://github.com/openresty/lua-resty-balancer" target="_blank" rel="noopener">lua-resty-balancer</a> 封装了负载均衡策略，基于 <a href="https://github.com/Kong/lua-resty-healthcheck" target="_blank" rel="noopener">lua-resty-healthcheck</a>（fork 版本）实现节点健康检查。</p>
<p>API 网关的负载均衡策略（Kong/APISIX）都是基于 OpenResty <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/balancer.md#set_current_peer" target="_blank" rel="noopener">lua-resty-core/balancer</a> 提供的负载均衡函数实现，<code>set_current_peer</code> 设置当前请求上游地址，<code>set_more_tries</code> 设置请求失败重试次数，<code>get_last_failure</code> 获取上一次请求失败结果判断是否需要继续重试，<code>set_timeouts</code> 设置单个请求超时时间。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-7_hu3151aaec3c16072f2fd321742c9aeddf_53299_1853d42df50fd2c33c28af7f07425da9.webp 400w,
               /blog/apisix-source-code-reading/graph-7_hu3151aaec3c16072f2fd321742c9aeddf_53299_1089f152c62023a721fd99769b290b2e.webp 760w,
               /blog/apisix-source-code-reading/graph-7_hu3151aaec3c16072f2fd321742c9aeddf_53299_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-7_hu3151aaec3c16072f2fd321742c9aeddf_53299_1853d42df50fd2c33c28af7f07425da9.webp"
               width="760"
               height="571"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p><code>set_balancer_opts</code> 设置 Nginx Balancer 参数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- set_balancer_opts will be called in balancer phase and before any tries</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">set_balancer_opts</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">up_conf</span> <span class="o">=</span> <span class="n">ctx.upstream_conf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- If the matched route has timeout config, prefer to use the route config.</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">timeout</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">route</span> <span class="ow">and</span> <span class="n">route.value</span> <span class="ow">and</span> <span class="n">route.value</span><span class="p">.</span><span class="n">timeout</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="n">route.value</span><span class="p">.</span><span class="n">timeout</span>
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">up_conf.timeout</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">timeout</span> <span class="o">=</span> <span class="n">up_conf.timeout</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 设置 Nginx 请求超时时间</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">timeout</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">set_timeouts</span><span class="p">(</span><span class="n">timeout.connect</span><span class="p">,</span> <span class="n">timeout.send</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">timeout.read</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;could not set upstream timeouts: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">retries</span> <span class="o">=</span> <span class="n">up_conf.retries</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">retries</span> <span class="ow">or</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">retries</span> <span class="o">=</span> <span class="o">#</span><span class="n">up_conf.nodes</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 设置 Nginx 失败重试次数</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">set_more_tries</span><span class="p">(</span><span class="n">retries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>在 <code>access_by_lua</code> 阶段中服务发现，调用 balancer 库获取 peer 节点，<code>balancer_by_lua</code> 中从 ctx 中获取 peer 节点信息，访问后端节点，若失败重试（该阶段再次被调用），重新获取 peer 节点，重新创建请求（<code>recreate_request()</code>）再次访问后端节点。</p>
<h2 id="9-plugin">9. Plugin</h2>
<p>插件机制也与 Kong 类似，插件开发者可以定义 Schema 配置数据结构，以及 Handler 注入 Nginx 请求生命周期，API 网关提供核心的库供开发者使用（SDK）。</p>
<p>APISIX 相比 Kong，开源的插件较多，插件 Schema 便于编写，同时插件只需要单文件，而 Kong 的插件通常是单独一个仓库，不方便维护。但是考虑到插件需要单独的 Test::Nginx 单元测试，单独一个仓库也未尝不可（Kong 还说了以后会把 Github 项目主仓库的插件代码移到单独的仓库）。</p>
<p>具体各个阶段执行逻辑应该与 Kong 相同，即部分阶段插件开协程并发执行，部分阶段避免数据竞争，插件顺序执行。</p>
<p>值得注意的一点是 APISIX 生命周期里没有 <code>rewrite_by_lua</code> 阶段，插件实现的该阶段会在 <code>access_by_lua</code> 中优先于 <code>access_by_lua</code> 插件逻辑执行。</p>
<blockquote>
<p>The apisix run both &ldquo;.access&rdquo; and &ldquo;.rewrite&rdquo; in the &ldquo;access&rdquo; phase.<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup></p>
</blockquote>
<h3 id="91-插件加载">9.1. 插件加载</h3>
<p>插件列表从本地 yaml 文件获取，同时监听本地文件变化，同步配置；插件配置信息从 etcd 获取。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">init_plugins_syncer</span>
</span></span><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">plugins_conf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">function</span> <span class="nf">init_plugins_syncer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 储存插件的配置信息, 一条 kv</span>
</span></span><span class="line"><span class="cl">        <span class="n">plugins_conf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">core.config</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&#34;/plugins&#34;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">automatic</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 后台创建 timer watch etcd 自动同步配置</span>
</span></span><span class="line"><span class="cl">            <span class="n">item_schema</span> <span class="o">=</span> <span class="n">core.schema</span><span class="p">.</span><span class="n">plugins</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">single_item</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- filter 方法中访问到 etcd kv 的 item, 这里进行插件加载的回调</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- 每次 etcd 插件配置变动, 自动同步</span>
</span></span><span class="line"><span class="cl">            <span class="n">filter</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- we need to pass &#39;item&#39; instead of plugins_conf because</span>
</span></span><span class="line"><span class="cl">                <span class="c1">-- the latter one is nil at the first run</span>
</span></span><span class="line"><span class="cl">                <span class="n">_M.load</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">plugins_conf</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to create etcd instance for fetching /plugins : &#34;</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>插件列表会储存到 Lua table 中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 加载插件</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">load</span><span class="p">(</span><span class="n">plugin_names</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">processed</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">plugin_names</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">processed</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">processed</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">core.log</span><span class="p">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&#34;new plugins: &#34;</span><span class="p">,</span> <span class="n">core.json</span><span class="p">.</span><span class="n">delay_encode</span><span class="p">(</span><span class="n">processed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 移除已经存在的 module</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">name</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">local_plugins_hash</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">unload_plugin</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">core.table</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">local_plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">core.table</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">local_plugins_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 加载插件</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">name</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">load_plugin</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">local_plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 插件排序, priority 越高的插件越先执行, 与 Kong 同样</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- sort by plugin&#39;s priority</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="o">#</span><span class="n">local_plugins</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">sort_tab</span><span class="p">(</span><span class="n">local_plugins</span><span class="p">,</span> <span class="n">sort_plugin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 打印调试日志</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">plugin</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">local_plugins</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>插件配置信息 <code>plugin_meta</code> 也加载到 Lua table 中，在插件匹配的时候会获取。</p>
<h3 id="92-插件匹配">9.2. 插件匹配</h3>
<p>插件过滤，遍历插件列表，匹配开启的插件，O(n) 操作 <code>plugin.filter(route)</code> ：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 插件配置绑定</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">user_route</span><span class="p">,</span> <span class="n">plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">plugins</span> <span class="o">=</span> <span class="n">plugins</span> <span class="ow">or</span> <span class="n">core.tablepool</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&#34;plugins&#34;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">plugin_obj</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">local_plugins</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">name</span> <span class="o">=</span> <span class="n">plugin_obj.name</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">plugin_conf</span> <span class="o">=</span> <span class="n">user_plugin_conf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 插件和插件配置存入</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">plugin_conf</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;table&#34;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plugin_conf.disable</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">core.table</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">plugins</span><span class="p">,</span> <span class="n">plugin_obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">core.table</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">plugins</span><span class="p">,</span> <span class="n">plugin_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">trace_plugins_info_for_debug</span><span class="p">(</span><span class="n">plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">plugins</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="93-插件执行">9.3. 插件执行</h3>
<p>这里以 <code>access_by_lua</code> 阶段插件执行逻辑为例，根据 Route、Service 匹配插件，创建临时 Table 储存 plugin 和  plugin_conf，存入 ctx 中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl">        <span class="c1">-- 插件过滤, 遍历插件列表, 匹配开启的插件, O(n)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">plugins</span> <span class="o">=</span> <span class="n">plugin.filter</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">api_ctx.plugins</span> <span class="o">=</span> <span class="n">plugins</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- fake 执行 rewrite 阶段</span>
</span></span><span class="line"><span class="cl">        <span class="n">plugin.run_plugin</span><span class="p">(</span><span class="s2">&#34;rewrite&#34;</span><span class="p">,</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">api_ctx.consumer</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">changed</span>
</span></span><span class="line"><span class="cl">            <span class="n">route</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">plugin.merge_consumer_route</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">api_ctx.consumer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">api_ctx</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">core.log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;find consumer &#34;</span><span class="p">,</span> <span class="n">api_ctx.consumer</span><span class="p">.</span><span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="s2">&#34;, config changed: &#34;</span><span class="p">,</span> <span class="n">changed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">changed</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">core.table</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">api_ctx.plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">api_ctx.plugins</span> <span class="o">=</span> <span class="n">plugin.filter</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">api_ctx.plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 执行 access 阶段</span>
</span></span><span class="line"><span class="cl">        <span class="n">plugin.run_plugin</span><span class="p">(</span><span class="s2">&#34;access&#34;</span><span class="p">,</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="10-主流程">10. 主流程</h2>
<p>以 Nginx HTTP Subsystem 为例分析主要执行逻辑，其中一些核心逻辑已在上述小节中流程分析过。</p>
<h3 id="101-init_by_lua">10.1. init_by_lua</h3>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-8_hua5d5a27a1e4ea7b909b10726bd1e2997_28292_6cab95557144777e411e760dc96ef767.webp 400w,
               /blog/apisix-source-code-reading/graph-8_hua5d5a27a1e4ea7b909b10726bd1e2997_28292_38505eb33f6e9be04d17076d62241428.webp 760w,
               /blog/apisix-source-code-reading/graph-8_hua5d5a27a1e4ea7b909b10726bd1e2997_28292_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-8_hua5d5a27a1e4ea7b909b10726bd1e2997_28292_6cab95557144777e411e760dc96ef767.webp"
               width="760"
               height="725"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">http_init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;resty.core&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ffi&#34;</span><span class="p">).</span><span class="n">os</span> <span class="o">==</span> <span class="s2">&#34;Linux&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ngx.re&#34;</span><span class="p">).</span><span class="n">opt</span><span class="p">(</span><span class="s2">&#34;jit_stack_size&#34;</span><span class="p">,</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;jit.opt&#34;</span><span class="p">).</span><span class="n">start</span><span class="p">(</span><span class="s2">&#34;minstitch=2&#34;</span><span class="p">,</span> <span class="s2">&#34;maxtrace=4000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="s2">&#34;maxrecord=8000&#34;</span><span class="p">,</span> <span class="s2">&#34;sizemcode=64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="s2">&#34;maxmcode=4000&#34;</span><span class="p">,</span> <span class="s2">&#34;maxirconst=1000&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">core.resolver</span><span class="p">.</span><span class="n">init_resolver</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 生成节点 ID</span>
</span></span><span class="line"><span class="cl">    <span class="n">core.id</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 启用 openresty 的特权进程</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">process</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ngx.process&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">process.enable_privileged_agent</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to enable privileged_agent: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 从 etcd / yaml 本地配置文件获取配置, etcd 有 init 函数</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">core.config</span><span class="p">.</span><span class="n">init</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">core.config</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to load the configuration: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="102-init_worker_by_lua">10.2. init_worker_by_lua</h3>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-9_hu064bb4f8df0de4775fe10a91ecb2e2ea_34895_169551277d1caebac2e8d5c7111cdc76.webp 400w,
               /blog/apisix-source-code-reading/graph-9_hu064bb4f8df0de4775fe10a91ecb2e2ea_34895_c42d66e3d36d1c5e31e21273b3dc5c84.webp 760w,
               /blog/apisix-source-code-reading/graph-9_hu064bb4f8df0de4775fe10a91ecb2e2ea_34895_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-9_hu064bb4f8df0de4775fe10a91ecb2e2ea_34895_169551277d1caebac2e8d5c7111cdc76.webp"
               width="760"
               height="710"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/graph-10_hub1f3208f90793ccbdf8c0e1a8af7a010_40529_2eee1d691b9982928ef3cdf60ad0f61f.webp 400w,
               /blog/apisix-source-code-reading/graph-10_hub1f3208f90793ccbdf8c0e1a8af7a010_40529_fa09717b3b3067f66a3196baa9dbfc71.webp 760w,
               /blog/apisix-source-code-reading/graph-10_hub1f3208f90793ccbdf8c0e1a8af7a010_40529_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/graph-10_hub1f3208f90793ccbdf8c0e1a8af7a010_40529_2eee1d691b9982928ef3cdf60ad0f61f.webp"
               width="760"
               height="469"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">http_init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">seed</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">core.utils</span><span class="p">.</span><span class="n">get_seed_from_urandom</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">seed</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;failed to get seed from urandom: &#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="n">ngx_now</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">ngx.worker</span><span class="p">.</span><span class="n">pid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">math.randomseed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- for testing only</span>
</span></span><span class="line"><span class="cl">    <span class="n">core.log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;random test in [1, 10000]: &#34;</span><span class="p">,</span> <span class="n">math.random</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 进程间事件通信</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">we</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;resty.worker.events&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">we.configure</span><span class="p">({</span><span class="n">shm</span> <span class="o">=</span> <span class="s2">&#34;worker-events&#34;</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to init worker event: &#34;</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 服务发现 lib</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">discovery</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.discovery.init&#34;</span><span class="p">).</span><span class="n">discovery</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 默认没有开启服务发现</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">discovery</span> <span class="ow">and</span> <span class="n">discovery.init_worker</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">discovery.init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 初始化负载均衡器, 方法为空</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.balancer&#34;</span><span class="p">).</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 负载均衡器</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_balancer</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.balancer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- TODO admin 流程分析</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.admin.init&#34;</span><span class="p">).</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 注册全局 timer</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.timers&#34;</span><span class="p">).</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 加载所有插件并执行插件 init</span>
</span></span><span class="line"><span class="cl">    <span class="n">plugin.init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 初始化 router, 并加载 routes</span>
</span></span><span class="line"><span class="cl">    <span class="n">router.http_init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 初始化 services, 加载 services</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.http.service&#34;</span><span class="p">).</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 加载插件配置</span>
</span></span><span class="line"><span class="cl">    <span class="n">plugin_config.init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- consumer 加载</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.consumer&#34;</span><span class="p">).</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">core.config</span> <span class="o">==</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.core.config_yaml&#34;</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.config</span><span class="p">.</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.debug&#34;</span><span class="p">).</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- upstreams 加载</span>
</span></span><span class="line"><span class="cl">    <span class="n">apisix_upstream.init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="s2">&#34;apisix.plugins.ext-plugin.init&#34;</span><span class="p">).</span><span class="n">init_worker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">local_conf</span> <span class="o">=</span> <span class="n">core.config</span><span class="p">.</span><span class="n">local_conf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">local_conf.apisix</span> <span class="ow">and</span> <span class="n">local_conf.apisix</span><span class="p">.</span><span class="n">enable_server_tokens</span> <span class="o">==</span> <span class="kc">false</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">ver_header</span> <span class="o">=</span> <span class="s2">&#34;APISIX&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h3 id="103-access_by_lua">10.3. access_by_lua</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- access_by_lua 阶段, apisix 没有 rewrite_by_lua</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- ref: https://github.com/apache/apisix/issues/1120</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- ref: https://github.com/apache/apisix/issues/1120#issuecomment-584949073</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">_M</span><span class="p">.</span><span class="nf">http_access_phase</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ngx_ctx</span> <span class="o">=</span> <span class="n">ngx.ctx</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 从 table 缓存池中获取 table</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- always fetch table from the table pool, we don&#39;t need a reused api_ctx</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">api_ctx</span> <span class="o">=</span> <span class="n">core.tablepool</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&#34;api_ctx&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 将 table 储存在 ngx.ctx 中, 下一个阶段共享</span>
</span></span><span class="line"><span class="cl">    <span class="n">ngx_ctx.api_ctx</span> <span class="o">=</span> <span class="n">api_ctx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 绑定 metatable </span>
</span></span><span class="line"><span class="cl">    <span class="n">core.ctx</span><span class="p">.</span><span class="n">set_vars_meta</span><span class="p">(</span><span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- router 路由匹配</span>
</span></span><span class="line"><span class="cl">    <span class="n">router.router_http</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- run global rule</span>
</span></span><span class="line"><span class="cl">    <span class="n">plugin.run_global_rules</span><span class="p">(</span><span class="n">api_ctx</span><span class="p">,</span> <span class="n">router.global_rules</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">enable_websocket</span> <span class="o">=</span> <span class="n">route.value</span><span class="p">.</span><span class="n">enable_websocket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- route 插件配置绑定</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">route.value</span><span class="p">.</span><span class="n">plugin_config_id</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">       	<span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">route</span> <span class="o">=</span> <span class="n">plugin_config.merge</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 获取对应的 service</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">route.value</span><span class="p">.</span><span class="n">service_id</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">service</span> <span class="o">=</span> <span class="n">service_fetch</span><span class="p">(</span><span class="n">route.value</span><span class="p">.</span><span class="n">service_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">enable_websocket</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">enable_websocket</span> <span class="o">=</span> <span class="n">service.value</span><span class="p">.</span><span class="n">enable_websocket</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_ctx.route_id</span> <span class="o">=</span> <span class="n">route.value</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_ctx.route_name</span> <span class="o">=</span> <span class="n">route.value</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 执行 script</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">route.value</span><span class="p">.</span><span class="n">script</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">script.load</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">script.run</span><span class="p">(</span><span class="s2">&#34;access&#34;</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 插件过滤, 遍历插件列表, 匹配开启的插件, O(n)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">plugins</span> <span class="o">=</span> <span class="n">plugin.filter</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">api_ctx.plugins</span> <span class="o">=</span> <span class="n">plugins</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- fake 执行 rewrite 阶段</span>
</span></span><span class="line"><span class="cl">        <span class="n">plugin.run_plugin</span><span class="p">(</span><span class="s2">&#34;rewrite&#34;</span><span class="p">,</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">api_ctx.consumer</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="kd">local</span> <span class="n">changed</span>
</span></span><span class="line"><span class="cl">            <span class="n">route</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">plugin.merge_consumer_route</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">api_ctx.consumer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">api_ctx</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">core.log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;find consumer &#34;</span><span class="p">,</span> <span class="n">api_ctx.consumer</span><span class="p">.</span><span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="s2">&#34;, config changed: &#34;</span><span class="p">,</span> <span class="n">changed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">if</span> <span class="n">changed</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">core.table</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">api_ctx.plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">api_ctx.plugins</span> <span class="o">=</span> <span class="n">plugin.filter</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">api_ctx.plugins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 执行 access 阶段</span>
</span></span><span class="line"><span class="cl">        <span class="n">plugin.run_plugin</span><span class="p">(</span><span class="s2">&#34;access&#34;</span><span class="p">,</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">up_id</span> <span class="o">=</span> <span class="n">route.value</span><span class="p">.</span><span class="n">upstream_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- used for the traffic-split plugin</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">api_ctx.upstream_id</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">up_id</span> <span class="o">=</span> <span class="n">api_ctx.upstream_id</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- websocket 特殊处理</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">enable_websocket</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">api_ctx.var</span><span class="p">.</span><span class="n">upstream_upgrade</span>    <span class="o">=</span> <span class="n">api_ctx.var</span><span class="p">.</span><span class="n">http_upgrade</span>
</span></span><span class="line"><span class="cl">        <span class="n">api_ctx.var</span><span class="p">.</span><span class="n">upstream_connection</span> <span class="o">=</span> <span class="n">api_ctx.var</span><span class="p">.</span><span class="n">http_connection</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;enabled websocket for route: &#34;</span><span class="p">,</span> <span class="n">route.value</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">route.value</span><span class="p">.</span><span class="n">service_protocol</span> <span class="o">==</span> <span class="s2">&#34;grpc&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">api_ctx.upstream_scheme</span> <span class="o">=</span> <span class="s2">&#34;grpc&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 获取 upstream 节点</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">code</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">set_upstream</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">code</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to set upstream: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.response</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 负载均衡</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">server</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">load_balancer.pick_server</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">api_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="ow">not</span> <span class="n">server</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="n">core.log</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;failed to pick server: &#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">core.response</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">502</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">api_ctx.picked_server</span> <span class="o">=</span> <span class="n">server</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">set_upstream_headers</span><span class="p">(</span><span class="n">api_ctx</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- stash ngx ctx 这部分与 Kong 一致, 怀疑是抄来的（95% 置信区间）</span>
</span></span><span class="line"><span class="cl">    <span class="n">ngx_var.ctx_ref</span> <span class="o">=</span> <span class="n">ctxdump.stash_ngx_ctx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">up_scheme</span> <span class="o">=</span> <span class="n">api_ctx.upstream_scheme</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">up_scheme</span> <span class="o">==</span> <span class="s2">&#34;grpcs&#34;</span> <span class="ow">or</span> <span class="n">up_scheme</span> <span class="o">==</span> <span class="s2">&#34;grpc&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">ngx.exec</span><span class="p">(</span><span class="s2">&#34;@grpc_pass&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">api_ctx.dubbo_proxy_enabled</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="kr">return</span> <span class="n">ngx.exec</span><span class="p">(</span><span class="s2">&#34;@dubbo_pass&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><h2 id="11-一些思考">11. 一些思考</h2>
<h3 id="111-边缘计算">11.1. 边缘计算</h3>
<blockquote>
<p>对于互联网设备，网络边缘是设备或包含设备的本地网络与互联网通信的位置。边缘是个比较模糊的术语。例如，可以将用户的计算机或 IoT  摄像头内部的处理器视为网络边缘，但也可以将用户的路由器、ISP 或本地边缘服务器视为边缘。重要的是，网络边缘在地理位置上靠近设备，与源站和云服务器不同，后者可能与它们相互通信的设备相距很远。</p>
<p>完全减轻额外硬件需求的一种方法是利用边缘服务器。例如，借助 Cloudflare 分散在全球各地的 194 个边缘服务器网络，Cloudflare 的客户可以使用 <a href="https://www.cloudflare.com/products/cloudflare-workers/" target="_blank" rel="noopener">Cloudflare Workers</a> 在全球范围内运行边缘代码。<sup id="fnref:10"><a href="#fn:10" class="footnote-ref" role="doc-noteref">10</a></sup></p>
</blockquote>
<p>Cloudflare 的边缘计算是基于 Edge Gateway（边缘网关、边缘集群）的 Serverless 代码执行，提供了 JS 代码执行，以及 WASM 二进制。<sup id="fnref:11"><a href="#fn:11" class="footnote-ref" role="doc-noteref">11</a></sup></p>
<p><em>一些相关的 Issue:</em></p>
<ul>
<li>
<p><a href="https://github.com/openresty/openresty/issues/541" target="_blank" rel="noopener">Support wasm in openresty?</a></p>
</li>
<li>
<p><a href="https://github.com/apache/apisix/issues/157" target="_blank" rel="noopener">feature: support WebAssembly in apisix.</a></p>
</li>
</ul>
<h3 id="112-serverless">11.2. Serverless</h3>
<p>APISIX 的 Serverless 插件功能支持注入任何 Lua 脚本，而 Kong 网关也有类似的插件功能。<sup id="fnref:12"><a href="#fn:12" class="footnote-ref" role="doc-noteref">12</a></sup></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/image-20210611160354452_hufa3ac669a36ea7e33018ab093d964704_81883_0cf4730412fe1df893d5447efafccc18.webp 400w,
               /blog/apisix-source-code-reading/image-20210611160354452_hufa3ac669a36ea7e33018ab093d964704_81883_31ea1abe310499b26ab860f41a73765f.webp 760w,
               /blog/apisix-source-code-reading/image-20210611160354452_hufa3ac669a36ea7e33018ab093d964704_81883_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/image-20210611160354452_hufa3ac669a36ea7e33018ab093d964704_81883_0cf4730412fe1df893d5447efafccc18.webp"
               width="760"
               height="394"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Serverless 插件支持执行简单的函数方法。</p>
<h3 id="113-webassembly">11.3. WebAssembly</h3>
<p>APISIX 自 2019 年发起提案，试图通过 WebAssembly 来扩展 Lua 贫乏的生态。
2021 年，在 WebAssembly 运行时的技术选型上，APISIX 的技术团队更偏向使用由 Fastly 团队
支撑<sup id="fnref:13"><a href="#fn:13" class="footnote-ref" role="doc-noteref">13</a></sup>的 <a href="https://github.com/bytecodealliance/wasmtime" target="_blank" rel="noopener">wasmtime</a> 项目。</p>
<p>开源的 WebAssembly 除了 wasmtime 还有<sup id="fnref:14"><a href="#fn:14" class="footnote-ref" role="doc-noteref">14</a></sup>：</p>
<ul>
<li><a href="https://github.com/WasmEdge/WasmEdge" target="_blank" rel="noopener">WasmEdge</a>（前身 SSVM），由 Second State 开源的 CNCF 沙箱项目。</li>
<li><a href="https://github.com/wasmerio/wasmer" target="_blank" rel="noopener">Wasmer</a>，Dart 语言使用的 Wasm 运行时。</li>
<li><a href="https://github.com/bytecodealliance/lucet" target="_blank" rel="noopener">Lucet</a>，由 Fastly 开源的 <a href="https://bytecodealliance.org/" target="_blank" rel="noopener">Bytecode Alliance</a> 的
项目，将会与 wasmtime 合并。</li>
</ul>
<p>在 Issue <a href="https://github.com/apache/apisix/issues/157" target="_blank" rel="noopener">#157</a> 的讨论中，Wasmer 的 CEO 也来插了一嘴，
希望 APISIX 能够选型 Wasmer 运行时，APISIX 成员给了 Wasmer 一个大大的赞，
最终在 <a href="https://github.com/api7/wasm-nginx-module" target="_blank" rel="noopener">api7/wasm-nginx-module</a> 插件中，
还是使用 wasmtime 运行时实现了对 WebAssembly 的支持。</p>
<h3 id="114-service-mesh">11.4. Service Mesh</h3>
<p>APISIX 的 Service Mesh 项目 <a href="https://github.com/api7/apisix-mesh-agent" target="_blank" rel="noopener">api7/apisix-mesh-agent</a>，将 APISIX Proxy 作为 Sidecar 运作在数据平面。通过实现控制平面的接口，接入类似 <a href="https://github.com/istio/istio" target="_blank" rel="noopener">Istio</a> 或 <a href="https://github.com/kumahq/kuma" target="_blank" rel="noopener">Kuma</a>（由 Kong 创建捐赠给 CNCF） 的控制平面，形成一套完整的 Service Mesh 方案。
该项目本质上是使用 APISIX 替换了 Istio 中的 Envoy。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/apisix-mesh-overview_hu2c04279ce4ba70f53eba1afdb602c103_294848_c6a05a8f3db7b130fa0ae66a28f24044.webp 400w,
               /blog/apisix-source-code-reading/apisix-mesh-overview_hu2c04279ce4ba70f53eba1afdb602c103_294848_c667c924d7d4ab84fccbecd63472c785.webp 760w,
               /blog/apisix-source-code-reading/apisix-mesh-overview_hu2c04279ce4ba70f53eba1afdb602c103_294848_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/apisix-mesh-overview_hu2c04279ce4ba70f53eba1afdb602c103_294848_c6a05a8f3db7b130fa0ae66a28f24044.webp"
               width="760"
               height="702"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>值得一提的是 Kong 类似的 Service Mesh 项目，叫做 <a href="https://docs.konghq.com/mesh/" target="_blank" rel="noopener">Kong Mesh</a>，目前只提供企业版本。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /blog/apisix-source-code-reading/kong_mesh_hu97f81dd9f11d08b989575a86257de6b7_206834_55ce4dac9e44cf22510b94ac9e020081.webp 400w,
               /blog/apisix-source-code-reading/kong_mesh_hu97f81dd9f11d08b989575a86257de6b7_206834_0827a24bb9dea00b373a145cb4799444.webp 760w,
               /blog/apisix-source-code-reading/kong_mesh_hu97f81dd9f11d08b989575a86257de6b7_206834_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/blog/apisix-source-code-reading/kong_mesh_hu97f81dd9f11d08b989575a86257de6b7_206834_55ce4dac9e44cf22510b94ac9e020081.webp"
               width="760"
               height="605"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>摘自 APISIX <a href="https://github.com/apache/apisix/issues/3207#issuecomment-759269071" target="_blank" rel="noopener">#3207</a> Issue&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://segmentfault.com/a/1190000016149595" target="_blank" rel="noopener">LuaJIT FFI 介绍，及其在 OpenResty 中的应用（下）</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://yxudong.github.io/%E3%80%8AOpenResty%E7%B2%BE%E5%8D%8E%E6%95%B4%E7%90%86%E3%80%8B6.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" target="_blank" rel="noopener">《OpenResty精华整理》6.性能优化 </a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://github.com/openresty/luajit2" target="_blank" rel="noopener">openresty/luajit2</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="https://www.cnblogs.com/liekkas01/p/12764577.html" target="_blank" rel="noopener">OpenResty：特权进程和定时任务</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>OpenResty lua-resty-core 文档 <a href="https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/process.md#enable_privileged_agent" target="_blank" rel="noopener">enable_privileged_agent</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p>OpenResty Issue <a href="https://github.com/openresty/lua-nginx-module/issues/1482" target="_blank" rel="noopener">ngx.var vs ngx.ctx</a>&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p><a href="https://github.com/openresty/lua-resty-lrucache#description" target="_blank" rel="noopener">openresty/lua-resty-lrucache</a>&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9">
<p><a href="https://github.com/apache/apisix/issues/1120#issuecomment-584949073" target="_blank" rel="noopener">set variable inoperative!!</a>&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:10">
<p><a href="https://www.cloudflare.com/zh-cn/learning/serverless/glossary/what-is-edge-computing/" target="_blank" rel="noopener">什么是边缘计算？</a>&#160;<a href="#fnref:10" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:11">
<p><a href="https://blog.cloudflare.com/webassembly-on-cloudflare-workers/" target="_blank" rel="noopener">WebAssembly on Cloudflare Workers</a>&#160;<a href="#fnref:11" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:12">
<p><a href="https://github.com/apache/apisix/blob/master/docs/en/latest/plugins/serverless.md" target="_blank" rel="noopener">APISIX Serverless Plugin</a>&#160;<a href="#fnref:12" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:13">
<p>摘自 <a href="https://bytecodealliance.org/articles/1-year-update" target="_blank" rel="noopener">Bytecode Alliance: One year update</a>&#160;<a href="#fnref:13" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:14">
<p>摘自 <a href="https://github.com/apache/apisix/issues/5106" target="_blank" rel="noopener">Proposal: APISIX JavaScript Plugin Runner</a>&#160;<a href="#fnref:14" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

                </div>
                

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a>
  
  <a class="badge badge-light" href="/tag/%E7%BD%91%E5%85%B3/">网关</a>
  
  <a class="badge badge-light" href="/tag/apisix/">apisix</a>
  
</div>











  
  
    



  
  
  
  
  
  <div class="media author-card content-widget-hr mb-4">
    
      
      <a href="/author/mayo-cream/"><img class="avatar mr-3 avatar-circle" src="/author/mayo-cream/avatar_hue38add62c87b7486d80c9f3fda25dfc1_12220_270x270_fill_q75_lanczos_center.jpg" alt="Mayo Cream"></a>
    

    <div class="media-body">
      <p class="card-title"><a href="/author/mayo-cream/">Mayo Cream</a></p>
      
      
      
    </div>
  </div>


  





<div class="article-widget">
  
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/blog/istio-zero-trust-source-code-reading/" rel="next">
    <div class="meta-nav">下一页</div>
    <p>Istio 安全源码分析——认证体系与通信安全</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/blog/chaos-engineering-with-kubernetes/" rel="prev">
    <div class="meta-nav">上一页</div>
    <p>在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发</p></a>
  
</div>

</div>










  

<p class="edit-page">
  <a href="https://github.com/cloudnativeto/cloudnative.to/edit/master/content/blog/apisix-source-code-reading/index.md">
    <i class="fas fa-pen pr-2"></i>编辑本页
  </a>
</p>




  
  
  <div class="article-widget content-widget-hr">
    <p class="related-title">相关推荐</p>
    <ul>
      
      <li><a href="/blog/kong-source-code-reading/">云原生网关 Kong 源码分析</a></li>
      
      <li><a href="/blog/chaos-engineering-with-kubernetes/">在 Kubernetes 实施混沌工程——Chaos Mesh 原理分析与控制面开发</a></li>
      
      <li><a href="/blog/istio-gateway-api-beta/">Istio 扩展对 Gateway API 的支持</a></li>
      
      <li><a href="/blog/istio-zero-trust-source-code-reading/">Istio 安全源码分析——认证体系与通信安全</a></li>
      
      <li><a href="/event/cloud-native-meetup-guangzhou-04/">云原生社区 meetup 第四期广州站</a></li>
      
    </ul>
  </div>
  





  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"cloudnativeto\/cloudnative.to",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMzc3NDUxOTA=",
    "data-category":"General",
    "data-category-id":"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDU5MzUy",
    "data-mapping":"pathname",
    "data-reactions-enabled":"",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"annoymous",
    "origins":"https://cloudnative.to",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



            </article>
        </main>
    </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2020-2022 云原生社区保留所有权利</p>
        </div>
    </div>
  </div>

</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
